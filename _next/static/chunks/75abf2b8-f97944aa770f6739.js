"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[630],{959:function(e,t,r){let i,n,a,s,o,l,c,u,h;r.d(t,{zxs:function(){return tn}});var p,d,f=r(1305);r(8304);var m=r(2919),g=r(5009),v=Object.defineProperty,y=(e,t,r)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,x=(e,t,r)=>(y(e,"symbol"!=typeof t?t+"":t,r),r);let T=new f.Vector3,b=new f.Line3,S=new f.Plane,E=new f.Vector3,R=new f.Triangle;class A{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new I,this.unassigned=new I,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,r=e.length;t<r;t++)this.vertices.push(new C(e[t]));this.compute()}return this}setFromObject(e){let t=[];return e.updateMatrixWorld(!0),e.traverse(function(e){let r=e.geometry;if(void 0!==r){let i=r.attributes.position;if(void 0!==i)for(let r=0,n=i.count;r<n;r++){let n=new Vector3;n.fromBufferAttribute(i,r).applyMatrix4(e.matrixWorld),t.push(n)}}}),this.setFromPoints(t)}containsPoint(e){let t=this.faces;for(let r=0,i=t.length;r<i;r++)if(t[r].distanceToPoint(e)>this.tolerance)return!1;return!0}intersectRay(e,t){let r=this.faces,i=-1/0,n=1/0;for(let t=0,a=r.length;t<a;t++){let a=r[t],s=a.distanceToPoint(e.origin),o=a.normal.dot(e.direction);if(s>0&&o>=0)return null;let l=0!==o?-s/o:0;if(!(l<=0)&&(o>0?n=Math.min(l,n):i=Math.max(l,i),i>n))return null}return i!==-1/0?e.at(i,t):e.at(n,t),t}intersectsRay(e){return null!==this.intersectRay(e,T)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}removeVertexFromFace(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}removeAllVerticesFromFace(e){if(null!==e.outside){let t=e.outside,r=e.outside;for(;null!==r.next&&r.next.face===e;)r=r.next;return this.assigned.removeSubList(t,r),t.prev=r.next=null,e.outside=null,t}}deleteFaceVertices(e,t){let r=this.removeAllVerticesFromFace(e);if(void 0!==r){if(void 0===t)this.unassigned.appendChain(r);else{let e=r;do{let r=e.next;t.distanceToPoint(e.point)>this.tolerance?this.addVertexToFace(e,t):this.unassigned.append(e),e=r}while(null!==e)}}return this}resolveUnassignedPoints(e){if(!1===this.unassigned.isEmpty()){let t=this.unassigned.first();do{let r=t.next,i=this.tolerance,n=null;for(let r=0;r<e.length;r++){let a=e[r];if(0===a.mark){let e=a.distanceToPoint(t.point);if(e>i&&(i=e,n=a),i>1e3*this.tolerance)break}}null!==n&&this.addVertexToFace(t,n),t=r}while(null!==t)}return this}computeExtremes(){let e=new Vector3,t=new Vector3,r=[],i=[];for(let e=0;e<3;e++)r[e]=i[e]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let n=0,a=this.vertices.length;n<a;n++){let a=this.vertices[n],s=a.point;for(let t=0;t<3;t++)s.getComponent(t)<e.getComponent(t)&&(e.setComponent(t,s.getComponent(t)),r[t]=a);for(let e=0;e<3;e++)s.getComponent(e)>t.getComponent(e)&&(t.setComponent(e,s.getComponent(e)),i[e]=a)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:r,max:i}}computeInitialHull(){let e,t;let r=this.vertices,i=this.computeExtremes(),n=i.min,a=i.max,s=0,o=0;for(let e=0;e<3;e++){let t=a[e].point.getComponent(e)-n[e].point.getComponent(e);t>s&&(s=t,o=e)}let l=n[o],c=a[o];s=0,b.set(l.point,c.point);for(let t=0,i=this.vertices.length;t<i;t++){let i=r[t];if(i!==l&&i!==c){b.closestPointToPoint(i.point,!0,E);let t=E.distanceToSquared(i.point);t>s&&(s=t,e=i)}}s=-1,S.setFromCoplanarPoints(l.point,c.point,e.point);for(let i=0,n=this.vertices.length;i<n;i++){let n=r[i];if(n!==l&&n!==c&&n!==e){let e=Math.abs(S.distanceToPoint(n.point));e>s&&(s=e,t=n)}}let u=[];if(0>S.distanceToPoint(t.point)){u.push(w.create(l,c,e),w.create(t,c,l),w.create(t,e,c),w.create(t,l,e));for(let e=0;e<3;e++){let t=(e+1)%3;u[e+1].getEdge(2).setTwin(u[0].getEdge(t)),u[e+1].getEdge(1).setTwin(u[t+1].getEdge(0))}}else{u.push(w.create(l,e,c),w.create(t,l,c),w.create(t,c,e),w.create(t,e,l));for(let e=0;e<3;e++){let t=(e+1)%3;u[e+1].getEdge(2).setTwin(u[0].getEdge((3-e)%3)),u[e+1].getEdge(0).setTwin(u[t+1].getEdge(1))}}for(let e=0;e<4;e++)this.faces.push(u[e]);for(let i=0,n=r.length;i<n;i++){let n=r[i];if(n!==l&&n!==c&&n!==e&&n!==t){s=this.tolerance;let e=null;for(let t=0;t<4;t++){let r=this.faces[t].distanceToPoint(n.point);r>s&&(s=r,e=this.faces[t])}null!==e&&this.addVertexToFace(n,e)}}return this}reindexFaces(){let e=[];for(let t=0;t<this.faces.length;t++){let r=this.faces[t];0===r.mark&&e.push(r)}return this.faces=e,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let e,t=0,r=this.assigned.first().face,i=r.outside;do{let n=r.distanceToPoint(i.point);n>t&&(t=n,e=i),i=i.next}while(null!==i&&i.face===r);return e}}computeHorizon(e,t,r,i){let n;this.deleteFaceVertices(r),r.mark=1,n=null===t?t=r.getEdge(0):t.next;do{let t=n.twin,r=t.face;0===r.mark&&(r.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,t,r,i):i.push(n)),n=n.next}while(n!==t);return this}addAdjoiningFace(e,t){let r=w.create(e,t.tail(),t.head());return this.faces.push(r),r.getEdge(-1).setTwin(t.twin),r.getEdge(0)}addNewFaces(e,t){this.newFaces=[];let r=null,i=null;for(let n=0;n<t.length;n++){let a=t[n],s=this.addAdjoiningFace(e,a);null===r?r=s:s.next.setTwin(i),this.newFaces.push(s.face),i=s}return r.next.setTwin(i),this}addVertexToHull(e){let t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}}let w=class e{constructor(){this.normal=new Vector3,this.midpoint=new Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(t,r,i){let n=new e,a=new M(t,n),s=new M(r,n),o=new M(i,n);return a.next=o.prev=s,s.next=a.prev=o,o.next=s.prev=a,n.edge=a,n.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){let e=this.edge.tail(),t=this.edge.head(),r=this.edge.next.head();return R.set(e.point,t.point,r.point),R.getNormal(this.normal),R.getMidpoint(this.midpoint),this.area=R.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}};class M{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){let e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1}lengthSquared(){let e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}}class C{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}}class I{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this}remove(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return null===this.head}}class N extends null{constructor(e=[]){super();let t=[],r=[],i=new A().setFromPoints(e).faces;for(let e=0;e<i.length;e++){let n=i[e],a=n.edge;do{let e=a.head().point;t.push(e.x,e.y,e.z),r.push(n.normal.x,n.normal.y,n.normal.z),a=a.next}while(a!==n.edge)}this.setAttribute("position",new Float32BufferAttribute(t,3)),this.setAttribute("normal",new Float32BufferAttribute(r,3))}}let O=new f.Vector3;class P{constructor(e=1.4,t=1e-4){this.minSizeForBreak=e,this.smallDelta=t,this.tempLine1=new Line3,this.tempPlane1=new Plane,this.tempPlane2=new Plane,this.tempPlane_Cut=new Plane,this.tempCM1=new Vector3,this.tempCM2=new Vector3,this.tempVector3=new Vector3,this.tempVector3_2=new Vector3,this.tempVector3_3=new Vector3,this.tempVector3_P0=new Vector3,this.tempVector3_P1=new Vector3,this.tempVector3_P2=new Vector3,this.tempVector3_N0=new Vector3,this.tempVector3_N1=new Vector3,this.tempVector3_AB=new Vector3,this.tempVector3_CB=new Vector3,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(let e=0;e<900;e++)this.segments[e]=!1}prepareBreakableObject(e,t,r,i,n){let a=e.userData;a.mass=t,a.velocity=r.clone(),a.angularVelocity=i.clone(),a.breakable=n}subdivideByImpact(e,t,r,i,n){let a=[],s=this.tempPlane1,o=this.tempPlane2;this.tempVector3.addVectors(t,r),s.setFromCoplanarPoints(t,e.position,this.tempVector3);let l=n+i,c=this;return!function n(u,h,p,d){if(Math.random()<.05*d||d>l){a.push(u);return}let f=Math.PI;0===d?(o.normal.copy(s.normal),o.constant=s.constant):d<=i?(f=(p-h)*(.2+.6*Math.random())+h,c.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(r,f).add(t),o.setFromCoplanarPoints(t,c.tempVector3,c.tempVector3_2)):(f=(.5*(1&d)+.2*(2-Math.random()))*Math.PI,c.tempVector3_2.copy(t).sub(u.position).applyAxisAngle(r,f).add(u.position),c.tempVector3_3.copy(r).add(u.position),o.setFromCoplanarPoints(u.position,c.tempVector3_3,c.tempVector3_2)),c.cutByPlane(u,o,c.tempResultObjects);let m=c.tempResultObjects.object1,g=c.tempResultObjects.object2;m&&n(m,h,f,d+1),g&&n(g,f,p,d+1)}(e,0,2*Math.PI,0),a}cutByPlane(e,t,r){let i=e.geometry,n=i.attributes.position.array,a=i.attributes.normal.array,s=n.length/3,o=s/3,l=i.getIndex();function c(e,t){let r=3*e+t;return l?l[r]:r}l&&(o=(l=l.array).length/3);let u=[],h=[],p=this.smallDelta,d=s*s;for(let e=0;e<d;e++)this.segments[e]=!1;let f=this.tempVector3_P0,m=this.tempVector3_P1,g=this.tempVector3_N0,v=this.tempVector3_N1;for(let e=0;e<o-1;e++){let t=c(e,0),r=c(e,1),i=c(e,2);g.set(a[t],a[t]+1,a[t]+2);for(let n=e+1;n<o;n++){let e=c(n,0),o=c(n,1),l=c(n,2);v.set(a[e],a[e]+1,a[e]+2),1-g.dot(v)<p&&(t===e||t===o||t===l?r===e||r===o||r===l?(this.segments[t*s+r]=!0,this.segments[r*s+t]=!0):(this.segments[i*s+t]=!0,this.segments[t*s+i]=!0):(r===e||r===o||r===l)&&(this.segments[i*s+r]=!0,this.segments[r*s+i]=!0))}}let y=this.tempPlane_Cut;e.updateMatrix(),P.transformPlaneToLocalSpace(t,e.matrix,y);for(let e=0;e<o;e++){let t=c(e,0),i=c(e,1),a=c(e,2);for(let e=0;e<3;e++){let o=0===e?t:1===e?i:a,l=0===e?i:1===e?a:t;if(this.segments[o*s+l])continue;this.segments[o*s+l]=!0,this.segments[l*s+o]=!0,f.set(n[3*o],n[3*o+1],n[3*o+2]),m.set(n[3*l],n[3*l+1],n[3*l+2]);let c=0,d=y.distanceToPoint(f);d>p?(c=2,h.push(f.clone())):d<-p?(c=1,u.push(f.clone())):(c=3,u.push(f.clone()),h.push(f.clone()));let g=0;if((d=y.distanceToPoint(m))>p?(g=2,h.push(m.clone())):d<-p?(g=1,u.push(m.clone())):(g=3,u.push(m.clone()),h.push(m.clone())),1===c&&2===g||2===c&&1===g){this.tempLine1.start.copy(f),this.tempLine1.end.copy(m);let e=new Vector3;if(null===(e=y.intersectLine(this.tempLine1,e)))return console.error("Internal error: segment does not intersect plane."),r.segmentedObject1=null,r.segmentedObject2=null,0;u.push(e),h.push(e.clone())}}}let x=.5*e.userData.mass;this.tempCM1.set(0,0,0);let T=0,b=u.length;if(b>0){for(let e=0;e<b;e++)this.tempCM1.add(u[e]);this.tempCM1.divideScalar(b);for(let e=0;e<b;e++){let t=u[e];t.sub(this.tempCM1),T=Math.max(T,t.x,t.y,t.z)}this.tempCM1.add(e.position)}this.tempCM2.set(0,0,0);let S=0,E=h.length;if(E>0){for(let e=0;e<E;e++)this.tempCM2.add(h[e]);this.tempCM2.divideScalar(E);for(let e=0;e<E;e++){let t=h[e];t.sub(this.tempCM2),S=Math.max(S,t.x,t.y,t.z)}this.tempCM2.add(e.position)}let R=null,A=null,w=0;return b>4&&((R=new Mesh(new N(u),e.material)).position.copy(this.tempCM1),R.quaternion.copy(e.quaternion),this.prepareBreakableObject(R,x,e.userData.velocity,e.userData.angularVelocity,2*T>this.minSizeForBreak),w++),E>4&&((A=new Mesh(new N(h),e.material)).position.copy(this.tempCM2),A.quaternion.copy(e.quaternion),this.prepareBreakableObject(A,x,e.userData.velocity,e.userData.angularVelocity,2*S>this.minSizeForBreak),w++),r.object1=R,r.object2=A,w}static transformFreeVector(e,t){let r=e.x,i=e.y,n=e.z,a=t.elements;return e.x=a[0]*r+a[4]*i+a[8]*n,e.y=a[1]*r+a[5]*i+a[9]*n,e.z=a[2]*r+a[6]*i+a[10]*n,e}static transformFreeVectorInverse(e,t){let r=e.x,i=e.y,n=e.z,a=t.elements;return e.x=a[0]*r+a[1]*i+a[2]*n,e.y=a[4]*r+a[5]*i+a[6]*n,e.z=a[8]*r+a[9]*i+a[10]*n,e}static transformTiedVectorInverse(e,t){let r=e.x,i=e.y,n=e.z,a=t.elements;return e.x=a[0]*r+a[1]*i+a[2]*n-a[12],e.y=a[4]*r+a[5]*i+a[6]*n-a[13],e.z=a[8]*r+a[9]*i+a[10]*n-a[14],e}static transformPlaneToLocalSpace(e,t,r){r.normal.copy(e.normal),r.constant=e.constant;let i=P.transformTiedVectorInverse(e.coplanarPoint(O),t);P.transformFreeVectorInverse(r.normal,t),r.constant=-i.dot(r.normal)}}class k{constructor(){this.position=new Vector3,this.positionWorld=new Vector3,this.positionScreen=new Vector4,this.visible=!0}copy(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)}}function _(e,t){if(t===f.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==f.TriangleFanDrawMode&&t!==f.TriangleStripDrawMode)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let r=e.getIndex();if(null===r){let t=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),r=e.getIndex()}let i=r.count-2,n=[];if(r){if(t===f.TriangleFanDrawMode)for(let e=1;e<=i;e++)n.push(r.getX(0)),n.push(r.getX(e)),n.push(r.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(n.push(r.getX(e)),n.push(r.getX(e+1)),n.push(r.getX(e+2))):(n.push(r.getX(e+2)),n.push(r.getX(e+1)),n.push(r.getX(e)))}n.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let a=e.clone();return a.setIndex(n),a.clearGroups(),a}}async function L(e){let t=await e.arrayBuffer(),r=btoa(String.fromCharCode(...new Uint8Array(t)));return`data:${e.type||""};base64,${r}`}function U(e,t=1/0,r=null){n||(n=new f.PlaneGeometry(2,2,1,1)),a||(a=new f.ShaderMaterial({uniforms:{blitTexture:new f.Uniform(e)},vertexShader:`
        varying vec2 vUv;
        void main(){
            vUv = uv;
            gl_Position = vec4(position.xy * 1.0,0.,.999999);
        }
      `,fragmentShader:`
          uniform sampler2D blitTexture; 
          varying vec2 vUv;

          void main(){ 
              gl_FragColor = vec4(vUv.xy, 0, 1);
              
              #ifdef IS_SRGB
              gl_FragColor = LinearTosRGB( texture2D( blitTexture, vUv) );
              #else
              gl_FragColor = texture2D( blitTexture, vUv);
              #endif
          }
      `})),a.uniforms.blitTexture.value=e,a.defines.IS_SRGB="colorSpace"in e?"srgb"===e.colorSpace:3001===e.encoding,a.needsUpdate=!0,s||((s=new f.Mesh(n,a)).frustrumCulled=!1);let o=new f.PerspectiveCamera,l=new f.Scene;l.add(s),r||(r=i=new f.WebGLRenderer({antialias:!1})),r.setSize(Math.min(e.image.width,t),Math.min(e.image.height,t)),r.clear(),r.render(l,o);let c=new f.Texture(r.domElement);return c.minFilter=e.minFilter,c.magFilter=e.magFilter,c.wrapS=e.wrapS,c.wrapT=e.wrapT,c.name=e.name,i&&(i.dispose(),i=null),c}let D={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class F{constructor(){this.pluginCallbacks=[],this.register(function(e){return new Z(e)}),this.register(function(e){return new $(e)}),this.register(function(e){return new ee(e)}),this.register(function(e){return new et(e)}),this.register(function(e){return new er(e)}),this.register(function(e){return new ei(e)}),this.register(function(e){return new Q(e)}),this.register(function(e){return new J(e)}),this.register(function(e){return new en(e)}),this.register(function(e){return new ea(e)}),this.register(function(e){return new es(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,i){let n=new q,a=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)a.push(this.pluginCallbacks[e](n));n.setPlugins(a),n.write(e,t,i).catch(r)}parseAsync(e,t){let r=this;return new Promise(function(i,n){r.parse(e,i,n,t)})}}let B={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},V="KHR_mesh_quantization",G={};G[f.NearestFilter]=B.NEAREST,G[f.NearestMipmapNearestFilter]=B.NEAREST_MIPMAP_NEAREST,G[f.NearestMipmapLinearFilter]=B.NEAREST_MIPMAP_LINEAR,G[f.LinearFilter]=B.LINEAR,G[f.LinearMipmapNearestFilter]=B.LINEAR_MIPMAP_NEAREST,G[f.LinearMipmapLinearFilter]=B.LINEAR_MIPMAP_LINEAR,G[f.ClampToEdgeWrapping]=B.CLAMP_TO_EDGE,G[f.RepeatWrapping]=B.REPEAT,G[f.MirroredRepeatWrapping]=B.MIRRORED_REPEAT;let z={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},j=new f.Color;function H(e,t){return e.length===t.length&&e.every(function(e,r){return e===t[r]})}function W(e){return 4*Math.ceil(e/4)}function K(e,t=0){let r=W(e.byteLength);if(r!==e.byteLength){let i=new Uint8Array(r);if(i.set(new Uint8Array(e)),0!==t)for(let n=e.byteLength;n<r;n++)i[n]=t;return i.buffer}return e}function X(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}function Y(e,t){let r;return void 0!==e.toBlob?new Promise(r=>e.toBlob(r,t)):("image/jpeg"===t?r=.92:"image/webp"===t&&(r=.8),e.convertToBlob({type:t,quality:r}))}class q{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,r={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},r),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);let i=this.buffers,n=this.json;r=this.options;let a=this.extensionsUsed,s=this.extensionsRequired,o=new Blob(i,{type:"application/octet-stream"}),l=Object.keys(a),c=Object.keys(s);l.length>0&&(n.extensionsUsed=l),c.length>0&&(n.extensionsRequired=c),n.buffers&&n.buffers.length>0&&(n.buffers[0].byteLength=o.size),!0===r.binary?o.arrayBuffer().then(e=>{var r;let i=K(e),a=new DataView(new ArrayBuffer(8));a.setUint32(0,i.byteLength,!0),a.setUint32(4,5130562,!0);let s=K((r=JSON.stringify(n),new TextEncoder().encode(r).buffer),32),o=new DataView(new ArrayBuffer(8));o.setUint32(0,s.byteLength,!0),o.setUint32(4,1313821514,!0);let l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,1179937895,!0),c.setUint32(4,2,!0);let u=12+o.byteLength+s.byteLength+a.byteLength+i.byteLength;c.setUint32(8,u,!0),new Blob([l,o,s,a,i],{type:"application/octet-stream"}).arrayBuffer().then(t)}):(n.buffers&&n.buffers.length>0&&L(o).then(e=>{n.buffers[0].uri=e}),t(n))}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let r=this.options,i=this.extensionsUsed;try{let n=JSON.parse(JSON.stringify(e.userData));if(r.includeCustomExtensions&&n.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),n.gltfExtensions)t.extensions[e]=n.gltfExtensions[e],i[e]=!0;delete n.gltfExtensions}Object.keys(n).length>0&&(t.extras=n)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;let t=new f.Vector3;for(let r=0,i=e.count;r<i;r++)if(Math.abs(t.fromBufferAttribute(e,r).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let r=e.clone(),i=new f.Vector3;for(let e=0,t=r.count;e<t;e++)i.fromBufferAttribute(r,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),r.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,r),r}applyTextureTransform(e,t){let r=!1,i={};(0!==t.offset.x||0!==t.offset.y)&&(i.offset=t.offset.toArray(),r=!0),0!==t.rotation&&(i.rotation=t.rotation,r=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(i.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=i,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function r(e){return("colorSpace"in e?"srgb"===e.colorSpace:3001===e.encoding)?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),e instanceof f.CompressedTexture&&(e=U(e)),t instanceof f.CompressedTexture&&(t=U(t));let i=e?e.image:null,n=t?t.image:null,a=Math.max(i?i.width:0,n?n.width:0),s=Math.max(i?i.height:0,n?n.height:0),o=X();o.width=a,o.height=s;let l=o.getContext("2d");l.fillStyle="#00ffff",l.fillRect(0,0,a,s);let c=l.getImageData(0,0,a,s);if(i){l.drawImage(i,0,0,a,s);let t=r(e),n=l.getImageData(0,0,a,s).data;for(let e=2;e<n.length;e+=4)c.data[e]=256*t(n[e]/256)}if(n){l.drawImage(n,0,0,a,s);let e=r(t),i=l.getImageData(0,0,a,s).data;for(let t=1;t<i.length;t+=4)c.data[t]=256*e(i[t]/256)}l.putImageData(c,0,0);let u=(e||t).clone();return u.source=new f.Texture(o).source,"colorSpace"in u?u.colorSpace="":u.encoding=3e3,u.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),u}processBuffer(e){let t=this.json,r=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),r.push(e),0}processBufferView(e,t,r,i,n){let a;let s=this.json;switch(s.bufferViews||(s.bufferViews=[]),t){case B.BYTE:case B.UNSIGNED_BYTE:a=1;break;case B.SHORT:case B.UNSIGNED_SHORT:a=2;break;default:a=4}let o=W(i*e.itemSize*a),l=new DataView(new ArrayBuffer(o)),c=0;for(let n=r;n<r+i;n++)for(let r=0;r<e.itemSize;r++){let i;e.itemSize>4?i=e.array[n*e.itemSize+r]:(0===r?i=e.getX(n):1===r?i=e.getY(n):2===r?i=e.getZ(n):3===r&&(i=e.getW(n)),!0===e.normalized&&(i=f.MathUtils.normalize(i,e.array))),t===B.FLOAT?l.setFloat32(c,i,!0):t===B.INT?l.setInt32(c,i,!0):t===B.UNSIGNED_INT?l.setUint32(c,i,!0):t===B.SHORT?l.setInt16(c,i,!0):t===B.UNSIGNED_SHORT?l.setUint16(c,i,!0):t===B.BYTE?l.setInt8(c,i):t===B.UNSIGNED_BYTE&&l.setUint8(c,i),c+=a}let u={buffer:this.processBuffer(l.buffer),byteOffset:this.byteOffset,byteLength:o};return void 0!==n&&(u.target=n),n===B.ARRAY_BUFFER&&(u.byteStride=e.itemSize*a),this.byteOffset+=o,s.bufferViews.push(u),{id:s.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){let t=this,r=t.json;return r.bufferViews||(r.bufferViews=[]),e.arrayBuffer().then(e=>{let i=K(e),n={buffer:t.processBuffer(i),byteOffset:t.byteOffset,byteLength:i.byteLength};return t.byteOffset+=i.byteLength,r.bufferViews.push(n)-1})}processAccessor(e,t,r,i){let n,a;let s=this.json;if(e.array.constructor===Float32Array)n=B.FLOAT;else if(e.array.constructor===Int32Array)n=B.INT;else if(e.array.constructor===Uint32Array)n=B.UNSIGNED_INT;else if(e.array.constructor===Int16Array)n=B.SHORT;else if(e.array.constructor===Uint16Array)n=B.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)n=B.BYTE;else if(e.array.constructor===Uint8Array)n=B.UNSIGNED_BYTE;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===r&&(r=0),void 0===i&&(i=e.count),0===i)return null;let o=function(e,t,r){let i={min:Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let n=t;n<t+r;n++)for(let t=0;t<e.itemSize;t++){let r;e.itemSize>4?r=e.array[n*e.itemSize+t]:(0===t?r=e.getX(n):1===t?r=e.getY(n):2===t?r=e.getZ(n):3===t&&(r=e.getW(n)),!0===e.normalized&&(r=f.MathUtils.normalize(r,e.array))),i.min[t]=Math.min(i.min[t],r),i.max[t]=Math.max(i.max[t],r)}return i}(e,r,i);void 0!==t&&(a=e===t.index?B.ELEMENT_ARRAY_BUFFER:B.ARRAY_BUFFER);let l=this.processBufferView(e,n,r,i,a),c={bufferView:l.id,byteOffset:l.byteOffset,componentType:n,count:i,max:o.max,min:o.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(c.normalized=!0),s.accessors||(s.accessors=[]),s.accessors.push(c)-1}processImage(e,t,r,i="image/png"){if(null!==e){let n=this,a=n.cache,s=n.json,o=n.options,l=n.pending;a.images.has(e)||a.images.set(e,{});let c=a.images.get(e),u=i+":flipY/"+r.toString();if(void 0!==c[u])return c[u];s.images||(s.images=[]);let h={mimeType:i},p=X();p.width=Math.min(e.width,o.maxTextureSize),p.height=Math.min(e.height,o.maxTextureSize);let d=p.getContext("2d");if(!0===r&&(d.translate(0,p.height),d.scale(1,-1)),void 0!==e.data){t!==f.RGBAFormat&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>o.maxTextureSize||e.height>o.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let r=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<r.length;t+=4)r[t+0]=e.data[t+0],r[t+1]=e.data[t+1],r[t+2]=e.data[t+2],r[t+3]=e.data[t+3];d.putImageData(new ImageData(r,e.width,e.height),0,0)}else d.drawImage(e,0,0,p.width,p.height);!0===o.binary?l.push(Y(p,i).then(e=>n.processBufferViewImage(e)).then(e=>{h.bufferView=e})):void 0!==p.toDataURL?h.uri=p.toDataURL(i):l.push(Y(p,i).then(L).then(e=>{h.uri=e}));let m=s.images.push(h)-1;return c[u]=m,m}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let r={magFilter:G[e.magFilter],minFilter:G[e.minFilter],wrapS:G[e.wrapS],wrapT:G[e.wrapT]};return t.samplers.push(r)-1}processTexture(e){let t=this.options,r=this.cache,i=this.json;if(r.textures.has(e))return r.textures.get(e);i.textures||(i.textures=[]),e instanceof f.CompressedTexture&&(e=U(e,t.maxTextureSize));let n=e.userData.mimeType;"image/webp"===n&&(n="image/png");let a={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,n)};e.name&&(a.name=e.name),this._invokeAll(function(t){t.writeTexture&&t.writeTexture(e,a)});let s=i.textures.push(a)-1;return r.textures.set(e,s),s}processMaterial(e){let t=this.cache,r=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;r.materials||(r.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let n=e.color.toArray().concat([e.opacity]);if(H(n,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=n),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=.5,i.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){let t=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),r={index:this.processTexture(t),channel:t.channel};this.applyTextureTransform(r,t),i.pbrMetallicRoughness.metallicRoughnessTexture=r}if(e.map){let t={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===f.DoubleSide&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),this._invokeAll(function(t){t.writeMaterial&&t.writeMaterial(e,i)});let a=r.materials.push(i)-1;return t.materials.set(e,a),a}processMesh(e){let t;let r=this.cache,i=this.json,n=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,r=e.material.length;t<r;t++)n.push(e.material[t].uuid);else n.push(e.material.uuid);let a=n.join(":");if(r.meshes.has(a))return r.meshes.get(a);let s=e.geometry;t=e.isLineSegments?B.LINES:e.isLineLoop?B.LINE_LOOP:e.isLine?B.LINE_STRIP:e.isPoints?B.POINTS:e.material.wireframe?B.LINES:B.TRIANGLES;let o={},l={},c=[],u=[],h={uv:"TEXCOORD_0",[f.REVISION.replace(/\D+/g,"")>=152?"uv1":"uv2"]:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},p=s.getAttribute("normal");void 0===p||this.isNormalizedNormalAttribute(p)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),s.setAttribute("normal",this.createNormalizedNormalAttribute(p)));let d=null;for(let e in s.attributes){if("morph"===e.slice(0,5))continue;let t=s.attributes[e];if(e=h[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),r.attributes.has(this.getUID(t))){l[e]=r.attributes.get(this.getUID(t));continue}d=null;let i=t.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),d=new f.BufferAttribute(new Uint16Array(i),t.itemSize,t.normalized));let n=this.processAccessor(d||t,s);null!==n&&(e.startsWith("_")||this.detectMeshQuantization(e,t),l[e]=n,r.attributes.set(this.getUID(t),n))}if(void 0!==p&&s.setAttribute("normal",p),0===Object.keys(l).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],i=[],n={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)n[e.morphTargetDictionary[t]]=t;for(let a=0;a<e.morphTargetInfluences.length;++a){let o={},l=!1;for(let e in s.morphAttributes){if("position"!==e&&"normal"!==e){l||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}let t=s.morphAttributes[e][a],i=e.toUpperCase(),n=s.attributes[e];if(r.attributes.has(this.getUID(t,!0))){o[i]=r.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!s.morphTargetsRelative)for(let e=0,r=t.count;e<r;e++)for(let r=0;r<t.itemSize;r++)0===r&&c.setX(e,t.getX(e)-n.getX(e)),1===r&&c.setY(e,t.getY(e)-n.getY(e)),2===r&&c.setZ(e,t.getZ(e)-n.getZ(e)),3===r&&c.setW(e,t.getW(e)-n.getW(e));o[i]=this.processAccessor(c,s),r.attributes.set(this.getUID(n,!0),o[i])}u.push(o),t.push(e.morphTargetInfluences[a]),void 0!==e.morphTargetDictionary&&i.push(n[a])}o.weights=t,i.length>0&&(o.extras={},o.extras.targetNames=i)}let m=Array.isArray(e.material);if(m&&0===s.groups.length)return null;let g=m?e.material:[e.material],v=m?s.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,i=v.length;e<i;e++){let i={mode:t,attributes:l};if(this.serializeUserData(s,i),u.length>0&&(i.targets=u),null!==s.index){let t=this.getUID(s.index);(void 0!==v[e].start||void 0!==v[e].count)&&(t+=":"+v[e].start+":"+v[e].count),r.attributes.has(t)?i.indices=r.attributes.get(t):(i.indices=this.processAccessor(s.index,s,v[e].start,v[e].count),r.attributes.set(t,i.indices)),null===i.indices&&delete i.indices}let n=this.processMaterial(g[v[e].materialIndex]);null!==n&&(i.material=n),c.push(i)}o.primitives=c,i.meshes||(i.meshes=[]),this._invokeAll(function(t){t.writeMesh&&t.writeMesh(e,o)});let y=i.meshes.push(o)-1;return r.meshes.set(a,y),y}detectMeshQuantization(e,t){let r;if(this.extensionsUsed[V])return;switch(t.array.constructor){case Int8Array:r="byte";break;case Uint8Array:r="unsigned byte";break;case Int16Array:r="short";break;case Uint16Array:r="unsigned short";break;default:return}t.normalized&&(r+=" normalized");let i=e.split("_",1)[0];D[i]&&D[i].includes(r)&&(this.extensionsUsed[V]=!0,this.extensionsRequired[V]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let r=e.isOrthographicCamera,i={type:r?"orthographic":"perspective"};return r?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:f.MathUtils.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let r=this.json,i=this.nodeMap;r.animations||(r.animations=[]);let n=(e=F.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],s=[];for(let e=0;e<n.length;++e){let r;let o=n[e],l=f.PropertyBinding.parseTrackName(o.name),c=f.PropertyBinding.findNode(t,l.nodeName),u=z[l.propertyName];if("bones"===l.objectName&&(c=!0===c.isSkinnedMesh?c.skeleton.getBoneByName(l.objectIndex):void 0),!c||!u)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name),null;let h=o.values.length/o.times.length;u===z.morphTargetInfluences&&(h/=c.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(r="CUBICSPLINE",h/=3):r=o.getInterpolation()===f.InterpolateDiscrete?"STEP":"LINEAR",s.push({input:this.processAccessor(new f.BufferAttribute(o.times,1)),output:this.processAccessor(new f.BufferAttribute(o.values,h)),interpolation:r}),a.push({sampler:s.length-1,target:{node:i.get(c),path:u}})}return r.animations.push({name:e.name||"clip_"+r.animations.length,samplers:s,channels:a}),r.animations.length-1}processSkin(e){let t=this.json,r=this.nodeMap,i=t.nodes[r.get(e)],n=e.skeleton;if(void 0===n)return null;let a=e.skeleton.bones[0];if(void 0===a)return null;let s=[],o=new Float32Array(16*n.bones.length),l=new f.Matrix4;for(let t=0;t<n.bones.length;++t)s.push(r.get(n.bones[t])),l.copy(n.boneInverses[t]),l.multiply(e.bindMatrix).toArray(o,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new f.BufferAttribute(o,16)),joints:s,skeleton:r.get(a)}),i.skin=t.skins.length-1}processNode(e){let t=this.json,r=this.options,i=this.nodeMap;t.nodes||(t.nodes=[]);let n={};if(r.trs){let t=e.quaternion.toArray(),r=e.position.toArray(),i=e.scale.toArray();H(t,[0,0,0,1])||(n.rotation=t),H(r,[0,0,0])||(n.translation=r),H(i,[1,1,1])||(n.scale=i)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===H(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(n.matrix=e.matrix.elements);if(""!==e.name&&(n.name=String(e.name)),this.serializeUserData(e,n),e.isMesh||e.isLine||e.isPoints){let t=this.processMesh(e);null!==t&&(n.mesh=t)}else e.isCamera&&(n.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){let t=[];for(let i=0,n=e.children.length;i<n;i++){let n=e.children[i];if(n.visible||!1===r.onlyVisible){let e=this.processNode(n);null!==e&&t.push(e)}}t.length>0&&(n.children=t)}this._invokeAll(function(t){t.writeNode&&t.writeNode(e,n)});let a=t.nodes.push(n)-1;return i.set(e,a),a}processScene(e){let t=this.json,r=this.options;t.scenes||(t.scenes=[],t.scene=0);let i={};""!==e.name&&(i.name=e.name),t.scenes.push(i);let n=[];for(let t=0,i=e.children.length;t<i;t++){let i=e.children[t];if(i.visible||!1===r.onlyVisible){let e=this.processNode(i);null!==e&&n.push(e)}}n.length>0&&(i.nodes=n),this.serializeUserData(e,i)}processObjects(e){let t=new f.Scene;t.name="AuxScene";for(let r=0;r<e.length;r++)t.children.push(e[r]);this.processScene(t)}processInput(e){let t=this.options;e=e instanceof Array?e:[e],this._invokeAll(function(t){t.beforeParse&&t.beforeParse(e)});let r=[];for(let t=0;t<e.length;t++)e[t]instanceof f.Scene?this.processScene(e[t]):r.push(e[t]);r.length>0&&this.processObjects(r);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let r=0;r<t.animations.length;++r)this.processAnimation(t.animations[r],e[0]);this._invokeAll(function(t){t.afterParse&&t.afterParse(e)})}_invokeAll(e){for(let t=0,r=this.plugins.length;t<r;t++)e(this.plugins[t])}}class Z{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}let r=this.writer,i=r.json,n=r.extensionsUsed,a={};e.name&&(a.name=e.name),a.color=e.color.toArray(),a.intensity=e.intensity,e.isDirectionalLight?a.type="directional":e.isPointLight?(a.type="point",e.distance>0&&(a.range=e.distance)):e.isSpotLight&&(a.type="spot",e.distance>0&&(a.range=e.distance),a.spot={},a.spot.innerConeAngle=-((e.penumbra-1)*e.angle*1),a.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),n[this.name]||(i.extensions=i.extensions||{},i.extensions[this.name]={lights:[]},n[this.name]=!0);let s=i.extensions[this.name].lights;s.push(a),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}let $=class{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;let r=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},r[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}},Q=class{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let r=this.writer,i=r.extensionsUsed,n={};if(n.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:r.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};r.applyTextureTransform(t,e.clearcoatMap),n.clearcoatTexture=t}if(n.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:r.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};r.applyTextureTransform(t,e.clearcoatRoughnessMap),n.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:r.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};r.applyTextureTransform(t,e.clearcoatNormalMap),n.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}},J=class{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let r=this.writer,i=r.extensionsUsed,n={};if(n.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:r.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};r.applyTextureTransform(t,e.iridescenceMap),n.iridescenceTexture=t}if(n.iridescenceIor=e.iridescenceIOR,n.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],n.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:r.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};r.applyTextureTransform(t,e.iridescenceThicknessMap),n.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}},ee=class{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let r=this.writer,i=r.extensionsUsed,n={};if(n.transmissionFactor=e.transmission,e.transmissionMap){let t={index:r.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};r.applyTextureTransform(t,e.transmissionMap),n.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}},et=class{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let r=this.writer,i=r.extensionsUsed,n={};if(n.thicknessFactor=e.thickness,e.thicknessMap){let t={index:r.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};r.applyTextureTransform(t,e.thicknessMap),n.thicknessTexture=t}n.attenuationDistance=e.attenuationDistance,n.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}},er=class{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let r=this.writer.extensionsUsed,i={};i.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}},ei=class{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(j)&&!e.specularIntensityMap&&!e.specularColorTexture)return;let r=this.writer,i=r.extensionsUsed,n={};if(e.specularIntensityMap){let t={index:r.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};r.applyTextureTransform(t,e.specularIntensityMap),n.specularTexture=t}if(e.specularColorMap){let t={index:r.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};r.applyTextureTransform(t,e.specularColorMap),n.specularColorTexture=t}n.specularFactor=e.specularIntensity,n.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}},en=class{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let r=this.writer,i=r.extensionsUsed,n={};if(e.sheenRoughnessMap){let t={index:r.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};r.applyTextureTransform(t,e.sheenRoughnessMap),n.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:r.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};r.applyTextureTransform(t,e.sheenColorMap),n.sheenColorTexture=t}n.sheenRoughnessFactor=e.sheenRoughness,n.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}},ea=class{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let r=this.writer,i=r.extensionsUsed,n={};if(e.anisotropyMap){let t={index:r.processTexture(e.anisotropyMap)};r.applyTextureTransform(t,e.anisotropyMap),n.anisotropyTexture=t}n.anisotropyStrength=e.anisotropy,n.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=n,i[this.name]=!0}},es=class{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let r=this.writer.extensionsUsed,i={};i.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=i,r[this.name]=!0}},eo=class{parse(e,t={decodeSpeed:5,encodeSpeed:5,encoderMethod:eo.MESH_EDGEBREAKER_ENCODING,quantization:[16,8,8,8,8],exportUvs:!0,exportNormals:!0,exportColor:!1}){let r,i,n;if(e instanceof f.BufferGeometry&&e.isBufferGeometry)throw Error("DRACOExporter: The first parameter of parse() is now an instance of Mesh or Points.");if(void 0===DracoEncoderModule)throw Error("THREE.DRACOExporter: required the draco_encoder to work.");let a=e.geometry,s=DracoEncoderModule(),o=new s.Encoder;if(!a.isBufferGeometry)throw Error("THREE.DRACOExporter.parse(geometry, options): geometry is not a THREE.BufferGeometry instance.");if(e instanceof f.Mesh&&e.isMesh){r=new s.MeshBuilder,i=new s.Mesh;let e=a.getAttribute("position");r.AddFloatAttributeToMesh(i,s.POSITION,e.count,e.itemSize,e.array);let n=a.getIndex();if(null!==n)r.AddFacesToMesh(i,n.count/3,n.array);else{let t=new(e.count>65535?Uint32Array:Uint16Array)(e.count);for(let e=0;e<t.length;e++)t[e]=e;r.AddFacesToMesh(i,e.count,t)}if(t.exportNormals){let e=a.getAttribute("normal");void 0!==e&&r.AddFloatAttributeToMesh(i,s.NORMAL,e.count,e.itemSize,e.array)}if(t.exportUvs){let e=a.getAttribute("uv");void 0!==e&&r.AddFloatAttributeToMesh(i,s.TEX_COORD,e.count,e.itemSize,e.array)}if(t.exportColor){let e=a.getAttribute("color");void 0!==e&&r.AddFloatAttributeToMesh(i,s.COLOR,e.count,e.itemSize,e.array)}}else if(e instanceof f.Points&&e.isPoints){r=new s.PointCloudBuilder,i=new s.PointCloud;let e=a.getAttribute("position");if(r.AddFloatAttribute(i,s.POSITION,e.count,e.itemSize,e.array),t.exportColor){let e=a.getAttribute("color");void 0!==e&&r.AddFloatAttribute(i,s.COLOR,e.count,e.itemSize,e.array)}}else throw Error("DRACOExporter: Unsupported object type.");let l=new s.DracoInt8Array,c=void 0!==t.encodeSpeed?t.encodeSpeed:5,u=void 0!==t.decodeSpeed?t.decodeSpeed:5;if(o.SetSpeedOptions(c,u),void 0!==t.encoderMethod&&o.SetEncodingMethod(t.encoderMethod),void 0!==t.quantization)for(let e=0;e<5;e++)void 0!==t.quantization[e]&&o.SetAttributeQuantization(e,t.quantization[e]);if(n=e instanceof f.Mesh&&e.isMesh?o.EncodeMeshToDracoBuffer(i,l):o.EncodePointCloudToDracoBuffer(i,!0,l),s.destroy(i),0===n)throw Error("THREE.DRACOExporter: Draco encoding failed.");let h=new Int8Array(new ArrayBuffer(n));for(let e=0;e<n;e++)h[e]=l.GetValue(e);return s.destroy(l),s.destroy(o),s.destroy(r),h}};x(eo,"MESH_SEQUENTIAL_ENCODING",0),x(eo,"TRIANGULAR_MESH",1),x(eo,"POSITION",0),x(eo,"NORMAL",1),x(eo,"COLOR",2),x(eo,"TEX_COORD",3),x(eo,"GENERIC",4);let el=new f.Vector3,ec=new f.Matrix4;function eu(e,t){return el.setFromMatrixPosition(e.matrixWorld).applyMatrix4(t)}function eh(e,t,r,i){let n=eu(r,i);e[3*t+0]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z}class ep extends null{constructor(e=1,t=1,r=4,i=8){let n=new Path;n.absarc(0,-t/2,e,1.5*Math.PI,0),n.absarc(0,t/2,e,0,.5*Math.PI),super(n.getPoints(r),i),this.type="CapsuleGeometry",this.parameters={radius:e,height:t,capSegments:r,radialSegments:i}}static fromJSON(e){return new ep(e.radius,e.length,e.capSegments,e.radialSegments)}}let ed=new f.Vector3,ef=new f.Quaternion,em=new f.Vector3,eg=new f.Matrix4,ev=parseInt(f.REVISION.replace(/\D+/g,"")),ey=class extends f.Mesh{constructor(e,t={}){super(e),this.isReflector=!0,this.type="Reflector",this.camera=new f.PerspectiveCamera;let r=this,i=new f.Color(void 0!==t.color?t.color:8355711),n=t.textureWidth||512,a=t.textureHeight||512,s=t.clipBias||0,o=t.shader||ey.ReflectorShader,l=void 0!==t.multisample?t.multisample:4,c=new f.Plane,u=new f.Vector3,h=new f.Vector3,p=new f.Vector3,d=new f.Matrix4,m=new f.Vector3(0,0,-1),g=new f.Vector4,v=new f.Vector3,y=new f.Vector3,x=new f.Vector4,T=new f.Matrix4,b=this.camera,S=new f.WebGLRenderTarget(n,a,{samples:l,type:f.HalfFloatType}),E=new f.ShaderMaterial({uniforms:f.UniformsUtils.clone(o.uniforms),fragmentShader:o.fragmentShader,vertexShader:o.vertexShader});E.uniforms.tDiffuse.value=S.texture,E.uniforms.color.value=i,E.uniforms.textureMatrix.value=T,this.material=E,this.onBeforeRender=function(e,t,i){if(h.setFromMatrixPosition(r.matrixWorld),p.setFromMatrixPosition(i.matrixWorld),d.extractRotation(r.matrixWorld),u.set(0,0,1),u.applyMatrix4(d),v.subVectors(h,p),v.dot(u)>0)return;v.reflect(u).negate(),v.add(h),d.extractRotation(i.matrixWorld),m.set(0,0,-1),m.applyMatrix4(d),m.add(p),y.subVectors(h,m),y.reflect(u).negate(),y.add(h),b.position.copy(v),b.up.set(0,1,0),b.up.applyMatrix4(d),b.up.reflect(u),b.lookAt(y),b.far=i.far,b.updateMatrixWorld(),b.projectionMatrix.copy(i.projectionMatrix),T.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),T.multiply(b.projectionMatrix),T.multiply(b.matrixWorldInverse),T.multiply(r.matrixWorld),c.setFromNormalAndCoplanarPoint(u,h),c.applyMatrix4(b.matrixWorldInverse),g.set(c.normal.x,c.normal.y,c.normal.z,c.constant);let n=b.projectionMatrix;x.x=(Math.sign(g.x)+n.elements[8])/n.elements[0],x.y=(Math.sign(g.y)+n.elements[9])/n.elements[5],x.z=-1,x.w=(1+n.elements[10])/n.elements[14],g.multiplyScalar(2/g.dot(x)),n.elements[2]=g.x,n.elements[6]=g.y,n.elements[10]=g.z+1-s,n.elements[14]=g.w,r.visible=!1;let a=e.getRenderTarget(),o=e.xr.enabled,l=e.shadowMap.autoUpdate,E=e.toneMapping,R=!1;R="outputColorSpace"in e?"srgb"===e.outputColorSpace:3001===e.outputEncoding,e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,"outputColorSpace"in e?e.outputColorSpace="linear-srgb":e.outputEncoding=3e3,e.toneMapping=f.NoToneMapping,e.setRenderTarget(S),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,b),e.xr.enabled=o,e.shadowMap.autoUpdate=l,e.toneMapping=E,"outputColorSpace"in e?e.outputColorSpace=R?"srgb":"srgb-linear":e.outputEncoding=R?3001:3e3,e.setRenderTarget(a);let A=i.viewport;void 0!==A&&e.state.viewport(A),r.visible=!0},this.getRenderTarget=function(){return S},this.dispose=function(){S.dispose(),r.material.dispose()}}};x(ey,"ReflectorShader",{uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:`
		uniform mat4 textureMatrix;
		varying vec4 vUv;

		#include <common>
		#include <logdepthbuf_pars_vertex>

		void main() {

			vUv = textureMatrix * vec4( position, 1.0 );

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

			#include <logdepthbuf_vertex>

		}`,fragmentShader:`
		uniform vec3 color;
		uniform sampler2D tDiffuse;
		varying vec4 vUv;

		#include <logdepthbuf_pars_fragment>

		float blendOverlay( float base, float blend ) {

			return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );

		}

		vec3 blendOverlay( vec3 base, vec3 blend ) {

			return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );

		}

		void main() {

			#include <logdepthbuf_fragment>

			vec4 base = texture2DProj( tDiffuse, vUv );
			gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );

			#include <tonemapping_fragment>
			#include <${ev>=154?"colorspace_fragment":"encodings_fragment"}>

		}`});let ex=class extends f.Mesh{constructor(e,t={}){super(e),this.isRefractor=!0,this.type="Refractor",this.camera=new f.PerspectiveCamera;let r=this,i=new f.Color(void 0!==t.color?t.color:8355711),n=t.textureWidth||512,a=t.textureHeight||512,s=t.clipBias||0,o=t.shader||ex.RefractorShader,l=void 0!==t.multisample?t.multisample:4,c=this.camera;c.matrixAutoUpdate=!1,c.userData.refractor=!0;let u=new f.Plane,h=new f.Matrix4,p=new f.WebGLRenderTarget(n,a,{samples:l,type:f.HalfFloatType});this.material=new f.ShaderMaterial({uniforms:f.UniformsUtils.clone(o.uniforms),vertexShader:o.vertexShader,fragmentShader:o.fragmentShader,transparent:!0}),this.material.uniforms.color.value=i,this.material.uniforms.tDiffuse.value=p.texture,this.material.uniforms.textureMatrix.value=h;let d=function(){let e=new f.Vector3,t=new f.Vector3,i=new f.Matrix4,n=new f.Vector3,a=new f.Vector3;return function(s){return e.setFromMatrixPosition(r.matrixWorld),t.setFromMatrixPosition(s.matrixWorld),n.subVectors(e,t),i.extractRotation(r.matrixWorld),a.set(0,0,1),a.applyMatrix4(i),0>n.dot(a)}}(),m=function(){let e=new f.Vector3,t=new f.Vector3,i=new f.Quaternion,n=new f.Vector3;return function(){r.matrixWorld.decompose(t,i,n),e.set(0,0,1).applyQuaternion(i).normalize(),e.negate(),u.setFromNormalAndCoplanarPoint(e,t)}}(),g=function(){let e=new f.Plane,t=new f.Vector4,r=new f.Vector4;return function(i){c.matrixWorld.copy(i.matrixWorld),c.matrixWorldInverse.copy(c.matrixWorld).invert(),c.projectionMatrix.copy(i.projectionMatrix),c.far=i.far,e.copy(u),e.applyMatrix4(c.matrixWorldInverse),t.set(e.normal.x,e.normal.y,e.normal.z,e.constant);let n=c.projectionMatrix;r.x=(Math.sign(t.x)+n.elements[8])/n.elements[0],r.y=(Math.sign(t.y)+n.elements[9])/n.elements[5],r.z=-1,r.w=(1+n.elements[10])/n.elements[14],t.multiplyScalar(2/t.dot(r)),n.elements[2]=t.x,n.elements[6]=t.y,n.elements[10]=t.z+1-s,n.elements[14]=t.w}}();this.onBeforeRender=function(e,t,i){!0!==i.userData.refractor&&!0!=!d(i)&&(m(),h.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),h.multiply(i.projectionMatrix),h.multiply(i.matrixWorldInverse),h.multiply(r.matrixWorld),g(i),function(e,t,i){r.visible=!1;let n=e.getRenderTarget(),a=e.xr.enabled,s=e.shadowMap.autoUpdate,o=e.toneMapping,l=!1;l="outputColorSpace"in e?"srgb"===e.outputColorSpace:3001===e.outputEncoding,e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,"outputColorSpace"in e?e.outputColorSpace="linear-srgb":e.outputEncoding=3e3,e.toneMapping=f.NoToneMapping,e.setRenderTarget(p),!1===e.autoClear&&e.clear(),e.render(t,c),e.xr.enabled=a,e.shadowMap.autoUpdate=s,e.toneMapping=o,e.setRenderTarget(n),"outputColorSpace"in e?e.outputColorSpace=l?"srgb":"srgb-linear":e.outputEncoding=l?3001:3e3;let u=i.viewport;void 0!==u&&e.state.viewport(u),r.visible=!0}(e,t,i))},this.getRenderTarget=function(){return p},this.dispose=function(){p.dispose(),r.material.dispose()}}};x(ex,"RefractorShader",{uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:`

		uniform mat4 textureMatrix;

		varying vec4 vUv;

		void main() {

			vUv = textureMatrix * vec4( position, 1.0 );
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform vec3 color;
		uniform sampler2D tDiffuse;

		varying vec4 vUv;

		float blendOverlay( float base, float blend ) {

			return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );

		}

		vec3 blendOverlay( vec3 base, vec3 blend ) {

			return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );

		}

		void main() {

			vec4 base = texture2DProj( tDiffuse, vUv );
			gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );

			#include <tonemapping_fragment>
			#include <${ev>=154?"colorspace_fragment":"encodings_fragment"}>

		}`});let eT=new f.BufferGeometry,eb=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),eS=new f.InterleavedBuffer(eb,5);eT.setIndex([0,1,2,0,2,3]),eT.setAttribute("position",new f.InterleavedBufferAttribute(eS,3,0,!1)),eT.setAttribute("uv",new f.InterleavedBufferAttribute(eS,2,3,!1));let eE=class extends f.Mesh{constructor(){super(eE.Geometry,new f.MeshBasicMaterial({opacity:0,transparent:!0})),this.isLensflare=!0,this.type="Lensflare",this.frustumCulled=!1,this.renderOrder=1/0;let e=new f.Vector3,t=new f.Vector3,r=new f.DataTexture(new Uint8Array(768),16,16,f.RGBAFormat);r.minFilter=f.NearestFilter,r.magFilter=f.NearestFilter,r.wrapS=f.ClampToEdgeWrapping,r.wrapT=f.ClampToEdgeWrapping;let i=new f.DataTexture(new Uint8Array(768),16,16,f.RGBAFormat);i.minFilter=f.NearestFilter,i.magFilter=f.NearestFilter,i.wrapS=f.ClampToEdgeWrapping,i.wrapT=f.ClampToEdgeWrapping;let n=eE.Geometry,a=new f.RawShaderMaterial({uniforms:{scale:{value:null},screenPosition:{value:null}},vertexShader:`

				precision highp float;

				uniform vec3 screenPosition;
				uniform vec2 scale;

				attribute vec3 position;

				void main() {

					gl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );

				}`,fragmentShader:`

				precision highp float;

				void main() {

					gl_FragColor = vec4( 1.0, 0.0, 1.0, 1.0 );

				}`,depthTest:!0,depthWrite:!1,transparent:!1}),s=new f.RawShaderMaterial({uniforms:{map:{value:r},scale:{value:null},screenPosition:{value:null}},vertexShader:`

				precision highp float;

				uniform vec3 screenPosition;
				uniform vec2 scale;

				attribute vec3 position;
				attribute vec2 uv;

				varying vec2 vUV;

				void main() {

					vUV = uv;

					gl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );

				}`,fragmentShader:`

				precision highp float;

				uniform sampler2D map;

				varying vec2 vUV;

				void main() {

					gl_FragColor = texture2D( map, vUV );

				}`,depthTest:!1,depthWrite:!1,transparent:!1}),o=new f.Mesh(n,a),l=[],c=eR.Shader,u=new f.RawShaderMaterial({uniforms:{map:{value:null},occlusionMap:{value:i},color:{value:new f.Color(16777215)},scale:{value:new f.Vector2},screenPosition:{value:new f.Vector3}},vertexShader:c.vertexShader,fragmentShader:c.fragmentShader,blending:f.AdditiveBlending,transparent:!0,depthWrite:!1}),h=new f.Mesh(n,u);this.addElement=function(e){l.push(e)};let p=new f.Vector2,d=new f.Vector2,m=new f.Box2,g=new f.Vector4;this.onBeforeRender=function(c,f,v){c.getCurrentViewport(g);let y=g.w/g.z,x=g.z/2,T=g.w/2,b=16/g.w;if(p.set(b*y,b),m.min.set(g.x,g.y),m.max.set(g.x+(g.z-16),g.y+(g.w-16)),t.setFromMatrixPosition(this.matrixWorld),t.applyMatrix4(v.matrixWorldInverse),!(t.z>0)&&(e.copy(t).applyMatrix4(v.projectionMatrix),d.x=g.x+e.x*x+x-8,d.y=g.y+e.y*T+T-8,m.containsPoint(d))){c.copyFramebufferToTexture(d,r);let t=a.uniforms;t.scale.value=p,t.screenPosition.value=e,c.renderBufferDirect(v,null,n,a,o,null),c.copyFramebufferToTexture(d,i),(t=s.uniforms).scale.value=p,t.screenPosition.value=e,c.renderBufferDirect(v,null,n,s,o,null);let f=-(2*e.x),m=-(2*e.y);for(let t=0,r=l.length;t<r;t++){let r=l[t],i=u.uniforms;i.color.value.copy(r.color),i.map.value=r.texture,i.screenPosition.value.x=e.x+f*r.distance,i.screenPosition.value.y=e.y+m*r.distance,b=r.size/g.w;let a=g.w/g.z;i.scale.value.set(b*a,b),u.uniformsNeedUpdate=!0,c.renderBufferDirect(v,null,n,u,h,null)}}},this.dispose=function(){a.dispose(),s.dispose(),u.dispose(),r.dispose(),i.dispose();for(let e=0,t=l.length;e<t;e++)l[e].texture.dispose()}}};x(eE,"Geometry",eT);class eR{constructor(e,t=1,r=0,i=new f.Color(16777215)){this.texture=e,this.size=t,this.distance=r,this.color=i}}x(eR,"Shader",{uniforms:{map:{value:null},occlusionMap:{value:null},color:{value:null},scale:{value:null},screenPosition:{value:null}},vertexShader:`

		precision highp float;

		uniform vec3 screenPosition;
		uniform vec2 scale;

		uniform sampler2D occlusionMap;

		attribute vec3 position;
		attribute vec2 uv;

		varying vec2 vUV;
		varying float vVisibility;

		void main() {

			vUV = uv;

			vec2 pos = position.xy;

			vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );
			visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );
			visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );
			visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );
			visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );
			visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );
			visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );
			visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );
			visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );

			vVisibility =        visibility.r / 9.0;
			vVisibility *= 1.0 - visibility.g / 9.0;
			vVisibility *=       visibility.b / 9.0;

			gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );

		}`,fragmentShader:`

		precision highp float;

		uniform sampler2D map;
		uniform vec3 color;

		varying vec2 vUV;
		varying float vVisibility;

		void main() {

			vec4 texture = texture2D( map, vUV );
			texture.a *= vVisibility;
			gl_FragColor = texture;
			gl_FragColor.rgb *= color;

		}`});class eA{constructor(e=Math){x(this,"grad3",[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]]),x(this,"grad4",[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]]),x(this,"p",[]),x(this,"perm",[]),x(this,"simplex",[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]),x(this,"dot",(e,t,r)=>e[0]*t+e[1]*r),x(this,"dot3",(e,t,r,i)=>e[0]*t+e[1]*r+e[2]*i),x(this,"dot4",(e,t,r,i,n)=>e[0]*t+e[1]*r+e[2]*i+e[3]*n),x(this,"noise",(e,t)=>{let r,i,n;let a=.5*(Math.sqrt(3)-1)*(e+t),s=Math.floor(e+a),o=Math.floor(t+a),l=(3-Math.sqrt(3))/6,c=(s+o)*l,u=e-(s-c),h=t-(o-c),p=0,d=1;u>h&&(p=1,d=0);let f=u-p+l,m=h-d+l,g=u-1+2*l,v=h-1+2*l,y=255&s,x=255&o,T=this.perm[y+this.perm[x]]%12,b=this.perm[y+p+this.perm[x+d]]%12,S=this.perm[y+1+this.perm[x+1]]%12,E=.5-u*u-h*h;E<0?r=0:(E*=E,r=E*E*this.dot(this.grad3[T],u,h));let R=.5-f*f-m*m;R<0?i=0:(R*=R,i=R*R*this.dot(this.grad3[b],f,m));let A=.5-g*g-v*v;return A<0?n=0:(A*=A,n=A*A*this.dot(this.grad3[S],g,v)),70*(r+i+n)}),x(this,"noise3d",(e,t,r)=>{let i,n,a,s,o,l,c,u,h,p;let d=1/3*(e+t+r),f=Math.floor(e+d),m=Math.floor(t+d),g=Math.floor(r+d),v=1/6*(f+m+g),y=e-(f-v),x=t-(m-v),T=r-(g-v);y>=x?x>=T?(o=1,l=0,c=0,u=1,h=1,p=0):(y>=T?(o=1,l=0,c=0):(o=0,l=0,c=1),u=1,h=0,p=1):x<T?(o=0,l=0,c=1,u=0,h=1,p=1):y<T?(o=0,l=1,c=0,u=0,h=1,p=1):(o=0,l=1,c=0,u=1,h=1,p=0);let b=y-o+1/6,S=x-l+1/6,E=T-c+1/6,R=y-u+1/6*2,A=x-h+1/6*2,w=T-p+1/6*2,M=y-1+1/6*3,C=x-1+1/6*3,I=T-1+1/6*3,N=255&f,O=255&m,P=255&g,k=this.perm[N+this.perm[O+this.perm[P]]]%12,_=this.perm[N+o+this.perm[O+l+this.perm[P+c]]]%12,L=this.perm[N+u+this.perm[O+h+this.perm[P+p]]]%12,U=this.perm[N+1+this.perm[O+1+this.perm[P+1]]]%12,D=.6-y*y-x*x-T*T;D<0?i=0:(D*=D,i=D*D*this.dot3(this.grad3[k],y,x,T));let F=.6-b*b-S*S-E*E;F<0?n=0:(F*=F,n=F*F*this.dot3(this.grad3[_],b,S,E));let B=.6-R*R-A*A-w*w;B<0?a=0:(B*=B,a=B*B*this.dot3(this.grad3[L],R,A,w));let V=.6-M*M-C*C-I*I;return V<0?s=0:(V*=V,s=V*V*this.dot3(this.grad3[U],M,C,I)),32*(i+n+a+s)}),x(this,"noise4d",(e,t,r,i)=>{let n,a,s,o,l,c,u,h,p,d,f,m,g,v,y,x,T;let b=this.grad4,S=this.simplex,E=this.perm,R=(5-Math.sqrt(5))/20,A=(Math.sqrt(5)-1)/4*(e+t+r+i),w=Math.floor(e+A),M=Math.floor(t+A),C=Math.floor(r+A),I=Math.floor(i+A),N=(w+M+C+I)*R,O=e-(w-N),P=t-(M-N),k=r-(C-N),_=i-(I-N),L=(O>P?32:0)+(O>k?16:0)+(P>k?8:0)+(O>_?4:0)+(P>_?2:0)+(k>_?1:0);c=S[L][0]>=3?1:0,u=S[L][1]>=3?1:0,h=S[L][2]>=3?1:0,p=S[L][3]>=3?1:0,d=S[L][0]>=2?1:0,f=S[L][1]>=2?1:0,m=S[L][2]>=2?1:0,g=S[L][3]>=2?1:0,v=S[L][0]>=1?1:0,y=S[L][1]>=1?1:0,x=S[L][2]>=1?1:0,T=S[L][3]>=1?1:0;let U=O-c+R,D=P-u+R,F=k-h+R,B=_-p+R,V=O-d+2*R,G=P-f+2*R,z=k-m+2*R,j=_-g+2*R,H=O-v+3*R,W=P-y+3*R,K=k-x+3*R,X=_-T+3*R,Y=O-1+4*R,q=P-1+4*R,Z=k-1+4*R,$=_-1+4*R,Q=255&w,J=255&M,ee=255&C,et=255&I,er=E[Q+E[J+E[ee+E[et]]]]%32,ei=E[Q+c+E[J+u+E[ee+h+E[et+p]]]]%32,en=E[Q+d+E[J+f+E[ee+m+E[et+g]]]]%32,ea=E[Q+v+E[J+y+E[ee+x+E[et+T]]]]%32,es=E[Q+1+E[J+1+E[ee+1+E[et+1]]]]%32,eo=.6-O*O-P*P-k*k-_*_;eo<0?n=0:(eo*=eo,n=eo*eo*this.dot4(b[er],O,P,k,_));let el=.6-U*U-D*D-F*F-B*B;el<0?a=0:(el*=el,a=el*el*this.dot4(b[ei],U,D,F,B));let ec=.6-V*V-G*G-z*z-j*j;ec<0?s=0:(ec*=ec,s=ec*ec*this.dot4(b[en],V,G,z,j));let eu=.6-H*H-W*W-K*K-X*X;eu<0?o=0:(eu*=eu,o=eu*eu*this.dot4(b[ea],H,W,K,X));let eh=.6-Y*Y-q*q-Z*Z-$*$;return eh<0?l=0:(eh*=eh,l=eh*eh*this.dot4(b[es],Y,q,Z,$)),27*(n+a+s+o+l)});for(let t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());for(let e=0;e<512;e++)this.perm[e]=this.p[255&e]}}let ew=class extends f.BufferGeometry{constructor(e={}){super(),this.isLightningStrike=!0,this.type="LightningStrike",this.init(ew.copyParameters(e,e)),this.createMesh()}static createRandomGenerator(){let e=[];for(let t=0;t<2053;t++)e.push(Math.random());let t={currentSeed:0,random:function(){let r=e[t.currentSeed];return t.currentSeed=(t.currentSeed+1)%2053,r},getSeed:function(){return t.currentSeed/2053},setSeed:function(e){t.currentSeed=Math.floor(2053*e)%2053}};return t}static copyParameters(e={},t={}){let r=function(r){return t===e?r:r.clone()};return e.sourceOffset=void 0!==t.sourceOffset?r(t.sourceOffset):new f.Vector3(0,100,0),e.destOffset=void 0!==t.destOffset?r(t.destOffset):new f.Vector3(0,0,0),e.timeScale=void 0!==t.timeScale?t.timeScale:1,e.roughness=void 0!==t.roughness?t.roughness:.9,e.straightness=void 0!==t.straightness?t.straightness:.7,e.up0=void 0!==t.up0?r(t.up0):new f.Vector3(0,0,1),e.up1=void 0!==t.up1?r(t.up1):new f.Vector3(0,0,1),e.radius0=void 0!==t.radius0?t.radius0:1,e.radius1=void 0!==t.radius1?t.radius1:1,e.radius0Factor=void 0!==t.radius0Factor?t.radius0Factor:.5,e.radius1Factor=void 0!==t.radius1Factor?t.radius1Factor:.2,e.minRadius=void 0!==t.minRadius?t.minRadius:.2,e.isEternal=void 0!==t.isEternal?t.isEternal:void 0===t.birthTime||void 0===t.deathTime,e.birthTime=t.birthTime,e.deathTime=t.deathTime,e.propagationTimeFactor=void 0!==t.propagationTimeFactor?t.propagationTimeFactor:.1,e.vanishingTimeFactor=void 0!==t.vanishingTimeFactor?t.vanishingTimeFactor:.9,e.subrayPeriod=void 0!==t.subrayPeriod?t.subrayPeriod:4,e.subrayDutyCycle=void 0!==t.subrayDutyCycle?t.subrayDutyCycle:.6,e.maxIterations=void 0!==t.maxIterations?t.maxIterations:9,e.isStatic=void 0!==t.isStatic&&t.isStatic,e.ramification=void 0!==t.ramification?t.ramification:5,e.maxSubrayRecursion=void 0!==t.maxSubrayRecursion?t.maxSubrayRecursion:3,e.recursionProbability=void 0!==t.recursionProbability?t.recursionProbability:.6,e.generateUVs=void 0!==t.generateUVs&&t.generateUVs,e.randomGenerator=t.randomGenerator,e.noiseSeed=t.noiseSeed,e.onDecideSubrayCreation=t.onDecideSubrayCreation,e.onSubrayCreation=t.onSubrayCreation,e}update(e){this.isStatic||(this.rayParameters.isEternal||this.rayParameters.birthTime<=e&&e<=this.rayParameters.deathTime?(this.updateMesh(e),e<this.subrays[0].endPropagationTime?this.state=ew.RAY_PROPAGATING:e>this.subrays[0].beginVanishingTime?this.state=ew.RAY_VANISHING:this.state=ew.RAY_STEADY,this.visible=!0):(this.visible=!1,e<this.rayParameters.birthTime?this.state=ew.RAY_UNBORN:this.state=ew.RAY_EXTINGUISHED))}init(e){this.rayParameters=e,this.maxIterations=void 0!==e.maxIterations?Math.floor(e.maxIterations):9,e.maxIterations=this.maxIterations,this.isStatic=void 0!==e.isStatic&&e.isStatic,e.isStatic=this.isStatic,this.ramification=void 0!==e.ramification?Math.floor(e.ramification):5,e.ramification=this.ramification,this.maxSubrayRecursion=void 0!==e.maxSubrayRecursion?Math.floor(e.maxSubrayRecursion):3,e.maxSubrayRecursion=this.maxSubrayRecursion,this.recursionProbability=void 0!==e.recursionProbability?e.recursionProbability:.6,e.recursionProbability=this.recursionProbability,this.generateUVs=void 0!==e.generateUVs&&e.generateUVs,e.generateUVs=this.generateUVs,void 0!==e.randomGenerator?(this.randomGenerator=e.randomGenerator,this.seedGenerator=e.randomGenerator,void 0!==e.noiseSeed&&this.seedGenerator.setSeed(e.noiseSeed)):(this.randomGenerator=ew.createRandomGenerator(),this.seedGenerator=Math),void 0!==e.onDecideSubrayCreation?this.onDecideSubrayCreation=e.onDecideSubrayCreation:(this.createDefaultSubrayCreationCallbacks(),void 0!==e.onSubrayCreation&&(this.onSubrayCreation=e.onSubrayCreation)),this.state=ew.RAY_INITIALIZED,this.maxSubrays=Math.ceil(1+Math.pow(this.ramification,Math.max(0,this.maxSubrayRecursion-1))),e.maxSubrays=this.maxSubrays,this.maxRaySegments=2*(1<<this.maxIterations),this.subrays=[];for(let e=0;e<this.maxSubrays;e++)this.subrays.push(this.createSubray());this.raySegments=[];for(let e=0;e<this.maxRaySegments;e++)this.raySegments.push(this.createSegment());this.time=0,this.timeFraction=0,this.currentSegmentCallback=null,this.currentCreateTriangleVertices=this.generateUVs?this.createTriangleVerticesWithUVs:this.createTriangleVerticesWithoutUVs,this.numSubrays=0,this.currentSubray=null,this.currentSegmentIndex=0,this.isInitialSegment=!1,this.subrayProbability=0,this.currentVertex=0,this.currentIndex=0,this.currentCoordinate=0,this.currentUVCoordinate=0,this.vertices=null,this.uvs=null,this.indices=null,this.positionAttribute=null,this.uvsAttribute=null,this.simplexX=new eA(this.seedGenerator),this.simplexY=new eA(this.seedGenerator),this.simplexZ=new eA(this.seedGenerator),this.forwards=new f.Vector3,this.forwardsFill=new f.Vector3,this.side=new f.Vector3,this.down=new f.Vector3,this.middlePos=new f.Vector3,this.middleLinPos=new f.Vector3,this.newPos=new f.Vector3,this.vPos=new f.Vector3,this.cross1=new f.Vector3}createMesh(){let e=1<<this.maxIterations,t=3*(e+1)*this.maxSubrays,r=18*e*this.maxSubrays;this.vertices=new Float32Array(3*t),this.indices=new Uint32Array(r),this.generateUVs&&(this.uvs=new Float32Array(2*t)),this.fillMesh(0),this.setIndex(new f.Uint32BufferAttribute(this.indices,1)),this.positionAttribute=new f.Float32BufferAttribute(this.vertices,3),this.setAttribute("position",this.positionAttribute),this.generateUVs&&(this.uvsAttribute=new f.Float32BufferAttribute(new Float32Array(this.uvs),2),this.setAttribute("uv",this.uvsAttribute)),!this.isStatic&&(this.index.usage=f.DynamicDrawUsage,this.positionAttribute.usage=f.DynamicDrawUsage,this.generateUVs&&(this.uvsAttribute.usage=f.DynamicDrawUsage)),this.vertices=this.positionAttribute.array,this.indices=this.index.array,this.generateUVs&&(this.uvs=this.uvsAttribute.array)}updateMesh(e){this.fillMesh(e),this.drawRange.count=this.currentIndex,this.index.needsUpdate=!0,this.positionAttribute.needsUpdate=!0,this.generateUVs&&(this.uvsAttribute.needsUpdate=!0)}fillMesh(e){let t=this;this.currentVertex=0,this.currentIndex=0,this.currentCoordinate=0,this.currentUVCoordinate=0,this.fractalRay(e,function(r){let i=t.currentSubray;!(e<i.birthTime)&&(this.rayParameters.isEternal&&0==t.currentSubray.recursion?(t.createPrism(r),t.onDecideSubrayCreation(r,t)):e<i.endPropagationTime?t.timeFraction>=r.fraction0*i.propagationTimeFactor&&(t.createPrism(r),t.onDecideSubrayCreation(r,t)):(e<i.beginVanishingTime?t.createPrism(r):t.timeFraction<=i.vanishingTimeFactor+r.fraction1*(1-i.vanishingTimeFactor)&&t.createPrism(r),t.onDecideSubrayCreation(r,t)))})}addNewSubray(){return this.subrays[this.numSubrays++]}initSubray(e,t){e.pos0.copy(t.sourceOffset),e.pos1.copy(t.destOffset),e.up0.copy(t.up0),e.up1.copy(t.up1),e.radius0=t.radius0,e.radius1=t.radius1,e.birthTime=t.birthTime,e.deathTime=t.deathTime,e.timeScale=t.timeScale,e.roughness=t.roughness,e.straightness=t.straightness,e.propagationTimeFactor=t.propagationTimeFactor,e.vanishingTimeFactor=t.vanishingTimeFactor,e.maxIterations=this.maxIterations,e.seed=void 0!==t.noiseSeed?t.noiseSeed:0,e.recursion=0}fractalRay(e,t){this.time=e,this.currentSegmentCallback=t,this.numSubrays=0,this.initSubray(this.addNewSubray(),this.rayParameters);for(let t=0;t<this.numSubrays;t++){let r=this.subrays[t];this.currentSubray=r,this.randomGenerator.setSeed(r.seed),r.endPropagationTime=f.MathUtils.lerp(r.birthTime,r.deathTime,r.propagationTimeFactor),r.beginVanishingTime=f.MathUtils.lerp(r.deathTime,r.birthTime,1-r.vanishingTimeFactor);let i=this.randomGenerator.random;r.linPos0.set(i(),i(),i()).multiplyScalar(1e3),r.linPos1.set(i(),i(),i()).multiplyScalar(1e3),this.timeFraction=(e-r.birthTime)/(r.deathTime-r.birthTime),this.currentSegmentIndex=0,this.isInitialSegment=!0;let n=this.getNewSegment();n.iteration=0,n.pos0.copy(r.pos0),n.pos1.copy(r.pos1),n.linPos0.copy(r.linPos0),n.linPos1.copy(r.linPos1),n.up0.copy(r.up0),n.up1.copy(r.up1),n.radius0=r.radius0,n.radius1=r.radius1,n.fraction0=0,n.fraction1=1,n.positionVariationFactor=1-r.straightness,this.subrayProbability=this.ramification*Math.pow(this.recursionProbability,r.recursion)/(1<<r.maxIterations),this.fractalRayRecursive(n)}this.currentSegmentCallback=null,this.currentSubray=null}fractalRayRecursive(e){if(e.iteration>=this.currentSubray.maxIterations){this.currentSegmentCallback(e);return}this.forwards.subVectors(e.pos1,e.pos0);let t=this.forwards.length();t<1e-6&&(this.forwards.set(0,0,.01),t=this.forwards.length());let r=(e.radius0+e.radius1)*.5,i=(e.fraction0+e.fraction1)*.5,n=this.time*this.currentSubray.timeScale*Math.pow(2,e.iteration);this.middlePos.lerpVectors(e.pos0,e.pos1,.5),this.middleLinPos.lerpVectors(e.linPos0,e.linPos1,.5);let a=this.middleLinPos;this.newPos.set(this.simplexX.noise4d(a.x,a.y,a.z,n),this.simplexY.noise4d(a.x,a.y,a.z,n),this.simplexZ.noise4d(a.x,a.y,a.z,n)),this.newPos.multiplyScalar(e.positionVariationFactor*t),this.newPos.add(this.middlePos);let s=this.getNewSegment();s.pos0.copy(e.pos0),s.pos1.copy(this.newPos),s.linPos0.copy(e.linPos0),s.linPos1.copy(this.middleLinPos),s.up0.copy(e.up0),s.up1.copy(e.up1),s.radius0=e.radius0,s.radius1=r,s.fraction0=e.fraction0,s.fraction1=i,s.positionVariationFactor=e.positionVariationFactor*this.currentSubray.roughness,s.iteration=e.iteration+1;let o=this.getNewSegment();o.pos0.copy(this.newPos),o.pos1.copy(e.pos1),o.linPos0.copy(this.middleLinPos),o.linPos1.copy(e.linPos1),this.cross1.crossVectors(e.up0,this.forwards.normalize()),o.up0.crossVectors(this.forwards,this.cross1).normalize(),o.up1.copy(e.up1),o.radius0=r,o.radius1=e.radius1,o.fraction0=i,o.fraction1=e.fraction1,o.positionVariationFactor=e.positionVariationFactor*this.currentSubray.roughness,o.iteration=e.iteration+1,this.fractalRayRecursive(s),this.fractalRayRecursive(o)}createPrism(e){this.forwardsFill.subVectors(e.pos1,e.pos0).normalize(),this.isInitialSegment&&(this.currentCreateTriangleVertices(e.pos0,e.up0,this.forwardsFill,e.radius0,0),this.isInitialSegment=!1),this.currentCreateTriangleVertices(e.pos1,e.up0,this.forwardsFill,e.radius1,e.fraction1),this.createPrismFaces()}createTriangleVerticesWithoutUVs(e,t,r,i){this.side.crossVectors(t,r).multiplyScalar(i*ew.COS30DEG),this.down.copy(t).multiplyScalar(-i*ew.SIN30DEG);let n=this.vPos,a=this.vertices;n.copy(e).sub(this.side).add(this.down),a[this.currentCoordinate++]=n.x,a[this.currentCoordinate++]=n.y,a[this.currentCoordinate++]=n.z,n.copy(e).add(this.side).add(this.down),a[this.currentCoordinate++]=n.x,a[this.currentCoordinate++]=n.y,a[this.currentCoordinate++]=n.z,n.copy(t).multiplyScalar(i).add(e),a[this.currentCoordinate++]=n.x,a[this.currentCoordinate++]=n.y,a[this.currentCoordinate++]=n.z,this.currentVertex+=3}createTriangleVerticesWithUVs(e,t,r,i,n){this.side.crossVectors(t,r).multiplyScalar(i*ew.COS30DEG),this.down.copy(t).multiplyScalar(-i*ew.SIN30DEG);let a=this.vPos,s=this.vertices,o=this.uvs;a.copy(e).sub(this.side).add(this.down),s[this.currentCoordinate++]=a.x,s[this.currentCoordinate++]=a.y,s[this.currentCoordinate++]=a.z,o[this.currentUVCoordinate++]=n,o[this.currentUVCoordinate++]=0,a.copy(e).add(this.side).add(this.down),s[this.currentCoordinate++]=a.x,s[this.currentCoordinate++]=a.y,s[this.currentCoordinate++]=a.z,o[this.currentUVCoordinate++]=n,o[this.currentUVCoordinate++]=.5,a.copy(t).multiplyScalar(i).add(e),s[this.currentCoordinate++]=a.x,s[this.currentCoordinate++]=a.y,s[this.currentCoordinate++]=a.z,o[this.currentUVCoordinate++]=n,o[this.currentUVCoordinate++]=1,this.currentVertex+=3}createPrismFaces(e){let t=this.indices;e=this.currentVertex-6,t[this.currentIndex++]=e+1,t[this.currentIndex++]=e+2,t[this.currentIndex++]=e+5,t[this.currentIndex++]=e+1,t[this.currentIndex++]=e+5,t[this.currentIndex++]=e+4,t[this.currentIndex++]=e+0,t[this.currentIndex++]=e+1,t[this.currentIndex++]=e+4,t[this.currentIndex++]=e+0,t[this.currentIndex++]=e+4,t[this.currentIndex++]=e+3,t[this.currentIndex++]=e+2,t[this.currentIndex++]=e+0,t[this.currentIndex++]=e+3,t[this.currentIndex++]=e+2,t[this.currentIndex++]=e+3,t[this.currentIndex++]=e+5}createDefaultSubrayCreationCallbacks(){let e=this.randomGenerator.random;this.onDecideSubrayCreation=function(t,r){let i=r.currentSubray,n=r.rayParameters.subrayPeriod,a=r.rayParameters.subrayDutyCycle,s=r.rayParameters.isEternal&&0==i.recursion?-e()*n:f.MathUtils.lerp(i.birthTime,i.endPropagationTime,t.fraction0)-e()*n,o=r.time-s,l=Math.floor(o/n),c=e()*(l+1),u=0;if(o%n<=a*n&&(u=r.subrayProbability),i.recursion<r.maxSubrayRecursion&&r.numSubrays<r.maxSubrays&&e()<u){let o=r.addNewSubray(),u=r.randomGenerator.getSeed();o.seed=c,r.randomGenerator.setSeed(c),o.recursion=i.recursion+1,o.maxIterations=Math.max(1,i.maxIterations-1),o.linPos0.set(e(),e(),e()).multiplyScalar(1e3),o.linPos1.set(e(),e(),e()).multiplyScalar(1e3),o.up0.copy(i.up0),o.up1.copy(i.up1),o.radius0=t.radius0*r.rayParameters.radius0Factor,o.radius1=Math.min(r.rayParameters.minRadius,t.radius1*r.rayParameters.radius1Factor),o.birthTime=s+l*n,o.deathTime=o.birthTime+n*a,r.rayParameters.isEternal||0!=i.recursion||(o.birthTime=Math.max(o.birthTime,i.birthTime),o.deathTime=Math.min(o.deathTime,i.deathTime)),o.timeScale=2*i.timeScale,o.roughness=i.roughness,o.straightness=i.straightness,o.propagationTimeFactor=i.propagationTimeFactor,o.vanishingTimeFactor=i.vanishingTimeFactor,r.onSubrayCreation(t,i,o,r),r.randomGenerator.setSeed(u)}};let t=new f.Vector3,r=new f.Vector3,i=new f.Vector3,n=new f.Vector3;this.onSubrayCreation=function(e,t,r,i){i.subrayCylinderPosition(e,t,r,.5,.6,.2)},this.subrayConePosition=function(a,s,o,l,c,u){o.pos0.copy(a.pos0),t.subVectors(s.pos1,s.pos0),r.copy(t).normalize(),t.multiplyScalar(a.fraction0+(1-a.fraction0)*(e()*l));let h=t.length();i.crossVectors(s.up0,r);let p=2*Math.PI*e();i.multiplyScalar(Math.cos(p)),n.copy(s.up0).multiplyScalar(Math.sin(p)),o.pos1.copy(i).add(n).multiplyScalar(h*c*(u+e()*(1-u))).add(t).add(s.pos0)},this.subrayCylinderPosition=function(a,s,o,l,c,u){o.pos0.copy(a.pos0),t.subVectors(s.pos1,s.pos0),r.copy(t).normalize(),t.multiplyScalar(a.fraction0+(1-a.fraction0)*((2*e()-1)*l));let h=t.length();i.crossVectors(s.up0,r);let p=2*Math.PI*e();i.multiplyScalar(Math.cos(p)),n.copy(s.up0).multiplyScalar(Math.sin(p)),o.pos1.copy(i).add(n).multiplyScalar(h*c*(u+e()*(1-u))).add(t).add(s.pos0)}}createSubray(){return{seed:0,maxIterations:0,recursion:0,pos0:new f.Vector3,pos1:new f.Vector3,linPos0:new f.Vector3,linPos1:new f.Vector3,up0:new f.Vector3,up1:new f.Vector3,radius0:0,radius1:0,birthTime:0,deathTime:0,timeScale:0,roughness:0,straightness:0,propagationTimeFactor:0,vanishingTimeFactor:0,endPropagationTime:0,beginVanishingTime:0}}createSegment(){return{iteration:0,pos0:new f.Vector3,pos1:new f.Vector3,linPos0:new f.Vector3,linPos1:new f.Vector3,up0:new f.Vector3,up1:new f.Vector3,radius0:0,radius1:0,fraction0:0,fraction1:0,positionVariationFactor:0}}getNewSegment(){return this.raySegments[this.currentSegmentIndex++]}copy(e){return super.copy(e),this.init(ew.copyParameters({},e.rayParameters)),this}clone(){return new this.constructor(ew.copyParameters({},this.rayParameters))}};x(ew,"RAY_UNBORN",1),x(ew,"RAY_PROPAGATING",2),x(ew,"RAY_STEADY",3),x(ew,"RAY_VANISHING",4),x(ew,"RAY_EXTINGUISHED",5),x(ew,"COS30DEG",Math.cos(30*Math.PI/180)),x(ew,"SIN30DEG",Math.sin(30*Math.PI/180));let eM=class extends f.Mesh{constructor(e,t={}){let r;super(e),this.isReflectorForSSRPass=!0,this.type="ReflectorForSSRPass";let i=this,n=new f.Color(void 0!==t.color?t.color:8355711),a=t.textureWidth||512,s=t.textureHeight||512,o=t.clipBias||0,l=t.shader||eM.ReflectorShader,c=!0===t.useDepthTexture,u=new f.Vector3(0,1,0),h=new f.Vector3,p=new f.Vector3;i.needsUpdate=!1,i.maxDistance=eM.ReflectorShader.uniforms.maxDistance.value,i.opacity=eM.ReflectorShader.uniforms.opacity.value,i.color=n,i.resolution=t.resolution||new f.Vector2(window.innerWidth,window.innerHeight),i._distanceAttenuation=eM.ReflectorShader.defines.DISTANCE_ATTENUATION,Object.defineProperty(i,"distanceAttenuation",{get:()=>i._distanceAttenuation,set(e){i._distanceAttenuation!==e&&(i._distanceAttenuation=e,i.material.defines.DISTANCE_ATTENUATION=e,i.material.needsUpdate=!0)}}),i._fresnel=eM.ReflectorShader.defines.FRESNEL,Object.defineProperty(i,"fresnel",{get:()=>i._fresnel,set(e){i._fresnel!==e&&(i._fresnel=e,i.material.defines.FRESNEL=e,i.material.needsUpdate=!0)}});let d=new f.Vector3,m=new f.Vector3,g=new f.Vector3,v=new f.Matrix4,y=new f.Vector3(0,0,-1),x=new f.Vector3,T=new f.Vector3,b=new f.Matrix4,S=new f.PerspectiveCamera;c&&((r=new f.DepthTexture).type=f.UnsignedShortType,r.minFilter=f.NearestFilter,r.magFilter=f.NearestFilter);let E={depthTexture:c?r:null,type:f.HalfFloatType},R=new f.WebGLRenderTarget(a,s,E),A=new f.ShaderMaterial({transparent:c,defines:Object.assign({},eM.ReflectorShader.defines,{useDepthTexture:c}),uniforms:f.UniformsUtils.clone(l.uniforms),fragmentShader:l.fragmentShader,vertexShader:l.vertexShader});A.uniforms.tDiffuse.value=R.texture,A.uniforms.color.value=i.color,A.uniforms.textureMatrix.value=b,c&&(A.uniforms.tDepth.value=R.depthTexture),this.material=A;let w=[new f.Plane(new f.Vector3(0,1,0),o)];this.doRender=function(e,t,r){if(A.uniforms.maxDistance.value=i.maxDistance,A.uniforms.color.value=i.color,A.uniforms.opacity.value=i.opacity,h.copy(r.position).normalize(),p.copy(h).reflect(u),A.uniforms.fresnelCoe.value=(h.dot(p)+1)/2,m.setFromMatrixPosition(i.matrixWorld),g.setFromMatrixPosition(r.matrixWorld),v.extractRotation(i.matrixWorld),d.set(0,0,1),d.applyMatrix4(v),x.subVectors(m,g),x.dot(d)>0)return;x.reflect(d).negate(),x.add(m),v.extractRotation(r.matrixWorld),y.set(0,0,-1),y.applyMatrix4(v),y.add(g),T.subVectors(m,y),T.reflect(d).negate(),T.add(m),S.position.copy(x),S.up.set(0,1,0),S.up.applyMatrix4(v),S.up.reflect(d),S.lookAt(T),S.far=r.far,S.updateMatrixWorld(),S.projectionMatrix.copy(r.projectionMatrix),A.uniforms.virtualCameraNear.value=r.near,A.uniforms.virtualCameraFar.value=r.far,A.uniforms.virtualCameraMatrixWorld.value=S.matrixWorld,A.uniforms.virtualCameraProjectionMatrix.value=r.projectionMatrix,A.uniforms.virtualCameraProjectionMatrixInverse.value=r.projectionMatrixInverse,A.uniforms.resolution.value=i.resolution,b.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),b.multiply(S.projectionMatrix),b.multiply(S.matrixWorldInverse),b.multiply(i.matrixWorld);let n=e.getRenderTarget(),a=e.xr.enabled,s=e.shadowMap.autoUpdate,o=e.clippingPlanes;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.clippingPlanes=w,e.setRenderTarget(R),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,S),e.xr.enabled=a,e.shadowMap.autoUpdate=s,e.clippingPlanes=o,e.setRenderTarget(n);let l=r.viewport;void 0!==l&&e.state.viewport(l)},this.getRenderTarget=function(){return R}}};x(eM,"ReflectorShader",{defines:{DISTANCE_ATTENUATION:!0,FRESNEL:!0},uniforms:{color:{value:null},tDiffuse:{value:null},tDepth:{value:null},textureMatrix:{value:new f.Matrix4},maxDistance:{value:180},opacity:{value:.5},fresnelCoe:{value:null},virtualCameraNear:{value:null},virtualCameraFar:{value:null},virtualCameraProjectionMatrix:{value:new f.Matrix4},virtualCameraMatrixWorld:{value:new f.Matrix4},virtualCameraProjectionMatrixInverse:{value:new f.Matrix4},resolution:{value:new f.Vector2}},vertexShader:`
		uniform mat4 textureMatrix;
		varying vec4 vUv;

		void main() {

			vUv = textureMatrix * vec4( position, 1.0 );

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`
		uniform vec3 color;
		uniform sampler2D tDiffuse;
		uniform sampler2D tDepth;
		uniform float maxDistance;
		uniform float opacity;
		uniform float fresnelCoe;
		uniform float virtualCameraNear;
		uniform float virtualCameraFar;
		uniform mat4 virtualCameraProjectionMatrix;
		uniform mat4 virtualCameraProjectionMatrixInverse;
		uniform mat4 virtualCameraMatrixWorld;
		uniform vec2 resolution;
		varying vec4 vUv;
		#include <packing>
		float blendOverlay( float base, float blend ) {
			return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );
		}
		vec3 blendOverlay( vec3 base, vec3 blend ) {
			return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );
		}
		float getDepth( const in vec2 uv ) {
			return texture2D( tDepth, uv ).x;
		}
		float getViewZ( const in float depth ) {
			return perspectiveDepthToViewZ( depth, virtualCameraNear, virtualCameraFar );
		}
		vec3 getViewPosition( const in vec2 uv, const in float depth/*clip space*/, const in float clipW ) {
			vec4 clipPosition = vec4( ( vec3( uv, depth ) - 0.5 ) * 2.0, 1.0 );//ndc
			clipPosition *= clipW; //clip
			return ( virtualCameraProjectionMatrixInverse * clipPosition ).xyz;//view
		}
		void main() {
			vec4 base = texture2DProj( tDiffuse, vUv );
			#ifdef useDepthTexture
				vec2 uv=(gl_FragCoord.xy-.5)/resolution.xy;
				uv.x=1.-uv.x;
				float depth = texture2DProj( tDepth, vUv ).r;
				float viewZ = getViewZ( depth );
				float clipW = virtualCameraProjectionMatrix[2][3] * viewZ+virtualCameraProjectionMatrix[3][3];
				vec3 viewPosition=getViewPosition( uv, depth, clipW );
				vec3 worldPosition=(virtualCameraMatrixWorld*vec4(viewPosition,1)).xyz;
				if(worldPosition.y>maxDistance) discard;
				float op=opacity;
				#ifdef DISTANCE_ATTENUATION
					float ratio=1.-(worldPosition.y/maxDistance);
					float attenuation=ratio*ratio;
					op=opacity*attenuation;
				#endif
				#ifdef FRESNEL
					op*=fresnelCoe;
				#endif
				gl_FragColor = vec4( blendOverlay( base.rgb, color ), op );
			#else
				gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );
			#endif
		}
	`});let eC={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new f.Vector3},up:{value:new f.Vector3(0,1,0)}},vertexShader:`
      uniform vec3 sunPosition;
      uniform float rayleigh;
      uniform float turbidity;
      uniform float mieCoefficient;
      uniform vec3 up;

      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      // constants for atmospheric scattering
      const float e = 2.71828182845904523536028747135266249775724709369995957;
      const float pi = 3.141592653589793238462643383279502884197169;

      // wavelength of used primaries, according to preetham
      const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );
      // this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:
      // (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))
      const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );

      // mie stuff
      // K coefficient for the primaries
      const float v = 4.0;
      const vec3 K = vec3( 0.686, 0.678, 0.666 );
      // MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K
      const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );

      // earth shadow hack
      // cutoffAngle = pi / 1.95;
      const float cutoffAngle = 1.6110731556870734;
      const float steepness = 1.5;
      const float EE = 1000.0;

      float sunIntensity( float zenithAngleCos ) {
        zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );
        return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );
      }

      vec3 totalMie( float T ) {
        float c = ( 0.2 * T ) * 10E-18;
        return 0.434 * c * MieConst;
      }

      void main() {

        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
        vWorldPosition = worldPosition.xyz;

        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        gl_Position.z = gl_Position.w; // set z to camera.far

        vSunDirection = normalize( sunPosition );

        vSunE = sunIntensity( dot( vSunDirection, up ) );

        vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );

        float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );

      // extinction (absorbtion + out scattering)
      // rayleigh coefficients
        vBetaR = totalRayleigh * rayleighCoefficient;

      // mie coefficients
        vBetaM = totalMie( turbidity ) * mieCoefficient;

      }
    `,fragmentShader:`
      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      uniform float mieDirectionalG;
      uniform vec3 up;

      const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );

      // constants for atmospheric scattering
      const float pi = 3.141592653589793238462643383279502884197169;

      const float n = 1.0003; // refractive index of air
      const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)

      // optical length at zenith for molecules
      const float rayleighZenithLength = 8.4E3;
      const float mieZenithLength = 1.25E3;
      // 66 arc seconds -> degrees, and the cosine of that
      const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;

      // 3.0 / ( 16.0 * pi )
      const float THREE_OVER_SIXTEENPI = 0.05968310365946075;
      // 1.0 / ( 4.0 * pi )
      const float ONE_OVER_FOURPI = 0.07957747154594767;

      float rayleighPhase( float cosTheta ) {
        return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );
      }

      float hgPhase( float cosTheta, float g ) {
        float g2 = pow( g, 2.0 );
        float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );
        return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );
      }

      void main() {

        vec3 direction = normalize( vWorldPosition - cameraPos );

      // optical length
      // cutoff angle at 90 to avoid singularity in next formula.
        float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );
        float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );
        float sR = rayleighZenithLength * inverse;
        float sM = mieZenithLength * inverse;

      // combined extinction factor
        vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );

      // in scattering
        float cosTheta = dot( direction, vSunDirection );

        float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );
        vec3 betaRTheta = vBetaR * rPhase;

        float mPhase = hgPhase( cosTheta, mieDirectionalG );
        vec3 betaMTheta = vBetaM * mPhase;

        vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );
        Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );

      // nightsky
        float theta = acos( direction.y ); // elevation --> y-axis, [-pi/2, pi/2]
        float phi = atan( direction.z, direction.x ); // azimuth --> x-axis [-pi/2, pi/2]
        vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );
        vec3 L0 = vec3( 0.1 ) * Fex;

      // composition + solar disc
        float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );
        L0 += ( vSunE * 19000.0 * Fex ) * sundisk;

        vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );

        vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );

        gl_FragColor = vec4( retColor, 1.0 );

      #include <tonemapping_fragment>
      #include <${ev>=154?"colorspace_fragment":"encodings_fragment"}>

      }
    `},eI=new f.ShaderMaterial({name:"SkyShader",fragmentShader:eC.fragmentShader,vertexShader:eC.vertexShader,uniforms:f.UniformsUtils.clone(eC.uniforms),side:f.BackSide,depthWrite:!1});class eN extends f.Mesh{constructor(){super(new f.BoxGeometry(1,1,1),eI)}}x(eN,"SkyShader",eC),x(eN,"material",eI);let eO=class extends f.Mesh{constructor(e,t={}){super(e),this.isWater=!0,this.type="Water";let r=this,i=new f.Color(void 0!==t.color?t.color:16777215),n=t.textureWidth||512,a=t.textureHeight||512,s=t.clipBias||0,o=t.flowDirection||new f.Vector2(1,0),l=t.flowSpeed||.03,c=t.reflectivity||.02,u=t.scale||1,h=t.shader||eO.WaterShader,p=void 0!==t.encoding?t.encoding:3e3,d=t.flowMap||void 0,m=t.normalMap0,g=t.normalMap1,v=new f.Matrix4,y=new f.Clock;if(void 0===ey){console.error("THREE.Water: Required component Reflector not found.");return}if(void 0===ex){console.error("THREE.Water: Required component Refractor not found.");return}let x=new ey(e,{textureWidth:n,textureHeight:a,clipBias:s,encoding:p}),T=new ex(e,{textureWidth:n,textureHeight:a,clipBias:s,encoding:p});x.matrixAutoUpdate=!1,T.matrixAutoUpdate=!1,this.material=new f.ShaderMaterial({uniforms:f.UniformsUtils.merge([f.UniformsLib.fog,h.uniforms]),vertexShader:h.vertexShader,fragmentShader:h.fragmentShader,transparent:!0,fog:!0}),void 0!==d?(this.material.defines.USE_FLOWMAP="",this.material.uniforms.tFlowMap={type:"t",value:d}):this.material.uniforms.flowDirection={type:"v2",value:o},m.wrapS=m.wrapT=f.RepeatWrapping,g.wrapS=g.wrapT=f.RepeatWrapping,this.material.uniforms.tReflectionMap.value=x.getRenderTarget().texture,this.material.uniforms.tRefractionMap.value=T.getRenderTarget().texture,this.material.uniforms.tNormalMap0.value=m,this.material.uniforms.tNormalMap1.value=g,this.material.uniforms.color.value=i,this.material.uniforms.reflectivity.value=c,this.material.uniforms.textureMatrix.value=v,this.material.uniforms.config.value.x=0,this.material.uniforms.config.value.y=.075,this.material.uniforms.config.value.z=.075,this.material.uniforms.config.value.w=u,this.onBeforeRender=function(e,t,i){v.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),v.multiply(i.projectionMatrix),v.multiply(i.matrixWorldInverse),v.multiply(r.matrixWorld),function(){let e=y.getDelta(),t=r.material.uniforms.config;t.value.x+=l*e,t.value.y=t.value.x+.075,t.value.x>=.15?(t.value.x=0,t.value.y=.075):t.value.y>=.15&&(t.value.y=t.value.y-.15)}(),r.visible=!1,x.matrixWorld.copy(r.matrixWorld),T.matrixWorld.copy(r.matrixWorld),x.onBeforeRender(e,t,i),T.onBeforeRender(e,t,i),r.visible=!0}}};x(eO,"WaterShader",{uniforms:{color:{value:null},reflectivity:{value:0},tReflectionMap:{value:null},tRefractionMap:{value:null},tNormalMap0:{value:null},tNormalMap1:{value:null},textureMatrix:{value:null},config:{value:new f.Vector4}},vertexShader:`

		#include <common>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>

		uniform mat4 textureMatrix;

		varying vec4 vCoord;
		varying vec2 vUv;
		varying vec3 vToEye;

		void main() {

			vUv = uv;
			vCoord = textureMatrix * vec4( position, 1.0 );

			vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
			vToEye = cameraPosition - worldPosition.xyz;

			vec4 mvPosition =  viewMatrix * worldPosition; // used in fog_vertex
			gl_Position = projectionMatrix * mvPosition;

			#include <logdepthbuf_vertex>
			#include <fog_vertex>

		}`,fragmentShader:`

		#include <common>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>

		uniform sampler2D tReflectionMap;
		uniform sampler2D tRefractionMap;
		uniform sampler2D tNormalMap0;
		uniform sampler2D tNormalMap1;

		#ifdef USE_FLOWMAP
			uniform sampler2D tFlowMap;
		#else
			uniform vec2 flowDirection;
		#endif

		uniform vec3 color;
		uniform float reflectivity;
		uniform vec4 config;

		varying vec4 vCoord;
		varying vec2 vUv;
		varying vec3 vToEye;

		void main() {

			#include <logdepthbuf_fragment>

			float flowMapOffset0 = config.x;
			float flowMapOffset1 = config.y;
			float halfCycle = config.z;
			float scale = config.w;

			vec3 toEye = normalize( vToEye );

			// determine flow direction
			vec2 flow;
			#ifdef USE_FLOWMAP
				flow = texture2D( tFlowMap, vUv ).rg * 2.0 - 1.0;
			#else
				flow = flowDirection;
			#endif
			flow.x *= - 1.0;

			// sample normal maps (distort uvs with flowdata)
			vec4 normalColor0 = texture2D( tNormalMap0, ( vUv * scale ) + flow * flowMapOffset0 );
			vec4 normalColor1 = texture2D( tNormalMap1, ( vUv * scale ) + flow * flowMapOffset1 );

			// linear interpolate to get the final normal color
			float flowLerp = abs( halfCycle - flowMapOffset0 ) / halfCycle;
			vec4 normalColor = mix( normalColor0, normalColor1, flowLerp );

			// calculate normal vector
			vec3 normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );

			// calculate the fresnel term to blend reflection and refraction maps
			float theta = max( dot( toEye, normal ), 0.0 );
			float reflectance = reflectivity + ( 1.0 - reflectivity ) * pow( ( 1.0 - theta ), 5.0 );

			// calculate final uv coords
			vec3 coord = vCoord.xyz / vCoord.w;
			vec2 uv = coord.xy + coord.z * normal.xz * 0.05;

			vec4 reflectColor = texture2D( tReflectionMap, vec2( 1.0 - uv.x, uv.y ) );
			vec4 refractColor = texture2D( tRefractionMap, uv );

			// multiply water color with the mix of both textures
			gl_FragColor = vec4( color, 1.0 ) * mix( refractColor, reflectColor, reflectance );

			#include <tonemapping_fragment>
			#include <${ev>=154?"colorspace_fragment":"encodings_fragment"}>
			#include <fog_fragment>

		}`}),(p=new f.RawShaderMaterial({uniforms:{roughnessMap:{value:null},normalMap:{value:null},texelSize:{value:new f.Vector2(1,1)}},vertexShader:`
			precision mediump float;
			precision mediump int;

			attribute vec3 position;
			attribute vec2 uv;

			varying vec2 vUv;

			void main() {

				vUv = uv;

				gl_Position = vec4( position, 1.0 );

			}
		`,fragmentShader:`
			precision mediump float;
			precision mediump int;

			varying vec2 vUv;

			uniform sampler2D roughnessMap;
			uniform sampler2D normalMap;
			uniform vec2 texelSize;

			#define ENVMAP_TYPE_CUBE_UV

			vec4 envMapTexelToLinear( vec4 a ) { return a; }

			#include <cube_uv_reflection_fragment>

			float roughnessToVariance( float roughness ) {

				float variance = 0.0;

				if ( roughness >= r1 ) {

					variance = ( r0 - roughness ) * ( v1 - v0 ) / ( r0 - r1 ) + v0;

				} else if ( roughness >= r4 ) {

					variance = ( r1 - roughness ) * ( v4 - v1 ) / ( r1 - r4 ) + v1;

				} else if ( roughness >= r5 ) {

					variance = ( r4 - roughness ) * ( v5 - v4 ) / ( r4 - r5 ) + v4;

				} else {

					float roughness2 = roughness * roughness;

					variance = 1.79 * roughness2 * roughness2;

				}

				return variance;

			}

			float varianceToRoughness( float variance ) {

				float roughness = 0.0;

				if ( variance >= v1 ) {

					roughness = ( v0 - variance ) * ( r1 - r0 ) / ( v0 - v1 ) + r0;

				} else if ( variance >= v4 ) {

					roughness = ( v1 - variance ) * ( r4 - r1 ) / ( v1 - v4 ) + r1;

				} else if ( variance >= v5 ) {

					roughness = ( v4 - variance ) * ( r5 - r4 ) / ( v4 - v5 ) + r4;

				} else {

					roughness = pow( 0.559 * variance, 0.25 ); // 0.559 = 1.0 / 1.79

				}

				return roughness;

			}

			void main() {

				gl_FragColor = texture2D( roughnessMap, vUv, - 1.0 );

				if ( texelSize.x == 0.0 ) return;

				float roughness = gl_FragColor.g;

				float variance = roughnessToVariance( roughness );

				vec3 avgNormal;

				for ( float x = - 1.0; x < 2.0; x += 2.0 ) {

					for ( float y = - 1.0; y < 2.0; y += 2.0 ) {

						vec2 uv = vUv + vec2( x, y ) * 0.25 * texelSize;

						avgNormal += normalize( texture2D( normalMap, uv, - 1.0 ).xyz - 0.5 );

					}

				}

				variance += 1.0 - 0.25 * length( avgNormal );

				gl_FragColor.g = varianceToRoughness( variance );

			}
		`,blending:f.NoBlending,depthTest:!1,depthWrite:!1})).type="RoughnessMipmapper";let eP={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform float opacity;\nuniform sampler2D tDiffuse;\nvarying vec2 vUv;\n#include <packing>\nvoid main() {\n	float depth = 1.0 - unpackRGBAToDepth( texture2D( tDiffuse, vUv ) );\n	gl_FragColor = vec4( vec3( depth ), opacity );\n}"};f.MeshPhongMaterial;let ek={c:null,u:[new f.Vector3,new f.Vector3,new f.Vector3],e:[]},e_={c:null,u:[new f.Vector3,new f.Vector3,new f.Vector3],e:[]},eL=[[],[],[]],eU=[[],[],[]],eD=[],eF=new f.Vector3,eB=new f.Vector3,eV=new f.Vector3,eG=new f.Vector3,ez=new f.Vector3,ej=new f.Vector3,eH=new f.Matrix3,eW=new f.Box3,eK=new f.Matrix4,eX=new f.Matrix4,eY=new f.Ray;class eq{constructor(e=new f.Vector3,t=new f.Vector3,r=new f.Matrix3){this.center=e,this.halfSize=t,this.rotation=r}set(e,t,r){return this.center=e,this.halfSize=t,this.rotation=r,this}copy(e){return this.center.copy(e.center),this.halfSize.copy(e.halfSize),this.rotation.copy(e.rotation),this}clone(){return new this.constructor().copy(this)}getSize(e){return e.copy(this.halfSize).multiplyScalar(2)}clampPoint(e,t){let r=this.halfSize;eG.subVectors(e,this.center),this.rotation.extractBasis(eF,eB,eV),t.copy(this.center);let i=f.MathUtils.clamp(eG.dot(eF),-r.x,r.x);t.add(eF.multiplyScalar(i));let n=f.MathUtils.clamp(eG.dot(eB),-r.y,r.y);t.add(eB.multiplyScalar(n));let a=f.MathUtils.clamp(eG.dot(eV),-r.z,r.z);return t.add(eV.multiplyScalar(a)),t}containsPoint(e){return eG.subVectors(e,this.center),this.rotation.extractBasis(eF,eB,eV),Math.abs(eG.dot(eF))<=this.halfSize.x&&Math.abs(eG.dot(eB))<=this.halfSize.y&&Math.abs(eG.dot(eV))<=this.halfSize.z}intersectsBox3(e){return this.intersectsOBB(eZ.fromBox3(e))}intersectsSphere(e){return this.clampPoint(e.center,ej),ej.distanceToSquared(e.center)<=e.radius*e.radius}intersectsOBB(e,t=Number.EPSILON){let r,i;ek.c=this.center,ek.e[0]=this.halfSize.x,ek.e[1]=this.halfSize.y,ek.e[2]=this.halfSize.z,this.rotation.extractBasis(ek.u[0],ek.u[1],ek.u[2]),e_.c=e.center,e_.e[0]=e.halfSize.x,e_.e[1]=e.halfSize.y,e_.e[2]=e.halfSize.z,e.rotation.extractBasis(e_.u[0],e_.u[1],e_.u[2]);for(let e=0;e<3;e++)for(let t=0;t<3;t++)eL[e][t]=ek.u[e].dot(e_.u[t]);eG.subVectors(e_.c,ek.c),eD[0]=eG.dot(ek.u[0]),eD[1]=eG.dot(ek.u[1]),eD[2]=eG.dot(ek.u[2]);for(let e=0;e<3;e++)for(let r=0;r<3;r++)eU[e][r]=Math.abs(eL[e][r])+t;for(let e=0;e<3;e++)if(r=ek.e[e],i=e_.e[0]*eU[e][0]+e_.e[1]*eU[e][1]+e_.e[2]*eU[e][2],Math.abs(eD[e])>r+i)return!1;for(let e=0;e<3;e++)if(r=ek.e[0]*eU[0][e]+ek.e[1]*eU[1][e]+ek.e[2]*eU[2][e],i=e_.e[e],Math.abs(eD[0]*eL[0][e]+eD[1]*eL[1][e]+eD[2]*eL[2][e])>r+i)return!1;return r=ek.e[1]*eU[2][0]+ek.e[2]*eU[1][0],i=e_.e[1]*eU[0][2]+e_.e[2]*eU[0][1],!(Math.abs(eD[2]*eL[1][0]-eD[1]*eL[2][0])>r+i)&&(r=ek.e[1]*eU[2][1]+ek.e[2]*eU[1][1],i=e_.e[0]*eU[0][2]+e_.e[2]*eU[0][0],!(Math.abs(eD[2]*eL[1][1]-eD[1]*eL[2][1])>r+i)&&(r=ek.e[1]*eU[2][2]+ek.e[2]*eU[1][2],i=e_.e[0]*eU[0][1]+e_.e[1]*eU[0][0],!(Math.abs(eD[2]*eL[1][2]-eD[1]*eL[2][2])>r+i)&&(r=ek.e[0]*eU[2][0]+ek.e[2]*eU[0][0],i=e_.e[1]*eU[1][2]+e_.e[2]*eU[1][1],!(Math.abs(eD[0]*eL[2][0]-eD[2]*eL[0][0])>r+i)&&(r=ek.e[0]*eU[2][1]+ek.e[2]*eU[0][1],i=e_.e[0]*eU[1][2]+e_.e[2]*eU[1][0],!(Math.abs(eD[0]*eL[2][1]-eD[2]*eL[0][1])>r+i)&&(r=ek.e[0]*eU[2][2]+ek.e[2]*eU[0][2],i=e_.e[0]*eU[1][1]+e_.e[1]*eU[1][0],!(Math.abs(eD[0]*eL[2][2]-eD[2]*eL[0][2])>r+i)&&(r=ek.e[0]*eU[1][0]+ek.e[1]*eU[0][0],i=e_.e[1]*eU[2][2]+e_.e[2]*eU[2][1],!(Math.abs(eD[1]*eL[0][0]-eD[0]*eL[1][0])>r+i)&&(r=ek.e[0]*eU[1][1]+ek.e[1]*eU[0][1],i=e_.e[0]*eU[2][2]+e_.e[2]*eU[2][0],!(Math.abs(eD[1]*eL[0][1]-eD[0]*eL[1][1])>r+i)&&(r=ek.e[0]*eU[1][2]+ek.e[1]*eU[0][2],i=e_.e[0]*eU[2][1]+e_.e[1]*eU[2][0],!(Math.abs(eD[1]*eL[0][2]-eD[0]*eL[1][2])>r+i)))))))))}intersectsPlane(e){this.rotation.extractBasis(eF,eB,eV);let t=this.halfSize.x*Math.abs(e.normal.dot(eF))+this.halfSize.y*Math.abs(e.normal.dot(eB))+this.halfSize.z*Math.abs(e.normal.dot(eV));return Math.abs(e.normal.dot(this.center)-e.constant)<=t}intersectRay(e,t){return(this.getSize(ez),eW.setFromCenterAndSize(eG.set(0,0,0),ez),eK.setFromMatrix3(this.rotation),eK.setPosition(this.center),eX.copy(eK).invert(),eY.copy(e).applyMatrix4(eX),eY.intersectBox(eW,t))?t.applyMatrix4(eK):null}intersectsRay(e){return null!==this.intersectRay(e,eG)}fromBox3(e){return e.getCenter(this.center),e.getSize(this.halfSize).multiplyScalar(.5),this.rotation.identity(),this}equals(e){return e.center.equals(this.center)&&e.halfSize.equals(this.halfSize)&&e.rotation.equals(this.rotation)}applyMatrix4(e){let t=e.elements,r=eG.set(t[0],t[1],t[2]).length(),i=eG.set(t[4],t[5],t[6]).length(),n=eG.set(t[8],t[9],t[10]).length();0>e.determinant()&&(r=-r),eH.setFromMatrix4(e);let a=1/r,s=1/i,o=1/n;return eH.elements[0]*=a,eH.elements[1]*=a,eH.elements[2]*=a,eH.elements[3]*=s,eH.elements[4]*=s,eH.elements[5]*=s,eH.elements[6]*=o,eH.elements[7]*=o,eH.elements[8]*=o,this.rotation.multiply(eH),this.halfSize.x*=r,this.halfSize.y*=i,this.halfSize.z*=n,eG.setFromMatrixPosition(e),this.center.add(eG),this}}let eZ=new eq,e$=new f.Vector3,eQ=new f.Vector3,eJ=new f.Vector3;class e0{constructor(e=new f.Vector3(0,0,0),t=new f.Vector3(0,1,0),r=1){this.start=e,this.end=t,this.radius=r}clone(){return new e0(this.start.clone(),this.end.clone(),this.radius)}set(e,t,r){this.start.copy(e),this.end.copy(t),this.radius=r}copy(e){this.start.copy(e.start),this.end.copy(e.end),this.radius=e.radius}getCenter(e){return e.copy(this.end).add(this.start).multiplyScalar(.5)}translate(e){this.start.add(e),this.end.add(e)}checkAABBAxis(e,t,r,i,n,a,s,o,l){return(n-e<l||n-r<l)&&(e-a<l||r-a<l)&&(s-t<l||s-i<l)&&(t-o<l||i-o<l)}intersectsBox(e){return this.checkAABBAxis(this.start.x,this.start.y,this.end.x,this.end.y,e.min.x,e.max.x,e.min.y,e.max.y,this.radius)&&this.checkAABBAxis(this.start.x,this.start.z,this.end.x,this.end.z,e.min.x,e.max.x,e.min.z,e.max.z,this.radius)&&this.checkAABBAxis(this.start.y,this.start.z,this.end.y,this.end.z,e.min.y,e.max.y,e.min.z,e.max.z,this.radius)}lineLineMinimumPoints(e,t){let r,i;let n=e$.copy(e.end).sub(e.start),a=eQ.copy(t.end).sub(t.start),s=eJ.copy(t.start).sub(e.start),o=n.dot(a),l=n.dot(n),c=a.dot(a),u=a.dot(s),h=n.dot(s),p=l*c-o*o;if(1e-10>Math.abs(p)){let e=-u/c,t=(o-u)/c;Math.abs(e-.5)<Math.abs(t-.5)?(r=0,i=e):(r=1,i=t)}else i=((r=(u*o+h*c)/p)*o-u)/c;return i=Math.max(0,Math.min(1,i)),r=Math.max(0,Math.min(1,r)),[n.multiplyScalar(r).add(e.start),a.multiplyScalar(i).add(t.start)]}}let e1=new f.Vector3,e2=new f.Vector3,e3=new f.Plane,e4=new f.Line3,e5=new f.Line3,e6=new f.Sphere,e8=new e0;class e9{constructor(e){this.triangles=[],this.box=e,this.subTrees=[]}addTriangle(e){return this.bounds||(this.bounds=new Box3),this.bounds.min.x=Math.min(this.bounds.min.x,e.a.x,e.b.x,e.c.x),this.bounds.min.y=Math.min(this.bounds.min.y,e.a.y,e.b.y,e.c.y),this.bounds.min.z=Math.min(this.bounds.min.z,e.a.z,e.b.z,e.c.z),this.bounds.max.x=Math.max(this.bounds.max.x,e.a.x,e.b.x,e.c.x),this.bounds.max.y=Math.max(this.bounds.max.y,e.a.y,e.b.y,e.c.y),this.bounds.max.z=Math.max(this.bounds.max.z,e.a.z,e.b.z,e.c.z),this.triangles.push(e),this}calcBox(){return this.box=this.bounds.clone(),this.box.min.x-=.01,this.box.min.y-=.01,this.box.min.z-=.01,this}split(e){let t;if(!this.box)return;let r=[],i=e2.copy(this.box.max).sub(this.box.min).multiplyScalar(.5);for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let n=0;n<2;n++){let a=new Box3,s=e1.set(e,t,n);a.min.copy(this.box.min).add(s.multiply(i)),a.max.copy(a.min).add(i),r.push(new e9(a))}for(;t=this.triangles.pop();)for(let e=0;e<r.length;e++)r[e].box.intersectsTriangle(t)&&r[e].triangles.push(t);for(let t=0;t<r.length;t++){let i=r[t].triangles.length;i>8&&e<16&&r[t].split(e+1),0!==i&&this.subTrees.push(r[t])}return this}build(){return this.calcBox(),this.split(0),this}getRayTriangles(e,t){for(let r=0;r<this.subTrees.length;r++){let i=this.subTrees[r];if(e.intersectsBox(i.box)){if(i.triangles.length>0)for(let e=0;e<i.triangles.length;e++)-1===t.indexOf(i.triangles[e])&&t.push(i.triangles[e]);else i.getRayTriangles(e,t)}}return t}triangleCapsuleIntersect(e,t){t.getPlane(e3);let r=e3.distanceToPoint(e.start)-e.radius,i=e3.distanceToPoint(e.end)-e.radius;if(r>0&&i>0||r<-e.radius&&i<-e.radius)return!1;let n=e1.copy(e.start).lerp(e.end,Math.abs(r/(Math.abs(r)+Math.abs(i))));if(t.containsPoint(n))return{normal:e3.normal.clone(),point:n.clone(),depth:Math.abs(Math.min(r,i))};let a=e.radius*e.radius,s=e4.set(e.start,e.end),o=[[t.a,t.b],[t.b,t.c],[t.c,t.a]];for(let t=0;t<o.length;t++){let r=e5.set(o[t][0],o[t][1]),[i,n]=e.lineLineMinimumPoints(s,r);if(i.distanceToSquared(n)<a)return{normal:i.clone().sub(n).normalize(),point:n.clone(),depth:e.radius-i.distanceTo(n)}}return!1}triangleSphereIntersect(e,t){if(t.getPlane(e3),!e.intersectsPlane(e3))return!1;let r=Math.abs(e3.distanceToSphere(e)),i=e.radius*e.radius-r*r,n=e3.projectPoint(e.center,e1);if(t.containsPoint(e.center))return{normal:e3.normal.clone(),point:n.clone(),depth:Math.abs(e3.distanceToSphere(e))};let a=[[t.a,t.b],[t.b,t.c],[t.c,t.a]];for(let t=0;t<a.length;t++){e4.set(a[t][0],a[t][1]),e4.closestPointToPoint(n,!0,e2);let r=e2.distanceToSquared(e.center);if(r<i)return{normal:e.center.clone().sub(e2).normalize(),point:e2.clone(),depth:e.radius-Math.sqrt(r)}}return!1}getSphereTriangles(e,t){for(let r=0;r<this.subTrees.length;r++){let i=this.subTrees[r];if(e.intersectsBox(i.box)){if(i.triangles.length>0)for(let e=0;e<i.triangles.length;e++)-1===t.indexOf(i.triangles[e])&&t.push(i.triangles[e]);else i.getSphereTriangles(e,t)}}}getCapsuleTriangles(e,t){for(let r=0;r<this.subTrees.length;r++){let i=this.subTrees[r];if(e.intersectsBox(i.box)){if(i.triangles.length>0)for(let e=0;e<i.triangles.length;e++)-1===t.indexOf(i.triangles[e])&&t.push(i.triangles[e]);else i.getCapsuleTriangles(e,t)}}}sphereIntersect(e){e6.copy(e);let t=[],r,i=!1;this.getSphereTriangles(e,t);for(let e=0;e<t.length;e++)(r=this.triangleSphereIntersect(e6,t[e]))&&(i=!0,e6.center.add(r.normal.multiplyScalar(r.depth)));if(i){let t=e6.center.clone().sub(e.center),r=t.length();return{normal:t.normalize(),depth:r}}return!1}capsuleIntersect(e){e8.copy(e);let t=[],r,i=!1;this.getCapsuleTriangles(e8,t);for(let e=0;e<t.length;e++)(r=this.triangleCapsuleIntersect(e8,t[e]))&&(i=!0,e8.translate(r.normal.multiplyScalar(r.depth)));if(i){let t=e8.getCenter(new Vector3).sub(e.getCenter(e1)),r=t.length();return{normal:t.normalize(),depth:r}}return!1}rayIntersect(e){if(0===e.direction.length())return;let t=[],r,i,n=1e100;this.getRayTriangles(e,t);for(let a=0;a<t.length;a++){let s=e.intersectTriangle(t[a].a,t[a].b,t[a].c,!0,e1);if(s){let o=s.sub(e.origin).length();n>o&&(i=s.clone().add(e.origin),n=o,r=t[a])}}return n<1e100&&{distance:n,triangle:r,position:i}}fromGraphNode(e){return e.updateWorldMatrix(!0,!0),e.traverse(e=>{if(!0===e.isMesh){let t,r=!1;null!==e.geometry.index?(r=!0,t=e.geometry.toNonIndexed()):t=e.geometry;let i=t.getAttribute("position");for(let t=0;t<i.count;t+=3){let r=new Vector3().fromBufferAttribute(i,t),n=new Vector3().fromBufferAttribute(i,t+1),a=new Vector3().fromBufferAttribute(i,t+2);r.applyMatrix4(e.matrixWorld),n.applyMatrix4(e.matrixWorld),a.applyMatrix4(e.matrixWorld),this.addTriangle(new Triangle$1(r,n,a))}r&&t.dispose()}}),this.build(),this}}var e7=((d=e7||{})[d.NONE=-1]="NONE",d[d.ROTATE=0]="ROTATE",d[d.DOLLY=1]="DOLLY",d[d.PAN=2]="PAN",d[d.TOUCH_ROTATE=3]="TOUCH_ROTATE",d[d.TOUCH_PAN=4]="TOUCH_PAN",d[d.TOUCH_DOLLY_PAN=5]="TOUCH_DOLLY_PAN",d[d.TOUCH_DOLLY_ROTATE=6]="TOUCH_DOLLY_ROTATE",d);let te=new f.Ray,tt=new f.Plane,tr=Math.cos(Math.PI/180*70),ti=(e,t)=>(e%t+t)%t;class tn extends f.EventDispatcher{constructor(e,t){super(),x(this,"object"),x(this,"domElement"),x(this,"enabled",!0),x(this,"target",new f.Vector3),x(this,"minDistance",0),x(this,"maxDistance",1/0),x(this,"minZoom",0),x(this,"maxZoom",1/0),x(this,"minPolarAngle",0),x(this,"maxPolarAngle",Math.PI),x(this,"minAzimuthAngle",-1/0),x(this,"maxAzimuthAngle",1/0),x(this,"enableDamping",!1),x(this,"dampingFactor",.05),x(this,"enableZoom",!0),x(this,"zoomSpeed",1),x(this,"enableRotate",!0),x(this,"rotateSpeed",1),x(this,"enablePan",!0),x(this,"panSpeed",1),x(this,"screenSpacePanning",!0),x(this,"keyPanSpeed",7),x(this,"zoomToCursor",!1),x(this,"autoRotate",!1),x(this,"autoRotateSpeed",2),x(this,"reverseOrbit",!1),x(this,"reverseHorizontalOrbit",!1),x(this,"reverseVerticalOrbit",!1),x(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),x(this,"mouseButtons",{LEFT:f.MOUSE.ROTATE,MIDDLE:f.MOUSE.DOLLY,RIGHT:f.MOUSE.PAN}),x(this,"touches",{ONE:f.TOUCH.ROTATE,TWO:f.TOUCH.DOLLY_PAN}),x(this,"target0"),x(this,"position0"),x(this,"zoom0"),x(this,"_domElementKeyEvents",null),x(this,"getPolarAngle"),x(this,"getAzimuthalAngle"),x(this,"setPolarAngle"),x(this,"setAzimuthalAngle"),x(this,"getDistance"),x(this,"listenToKeyEvents"),x(this,"stopListenToKeyEvents"),x(this,"saveState"),x(this,"reset"),x(this,"update"),x(this,"connect"),x(this,"dispose"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>c.phi,this.getAzimuthalAngle=()=>c.theta,this.setPolarAngle=e=>{let t=ti(e,2*Math.PI),i=c.phi;i<0&&(i+=2*Math.PI),t<0&&(t+=2*Math.PI);let n=Math.abs(t-i);2*Math.PI-n<n&&(t<i?t+=2*Math.PI:i+=2*Math.PI),u.phi=t-i,r.update()},this.setAzimuthalAngle=e=>{let t=ti(e,2*Math.PI),i=c.theta;i<0&&(i+=2*Math.PI),t<0&&(t+=2*Math.PI);let n=Math.abs(t-i);2*Math.PI-n<n&&(t<i?t+=2*Math.PI:i+=2*Math.PI),u.theta=t-i,r.update()},this.getDistance=()=>r.object.position.distanceTo(r.target),this.listenToKeyEvents=e=>{e.addEventListener("keydown",Q),this._domElementKeyEvents=e},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",Q),this._domElementKeyEvents=null},this.saveState=()=>{r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=()=>{r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(i),r.update(),o=s.NONE},this.update=(()=>{let t=new f.Vector3,n=new f.Vector3(0,1,0),a=new f.Quaternion().setFromUnitVectors(e.up,n),d=a.clone().invert(),m=new f.Vector3,g=new f.Quaternion,v=2*Math.PI;return function(){let y=r.object.position;a.setFromUnitVectors(e.up,n),d.copy(a).invert(),t.copy(y).sub(r.target),t.applyQuaternion(a),c.setFromVector3(t),r.autoRotate&&o===s.NONE&&N(2*Math.PI/60/60*r.autoRotateSpeed),r.enableDamping?(c.theta+=u.theta*r.dampingFactor,c.phi+=u.phi*r.dampingFactor):(c.theta+=u.theta,c.phi+=u.phi);let x=r.minAzimuthAngle,T=r.maxAzimuthAngle;isFinite(x)&&isFinite(T)&&(x<-Math.PI?x+=v:x>Math.PI&&(x-=v),T<-Math.PI?T+=v:T>Math.PI&&(T-=v),x<=T?c.theta=Math.max(x,Math.min(T,c.theta)):c.theta=c.theta>(x+T)/2?Math.max(x,c.theta):Math.min(T,c.theta)),c.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,c.phi)),c.makeSafe(),!0===r.enableDamping?r.target.addScaledVector(p,r.dampingFactor):r.target.add(p),r.zoomToCursor&&w||r.object.isOrthographicCamera?c.radius=F(c.radius):c.radius=F(c.radius*h),t.setFromSpherical(c),t.applyQuaternion(d),y.copy(r.target).add(t),r.object.lookAt(r.target),!0===r.enableDamping?(u.theta*=1-r.dampingFactor,u.phi*=1-r.dampingFactor,p.multiplyScalar(1-r.dampingFactor)):(u.set(0,0,0),p.set(0,0,0));let b=!1;if(r.zoomToCursor&&w){let i=null;if(r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera){let e=t.length();i=F(e*h);let n=e-i;r.object.position.addScaledVector(R,n),r.object.updateMatrixWorld()}else if(r.object.isOrthographicCamera){let e=new f.Vector3(A.x,A.y,0);e.unproject(r.object),r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/h)),r.object.updateProjectionMatrix(),b=!0;let n=new f.Vector3(A.x,A.y,0);n.unproject(r.object),r.object.position.sub(n).add(e),r.object.updateMatrixWorld(),i=t.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),r.zoomToCursor=!1;null!==i&&(r.screenSpacePanning?r.target.set(0,0,-1).transformDirection(r.object.matrix).multiplyScalar(i).add(r.object.position):(te.origin.copy(r.object.position),te.direction.set(0,0,-1).transformDirection(r.object.matrix),Math.abs(r.object.up.dot(te.direction))<tr?e.lookAt(r.target):(tt.setFromNormalAndCoplanarPoint(r.object.up,r.target),te.intersectPlane(tt,r.target))))}else r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera&&(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/h)),r.object.updateProjectionMatrix(),b=!0);return h=1,w=!1,!!(b||m.distanceToSquared(r.object.position)>l||8*(1-g.dot(r.object.quaternion))>l)&&(r.dispatchEvent(i),m.copy(r.object.position),g.copy(r.object.quaternion),b=!1,!0)}})(),this.connect=e=>{e===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),r.domElement=e,r.domElement.style.touchAction="none",r.domElement.addEventListener("contextmenu",J),r.domElement.addEventListener("pointerdown",X),r.domElement.addEventListener("pointercancel",Z),r.domElement.addEventListener("wheel",$)},this.dispose=()=>{var e,t,i,n,a,s;null==(e=r.domElement)||e.removeEventListener("contextmenu",J),null==(t=r.domElement)||t.removeEventListener("pointerdown",X),null==(i=r.domElement)||i.removeEventListener("pointercancel",Z),null==(n=r.domElement)||n.removeEventListener("wheel",$),null==(a=r.domElement)||a.removeEventListener("pointermove",Y),null==(s=r.domElement)||s.removeEventListener("pointerup",q),null!==r._domElementKeyEvents&&r._domElementKeyEvents.removeEventListener("keydown",Q)};let r=this,i={type:"change"},n={type:"start"},a={type:"end"},s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},o=s.NONE,l=1e-6,c=new f.Spherical,u=new f.Spherical,h=1,p=new f.Vector3,d=new f.Vector2,m=new f.Vector2,g=new f.Vector2,v=new f.Vector2,y=new f.Vector2,T=new f.Vector2,b=new f.Vector2,S=new f.Vector2,E=new f.Vector2,R=new f.Vector3,A=new f.Vector2,w=!1,M=[],C={};function I(){return Math.pow(.95,r.zoomSpeed)}function N(e){r.reverseOrbit||r.reverseHorizontalOrbit?u.theta+=e:u.theta-=e}function O(e){r.reverseOrbit||r.reverseVerticalOrbit?u.phi+=e:u.phi-=e}let P=(()=>{let e=new f.Vector3;return function(t,r){e.setFromMatrixColumn(r,0),e.multiplyScalar(-t),p.add(e)}})(),k=(()=>{let e=new f.Vector3;return function(t,i){!0===r.screenSpacePanning?e.setFromMatrixColumn(i,1):(e.setFromMatrixColumn(i,0),e.crossVectors(r.object.up,e)),e.multiplyScalar(t),p.add(e)}})(),_=(()=>{let e=new f.Vector3;return function(t,i){let n=r.domElement;if(n&&r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera){let a=r.object.position;e.copy(a).sub(r.target);let s=e.length();P(2*t*(s*=Math.tan(r.object.fov/2*Math.PI/180))/n.clientHeight,r.object.matrix),k(2*i*s/n.clientHeight,r.object.matrix)}else n&&r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera?(P(t*(r.object.right-r.object.left)/r.object.zoom/n.clientWidth,r.object.matrix),k(i*(r.object.top-r.object.bottom)/r.object.zoom/n.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}})();function L(e){r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera||r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera?h/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function U(e){r.object instanceof f.PerspectiveCamera&&r.object.isPerspectiveCamera||r.object instanceof f.OrthographicCamera&&r.object.isOrthographicCamera?h*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function D(e){if(!r.zoomToCursor||!r.domElement)return;w=!0;let t=r.domElement.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top,a=t.width,s=t.height;A.x=i/a*2-1,A.y=-(n/s*2)+1,R.set(A.x,A.y,1).unproject(r.object).sub(r.object.position).normalize()}function F(e){return Math.max(r.minDistance,Math.min(r.maxDistance,e))}function B(e){d.set(e.clientX,e.clientY)}function V(e){v.set(e.clientX,e.clientY)}function G(){if(1==M.length)d.set(M[0].pageX,M[0].pageY);else{let e=.5*(M[0].pageX+M[1].pageX),t=.5*(M[0].pageY+M[1].pageY);d.set(e,t)}}function z(){if(1==M.length)v.set(M[0].pageX,M[0].pageY);else{let e=.5*(M[0].pageX+M[1].pageX),t=.5*(M[0].pageY+M[1].pageY);v.set(e,t)}}function j(){let e=M[0].pageX-M[1].pageX,t=M[0].pageY-M[1].pageY;b.set(0,Math.sqrt(e*e+t*t))}function H(e){if(1==M.length)m.set(e.pageX,e.pageY);else{let t=er(e),r=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);m.set(r,i)}g.subVectors(m,d).multiplyScalar(r.rotateSpeed);let t=r.domElement;t&&(N(2*Math.PI*g.x/t.clientHeight),O(2*Math.PI*g.y/t.clientHeight)),d.copy(m)}function W(e){if(1==M.length)y.set(e.pageX,e.pageY);else{let t=er(e),r=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);y.set(r,i)}T.subVectors(y,v).multiplyScalar(r.panSpeed),_(T.x,T.y),v.copy(y)}function K(e){let t=er(e),i=e.pageX-t.x,n=e.pageY-t.y;S.set(0,Math.sqrt(i*i+n*n)),E.set(0,Math.pow(S.y/b.y,r.zoomSpeed)),L(E.y),b.copy(S)}function X(e){var t,i,a;!1!==r.enabled&&(0===M.length&&(null==(t=r.domElement)||t.setPointerCapture(e.pointerId),null==(i=r.domElement)||i.addEventListener("pointermove",Y),null==(a=r.domElement)||a.addEventListener("pointerup",q)),M.push(e),"touch"===e.pointerType?function(e){switch(et(e),M.length){case 1:switch(r.touches.ONE){case f.TOUCH.ROTATE:if(!1===r.enableRotate)return;G(),o=s.TOUCH_ROTATE;break;case f.TOUCH.PAN:if(!1===r.enablePan)return;z(),o=s.TOUCH_PAN;break;default:o=s.NONE}break;case 2:switch(r.touches.TWO){case f.TOUCH.DOLLY_PAN:if(!1===r.enableZoom&&!1===r.enablePan)return;r.enableZoom&&j(),r.enablePan&&z(),o=s.TOUCH_DOLLY_PAN;break;case f.TOUCH.DOLLY_ROTATE:if(!1===r.enableZoom&&!1===r.enableRotate)return;r.enableZoom&&j(),r.enableRotate&&G(),o=s.TOUCH_DOLLY_ROTATE;break;default:o=s.NONE}break;default:o=s.NONE}o!==s.NONE&&r.dispatchEvent(n)}(e):function(e){let t;switch(e.button){case 0:t=r.mouseButtons.LEFT;break;case 1:t=r.mouseButtons.MIDDLE;break;case 2:t=r.mouseButtons.RIGHT;break;default:t=-1}switch(t){case f.MOUSE.DOLLY:if(!1===r.enableZoom)return;D(e),b.set(e.clientX,e.clientY),o=s.DOLLY;break;case f.MOUSE.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===r.enablePan)return;V(e),o=s.PAN}else{if(!1===r.enableRotate)return;B(e),o=s.ROTATE}break;case f.MOUSE.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===r.enableRotate)return;B(e),o=s.ROTATE}else{if(!1===r.enablePan)return;V(e),o=s.PAN}break;default:o=s.NONE}o!==s.NONE&&r.dispatchEvent(n)}(e))}function Y(e){!1!==r.enabled&&("touch"===e.pointerType?function(e){switch(et(e),o){case s.TOUCH_ROTATE:if(!1===r.enableRotate)return;H(e),r.update();break;case s.TOUCH_PAN:if(!1===r.enablePan)return;W(e),r.update();break;case s.TOUCH_DOLLY_PAN:if(!1===r.enableZoom&&!1===r.enablePan)return;r.enableZoom&&K(e),r.enablePan&&W(e),r.update();break;case s.TOUCH_DOLLY_ROTATE:if(!1===r.enableZoom&&!1===r.enableRotate)return;r.enableZoom&&K(e),r.enableRotate&&H(e),r.update();break;default:o=s.NONE}}(e):function(e){if(!1!==r.enabled)switch(o){case s.ROTATE:if(!1===r.enableRotate)return;!function(e){m.set(e.clientX,e.clientY),g.subVectors(m,d).multiplyScalar(r.rotateSpeed);let t=r.domElement;t&&(N(2*Math.PI*g.x/t.clientHeight),O(2*Math.PI*g.y/t.clientHeight)),d.copy(m),r.update()}(e);break;case s.DOLLY:if(!1===r.enableZoom)return;S.set(e.clientX,e.clientY),E.subVectors(S,b),E.y>0?L(I()):E.y<0&&U(I()),b.copy(S),r.update();break;case s.PAN:if(!1===r.enablePan)return;y.set(e.clientX,e.clientY),T.subVectors(y,v).multiplyScalar(r.panSpeed),_(T.x,T.y),v.copy(y),r.update()}}(e))}function q(e){var t,i,n;ee(e),0===M.length&&(null==(t=r.domElement)||t.releasePointerCapture(e.pointerId),null==(i=r.domElement)||i.removeEventListener("pointermove",Y),null==(n=r.domElement)||n.removeEventListener("pointerup",q)),r.dispatchEvent(a),o=s.NONE}function Z(e){ee(e)}function $(e){!1!==r.enabled&&!1!==r.enableZoom&&(o===s.NONE||o===s.ROTATE)&&(e.preventDefault(),r.dispatchEvent(n),D(e),e.deltaY<0?U(I()):e.deltaY>0&&L(I()),r.update(),r.dispatchEvent(a))}function Q(e){!1!==r.enabled&&!1!==r.enablePan&&function(e){let t=!1;switch(e.code){case r.keys.UP:_(0,r.keyPanSpeed),t=!0;break;case r.keys.BOTTOM:_(0,-r.keyPanSpeed),t=!0;break;case r.keys.LEFT:_(r.keyPanSpeed,0),t=!0;break;case r.keys.RIGHT:_(-r.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),r.update())}(e)}function J(e){!1!==r.enabled&&e.preventDefault()}function ee(e){delete C[e.pointerId];for(let t=0;t<M.length;t++)if(M[t].pointerId==e.pointerId){M.splice(t,1);return}}function et(e){let t=C[e.pointerId];void 0===t&&(t=new f.Vector2,C[e.pointerId]=t),t.set(e.pageX,e.pageY)}function er(e){return C[(e.pointerId===M[0].pointerId?M[1]:M[0]).pointerId]}void 0!==t&&this.connect(t),this.update()}}class ta{constructor(){x(this,"enabled",!0),x(this,"needsSwap",!0),x(this,"clear",!1),x(this,"renderToScreen",!1)}setSize(e,t){}render(e,t,r,i,n){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}class ts{constructor(e){x(this,"camera",new f.OrthographicCamera(-1,1,1,-1,0,1)),x(this,"geometry",new f.PlaneGeometry(2,2)),x(this,"mesh"),this.mesh=new f.Mesh(this.geometry,e)}get material(){return this.mesh.material}set material(e){this.mesh.material=e}dispose(){this.mesh.geometry.dispose()}render(e){e.render(this.mesh,this.camera)}}let to={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform float opacity;\nuniform sampler2D tDiffuse;\nvarying vec2 vUv;\nvoid main() {\n	vec4 texel = texture2D( tDiffuse, vUv );\n	gl_FragColor = opacity * texel;\n}"},tl={defines:{PERSPECTIVE_CAMERA:1,KERNEL_SIZE:32},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},kernel:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new f.Vector2},cameraProjectionMatrix:{value:new f.Matrix4},cameraInverseProjectionMatrix:{value:new f.Matrix4},kernelRadius:{value:8},minDistance:{value:.005},maxDistance:{value:.05}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D tDiffuse;\nuniform sampler2D tNormal;\nuniform sampler2D tDepth;\nuniform sampler2D tNoise;\nuniform vec3 kernel[ KERNEL_SIZE ];\nuniform vec2 resolution;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform mat4 cameraProjectionMatrix;\nuniform mat4 cameraInverseProjectionMatrix;\nuniform float kernelRadius;\nuniform float minDistance;\nuniform float maxDistance;\nvarying vec2 vUv;\n#include <packing>\nfloat getDepth( const in vec2 screenPosition ) {\n	return texture2D( tDepth, screenPosition ).x;\n}\nfloat getLinearDepth( const in vec2 screenPosition ) {\n	#if PERSPECTIVE_CAMERA == 1\n		float fragCoordZ = texture2D( tDepth, screenPosition ).x;\n		float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n		return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n	#else\n		return texture2D( tDepth, screenPosition ).x;\n	#endif\n}\nfloat getViewZ( const in float depth ) {\n	#if PERSPECTIVE_CAMERA == 1\n		return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n	#else\n		return orthographicDepthToViewZ( depth, cameraNear, cameraFar );\n	#endif\n}\nvec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {\n	float clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];\n	vec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );\n	clipPosition *= clipW; // unprojection.\n	return ( cameraInverseProjectionMatrix * clipPosition ).xyz;\n}\nvec3 getViewNormal( const in vec2 screenPosition ) {\n	return unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );\n}\nvoid main() {\n	float depth = getDepth( vUv );\n	float viewZ = getViewZ( depth );\n	vec3 viewPosition = getViewPosition( vUv, depth, viewZ );\n	vec3 viewNormal = getViewNormal( vUv );\n vec2 noiseScale = vec2( resolution.x / 4.0, resolution.y / 4.0 );\n	vec3 random = texture2D( tNoise, vUv * noiseScale ).xyz;\n	vec3 tangent = normalize( random - viewNormal * dot( random, viewNormal ) );\n	vec3 bitangent = cross( viewNormal, tangent );\n	mat3 kernelMatrix = mat3( tangent, bitangent, viewNormal );\n float occlusion = 0.0;\n for ( int i = 0; i < KERNEL_SIZE; i ++ ) {\n		vec3 sampleVector = kernelMatrix * kernel[ i ];\n		vec3 samplePoint = viewPosition + ( sampleVector * kernelRadius );\n		vec4 samplePointNDC = cameraProjectionMatrix * vec4( samplePoint, 1.0 );\n		samplePointNDC /= samplePointNDC.w;\n		vec2 samplePointUv = samplePointNDC.xy * 0.5 + 0.5;\n		float realDepth = getLinearDepth( samplePointUv );\n		float sampleDepth = viewZToOrthographicDepth( samplePoint.z, cameraNear, cameraFar );\n		float delta = sampleDepth - realDepth;\n		if ( delta > minDistance && delta < maxDistance ) {\n			occlusion += 1.0;\n		}\n	}\n	occlusion = clamp( occlusion / float( KERNEL_SIZE ), 0.0, 1.0 );\n	gl_FragColor = vec4( vec3( 1.0 - occlusion ), 1.0 );\n}"},tc={defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D tDepth;\nuniform float cameraNear;\nuniform float cameraFar;\nvarying vec2 vUv;\n#include <packing>\nfloat getLinearDepth( const in vec2 screenPosition ) {\n	#if PERSPECTIVE_CAMERA == 1\n		float fragCoordZ = texture2D( tDepth, screenPosition ).x;\n		float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n		return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n	#else\n		return texture2D( tDepth, screenPosition ).x;\n	#endif\n}\nvoid main() {\n	float depth = getLinearDepth( vUv );\n	gl_FragColor = vec4( vec3( 1.0 - depth ), 1.0 );\n}"},tu={uniforms:{tDiffuse:{value:null},resolution:{value:new f.Vector2}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D tDiffuse;\nuniform vec2 resolution;\nvarying vec2 vUv;\nvoid main() {\n	vec2 texelSize = ( 1.0 / resolution );\n	float result = 0.0;\n	for ( int i = - 2; i <= 2; i ++ ) {\n		for ( int j = - 2; j <= 2; j ++ ) {\n			vec2 offset = ( vec2( float( i ), float( j ) ) ) * texelSize;\n			result += texture2D( tDiffuse, vUv + offset ).r;\n		}\n	}\n	gl_FragColor = vec4( vec3( result / ( 5.0 * 5.0 ) ), 1.0 );\n}"},th=class extends ta{constructor(e,t,r,i){super(),this.width=void 0!==r?r:512,this.height=void 0!==i?i:512,this.clear=!0,this.camera=t,this.scene=e,this.kernelRadius=8,this.kernelSize=32,this.kernel=[],this.noiseTexture=null,this.output=0,this.minDistance=.005,this.maxDistance=.1,this._visibilityCache=new Map,this.generateSampleKernel(),this.generateRandomKernelRotations();let n=new f.DepthTexture;n.format=f.DepthStencilFormat,n.type=f.UnsignedInt248Type,this.beautyRenderTarget=new f.WebGLRenderTarget(this.width,this.height),this.normalRenderTarget=new f.WebGLRenderTarget(this.width,this.height,{minFilter:f.NearestFilter,magFilter:f.NearestFilter,depthTexture:n}),this.ssaoRenderTarget=new f.WebGLRenderTarget(this.width,this.height),this.blurRenderTarget=this.ssaoRenderTarget.clone(),void 0===tl&&console.error("THREE.SSAOPass: The pass relies on SSAOShader."),this.ssaoMaterial=new f.ShaderMaterial({defines:Object.assign({},tl.defines),uniforms:f.UniformsUtils.clone(tl.uniforms),vertexShader:tl.vertexShader,fragmentShader:tl.fragmentShader,blending:f.NoBlending}),this.ssaoMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.ssaoMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.ssaoMaterial.uniforms.tDepth.value=this.normalRenderTarget.depthTexture,this.ssaoMaterial.uniforms.tNoise.value=this.noiseTexture,this.ssaoMaterial.uniforms.kernel.value=this.kernel,this.ssaoMaterial.uniforms.cameraNear.value=this.camera.near,this.ssaoMaterial.uniforms.cameraFar.value=this.camera.far,this.ssaoMaterial.uniforms.resolution.value.set(this.width,this.height),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.normalMaterial=new f.MeshNormalMaterial,this.normalMaterial.blending=f.NoBlending,this.blurMaterial=new f.ShaderMaterial({defines:Object.assign({},tu.defines),uniforms:f.UniformsUtils.clone(tu.uniforms),vertexShader:tu.vertexShader,fragmentShader:tu.fragmentShader}),this.blurMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.blurMaterial.uniforms.resolution.value.set(this.width,this.height),this.depthRenderMaterial=new f.ShaderMaterial({defines:Object.assign({},tc.defines),uniforms:f.UniformsUtils.clone(tc.uniforms),vertexShader:tc.vertexShader,fragmentShader:tc.fragmentShader,blending:f.NoBlending}),this.depthRenderMaterial.uniforms.tDepth.value=this.normalRenderTarget.depthTexture,this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this.copyMaterial=new f.ShaderMaterial({uniforms:f.UniformsUtils.clone(to.uniforms),vertexShader:to.vertexShader,fragmentShader:to.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:f.DstColorFactor,blendDst:f.ZeroFactor,blendEquation:f.AddEquation,blendSrcAlpha:f.DstAlphaFactor,blendDstAlpha:f.ZeroFactor,blendEquationAlpha:f.AddEquation}),this.fsQuad=new ts(null),this.originalClearColor=new f.Color}dispose(){this.beautyRenderTarget.dispose(),this.normalRenderTarget.dispose(),this.ssaoRenderTarget.dispose(),this.blurRenderTarget.dispose(),this.normalMaterial.dispose(),this.blurMaterial.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose(),this.fsQuad.dispose()}render(e,t){switch(!1===e.capabilities.isWebGL2&&(this.noiseTexture.format=f.LuminanceFormat),e.setRenderTarget(this.beautyRenderTarget),e.clear(),e.render(this.scene,this.camera),this.overrideVisibility(),this.renderOverride(e,this.normalMaterial,this.normalRenderTarget,7829503,1),this.restoreVisibility(),this.ssaoMaterial.uniforms.kernelRadius.value=this.kernelRadius,this.ssaoMaterial.uniforms.minDistance.value=this.minDistance,this.ssaoMaterial.uniforms.maxDistance.value=this.maxDistance,this.renderPass(e,this.ssaoMaterial,this.ssaoRenderTarget),this.renderPass(e,this.blurMaterial,this.blurRenderTarget),this.output){case th.OUTPUT.SSAO:this.copyMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case th.OUTPUT.Blur:this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case th.OUTPUT.Beauty:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case th.OUTPUT.Depth:this.renderPass(e,this.depthRenderMaterial,this.renderToScreen?null:t);break;case th.OUTPUT.Normal:this.copyMaterial.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case th.OUTPUT.Default:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t),this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=f.CustomBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;default:console.warn("THREE.SSAOPass: Unknown output type.")}}renderPass(e,t,r,i,n){e.getClearColor(this.originalClearColor);let a=e.getClearAlpha(),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,null!=i&&(e.setClearColor(i),e.setClearAlpha(n||0),e.clear()),this.fsQuad.material=t,this.fsQuad.render(e),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(a)}renderOverride(e,t,r,i,n){e.getClearColor(this.originalClearColor);let a=e.getClearAlpha(),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,i=t.clearColor||i,n=t.clearAlpha||n,null!=i&&(e.setClearColor(i),e.setClearAlpha(n||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(a)}setSize(e,t){this.width=e,this.height=t,this.beautyRenderTarget.setSize(e,t),this.ssaoRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.blurRenderTarget.setSize(e,t),this.ssaoMaterial.uniforms.resolution.value.set(e,t),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.blurMaterial.uniforms.resolution.value.set(e,t)}generateSampleKernel(){let e=this.kernelSize,t=this.kernel;for(let r=0;r<e;r++){let i=new f.Vector3;i.x=2*Math.random()-1,i.y=2*Math.random()-1,i.z=Math.random(),i.normalize();let n=r/e;n=f.MathUtils.lerp(.1,1,n*n),i.multiplyScalar(n),t.push(i)}}generateRandomKernelRotations(){void 0===eA&&console.error("THREE.SSAOPass: The pass relies on SimplexNoise.");let e=new eA,t=new Float32Array(16);for(let r=0;r<16;r++){let i=2*Math.random()-1,n=2*Math.random()-1;t[r]=e.noise3d(i,n,0)}this.noiseTexture=new f.DataTexture(t,4,4,f.RedFormat,f.FloatType),this.noiseTexture.wrapS=f.RepeatWrapping,this.noiseTexture.wrapT=f.RepeatWrapping,this.noiseTexture.needsUpdate=!0}overrideVisibility(){let e=this.scene,t=this._visibilityCache;e.traverse(function(e){t.set(e,e.visible),(e.isPoints||e.isLine)&&(e.visible=!1)})}restoreVisibility(){let e=this.scene,t=this._visibilityCache;e.traverse(function(e){let r=t.get(e);e.visible=r}),t.clear()}};x(th,"OUTPUT",{Default:0,SSAO:1,Blur:2,Beauty:3,Depth:4,Normal:5});let tp={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new f.Color(0)},defaultOpacity:{value:0}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D tDiffuse;\nuniform vec3 defaultColor;\nuniform float defaultOpacity;\nuniform float luminosityThreshold;\nuniform float smoothWidth;\nvarying vec2 vUv;\nvoid main() {\n	vec4 texel = texture2D( tDiffuse, vUv );\n	vec3 luma = vec3( 0.299, 0.587, 0.114 );\n	float v = dot( texel.xyz, luma );\n	vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );\n	float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n	gl_FragColor = mix( outputColor, texel, alpha );\n}"},td=class extends ta{constructor(e,t,r,i){super(),this.strength=void 0!==t?t:1,this.radius=r,this.threshold=i,this.resolution=void 0!==e?new f.Vector2(e.x,e.y):new f.Vector2(256,256),this.clearColor=new f.Color(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let n=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);this.renderTargetBright=new f.WebGLRenderTarget(n,a,{type:f.HalfFloatType}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let e=0;e<this.nMips;e++){let t=new f.WebGLRenderTarget(n,a,{type:f.HalfFloatType});t.texture.name="UnrealBloomPass.h"+e,t.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(t);let r=new f.WebGLRenderTarget(n,a,{type:f.HalfFloatType});r.texture.name="UnrealBloomPass.v"+e,r.texture.generateMipmaps=!1,this.renderTargetsVertical.push(r),n=Math.round(n/2),a=Math.round(a/2)}this.highPassUniforms=f.UniformsUtils.clone(tp.uniforms),this.highPassUniforms.luminosityThreshold.value=i,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new f.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:tp.vertexShader,fragmentShader:tp.fragmentShader,defines:{}}),this.separableBlurMaterials=[];let s=[3,5,7,9,11];n=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);for(let e=0;e<this.nMips;e++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(s[e])),this.separableBlurMaterials[e].uniforms.texSize.value=new f.Vector2(n,a),n=Math.round(n/2),a=Math.round(a/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=t,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0,this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new f.Vector3(1,1,1),new f.Vector3(1,1,1),new f.Vector3(1,1,1),new f.Vector3(1,1,1),new f.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,this.copyUniforms=f.UniformsUtils.clone(to.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new f.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:to.vertexShader,fragmentShader:to.fragmentShader,blending:f.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new f.Color,this.oldClearAlpha=1,this.basic=new f.MeshBasicMaterial,this.fsQuad=new ts(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.materialCopy.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(e,t){let r=Math.round(e/2),i=Math.round(t/2);this.renderTargetBright.setSize(r,i);for(let e=0;e<this.nMips;e++)this.renderTargetsHorizontal[e].setSize(r,i),this.renderTargetsVertical[e].setSize(r,i),this.separableBlurMaterials[e].uniforms.texSize.value=new f.Vector2(r,i),r=Math.round(r/2),i=Math.round(i/2)}render(e,t,r,i,n){e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();let a=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),n&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=r.texture,e.setRenderTarget(null),e.clear(),this.fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=r.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this.fsQuad.render(e);let s=this.renderTargetBright;for(let t=0;t<this.nMips;t++)this.fsQuad.material=this.separableBlurMaterials[t],this.separableBlurMaterials[t].uniforms.colorTexture.value=s.texture,this.separableBlurMaterials[t].uniforms.direction.value=td.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[t]),e.clear(),this.fsQuad.render(e),this.separableBlurMaterials[t].uniforms.colorTexture.value=this.renderTargetsHorizontal[t].texture,this.separableBlurMaterials[t].uniforms.direction.value=td.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[t]),e.clear(),this.fsQuad.render(e),s=this.renderTargetsVertical[t];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,n&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?e.setRenderTarget(null):e.setRenderTarget(r),this.fsQuad.render(e),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=a}getSeperableBlurMaterial(e){return new f.ShaderMaterial({defines:{KERNEL_RADIUS:e,SIGMA:e},uniforms:{colorTexture:{value:null},texSize:{value:new f.Vector2(.5,.5)},direction:{value:new f.Vector2(.5,.5)}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 texSize;
				uniform vec2 direction;

				float gaussianPdf(in float x, in float sigma) {
					return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;
				}
				void main() {
					vec2 invSize = 1.0 / texSize;
					float fSigma = float(SIGMA);
					float weightSum = gaussianPdf(0.0, fSigma);
					vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianPdf(x, fSigma);
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}getCompositeMaterial(e){return new f.ShaderMaterial({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}};x(td,"BlurDirectionX",new f.Vector2(1,0)),x(td,"BlurDirectionY",new f.Vector2(0,1));let tf={defines:{NUM_SAMPLES:7,NUM_RINGS:4,NORMAL_TEXTURE:0,DIFFUSE_TEXTURE:0,DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},tDiffuse:{value:null},tNormal:{value:null},size:{value:new f.Vector2(512,512)},cameraNear:{value:1},cameraFar:{value:100},cameraProjectionMatrix:{value:new f.Matrix4},cameraInverseProjectionMatrix:{value:new f.Matrix4},scale:{value:1},intensity:{value:.1},bias:{value:.5},minResolution:{value:0},kernelRadius:{value:100},randomSeed:{value:0}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"#include <common>\nvarying vec2 vUv;\n#if DIFFUSE_TEXTURE == 1\nuniform sampler2D tDiffuse;\n#endif\nuniform sampler2D tDepth;\n#if NORMAL_TEXTURE == 1\nuniform sampler2D tNormal;\n#endif\nuniform float cameraNear;\nuniform float cameraFar;\nuniform mat4 cameraProjectionMatrix;\nuniform mat4 cameraInverseProjectionMatrix;\nuniform float scale;\nuniform float intensity;\nuniform float bias;\nuniform float kernelRadius;\nuniform float minResolution;\nuniform vec2 size;\nuniform float randomSeed;\n// RGBA depth\n#include <packing>\nvec4 getDefaultColor( const in vec2 screenPosition ) {\n	#if DIFFUSE_TEXTURE == 1\n	return texture2D( tDiffuse, vUv );\n	#else\n	return vec4( 1.0 );\n	#endif\n}\nfloat getDepth( const in vec2 screenPosition ) {\n	#if DEPTH_PACKING == 1\n	return unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );\n	#else\n	return texture2D( tDepth, screenPosition ).x;\n	#endif\n}\nfloat getViewZ( const in float depth ) {\n	#if PERSPECTIVE_CAMERA == 1\n	return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n	#else\n	return orthographicDepthToViewZ( depth, cameraNear, cameraFar );\n	#endif\n}\nvec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {\n	float clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];\n	vec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );\n	clipPosition *= clipW; // unprojection.\n	return ( cameraInverseProjectionMatrix * clipPosition ).xyz;\n}\nvec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPosition ) {\n	#if NORMAL_TEXTURE == 1\n	return unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );\n	#else\n	return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n	#endif\n}\nfloat scaleDividedByCameraFar;\nfloat minResolutionMultipliedByCameraFar;\nfloat getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n	vec3 viewDelta = sampleViewPosition - centerViewPosition;\n	float viewDistance = length( viewDelta );\n	float scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n	return max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - bias) / (1.0 + pow2( scaledScreenDistance ) );\n}\n// moving costly divides into consts\nconst float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\nconst float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\nfloat getAmbientOcclusion( const in vec3 centerViewPosition ) {\n	// precompute some variables require in getOcclusion.\n	scaleDividedByCameraFar = scale / cameraFar;\n	minResolutionMultipliedByCameraFar = minResolution * cameraFar;\n	vec3 centerViewNormal = getViewNormal( centerViewPosition, vUv );\n	// jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/\n	float angle = rand( vUv + randomSeed ) * PI2;\n	vec2 radius = vec2( kernelRadius * INV_NUM_SAMPLES ) / size;\n	vec2 radiusStep = radius;\n	float occlusionSum = 0.0;\n	float weightSum = 0.0;\n	for( int i = 0; i < NUM_SAMPLES; i ++ ) {\n		vec2 sampleUv = vUv + vec2( cos( angle ), sin( angle ) ) * radius;\n		radius += radiusStep;\n		angle += ANGLE_STEP;\n		float sampleDepth = getDepth( sampleUv );\n		if( sampleDepth >= ( 1.0 - EPSILON ) ) {\n			continue;\n		}\n		float sampleViewZ = getViewZ( sampleDepth );\n		vec3 sampleViewPosition = getViewPosition( sampleUv, sampleDepth, sampleViewZ );\n		occlusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n		weightSum += 1.0;\n	}\n	if( weightSum == 0.0 ) discard;\n	return occlusionSum * ( intensity / weightSum );\n}\nvoid main() {\n	float centerDepth = getDepth( vUv );\n	if( centerDepth >= ( 1.0 - EPSILON ) ) {\n		discard;\n	}\n	float centerViewZ = getViewZ( centerDepth );\n	vec3 viewPosition = getViewPosition( vUv, centerDepth, centerViewZ );\n	float ambientOcclusion = getAmbientOcclusion( viewPosition );\n	gl_FragColor = getDefaultColor( vUv );\n	gl_FragColor.xyz *=  1.0 - ambientOcclusion;\n}"},tm={defines:{KERNEL_RADIUS:4,DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tDiffuse:{value:null},size:{value:new f.Vector2(512,512)},sampleUvOffsets:{value:[new f.Vector2(0,0)]},sampleWeights:{value:[1]},tDepth:{value:null},cameraNear:{value:10},cameraFar:{value:1e3},depthCutoff:{value:10}},vertexShader:"#include <common>\nuniform vec2 size;\nvarying vec2 vUv;\nvarying vec2 vInvSize;\nvoid main() {\n	vUv = uv;\n	vInvSize = 1.0 / size;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"#include <common>\n#include <packing>\nuniform sampler2D tDiffuse;\nuniform sampler2D tDepth;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform float depthCutoff;\nuniform vec2 sampleUvOffsets[ KERNEL_RADIUS + 1 ];\nuniform float sampleWeights[ KERNEL_RADIUS + 1 ];\nvarying vec2 vUv;\nvarying vec2 vInvSize;\nfloat getDepth( const in vec2 screenPosition ) {\n	#if DEPTH_PACKING == 1\n	return unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );\n	#else\n	return texture2D( tDepth, screenPosition ).x;\n	#endif\n}\nfloat getViewZ( const in float depth ) {\n	#if PERSPECTIVE_CAMERA == 1\n	return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n	#else\n	return orthographicDepthToViewZ( depth, cameraNear, cameraFar );\n	#endif\n}\nvoid main() {\n	float depth = getDepth( vUv );\n	if( depth >= ( 1.0 - EPSILON ) ) {\n		discard;\n	}\n	float centerViewZ = -getViewZ( depth );\n	bool rBreak = false, lBreak = false;\n	float weightSum = sampleWeights[0];\n	vec4 diffuseSum = texture2D( tDiffuse, vUv ) * weightSum;\n	for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n		float sampleWeight = sampleWeights[i];\n		vec2 sampleUvOffset = sampleUvOffsets[i] * vInvSize;\n		vec2 sampleUv = vUv + sampleUvOffset;\n		float viewZ = -getViewZ( getDepth( sampleUv ) );\n		if( abs( viewZ - centerViewZ ) > depthCutoff ) rBreak = true;\n		if( ! rBreak ) {\n			diffuseSum += texture2D( tDiffuse, sampleUv ) * sampleWeight;\n			weightSum += sampleWeight;\n		}\n		sampleUv = vUv - sampleUvOffset;\n		viewZ = -getViewZ( getDepth( sampleUv ) );\n		if( abs( viewZ - centerViewZ ) > depthCutoff ) lBreak = true;\n		if( ! lBreak ) {\n			diffuseSum += texture2D( tDiffuse, sampleUv ) * sampleWeight;\n			weightSum += sampleWeight;\n		}\n	}\n	gl_FragColor = diffuseSum / weightSum;\n}"},tg={createSampleWeights:(e,t)=>{let r=(e,t)=>Math.exp(-(e*e)/(t*t*2))/(Math.sqrt(2*Math.PI)*t),i=[];for(let n=0;n<=e;n++)i.push(r(n,t));return i},createSampleOffsets:(e,t)=>{let r=[];for(let i=0;i<=e;i++)r.push(t.clone().multiplyScalar(i));return r},configure:(e,t,r,i)=>{e.defines.KERNEL_RADIUS=t,e.uniforms.sampleUvOffsets.value=tg.createSampleOffsets(t,i),e.uniforms.sampleWeights.value=tg.createSampleWeights(t,r),e.needsUpdate=!0}};class tv extends ta{constructor(e,t,r=!1,i=!1,n=new f.Vector2(256,256)){let a;super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.supportsDepthTextureExtension=r,this.supportsNormalTexture=i,this.originalClearColor=new f.Color,this._oldClearColor=new f.Color,this.oldClearAlpha=1,this.params={output:0,saoBias:.5,saoIntensity:.18,saoScale:1,saoKernelRadius:100,saoMinResolution:0,saoBlur:!0,saoBlurRadius:8,saoBlurStdDev:4,saoBlurDepthCutoff:.01},this.resolution=new f.Vector2(n.x,n.y),this.saoRenderTarget=new f.WebGLRenderTarget(this.resolution.x,this.resolution.y,{type:f.HalfFloatType}),this.blurIntermediateRenderTarget=this.saoRenderTarget.clone(),this.beautyRenderTarget=this.saoRenderTarget.clone(),this.normalRenderTarget=new f.WebGLRenderTarget(this.resolution.x,this.resolution.y,{minFilter:f.NearestFilter,magFilter:f.NearestFilter,type:f.HalfFloatType}),this.depthRenderTarget=this.normalRenderTarget.clone(),this.supportsDepthTextureExtension&&((a=new f.DepthTexture).type=f.UnsignedShortType,this.beautyRenderTarget.depthTexture=a,this.beautyRenderTarget.depthBuffer=!0),this.depthMaterial=new f.MeshDepthMaterial,this.depthMaterial.depthPacking=f.RGBADepthPacking,this.depthMaterial.blending=f.NoBlending,this.normalMaterial=new f.MeshNormalMaterial,this.normalMaterial.blending=f.NoBlending,this.saoMaterial=new f.ShaderMaterial({defines:Object.assign({},tf.defines),fragmentShader:tf.fragmentShader,vertexShader:tf.vertexShader,uniforms:f.UniformsUtils.clone(tf.uniforms)}),this.saoMaterial.extensions.derivatives=!0,this.saoMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.saoMaterial.defines.NORMAL_TEXTURE=this.supportsNormalTexture?1:0,this.saoMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.saoMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?a:this.depthRenderTarget.texture,this.saoMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.saoMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.saoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.saoMaterial.uniforms.cameraProjectionMatrix.value=this.camera.projectionMatrix,this.saoMaterial.blending=f.NoBlending,this.vBlurMaterial=new f.ShaderMaterial({uniforms:f.UniformsUtils.clone(tm.uniforms),defines:Object.assign({},tm.defines),vertexShader:tm.vertexShader,fragmentShader:tm.fragmentShader}),this.vBlurMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.vBlurMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.vBlurMaterial.uniforms.tDiffuse.value=this.saoRenderTarget.texture,this.vBlurMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?a:this.depthRenderTarget.texture,this.vBlurMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.vBlurMaterial.blending=f.NoBlending,this.hBlurMaterial=new f.ShaderMaterial({uniforms:f.UniformsUtils.clone(tm.uniforms),defines:Object.assign({},tm.defines),vertexShader:tm.vertexShader,fragmentShader:tm.fragmentShader}),this.hBlurMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.hBlurMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.hBlurMaterial.uniforms.tDiffuse.value=this.blurIntermediateRenderTarget.texture,this.hBlurMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?a:this.depthRenderTarget.texture,this.hBlurMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.hBlurMaterial.blending=f.NoBlending,this.materialCopy=new f.ShaderMaterial({uniforms:f.UniformsUtils.clone(to.uniforms),vertexShader:to.vertexShader,fragmentShader:to.fragmentShader,blending:f.NoBlending}),this.materialCopy.transparent=!0,this.materialCopy.depthTest=!1,this.materialCopy.depthWrite=!1,this.materialCopy.blending=f.CustomBlending,this.materialCopy.blendSrc=f.DstColorFactor,this.materialCopy.blendDst=f.ZeroFactor,this.materialCopy.blendEquation=f.AddEquation,this.materialCopy.blendSrcAlpha=f.DstAlphaFactor,this.materialCopy.blendDstAlpha=f.ZeroFactor,this.materialCopy.blendEquationAlpha=f.AddEquation,this.depthCopy=new f.ShaderMaterial({uniforms:f.UniformsUtils.clone(eP.uniforms),vertexShader:eP.vertexShader,fragmentShader:eP.fragmentShader,blending:f.NoBlending}),this.fsQuad=new ts(null)}render(e,t,r){if(this.renderToScreen&&(this.materialCopy.blending=f.NoBlending,this.materialCopy.uniforms.tDiffuse.value=r.texture,this.materialCopy.needsUpdate=!0,this.renderPass(e,this.materialCopy,null)),1===this.params.output)return;e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();let i=e.autoClear;e.autoClear=!1,e.setRenderTarget(this.depthRenderTarget),e.clear(),this.saoMaterial.uniforms.bias.value=this.params.saoBias,this.saoMaterial.uniforms.intensity.value=this.params.saoIntensity,this.saoMaterial.uniforms.scale.value=this.params.saoScale,this.saoMaterial.uniforms.kernelRadius.value=this.params.saoKernelRadius,this.saoMaterial.uniforms.minResolution.value=this.params.saoMinResolution,this.saoMaterial.uniforms.cameraNear.value=this.camera.near,this.saoMaterial.uniforms.cameraFar.value=this.camera.far;let n=this.params.saoBlurDepthCutoff*(this.camera.far-this.camera.near);this.vBlurMaterial.uniforms.depthCutoff.value=n,this.hBlurMaterial.uniforms.depthCutoff.value=n,this.vBlurMaterial.uniforms.cameraNear.value=this.camera.near,this.vBlurMaterial.uniforms.cameraFar.value=this.camera.far,this.hBlurMaterial.uniforms.cameraNear.value=this.camera.near,this.hBlurMaterial.uniforms.cameraFar.value=this.camera.far,this.params.saoBlurRadius=Math.floor(this.params.saoBlurRadius),(this.prevStdDev!==this.params.saoBlurStdDev||this.prevNumSamples!==this.params.saoBlurRadius)&&(tg.configure(this.vBlurMaterial,this.params.saoBlurRadius,this.params.saoBlurStdDev,new f.Vector2(0,1)),tg.configure(this.hBlurMaterial,this.params.saoBlurRadius,this.params.saoBlurStdDev,new f.Vector2(1,0)),this.prevStdDev=this.params.saoBlurStdDev,this.prevNumSamples=this.params.saoBlurRadius),e.setClearColor(0),e.setRenderTarget(this.beautyRenderTarget),e.clear(),e.render(this.scene,this.camera),this.supportsDepthTextureExtension||this.renderOverride(e,this.depthMaterial,this.depthRenderTarget,0,1),this.supportsNormalTexture&&this.renderOverride(e,this.normalMaterial,this.normalRenderTarget,7829503,1),this.renderPass(e,this.saoMaterial,this.saoRenderTarget,16777215,1),this.params.saoBlur&&(this.renderPass(e,this.vBlurMaterial,this.blurIntermediateRenderTarget,16777215,1),this.renderPass(e,this.hBlurMaterial,this.saoRenderTarget,16777215,1));let a=this.materialCopy;3===this.params.output?this.supportsDepthTextureExtension?(this.materialCopy.uniforms.tDiffuse.value=this.beautyRenderTarget.depthTexture,this.materialCopy.needsUpdate=!0):(this.depthCopy.uniforms.tDiffuse.value=this.depthRenderTarget.texture,this.depthCopy.needsUpdate=!0,a=this.depthCopy):(4===this.params.output?this.materialCopy.uniforms.tDiffuse.value=this.normalRenderTarget.texture:this.materialCopy.uniforms.tDiffuse.value=this.saoRenderTarget.texture,this.materialCopy.needsUpdate=!0),0===this.params.output?a.blending=f.CustomBlending:a.blending=f.NoBlending,this.renderPass(e,a,this.renderToScreen?null:r),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=i}renderPass(e,t,r,i,n){e.getClearColor(this.originalClearColor);let a=e.getClearAlpha(),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,null!=i&&(e.setClearColor(i),e.setClearAlpha(n||0),e.clear()),this.fsQuad.material=t,this.fsQuad.render(e),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(a)}renderOverride(e,t,r,i,n){e.getClearColor(this.originalClearColor);let a=e.getClearAlpha(),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,i=t.clearColor||i,n=t.clearAlpha||n,null!=i&&(e.setClearColor(i),e.setClearAlpha(n||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(a)}setSize(e,t){this.beautyRenderTarget.setSize(e,t),this.saoRenderTarget.setSize(e,t),this.blurIntermediateRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.depthRenderTarget.setSize(e,t),this.saoMaterial.uniforms.size.value.set(e,t),this.saoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.saoMaterial.uniforms.cameraProjectionMatrix.value=this.camera.projectionMatrix,this.saoMaterial.needsUpdate=!0,this.vBlurMaterial.uniforms.size.value.set(e,t),this.vBlurMaterial.needsUpdate=!0,this.hBlurMaterial.uniforms.size.value.set(e,t),this.hBlurMaterial.needsUpdate=!0}dispose(){this.saoRenderTarget.dispose(),this.blurIntermediateRenderTarget.dispose(),this.beautyRenderTarget.dispose(),this.normalRenderTarget.dispose(),this.depthRenderTarget.dispose(),this.depthMaterial.dispose(),this.normalMaterial.dispose(),this.saoMaterial.dispose(),this.vBlurMaterial.dispose(),this.hBlurMaterial.dispose(),this.materialCopy.dispose(),this.depthCopy.dispose(),this.fsQuad.dispose()}}x(tv,"OUTPUT",{Beauty:1,Default:0,SAO:2,Depth:3,Normal:4});let ty={defines:{MAX_STEP:0,isPerspectiveCamera:!0,isDistanceAttenuation:!0,isFresnel:!0,isInfiniteThick:!1,isSelective:!1},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tMetalness:{value:null},tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new f.Vector2},cameraProjectionMatrix:{value:new f.Matrix4},cameraInverseProjectionMatrix:{value:new f.Matrix4},opacity:{value:.5},maxDistance:{value:180},cameraRange:{value:0},surfDist:{value:.007},thickTolerance:{value:.03}},vertexShader:`

    varying vec2 vUv;

    void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }

  `,fragmentShader:`
		// precision highp float;
		precision highp sampler2D;
		varying vec2 vUv;
		uniform sampler2D tDepth;
		uniform sampler2D tNormal;
		uniform sampler2D tMetalness;
		uniform sampler2D tDiffuse;
		uniform float cameraRange;
		uniform vec2 resolution;
		uniform float opacity;
		uniform float cameraNear;
		uniform float cameraFar;
		uniform float maxDistance;
		uniform float surfDist;
		uniform mat4 cameraProjectionMatrix;
		uniform mat4 cameraInverseProjectionMatrix;
		uniform float thickTolerance;
		#include <packing>
		float pointToLineDistance(vec3 x0, vec3 x1, vec3 x2) {
			//x0: point, x1: linePointA, x2: linePointB
			//https://mathworld.wolfram.com/Point-LineDistance3-Dimensional.html
			return length(cross(x0-x1,x0-x2))/length(x2-x1);
		}
		float pointPlaneDistance(vec3 point,vec3 planePoint,vec3 planeNormal){
			// https://mathworld.wolfram.com/Point-PlaneDistance.html
			//// https://en.wikipedia.org/wiki/Plane_(geometry)
			//// http://paulbourke.net/geometry/pointlineplane/
			float a=planeNormal.x,b=planeNormal.y,c=planeNormal.z;
			float x0=point.x,y0=point.y,z0=point.z;
			float x=planePoint.x,y=planePoint.y,z=planePoint.z;
			float d=-(a*x+b*y+c*z);
			float distance=(a*x0+b*y0+c*z0+d)/sqrt(a*a+b*b+c*c);
			return distance;
		}
		float getDepth( const in vec2 uv ) {
			return texture2D( tDepth, uv ).x;
		}
		float getViewZ( const in float depth ) {
			#ifdef isPerspectiveCamera
				return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );
			#else
				return orthographicDepthToViewZ( depth, cameraNear, cameraFar );
			#endif
		}
		vec3 getViewPosition( const in vec2 uv, const in float depth/*clip space*/, const in float clipW ) {
			vec4 clipPosition = vec4( ( vec3( uv, depth ) - 0.5 ) * 2.0, 1.0 );//ndc
			clipPosition *= clipW; //clip
			return ( cameraInverseProjectionMatrix * clipPosition ).xyz;//view
		}
		vec3 getViewNormal( const in vec2 uv ) {
			return unpackRGBToNormal( texture2D( tNormal, uv ).xyz );
		}
		vec2 viewPositionToXY(vec3 viewPosition){
			vec2 xy;
			vec4 clip=cameraProjectionMatrix*vec4(viewPosition,1);
			xy=clip.xy;//clip
			float clipW=clip.w;
			xy/=clipW;//NDC
			xy=(xy+1.)/2.;//uv
			xy*=resolution;//screen
			return xy;
		}
		void main(){
			#ifdef isSelective
				float metalness=texture2D(tMetalness,vUv).r;
				if(metalness==0.) return;
			#endif

			float depth = getDepth( vUv );
			float viewZ = getViewZ( depth );
			if(-viewZ>=cameraFar) return;

			float clipW = cameraProjectionMatrix[2][3] * viewZ+cameraProjectionMatrix[3][3];
			vec3 viewPosition=getViewPosition( vUv, depth, clipW );

			vec2 d0=gl_FragCoord.xy;
			vec2 d1;

			vec3 viewNormal=getViewNormal( vUv );

			#ifdef isPerspectiveCamera
				vec3 viewIncidenceDir=normalize(viewPosition);
				vec3 viewReflectDir=reflect(viewIncidenceDir,viewNormal);
			#else
				vec3 viewIncidenceDir=vec3(0,0,-1);
				vec3 viewReflectDir=reflect(viewIncidenceDir,viewNormal);
			#endif

			float maxReflectRayLen=maxDistance/dot(-viewIncidenceDir,viewNormal);
			// dot(a,b)==length(a)*length(b)*cos(theta) // https://www.mathsisfun.com/algebra/vectors-dot-product.html
			// if(a.isNormalized&&b.isNormalized) dot(a,b)==cos(theta)
			// maxDistance/maxReflectRayLen=cos(theta)
			// maxDistance/maxReflectRayLen==dot(a,b)
			// maxReflectRayLen==maxDistance/dot(a,b)

			vec3 d1viewPosition=viewPosition+viewReflectDir*maxReflectRayLen;
			#ifdef isPerspectiveCamera
				if(d1viewPosition.z>-cameraNear){
					//https://tutorial.math.lamar.edu/Classes/CalcIII/EqnsOfLines.aspx
					float t=(-cameraNear-viewPosition.z)/viewReflectDir.z;
					d1viewPosition=viewPosition+viewReflectDir*t;
				}
			#endif
			d1=viewPositionToXY(d1viewPosition);

			float totalLen=length(d1-d0);
			float xLen=d1.x-d0.x;
			float yLen=d1.y-d0.y;
			float totalStep=max(abs(xLen),abs(yLen));
			float xSpan=xLen/totalStep;
			float ySpan=yLen/totalStep;
			for(float i=0.;i<MAX_STEP;i++){
				if(i>=totalStep) break;
				vec2 xy=vec2(d0.x+i*xSpan,d0.y+i*ySpan);
				if(xy.x<0.||xy.x>resolution.x||xy.y<0.||xy.y>resolution.y) break;
				float s=length(xy-d0)/totalLen;
				vec2 uv=xy/resolution;

				float d = getDepth(uv);
				float vZ = getViewZ( d );
				if(-vZ>=cameraFar) continue;
				float cW = cameraProjectionMatrix[2][3] * vZ+cameraProjectionMatrix[3][3];
				vec3 vP=getViewPosition( uv, d, cW );

				#ifdef isPerspectiveCamera
					// https://www.comp.nus.edu.sg/~lowkl/publications/lowk_persp_interp_techrep.pdf
					float recipVPZ=1./viewPosition.z;
					float viewReflectRayZ=1./(recipVPZ+s*(1./d1viewPosition.z-recipVPZ));
					float sD=surfDist*cW;
				#else
					float viewReflectRayZ=viewPosition.z+s*(d1viewPosition.z-viewPosition.z);
					float sD=surfDist;
				#endif
				if(viewReflectRayZ-sD>vZ) continue;

				#ifdef isInfiniteThick
					if(viewReflectRayZ+thickTolerance*clipW<vP.z) break;
				#endif
				float away=pointToLineDistance(vP,viewPosition,d1viewPosition);

				float op=opacity;

				if(away<sD){
					vec3 vN=getViewNormal( uv );
					if(dot(viewReflectDir,vN)>=0.) continue;
					float distance=pointPlaneDistance(vP,viewPosition,viewNormal);
					if(distance>maxDistance) break;
					#ifdef isDistanceAttenuation
						float ratio=1.-(distance/maxDistance);
						float attenuation=ratio*ratio;
						op=opacity*attenuation;
					#endif
					#ifdef isFresnel
						float fresnel=(dot(viewIncidenceDir,viewReflectDir)+1.)/2.;
						op*=fresnel;
					#endif
					vec4 reflectColor=texture2D(tDiffuse,uv);
					gl_FragColor.xyz=reflectColor.xyz;
					gl_FragColor.a=op;
					break;
				}
			}
		}
	`},tx={defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:`

    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }

  `,fragmentShader:`

    uniform sampler2D tDepth;

    uniform float cameraNear;
    uniform float cameraFar;

    varying vec2 vUv;

    #include <packing>

		float getLinearDepth( const in vec2 uv ) {

			#if PERSPECTIVE_CAMERA == 1

				float fragCoordZ = texture2D( tDepth, uv ).x;
				float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );
				return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );

			#else

				return texture2D( tDepth, uv ).x;

			#endif

		}

    void main() {

    	float depth = getLinearDepth( vUv );
			float d = 1.0 - depth;
			// d=(d-.999)*1000.;
    	gl_FragColor = vec4( vec3( d ), 1.0 );

    }

  `},tT={uniforms:{tDiffuse:{value:null},resolution:{value:new f.Vector2},opacity:{value:.5}},vertexShader:`

    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }

  `,fragmentShader:`

    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    varying vec2 vUv;
    void main() {
			//reverse engineering from PhotoShop blur filter, then change coefficient

    	vec2 texelSize = ( 1.0 / resolution );

			vec4 c=texture2D(tDiffuse,vUv);

			vec2 offset;

			offset=(vec2(-1,0))*texelSize;
			vec4 cl=texture2D(tDiffuse,vUv+offset);

			offset=(vec2(1,0))*texelSize;
			vec4 cr=texture2D(tDiffuse,vUv+offset);

			offset=(vec2(0,-1))*texelSize;
			vec4 cb=texture2D(tDiffuse,vUv+offset);

			offset=(vec2(0,1))*texelSize;
			vec4 ct=texture2D(tDiffuse,vUv+offset);

			// float coeCenter=.5;
			// float coeSide=.125;
			float coeCenter=.2;
			float coeSide=.2;
			float a=c.a*coeCenter+cl.a*coeSide+cr.a*coeSide+cb.a*coeSide+ct.a*coeSide;
			vec3 rgb=(c.rgb*c.a*coeCenter+cl.rgb*cl.a*coeSide+cr.rgb*cr.a*coeSide+cb.rgb*cb.a*coeSide+ct.rgb*ct.a*coeSide)/a;
			gl_FragColor=vec4(rgb,a);

		}
	`},tb=class extends ta{constructor({renderer:e,scene:t,camera:r,width:i,height:n,selects:a,bouncing:s=!1,groundReflector:o}){super(),this.width=void 0!==i?i:512,this.height=void 0!==n?n:512,this.clear=!0,this.renderer=e,this.scene=t,this.camera=r,this.groundReflector=o,this.opacity=ty.uniforms.opacity.value,this.output=0,this.maxDistance=ty.uniforms.maxDistance.value,this.thickness=ty.uniforms.thickness.value,this.tempColor=new f.Color,this._selects=a,this.selective=Array.isArray(this._selects),Object.defineProperty(this,"selects",{get(){return this._selects},set(e){this._selects!==e&&(this._selects=e,Array.isArray(e)?(this.selective=!0,this.ssrMaterial.defines.SELECTIVE=!0):(this.selective=!1,this.ssrMaterial.defines.SELECTIVE=!1),this.ssrMaterial.needsUpdate=!0)}}),this._bouncing=s,Object.defineProperty(this,"bouncing",{get(){return this._bouncing},set(e){this._bouncing!==e&&(this._bouncing=e,e?this.ssrMaterial.uniforms.tDiffuse.value=this.prevRenderTarget.texture:this.ssrMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture)}}),this.blur=!0,this._distanceAttenuation=ty.defines.DISTANCE_ATTENUATION,Object.defineProperty(this,"distanceAttenuation",{get(){return this._distanceAttenuation},set(e){this._distanceAttenuation!==e&&(this._distanceAttenuation=e,this.ssrMaterial.defines.DISTANCE_ATTENUATION=e,this.ssrMaterial.needsUpdate=!0)}}),this._fresnel=ty.defines.FRESNEL,Object.defineProperty(this,"fresnel",{get(){return this._fresnel},set(e){this._fresnel!==e&&(this._fresnel=e,this.ssrMaterial.defines.FRESNEL=e,this.ssrMaterial.needsUpdate=!0)}}),this._infiniteThick=ty.defines.INFINITE_THICK,Object.defineProperty(this,"infiniteThick",{get(){return this._infiniteThick},set(e){this._infiniteThick!==e&&(this._infiniteThick=e,this.ssrMaterial.defines.INFINITE_THICK=e,this.ssrMaterial.needsUpdate=!0)}});let l=new f.DepthTexture;l.type=f.UnsignedShortType,l.minFilter=f.NearestFilter,l.magFilter=f.NearestFilter,this.beautyRenderTarget=new f.WebGLRenderTarget(this.width,this.height,{minFilter:f.NearestFilter,magFilter:f.NearestFilter,type:f.HalfFloatType,depthTexture:l,depthBuffer:!0}),this.prevRenderTarget=new f.WebGLRenderTarget(this.width,this.height,{minFilter:f.NearestFilter,magFilter:f.NearestFilter}),this.normalRenderTarget=new f.WebGLRenderTarget(this.width,this.height,{minFilter:f.NearestFilter,magFilter:f.NearestFilter,type:f.HalfFloatType}),this.metalnessRenderTarget=new f.WebGLRenderTarget(this.width,this.height,{minFilter:f.NearestFilter,magFilter:f.NearestFilter,type:f.HalfFloatType}),this.ssrRenderTarget=new f.WebGLRenderTarget(this.width,this.height,{minFilter:f.NearestFilter,magFilter:f.NearestFilter}),this.blurRenderTarget=this.ssrRenderTarget.clone(),this.blurRenderTarget2=this.ssrRenderTarget.clone(),this.ssrMaterial=new f.ShaderMaterial({defines:Object.assign({},ty.defines,{MAX_STEP:Math.sqrt(this.width*this.width+this.height*this.height)}),uniforms:f.UniformsUtils.clone(ty.uniforms),vertexShader:ty.vertexShader,fragmentShader:ty.fragmentShader,blending:f.NoBlending}),this.ssrMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.ssrMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.ssrMaterial.defines.SELECTIVE=this.selective,this.ssrMaterial.needsUpdate=!0,this.ssrMaterial.uniforms.tMetalness.value=this.metalnessRenderTarget.texture,this.ssrMaterial.uniforms.tDepth.value=this.beautyRenderTarget.depthTexture,this.ssrMaterial.uniforms.cameraNear.value=this.camera.near,this.ssrMaterial.uniforms.cameraFar.value=this.camera.far,this.ssrMaterial.uniforms.thickness.value=this.thickness,this.ssrMaterial.uniforms.resolution.value.set(this.width,this.height),this.ssrMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssrMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.normalMaterial=new f.MeshNormalMaterial,this.normalMaterial.blending=f.NoBlending,this.metalnessOnMaterial=new f.MeshBasicMaterial({color:"white"}),this.metalnessOffMaterial=new f.MeshBasicMaterial({color:"black"}),this.blurMaterial=new f.ShaderMaterial({defines:Object.assign({},tT.defines),uniforms:f.UniformsUtils.clone(tT.uniforms),vertexShader:tT.vertexShader,fragmentShader:tT.fragmentShader}),this.blurMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.blurMaterial.uniforms.resolution.value.set(this.width,this.height),this.blurMaterial2=new f.ShaderMaterial({defines:Object.assign({},tT.defines),uniforms:f.UniformsUtils.clone(tT.uniforms),vertexShader:tT.vertexShader,fragmentShader:tT.fragmentShader}),this.blurMaterial2.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.blurMaterial2.uniforms.resolution.value.set(this.width,this.height),this.depthRenderMaterial=new f.ShaderMaterial({defines:Object.assign({},tx.defines),uniforms:f.UniformsUtils.clone(tx.uniforms),vertexShader:tx.vertexShader,fragmentShader:tx.fragmentShader,blending:f.NoBlending}),this.depthRenderMaterial.uniforms.tDepth.value=this.beautyRenderTarget.depthTexture,this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this.copyMaterial=new f.ShaderMaterial({uniforms:f.UniformsUtils.clone(to.uniforms),vertexShader:to.vertexShader,fragmentShader:to.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:f.SrcAlphaFactor,blendDst:f.OneMinusSrcAlphaFactor,blendEquation:f.AddEquation,blendSrcAlpha:f.SrcAlphaFactor,blendDstAlpha:f.OneMinusSrcAlphaFactor,blendEquationAlpha:f.AddEquation}),this.fsQuad=new ts(null),this.originalClearColor=new f.Color}dispose(){this.beautyRenderTarget.dispose(),this.prevRenderTarget.dispose(),this.normalRenderTarget.dispose(),this.metalnessRenderTarget.dispose(),this.ssrRenderTarget.dispose(),this.blurRenderTarget.dispose(),this.blurRenderTarget2.dispose(),this.normalMaterial.dispose(),this.metalnessOnMaterial.dispose(),this.metalnessOffMaterial.dispose(),this.blurMaterial.dispose(),this.blurMaterial2.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose(),this.fsQuad.dispose()}render(e,t){switch(e.setRenderTarget(this.beautyRenderTarget),e.clear(),this.groundReflector&&(this.groundReflector.visible=!1,this.groundReflector.doRender(this.renderer,this.scene,this.camera),this.groundReflector.visible=!0),e.render(this.scene,this.camera),this.groundReflector&&(this.groundReflector.visible=!1),this.renderOverride(e,this.normalMaterial,this.normalRenderTarget,0,0),this.selective&&this.renderMetalness(e,this.metalnessOnMaterial,this.metalnessRenderTarget,0,0),this.ssrMaterial.uniforms.opacity.value=this.opacity,this.ssrMaterial.uniforms.maxDistance.value=this.maxDistance,this.ssrMaterial.uniforms.thickness.value=this.thickness,this.renderPass(e,this.ssrMaterial,this.ssrRenderTarget),this.blur&&(this.renderPass(e,this.blurMaterial,this.blurRenderTarget),this.renderPass(e,this.blurMaterial2,this.blurRenderTarget2)),this.output){case tb.OUTPUT.Default:this.bouncing?(this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.prevRenderTarget),this.blur?this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget2.texture:this.copyMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.copyMaterial.blending=f.NormalBlending,this.renderPass(e,this.copyMaterial,this.prevRenderTarget),this.copyMaterial.uniforms.tDiffuse.value=this.prevRenderTarget.texture,this.copyMaterial.blending=f.NoBlending):(this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t),this.blur?this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget2.texture:this.copyMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.copyMaterial.blending=f.NormalBlending),this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case tb.OUTPUT.SSR:this.blur?this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget2.texture:this.copyMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t),this.bouncing&&(this.blur?this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget2.texture:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.prevRenderTarget),this.copyMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.copyMaterial.blending=f.NormalBlending,this.renderPass(e,this.copyMaterial,this.prevRenderTarget));break;case tb.OUTPUT.Beauty:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case tb.OUTPUT.Depth:this.renderPass(e,this.depthRenderMaterial,this.renderToScreen?null:t);break;case tb.OUTPUT.Normal:this.copyMaterial.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case tb.OUTPUT.Metalness:this.copyMaterial.uniforms.tDiffuse.value=this.metalnessRenderTarget.texture,this.copyMaterial.blending=f.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;default:console.warn("THREE.SSRPass: Unknown output type.")}}renderPass(e,t,r,i,n){this.originalClearColor.copy(e.getClearColor(this.tempColor));let a=e.getClearAlpha(this.tempColor),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,null!=i&&(e.setClearColor(i),e.setClearAlpha(n||0),e.clear()),this.fsQuad.material=t,this.fsQuad.render(e),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(a)}renderOverride(e,t,r,i,n){this.originalClearColor.copy(e.getClearColor(this.tempColor));let a=e.getClearAlpha(this.tempColor),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,i=t.clearColor||i,n=t.clearAlpha||n,null!=i&&(e.setClearColor(i),e.setClearAlpha(n||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(a)}renderMetalness(e,t,r,i,n){this.originalClearColor.copy(e.getClearColor(this.tempColor));let a=e.getClearAlpha(this.tempColor),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,i=t.clearColor||i,n=t.clearAlpha||n,null!=i&&(e.setClearColor(i),e.setClearAlpha(n||0),e.clear()),this.scene.traverseVisible(e=>{e._SSRPassBackupMaterial=e.material,this._selects.includes(e)?e.material=this.metalnessOnMaterial:e.material=this.metalnessOffMaterial}),e.render(this.scene,this.camera),this.scene.traverseVisible(e=>{e.material=e._SSRPassBackupMaterial}),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(a)}setSize(e,t){this.width=e,this.height=t,this.ssrMaterial.defines.MAX_STEP=Math.sqrt(e*e+t*t),this.ssrMaterial.needsUpdate=!0,this.beautyRenderTarget.setSize(e,t),this.prevRenderTarget.setSize(e,t),this.ssrRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.metalnessRenderTarget.setSize(e,t),this.blurRenderTarget.setSize(e,t),this.blurRenderTarget2.setSize(e,t),this.ssrMaterial.uniforms.resolution.value.set(e,t),this.ssrMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssrMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.blurMaterial.uniforms.resolution.value.set(e,t),this.blurMaterial2.uniforms.resolution.value.set(e,t)}};x(tb,"OUTPUT",{Default:0,SSR:1,Beauty:3,Depth:4,Normal:5,Metalness:7});function tS(){let e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let tE={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class tR{constructor(e){this.parser=e,this.name=tE.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let r=0,i=t.length;r<i;r++){let i=t[r];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){let t;let r=this.parser,i="light:"+e,n=r.cache.get(i);if(n)return n;let a=r.json,s=((a.extensions&&a.extensions[this.name]||{}).lights||[])[e],o=new Color(16777215);void 0!==s.color&&o.fromArray(s.color);let l=void 0!==s.range?s.range:0;switch(s.type){case"directional":(t=new DirectionalLight(o)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new PointLight(o)).distance=l;break;case"spot":(t=new SpotLight(o)).distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,t.angle=s.spot.outerConeAngle,t.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+s.type)}return t.position.set(0,0,0),t.decay=2,t5(t,s),void 0!==s.intensity&&(t.intensity=s.intensity),t.name=r.createUniqueName(s.name||"light_"+e),n=Promise.resolve(t),r.cache.add(i,n),n}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,r=this.parser,i=r.json.nodes[e],n=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===n?null:this._loadLight(n).then(function(e){return r._getNodeRef(t.cache,n,e)})}}class tA{constructor(){this.name=tE.KHR_MATERIALS_UNLIT}getMaterialType(){return MeshBasicMaterial}extendParams(e,t,r){let i=[];e.color=new Color(1,1,1),e.opacity=1;let n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){let t=n.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==n.baseColorTexture&&i.push(r.assignTexture(e,"map",n.baseColorTexture,3001))}return Promise.all(i)}}class tw{constructor(e){this.parser=e,this.name=tE.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=r.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}}class tM{constructor(e){this.parser=e,this.name=tE.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let n=[],a=i.extensions[this.name];if(void 0!==a.clearcoatFactor&&(t.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&n.push(r.assignTexture(t,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(t.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&n.push(r.assignTexture(t,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(n.push(r.assignTexture(t,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){let e=a.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Vector2(e,e)}return Promise.all(n)}}class tC{constructor(e){this.parser=e,this.name=tE.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let n=[],a=i.extensions[this.name];return void 0!==a.iridescenceFactor&&(t.iridescence=a.iridescenceFactor),void 0!==a.iridescenceTexture&&n.push(r.assignTexture(t,"iridescenceMap",a.iridescenceTexture)),void 0!==a.iridescenceIor&&(t.iridescenceIOR=a.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==a.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=a.iridescenceThicknessMinimum),void 0!==a.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=a.iridescenceThicknessMaximum),void 0!==a.iridescenceThicknessTexture&&n.push(r.assignTexture(t,"iridescenceThicknessMap",a.iridescenceThicknessTexture)),Promise.all(n)}}class tI{constructor(e){this.parser=e,this.name=tE.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let n=[];t.sheenColor=new Color(0,0,0),t.sheenRoughness=0,t.sheen=1;let a=i.extensions[this.name];return void 0!==a.sheenColorFactor&&t.sheenColor.fromArray(a.sheenColorFactor),void 0!==a.sheenRoughnessFactor&&(t.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&n.push(r.assignTexture(t,"sheenColorMap",a.sheenColorTexture,3001)),void 0!==a.sheenRoughnessTexture&&n.push(r.assignTexture(t,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(n)}}class tN{constructor(e){this.parser=e,this.name=tE.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let n=[],a=i.extensions[this.name];return void 0!==a.transmissionFactor&&(t.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&n.push(r.assignTexture(t,"transmissionMap",a.transmissionTexture)),Promise.all(n)}}class tO{constructor(e){this.parser=e,this.name=tE.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let n=[],a=i.extensions[this.name];t.thickness=void 0!==a.thicknessFactor?a.thicknessFactor:0,void 0!==a.thicknessTexture&&n.push(r.assignTexture(t,"thicknessMap",a.thicknessTexture)),t.attenuationDistance=a.attenuationDistance||1/0;let s=a.attenuationColor||[1,1,1];return t.attenuationColor=new Color(s[0],s[1],s[2]),Promise.all(n)}}class tP{constructor(e){this.parser=e,this.name=tE.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();let i=r.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class tk{constructor(e){this.parser=e,this.name=tE.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let n=[],a=i.extensions[this.name];t.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&n.push(r.assignTexture(t,"specularIntensityMap",a.specularTexture));let s=a.specularColorFactor||[1,1,1];return t.specularColor=new Color(s[0],s[1],s[2]),void 0!==a.specularColorTexture&&n.push(r.assignTexture(t,"specularColorMap",a.specularColorTexture,3001)),Promise.all(n)}}class t_{constructor(e){this.parser=e,this.name=tE.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let n=[],a=i.extensions[this.name];return void 0!==a.anisotropyStrength&&(t.anisotropy=a.anisotropyStrength),void 0!==a.anisotropyRotation&&(t.anisotropyRotation=a.anisotropyRotation),void 0!==a.anisotropyTexture&&n.push(r.assignTexture(t,"anisotropyMap",a.anisotropyTexture)),Promise.all(n)}}class tL{constructor(e){this.parser=e,this.name=tE.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,r=t.json,i=r.textures[e];if(!i.extensions||!i.extensions[this.name])return null;let n=i.extensions[this.name],a=t.options.ktx2Loader;if(!a){if(!(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}return t.loadTextureImage(e,n.source,a)}}class tU{constructor(e){this.parser=e,this.name=tE.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){let t=this.name,r=this.parser,i=r.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;let a=n.extensions[t],s=i.images[a.source],o=r.textureLoader;if(s.uri){let e=r.options.manager.getHandler(s.uri);null!==e&&(o=e)}return this.detectSupport().then(function(n){if(n)return r.loadTextureImage(e,a.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){let t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class tD{constructor(e){this.parser=e,this.name=tE.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){let t=this.name,r=this.parser,i=r.json,n=i.textures[e];if(!n.extensions||!n.extensions[t])return null;let a=n.extensions[t],s=i.images[a.source],o=r.textureLoader;if(s.uri){let e=r.options.manager.getHandler(s.uri);null!==e&&(o=e)}return this.detectSupport().then(function(n){if(n)return r.loadTextureImage(e,a.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){let t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}}class tF{constructor(e){this.name=tE.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,r=t.bufferViews[e];if(!r.extensions||!r.extensions[this.name])return null;{let e=r.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),n=this.parser.options.meshoptDecoder;if(!n||!n.supported){if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}return i.then(function(t){let r=e.byteOffset||0,i=e.byteLength||0,a=e.count,s=e.byteStride,o=new Uint8Array(t,r,i);return n.decodeGltfBufferAsync?n.decodeGltfBufferAsync(a,s,o,e.mode,e.filter).then(function(e){return e.buffer}):n.ready.then(function(){let t=new ArrayBuffer(a*s);return n.decodeGltfBuffer(new Uint8Array(t),a,s,o,e.mode,e.filter),t})})}}}class tB{constructor(e){this.name=tE.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,r=t.nodes[e];if(!r.extensions||!r.extensions[this.name]||void 0===r.mesh)return null;for(let e of t.meshes[r.mesh].primitives)if(e.mode!==tq.TRIANGLES&&e.mode!==tq.TRIANGLE_STRIP&&e.mode!==tq.TRIANGLE_FAN&&void 0!==e.mode)return null;let i=r.extensions[this.name].attributes,n=[],a={};for(let e in i)n.push(this.parser.getDependency("accessor",i[e]).then(t=>(a[e]=t,a[e])));return n.length<1?null:(n.push(this.parser.createNodeMesh(e)),Promise.all(n).then(e=>{let t=e.pop(),r=t.isGroup?t.children:[t],i=e[0].count,n=[];for(let e of r){let t=new Matrix4,r=new Vector3,s=new Quaternion,o=new Vector3(1,1,1),l=new InstancedMesh(e.geometry,e.material,i);for(let e=0;e<i;e++)a.TRANSLATION&&r.fromBufferAttribute(a.TRANSLATION,e),a.ROTATION&&s.fromBufferAttribute(a.ROTATION,e),a.SCALE&&o.fromBufferAttribute(a.SCALE,e),l.setMatrixAt(e,t.compose(r,s,o));for(let t in a)"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,a[t]);Object3D.prototype.copy.call(l,e),this.parser.assignFinalMaterial(l),n.push(l)}return t.isGroup?(t.clear(),t.add(...n),t):n[0]}))}}let tV="glTF",tG={JSON:1313821514,BIN:5130562};class tz{constructor(e){this.name=tE.KHR_BINARY_GLTF,this.content=null,this.body=null;let t=new DataView(e,0,12);if(this.header={magic:LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==tV)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");let r=this.header.length-12,i=new DataView(e,12),n=0;for(;n<r;){let t=i.getUint32(n,!0);n+=4;let r=i.getUint32(n,!0);if(n+=4,r===tG.JSON){let r=new Uint8Array(e,12+n,t);this.content=LoaderUtils.decodeText(r)}else if(r===tG.BIN){let r=12+n;this.body=e.slice(r,r+t)}n+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}}class tj{constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=tE.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let r=this.json,i=this.dracoLoader,n=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,s={},o={},l={};for(let e in a)s[t0[e]||e.toLowerCase()]=a[e];for(let t in e.attributes){let i=t0[t]||t.toLowerCase();if(void 0!==a[t]){let n=r.accessors[e.attributes[t]],a=tZ[n.componentType];l[i]=a.name,o[i]=!0===n.normalized}}return t.getDependency("bufferView",n).then(function(e){return new Promise(function(t){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let r=e.attributes[t],i=o[t];void 0!==i&&(r.normalized=i)}t(e)},s,l)})})}}class tH{constructor(){this.name=tE.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class tW{constructor(){this.name=tE.KHR_MESH_QUANTIZATION}}class tK extends null{constructor(e,t,r,i){super(e,t,r,i)}copySampleValue_(e){let t=this.resultBuffer,r=this.sampleValues,i=this.valueSize,n=e*i*3+i;for(let e=0;e!==i;e++)t[e]=r[n+e];return t}interpolate_(e,t,r,i){let n=this.resultBuffer,a=this.sampleValues,s=this.valueSize,o=2*s,l=3*s,c=i-t,u=(r-t)/c,h=u*u,p=h*u,d=e*l,f=d-l,m=-2*p+3*h,g=p-h,v=1-m,y=g-h+u;for(let e=0;e!==s;e++){let t=a[f+e+s],r=a[f+e+o]*c,i=a[d+e+s],l=a[d+e]*c;n[e]=v*t+y*r+m*i+g*l}return n}}let tX=new f.Quaternion;class tY extends null{interpolate_(e,t,r,i){let n=super.interpolate_(e,t,r,i);return tX.fromArray(n).normalize().toArray(n),n}}let tq={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},tZ={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},t$={9728:f.NearestFilter,9729:f.LinearFilter,9984:f.NearestMipmapNearestFilter,9985:f.LinearMipmapNearestFilter,9986:f.NearestMipmapLinearFilter,9987:f.LinearMipmapLinearFilter},tQ={33071:f.ClampToEdgeWrapping,33648:f.MirroredRepeatWrapping,10497:f.RepeatWrapping},tJ={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},t0={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...ev>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},t1={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},t2={CUBICSPLINE:void 0,LINEAR:f.InterpolateLinear,STEP:f.InterpolateDiscrete},t3={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function t4(e,t,r){for(let i in r.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=r.extensions[i])}function t5(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function t6(e){let t="",r=Object.keys(e).sort();for(let i=0,n=r.length;i<n;i++)t+=r[i]+":"+e[r[i]]+";";return t}function t8(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}let t9=new f.Matrix4;class t7{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new tS,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,i=!1,n=-1;"undefined"!=typeof navigator&&void 0!==navigator.userAgent&&(r=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),n=(i=navigator.userAgent.indexOf("Firefox")>-1)?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||r||i&&n<98?this.textureLoader=new TextureLoader(this.options.manager):this.textureLoader=new ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let r=this,i=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])}).then(function(t){let a={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:r,userData:{}};t4(n,a,i),t5(a,i),Promise.all(r._invokeAll(function(e){return e.afterRoot&&e.afterRoot(a)})).then(function(){e(a)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[];for(let r=0,i=t.length;r<i;r++){let i=t[r].joints;for(let t=0,r=i.length;t<r;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){let i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(r[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,r){if(e.refs[t]<=1)return r;let i=r.clone(),n=(e,t)=>{let r=this.associations.get(e);for(let[i,a]of(null!=r&&this.associations.set(t,r),e.children.entries()))n(a,t.children[i])};return n(r,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let r=0;r<t.length;r++){let i=e(t[r]);if(i)return i}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let r=[];for(let i=0;i<t.length;i++){let n=e(t[i]);n&&r.push(n)}return r}getDependency(e,t){let r=e+":"+t,i=this.cache.get(r);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":i=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(!(i=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(r,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){let r=this;t=Promise.all((this.json[e+("mesh"===e?"es":"s")]||[]).map(function(t,i){return r.getDependency(e,i)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],r=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[tE.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,n){r.load(LoaderUtils.resolveURL(t.uri,i.path),e,void 0,function(){n(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let r=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+r)})}loadAccessor(e){let t=this,r=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=tJ[i.type],t=tZ[i.componentType],r=!0===i.normalized,n=new t(i.count*e);return Promise.resolve(new BufferAttribute(n,e,r))}let n=[];return void 0!==i.bufferView?n.push(this.getDependency("bufferView",i.bufferView)):n.push(null),void 0!==i.sparse&&(n.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(n).then(function(e){let n,a;let s=e[0],o=tJ[i.type],l=tZ[i.componentType],c=l.BYTES_PER_ELEMENT,u=c*o,h=i.byteOffset||0,p=void 0!==i.bufferView?r.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(p&&p!==u){let e=Math.floor(h/p),r="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,u=t.cache.get(r);u||(n=new l(s,e*p,i.count*p/c),u=new InterleavedBuffer(n,p/c),t.cache.add(r,u)),a=new InterleavedBufferAttribute(u,o,h%p/c,d)}else n=null===s?new l(i.count*o):new l(s,h,i.count*o),a=new BufferAttribute(n,o,d);if(void 0!==i.sparse){let t=tJ.SCALAR,r=tZ[i.sparse.indices.componentType],n=i.sparse.indices.byteOffset||0,c=i.sparse.values.byteOffset||0,u=new r(e[1],n,i.sparse.count*t),h=new l(e[2],c,i.sparse.count*o);null!==s&&(a=new BufferAttribute(a.array.slice(),a.itemSize,a.normalized));for(let e=0,t=u.length;e<t;e++){let t=u[e];if(a.setX(t,h[e*o]),o>=2&&a.setY(t,h[e*o+1]),o>=3&&a.setZ(t,h[e*o+2]),o>=4&&a.setW(t,h[e*o+3]),o>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return a})}loadTexture(e){let t=this.json,r=this.options,i=t.textures[e].source,n=t.images[i],a=this.textureLoader;if(n.uri){let e=r.manager.getHandler(n.uri);null!==e&&(a=e)}return this.loadTextureImage(e,i,a)}loadTextureImage(e,t,r){let i=this,n=this.json,a=n.textures[e],s=n.images[t],o=(s.uri||s.bufferView)+":"+a.sampler;if(this.textureCache[o])return this.textureCache[o];let l=this.loadImageSource(t,r).then(function(t){t.flipY=!1,t.name=a.name||s.name||"",""===t.name&&"string"==typeof s.uri&&!1===s.uri.startsWith("data:image/")&&(t.name=s.uri);let r=(n.samplers||{})[a.sampler]||{};return t.magFilter=t$[r.magFilter]||LinearFilter,t.minFilter=t$[r.minFilter]||LinearMipmapLinearFilter,t.wrapS=tQ[r.wrapS]||RepeatWrapping,t.wrapT=tQ[r.wrapT]||RepeatWrapping,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[o]=l,l}loadImageSource(e,t){let r=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let n=r.images[e],a=self.URL||self.webkitURL,s=n.uri||"",o=!1;if(void 0!==n.bufferView)s=this.getDependency("bufferView",n.bufferView).then(function(e){o=!0;let t=new Blob([e],{type:n.mimeType});return s=a.createObjectURL(t)});else if(void 0===n.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let l=Promise.resolve(s).then(function(e){return new Promise(function(r,n){let a=r;!0===t.isImageBitmapLoader&&(a=function(e){let t=new Texture(e);t.needsUpdate=!0,r(t)}),t.load(LoaderUtils.resolveURL(e,i.path),a,void 0,n)})}).then(function(e){var t;return!0===o&&a.revokeObjectURL(s),e.userData.mimeType=n.mimeType||((t=n.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",s),e});return this.sourceCache[e]=l,l}assignTexture(e,t,r,i){let n=this;return this.getDependency("texture",r.index).then(function(a){if(!a)return null;if(void 0!==r.texCoord&&r.texCoord>0&&((a=a.clone()).channel=r.texCoord),n.extensions[tE.KHR_TEXTURE_TRANSFORM]){let e=void 0!==r.extensions?r.extensions[tE.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=n.associations.get(a);a=n.extensions[tE.KHR_TEXTURE_TRANSFORM].extendTexture(a,e),n.associations.set(a,t)}}return void 0!==i&&("colorSpace"in a?a.colorSpace=3001===i?"srgb":"srgb-linear":a.encoding=i),e[t]=a,a})}assignFinalMaterial(e){let t=e.geometry,r=e.material,i=void 0===t.attributes.tangent,n=void 0!==t.attributes.color,a=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+r.uuid,t=this.cache.get(e);t||(t=new PointsMaterial,Material.prototype.copy.call(t,r),t.color.copy(r.color),t.map=r.map,t.sizeAttenuation=!1,this.cache.add(e,t)),r=t}else if(e.isLine){let e="LineBasicMaterial:"+r.uuid,t=this.cache.get(e);t||(t=new LineBasicMaterial,Material.prototype.copy.call(t,r),t.color.copy(r.color),t.map=r.map,this.cache.add(e,t)),r=t}if(i||n||a){let e="ClonedMaterial:"+r.uuid+":";i&&(e+="derivative-tangents:"),n&&(e+="vertex-colors:"),a&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=r.clone(),n&&(t.vertexColors=!0),a&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(r))),r=t}e.material=r}getMaterialType(){return MeshStandardMaterial}loadMaterial(e){let t;let r=this,i=this.json,n=this.extensions,a=i.materials[e],s={},o=a.extensions||{},l=[];if(o[tE.KHR_MATERIALS_UNLIT]){let e=n[tE.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),l.push(e.extendParams(s,a,r))}else{let i=a.pbrMetallicRoughness||{};if(s.color=new Color(1,1,1),s.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;s.color.fromArray(e),s.opacity=e[3]}void 0!==i.baseColorTexture&&l.push(r.assignTexture(s,"map",i.baseColorTexture,3001)),s.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,s.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(l.push(r.assignTexture(s,"metalnessMap",i.metallicRoughnessTexture)),l.push(r.assignTexture(s,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,s)})))}!0===a.doubleSided&&(s.side=DoubleSide);let c=a.alphaMode||t3.OPAQUE;if(c===t3.BLEND?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,c===t3.MASK&&(s.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&t!==MeshBasicMaterial&&(l.push(r.assignTexture(s,"normalMap",a.normalTexture)),s.normalScale=new Vector2(1,1),void 0!==a.normalTexture.scale)){let e=a.normalTexture.scale;s.normalScale.set(e,e)}return void 0!==a.occlusionTexture&&t!==MeshBasicMaterial&&(l.push(r.assignTexture(s,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(s.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&t!==MeshBasicMaterial&&(s.emissive=new Color().fromArray(a.emissiveFactor)),void 0!==a.emissiveTexture&&t!==MeshBasicMaterial&&l.push(r.assignTexture(s,"emissiveMap",a.emissiveTexture,3001)),Promise.all(l).then(function(){let i=new t(s);return a.name&&(i.name=a.name),t5(i,a),r.associations.set(i,{materials:e}),a.extensions&&t4(n,i,a),i})}createUniqueName(e){let t=PropertyBinding.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,r=this.extensions,i=this.primitiveCache,n=[];for(let a=0,s=e.length;a<s;a++){let s=e[a],o=function(e){let t;let r=e.extensions&&e.extensions[tE.KHR_DRACO_MESH_COMPRESSION];if(t=r?"draco:"+r.bufferView+":"+r.indices+":"+t6(r.attributes):e.indices+":"+t6(e.attributes)+":"+e.mode,void 0!==e.targets)for(let r=0,i=e.targets.length;r<i;r++)t+=":"+t6(e.targets[r]);return t}(s),l=i[o];if(l)n.push(l.promise);else{let e;e=s.extensions&&s.extensions[tE.KHR_DRACO_MESH_COMPRESSION]?function(e){return r[tE.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(r){return re(r,e,t)})}(s):re(new BufferGeometry,s,t),i[o]={primitive:s,promise:e},n.push(e)}}return Promise.all(n)}loadMesh(e){let t=this,r=this.json,i=this.extensions,n=r.meshes[e],a=n.primitives,s=[];for(let e=0,t=a.length;e<t;e++){var o;let t=void 0===a[e].material?(void 0===(o=this.cache).DefaultMaterial&&(o.DefaultMaterial=new MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:FrontSide})),o.DefaultMaterial):this.getDependency("material",a[e].material);s.push(t)}return s.push(t.loadGeometries(a)),Promise.all(s).then(function(r){let s=r.slice(0,r.length-1),o=r[r.length-1],l=[];for(let r=0,c=o.length;r<c;r++){let c;let u=o[r],h=a[r],p=s[r];if(h.mode===tq.TRIANGLES||h.mode===tq.TRIANGLE_STRIP||h.mode===tq.TRIANGLE_FAN||void 0===h.mode)!0===(c=!0===n.isSkinnedMesh?new SkinnedMesh(u,p):new Mesh(u,p)).isSkinnedMesh&&c.normalizeSkinWeights(),h.mode===tq.TRIANGLE_STRIP?c.geometry=_(c.geometry,TriangleStripDrawMode):h.mode===tq.TRIANGLE_FAN&&(c.geometry=_(c.geometry,TriangleFanDrawMode));else if(h.mode===tq.LINES)c=new LineSegments(u,p);else if(h.mode===tq.LINE_STRIP)c=new Line(u,p);else if(h.mode===tq.LINE_LOOP)c=new LineLoop(u,p);else if(h.mode===tq.POINTS)c=new Points(u,p);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);Object.keys(c.geometry.morphAttributes).length>0&&function(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let r=0,i=t.weights.length;r<i;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){let r=t.extras.targetNames;if(e.morphTargetInfluences.length===r.length){e.morphTargetDictionary={};for(let t=0,i=r.length;t<i;t++)e.morphTargetDictionary[r[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}(c,n),c.name=t.createUniqueName(n.name||"mesh_"+e),t5(c,n),h.extensions&&t4(i,c,h),t.assignFinalMaterial(c),l.push(c)}for(let r=0,i=l.length;r<i;r++)t.associations.set(l[r],{meshes:e,primitives:r});if(1===l.length)return n.extensions&&t4(i,l[0],n),l[0];let c=new Group;n.extensions&&t4(i,c,n),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c})}loadCamera(e){let t;let r=this.json.cameras[e],i=r[r.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return"perspective"===r.type?t=new PerspectiveCamera(MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===r.type&&(t=new OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),t5(t,r),Promise.resolve(t)}loadSkin(e){let t=this.json.skins[e],r=[];for(let e=0,i=t.joints.length;e<i;e++)r.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?r.push(this.getDependency("accessor",t.inverseBindMatrices)):r.push(null),Promise.all(r).then(function(e){let r=e.pop(),i=[],n=[];for(let a=0,s=e.length;a<s;a++){let s=e[a];if(s){i.push(s);let e=new Matrix4;null!==r&&e.fromArray(r.array,16*a),n.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[a])}return new Skeleton(i,n)})}loadAnimation(e){let t=this.json.animations[e],r=t.name?t.name:"animation_"+e,i=[],n=[],a=[],s=[],o=[];for(let e=0,r=t.channels.length;e<r;e++){let r=t.channels[e],l=t.samplers[r.sampler],c=r.target,u=c.node,h=void 0!==t.parameters?t.parameters[l.input]:l.input,p=void 0!==t.parameters?t.parameters[l.output]:l.output;void 0!==c.node&&(i.push(this.getDependency("node",u)),n.push(this.getDependency("accessor",h)),a.push(this.getDependency("accessor",p)),s.push(l),o.push(c))}return Promise.all([Promise.all(i),Promise.all(n),Promise.all(a),Promise.all(s),Promise.all(o)]).then(function(e){let t=e[0],i=e[1],n=e[2],a=e[3],s=e[4],o=[];for(let e=0,r=t.length;e<r;e++){let r;let l=t[e],c=i[e],u=n[e],h=a[e],p=s[e];if(void 0===l)continue;switch(l.updateMatrix(),t1[p.path]){case t1.weights:r=NumberKeyframeTrack;break;case t1.rotation:r=QuaternionKeyframeTrack;break;case t1.position:case t1.scale:default:r=VectorKeyframeTrack}let d=l.name?l.name:l.uuid,f=void 0!==h.interpolation?t2[h.interpolation]:InterpolateLinear,m=[];t1[p.path]===t1.weights?l.traverse(function(e){e.morphTargetInfluences&&m.push(e.name?e.name:e.uuid)}):m.push(d);let g=u.array;if(u.normalized){let e=t8(g.constructor),t=new Float32Array(g.length);for(let r=0,i=g.length;r<i;r++)t[r]=g[r]*e;g=t}for(let e=0,t=m.length;e<t;e++){let t=new r(m[e]+"."+t1[p.path],c.array,g,f);"CUBICSPLINE"===h.interpolation&&(t.createInterpolant=function(e){return new(this instanceof QuaternionKeyframeTrack?tY:tK)(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),o.push(t)}}return new AnimationClip(r,void 0,o)})}createNodeMesh(e){let t=this.json,r=this,i=t.nodes[e];return void 0===i.mesh?null:r.getDependency("mesh",i.mesh).then(function(e){let t=r._getNodeRef(r.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,r=i.weights.length;t<r;t++)e.morphTargetInfluences[t]=i.weights[t]}),t})}loadNode(e){let t=this.json.nodes[e],r=this._loadNodeShallow(e),i=[],n=t.children||[];for(let e=0,t=n.length;e<t;e++)i.push(this.getDependency("node",n[e]));let a=void 0===t.skin?Promise.resolve(null):this.getDependency("skin",t.skin);return Promise.all([r,Promise.all(i),a]).then(function(e){let t=e[0],r=e[1],i=e[2];null!==i&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(i,t9)});for(let e=0,i=r.length;e<i;e++)t.add(r[e]);return t})}_loadNodeShallow(e){let t=this.json,r=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let n=t.nodes[e],a=n.name?i.createUniqueName(n.name):"",s=[],o=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return o&&s.push(o),void 0!==n.camera&&s.push(i.getDependency("camera",n.camera).then(function(e){return i._getNodeRef(i.cameraCache,n.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){s.push(e)}),this.nodeCache[e]=Promise.all(s).then(function(t){let s;if((s=!0===n.isBone?new Bone:t.length>1?new Group:1===t.length?t[0]:new Object3D)!==t[0])for(let e=0,r=t.length;e<r;e++)s.add(t[e]);if(n.name&&(s.userData.name=n.name,s.name=a),t5(s,n),n.extensions&&t4(r,s,n),void 0!==n.matrix){let e=new Matrix4;e.fromArray(n.matrix),s.applyMatrix4(e)}else void 0!==n.translation&&s.position.fromArray(n.translation),void 0!==n.rotation&&s.quaternion.fromArray(n.rotation),void 0!==n.scale&&s.scale.fromArray(n.scale);return i.associations.has(s)||i.associations.set(s,{}),i.associations.get(s).nodes=e,s}),this.nodeCache[e]}loadScene(e){let t=this.extensions,r=this.json.scenes[e],i=this,n=new Group;r.name&&(n.name=i.createUniqueName(r.name)),t5(n,r),r.extensions&&t4(t,n,r);let a=r.nodes||[],s=[];for(let e=0,t=a.length;e<t;e++)s.push(i.getDependency("node",a[e]));return Promise.all(s).then(function(e){for(let t=0,r=e.length;t<r;t++)n.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,r]of i.associations)(e instanceof Material||e instanceof Texture)&&t.set(e,r);return e.traverse(e=>{let r=i.associations.get(e);null!=r&&t.set(e,r)}),t})(n),n})}}function re(e,t,r){let i=t.attributes,n=[];for(let t in i){let a=t0[t]||t.toLowerCase();a in e.attributes||n.push(function(t,i){return r.getDependency("accessor",t).then(function(t){e.setAttribute(i,t)})}(i[t],a))}if(void 0!==t.indices&&!e.index){let i=r.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});n.push(i)}return t5(e,t),!function(e,t,r){let i=t.attributes,n=new Box3;if(void 0===i.POSITION)return;{let e=r.json.accessors[i.POSITION],t=e.min,a=e.max;if(void 0!==t&&void 0!==a){if(n.set(new Vector3(t[0],t[1],t[2]),new Vector3(a[0],a[1],a[2])),e.normalized){let t=t8(tZ[e.componentType]);n.min.multiplyScalar(t),n.max.multiplyScalar(t)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}let a=t.targets;if(void 0!==a){let e=new Vector3,t=new Vector3;for(let i=0,n=a.length;i<n;i++){let n=a[i];if(void 0!==n.POSITION){let i=r.json.accessors[n.POSITION],a=i.min,s=i.max;if(void 0!==a&&void 0!==s){if(t.setX(Math.max(Math.abs(a[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(a[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(a[2]),Math.abs(s[2]))),i.normalized){let e=t8(tZ[i.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}n.expandByVector(e)}e.boundingBox=n;let s=new Sphere;n.getCenter(s.center),s.radius=n.min.distanceTo(n.max)/2,e.boundingSphere=s}(e,t,r),Promise.all(n).then(function(){return void 0!==t.targets?function(e,t,r){let i=!1,n=!1,a=!1;for(let e=0,r=t.length;e<r;e++){let r=t[e];if(void 0!==r.POSITION&&(i=!0),void 0!==r.NORMAL&&(n=!0),void 0!==r.COLOR_0&&(a=!0),i&&n&&a)break}if(!i&&!n&&!a)return Promise.resolve(e);let s=[],o=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(i){let t=void 0!==u.POSITION?r.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(n){let t=void 0!==u.NORMAL?r.getDependency("accessor",u.NORMAL):e.attributes.normal;o.push(t)}if(a){let t=void 0!==u.COLOR_0?r.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(o),Promise.all(l)]).then(function(t){let r=t[0],s=t[1],o=t[2];return i&&(e.morphAttributes.position=r),n&&(e.morphAttributes.normal=s),a&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e})}(e,t.targets,r):e})}f.Object3D;let rt=class{static createButton(e,t={}){let r=document.createElement("button");function i(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return i(r),r.id="VRButton",r.style.display="none",navigator.xr.isSessionSupported("immersive-vr").then(i=>{i?function(){let i=null;async function n(t){t.addEventListener("end",a),await e.xr.setSession(t),r.textContent="EXIT VR",i=t}function a(){i.removeEventListener("end",a),r.textContent="ENTER VR",i=null}r.style.display="",r.style.cursor="pointer",r.style.left="calc(50% - 50px)",r.style.width="100px",r.textContent="ENTER VR",r.onmouseenter=()=>{r.style.opacity="1.0"},r.onmouseleave=()=>{r.style.opacity="0.5"},r.onclick=()=>{var e;if(null===i){let r=[t.optionalFeatures,"local-floor","bounded-floor","hand-tracking"].flat().filter(Boolean);null==(e=navigator.xr)||e.requestSession("immersive-vr",{...t,optionalFeatures:r}).then(n)}else i.end()}}():(r.style.display="",r.style.cursor="auto",r.style.left="calc(50% - 75px)",r.style.width="150px",r.onmouseenter=null,r.onmouseleave=null,r.onclick=null,r.textContent="VR NOT SUPPORTED"),i&&rt.xrSessionIsGranted&&r.click()}),r;{let e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",i(e),e}}static registerSessionGrantedListener(){"undefined"!=typeof navigator&&"xr"in navigator&&navigator.xr.addEventListener("sessiongranted",()=>{rt.xrSessionIsGranted=!0})}};x(rt,"xrSessionIsGranted",!1),rt.registerSessionGrantedListener();let rr={ComponentState:{DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"},ComponentProperty:{BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"},ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:{TRANSFORM:"transform",VISIBILITY:"visibility"}};async function ri(e){let t=await fetch(e);if(t.ok)return t.json();throw Error(t.statusText)}let rn={xAxis:0,yAxis:0,button:0,state:rr.ComponentState.DEFAULT};class ra{constructor(e){x(this,"value"),x(this,"componentProperty"),x(this,"states"),x(this,"valueNodeName"),x(this,"valueNodeProperty"),x(this,"minNodeName"),x(this,"maxNodeName"),x(this,"valueNode"),x(this,"minNode"),x(this,"maxNode"),this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===rr.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(rn)}updateFromComponent({xAxis:e,yAxis:t,button:r,state:i}){let{normalizedXAxis:n,normalizedYAxis:a}=function(e=0,t=0){let r=e,i=t;if(Math.sqrt(e*e+t*t)>1){let n=Math.atan2(t,e);r=Math.cos(n),i=Math.sin(n)}return{normalizedXAxis:.5*r+.5,normalizedYAxis:.5*i+.5}}(e,t);switch(this.componentProperty){case rr.ComponentProperty.X_AXIS:this.value=this.states.includes(i)?n:.5;break;case rr.ComponentProperty.Y_AXIS:this.value=this.states.includes(i)?a:.5;break;case rr.ComponentProperty.BUTTON:this.value=this.states.includes(i)&&r?r:0;break;case rr.ComponentProperty.STATE:this.valueNodeProperty===rr.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(i):this.value=this.states.includes(i)?1:0;break;default:throw Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}f.BufferGeometry;let rs=new f.Matrix4;class ro{constructor(e){e=e||{},this.vertices={near:[new f.Vector3,new f.Vector3,new f.Vector3,new f.Vector3],far:[new f.Vector3,new f.Vector3,new f.Vector3,new f.Vector3]},void 0!==e.projectionMatrix&&this.setFromProjectionMatrix(e.projectionMatrix,e.maxFar||1e4)}setFromProjectionMatrix(e,t){let r=0===e.elements[11];return rs.copy(e).invert(),this.vertices.near[0].set(1,1,-1),this.vertices.near[1].set(1,-1,-1),this.vertices.near[2].set(-1,-1,-1),this.vertices.near[3].set(-1,1,-1),this.vertices.near.forEach(function(e){e.applyMatrix4(rs)}),this.vertices.far[0].set(1,1,1),this.vertices.far[1].set(1,-1,1),this.vertices.far[2].set(-1,-1,1),this.vertices.far[3].set(-1,1,1),this.vertices.far.forEach(function(e){e.applyMatrix4(rs);let i=Math.abs(e.z);r?e.z*=Math.min(t/i,1):e.multiplyScalar(Math.min(t/i,1))}),this.vertices}split(e,t){for(;e.length>t.length;)t.push(new ro);t.length=e.length;for(let r=0;r<e.length;r++){let i=t[r];if(0===r)for(let e=0;e<4;e++)i.vertices.near[e].copy(this.vertices.near[e]);else for(let t=0;t<4;t++)i.vertices.near[t].lerpVectors(this.vertices.near[t],this.vertices.far[t],e[r-1]);if(r===e.length-1)for(let e=0;e<4;e++)i.vertices.far[e].copy(this.vertices.far[e]);else for(let t=0;t<4;t++)i.vertices.far[t].lerpVectors(this.vertices.near[t],this.vertices.far[t],e[r])}}toSpace(e,t){for(let r=0;r<4;r++)t.vertices.near[r].copy(this.vertices.near[r]).applyMatrix4(e),t.vertices.far[r].copy(this.vertices.far[r]).applyMatrix4(e)}}let rl=new WeakMap;function rc(e,t,r){let i=r.length-e-1;if(t>=r[i])return i-1;if(t<=r[e])return e;let n=e,a=i,s=Math.floor((n+a)/2);for(;t<r[s]||t>=r[s+1];)t<r[s]?a=s:n=s,s=Math.floor((n+a)/2);return s}class ru extends null{constructor(e,t,r,i,n){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=i||0,this.endKnot=n||this.knots.length-1;for(let e=0;e<r.length;++e){let t=r[e];this.controlPoints[e]=new Vector4(t.x,t.y,t.z,t.w)}}getPoint(e,t){let r=t||new Vector3,i=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),n=function(e,t,r,i){let n=rc(e,i,t),a=function(e,t,r,i){let n=[],a=[],s=[];n[0]=1;for(let o=1;o<=r;++o){a[o]=t-i[e+1-o],s[o]=i[e+o]-t;let r=0;for(let e=0;e<o;++e){let t=s[e+1],i=a[o-e],l=n[e]/(t+i);n[e]=r+t*l,r=i*l}n[o]=r}return n}(n,i,e,t),s=new Vector4(0,0,0,0);for(let t=0;t<=e;++t){let i=r[n-e+t],o=a[t],l=i.w*o;s.x+=i.x*l,s.y+=i.y*l,s.z+=i.z*l,s.w+=i.w*o}return s}(this.degree,this.knots,this.controlPoints,i);return 1!=n.w&&n.divideScalar(n.w),r.set(n.x,n.y,n.z)}getTangent(e,t){var r;let i=t||new Vector3,n=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),a=(r=this.degree,function(e){let t=e.length,r=[],i=[];for(let n=0;n<t;++n){let t=e[n];r[n]=new Vector3(t.x,t.y,t.z),i[n]=t.w}let n=[];for(let e=0;e<t;++e){let t=r[e].clone();for(let r=1;r<=e;++r)t.sub(n[e-r].clone().multiplyScalar(function(e,t){let r=1;for(let t=2;t<=e;++t)r*=t;let i=1;for(let e=2;e<=t;++e)i*=e;for(let r=2;r<=e-t;++r)i*=r;return r/i}(e,r)*i[r]));n[e]=t.divideScalar(i[0])}return n}(function(e,t,r,i,n){let a=n<e?n:e,s=[],o=rc(e,i,t),l=function(e,t,r,i,n){let a=[];for(let e=0;e<=r;++e)a[e]=0;let s=[];for(let e=0;e<=i;++e)s[e]=a.slice(0);let o=[];for(let e=0;e<=r;++e)o[e]=a.slice(0);o[0][0]=1;let l=a.slice(0),c=a.slice(0);for(let i=1;i<=r;++i){l[i]=t-n[e+1-i],c[i]=n[e+i]-t;let r=0;for(let e=0;e<i;++e){let t=c[e+1],n=l[i-e];o[i][e]=t+n;let a=o[e][i-1]/o[i][e];o[e][i]=r+t*a,r=n*a}o[i][i]=r}for(let e=0;e<=r;++e)s[0][e]=o[e][r];for(let e=0;e<=r;++e){let t=0,n=1,l=[];for(let e=0;e<=r;++e)l[e]=a.slice(0);l[0][0]=1;for(let a=1;a<=i;++a){let i=0,c=e-a,u=r-a;e>=a&&(l[n][0]=l[t][0]/o[u+1][c],i=l[n][0]*o[c][u]);let h=c>=-1?1:-c,p=e-1<=u?a-1:r-e;for(let e=h;e<=p;++e)l[n][e]=(l[t][e]-l[t][e-1])/o[u+1][c+e],i+=l[n][e]*o[c+e][u];e<=u&&(l[n][a]=-l[t][a-1]/o[u+1][e],i+=l[n][a]*o[e][u]),s[a][e]=i;let d=t;t=n,n=d}}let u=r;for(let e=1;e<=i;++e){for(let t=0;t<=r;++t)s[e][t]*=u;u*=r-e}return s}(o,i,e,a,t),c=[];for(let e=0;e<r.length;++e){let t=r[e].clone(),i=t.w;t.x*=i,t.y*=i,t.z*=i,c[e]=t}for(let t=0;t<=a;++t){let r=c[o-e].clone().multiplyScalar(l[t][0]);for(let i=1;i<=e;++i)r.add(c[o-e+i].clone().multiplyScalar(l[t][i]));s[t]=r}for(let e=a+1;e<=n+1;++e)s[e]=new Vector4(0,0,0);return s}(r,this.knots,this.controlPoints,n,1)));return i.copy(a[1]).normalize(),i}}function rh(e){return e/46186158e3}function rp(e,t,r,i){let n;switch(i.mappingType){case"ByPolygonVertex":n=e;break;case"ByPolygon":n=t;break;case"ByVertice":n=r;break;case"AllSame":n=i.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+i.mappingType)}"IndexToDirect"===i.referenceType&&(n=i.indices[n]);let a=n*i.dataSize,s=a+i.dataSize;return function(e,t,r,i){for(let n=r,a=0;n<i;n++,a++)e[a]=t[n];return e}(null,i.buffer,a,s)}let rd=new f.Euler,rf=new f.Vector3;function rm(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}class rg{constructor(e){x(this,"data"),this.data=e}generateShapes(e,t=100,r){let i=[],n={letterSpacing:0,lineHeight:1,...r},a=function(e,t,r,i){let n=Array.from(e),a=t/r.resolution,s=(r.boundingBox.yMax-r.boundingBox.yMin+r.underlineThickness)*a,o=[],l=0,c=0;for(let e=0;e<n.length;e++){let t=n[e];if("\n"===t)l=0,c-=s*i.lineHeight;else{let e=function(e,t,r,i,n){let a,s,o,l,c,u,h,p;let d=n.glyphs[e]||n.glyphs["?"];if(!d){console.error('THREE.Font: character "'+e+'" does not exists in font family '+n.familyName+".");return}let m=new f.ShapePath;if(d.o){let e=d._cachedOutline||(d._cachedOutline=d.o.split(" "));for(let n=0,d=e.length;n<d;)switch(e[n++]){case"m":a=parseInt(e[n++])*t+r,s=parseInt(e[n++])*t+i,m.moveTo(a,s);break;case"l":a=parseInt(e[n++])*t+r,s=parseInt(e[n++])*t+i,m.lineTo(a,s);break;case"q":o=parseInt(e[n++])*t+r,l=parseInt(e[n++])*t+i,c=parseInt(e[n++])*t+r,u=parseInt(e[n++])*t+i,m.quadraticCurveTo(c,u,o,l);break;case"b":o=parseInt(e[n++])*t+r,l=parseInt(e[n++])*t+i,c=parseInt(e[n++])*t+r,u=parseInt(e[n++])*t+i,h=parseInt(e[n++])*t+r,p=parseInt(e[n++])*t+i,m.bezierCurveTo(c,u,h,p,o,l)}}return{offsetX:d.ha*t,path:m}}(t,a,l,c,r);e&&(l+=e.offsetX+i.letterSpacing,o.push(e.path))}}return o}(e,t,this.data,n);for(let e=0,t=a.length;e<t;e++)Array.prototype.push.apply(i,a[e].toShapes(!1));return i}}x(rg,"isFont"),x(rg,"type");class rv extends null{constructor(e){super(e)}parse(e){e.length<19&&console.error("THREE.TGALoader: Not enough data to contain header.");let t=0,r=new Uint8Array(e),i={id_length:r[t++],colormap_type:r[t++],image_type:r[t++],colormap_index:r[t++]|r[t++]<<8,colormap_length:r[t++]|r[t++]<<8,colormap_size:r[t++],origin:[r[t++]|r[t++]<<8,r[t++]|r[t++]<<8],width:r[t++]|r[t++]<<8,height:r[t++]|r[t++]<<8,pixel_size:r[t++],flags:r[t++]};!function(e){switch(e.image_type){case 1:case 9:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case 2:case 3:case 10:case 11:e.colormap_type&&console.error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case 0:console.error("THREE.TGALoader: No data.");default:console.error('THREE.TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader: Invalid image size."),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader: Invalid pixel size "%s".',e.pixel_size)}(i),i.id_length+t>e.length&&console.error("THREE.TGALoader: No data."),t+=i.id_length;let n=!1,a=!1,s=!1;switch(i.image_type){case 9:n=!0,a=!0;break;case 1:a=!0;break;case 10:n=!0;break;case 2:break;case 11:n=!0,s=!0;break;case 3:s=!0}let o=new Uint8Array(i.width*i.height*4),l=function(e,t,r,i,n){let a,s;let o=r.pixel_size>>3,l=r.width*r.height*o;if(t&&(s=n.subarray(i,i+=r.colormap_length*(r.colormap_size>>3))),e){let e,t,r;a=new Uint8Array(l);let s=0,c=new Uint8Array(o);for(;s<l;)if(t=(127&(e=n[i++]))+1,128&e){for(r=0;r<o;++r)c[r]=n[i++];for(r=0;r<t;++r)a.set(c,s+r*o);s+=o*t}else{for(t*=o,r=0;r<t;++r)a[s+r]=n[i++];s+=t}}else a=n.subarray(i,i+=t?r.width*r.height:l);return{pixel_data:a,palettes:s}}(n,a,i,t,r);return!function(e,t,r,n,a){let o,l,c,u,h,p;switch((48&i.flags)>>4){default:case 2:o=0,c=1,h=t,l=0,u=1,p=r;break;case 0:o=0,c=1,h=t,l=r-1,u=-1,p=-1;break;case 3:o=t-1,c=-1,h=-1,l=0,u=1,p=r;break;case 1:o=t-1,c=-1,h=-1,l=r-1,u=-1,p=-1}if(s)switch(i.pixel_size){case 8:!function(e,t,r,n,a,s,o,l){let c,u=0,h,p,d=i.width;for(p=t;p!==n;p+=r)for(h=a;h!==o;h+=s,u++)c=l[u],e[(h+d*p)*4+0]=c,e[(h+d*p)*4+1]=c,e[(h+d*p)*4+2]=c,e[(h+d*p)*4+3]=255}(e,l,u,p,o,c,h,n);break;case 16:!function(e,t,r,n,a,s,o,l){let c=0,u,h,p=i.width;for(h=t;h!==n;h+=r)for(u=a;u!==o;u+=s,c+=2)e[(u+p*h)*4+0]=l[c+0],e[(u+p*h)*4+1]=l[c+0],e[(u+p*h)*4+2]=l[c+0],e[(u+p*h)*4+3]=l[c+1]}(e,l,u,p,o,c,h,n);break;default:console.error("THREE.TGALoader: Format not supported.")}else switch(i.pixel_size){case 8:!function(e,t,r,n,a,s,o,l,c){let u,h=0,p,d,f=i.width;for(d=t;d!==n;d+=r)for(p=a;p!==o;p+=s,h++)u=l[h],e[(p+f*d)*4+3]=255,e[(p+f*d)*4+2]=c[3*u+0],e[(p+f*d)*4+1]=c[3*u+1],e[(p+f*d)*4+0]=c[3*u+2]}(e,l,u,p,o,c,h,n,a);break;case 16:!function(e,t,r,n,a,s,o,l){let c,u=0,h,p,d=i.width;for(p=t;p!==n;p+=r)for(h=a;h!==o;h+=s,u+=2)c=l[u+0]+(l[u+1]<<8),e[(h+d*p)*4+0]=(31744&c)>>7,e[(h+d*p)*4+1]=(992&c)>>2,e[(h+d*p)*4+2]=(31&c)>>3,e[(h+d*p)*4+3]=32768&c?0:255}(e,l,u,p,o,c,h,n);break;case 24:!function(e,t,r,n,a,s,o,l){let c=0,u,h,p=i.width;for(h=t;h!==n;h+=r)for(u=a;u!==o;u+=s,c+=3)e[(u+p*h)*4+3]=255,e[(u+p*h)*4+2]=l[c+0],e[(u+p*h)*4+1]=l[c+1],e[(u+p*h)*4+0]=l[c+2]}(e,l,u,p,o,c,h,n);break;case 32:!function(e,t,r,n,a,s,o,l){let c=0,u,h,p=i.width;for(h=t;h!==n;h+=r)for(u=a;u!==o;u+=s,c+=4)e[(u+p*h)*4+2]=l[c+0],e[(u+p*h)*4+1]=l[c+1],e[(u+p*h)*4+0]=l[c+2],e[(u+p*h)*4+3]=l[c+3]}(e,l,u,p,o,c,h,n);break;default:console.error("THREE.TGALoader: Format not supported.")}}(o,i.width,i.height,l.pixel_data,l.palettes),{data:o,width:i.width,height:i.height,flipY:!0,generateMipmaps:!0,minFilter:LinearMipmapLinearFilter}}}class ry extends f.Texture{constructor(e=null,t=1,r=1,i=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:r,depth:i},this.magFilter=f.NearestFilter,this.minFilter=f.NearestFilter,this.wrapR=f.ClampToEdgeWrapping,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}let{CstParser:rx,Lexer:rT,createToken:rb}=(()=>{var e,t,r,i,n,a,s,o,l,c,u,h,p,d,f,m,g,v,y,x="object"==typeof global&&global&&global.Object===Object&&global,T="object"==typeof self&&self&&self.Object===Object&&self,b=x||T||Function("return this")(),S=b.Symbol,E=Object.prototype,R=E.hasOwnProperty,A=E.toString,w=S?S.toStringTag:void 0,M=Object.prototype.toString,C=S?S.toStringTag:void 0;function I(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":C&&C in Object(e)?function(e){var t=R.call(e,w),r=e[w];try{e[w]=void 0;var i=!0}catch(e){}var n=A.call(e);return i&&(t?e[w]=r:delete e[w]),n}(e):M.call(e)}function N(e){return null!=e&&"object"==typeof e}function O(e){return"symbol"==typeof e||N(e)&&"[object Symbol]"==I(e)}function P(e,t){for(var r=-1,i=null==e?0:e.length,n=Array(i);++r<i;)n[r]=t(e[r],r,e);return n}var k=Array.isArray,_=1/0,L=S?S.prototype:void 0,U=L?L.toString:void 0,D=/\s/,F=/^\s+/;function B(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var V=0/0,G=/^[-+]0x[0-9a-f]+$/i,z=/^0b[01]+$/i,j=/^0o[0-7]+$/i,H=parseInt,W=1/0;function K(e){var t,r=(t=e)?(t=function(e){if("number"==typeof e)return e;if(O(e))return V;if(B(e)){var t,r="function"==typeof e.valueOf?e.valueOf():e;e=B(r)?r+"":r}if("string"!=typeof e)return 0===e?e:+e;e=(t=e)?t.slice(0,function(e){for(var t=e.length;t--&&D.test(e.charAt(t)););return t}(t)+1).replace(F,""):t;var i=z.test(e);return i||j.test(e)?H(e.slice(2),i?2:8):G.test(e)?V:+e}(t))===W||t===-W?(t<0?-1:1)*17976931348623157e292:t==t?t:0:0===t?t:0,i=r%1;return r==r?i?r-i:r:0}function X(e){return e}function Y(e){if(!B(e))return!1;var t=I(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}var q=b["__core-js_shared__"],Z=(e=/[^.]+$/.exec(q&&q.keys&&q.keys.IE_PROTO||""))?"Symbol(src)_1."+e:"",$=Function.prototype.toString;function Q(e){if(null!=e){try{return $.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var J=/^\[object .+?Constructor\]$/,ee=Object.prototype,et=Function.prototype.toString,er=ee.hasOwnProperty,ei=RegExp("^"+et.call(er).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function en(e,t){var r=null==e?void 0:e[t];return B(r)&&(!Z||!(Z in r))&&(Y(r)?ei:J).test(Q(r))?r:void 0}var ea=en(b,"WeakMap"),es=Object.create,eo=function(){function e(){}return function(t){if(!B(t))return{};if(es)return es(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}();function el(){}var ec=Date.now,eu=function(){try{var e=en(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),eh=(t=eu?function(e,t){return eu(e,"toString",{configurable:!0,enumerable:!1,value:function(){return t},writable:!0})}:X,r=0,i=0,function(){var e=ec(),n=16-(e-i);if(i=e,n>0){if(++r>=800)return arguments[0]}else r=0;return t.apply(void 0,arguments)});function ep(e,t){for(var r=-1,i=null==e?0:e.length;++r<i&&!1!==t(e[r],r,e););return e}function ed(e,t,r,i){for(var n=e.length,a=r+(i?1:-1);i?a--:++a<n;)if(t(e[a],a,e))return a;return -1}function ef(e){return e!=e}function em(e,t,r){return t==t?function(e,t,r){for(var i=r-1,n=e.length;++i<n;)if(e[i]===t)return i;return -1}(e,t,r):ed(e,ef,r)}function eg(e,t){return!!(null==e?0:e.length)&&em(e,t,0)>-1}var ev=/^(?:0|[1-9]\d*)$/;function ey(e,t){var r=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==r||"symbol"!=r&&ev.test(e))&&e>-1&&e%1==0&&e<t}function ex(e,t,r){"__proto__"==t&&eu?eu(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}function eT(e,t){return e===t||e!=e&&t!=t}var eb=Object.prototype.hasOwnProperty;function eS(e,t,r){var i=e[t];eb.call(e,t)&&eT(i,r)&&(void 0!==r||t in e)||ex(e,t,r)}function eE(e,t,r,i){var n=!r;r||(r={});for(var a=-1,s=t.length;++a<s;){var o=t[a],l=i?i(r[o],e[o],o,r,e):void 0;void 0===l&&(l=e[o]),n?ex(r,o,l):eS(r,o,l)}return r}var eR=Math.max;function eA(e,t){var r;return eh((r=eR(void 0===(r=t)?e.length-1:r,0),function(){for(var t=arguments,i=-1,n=eR(t.length-r,0),a=Array(n);++i<n;)a[i]=t[r+i];i=-1;for(var s=Array(r+1);++i<r;)s[i]=t[i];return s[r]=X(a),function(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)}(e,this,s)}),e+"")}function ew(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}function eM(e){return null!=e&&ew(e.length)&&!Y(e)}function eC(e,t,r){if(!B(r))return!1;var i=typeof t;return("number"==i?!!(eM(r)&&ey(t,r.length)):"string"==i&&t in r)&&eT(r[t],e)}var eI=Object.prototype;function eN(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||eI)}function eO(e){return N(e)&&"[object Arguments]"==I(e)}var eP=Object.prototype,ek=eP.hasOwnProperty,e_=eP.propertyIsEnumerable,eL=eO(function(){return arguments}())?eO:function(e){return N(e)&&ek.call(e,"callee")&&!e_.call(e,"callee")},eU="object"==typeof exports&&exports&&!exports.nodeType&&exports,eD=eU&&"object"==typeof module&&module&&!module.nodeType&&module,eF=eD&&eD.exports===eU?b.Buffer:void 0;let eB=(eF?eF.isBuffer:void 0)||function(){return!1};var eV={};function eG(e){return function(t){return e(t)}}eV["[object Float32Array]"]=eV["[object Float64Array]"]=eV["[object Int8Array]"]=eV["[object Int16Array]"]=eV["[object Int32Array]"]=eV["[object Uint8Array]"]=eV["[object Uint8ClampedArray]"]=eV["[object Uint16Array]"]=eV["[object Uint32Array]"]=!0,eV["[object Arguments]"]=eV["[object Array]"]=eV["[object ArrayBuffer]"]=eV["[object Boolean]"]=eV["[object DataView]"]=eV["[object Date]"]=eV["[object Error]"]=eV["[object Function]"]=eV["[object Map]"]=eV["[object Number]"]=eV["[object Object]"]=eV["[object RegExp]"]=eV["[object Set]"]=eV["[object String]"]=eV["[object WeakMap]"]=!1;var ez="object"==typeof exports&&exports&&!exports.nodeType&&exports,ej=ez&&"object"==typeof module&&module&&!module.nodeType&&module,eH=ej&&ej.exports===ez&&x.process,eW=function(){try{var e=ej&&ej.require&&ej.require("util").types;if(e)return e;return eH&&eH.binding&&eH.binding("util")}catch(e){}}(),eK=eW&&eW.isTypedArray,eX=eK?eG(eK):function(e){return N(e)&&ew(e.length)&&!!eV[I(e)]},eY=Object.prototype.hasOwnProperty;function eq(e,t){var r=k(e),i=!r&&eL(e),n=!r&&!i&&eB(e),a=!r&&!i&&!n&&eX(e),s=r||i||n||a,o=s?function(e,t){for(var r=-1,i=Array(e);++r<e;)i[r]=t(r);return i}(e.length,String):[],l=o.length;for(var c in e)(t||eY.call(e,c))&&!(s&&("length"==c||n&&("offset"==c||"parent"==c)||a&&("buffer"==c||"byteLength"==c||"byteOffset"==c)||ey(c,l)))&&o.push(c);return o}function eZ(e,t){return function(r){return e(t(r))}}var e$=eZ(Object.keys,Object),eQ=Object.prototype.hasOwnProperty;function eJ(e){if(!eN(e))return e$(e);var t=[];for(var r in Object(e))eQ.call(e,r)&&"constructor"!=r&&t.push(r);return t}function e0(e){return eM(e)?eq(e):eJ(e)}var e1=Object.prototype.hasOwnProperty,e2=(n=function(e,t){if(eN(t)||eM(t)){eE(t,e0(t),e);return}for(var r in t)e1.call(t,r)&&eS(e,r,t[r])},eA(function(e,t){var r=-1,i=t.length,a=i>1?t[i-1]:void 0,s=i>2?t[2]:void 0;for(a=n.length>3&&"function"==typeof a?(i--,a):void 0,s&&eC(t[0],t[1],s)&&(a=i<3?void 0:a,i=1),e=Object(e);++r<i;){var o=t[r];o&&n(e,o,r,a)}return e})),e3=Object.prototype.hasOwnProperty;function e4(e){return eM(e)?eq(e,!0):function(e){if(!B(e))return function(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t}(e);var t=eN(e),r=[];for(var i in e)"constructor"==i&&(t||!e3.call(e,i))||r.push(i);return r}(e)}var e5=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,e6=/^\w*$/;function e8(e,t){if(k(e))return!1;var r=typeof e;return!!("number"==r||"symbol"==r||"boolean"==r||null==e||O(e))||e6.test(e)||!e5.test(e)||null!=t&&e in Object(t)}var e9=en(Object,"create"),e7=Object.prototype.hasOwnProperty,te=Object.prototype.hasOwnProperty;function tt(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}function tr(e,t){for(var r=e.length;r--;)if(eT(e[r][0],t))return r;return -1}tt.prototype.clear=function(){this.__data__=e9?e9(null):{},this.size=0},tt.prototype.delete=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},tt.prototype.get=function(e){var t=this.__data__;if(e9){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return e7.call(t,e)?t[e]:void 0},tt.prototype.has=function(e){var t=this.__data__;return e9?void 0!==t[e]:te.call(t,e)},tt.prototype.set=function(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=e9&&void 0===t?"__lodash_hash_undefined__":t,this};var ti=Array.prototype.splice;function tn(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}tn.prototype.clear=function(){this.__data__=[],this.size=0},tn.prototype.delete=function(e){var t=this.__data__,r=tr(t,e);return!(r<0)&&(r==t.length-1?t.pop():ti.call(t,r,1),--this.size,!0)},tn.prototype.get=function(e){var t=this.__data__,r=tr(t,e);return r<0?void 0:t[r][1]},tn.prototype.has=function(e){return tr(this.__data__,e)>-1},tn.prototype.set=function(e,t){var r=this.__data__,i=tr(r,e);return i<0?(++this.size,r.push([e,t])):r[i][1]=t,this};var ta=en(b,"Map");function ts(e,t){var r,i=e.__data__;return("string"==(r=typeof t)||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==t:null===t)?i["string"==typeof t?"string":"hash"]:i.map}function to(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}function tl(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw TypeError("Expected a function");var r=function(){var i=arguments,n=t?t.apply(this,i):i[0],a=r.cache;if(a.has(n))return a.get(n);var s=e.apply(this,i);return r.cache=a.set(n,s)||a,s};return r.cache=new(tl.Cache||to),r}to.prototype.clear=function(){this.size=0,this.__data__={hash:new tt,map:new(ta||tn),string:new tt}},to.prototype.delete=function(e){var t=ts(this,e).delete(e);return this.size-=t?1:0,t},to.prototype.get=function(e){return ts(this,e).get(e)},to.prototype.has=function(e){return ts(this,e).has(e)},to.prototype.set=function(e,t){var r=ts(this,e),i=r.size;return r.set(e,t),this.size+=r.size==i?0:1,this},tl.Cache=to;var tc=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,tu=/\\(\\)?/g,th=(s=(a=tl(function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(tc,function(e,r,i,n){t.push(i?n.replace(tu,"$1"):r||e)}),t},function(e){return 500===s.size&&s.clear(),e})).cache,a);function tp(e,t){return k(e)?e:e8(e,t)?[e]:th(null==e?"":function e(t){if("string"==typeof t)return t;if(k(t))return P(t,e)+"";if(O(t))return U?U.call(t):"";var r=t+"";return"0"==r&&1/t==-_?"-0":r}(e))}var td=1/0;function tf(e){if("string"==typeof e||O(e))return e;var t=e+"";return"0"==t&&1/e==-td?"-0":t}function tm(e,t){t=tp(t,e);for(var r=0,i=t.length;null!=e&&r<i;)e=e[tf(t[r++])];return r&&r==i?e:void 0}function tg(e,t){for(var r=-1,i=t.length,n=e.length;++r<i;)e[n+r]=t[r];return e}var tv=S?S.isConcatSpreadable:void 0;function ty(e){return k(e)||eL(e)||!!(tv&&e&&e[tv])}function tx(e,t,r,i,n){var a=-1,s=e.length;for(r||(r=ty),n||(n=[]);++a<s;){var o=e[a];t>0&&r(o)?t>1?tx(o,t-1,r,i,n):tg(n,o):i||(n[n.length]=o)}return n}function tT(e){return(null==e?0:e.length)?tx(e,1):[]}var tb=eZ(Object.getPrototypeOf,Object);function tS(e,t,r){var i=-1,n=e.length;t<0&&(t=-t>n?0:n+t),(r=r>n?n:r)<0&&(r+=n),n=t>r?0:r-t>>>0,t>>>=0;for(var a=Array(n);++i<n;)a[i]=e[i+t];return a}function tE(e,t,r,i){var n=-1,a=null==e?0:e.length;for(i&&a&&(r=e[++n]);++n<a;)r=t(r,e[n],n,e);return r}function tR(e){var t=this.__data__=new tn(e);this.size=t.size}tR.prototype.clear=function(){this.__data__=new tn,this.size=0},tR.prototype.delete=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r},tR.prototype.get=function(e){return this.__data__.get(e)},tR.prototype.has=function(e){return this.__data__.has(e)},tR.prototype.set=function(e,t){var r=this.__data__;if(r instanceof tn){var i=r.__data__;if(!ta||i.length<199)return i.push([e,t]),this.size=++r.size,this;r=this.__data__=new to(i)}return r.set(e,t),this.size=r.size,this};var tA="object"==typeof exports&&exports&&!exports.nodeType&&exports,tw=tA&&"object"==typeof module&&module&&!module.nodeType&&module,tM=tw&&tw.exports===tA?b.Buffer:void 0,tC=tM?tM.allocUnsafe:void 0;function tI(e,t){for(var r=-1,i=null==e?0:e.length,n=0,a=[];++r<i;){var s=e[r];t(s,r,e)&&(a[n++]=s)}return a}function tN(){return[]}var tO=Object.prototype.propertyIsEnumerable,tP=Object.getOwnPropertySymbols,tk=tP?function(e){return null==e?[]:tI(tP(e=Object(e)),function(t){return tO.call(e,t)})}:tN,t_=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)tg(t,tk(e)),e=tb(e);return t}:tN;function tL(e,t,r){var i=t(e);return k(e)?i:tg(i,r(e))}function tU(e){return tL(e,e0,tk)}function tD(e){return tL(e,e4,t_)}var tF=en(b,"DataView"),tB=en(b,"Promise"),tV=en(b,"Set"),tG="[object Map]",tz="[object Promise]",tj="[object Set]",tH="[object WeakMap]",tW="[object DataView]",tK=Q(tF),tX=Q(ta),tY=Q(tB),tq=Q(tV),tZ=Q(ea),t$=I;(tF&&t$(new tF(new ArrayBuffer(1)))!=tW||ta&&t$(new ta)!=tG||tB&&t$(tB.resolve())!=tz||tV&&t$(new tV)!=tj||ea&&t$(new ea)!=tH)&&(t$=function(e){var t=I(e),r="[object Object]"==t?e.constructor:void 0,i=r?Q(r):"";if(i)switch(i){case tK:return tW;case tX:return tG;case tY:return tz;case tq:return tj;case tZ:return tH}return t});let tQ=t$;var tJ=Object.prototype.hasOwnProperty,t0=b.Uint8Array;function t1(e){var t=new e.constructor(e.byteLength);return new t0(t).set(new t0(e)),t}var t2=/\w*$/,t3=S?S.prototype:void 0,t4=t3?t3.valueOf:void 0,t5=eW&&eW.isMap,t6=t5?eG(t5):function(e){return N(e)&&"[object Map]"==tQ(e)},t8=eW&&eW.isSet,t9=t8?eG(t8):function(e){return N(e)&&"[object Set]"==tQ(e)},t7="[object Arguments]",re="[object Function]",rt="[object Object]",rr={};function ri(e){return function e(t,r,i,n,a,s){var o,l=1&r,c=2&r,u=4&r;if(i&&(o=a?i(t,n,a,s):i(t)),void 0!==o)return o;if(!B(t))return t;var h=k(t);if(h){if(p=t.length,d=new t.constructor(p),p&&"string"==typeof t[0]&&tJ.call(t,"index")&&(d.index=t.index,d.input=t.input),o=d,!l)return function(e,t){var r=-1,i=e.length;for(t||(t=Array(i));++r<i;)t[r]=e[r];return t}(t,o)}else{var p,d,f,m,g,v,y=tQ(t),x=y==re||"[object GeneratorFunction]"==y;if(eB(t))return function(e,t){if(t)return e.slice();var r=e.length,i=tC?tC(r):new e.constructor(r);return e.copy(i),i}(t,l);if(y==rt||y==t7||x&&!a){if(o=c||x?{}:"function"!=typeof t.constructor||eN(t)?{}:eo(tb(t)),!l)return c?(m=(f=o)&&eE(t,e4(t),f),eE(t,t_(t),m)):(v=(g=o)&&eE(t,e0(t),g),eE(t,tk(t),v))}else{if(!rr[y])return a?t:{};o=function(e,t,r){var i,n,a,s=e.constructor;switch(t){case"[object ArrayBuffer]":return t1(e);case"[object Boolean]":case"[object Date]":return new s(+e);case"[object DataView]":return i=r?t1(e.buffer):e.buffer,new e.constructor(i,e.byteOffset,e.byteLength);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return n=r?t1(e.buffer):e.buffer,new e.constructor(n,e.byteOffset,e.length);case"[object Map]":case"[object Set]":return new s;case"[object Number]":case"[object String]":return new s(e);case"[object RegExp]":return(a=new e.constructor(e.source,t2.exec(e))).lastIndex=e.lastIndex,a;case"[object Symbol]":return t4?Object(t4.call(e)):{}}}(t,y,l)}}s||(s=new tR);var T=s.get(t);if(T)return T;s.set(t,o),t9(t)?t.forEach(function(n){o.add(e(n,r,i,n,t,s))}):t6(t)&&t.forEach(function(n,a){o.set(a,e(n,r,i,a,t,s))});var b=u?c?tD:tU:c?e4:e0,S=h?void 0:b(t);return ep(S||t,function(n,a){S&&(n=t[a=n]),eS(o,a,e(n,r,i,a,t,s))}),o}(e,4)}function rn(e){for(var t=-1,r=null==e?0:e.length,i=0,n=[];++t<r;){var a=e[t];a&&(n[i++]=a)}return n}function ra(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new to;++t<r;)this.add(e[t])}function rs(e,t){for(var r=-1,i=null==e?0:e.length;++r<i;)if(t(e[r],r,e))return!0;return!1}function ro(e,t){return e.has(t)}function rl(e,t,r,i,n,a){var s=1&r,o=e.length,l=t.length;if(o!=l&&!(s&&l>o))return!1;var c=a.get(e),u=a.get(t);if(c&&u)return c==t&&u==e;var h=-1,p=!0,d=2&r?new ra:void 0;for(a.set(e,t),a.set(t,e);++h<o;){var f=e[h],m=t[h];if(i)var g=s?i(m,f,h,t,e,a):i(f,m,h,e,t,a);if(void 0!==g){if(g)continue;p=!1;break}if(d){if(!rs(t,function(e,t){if(!ro(d,t)&&(f===e||n(f,e,r,i,a)))return d.push(t)})){p=!1;break}}else if(!(f===m||n(f,m,r,i,a))){p=!1;break}}return a.delete(e),a.delete(t),p}function rc(e){var t=-1,r=Array(e.size);return e.forEach(function(e,i){r[++t]=[i,e]}),r}function ru(e){var t=-1,r=Array(e.size);return e.forEach(function(e){r[++t]=e}),r}rr[t7]=rr["[object Array]"]=rr["[object ArrayBuffer]"]=rr["[object DataView]"]=rr["[object Boolean]"]=rr["[object Date]"]=rr["[object Float32Array]"]=rr["[object Float64Array]"]=rr["[object Int8Array]"]=rr["[object Int16Array]"]=rr["[object Int32Array]"]=rr["[object Map]"]=rr["[object Number]"]=rr[rt]=rr["[object RegExp]"]=rr["[object Set]"]=rr["[object String]"]=rr["[object Symbol]"]=rr["[object Uint8Array]"]=rr["[object Uint8ClampedArray]"]=rr["[object Uint16Array]"]=rr["[object Uint32Array]"]=!0,rr["[object Error]"]=rr[re]=rr["[object WeakMap]"]=!1,ra.prototype.add=ra.prototype.push=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this},ra.prototype.has=function(e){return this.__data__.has(e)};var rh=S?S.prototype:void 0,rp=rh?rh.valueOf:void 0,rd=Object.prototype.hasOwnProperty,rf="[object Arguments]",rm="[object Array]",rg="[object Object]",rv=Object.prototype.hasOwnProperty;function ry(e,t,r,i,n){return e===t||(null!=e&&null!=t&&(N(e)||N(t))?function(e,t,r,i,n,a){var s=k(e),o=k(t),l=s?rm:tQ(e),c=o?rm:tQ(t);l=l==rf?rg:l,c=c==rf?rg:c;var u=l==rg,h=c==rg,p=l==c;if(p&&eB(e)){if(!eB(t))return!1;s=!0,u=!1}if(p&&!u)return a||(a=new tR),s||eX(e)?rl(e,t,r,i,n,a):function(e,t,r,i,n,a,s){switch(r){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)break;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":if(e.byteLength!=t.byteLength||!a(new t0(e),new t0(t)))break;return!0;case"[object Boolean]":case"[object Date]":case"[object Number]":return eT(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var o=rc;case"[object Set]":var l=1&i;if(o||(o=ru),e.size!=t.size&&!l)break;var c=s.get(e);if(c)return c==t;i|=2,s.set(e,t);var u=rl(o(e),o(t),i,n,a,s);return s.delete(e),u;case"[object Symbol]":if(rp)return rp.call(e)==rp.call(t)}return!1}(e,t,l,r,i,n,a);if(!(1&r)){var d=u&&rv.call(e,"__wrapped__"),f=h&&rv.call(t,"__wrapped__");if(d||f){var m=d?e.value():e,g=f?t.value():t;return a||(a=new tR),n(m,g,r,i,a)}}return!!p&&(a||(a=new tR),function(e,t,r,i,n,a){var s=1&r,o=tU(e),l=o.length;if(l!=tU(t).length&&!s)return!1;for(var c=l;c--;){var u=o[c];if(!(s?u in t:rd.call(t,u)))return!1}var h=a.get(e),p=a.get(t);if(h&&p)return h==t&&p==e;var d=!0;a.set(e,t),a.set(t,e);for(var f=s;++c<l;){var m=e[u=o[c]],g=t[u];if(i)var v=s?i(g,m,u,t,e,a):i(m,g,u,e,t,a);if(!(void 0===v?m===g||n(m,g,r,i,a):v)){d=!1;break}f||(f="constructor"==u)}if(d&&!f){var y=e.constructor,x=t.constructor;y!=x&&"constructor"in e&&"constructor"in t&&!("function"==typeof y&&y instanceof y&&"function"==typeof x&&x instanceof x)&&(d=!1)}return a.delete(e),a.delete(t),d}(e,t,r,i,n,a))}(e,t,r,i,ry,n):e!=e&&t!=t)}function rx(e,t){return function(r){return null!=r&&r[e]===t&&(void 0!==t||e in Object(r))}}function rT(e,t){return null!=e&&t in Object(e)}function rb(e,t,r){t=tp(t,e);for(var i=-1,n=t.length,a=!1;++i<n;){var s=tf(t[i]);if(!(a=null!=e&&r(e,s)))break;e=e[s]}return a||++i!=n?a:!!(n=null==e?0:e.length)&&ew(n)&&ey(s,n)&&(k(e)||eL(e))}function rS(e){var t,r,i,n,a;return"function"==typeof e?e:null==e?X:"object"==typeof e?k(e)?(t=e[0],r=e[1],e8(t)&&(i=r)==i&&!B(i)?rx(tf(t),r):function(e){var i,n=void 0===(i=null==e?void 0:tm(e,t))?void 0:i;return void 0===n&&n===r?null!=e&&rb(e,t,rT):ry(r,n,3)}):1==(n=function(e){for(var t=e0(e),r=t.length;r--;){var i=t[r],n=e[i];t[r]=[i,n,n==n&&!B(n)]}return t}(e)).length&&n[0][2]?rx(n[0][0],n[0][1]):function(t){return t===e||function(e,t,r,i){var n=r.length,a=n,s=!i;if(null==e)return!a;for(e=Object(e);n--;){var o=r[n];if(s&&o[2]?o[1]!==e[o[0]]:!(o[0]in e))return!1}for(;++n<a;){var l=(o=r[n])[0],c=e[l],u=o[1];if(s&&o[2]){if(void 0===c&&!(l in e))return!1}else{var h=new tR;if(i)var p=i(c,u,l,e,t,h);if(!(void 0===p?ry(u,c,3,i,h):p))return!1}}return!0}(t,e,n)}:e8(e)?(a=tf(e),function(e){return null==e?void 0:e[a]}):function(t){return tm(t,e)}}function rE(e,t,r,i){for(var n=-1,a=null==e?0:e.length;++n<a;){var s=e[n];t(i,s,r(s),e)}return i}let rR=function(e,t,r){for(var i=-1,n=Object(e),a=r(e),s=a.length;s--;){var o=a[++i];if(!1===t(n[o],o,n))break}return e};var rA=function(e,t){if(null==e)return e;if(!eM(e))return e&&rR(e,t,e0);for(var r=e.length,i=o?r:-1,n=Object(e);(o?i--:++i<r)&&!1!==t(n[i],i,n););return e};function rw(e,t,r,i){return rA(e,function(e,n,a){t(i,e,r(e),a)}),i}var rM=Object.prototype,rC=rM.hasOwnProperty,rI=eA(function(e,t){e=Object(e);var r=-1,i=t.length,n=i>2?t[2]:void 0;for(n&&eC(t[0],t[1],n)&&(i=1);++r<i;)for(var a=t[r],s=e4(a),o=-1,l=s.length;++o<l;){var c=s[o],u=e[c];(void 0===u||eT(u,rM[c])&&!rC.call(e,c))&&(e[c]=a[c])}return e});function rN(e){return N(e)&&eM(e)}function rO(e,t,r){for(var i=-1,n=null==e?0:e.length;++i<n;)if(r(t,e[i]))return!0;return!1}var rP=eA(function(e,t){return rN(e)?function(e,t,r,i){var n=-1,a=eg,s=!0,o=e.length,l=[],c=t.length;if(!o)return l;r&&(t=P(t,eG(r))),i?(a=rO,s=!1):t.length>=200&&(a=ro,s=!1,t=new ra(t));e:for(;++n<o;){var u=e[n],h=null==r?u:r(u);if(u=i||0!==u?u:0,s&&h==h){for(var p=c;p--;)if(t[p]===h)continue e;l.push(u)}else a(t,h,i)||l.push(u)}return l}(e,tx(t,1,rN,!0)):[]});function rk(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}function r_(e,t,r){var i=null==e?0:e.length;return i?tS(e,(t=r||void 0===t?1:K(t))<0?0:t,i):[]}function rL(e,t,r){var i=null==e?0:e.length;return i?tS(e,0,(t=i-(t=r||void 0===t?1:K(t)))<0?0:t):[]}function rU(e,t){return(k(e)?ep:rA)(e,"function"==typeof t?t:X)}function rD(e,t){for(var r=-1,i=null==e?0:e.length;++r<i;)if(!t(e[r],r,e))return!1;return!0}function rF(e,t){var r=!0;return rA(e,function(e,i,n){return r=!!t(e,i,n)}),r}function rB(e,t,r){var i=k(e)?rD:rF;return r&&eC(e,t,r)&&(t=void 0),i(e,rS(t))}function rV(e,t){var r=[];return rA(e,function(e,i,n){t(e,i,n)&&r.push(e)}),r}function rG(e,t){return(k(e)?tI:rV)(e,rS(t))}var rz=Math.max,rj=(l=function(e,t,r){var i=null==e?0:e.length;if(!i)return -1;var n=null==r?0:K(r);return n<0&&(n=rz(i+n,0)),ed(e,rS(t),n)},function(e,t,r){var i=Object(e);if(!eM(e)){var n=rS(t);e=e0(e),t=function(e){return n(i[e],e,i)}}var a=l(e,t,r);return a>-1?i[n?e[a]:a]:void 0});function rH(e){return e&&e.length?e[0]:void 0}function rW(e,t){return(k(e)?P:function(e,t){var r=-1,i=eM(e)?Array(e.length):[];return rA(e,function(e,n,a){i[++r]=t(e,n,a)}),i})(e,rS(t))}function rK(e,t){return tx(rW(e,t),1)}var rX=Object.prototype.hasOwnProperty,rY=(c=function(e,t,r){rX.call(e,r)?e[r].push(t):ex(e,r,[t])},function(e,t){var r=k(e)?rE:rw,i=u?u():{};return r(e,c,rS(t),i)}),rq=Object.prototype.hasOwnProperty;function rZ(e,t){return null!=e&&rq.call(e,t)}function r$(e,t){return null!=e&&rb(e,t,rZ)}function rQ(e){return"string"==typeof e||!k(e)&&N(e)&&"[object String]"==I(e)}function rJ(e){return null==e?[]:P(e0(e),function(t){return e[t]})}var r0=Math.max;function r1(e,t,r,i){e=eM(e)?e:rJ(e),r=r&&!i?K(r):0;var n=e.length;return r<0&&(r=r0(n+r,0)),rQ(e)?r<=n&&e.indexOf(t,r)>-1:!!n&&em(e,t,r)>-1}var r2=Math.max;function r3(e,t,r){var i=null==e?0:e.length;if(!i)return -1;var n=null==r?0:K(r);return n<0&&(n=r2(i+n,0)),em(e,t,n)}var r4=Object.prototype.hasOwnProperty;function r5(e){if(null==e)return!0;if(eM(e)&&(k(e)||"string"==typeof e||"function"==typeof e.splice||eB(e)||eX(e)||eL(e)))return!e.length;var t=tQ(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(eN(e))return!eJ(e).length;for(var r in e)if(r4.call(e,r))return!1;return!0}var r6=eW&&eW.isRegExp,r8=r6?eG(r6):function(e){return N(e)&&"[object RegExp]"==I(e)};function r9(e){return void 0===e}function r7(e,t){if(null==e)return{};var r=P(tD(e),function(e){return[e]});return t=rS(t),function(e,t,r){for(var i=-1,n=t.length,a={};++i<n;){var s=t[i],o=tm(e,s);r(o,s)&&function(e,t,r,i){if(B(e)){t=tp(t,e);for(var n=-1,a=t.length,s=a-1,o=e;null!=o&&++n<a;){var l=tf(t[n]),c=r;if("__proto__"===l||"constructor"===l||"prototype"===l)break;if(n!=s){var u=o[l];void 0===(c=i?i(u,l,o):void 0)&&(c=B(u)?u:ey(t[n+1])?[]:{})}eS(o,l,c),o=o[l]}}}(a,tp(s,e),o)}return a}(e,r,function(e,r){return t(e,r[0])})}function ie(e,t,r,i,n){return n(e,function(e,n,a){r=i?(i=!1,e):t(r,e,n,a)}),r}function it(e,t,r){var i=k(e)?tE:ie,n=arguments.length<3;return i(e,rS(t),r,n,rA)}function ir(e,t){return(k(e)?tI:rV)(e,function(e){if("function"!=typeof e)throw TypeError("Expected a function");return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}(rS(t)))}function ii(e,t){var r;return rA(e,function(e,i,n){return!(r=t(e,i,n))}),!!r}function ia(e,t,r){var i=k(e)?rs:ii;return r&&eC(e,t,r)&&(t=void 0),i(e,rS(t))}var is=tV&&1/ru(new tV([,-0]))[1]==1/0?function(e){return new tV(e)}:el;function io(e){return e&&e.length?function(e,t,r){var i=-1,n=eg,a=e.length,s=!0,o=[],l=o;if(r)s=!1,n=rO;else if(a>=200){var c=t?null:is(e);if(c)return ru(c);s=!1,n=ro,l=new ra}else l=t?[]:o;e:for(;++i<a;){var u=e[i],h=t?t(u):u;if(u=r||0!==u?u:0,s&&h==h){for(var p=l.length;p--;)if(l[p]===h)continue e;t&&l.push(h),o.push(u)}else n(l,h,r)||(l!==o&&l.push(h),o.push(u))}return o}(e):[]}function il(e){console&&console.error&&console.error(`Error: ${e}`)}function ic(e){console&&console.warn&&console.warn(`Warning: ${e}`)}function iu(e){let t=new Date().getTime(),r=e();return{time:new Date().getTime()-t,value:r}}function ih(e){function t(){}t.prototype=e;let r=new t;function i(){return typeof r.bar}return i(),i(),e}class ip{get definition(){return this._definition}set definition(e){this._definition=e}constructor(e){this._definition=e}accept(e){e.visit(this),rU(this.definition,t=>{t.accept(e)})}}class id extends ip{constructor(e){super([]),this.idx=1,e2(this,r7(e,e=>void 0!==e))}set definition(e){}get definition(){return void 0!==this.referencedRule?this.referencedRule.definition:[]}accept(e){e.visit(this)}}class im extends ip{constructor(e){super(e.definition),this.orgText="",e2(this,r7(e,e=>void 0!==e))}}class ig extends ip{constructor(e){super(e.definition),this.ignoreAmbiguities=!1,e2(this,r7(e,e=>void 0!==e))}}class Option extends ip{constructor(e){super(e.definition),this.idx=1,e2(this,r7(e,e=>void 0!==e))}}class iv extends ip{constructor(e){super(e.definition),this.idx=1,e2(this,r7(e,e=>void 0!==e))}}class iy extends ip{constructor(e){super(e.definition),this.idx=1,e2(this,r7(e,e=>void 0!==e))}}class ix extends ip{constructor(e){super(e.definition),this.idx=1,e2(this,r7(e,e=>void 0!==e))}}class iT extends ip{constructor(e){super(e.definition),this.idx=1,e2(this,r7(e,e=>void 0!==e))}}class ib extends ip{get definition(){return this._definition}set definition(e){this._definition=e}constructor(e){super(e.definition),this.idx=1,this.ignoreAmbiguities=!1,this.hasPredicates=!1,e2(this,r7(e,e=>void 0!==e))}}class iS{constructor(e){this.idx=1,e2(this,r7(e,e=>void 0!==e))}accept(e){e.visit(this)}}class iE{visit(e){switch(e.constructor){case id:return this.visitNonTerminal(e);case ig:return this.visitAlternative(e);case Option:return this.visitOption(e);case iv:return this.visitRepetitionMandatory(e);case iy:return this.visitRepetitionMandatoryWithSeparator(e);case iT:return this.visitRepetitionWithSeparator(e);case ix:return this.visitRepetition(e);case ib:return this.visitAlternation(e);case iS:return this.visitTerminal(e);case im:return this.visitRule(e);default:throw Error("non exhaustive match")}}visitNonTerminal(e){}visitAlternative(e){}visitOption(e){}visitRepetition(e){}visitRepetitionMandatory(e){}visitRepetitionMandatoryWithSeparator(e){}visitRepetitionWithSeparator(e){}visitAlternation(e){}visitTerminal(e){}visitRule(e){}}function iR(e,t=[]){return e instanceof Option||e instanceof ix||e instanceof iT||(e instanceof ib?ia(e.definition,e=>iR(e,t)):!(e instanceof id&&r1(t,e))&&e instanceof ip&&(e instanceof id&&t.push(e),rB(e.definition,e=>iR(e,t))))}function iA(e){if(e instanceof id)return"SUBRULE";if(e instanceof Option)return"OPTION";if(e instanceof ib)return"OR";if(e instanceof iv)return"AT_LEAST_ONE";if(e instanceof iy)return"AT_LEAST_ONE_SEP";if(e instanceof iT)return"MANY_SEP";if(e instanceof ix)return"MANY";else if(e instanceof iS)return"CONSUME";else throw Error("non exhaustive match")}class iw{walk(e,t=[]){rU(e.definition,(r,i)=>{let n=r_(e.definition,i+1);if(r instanceof id)this.walkProdRef(r,n,t);else if(r instanceof iS)this.walkTerminal(r,n,t);else if(r instanceof ig)this.walkFlat(r,n,t);else if(r instanceof Option)this.walkOption(r,n,t);else if(r instanceof iv)this.walkAtLeastOne(r,n,t);else if(r instanceof iy)this.walkAtLeastOneSep(r,n,t);else if(r instanceof iT)this.walkManySep(r,n,t);else if(r instanceof ix)this.walkMany(r,n,t);else if(r instanceof ib)this.walkOr(r,n,t);else throw Error("non exhaustive match")})}walkTerminal(e,t,r){}walkProdRef(e,t,r){}walkFlat(e,t,r){let i=t.concat(r);this.walk(e,i)}walkOption(e,t,r){let i=t.concat(r);this.walk(e,i)}walkAtLeastOne(e,t,r){let i=[new Option({definition:e.definition})].concat(t,r);this.walk(e,i)}walkAtLeastOneSep(e,t,r){let i=iM(e,t,r);this.walk(e,i)}walkMany(e,t,r){let i=[new Option({definition:e.definition})].concat(t,r);this.walk(e,i)}walkManySep(e,t,r){let i=iM(e,t,r);this.walk(e,i)}walkOr(e,t,r){let i=t.concat(r);rU(e.definition,e=>{let t=new ig({definition:[e]});this.walk(t,i)})}}function iM(e,t,r){return[new Option({definition:[new iS({terminalType:e.separator})].concat(e.definition)})].concat(t,r)}function iC(e){if(e instanceof id)return iC(e.referencedRule);if(e instanceof iS)return[e.terminalType];if(e instanceof ig||e instanceof Option||e instanceof ix||e instanceof iv||e instanceof iy||e instanceof iT||e instanceof iS||e instanceof im)return function(e){let t,r=[],i=e.definition,n=0,a=i.length>n,s=!0;for(;a&&s;)s=iR(t=i[n]),r=r.concat(iC(t)),n+=1,a=i.length>n;return io(r)}(e);if(e instanceof ib)return io(tT(rW(e.definition,e=>iC(e))));throw Error("non exhaustive match")}let iI="_~IN~_";class iN extends iw{constructor(e){super(),this.topProd=e,this.follows={}}startWalking(){return this.walk(this.topProd),this.follows}walkTerminal(e,t,r){}walkProdRef(e,t,r){var i,n;let a=(i=e.referencedRule,n=e.idx,i.name+n+iI+this.topProd.name),s=iC(new ig({definition:t.concat(r)}));this.follows[a]=s}}function iO(e){return e.charCodeAt(0)}function iP(e,t){Array.isArray(e)?e.forEach(function(e){t.push(e)}):t.push(e)}function ik(e,t){if(!0===e[t])throw"duplicate flag "+t;e[t],e[t]=!0}function i_(e){if(void 0===e)throw Error("Internal Error - Should never get here!");return!0}function iL(e){return"Character"===e.type}let iU=[];for(let e=iO("0");e<=iO("9");e++)iU.push(e);let iD=[iO("_")].concat(iU);for(let e=iO("a");e<=iO("z");e++)iD.push(e);for(let e=iO("A");e<=iO("Z");e++)iD.push(e);let iF=[iO(" "),iO("\f"),iO("\n"),iO("\r"),iO("	"),iO("\v"),iO("	"),iO("\xa0"),iO(""),iO(""),iO(""),iO(""),iO(""),iO(""),iO(""),iO(""),iO(""),iO(""),iO(""),iO(""),iO("\u2028"),iO("\u2029"),iO(""),iO(""),iO(""),iO("\uFEFF")],iB=/[0-9a-fA-F]/,iV=/[0-9]/,iG=/[1-9]/;class iz{constructor(){this.idx=0,this.input="",this.groupIdx=0}saveState(){return{idx:this.idx,input:this.input,groupIdx:this.groupIdx}}restoreState(e){this.idx=e.idx,this.input=e.input,this.groupIdx=e.groupIdx}pattern(e){this.idx=0,this.input=e,this.groupIdx=0,this.consumeChar("/");let t=this.disjunction();this.consumeChar("/");let r={type:"Flags",loc:{begin:this.idx,end:e.length},global:!1,ignoreCase:!1,multiLine:!1,unicode:!1,sticky:!1};for(;this.isRegExpFlag();)switch(this.popChar()){case"g":ik(r,"global");break;case"i":ik(r,"ignoreCase");break;case"m":ik(r,"multiLine");break;case"u":ik(r,"unicode");break;case"y":ik(r,"sticky")}if(this.idx!==this.input.length)throw Error("Redundant input: "+this.input.substring(this.idx));return{type:"Pattern",flags:r,value:t,loc:this.loc(0)}}disjunction(){let e=[],t=this.idx;for(e.push(this.alternative());"|"===this.peekChar();)this.consumeChar("|"),e.push(this.alternative());return{type:"Disjunction",value:e,loc:this.loc(t)}}alternative(){let e=[],t=this.idx;for(;this.isTerm();)e.push(this.term());return{type:"Alternative",value:e,loc:this.loc(t)}}term(){return this.isAssertion()?this.assertion():this.atom()}assertion(){let e=this.idx;switch(this.popChar()){case"^":return{type:"StartAnchor",loc:this.loc(e)};case"$":return{type:"EndAnchor",loc:this.loc(e)};case"\\":switch(this.popChar()){case"b":return{type:"WordBoundary",loc:this.loc(e)};case"B":return{type:"NonWordBoundary",loc:this.loc(e)}}throw Error("Invalid Assertion Escape");case"(":let t;switch(this.consumeChar("?"),this.popChar()){case"=":t="Lookahead";break;case"!":t="NegativeLookahead"}i_(t);let r=this.disjunction();return this.consumeChar(")"),{type:t,value:r,loc:this.loc(e)}}return function(){throw Error("Internal Error - Should never get here!")}()}quantifier(e=!1){let t;let r=this.idx;switch(this.popChar()){case"*":t={atLeast:0,atMost:1/0};break;case"+":t={atLeast:1,atMost:1/0};break;case"?":t={atLeast:0,atMost:1};break;case"{":let i=this.integerIncludingZero();switch(this.popChar()){case"}":t={atLeast:i,atMost:i};break;case",":t=this.isDigit()?{atLeast:i,atMost:this.integerIncludingZero()}:{atLeast:i,atMost:1/0},this.consumeChar("}")}if(!0===e&&void 0===t)return;i_(t)}if((!0!==e||void 0!==t)&&i_(t))return"?"===this.peekChar(0)?(this.consumeChar("?"),t.greedy=!1):t.greedy=!0,t.type="Quantifier",t.loc=this.loc(r),t}atom(){let e;let t=this.idx;switch(this.peekChar()){case".":e=this.dotAll();break;case"\\":e=this.atomEscape();break;case"[":e=this.characterClass();break;case"(":e=this.group()}if(void 0===e&&this.isPatternCharacter()&&(e=this.patternCharacter()),i_(e))return e.loc=this.loc(t),this.isQuantifier()&&(e.quantifier=this.quantifier()),e}dotAll(){return this.consumeChar("."),{type:"Set",complement:!0,value:[iO("\n"),iO("\r"),iO("\u2028"),iO("\u2029")]}}atomEscape(){switch(this.consumeChar("\\"),this.peekChar()){case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":return this.decimalEscapeAtom();case"d":case"D":case"s":case"S":case"w":case"W":return this.characterClassEscape();case"f":case"n":case"r":case"t":case"v":return this.controlEscapeAtom();case"c":return this.controlLetterEscapeAtom();case"0":return this.nulCharacterAtom();case"x":return this.hexEscapeSequenceAtom();case"u":return this.regExpUnicodeEscapeSequenceAtom();default:return this.identityEscapeAtom()}}decimalEscapeAtom(){return{type:"GroupBackReference",value:this.positiveInteger()}}characterClassEscape(){let e;let t=!1;switch(this.popChar()){case"d":e=iU;break;case"D":e=iU,t=!0;break;case"s":e=iF;break;case"S":e=iF,t=!0;break;case"w":e=iD;break;case"W":e=iD,t=!0}if(i_(e))return{type:"Set",value:e,complement:t}}controlEscapeAtom(){let e;switch(this.popChar()){case"f":e=iO("\f");break;case"n":e=iO("\n");break;case"r":e=iO("\r");break;case"t":e=iO("	");break;case"v":e=iO("\v")}if(i_(e))return{type:"Character",value:e}}controlLetterEscapeAtom(){this.consumeChar("c");let e=this.popChar();if(!1===/[a-zA-Z]/.test(e))throw Error("Invalid ");return{type:"Character",value:e.toUpperCase().charCodeAt(0)-64}}nulCharacterAtom(){return this.consumeChar("0"),{type:"Character",value:iO("\x00")}}hexEscapeSequenceAtom(){return this.consumeChar("x"),this.parseHexDigits(2)}regExpUnicodeEscapeSequenceAtom(){return this.consumeChar("u"),this.parseHexDigits(4)}identityEscapeAtom(){return{type:"Character",value:iO(this.popChar())}}classPatternCharacterAtom(){switch(this.peekChar()){case"\n":case"\r":case"\u2028":case"\u2029":case"\\":case"]":throw Error("TBD");default:return{type:"Character",value:iO(this.popChar())}}}characterClass(){let e=[],t=!1;for(this.consumeChar("["),"^"===this.peekChar(0)&&(this.consumeChar("^"),t=!0);this.isClassAtom();){let t=this.classAtom();if(t.type,iL(t)&&this.isRangeDash()){this.consumeChar("-");let r=this.classAtom();if(r.type,iL(r)){if(r.value<t.value)throw Error("Range out of order in character class");e.push({from:t.value,to:r.value})}else iP(t.value,e),e.push(iO("-")),iP(r.value,e)}else iP(t.value,e)}return this.consumeChar("]"),{type:"Set",complement:t,value:e}}classAtom(){switch(this.peekChar()){case"]":case"\n":case"\r":case"\u2028":case"\u2029":throw Error("TBD");case"\\":return this.classEscape();default:return this.classPatternCharacterAtom()}}classEscape(){switch(this.consumeChar("\\"),this.peekChar()){case"b":return this.consumeChar("b"),{type:"Character",value:iO("\b")};case"d":case"D":case"s":case"S":case"w":case"W":return this.characterClassEscape();case"f":case"n":case"r":case"t":case"v":return this.controlEscapeAtom();case"c":return this.controlLetterEscapeAtom();case"0":return this.nulCharacterAtom();case"x":return this.hexEscapeSequenceAtom();case"u":return this.regExpUnicodeEscapeSequenceAtom();default:return this.identityEscapeAtom()}}group(){let e=!0;(this.consumeChar("("),"?"===this.peekChar(0))?(this.consumeChar("?"),this.consumeChar(":"),e=!1):this.groupIdx++;let t=this.disjunction();this.consumeChar(")");let r={type:"Group",capturing:e,value:t};return e&&(r.idx=this.groupIdx),r}positiveInteger(){let e=this.popChar();if(!1===iG.test(e))throw Error("Expecting a positive integer");for(;iV.test(this.peekChar(0));)e+=this.popChar();return parseInt(e,10)}integerIncludingZero(){let e=this.popChar();if(!1===iV.test(e))throw Error("Expecting an integer");for(;iV.test(this.peekChar(0));)e+=this.popChar();return parseInt(e,10)}patternCharacter(){let e=this.popChar();switch(e){case"\n":case"\r":case"\u2028":case"\u2029":case"^":case"$":case"\\":case".":case"*":case"+":case"?":case"(":case")":case"[":case"|":throw Error("TBD");default:return{type:"Character",value:iO(e)}}}isRegExpFlag(){switch(this.peekChar(0)){case"g":case"i":case"m":case"u":case"y":return!0;default:return!1}}isRangeDash(){return"-"===this.peekChar()&&this.isClassAtom(1)}isDigit(){return iV.test(this.peekChar(0))}isClassAtom(e=0){switch(this.peekChar(e)){case"]":case"\n":case"\r":case"\u2028":case"\u2029":return!1;default:return!0}}isTerm(){return this.isAtom()||this.isAssertion()}isAtom(){if(this.isPatternCharacter())return!0;switch(this.peekChar(0)){case".":case"\\":case"[":case"(":return!0;default:return!1}}isAssertion(){switch(this.peekChar(0)){case"^":case"$":return!0;case"\\":switch(this.peekChar(1)){case"b":case"B":return!0;default:return!1}case"(":return"?"===this.peekChar(1)&&("="===this.peekChar(2)||"!"===this.peekChar(2));default:return!1}}isQuantifier(){let e=this.saveState();try{return void 0!==this.quantifier(!0)}catch(e){return!1}finally{this.restoreState(e)}}isPatternCharacter(){switch(this.peekChar()){case"^":case"$":case"\\":case".":case"*":case"+":case"?":case"(":case")":case"[":case"|":case"/":case"\n":case"\r":case"\u2028":case"\u2029":return!1;default:return!0}}parseHexDigits(e){let t="";for(let r=0;r<e;r++){let e=this.popChar();if(!1===iB.test(e))throw Error("Expecting a HexDecimal digits");t+=e}return{type:"Character",value:parseInt(t,16)}}peekChar(e=0){return this.input[this.idx+e]}popChar(){let e=this.peekChar(0);return this.consumeChar(void 0),e}consumeChar(e){if(void 0!==e&&this.input[this.idx]!==e)throw Error("Expected: '"+e+"' but found: '"+this.input[this.idx]+"' at offset: "+this.idx);if(this.idx>=this.input.length)throw Error("Unexpected end of input");this.idx++}loc(e){return{begin:e,end:this.idx}}}class ij{visitChildren(e){for(let t in e){let r=e[t];e.hasOwnProperty(t)&&(void 0!==r.type?this.visit(r):Array.isArray(r)&&r.forEach(e=>{this.visit(e)},this))}}visit(e){switch(e.type){case"Pattern":this.visitPattern(e);break;case"Flags":this.visitFlags(e);break;case"Disjunction":this.visitDisjunction(e);break;case"Alternative":this.visitAlternative(e);break;case"StartAnchor":this.visitStartAnchor(e);break;case"EndAnchor":this.visitEndAnchor(e);break;case"WordBoundary":this.visitWordBoundary(e);break;case"NonWordBoundary":this.visitNonWordBoundary(e);break;case"Lookahead":this.visitLookahead(e);break;case"NegativeLookahead":this.visitNegativeLookahead(e);break;case"Character":this.visitCharacter(e);break;case"Set":this.visitSet(e);break;case"Group":this.visitGroup(e);break;case"GroupBackReference":this.visitGroupBackReference(e);break;case"Quantifier":this.visitQuantifier(e)}this.visitChildren(e)}visitPattern(e){}visitFlags(e){}visitDisjunction(e){}visitAlternative(e){}visitStartAnchor(e){}visitEndAnchor(e){}visitWordBoundary(e){}visitNonWordBoundary(e){}visitLookahead(e){}visitNegativeLookahead(e){}visitCharacter(e){}visitSet(e){}visitGroup(e){}visitGroupBackReference(e){}visitQuantifier(e){}}let iH={},iW=new iz;function iK(e){let t=e.toString();if(iH.hasOwnProperty(t))return iH[t];{let e=iW.pattern(t);return iH[t]=e,e}}let iX="Complement Sets are not supported for first char optimization",iY='Unable to use "first char" lexer optimizations:\n';function iq(e,t,r){let i=nn(e);t[i]=i,!0===r&&function(e,t){let r=String.fromCharCode(e),i=r.toUpperCase();if(i!==r){let e=nn(i.charCodeAt(0));t[e]=e}else{let e=r.toLowerCase();if(e!==r){let r=nn(e.charCodeAt(0));t[r]=r}}}(e,t)}function iZ(e,t){return rj(e.value,e=>"number"==typeof e?r1(t,e):void 0!==rj(t,t=>e.from<=t&&t<=e.to))}class i$ extends ij{constructor(e){super(),this.targetCharCodes=e,this.found=!1}visitChildren(e){if(!0!==this.found){switch(e.type){case"Lookahead":this.visitLookahead(e);return;case"NegativeLookahead":this.visitNegativeLookahead(e);return}super.visitChildren(e)}}visitCharacter(e){r1(this.targetCharCodes,e.value)&&(this.found=!0)}visitSet(e){e.complement?void 0===iZ(e,this.targetCharCodes)&&(this.found=!0):void 0!==iZ(e,this.targetCharCodes)&&(this.found=!0)}}function iQ(e,t){if(!(t instanceof RegExp))return void 0!==rj(t,t=>r1(e,t.charCodeAt(0)));{let r=iK(t),i=new i$(e);return i.visit(r),i.found}}let iJ="PATTERN",i0="defaultMode",i1="modes",i2="boolean"==typeof RegExp("(?:)").sticky,i3=/[^\\][$]/,i4=/[^\\[][\^]|^\^/;function i5(e){let t=e.ignoreCase?"i":"";return RegExp(`^(?:${e.source})`,t)}function i6(e){let t=e.ignoreCase?"iy":"y";return RegExp(`${e.source}`,t)}function i8(e){let t=e.PATTERN;if(r8(t))return!1;if(Y(t)||r$(t,"exec"))return!0;if(rQ(t))return!1;throw Error("non exhaustive match")}function i9(e){return!!rQ(e)&&1===e.length&&e.charCodeAt(0)}let i7={test:function(e){let t=e.length;for(let r=this.lastIndex;r<t;r++){let t=e.charCodeAt(r);if(10===t)return this.lastIndex=r+1,!0;if(13===t)return 10===e.charCodeAt(r+1)?this.lastIndex=r+2:this.lastIndex=r+1,!0}return!1},lastIndex:0};function ne(e,t){if(r$(e,"LINE_BREAKS"))return!1;if(r8(e.PATTERN)){try{iQ(t,e.PATTERN)}catch(e){return{issue:m.IDENTIFY_TERMINATOR,errMsg:e.message}}return!1}if(rQ(e.PATTERN))return!1;if(i8(e))return{issue:m.CUSTOM_LINE_BREAK};throw Error("non exhaustive match")}function nt(e){return rW(e,e=>rQ(e)?e.charCodeAt(0):e)}function nr(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}let ni=[];function nn(e){return e<256?e:ni[e]}function na(e,t){let r=e.tokenTypeIdx;return r===t.tokenTypeIdx||!0===t.isParent&&!0===t.categoryMatchesMap[r]}function ns(e,t){return e.tokenTypeIdx===t.tokenTypeIdx}let no=1,nl={};function nc(e){let t=function(e){let t=ri(e),r=e,i=!0;for(;i;){let e=rP(r=rn(tT(rW(r,e=>e.CATEGORIES))),t);t=t.concat(e),r5(e)?i=!1:r=e}return t}(e);rU(t,e=>{nu(e)||(nl[no]=e,e.tokenTypeIdx=no++),nh(e)&&!k(e.CATEGORIES)&&(e.CATEGORIES=[e.CATEGORIES]),nh(e)||(e.CATEGORIES=[]),r$(e,"categoryMatches")||(e.categoryMatches=[]),r$(e,"categoryMatchesMap")||(e.categoryMatchesMap={})}),rU(t,e=>{(function e(t,r){rU(t,e=>{r.categoryMatchesMap[e.tokenTypeIdx]=!0}),rU(r.CATEGORIES,i=>{let n=t.concat(r);r1(n,i)||e(n,i)})})([],e)}),rU(t,e=>{e.categoryMatches=[],rU(e.categoryMatchesMap,(t,r)=>{e.categoryMatches.push(nl[r].tokenTypeIdx)})}),rU(t,e=>{e.isParent=e.categoryMatches.length>0})}function nu(e){return r$(e,"tokenTypeIdx")}function nh(e){return r$(e,"CATEGORIES")}function np(e){return r$(e,"tokenTypeIdx")}(h=m||(m={}))[h.MISSING_PATTERN=0]="MISSING_PATTERN",h[h.INVALID_PATTERN=1]="INVALID_PATTERN",h[h.EOI_ANCHOR_FOUND=2]="EOI_ANCHOR_FOUND",h[h.UNSUPPORTED_FLAGS_FOUND=3]="UNSUPPORTED_FLAGS_FOUND",h[h.DUPLICATE_PATTERNS_FOUND=4]="DUPLICATE_PATTERNS_FOUND",h[h.INVALID_GROUP_TYPE_FOUND=5]="INVALID_GROUP_TYPE_FOUND",h[h.PUSH_MODE_DOES_NOT_EXIST=6]="PUSH_MODE_DOES_NOT_EXIST",h[h.MULTI_MODE_LEXER_WITHOUT_DEFAULT_MODE=7]="MULTI_MODE_LEXER_WITHOUT_DEFAULT_MODE",h[h.MULTI_MODE_LEXER_WITHOUT_MODES_PROPERTY=8]="MULTI_MODE_LEXER_WITHOUT_MODES_PROPERTY",h[h.MULTI_MODE_LEXER_DEFAULT_MODE_VALUE_DOES_NOT_EXIST=9]="MULTI_MODE_LEXER_DEFAULT_MODE_VALUE_DOES_NOT_EXIST",h[h.LEXER_DEFINITION_CANNOT_CONTAIN_UNDEFINED=10]="LEXER_DEFINITION_CANNOT_CONTAIN_UNDEFINED",h[h.SOI_ANCHOR_FOUND=11]="SOI_ANCHOR_FOUND",h[h.EMPTY_MATCH_PATTERN=12]="EMPTY_MATCH_PATTERN",h[h.NO_LINE_BREAKS_FLAGS=13]="NO_LINE_BREAKS_FLAGS",h[h.UNREACHABLE_PATTERN=14]="UNREACHABLE_PATTERN",h[h.IDENTIFY_TERMINATOR=15]="IDENTIFY_TERMINATOR",h[h.CUSTOM_LINE_BREAK=16]="CUSTOM_LINE_BREAK",h[h.MULTI_MODE_LEXER_LONGER_ALT_NOT_IN_CURRENT_MODE=17]="MULTI_MODE_LEXER_LONGER_ALT_NOT_IN_CURRENT_MODE";let nd={deferDefinitionErrorsHandling:!1,positionTracking:"full",lineTerminatorsPattern:/\n|\r\n?/g,lineTerminatorCharacters:["\n","\r"],ensureOptimizations:!1,safeMode:!1,errorMessageProvider:{buildUnableToPopLexerModeMessage:e=>`Unable to pop Lexer Mode after encountering Token ->${e.image}<- The Mode Stack is empty`,buildUnexpectedCharactersMessage:(e,t,r,i,n)=>`unexpected character: ->${e.charAt(t)}<- at offset: ${t}, skipped ${r} characters.`},traceInitPerf:!1,skipValidations:!1,recoveryEnabled:!0};Object.freeze(nd);class nf{constructor(e,t=nd){if(this.lexerDefinition=e,this.lexerDefinitionErrors=[],this.lexerDefinitionWarning=[],this.patternIdxToConfig={},this.charCodeToPatternIdxToConfig={},this.modes=[],this.emptyGroups={},this.trackStartLines=!0,this.trackEndLines=!0,this.hasCustom=!1,this.canModeBeOptimized={},this.TRACE_INIT=(e,t)=>{if(!0!==this.traceInitPerf)return t();{this.traceInitIndent++;let r=Array(this.traceInitIndent+1).join("	");this.traceInitIndent<this.traceInitMaxIdent&&console.log(`${r}--> <${e}>`);let{time:i,value:n}=iu(t),a=i>10?console.warn:console.log;return this.traceInitIndent<this.traceInitMaxIdent&&a(`${r}<-- <${e}> time: ${i}ms`),this.traceInitIndent--,n}},"boolean"==typeof t)throw Error("The second argument to the Lexer constructor is now an ILexerConfig Object.\na boolean 2nd argument is no longer supported");this.config=e2({},nd,t);let r=this.config.traceInitPerf;!0===r?(this.traceInitMaxIdent=1/0,this.traceInitPerf=!0):"number"==typeof r&&(this.traceInitMaxIdent=r,this.traceInitPerf=!0),this.traceInitIndent=-1,this.TRACE_INIT("Lexer Constructor",()=>{let r;let i=!0;this.TRACE_INIT("Lexer Config handling",()=>{if(this.config.lineTerminatorsPattern===nd.lineTerminatorsPattern)this.config.lineTerminatorsPattern=i7;else if(this.config.lineTerminatorCharacters===nd.lineTerminatorCharacters)throw Error("Error: Missing <lineTerminatorCharacters> property on the Lexer config.\n	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#MISSING_LINE_TERM_CHARS");if(t.safeMode&&t.ensureOptimizations)throw Error('"safeMode" and "ensureOptimizations" flags are mutually exclusive.');this.trackStartLines=/full|onlyStart/i.test(this.config.positionTracking),this.trackEndLines=/full/i.test(this.config.positionTracking),k(e)?r={modes:{defaultMode:ri(e)},defaultMode:i0}:(i=!1,r=ri(e))}),!1===this.config.skipValidations&&(this.TRACE_INIT("performRuntimeChecks",()=>{this.lexerDefinitionErrors=this.lexerDefinitionErrors.concat(function(e,t,r){let i=[];return r$(e,i0)||i.push({message:"A MultiMode Lexer cannot be initialized without a <"+i0+"> property in its definition\n",type:m.MULTI_MODE_LEXER_WITHOUT_DEFAULT_MODE}),r$(e,i1)||i.push({message:"A MultiMode Lexer cannot be initialized without a <"+i1+"> property in its definition\n",type:m.MULTI_MODE_LEXER_WITHOUT_MODES_PROPERTY}),r$(e,i1)&&r$(e,i0)&&!r$(e.modes,e.defaultMode)&&i.push({message:`A MultiMode Lexer cannot be initialized with a ${i0}: <${e.defaultMode}>which does not exist
`,type:m.MULTI_MODE_LEXER_DEFAULT_MODE_VALUE_DOES_NOT_EXIST}),r$(e,i1)&&rU(e.modes,(e,t)=>{rU(e,(r,n)=>{r9(r)?i.push({message:`A Lexer cannot be initialized using an undefined Token Type. Mode:<${t}> at index: <${n}>
`,type:m.LEXER_DEFINITION_CANNOT_CONTAIN_UNDEFINED}):r$(r,"LONGER_ALT")&&rU(k(r.LONGER_ALT)?r.LONGER_ALT:[r.LONGER_ALT],n=>{r9(n)||r1(e,n)||i.push({message:`A MultiMode Lexer cannot be initialized with a longer_alt <${n.name}> on token <${r.name}> outside of mode <${t}>
`,type:m.MULTI_MODE_LEXER_LONGER_ALT_NOT_IN_CURRENT_MODE})})})}),i}(r,this.trackStartLines,this.config.lineTerminatorCharacters))}),this.TRACE_INIT("performWarningRuntimeChecks",()=>{this.lexerDefinitionWarning=this.lexerDefinitionWarning.concat(function(e,t,r){let i=[],n=!1,a=ir(rn(tT(rJ(e.modes))),e=>e[iJ]===nf.NA),s=nt(r);return t&&rU(a,e=>{let t=ne(e,s);if(!1!==t){let r={message:function(e,t){if(t.issue===m.IDENTIFY_TERMINATOR)return`Warning: unable to identify line terminator usage in pattern.
	The problem is in the <${e.name}> Token Type
	 Root cause: ${t.errMsg}.
	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#IDENTIFY_TERMINATOR`;if(t.issue===m.CUSTOM_LINE_BREAK)return`Warning: A Custom Token Pattern should specify the <line_breaks> option.
	The problem is in the <${e.name}> Token Type
	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#CUSTOM_LINE_BREAK`;throw Error("non exhaustive match")}(e,t),type:t.issue,tokenType:e};i.push(r)}else r$(e,"LINE_BREAKS")?!0===e.LINE_BREAKS&&(n=!0):iQ(s,e.PATTERN)&&(n=!0)}),t&&!n&&i.push({message:"Warning: No LINE_BREAKS Found.\n	This Lexer has been defined to track line and column information,\n	But none of the Token Types can be identified as matching a line terminator.\n	See https://chevrotain.io/docs/guide/resolving_lexer_errors.html#LINE_BREAKS \n	for details.",type:m.NO_LINE_BREAKS_FLAGS}),i}(r,this.trackStartLines,this.config.lineTerminatorCharacters))})),r.modes=r.modes?r.modes:{},rU(r.modes,(e,t)=>{r.modes[t]=ir(e,e=>r9(e))});let n=e0(r.modes);if(rU(r.modes,(e,r)=>{this.TRACE_INIT(`Mode: <${r}> processing`,()=>{if(this.modes.push(r),!1===this.config.skipValidations&&this.TRACE_INIT("validatePatterns",()=>{this.lexerDefinitionErrors=this.lexerDefinitionErrors.concat(function(e,t){let r=[],i=function(e){let t=rG(e,e=>!r$(e,iJ));return{errors:rW(t,e=>({message:"Token Type: ->"+e.name+"<- missing static 'PATTERN' property",type:m.MISSING_PATTERN,tokenTypes:[e]})),valid:rP(e,t)}}(e);r=r.concat(i.errors);let n=function(e){let t=rG(e,e=>{let t=e[iJ];return!r8(t)&&!Y(t)&&!r$(t,"exec")&&!rQ(t)});return{errors:rW(t,e=>({message:"Token Type: ->"+e.name+"<- static 'PATTERN' can only be a RegExp, a Function matching the {CustomPatternMatcherFunc} type or an Object matching the {ICustomPattern} interface.",type:m.INVALID_PATTERN,tokenTypes:[e]})),valid:rP(e,t)}}(i.valid),a=n.valid;return(r=(r=(r=(r=r.concat(n.errors)).concat(function(e){let t=[],r=rG(e,e=>r8(e[iJ]));return(t=(t=(t=(t=t.concat(function(e){class t extends ij{constructor(){super(...arguments),this.found=!1}visitEndAnchor(e){this.found=!0}}return rW(rG(e,e=>{let r=e.PATTERN;try{let e=iK(r),i=new t;return i.visit(e),i.found}catch(e){return i3.test(r.source)}}),e=>({message:"Unexpected RegExp Anchor Error:\n	Token Type: ->"+e.name+"<- static 'PATTERN' cannot contain end of input anchor '$'\n	See chevrotain.io/docs/guide/resolving_lexer_errors.html#ANCHORS	for details.",type:m.EOI_ANCHOR_FOUND,tokenTypes:[e]}))}(r))).concat(function(e){class t extends ij{constructor(){super(...arguments),this.found=!1}visitStartAnchor(e){this.found=!0}}return rW(rG(e,e=>{let r=e.PATTERN;try{let e=iK(r),i=new t;return i.visit(e),i.found}catch(e){return i4.test(r.source)}}),e=>({message:"Unexpected RegExp Anchor Error:\n	Token Type: ->"+e.name+"<- static 'PATTERN' cannot contain start of input anchor '^'\n	See https://chevrotain.io/docs/guide/resolving_lexer_errors.html#ANCHORS	for details.",type:m.SOI_ANCHOR_FOUND,tokenTypes:[e]}))}(r))).concat(rW(rG(r,e=>{let t=e[iJ];return t instanceof RegExp&&(t.multiline||t.global)}),e=>({message:"Token Type: ->"+e.name+"<- static 'PATTERN' may NOT contain global('g') or multiline('m')",type:m.UNSUPPORTED_FLAGS_FOUND,tokenTypes:[e]})))).concat(function(e){let t=[],r=rW(e,r=>it(e,(e,i)=>(r.PATTERN.source!==i.PATTERN.source||r1(t,i)||i.PATTERN===nf.NA||(t.push(i),e.push(i)),e),[]));return rW(rG(r=rn(r),e=>e.length>1),e=>{let t=rW(e,e=>e.name),r=rH(e).PATTERN;return{message:`The same RegExp pattern ->${r}<-has been used in all of the following Token Types: ${t.join(", ")} <-`,type:m.DUPLICATE_PATTERNS_FOUND,tokenTypes:e}})}(r))).concat(rW(rG(r,e=>e.PATTERN.test("")),e=>({message:"Token Type: ->"+e.name+"<- static 'PATTERN' must not match an empty string",type:m.EMPTY_MATCH_PATTERN,tokenTypes:[e]})))}(a))).concat(rW(rG(a,e=>{if(!r$(e,"GROUP"))return!1;let t=e.GROUP;return t!==nf.SKIPPED&&t!==nf.NA&&!rQ(t)}),e=>({message:"Token Type: ->"+e.name+"<- static 'GROUP' can only be Lexer.SKIPPED/Lexer.NA/A String",type:m.INVALID_GROUP_TYPE_FOUND,tokenTypes:[e]})))).concat(rW(rG(a,e=>void 0!==e.PUSH_MODE&&!r1(t,e.PUSH_MODE)),e=>({message:`Token Type: ->${e.name}<- static 'PUSH_MODE' value cannot refer to a Lexer Mode ->${e.PUSH_MODE}<-which does not exist`,type:m.PUSH_MODE_DOES_NOT_EXIST,tokenTypes:[e]})))).concat(function(e){let t=[],r=it(e,(e,t,r)=>{let i=t.PATTERN;return i===nf.NA||(rQ(i)?e.push({str:i,idx:r,tokenType:t}):r8(i)&&void 0===rj([".","\\","[","]","|","^","$","(",")","?","*","+","{"],e=>-1!==i.source.indexOf(e))&&e.push({str:i.source,idx:r,tokenType:t})),e},[]);return rU(e,(e,i)=>{rU(r,({str:r,idx:n,tokenType:a})=>{if(i<n&&function(e,t){if(r8(t)){let r=t.exec(e);return null!==r&&0===r.index}if(Y(t))return t(e,0,[],{});if(r$(t,"exec"))return t.exec(e,0,[],{});if("string"==typeof t)return t===e;throw Error("non exhaustive match")}(r,e.PATTERN)){let r=`Token: ->${a.name}<- can never be matched.
Because it appears AFTER the Token Type ->${e.name}<-in the lexer's definition.
See https://chevrotain.io/docs/guide/resolving_lexer_errors.html#UNREACHABLE`;t.push({message:r,type:m.UNREACHABLE_PATTERN,tokenTypes:[e,a]})}})}),t}(a))}(e,n))}),r5(this.lexerDefinitionErrors)){let i;nc(e),this.TRACE_INIT("analyzeTokenTypes",()=>{i=function(e,t){let r,i,n,a,s,o,l,c,u,h,p,d;let f=(t=rI(t,{useSticky:i2,debug:!1,safeMode:!1,positionTracking:"full",lineTerminatorCharacters:["\r","\n"],tracer:(e,t)=>t()})).tracer;f("initCharCodeToOptimizedIndexMap",()=>{(function(){if(r5(ni)){ni=Array(65536);for(let e=0;e<65536;e++)ni[e]=e>255?255+~~(e/255):e}})()}),f("Reject Lexer.NA",()=>{r=ir(e,e=>e[iJ]===nf.NA)});let m=!1;f("Transform Patterns",()=>{m=!1,i=rW(r,e=>{let r=e[iJ];if(r8(r)){let e=r.source;return 1!==e.length||"^"===e||"$"===e||"."===e||r.ignoreCase?2!==e.length||"\\"!==e[0]||r1(["d","D","s","S","t","r","n","t","0","c","b","B","f","v","w","W"],e[1])?t.useSticky?i6(r):i5(r):e[1]:e}if(Y(r))return m=!0,{exec:r};if("object"==typeof r)return m=!0,r;if("string"==typeof r){if(1===r.length)return r;{let e=new RegExp(r.replace(/[\\^$.*+?()[\]{}|]/g,"\\$&"));return t.useSticky?i6(e):i5(e)}}throw Error("non exhaustive match")})}),f("misc mapping",()=>{n=rW(r,e=>e.tokenTypeIdx),a=rW(r,e=>{let t=e.GROUP;if(t!==nf.SKIPPED){if(rQ(t))return t;if(r9(t))return!1;throw Error("non exhaustive match")}}),s=rW(r,e=>{let t=e.LONGER_ALT;if(t)return k(t)?rW(t,e=>r3(r,e)):[r3(r,t)]}),o=rW(r,e=>e.PUSH_MODE),l=rW(r,e=>r$(e,"POP_MODE"))}),f("Line Terminator Handling",()=>{let e=nt(t.lineTerminatorCharacters);c=rW(r,e=>!1),"onlyOffset"!==t.positionTracking&&(c=rW(r,t=>r$(t,"LINE_BREAKS")?!!t.LINE_BREAKS:!1===ne(t,e)&&iQ(e,t.PATTERN)))}),f("Misc Mapping #2",()=>{u=rW(r,i8),h=rW(i,i9),p=it(r,(e,t)=>{let r=t.GROUP;return rQ(r)&&r!==nf.SKIPPED&&(e[r]=[]),e},{}),d=rW(i,(e,t)=>({pattern:i[t],longerAlt:s[t],canLineTerminator:c[t],isCustom:u[t],short:h[t],group:a[t],push:o[t],pop:l[t],tokenTypeIdx:n[t],tokenType:r[t]}))});let g=!0,v=[];return t.safeMode||f("First Char Optimization",()=>{v=it(r,(e,r,i)=>{if("string"==typeof r.PATTERN)nr(e,nn(r.PATTERN.charCodeAt(0)),d[i]);else if(k(r.START_CHARS_HINT)){let t;rU(r.START_CHARS_HINT,r=>{let n=nn("string"==typeof r?r.charCodeAt(0):r);t!==n&&(t=n,nr(e,n,d[i]))})}else if(r8(r.PATTERN)){if(r.PATTERN.unicode)g=!1,t.ensureOptimizations&&il(`${iY}	Unable to analyze < ${r.PATTERN.toString()} > pattern.
	The regexp unicode flag is not currently supported by the regexp-to-ast library.
	This will disable the lexer's first char optimizations.
	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#UNICODE_OPTIMIZE`);else{let n=function(e,t=!1){try{let t=iK(e);return function e(t,r,i){switch(t.type){case"Disjunction":for(let n=0;n<t.value.length;n++)e(t.value[n],r,i);break;case"Alternative":let n=t.value;for(let t=0;t<n.length;t++){let a=n[t];switch(a.type){case"EndAnchor":case"GroupBackReference":case"Lookahead":case"NegativeLookahead":case"StartAnchor":case"WordBoundary":case"NonWordBoundary":continue}switch(a.type){case"Character":iq(a.value,r,i);break;case"Set":if(!0===a.complement)throw Error(iX);rU(a.value,e=>{if("number"==typeof e)iq(e,r,i);else if(!0===i)for(let t=e.from;t<=e.to;t++)iq(t,r,i);else{for(let t=e.from;t<=e.to&&t<256;t++)iq(t,r,i);if(e.to>=256){let t=e.from>=256?e.from:256,i=e.to,n=nn(t),a=nn(i);for(let e=n;e<=a;e++)r[e]=e}}});break;case"Group":e(a.value,r,i);break;default:throw Error("Non Exhaustive Match")}let s=void 0!==a.quantifier&&0===a.quantifier.atLeast;if("Group"===a.type&&!1===function e(t){let r=t.quantifier;return!!r&&0===r.atLeast||!!t.value&&(k(t.value)?rB(t.value,e):e(t.value))}(a)||"Group"!==a.type&&!1===s)break}break;default:throw Error("non exhaustive match!")}return rJ(r)}(t.value,{},t.flags.ignoreCase)}catch(r){if(r.message===iX)t&&ic(`${iY}	Unable to optimize: < ${e.toString()} >
	Complement Sets cannot be automatically optimized.
	This will disable the lexer's first char optimizations.
	See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#COMPLEMENT for details.`);else{let r="";t&&(r="\n	This will disable the lexer's first char optimizations.\n	See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#REGEXP_PARSING for details."),il(`${iY}
	Failed parsing: < ${e.toString()} >
	Using the @chevrotain/regexp-to-ast library
	Please open an issue at: https://github.com/chevrotain/chevrotain/issues`+r)}}return[]}(r.PATTERN,t.ensureOptimizations);r5(n)&&(g=!1),rU(n,t=>{nr(e,t,d[i])})}}else t.ensureOptimizations&&il(`${iY}	TokenType: <${r.name}> is using a custom token pattern without providing <start_chars_hint> parameter.
	This will disable the lexer's first char optimizations.
	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#CUSTOM_OPTIMIZE`),g=!1;return e},[])}),{emptyGroups:p,patternIdxToConfig:d,charCodeToPatternIdxToConfig:v,hasCustom:m,canBeOptimized:g}}(e,{lineTerminatorCharacters:this.config.lineTerminatorCharacters,positionTracking:t.positionTracking,ensureOptimizations:t.ensureOptimizations,safeMode:t.safeMode,tracer:this.TRACE_INIT})}),this.patternIdxToConfig[r]=i.patternIdxToConfig,this.charCodeToPatternIdxToConfig[r]=i.charCodeToPatternIdxToConfig,this.emptyGroups=e2({},this.emptyGroups,i.emptyGroups),this.hasCustom=i.hasCustom||this.hasCustom,this.canModeBeOptimized[r]=i.canBeOptimized}})}),this.defaultMode=r.defaultMode,!r5(this.lexerDefinitionErrors)&&!this.config.deferDefinitionErrorsHandling)throw Error("Errors detected in definition of Lexer:\n"+rW(this.lexerDefinitionErrors,e=>e.message).join("-----------------------\n"));rU(this.lexerDefinitionWarning,e=>{ic(e.message)}),this.TRACE_INIT("Choosing sub-methods implementations",()=>{if(i2?(this.chopInput=X,this.match=this.matchWithTest):(this.updateLastIndex=el,this.match=this.matchWithExec),i&&(this.handleModes=el),!1===this.trackStartLines&&(this.computeNewColumn=X),!1===this.trackEndLines&&(this.updateTokenEndLineColumnLocation=el),/full/i.test(this.config.positionTracking))this.createTokenInstance=this.createFullToken;else if(/onlyStart/i.test(this.config.positionTracking))this.createTokenInstance=this.createStartOnlyToken;else if(/onlyOffset/i.test(this.config.positionTracking))this.createTokenInstance=this.createOffsetOnlyToken;else throw Error(`Invalid <positionTracking> config option: "${this.config.positionTracking}"`);this.hasCustom?(this.addToken=this.addTokenUsingPush,this.handlePayload=this.handlePayloadWithCustom):(this.addToken=this.addTokenUsingMemberAccess,this.handlePayload=this.handlePayloadNoCustom)}),this.TRACE_INIT("Failed Optimization Warnings",()=>{let e=it(this.canModeBeOptimized,(e,t,r)=>(!1===t&&e.push(r),e),[]);if(t.ensureOptimizations&&!r5(e))throw Error(`Lexer Modes: < ${e.join(", ")} > cannot be optimized.
	 Disable the "ensureOptimizations" lexer config flag to silently ignore this and run the lexer in an un-optimized mode.
	 Or inspect the console log for details on how to resolve these issues.`)}),this.TRACE_INIT("clearRegExpParserCache",()=>{iH={}}),this.TRACE_INIT("toFastProperties",()=>{ih(this)})})}tokenize(e,t=this.defaultMode){if(!r5(this.lexerDefinitionErrors))throw Error("Unable to Tokenize because Errors detected in definition of Lexer:\n"+rW(this.lexerDefinitionErrors,e=>e.message).join("-----------------------\n"));return this.tokenizeInternal(e,t)}tokenizeInternal(e,t){let r,i,n,a,s,o,l,c,u,h,p,d,f,m,g,v,y;let x=e,T=x.length,b=0,S=0,E=Array(this.hasCustom?0:Math.floor(e.length/10)),R=[],A=this.trackStartLines?1:void 0,w=this.trackStartLines?1:void 0,M=function(e){let t={};return rU(e0(e),r=>{if(k(e[r]))t[r]=[];else throw Error("non exhaustive match")}),t}(this.emptyGroups),C=this.trackStartLines,I=this.config.lineTerminatorsPattern,N=0,O=[],P=[],_=[],L=[];function U(){return O}function D(e){let t=P[nn(e)];return void 0===t?L:t}Object.freeze(L);let F=e=>{if(1===_.length&&void 0===e.tokenType.PUSH_MODE){let t=this.config.errorMessageProvider.buildUnableToPopLexerModeMessage(e);R.push({offset:e.startOffset,line:e.startLine,column:e.startColumn,length:e.image.length,message:t})}else{_.pop();let e=rk(_);O=this.patternIdxToConfig[e],P=this.charCodeToPatternIdxToConfig[e],N=O.length;let t=this.canModeBeOptimized[e]&&!1===this.config.safeMode;v=P&&t?D:U}};function B(e){_.push(e),P=this.charCodeToPatternIdxToConfig[e],N=(O=this.patternIdxToConfig[e]).length,N=O.length;let t=this.canModeBeOptimized[e]&&!1===this.config.safeMode;v=P&&t?D:U}B.call(this,t);let V=this.config.recoveryEnabled;for(;b<T;){o=null;let t=x.charCodeAt(b),P=v(t),k=P.length;for(r=0;r<k;r++){let i=(y=P[r]).pattern;l=null;let u=y.short;if(!1!==u?t===u&&(o=i):!0===y.isCustom?null!==(g=i.exec(x,b,E,M))?(o=g[0],void 0!==g.payload&&(l=g.payload)):o=null:(this.updateLastIndex(i,b),o=this.match(i,e,b)),null!==o){if(void 0!==(s=y.longerAlt)){let t=s.length;for(n=0;n<t;n++){let t=O[s[n]],r=t.pattern;if(c=null,!0===t.isCustom?null!==(g=r.exec(x,b,E,M))?(a=g[0],void 0!==g.payload&&(c=g.payload)):a=null:(this.updateLastIndex(r,b),a=this.match(r,e,b)),a&&a.length>o.length){o=a,l=c,y=t;break}}}break}}if(null!==o){if(u=o.length,void 0!==(h=y.group)&&(p=y.tokenTypeIdx,d=this.createTokenInstance(o,b,p,y.tokenType,A,w,u),this.handlePayload(d,l),!1===h?S=this.addToken(E,S,d):M[h].push(d)),e=this.chopInput(e,u),b+=u,w=this.computeNewColumn(w,u),!0===C&&!0===y.canLineTerminator){let e,t,r=0;I.lastIndex=0;do!0===(e=I.test(o))&&(t=I.lastIndex-1,r++);while(!0===e);0!==r&&(A+=r,w=u-t,this.updateTokenEndLineColumnLocation(d,h,t,r,A,w,u))}this.handleModes(y,F,B,d)}else{let t=b,r=A,n=w,a=!1===V;for(;!1===a&&b<T;)for(e=this.chopInput(e,1),b++,i=0;i<N;i++){let t=O[i],r=t.pattern,n=t.short;if(!1!==n?x.charCodeAt(b)===n&&(a=!0):!0===t.isCustom?a=null!==r.exec(x,b,E,M):(this.updateLastIndex(r,b),a=null!==r.exec(e)),!0===a)break}if(f=b-t,w=this.computeNewColumn(w,f),m=this.config.errorMessageProvider.buildUnexpectedCharactersMessage(x,t,f,r,n),R.push({offset:t,line:r,column:n,length:f,message:m}),!1===V)break}}return this.hasCustom||(E.length=S),{tokens:E,groups:M,errors:R}}handleModes(e,t,r,i){if(!0===e.pop){let n=e.push;t(i),void 0!==n&&r.call(this,n)}else void 0!==e.push&&r.call(this,e.push)}chopInput(e,t){return e.substring(t)}updateLastIndex(e,t){e.lastIndex=t}updateTokenEndLineColumnLocation(e,t,r,i,n,a,s){let o,l;void 0===t||(l=(o=r===s-1)?-1:0,1===i&&!0===o||(e.endLine=n+l,e.endColumn=a-1+-l))}computeNewColumn(e,t){return e+t}createOffsetOnlyToken(e,t,r,i){return{image:e,startOffset:t,tokenTypeIdx:r,tokenType:i}}createStartOnlyToken(e,t,r,i,n,a){return{image:e,startOffset:t,startLine:n,startColumn:a,tokenTypeIdx:r,tokenType:i}}createFullToken(e,t,r,i,n,a,s){return{image:e,startOffset:t,endOffset:t+s-1,startLine:n,endLine:n,startColumn:a,endColumn:a+s-1,tokenTypeIdx:r,tokenType:i}}addTokenUsingPush(e,t,r){return e.push(r),t}addTokenUsingMemberAccess(e,t,r){return e[t]=r,++t}handlePayloadNoCustom(e,t){}handlePayloadWithCustom(e,t){null!==t&&(e.payload=t)}matchWithTest(e,t,r){return!0===e.test(t)?t.substring(r,e.lastIndex):null}matchWithExec(e,t){let r=e.exec(t);return null!==r?r[0]:null}}function nm(e){return ng(e)?e.LABEL:e.name}function ng(e){return rQ(e.LABEL)&&""!==e.LABEL}nf.SKIPPED="This marks a skipped Token pattern, this means each token identified by it willbe consumed and then thrown into oblivion, this can be used to for example to completely ignore whitespace.",nf.NA=/NOT_APPLICABLE/;let nv="categories",ny="label",nx="group",nT="push_mode",nb="pop_mode",nS="longer_alt",nE="line_breaks",nR="start_chars_hint";function nA(e){let t=e.pattern,r={};if(r.name=e.name,r9(t)||(r.PATTERN=t),r$(e,"parent"))throw"The parent property is no longer supported.\nSee: https://github.com/chevrotain/chevrotain/issues/564#issuecomment-349062346 for details.";return r$(e,nv)&&(r.CATEGORIES=e[nv]),nc([r]),r$(e,ny)&&(r.LABEL=e[ny]),r$(e,nx)&&(r.GROUP=e[nx]),r$(e,nb)&&(r.POP_MODE=e[nb]),r$(e,nT)&&(r.PUSH_MODE=e[nT]),r$(e,nS)&&(r.LONGER_ALT=e[nS]),r$(e,nE)&&(r.LINE_BREAKS=e[nE]),r$(e,nR)&&(r.START_CHARS_HINT=e[nR]),r}let nw=nA({name:"EOF",pattern:nf.NA});function nM(e,t,r,i,n,a,s,o){return{image:t,startOffset:r,endOffset:i,startLine:n,endLine:a,startColumn:s,endColumn:o,tokenTypeIdx:e.tokenTypeIdx,tokenType:e}}nc([nw]);let nC={buildMismatchTokenMessage({expected:e,actual:t,previous:r,ruleName:i}){let n=ng(e)?`--> ${nm(e)} <--`:`token of type --> ${e.name} <--`;return`Expecting ${n} but found --> '${t.image}' <--`},buildNotAllInputParsedMessage:({firstRedundant:e,ruleName:t})=>"Redundant input, expecting EOF but found: "+e.image,buildNoViableAltMessage({expectedPathsPerAlt:e,actual:t,previous:r,customUserDescription:i,ruleName:n}){let a="Expecting: ",s="\nbut found: '"+rH(t).image+"'";if(i)return a+i+s;{let t=rW(it(e,(e,t)=>e.concat(t),[]),e=>`[${rW(e,e=>nm(e)).join(", ")}]`),r=rW(t,(e,t)=>`  ${t+1}. ${e}`);return a+`one of these possible Token sequences:
${r.join("\n")}`+s}},buildEarlyExitMessage({expectedIterationPaths:e,actual:t,customUserDescription:r,ruleName:i}){let n="Expecting: ",a="\nbut found: '"+rH(t).image+"'";if(r)return n+r+a;{let t=rW(e,e=>`[${rW(e,e=>nm(e)).join(",")}]`);return n+`expecting at least one iteration which starts with one of these possible Token sequences::
  <${t.join(" ,")}>`+a}}};Object.freeze(nC);let nI={buildRuleNotFoundError:(e,t)=>"Invalid grammar, reference to a rule which is not defined: ->"+t.nonTerminalName+"<-\ninside top level rule: ->"+e.name+"<-"},nN={buildDuplicateFoundError(e,t){let r=e.name,i=rH(t),n=i.idx,a=iA(i),s=i instanceof iS?i.terminalType.name:i instanceof id?i.nonTerminalName:"",o=`->${a}${n>0?n:""}<- ${s?`with argument: ->${s}<-`:""}
                  appears more than once (${t.length} times) in the top level rule: ->${r}<-.                  
                  For further details see: https://chevrotain.io/docs/FAQ.html#NUMERICAL_SUFFIXES 
                  `;return(o=o.replace(/[ \t]+/g," ")).replace(/\s\s+/g,"\n")},buildNamespaceConflictError:e=>`Namespace conflict found in grammar.
The grammar has both a Terminal(Token) and a Non-Terminal(Rule) named: <${e.name}>.
To resolve this make sure each Terminal and Non-Terminal names are unique
This is easy to accomplish by using the convention that Terminal names start with an uppercase letter
and Non-Terminal names start with a lower case letter.`,buildAlternationPrefixAmbiguityError(e){let t=rW(e.prefixPath,e=>nm(e)).join(", "),r=0===e.alternation.idx?"":e.alternation.idx;return`Ambiguous alternatives: <${e.ambiguityIndices.join(" ,")}> due to common lookahead prefix
in <OR${r}> inside <${e.topLevelRule.name}> Rule,
<${t}> may appears as a prefix path in all these alternatives.
See: https://chevrotain.io/docs/guide/resolving_grammar_errors.html#COMMON_PREFIX
For Further details.`},buildAlternationAmbiguityError(e){let t=rW(e.prefixPath,e=>nm(e)).join(", "),r=0===e.alternation.idx?"":e.alternation.idx;return`Ambiguous Alternatives Detected: <${e.ambiguityIndices.join(" ,")}> in <OR${r}> inside <${e.topLevelRule.name}> Rule,
<${t}> may appears as a prefix path in all these alternatives.
See: https://chevrotain.io/docs/guide/resolving_grammar_errors.html#AMBIGUOUS_ALTERNATIVES
For Further details.`},buildEmptyRepetitionError(e){let t=iA(e.repetition);return 0!==e.repetition.idx&&(t+=e.repetition.idx),`The repetition <${t}> within Rule <${e.topLevelRule.name}> can never consume any tokens.
This could lead to an infinite loop.`},buildTokenNameError:e=>"deprecated",buildEmptyAlternationError:e=>`Ambiguous empty alternative: <${e.emptyChoiceIdx+1}> in <OR${e.alternation.idx}> inside <${e.topLevelRule.name}> Rule.
Only the last alternative may be an empty alternative.`,buildTooManyAlternativesError:e=>`An Alternation cannot have more than 256 alternatives:
<OR${e.alternation.idx}> inside <${e.topLevelRule.name}> Rule.
 has ${e.alternation.definition.length+1} alternatives.`,buildLeftRecursionError(e){let t=e.topLevelRule.name,r=rW(e.leftRecursionPath,e=>e.name),i=`${t} --> ${r.concat([t]).join(" --> ")}`;return`Left Recursion found in grammar.
rule: <${t}> can be invoked from itself (directly or indirectly)
without consuming any Tokens. The grammar path that causes this is: 
 ${i}
 To fix this refactor your grammar to remove the left recursion.
see: https://en.wikipedia.org/wiki/LL_parser#Left_factoring.`},buildInvalidRuleNameError:e=>"deprecated",buildDuplicateRuleNameError(e){let t;return t=e.topLevelRule instanceof im?e.topLevelRule.name:e.topLevelRule,`Duplicate definition, rule: ->${t}<- is already defined in the grammar: ->${e.grammarName}<-`}};class nO extends iE{constructor(e,t){super(),this.nameToTopRule=e,this.errMsgProvider=t,this.errors=[]}resolveRefs(){rU(rJ(this.nameToTopRule),e=>{this.currTopLevel=e,e.accept(this)})}visitNonTerminal(e){let t=this.nameToTopRule[e.nonTerminalName];if(t)e.referencedRule=t;else{let t=this.errMsgProvider.buildRuleNotFoundError(this.currTopLevel,e);this.errors.push({message:t,type:y.UNRESOLVED_SUBRULE_REF,ruleName:this.currTopLevel.name,unresolvedRefName:e.nonTerminalName})}}}class nP extends iw{constructor(e,t){super(),this.topProd=e,this.path=t,this.possibleTokTypes=[],this.nextProductionName="",this.nextProductionOccurrence=0,this.found=!1,this.isAtEndOfPath=!1}startWalking(){if(this.found=!1,this.path.ruleStack[0]!==this.topProd.name)throw Error("The path does not start with the walker's top Rule!");return this.ruleStack=ri(this.path.ruleStack).reverse(),this.occurrenceStack=ri(this.path.occurrenceStack).reverse(),this.ruleStack.pop(),this.occurrenceStack.pop(),this.updateExpectedNext(),this.walk(this.topProd),this.possibleTokTypes}walk(e,t=[]){this.found||super.walk(e,t)}walkProdRef(e,t,r){if(e.referencedRule.name===this.nextProductionName&&e.idx===this.nextProductionOccurrence){let i=t.concat(r);this.updateExpectedNext(),this.walk(e.referencedRule,i)}}updateExpectedNext(){r5(this.ruleStack)?(this.nextProductionName="",this.nextProductionOccurrence=0,this.isAtEndOfPath=!0):(this.nextProductionName=this.ruleStack.pop(),this.nextProductionOccurrence=this.occurrenceStack.pop())}}class nk extends nP{constructor(e,t){super(e,t),this.path=t,this.nextTerminalName="",this.nextTerminalOccurrence=0,this.nextTerminalName=this.path.lastTok.name,this.nextTerminalOccurrence=this.path.lastTokOccurrence}walkTerminal(e,t,r){if(this.isAtEndOfPath&&e.terminalType.name===this.nextTerminalName&&e.idx===this.nextTerminalOccurrence&&!this.found){let e=new ig({definition:t.concat(r)});this.possibleTokTypes=iC(e),this.found=!0}}}class n_ extends iw{constructor(e,t){super(),this.topRule=e,this.occurrence=t,this.result={token:void 0,occurrence:void 0,isEndOfRule:void 0}}startWalking(){return this.walk(this.topRule),this.result}}class nL extends n_{walkMany(e,t,r){if(e.idx===this.occurrence){let e=rH(t.concat(r));this.result.isEndOfRule=void 0===e,e instanceof iS&&(this.result.token=e.terminalType,this.result.occurrence=e.idx)}else super.walkMany(e,t,r)}}class nU extends n_{walkManySep(e,t,r){if(e.idx===this.occurrence){let e=rH(t.concat(r));this.result.isEndOfRule=void 0===e,e instanceof iS&&(this.result.token=e.terminalType,this.result.occurrence=e.idx)}else super.walkManySep(e,t,r)}}class nD extends n_{walkAtLeastOne(e,t,r){if(e.idx===this.occurrence){let e=rH(t.concat(r));this.result.isEndOfRule=void 0===e,e instanceof iS&&(this.result.token=e.terminalType,this.result.occurrence=e.idx)}else super.walkAtLeastOne(e,t,r)}}class nF extends n_{walkAtLeastOneSep(e,t,r){if(e.idx===this.occurrence){let e=rH(t.concat(r));this.result.isEndOfRule=void 0===e,e instanceof iS&&(this.result.token=e.terminalType,this.result.occurrence=e.idx)}else super.walkAtLeastOneSep(e,t,r)}}function nB(e,t,r=[]){r=ri(r);let i=[],n=0;function a(a){let s=nB(a.concat(r_(e,n+1)),t,r);return i.concat(s)}for(;r.length<t&&n<e.length;){let t=e[n];if(t instanceof ig||t instanceof id)return a(t.definition);if(t instanceof Option)i=a(t.definition);else if(t instanceof iv)return a(t.definition.concat([new ix({definition:t.definition})]));else if(t instanceof iy)return a([new ig({definition:t.definition}),new ix({definition:[new iS({terminalType:t.separator})].concat(t.definition)})]);else if(t instanceof iT)i=a(t.definition.concat([new ix({definition:[new iS({terminalType:t.separator})].concat(t.definition)})]));else if(t instanceof ix)i=a(t.definition.concat([new ix({definition:t.definition})]));else if(t instanceof ib)return rU(t.definition,e=>{!1===r5(e.definition)&&(i=a(e.definition))}),i;else if(t instanceof iS)r.push(t.terminalType);else throw Error("non exhaustive match");n++}return i.push({partialPath:r,suffixDef:r_(e,n)}),i}function nV(e,t,r,i){let n="EXIT_NONE_TERMINAL",a=[n],s="EXIT_ALTERNATIVE",o=!1,l=t.length,c=l-i-1,u=[],h=[];for(h.push({idx:-1,def:e,ruleStack:[],occurrenceStack:[]});!r5(h);){let e=h.pop();if(e===s){o&&rk(h).idx<=c&&h.pop();continue}let i=e.def,p=e.idx,d=e.ruleStack,f=e.occurrenceStack;if(r5(i))continue;let m=i[0];if(m===n){let e={idx:p,def:r_(i),ruleStack:rL(d),occurrenceStack:rL(f)};h.push(e)}else if(m instanceof iS){if(p<l-1){let e=p+1;if(r(t[e],m.terminalType)){let t={idx:e,def:r_(i),ruleStack:d,occurrenceStack:f};h.push(t)}}else if(p===l-1)u.push({nextTokenType:m.terminalType,nextTokenOccurrence:m.idx,ruleStack:d,occurrenceStack:f}),o=!0;else throw Error("non exhaustive match")}else if(m instanceof id){let e=ri(d);e.push(m.nonTerminalName);let t=ri(f);t.push(m.idx);let r={idx:p,def:m.definition.concat(a,r_(i)),ruleStack:e,occurrenceStack:t};h.push(r)}else if(m instanceof Option){let e={idx:p,def:r_(i),ruleStack:d,occurrenceStack:f};h.push(e),h.push(s);let t={idx:p,def:m.definition.concat(r_(i)),ruleStack:d,occurrenceStack:f};h.push(t)}else if(m instanceof iv){let e=new ix({definition:m.definition,idx:m.idx}),t={idx:p,def:m.definition.concat([e],r_(i)),ruleStack:d,occurrenceStack:f};h.push(t)}else if(m instanceof iy){let e=new ix({definition:[new iS({terminalType:m.separator})].concat(m.definition),idx:m.idx}),t={idx:p,def:m.definition.concat([e],r_(i)),ruleStack:d,occurrenceStack:f};h.push(t)}else if(m instanceof iT){let e={idx:p,def:r_(i),ruleStack:d,occurrenceStack:f};h.push(e),h.push(s);let t=new ix({definition:[new iS({terminalType:m.separator})].concat(m.definition),idx:m.idx}),r={idx:p,def:m.definition.concat([t],r_(i)),ruleStack:d,occurrenceStack:f};h.push(r)}else if(m instanceof ix){let e={idx:p,def:r_(i),ruleStack:d,occurrenceStack:f};h.push(e),h.push(s);let t=new ix({definition:m.definition,idx:m.idx}),r={idx:p,def:m.definition.concat([t],r_(i)),ruleStack:d,occurrenceStack:f};h.push(r)}else if(m instanceof ib)for(let e=m.definition.length-1;e>=0;e--){let t={idx:p,def:m.definition[e].definition.concat(r_(i)),ruleStack:d,occurrenceStack:f};h.push(t),h.push(s)}else if(m instanceof ig)h.push({idx:p,def:m.definition.concat(r_(i)),ruleStack:d,occurrenceStack:f});else if(m instanceof im)h.push(function(e,t,r,i){let n=ri(r);n.push(e.name);let a=ri(i);return a.push(1),{idx:t,def:e.definition,ruleStack:n,occurrenceStack:a}}(m,p,d,f));else throw Error("non exhaustive match")}return u}function nG(e){if(e instanceof Option||"Option"===e)return g.OPTION;if(e instanceof ix||"Repetition"===e)return g.REPETITION;if(e instanceof iv||"RepetitionMandatory"===e)return g.REPETITION_MANDATORY;if(e instanceof iy||"RepetitionMandatoryWithSeparator"===e)return g.REPETITION_MANDATORY_WITH_SEPARATOR;if(e instanceof iT||"RepetitionWithSeparator"===e)return g.REPETITION_WITH_SEPARATOR;if(e instanceof ib||"Alternation"===e)return g.ALTERNATION;throw Error("non exhaustive match")}function nz(e,t,r,i){let n=e.length,a=rB(e,e=>rB(e,e=>1===e.length));if(t)return function(t){let i=rW(t,e=>e.GATE);for(let t=0;t<n;t++){let n=e[t],a=n.length,s=i[t];if(void 0===s||!1!==s.call(this))t:for(let e=0;e<a;e++){let i=n[e],a=i.length;for(let e=0;e<a;e++)if(!1===r(this.LA(e+1),i[e]))continue t;return t}}};if(!a||i)return function(){for(let t=0;t<n;t++){let i=e[t],n=i.length;t:for(let e=0;e<n;e++){let n=i[e],a=n.length;for(let e=0;e<a;e++)if(!1===r(this.LA(e+1),n[e]))continue t;return t}}};{let t=it(rW(e,e=>tT(e)),(e,t,r)=>(rU(t,t=>{r$(e,t.tokenTypeIdx)||(e[t.tokenTypeIdx]=r),rU(t.categoryMatches,t=>{r$(e,t)||(e[t]=r)})}),e),{});return function(){return t[this.LA(1).tokenTypeIdx]}}}function nj(e,t,r){let i=rB(e,e=>1===e.length),n=e.length;if(!i||r)return function(){t:for(let r=0;r<n;r++){let i=e[r],n=i.length;for(let e=0;e<n;e++)if(!1===t(this.LA(e+1),i[e]))continue t;return!0}return!1};{let t=tT(e);if(1===t.length&&r5(t[0].categoryMatches)){let e=t[0].tokenTypeIdx;return function(){return this.LA(1).tokenTypeIdx===e}}{let e=it(t,(e,t,r)=>(e[t.tokenTypeIdx]=!0,rU(t.categoryMatches,t=>{e[t]=!0}),e),[]);return function(){return!0===e[this.LA(1).tokenTypeIdx]}}}}(p=g||(g={}))[p.OPTION=0]="OPTION",p[p.REPETITION=1]="REPETITION",p[p.REPETITION_MANDATORY=2]="REPETITION_MANDATORY",p[p.REPETITION_MANDATORY_WITH_SEPARATOR=3]="REPETITION_MANDATORY_WITH_SEPARATOR",p[p.REPETITION_WITH_SEPARATOR=4]="REPETITION_WITH_SEPARATOR",p[p.ALTERNATION=5]="ALTERNATION";class nH extends iw{constructor(e,t,r){super(),this.topProd=e,this.targetOccurrence=t,this.targetProdType=r}startWalking(){return this.walk(this.topProd),this.restDef}checkIsTarget(e,t,r,i){return e.idx===this.targetOccurrence&&this.targetProdType===t&&(this.restDef=r.concat(i),!0)}walkOption(e,t,r){this.checkIsTarget(e,g.OPTION,t,r)||super.walkOption(e,t,r)}walkAtLeastOne(e,t,r){this.checkIsTarget(e,g.REPETITION_MANDATORY,t,r)||super.walkOption(e,t,r)}walkAtLeastOneSep(e,t,r){this.checkIsTarget(e,g.REPETITION_MANDATORY_WITH_SEPARATOR,t,r)||super.walkOption(e,t,r)}walkMany(e,t,r){this.checkIsTarget(e,g.REPETITION,t,r)||super.walkOption(e,t,r)}walkManySep(e,t,r){this.checkIsTarget(e,g.REPETITION_WITH_SEPARATOR,t,r)||super.walkOption(e,t,r)}}class nW extends iE{constructor(e,t,r){super(),this.targetOccurrence=e,this.targetProdType=t,this.targetRef=r,this.result=[]}checkIsTarget(e,t){e.idx===this.targetOccurrence&&this.targetProdType===t&&(void 0===this.targetRef||e===this.targetRef)&&(this.result=e.definition)}visitOption(e){this.checkIsTarget(e,g.OPTION)}visitRepetition(e){this.checkIsTarget(e,g.REPETITION)}visitRepetitionMandatory(e){this.checkIsTarget(e,g.REPETITION_MANDATORY)}visitRepetitionMandatoryWithSeparator(e){this.checkIsTarget(e,g.REPETITION_MANDATORY_WITH_SEPARATOR)}visitRepetitionWithSeparator(e){this.checkIsTarget(e,g.REPETITION_WITH_SEPARATOR)}visitAlternation(e){this.checkIsTarget(e,g.ALTERNATION)}}function nK(e){let t=Array(e);for(let r=0;r<e;r++)t[r]=[];return t}function nX(e){let t=[""];for(let r=0;r<e.length;r++){let i=e[r],n=[];for(let e=0;e<t.length;e++){let r=t[e];n.push(r+"_"+i.tokenTypeIdx);for(let e=0;e<i.categoryMatches.length;e++){let t="_"+i.categoryMatches[e];n.push(r+t)}}t=n}return t}function nY(e,t){let r=rW(e,e=>nB([e],1)),i=nK(r.length),n=rW(r,e=>{let t={};return rU(e,e=>{rU(nX(e.partialPath),e=>{t[e]=!0})}),t}),a=r;for(let e=1;e<=t;e++){let r=a;a=nK(r.length);for(let s=0;s<r.length;s++){let o=r[s];for(let r=0;r<o.length;r++){let l=o[r].partialPath,c=o[r].suffixDef,u=nX(l);if(function(e,t,r){for(let i=0;i<e.length;i++){if(i===r)continue;let n=e[i];for(let e=0;e<t.length;e++)if(!0===n[t[e]])return!1}return!0}(n,u,s)||r5(c)||l.length===t){let e=i[s];if(!1===n$(e,l)){e.push(l);for(let e=0;e<u.length;e++){let t=u[e];n[s][t]=!0}}}else{let t=nB(c,e+1,l);a[s]=a[s].concat(t),rU(t,e=>{rU(nX(e.partialPath),e=>{n[s][e]=!0})})}}}}return i}function nq(e,t,r,i){let n=new nW(e,g.ALTERNATION,i);return t.accept(n),nY(n.result,r)}function nZ(e,t,r,i){let n=new nW(e,r);t.accept(n);let a=n.result,s=new nH(t,e,r).startWalking();return nY([new ig({definition:a}),new ig({definition:s})],i)}function n$(e,t){r:for(let r=0;r<e.length;r++){let i=e[r];if(i.length===t.length){for(let e=0;e<i.length;e++){let r=t[e],n=i[e];if(!1==(r===n||void 0!==n.categoryMatchesMap[r.tokenTypeIdx]))continue r}return!0}}return!1}function nQ(e){return rB(e,e=>rB(e,e=>rB(e,e=>r5(e.categoryMatches))))}function nJ(e){return`${iA(e)}_#_${e.idx}_#_${n0(e)}`}function n0(e){return e instanceof iS?e.terminalType.name:e instanceof id?e.nonTerminalName:""}class n1 extends iE{constructor(){super(...arguments),this.allProductions=[]}visitNonTerminal(e){this.allProductions.push(e)}visitOption(e){this.allProductions.push(e)}visitRepetitionWithSeparator(e){this.allProductions.push(e)}visitRepetitionMandatory(e){this.allProductions.push(e)}visitRepetitionMandatoryWithSeparator(e){this.allProductions.push(e)}visitRepetition(e){this.allProductions.push(e)}visitAlternation(e){this.allProductions.push(e)}visitTerminal(e){this.allProductions.push(e)}}class n2 extends iE{constructor(){super(...arguments),this.alternations=[]}visitAlternation(e){this.alternations.push(e)}}class n3 extends iE{constructor(){super(...arguments),this.allProductions=[]}visitRepetitionWithSeparator(e){this.allProductions.push(e)}visitRepetitionMandatory(e){this.allProductions.push(e)}visitRepetitionMandatoryWithSeparator(e){this.allProductions.push(e)}visitRepetition(e){this.allProductions.push(e)}}let n4="MismatchedTokenException",n5="NoViableAltException",n6="EarlyExitException",n8="NotAllInputParsedException",n9=[n4,n5,n6,n8];function n7(e){return r1(n9,e.name)}Object.freeze(n9);class ae extends Error{constructor(e,t){super(e),this.token=t,this.resyncedTokens=[],Object.setPrototypeOf(this,new.target.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}}class at extends ae{constructor(e,t,r){super(e,t),this.previousToken=r,this.name=n4}}class ar extends ae{constructor(e,t,r){super(e,t),this.previousToken=r,this.name=n5}}class ai extends ae{constructor(e,t){super(e,t),this.name=n8}}class an extends ae{constructor(e,t,r){super(e,t),this.previousToken=r,this.name=n6}}let aa={},as="InRuleRecoveryException";class ao extends Error{constructor(e){super(e),this.name=as}}class al{initRecoverable(e){this.firstAfterRepMap={},this.resyncFollows={},this.recoveryEnabled=r$(e,"recoveryEnabled")?e.recoveryEnabled:aL.recoveryEnabled,this.recoveryEnabled&&(this.attemptInRepetitionRecovery=ac)}getTokenToInsert(e){let t=nM(e,"",NaN,NaN,NaN,NaN,NaN,NaN);return t.isInsertedInRecovery=!0,t}canTokenTypeBeInsertedInRecovery(e){return!0}canTokenTypeBeDeletedInRecovery(e){return!0}tryInRepetitionRecovery(e,t,r,i){let n=this.findReSyncTokenType(),a=this.exportLexerState(),s=[],o=!1,l=this.LA(1),c=this.LA(1),u=()=>{let e=this.LA(0),t=new at(this.errorMessageProvider.buildMismatchTokenMessage({expected:i,actual:l,previous:e,ruleName:this.getCurrRuleFullName()}),l,this.LA(0));t.resyncedTokens=rL(s),this.SAVE_ERROR(t)};for(;!o;){if(this.tokenMatcher(c,i)){u();return}if(r.call(this)){u(),e.apply(this,t);return}this.tokenMatcher(c,n)?o=!0:(c=this.SKIP_TOKEN(),this.addToResyncTokens(c,s))}this.importLexerState(a)}shouldInRepetitionRecoveryBeTried(e,t,r){return!(!1===r||this.tokenMatcher(this.LA(1),e)||this.isBackTracking()||this.canPerformInRuleRecovery(e,this.getFollowsForInRuleRecovery(e,t)))}getFollowsForInRuleRecovery(e,t){let r=this.getCurrentGrammarPath(e,t);return this.getNextPossibleTokenTypes(r)}tryInRuleRecovery(e,t){if(this.canRecoverWithSingleTokenInsertion(e,t))return this.getTokenToInsert(e);if(this.canRecoverWithSingleTokenDeletion(e)){let e=this.SKIP_TOKEN();return this.consumeToken(),e}throw new ao("sad sad panda")}canPerformInRuleRecovery(e,t){return this.canRecoverWithSingleTokenInsertion(e,t)||this.canRecoverWithSingleTokenDeletion(e)}canRecoverWithSingleTokenInsertion(e,t){if(!this.canTokenTypeBeInsertedInRecovery(e)||r5(t))return!1;let r=this.LA(1);return void 0!==rj(t,e=>this.tokenMatcher(r,e))}canRecoverWithSingleTokenDeletion(e){return!!this.canTokenTypeBeDeletedInRecovery(e)&&this.tokenMatcher(this.LA(2),e)}isInCurrentRuleReSyncSet(e){let t=this.getCurrFollowKey();return r1(this.getFollowSetFromFollowKey(t),e)}findReSyncTokenType(){let e=this.flattenFollowSet(),t=this.LA(1),r=2;for(;;){let i=rj(e,e=>na(t,e));if(void 0!==i)return i;t=this.LA(r),r++}}getCurrFollowKey(){if(1===this.RULE_STACK.length)return aa;let e=this.getLastExplicitRuleShortName(),t=this.getLastExplicitRuleOccurrenceIndex(),r=this.getPreviousExplicitRuleShortName();return{ruleName:this.shortRuleNameToFullName(e),idxInCallingRule:t,inRule:this.shortRuleNameToFullName(r)}}buildFullFollowKeyStack(){let e=this.RULE_STACK,t=this.RULE_OCCURRENCE_STACK;return rW(e,(r,i)=>0===i?aa:{ruleName:this.shortRuleNameToFullName(r),idxInCallingRule:t[i],inRule:this.shortRuleNameToFullName(e[i-1])})}flattenFollowSet(){return tT(rW(this.buildFullFollowKeyStack(),e=>this.getFollowSetFromFollowKey(e)))}getFollowSetFromFollowKey(e){if(e===aa)return[nw];let t=e.ruleName+e.idxInCallingRule+iI+e.inRule;return this.resyncFollows[t]}addToResyncTokens(e,t){return this.tokenMatcher(e,nw)||t.push(e),t}reSyncTo(e){let t=[],r=this.LA(1);for(;!1===this.tokenMatcher(r,e);)r=this.SKIP_TOKEN(),this.addToResyncTokens(r,t);return rL(t)}attemptInRepetitionRecovery(e,t,r,i,n,a,s){}getCurrentGrammarPath(e,t){return{ruleStack:this.getHumanReadableRuleStack(),occurrenceStack:ri(this.RULE_OCCURRENCE_STACK),lastTok:e,lastTokOccurrence:t}}getHumanReadableRuleStack(){return rW(this.RULE_STACK,e=>this.shortRuleNameToFullName(e))}}function ac(e,t,r,i,n,a,s){let o=this.getKeyForAutomaticLookahead(i,n),l=this.firstAfterRepMap[o];if(void 0===l){let e=this.getCurrRuleFullName();l=new a(this.getGAstProductions()[e],n).startWalking(),this.firstAfterRepMap[o]=l}let c=l.token,u=l.occurrence,h=l.isEndOfRule;1===this.RULE_STACK.length&&h&&void 0===c&&(c=nw,u=1),void 0!==c&&void 0!==u&&this.shouldInRepetitionRecoveryBeTried(c,u,s)&&this.tryInRepetitionRecovery(e,t,r,c)}class au{constructor(e){var t;this.maxLookahead=null!==(t=null==e?void 0:e.maxLookahead)&&void 0!==t?t:aL.maxLookahead}validate(e){let t=this.validateNoLeftRecursion(e.rules);return r5(t)?[...t,...this.validateEmptyOrAlternatives(e.rules),...this.validateAmbiguousAlternationAlternatives(e.rules,this.maxLookahead),...this.validateSomeNonEmptyLookaheadPath(e.rules,this.maxLookahead)]:t}validateNoLeftRecursion(e){return rK(e,e=>(function e(t,r,i,n=[]){let a=[],s=function e(t){let r=[];if(r5(t))return r;let i=rH(t);if(i instanceof id)r.push(i.referencedRule);else if(i instanceof ig||i instanceof Option||i instanceof iv||i instanceof iy||i instanceof iT||i instanceof ix)r=r.concat(e(i.definition));else if(i instanceof ib)r=tT(rW(i.definition,t=>e(t.definition)));else if(i instanceof iS);else throw Error("non exhaustive match");let n=iR(i),a=t.length>1;if(!n||!a)return r;{let i=r_(t);return r.concat(e(i))}}(r.definition);if(r5(s))return[];{let r=t.name;r1(s,t)&&a.push({message:i.buildLeftRecursionError({topLevelRule:t,leftRecursionPath:n}),type:y.LEFT_RECURSION,ruleName:r});let o=rK(rP(s,n.concat([t])),r=>{let a=ri(n);return a.push(r),e(t,r,i,a)});return a.concat(o)}})(e,e,nN))}validateEmptyOrAlternatives(e){return rK(e,e=>(function(e,t){let r=new n2;return e.accept(r),rK(r.alternations,r=>rK(rL(r.definition),(i,n)=>r5(nV([i],[],na,1))?[{message:t.buildEmptyAlternationError({topLevelRule:e,alternation:r,emptyChoiceIdx:n}),type:y.NONE_LAST_EMPTY_ALT,ruleName:e.name,occurrence:r.idx,alternative:n+1}]:[]))})(e,nN))}validateAmbiguousAlternationAlternatives(e,t){return rK(e,e=>(function(e,t,r){let i=new n2;e.accept(i);let n=i.alternations;return rK(n=ir(n,e=>!0===e.ignoreAmbiguities),i=>{let n=nq(i.idx,e,i.maxLookahead||t,i),a=function(e,t,r,i){let n=[];return rW(it(e,(r,i,a)=>(!0===t.definition[a].ignoreAmbiguities||rU(i,i=>{let s=[a];rU(e,(e,r)=>{a!==r&&n$(e,i)&&!0!==t.definition[r].ignoreAmbiguities&&s.push(r)}),s.length>1&&!n$(n,i)&&(n.push(i),r.push({alts:s,path:i}))}),r),[]),e=>{let n=rW(e.alts,e=>e+1);return{message:i.buildAlternationAmbiguityError({topLevelRule:r,alternation:t,ambiguityIndices:n,prefixPath:e.path}),type:y.AMBIGUOUS_ALTS,ruleName:r.name,occurrence:t.idx,alternatives:e.alts}})}(n,i,e,r),s=function(e,t,r,i){let n=it(e,(e,t,r)=>{let i=rW(t,e=>({idx:r,path:e}));return e.concat(i)},[]);return rn(rK(n,e=>{if(!0===t.definition[e.idx].ignoreAmbiguities)return[];let a=e.idx,s=e.path;return rW(rG(n,e=>{var r;return!0!==t.definition[e.idx].ignoreAmbiguities&&e.idx<a&&(r=e.path).length<s.length&&rB(r,(e,t)=>{let r=s[t];return e===r||r.categoryMatchesMap[e.tokenTypeIdx]})}),e=>{let n=[e.idx+1,a+1],s=0===t.idx?"":t.idx;return{message:i.buildAlternationPrefixAmbiguityError({topLevelRule:r,alternation:t,ambiguityIndices:n,prefixPath:e.path}),type:y.AMBIGUOUS_PREFIX_ALTS,ruleName:r.name,occurrence:s,alternatives:n}})}))}(n,i,e,r);return a.concat(s)})})(e,t,nN))}validateSomeNonEmptyLookaheadPath(e,t){return function(e,t,r){let i=[];return rU(e,e=>{let n=new n3;e.accept(n),rU(n.allProductions,n=>{let a=nG(n),s=n.maxLookahead||t;if(r5(tT(nZ(n.idx,e,a,s)[0]))){let t=r.buildEmptyRepetitionError({topLevelRule:e,repetition:n});i.push({message:t,type:y.NO_NON_EMPTY_LOOKAHEAD,ruleName:e.name})}})}),i}(e,t,nN)}buildLookaheadForAlternation(e){return function(e,t,r,i,n,a){let s=nq(e,t,r),o=nQ(s)?ns:na;return a(s,i,o,n)}(e.prodOccurrence,e.rule,e.maxLookahead,e.hasPredicates,e.dynamicTokensEnabled,nz)}buildLookaheadForOptional(e){return function(e,t,r,i,n,a){let s=nZ(e,t,n,r),o=nQ(s)?ns:na;return a(s[0],o,i)}(e.prodOccurrence,e.rule,e.maxLookahead,e.dynamicTokensEnabled,nG(e.prodType),nj)}}class ah{initLooksAhead(e){this.dynamicTokensEnabled=r$(e,"dynamicTokensEnabled")?e.dynamicTokensEnabled:aL.dynamicTokensEnabled,this.maxLookahead=r$(e,"maxLookahead")?e.maxLookahead:aL.maxLookahead,this.lookaheadStrategy=r$(e,"lookaheadStrategy")?e.lookaheadStrategy:new au({maxLookahead:this.maxLookahead}),this.lookAheadFuncsCache=new Map}preComputeLookaheadFunctions(e){rU(e,e=>{this.TRACE_INIT(`${e.name} Rule Lookahead`,()=>{let{alternation:t,repetition:r,option:i,repetitionMandatory:n,repetitionMandatoryWithSeparator:a,repetitionWithSeparator:s}=function(e){ad.reset(),e.accept(ad);let t=ad.dslMethods;return ad.reset(),t}(e);rU(t,t=>{let r=0===t.idx?"":t.idx;this.TRACE_INIT(`${iA(t)}${r}`,()=>{var r;let i=this.lookaheadStrategy.buildLookaheadForAlternation({prodOccurrence:t.idx,rule:e,maxLookahead:t.maxLookahead||this.maxLookahead,hasPredicates:t.hasPredicates,dynamicTokensEnabled:this.dynamicTokensEnabled}),n=(r=this.fullRuleNameToShort[e.name],256|t.idx|r);this.setLaFuncCache(n,i)})}),rU(r,t=>{this.computeLookaheadFunc(e,t.idx,768,"Repetition",t.maxLookahead,iA(t))}),rU(i,t=>{this.computeLookaheadFunc(e,t.idx,512,"Option",t.maxLookahead,iA(t))}),rU(n,t=>{this.computeLookaheadFunc(e,t.idx,1024,"RepetitionMandatory",t.maxLookahead,iA(t))}),rU(a,t=>{this.computeLookaheadFunc(e,t.idx,1536,"RepetitionMandatoryWithSeparator",t.maxLookahead,iA(t))}),rU(s,t=>{this.computeLookaheadFunc(e,t.idx,1280,"RepetitionWithSeparator",t.maxLookahead,iA(t))})})})}computeLookaheadFunc(e,t,r,i,n,a){this.TRACE_INIT(`${a}${0===t?"":t}`,()=>{let a=this.lookaheadStrategy.buildLookaheadForOptional({prodOccurrence:t,rule:e,maxLookahead:n||this.maxLookahead,dynamicTokensEnabled:this.dynamicTokensEnabled,prodType:i}),s=t|r|this.fullRuleNameToShort[e.name];this.setLaFuncCache(s,a)})}getKeyForAutomaticLookahead(e,t){return t|e|this.getLastExplicitRuleShortName()}getLaFuncFromCache(e){return this.lookAheadFuncsCache.get(e)}setLaFuncCache(e,t){this.lookAheadFuncsCache.set(e,t)}}class ap extends iE{constructor(){super(...arguments),this.dslMethods={option:[],alternation:[],repetition:[],repetitionWithSeparator:[],repetitionMandatory:[],repetitionMandatoryWithSeparator:[]}}reset(){this.dslMethods={option:[],alternation:[],repetition:[],repetitionWithSeparator:[],repetitionMandatory:[],repetitionMandatoryWithSeparator:[]}}visitOption(e){this.dslMethods.option.push(e)}visitRepetitionWithSeparator(e){this.dslMethods.repetitionWithSeparator.push(e)}visitRepetitionMandatory(e){this.dslMethods.repetitionMandatory.push(e)}visitRepetitionMandatoryWithSeparator(e){this.dslMethods.repetitionMandatoryWithSeparator.push(e)}visitRepetition(e){this.dslMethods.repetition.push(e)}visitAlternation(e){this.dslMethods.alternation.push(e)}}let ad=new ap;function af(e,t){!0===isNaN(e.startOffset)?(e.startOffset=t.startOffset,e.endOffset=t.endOffset):e.endOffset<t.endOffset==!0&&(e.endOffset=t.endOffset)}function am(e,t){!0===isNaN(e.startOffset)?(e.startOffset=t.startOffset,e.startColumn=t.startColumn,e.startLine=t.startLine,e.endOffset=t.endOffset,e.endColumn=t.endColumn,e.endLine=t.endLine):e.endOffset<t.endOffset==!0&&(e.endOffset=t.endOffset,e.endColumn=t.endColumn,e.endLine=t.endLine)}function ag(e,t){Object.defineProperty(e,"name",{enumerable:!1,configurable:!0,writable:!1,value:t})}function av(e,t){let r=e0(e),i=r.length;for(let n=0;n<i;n++){let i=e[r[n]],a=i.length;for(let e=0;e<a;e++){let r=i[e];void 0===r.tokenTypeIdx&&this[r.name](r.children,t)}}}(d=v||(v={}))[d.REDUNDANT_METHOD=0]="REDUNDANT_METHOD",d[d.MISSING_METHOD=1]="MISSING_METHOD";class ay{initTreeBuilder(e){if(this.CST_STACK=[],this.outputCst=e.outputCst,this.nodeLocationTracking=r$(e,"nodeLocationTracking")?e.nodeLocationTracking:aL.nodeLocationTracking,this.outputCst){if(/full/i.test(this.nodeLocationTracking))this.recoveryEnabled?(this.setNodeLocationFromToken=am,this.setNodeLocationFromNode=am,this.cstPostRule=el,this.setInitialNodeLocation=this.setInitialNodeLocationFullRecovery):(this.setNodeLocationFromToken=el,this.setNodeLocationFromNode=el,this.cstPostRule=this.cstPostRuleFull,this.setInitialNodeLocation=this.setInitialNodeLocationFullRegular);else if(/onlyOffset/i.test(this.nodeLocationTracking))this.recoveryEnabled?(this.setNodeLocationFromToken=af,this.setNodeLocationFromNode=af,this.cstPostRule=el,this.setInitialNodeLocation=this.setInitialNodeLocationOnlyOffsetRecovery):(this.setNodeLocationFromToken=el,this.setNodeLocationFromNode=el,this.cstPostRule=this.cstPostRuleOnlyOffset,this.setInitialNodeLocation=this.setInitialNodeLocationOnlyOffsetRegular);else if(/none/i.test(this.nodeLocationTracking))this.setNodeLocationFromToken=el,this.setNodeLocationFromNode=el,this.cstPostRule=el,this.setInitialNodeLocation=el;else throw Error(`Invalid <nodeLocationTracking> config option: "${e.nodeLocationTracking}"`)}else this.cstInvocationStateUpdate=el,this.cstFinallyStateUpdate=el,this.cstPostTerminal=el,this.cstPostNonTerminal=el,this.cstPostRule=el}setInitialNodeLocationOnlyOffsetRecovery(e){e.location={startOffset:NaN,endOffset:NaN}}setInitialNodeLocationOnlyOffsetRegular(e){e.location={startOffset:this.LA(1).startOffset,endOffset:NaN}}setInitialNodeLocationFullRecovery(e){e.location={startOffset:NaN,startLine:NaN,startColumn:NaN,endOffset:NaN,endLine:NaN,endColumn:NaN}}setInitialNodeLocationFullRegular(e){let t=this.LA(1);e.location={startOffset:t.startOffset,startLine:t.startLine,startColumn:t.startColumn,endOffset:NaN,endLine:NaN,endColumn:NaN}}cstInvocationStateUpdate(e){let t={name:e,children:Object.create(null)};this.setInitialNodeLocation(t),this.CST_STACK.push(t)}cstFinallyStateUpdate(){this.CST_STACK.pop()}cstPostRuleFull(e){let t=this.LA(0),r=e.location;r.startOffset<=t.startOffset==!0?(r.endOffset=t.endOffset,r.endLine=t.endLine,r.endColumn=t.endColumn):(r.startOffset=NaN,r.startLine=NaN,r.startColumn=NaN)}cstPostRuleOnlyOffset(e){let t=this.LA(0),r=e.location;r.startOffset<=t.startOffset==!0?r.endOffset=t.endOffset:r.startOffset=NaN}cstPostTerminal(e,t){let r=this.CST_STACK[this.CST_STACK.length-1];void 0===r.children[e]?r.children[e]=[t]:r.children[e].push(t),this.setNodeLocationFromToken(r.location,t)}cstPostNonTerminal(e,t){let r=this.CST_STACK[this.CST_STACK.length-1];void 0===r.children[t]?r.children[t]=[e]:r.children[t].push(e),this.setNodeLocationFromNode(r.location,e.location)}getBaseCstVisitorConstructor(){if(r9(this.baseCstVisitorConstructor)){let e=function(e,t){let r=function(){};return ag(r,e+"BaseSemantics"),r.prototype={visit:function(e,t){if(k(e)&&(e=e[0]),!r9(e))return this[e.name](e.children,t)},validateVisitor:function(){var e;let r=(e=this,rn(rW(rG(t,t=>!1===Y(e[t])),t=>({msg:`Missing visitor method: <${t}> on ${e.constructor.name} CST Visitor.`,type:v.MISSING_METHOD,methodName:t}))));if(!r5(r)){let e=rW(r,e=>e.msg);throw Error(`Errors Detected in CST Visitor <${this.constructor.name}>:
	${e.join("\n\n").replace(/\n/g,"\n	")}`)}}},r.prototype.constructor=r,r._RULE_NAMES=t,r}(this.className,e0(this.gastProductionsCache));return this.baseCstVisitorConstructor=e,e}return this.baseCstVisitorConstructor}getBaseCstVisitorConstructorWithDefaults(){if(r9(this.baseCstVisitorWithDefaultsConstructor)){let e=function(e,t,r){let i=function(){};ag(i,e+"BaseSemanticsWithDefaults");let n=Object.create(r.prototype);return rU(t,e=>{n[e]=av}),i.prototype=n,i.prototype.constructor=i,i}(this.className,e0(this.gastProductionsCache),this.getBaseCstVisitorConstructor());return this.baseCstVisitorWithDefaultsConstructor=e,e}return this.baseCstVisitorWithDefaultsConstructor}getLastExplicitRuleShortName(){let e=this.RULE_STACK;return e[e.length-1]}getPreviousExplicitRuleShortName(){let e=this.RULE_STACK;return e[e.length-2]}getLastExplicitRuleOccurrenceIndex(){let e=this.RULE_OCCURRENCE_STACK;return e[e.length-1]}}class ax{initLexerAdapter(){this.tokVector=[],this.tokVectorLength=0,this.currIdx=-1}set input(e){if(!0!==this.selfAnalysisDone)throw Error("Missing <performSelfAnalysis> invocation at the end of the Parser's constructor.");this.reset(),this.tokVector=e,this.tokVectorLength=e.length}get input(){return this.tokVector}SKIP_TOKEN(){return this.currIdx<=this.tokVector.length-2?(this.consumeToken(),this.LA(1)):a_}LA(e){let t=this.currIdx+e;return t<0||this.tokVectorLength<=t?a_:this.tokVector[t]}consumeToken(){this.currIdx++}exportLexerState(){return this.currIdx}importLexerState(e){this.currIdx=e}resetLexerState(){this.currIdx=-1}moveToTerminatedState(){this.currIdx=this.tokVector.length-1}getLexerPosition(){return this.exportLexerState()}}class aT{ACTION(e){return e.call(this)}consume(e,t,r){return this.consumeInternal(t,e,r)}subrule(e,t,r){return this.subruleInternal(t,e,r)}option(e,t){return this.optionInternal(t,e)}or(e,t){return this.orInternal(t,e)}many(e,t){return this.manyInternal(e,t)}atLeastOne(e,t){return this.atLeastOneInternal(e,t)}CONSUME(e,t){return this.consumeInternal(e,0,t)}CONSUME1(e,t){return this.consumeInternal(e,1,t)}CONSUME2(e,t){return this.consumeInternal(e,2,t)}CONSUME3(e,t){return this.consumeInternal(e,3,t)}CONSUME4(e,t){return this.consumeInternal(e,4,t)}CONSUME5(e,t){return this.consumeInternal(e,5,t)}CONSUME6(e,t){return this.consumeInternal(e,6,t)}CONSUME7(e,t){return this.consumeInternal(e,7,t)}CONSUME8(e,t){return this.consumeInternal(e,8,t)}CONSUME9(e,t){return this.consumeInternal(e,9,t)}SUBRULE(e,t){return this.subruleInternal(e,0,t)}SUBRULE1(e,t){return this.subruleInternal(e,1,t)}SUBRULE2(e,t){return this.subruleInternal(e,2,t)}SUBRULE3(e,t){return this.subruleInternal(e,3,t)}SUBRULE4(e,t){return this.subruleInternal(e,4,t)}SUBRULE5(e,t){return this.subruleInternal(e,5,t)}SUBRULE6(e,t){return this.subruleInternal(e,6,t)}SUBRULE7(e,t){return this.subruleInternal(e,7,t)}SUBRULE8(e,t){return this.subruleInternal(e,8,t)}SUBRULE9(e,t){return this.subruleInternal(e,9,t)}OPTION(e){return this.optionInternal(e,0)}OPTION1(e){return this.optionInternal(e,1)}OPTION2(e){return this.optionInternal(e,2)}OPTION3(e){return this.optionInternal(e,3)}OPTION4(e){return this.optionInternal(e,4)}OPTION5(e){return this.optionInternal(e,5)}OPTION6(e){return this.optionInternal(e,6)}OPTION7(e){return this.optionInternal(e,7)}OPTION8(e){return this.optionInternal(e,8)}OPTION9(e){return this.optionInternal(e,9)}OR(e){return this.orInternal(e,0)}OR1(e){return this.orInternal(e,1)}OR2(e){return this.orInternal(e,2)}OR3(e){return this.orInternal(e,3)}OR4(e){return this.orInternal(e,4)}OR5(e){return this.orInternal(e,5)}OR6(e){return this.orInternal(e,6)}OR7(e){return this.orInternal(e,7)}OR8(e){return this.orInternal(e,8)}OR9(e){return this.orInternal(e,9)}MANY(e){this.manyInternal(0,e)}MANY1(e){this.manyInternal(1,e)}MANY2(e){this.manyInternal(2,e)}MANY3(e){this.manyInternal(3,e)}MANY4(e){this.manyInternal(4,e)}MANY5(e){this.manyInternal(5,e)}MANY6(e){this.manyInternal(6,e)}MANY7(e){this.manyInternal(7,e)}MANY8(e){this.manyInternal(8,e)}MANY9(e){this.manyInternal(9,e)}MANY_SEP(e){this.manySepFirstInternal(0,e)}MANY_SEP1(e){this.manySepFirstInternal(1,e)}MANY_SEP2(e){this.manySepFirstInternal(2,e)}MANY_SEP3(e){this.manySepFirstInternal(3,e)}MANY_SEP4(e){this.manySepFirstInternal(4,e)}MANY_SEP5(e){this.manySepFirstInternal(5,e)}MANY_SEP6(e){this.manySepFirstInternal(6,e)}MANY_SEP7(e){this.manySepFirstInternal(7,e)}MANY_SEP8(e){this.manySepFirstInternal(8,e)}MANY_SEP9(e){this.manySepFirstInternal(9,e)}AT_LEAST_ONE(e){this.atLeastOneInternal(0,e)}AT_LEAST_ONE1(e){return this.atLeastOneInternal(1,e)}AT_LEAST_ONE2(e){this.atLeastOneInternal(2,e)}AT_LEAST_ONE3(e){this.atLeastOneInternal(3,e)}AT_LEAST_ONE4(e){this.atLeastOneInternal(4,e)}AT_LEAST_ONE5(e){this.atLeastOneInternal(5,e)}AT_LEAST_ONE6(e){this.atLeastOneInternal(6,e)}AT_LEAST_ONE7(e){this.atLeastOneInternal(7,e)}AT_LEAST_ONE8(e){this.atLeastOneInternal(8,e)}AT_LEAST_ONE9(e){this.atLeastOneInternal(9,e)}AT_LEAST_ONE_SEP(e){this.atLeastOneSepFirstInternal(0,e)}AT_LEAST_ONE_SEP1(e){this.atLeastOneSepFirstInternal(1,e)}AT_LEAST_ONE_SEP2(e){this.atLeastOneSepFirstInternal(2,e)}AT_LEAST_ONE_SEP3(e){this.atLeastOneSepFirstInternal(3,e)}AT_LEAST_ONE_SEP4(e){this.atLeastOneSepFirstInternal(4,e)}AT_LEAST_ONE_SEP5(e){this.atLeastOneSepFirstInternal(5,e)}AT_LEAST_ONE_SEP6(e){this.atLeastOneSepFirstInternal(6,e)}AT_LEAST_ONE_SEP7(e){this.atLeastOneSepFirstInternal(7,e)}AT_LEAST_ONE_SEP8(e){this.atLeastOneSepFirstInternal(8,e)}AT_LEAST_ONE_SEP9(e){this.atLeastOneSepFirstInternal(9,e)}RULE(e,t,r=aU){if(r1(this.definedRulesNames,e)){let t={message:nN.buildDuplicateRuleNameError({topLevelRule:e,grammarName:this.className}),type:y.DUPLICATE_RULE_NAME,ruleName:e};this.definitionErrors.push(t)}this.definedRulesNames.push(e);let i=this.defineRule(e,t,r);return this[e]=i,i}OVERRIDE_RULE(e,t,r=aU){let i=function(e,t,r){let i=[];return r1(t,e)||i.push({message:`Invalid rule override, rule: ->${e}<- cannot be overridden in the grammar: ->${r}<-as it is not defined in any of the super grammars `,type:y.INVALID_RULE_OVERRIDE,ruleName:e}),i}(e,this.definedRulesNames,this.className);this.definitionErrors=this.definitionErrors.concat(i);let n=this.defineRule(e,t,r);return this[e]=n,n}BACKTRACK(e,t){return function(){this.isBackTrackingStack.push(1);let r=this.saveRecogState();try{return e.apply(this,t),!0}catch(e){if(n7(e))return!1;throw e}finally{this.reloadRecogState(r),this.isBackTrackingStack.pop()}}}getGAstProductions(){return this.gastProductionsCache}getSerializedGastProductions(){return rW(rJ(this.gastProductionsCache),function e(t){function r(t){return rW(t,e)}if(t instanceof id){let e={type:"NonTerminal",name:t.nonTerminalName,idx:t.idx};return rQ(t.label)&&(e.label=t.label),e}if(t instanceof ig)return{type:"Alternative",definition:r(t.definition)};if(t instanceof Option)return{type:"Option",idx:t.idx,definition:r(t.definition)};if(t instanceof iv)return{type:"RepetitionMandatory",idx:t.idx,definition:r(t.definition)};if(t instanceof iy)return{type:"RepetitionMandatoryWithSeparator",idx:t.idx,separator:e(new iS({terminalType:t.separator})),definition:r(t.definition)};if(t instanceof iT)return{type:"RepetitionWithSeparator",idx:t.idx,separator:e(new iS({terminalType:t.separator})),definition:r(t.definition)};if(t instanceof ix)return{type:"Repetition",idx:t.idx,definition:r(t.definition)};else if(t instanceof ib)return{type:"Alternation",idx:t.idx,definition:r(t.definition)};else if(t instanceof iS){var i,n;let e={type:"Terminal",name:t.terminalType.name,label:rQ((n=i=t.terminalType).LABEL)&&""!==n.LABEL?i.LABEL:i.name,idx:t.idx};rQ(t.label)&&(e.terminalLabel=t.label);let r=t.terminalType.PATTERN;return t.terminalType.PATTERN&&(e.pattern=r8(r)?r.source:r),e}else if(t instanceof im)return{type:"Rule",name:t.name,orgText:t.orgText,definition:r(t.definition)};else throw Error("non exhaustive match")})}}class ab{initRecognizerEngine(e,t){if(this.className=this.constructor.name,this.shortRuleNameToFull={},this.fullRuleNameToShort={},this.ruleShortNameIdx=256,this.tokenMatcher=ns,this.subruleIdx=0,this.definedRulesNames=[],this.tokensMap={},this.isBackTrackingStack=[],this.RULE_STACK=[],this.RULE_OCCURRENCE_STACK=[],this.gastProductionsCache={},r$(t,"serializedGrammar"))throw Error("The Parser's configuration can no longer contain a <serializedGrammar> property.\n	See: https://chevrotain.io/docs/changes/BREAKING_CHANGES.html#_6-0-0\n	For Further details.");if(k(e)){if(r5(e))throw Error("A Token Vocabulary cannot be empty.\n	Note that the first argument for the parser constructor\n	is no longer a Token vector (since v4.0).");if("number"==typeof e[0].startOffset)throw Error("The Parser constructor no longer accepts a token vector as the first argument.\n	See: https://chevrotain.io/docs/changes/BREAKING_CHANGES.html#_4-0-0\n	For Further details.")}if(k(e))this.tokensMap=it(e,(e,t)=>(e[t.name]=t,e),{});else if(r$(e,"modes")&&rB(tT(rJ(e.modes)),np)){let t=io(tT(rJ(e.modes)));this.tokensMap=it(t,(e,t)=>(e[t.name]=t,e),{})}else if(B(e))this.tokensMap=ri(e);else throw Error("<tokensDictionary> argument must be An Array of Token constructors, A dictionary of Token constructors or an IMultiModeLexerDefinition");this.tokensMap.EOF=nw;let r=rB(r$(e,"modes")?tT(rJ(e.modes)):rJ(e),e=>r5(e.categoryMatches));this.tokenMatcher=r?ns:na,nc(rJ(this.tokensMap))}defineRule(e,t,r){if(this.selfAnalysisDone)throw Error(`Grammar rule <${e}> may not be defined after the 'performSelfAnalysis' method has been called'
Make sure that all grammar rule definitions are done before 'performSelfAnalysis' is called.`);let i=r$(r,"resyncEnabled")?r.resyncEnabled:aU.resyncEnabled,n=r$(r,"recoveryValueFunc")?r.recoveryValueFunc:aU.recoveryValueFunc,a=this.ruleShortNameIdx<<12;return this.ruleShortNameIdx++,this.shortRuleNameToFull[a]=e,this.fullRuleNameToShort[e]=a,Object.assign(!0===this.outputCst?function(...r){try{this.ruleInvocationStateUpdate(a,e,this.subruleIdx),t.apply(this,r);let i=this.CST_STACK[this.CST_STACK.length-1];return this.cstPostRule(i),i}catch(e){return this.invokeRuleCatch(e,i,n)}finally{this.ruleFinallyStateUpdate()}}:function(...r){try{return this.ruleInvocationStateUpdate(a,e,this.subruleIdx),t.apply(this,r)}catch(e){return this.invokeRuleCatch(e,i,n)}finally{this.ruleFinallyStateUpdate()}},{ruleName:e,originalGrammarAction:t})}invokeRuleCatch(e,t,r){let i=1===this.RULE_STACK.length,n=t&&!this.isBackTracking()&&this.recoveryEnabled;if(n7(e)){if(n){let t=this.findReSyncTokenType();if(this.isInCurrentRuleReSyncSet(t)){if(e.resyncedTokens=this.reSyncTo(t),!this.outputCst)return r(e);{let e=this.CST_STACK[this.CST_STACK.length-1];return e.recoveredNode=!0,e}}if(this.outputCst){let t=this.CST_STACK[this.CST_STACK.length-1];t.recoveredNode=!0,e.partialCstResult=t}throw e}if(i)return this.moveToTerminatedState(),r(e)}throw e}optionInternal(e,t){let r=this.getKeyForAutomaticLookahead(512,t);return this.optionInternalLogic(e,t,r)}optionInternalLogic(e,t,r){let i,n=this.getLaFuncFromCache(r);if("function"!=typeof e){i=e.DEF;let t=e.GATE;if(void 0!==t){let e=n;n=()=>t.call(this)&&e.call(this)}}else i=e;if(!0===n.call(this))return i.call(this)}atLeastOneInternal(e,t){let r=this.getKeyForAutomaticLookahead(1024,e);return this.atLeastOneInternalLogic(e,t,r)}atLeastOneInternalLogic(e,t,r){let i,n=this.getLaFuncFromCache(r);if("function"!=typeof t){i=t.DEF;let e=t.GATE;if(void 0!==e){let t=n;n=()=>e.call(this)&&t.call(this)}}else i=t;if(!0===n.call(this)){let e=this.doSingleRepetition(i);for(;!0===n.call(this)&&!0===e;)e=this.doSingleRepetition(i)}else throw this.raiseEarlyExitException(e,g.REPETITION_MANDATORY,t.ERR_MSG);this.attemptInRepetitionRecovery(this.atLeastOneInternal,[e,t],n,1024,e,nD)}atLeastOneSepFirstInternal(e,t){let r=this.getKeyForAutomaticLookahead(1536,e);this.atLeastOneSepFirstInternalLogic(e,t,r)}atLeastOneSepFirstInternalLogic(e,t,r){let i=t.DEF,n=t.SEP;if(!0===this.getLaFuncFromCache(r).call(this)){i.call(this);let t=()=>this.tokenMatcher(this.LA(1),n);for(;!0===this.tokenMatcher(this.LA(1),n);)this.CONSUME(n),i.call(this);this.attemptInRepetitionRecovery(this.repetitionSepSecondInternal,[e,n,t,i,nF],t,1536,e,nF)}else throw this.raiseEarlyExitException(e,g.REPETITION_MANDATORY_WITH_SEPARATOR,t.ERR_MSG)}manyInternal(e,t){let r=this.getKeyForAutomaticLookahead(768,e);return this.manyInternalLogic(e,t,r)}manyInternalLogic(e,t,r){let i,n=this.getLaFuncFromCache(r);if("function"!=typeof t){i=t.DEF;let e=t.GATE;if(void 0!==e){let t=n;n=()=>e.call(this)&&t.call(this)}}else i=t;let a=!0;for(;!0===n.call(this)&&!0===a;)a=this.doSingleRepetition(i);this.attemptInRepetitionRecovery(this.manyInternal,[e,t],n,768,e,nL,a)}manySepFirstInternal(e,t){let r=this.getKeyForAutomaticLookahead(1280,e);this.manySepFirstInternalLogic(e,t,r)}manySepFirstInternalLogic(e,t,r){let i=t.DEF,n=t.SEP;if(!0===this.getLaFuncFromCache(r).call(this)){i.call(this);let t=()=>this.tokenMatcher(this.LA(1),n);for(;!0===this.tokenMatcher(this.LA(1),n);)this.CONSUME(n),i.call(this);this.attemptInRepetitionRecovery(this.repetitionSepSecondInternal,[e,n,t,i,nU],t,1280,e,nU)}}repetitionSepSecondInternal(e,t,r,i,n){for(;r();)this.CONSUME(t),i.call(this);this.attemptInRepetitionRecovery(this.repetitionSepSecondInternal,[e,t,r,i,n],r,1536,e,n)}doSingleRepetition(e){let t=this.getLexerPosition();return e.call(this),this.getLexerPosition()>t}orInternal(e,t){let r=this.getKeyForAutomaticLookahead(256,t),i=k(e)?e:e.DEF,n=this.getLaFuncFromCache(r).call(this,i);if(void 0!==n)return i[n].ALT.call(this);this.raiseNoAltException(t,e.ERR_MSG)}ruleFinallyStateUpdate(){if(this.RULE_STACK.pop(),this.RULE_OCCURRENCE_STACK.pop(),this.cstFinallyStateUpdate(),0===this.RULE_STACK.length&&!1===this.isAtEndOfInput()){let e=this.LA(1),t=this.errorMessageProvider.buildNotAllInputParsedMessage({firstRedundant:e,ruleName:this.getCurrRuleFullName()});this.SAVE_ERROR(new ai(t,e))}}subruleInternal(e,t,r){let i;try{let n=void 0!==r?r.ARGS:void 0;return this.subruleIdx=t,i=e.apply(this,n),this.cstPostNonTerminal(i,void 0!==r&&void 0!==r.LABEL?r.LABEL:e.ruleName),i}catch(t){throw this.subruleInternalError(t,r,e.ruleName)}}subruleInternalError(e,t,r){throw n7(e)&&void 0!==e.partialCstResult&&(this.cstPostNonTerminal(e.partialCstResult,void 0!==t&&void 0!==t.LABEL?t.LABEL:r),delete e.partialCstResult),e}consumeInternal(e,t,r){let i;try{let t=this.LA(1);!0===this.tokenMatcher(t,e)?(this.consumeToken(),i=t):this.consumeInternalError(e,t,r)}catch(r){i=this.consumeInternalRecovery(e,t,r)}return this.cstPostTerminal(void 0!==r&&void 0!==r.LABEL?r.LABEL:e.name,i),i}consumeInternalError(e,t,r){let i;let n=this.LA(0);throw i=void 0!==r&&r.ERR_MSG?r.ERR_MSG:this.errorMessageProvider.buildMismatchTokenMessage({expected:e,actual:t,previous:n,ruleName:this.getCurrRuleFullName()}),this.SAVE_ERROR(new at(i,t,n))}consumeInternalRecovery(e,t,r){if(this.recoveryEnabled&&"MismatchedTokenException"===r.name&&!this.isBackTracking()){let i=this.getFollowsForInRuleRecovery(e,t);try{return this.tryInRuleRecovery(e,i)}catch(e){if(e.name===as)throw r;throw e}}else throw r}saveRecogState(){let e=this.errors,t=ri(this.RULE_STACK);return{errors:e,lexerState:this.exportLexerState(),RULE_STACK:t,CST_STACK:this.CST_STACK}}reloadRecogState(e){this.errors=e.errors,this.importLexerState(e.lexerState),this.RULE_STACK=e.RULE_STACK}ruleInvocationStateUpdate(e,t,r){this.RULE_OCCURRENCE_STACK.push(r),this.RULE_STACK.push(e),this.cstInvocationStateUpdate(t)}isBackTracking(){return 0!==this.isBackTrackingStack.length}getCurrRuleFullName(){let e=this.getLastExplicitRuleShortName();return this.shortRuleNameToFull[e]}shortRuleNameToFullName(e){return this.shortRuleNameToFull[e]}isAtEndOfInput(){return this.tokenMatcher(this.LA(1),nw)}reset(){this.resetLexerState(),this.subruleIdx=0,this.isBackTrackingStack=[],this.errors=[],this.RULE_STACK=[],this.CST_STACK=[],this.RULE_OCCURRENCE_STACK=[]}}class aS{initErrorHandler(e){this._errors=[],this.errorMessageProvider=r$(e,"errorMessageProvider")?e.errorMessageProvider:aL.errorMessageProvider}SAVE_ERROR(e){if(n7(e))return e.context={ruleStack:this.getHumanReadableRuleStack(),ruleOccurrenceStack:ri(this.RULE_OCCURRENCE_STACK)},this._errors.push(e),e;throw Error("Trying to save an Error which is not a RecognitionException")}get errors(){return ri(this._errors)}set errors(e){this._errors=e}raiseEarlyExitException(e,t,r){let i=this.getCurrRuleFullName(),n=nZ(e,this.getGAstProductions()[i],t,this.maxLookahead)[0],a=[];for(let e=1;e<=this.maxLookahead;e++)a.push(this.LA(e));let s=this.errorMessageProvider.buildEarlyExitMessage({expectedIterationPaths:n,actual:a,previous:this.LA(0),customUserDescription:r,ruleName:i});throw this.SAVE_ERROR(new an(s,this.LA(1),this.LA(0)))}raiseNoAltException(e,t){let r=this.getCurrRuleFullName(),i=nq(e,this.getGAstProductions()[r],this.maxLookahead),n=[];for(let e=1;e<=this.maxLookahead;e++)n.push(this.LA(e));let a=this.LA(0),s=this.errorMessageProvider.buildNoViableAltMessage({expectedPathsPerAlt:i,actual:n,previous:a,customUserDescription:t,ruleName:this.getCurrRuleFullName()});throw this.SAVE_ERROR(new ar(s,this.LA(1),a))}}class aE{initContentAssist(){}computeContentAssist(e,t){let r=this.gastProductionsCache[e];if(r9(r))throw Error(`Rule ->${e}<- does not exist in this grammar.`);return nV([r],t,this.tokenMatcher,this.maxLookahead)}getNextPossibleTokenTypes(e){let t=rH(e.ruleStack);return new nk(this.getGAstProductions()[t],e).startWalking()}}let aR={description:"This Object indicates the Parser is during Recording Phase"};Object.freeze(aR);let aA=nA({name:"RECORDING_PHASE_TOKEN",pattern:nf.NA});nc([aA]);let aw=nM(aA,"This IToken indicates the Parser is in Recording Phase\n	See: https://chevrotain.io/docs/guide/internals.html#grammar-recording for details",-1,-1,-1,-1,-1,-1);Object.freeze(aw);let aM={name:"This CSTNode indicates the Parser is in Recording Phase\n	See: https://chevrotain.io/docs/guide/internals.html#grammar-recording for details",children:{}};class aC{initGastRecorder(e){this.recordingProdStack=[],this.RECORDING_PHASE=!1}enableRecording(){this.RECORDING_PHASE=!0,this.TRACE_INIT("Enable Recording",()=>{for(let e=0;e<10;e++){let t=e>0?e:"";this[`CONSUME${t}`]=function(t,r){return this.consumeInternalRecord(t,e,r)},this[`SUBRULE${t}`]=function(t,r){return this.subruleInternalRecord(t,e,r)},this[`OPTION${t}`]=function(t){return this.optionInternalRecord(t,e)},this[`OR${t}`]=function(t){return this.orInternalRecord(t,e)},this[`MANY${t}`]=function(t){this.manyInternalRecord(e,t)},this[`MANY_SEP${t}`]=function(t){this.manySepFirstInternalRecord(e,t)},this[`AT_LEAST_ONE${t}`]=function(t){this.atLeastOneInternalRecord(e,t)},this[`AT_LEAST_ONE_SEP${t}`]=function(t){this.atLeastOneSepFirstInternalRecord(e,t)}}this.consume=function(e,t,r){return this.consumeInternalRecord(t,e,r)},this.subrule=function(e,t,r){return this.subruleInternalRecord(t,e,r)},this.option=function(e,t){return this.optionInternalRecord(t,e)},this.or=function(e,t){return this.orInternalRecord(t,e)},this.many=function(e,t){this.manyInternalRecord(e,t)},this.atLeastOne=function(e,t){this.atLeastOneInternalRecord(e,t)},this.ACTION=this.ACTION_RECORD,this.BACKTRACK=this.BACKTRACK_RECORD,this.LA=this.LA_RECORD})}disableRecording(){this.RECORDING_PHASE=!1,this.TRACE_INIT("Deleting Recording methods",()=>{for(let e=0;e<10;e++){let t=e>0?e:"";delete this[`CONSUME${t}`],delete this[`SUBRULE${t}`],delete this[`OPTION${t}`],delete this[`OR${t}`],delete this[`MANY${t}`],delete this[`MANY_SEP${t}`],delete this[`AT_LEAST_ONE${t}`],delete this[`AT_LEAST_ONE_SEP${t}`]}delete this.consume,delete this.subrule,delete this.option,delete this.or,delete this.many,delete this.atLeastOne,delete this.ACTION,delete this.BACKTRACK,delete this.LA})}ACTION_RECORD(e){}BACKTRACK_RECORD(e,t){return()=>!0}LA_RECORD(e){return a_}topLevelRuleRecord(e,t){try{let r=new im({definition:[],name:e});return r.name=e,this.recordingProdStack.push(r),t.call(this),this.recordingProdStack.pop(),r}catch(e){if(!0!==e.KNOWN_RECORDER_ERROR)try{e.message=e.message+'\n	 This error was thrown during the "grammar recording phase" For more info see:\n	https://chevrotain.io/docs/guide/internals.html#grammar-recording'}catch(t){throw e}throw e}}optionInternalRecord(e,t){return aI.call(this,Option,e,t)}atLeastOneInternalRecord(e,t){aI.call(this,iv,t,e)}atLeastOneSepFirstInternalRecord(e,t){aI.call(this,iy,t,e,!0)}manyInternalRecord(e,t){aI.call(this,ix,t,e)}manySepFirstInternalRecord(e,t){aI.call(this,iT,t,e,!0)}orInternalRecord(e,t){return aN.call(this,e,t)}subruleInternalRecord(e,t,r){if(aP(t),!e||!1===r$(e,"ruleName")){let r=Error(`<SUBRULE${aO(t)}> argument is invalid expecting a Parser method reference but got: <${JSON.stringify(e)}>
 inside top level rule: <${this.recordingProdStack[0].name}>`);throw r.KNOWN_RECORDER_ERROR=!0,r}let i=rk(this.recordingProdStack),n=new id({idx:t,nonTerminalName:e.ruleName,label:null==r?void 0:r.LABEL,referencedRule:void 0});return i.definition.push(n),this.outputCst?aM:aR}consumeInternalRecord(e,t,r){if(aP(t),!nu(e)){let r=Error(`<CONSUME${aO(t)}> argument is invalid expecting a TokenType reference but got: <${JSON.stringify(e)}>
 inside top level rule: <${this.recordingProdStack[0].name}>`);throw r.KNOWN_RECORDER_ERROR=!0,r}let i=rk(this.recordingProdStack),n=new iS({idx:t,terminalType:e,label:null==r?void 0:r.LABEL});return i.definition.push(n),aw}}function aI(e,t,r,i=!1){aP(r);let n=rk(this.recordingProdStack),a=Y(t)?t:t.DEF,s=new e({definition:[],idx:r});return i&&(s.separator=t.SEP),r$(t,"MAX_LOOKAHEAD")&&(s.maxLookahead=t.MAX_LOOKAHEAD),this.recordingProdStack.push(s),a.call(this),n.definition.push(s),this.recordingProdStack.pop(),aR}function aN(e,t){aP(t);let r=rk(this.recordingProdStack),i=!1===k(e),n=!1===i?e:e.DEF,a=new ib({definition:[],idx:t,ignoreAmbiguities:i&&!0===e.IGNORE_AMBIGUITIES});r$(e,"MAX_LOOKAHEAD")&&(a.maxLookahead=e.MAX_LOOKAHEAD);let s=ia(n,e=>Y(e.GATE));return a.hasPredicates=s,r.definition.push(a),rU(n,e=>{let t=new ig({definition:[]});a.definition.push(t),r$(e,"IGNORE_AMBIGUITIES")?t.ignoreAmbiguities=e.IGNORE_AMBIGUITIES:r$(e,"GATE")&&(t.ignoreAmbiguities=!0),this.recordingProdStack.push(t),e.ALT.call(this),this.recordingProdStack.pop()}),aR}function aO(e){return 0===e?"":`${e}`}function aP(e){if(e<0||e>255){let t=Error(`Invalid DSL Method idx value: <${e}>
	Idx value must be a none negative value smaller than 256`);throw t.KNOWN_RECORDER_ERROR=!0,t}}class ak{initPerformanceTracer(e){if(r$(e,"traceInitPerf")){let t=e.traceInitPerf,r="number"==typeof t;this.traceInitMaxIdent=r?t:1/0,this.traceInitPerf=r?t>0:t}else this.traceInitMaxIdent=0,this.traceInitPerf=aL.traceInitPerf;this.traceInitIndent=-1}TRACE_INIT(e,t){if(!0!==this.traceInitPerf)return t();{this.traceInitIndent++;let r=Array(this.traceInitIndent+1).join("	");this.traceInitIndent<this.traceInitMaxIdent&&console.log(`${r}--> <${e}>`);let{time:i,value:n}=iu(t),a=i>10?console.warn:console.log;return this.traceInitIndent<this.traceInitMaxIdent&&a(`${r}<-- <${e}> time: ${i}ms`),this.traceInitIndent--,n}}}let a_=nM(nw,"",NaN,NaN,NaN,NaN,NaN,NaN);Object.freeze(a_);let aL=Object.freeze({recoveryEnabled:!1,maxLookahead:3,dynamicTokensEnabled:!1,outputCst:!0,errorMessageProvider:nC,nodeLocationTracking:"none",traceInitPerf:!1,skipValidations:!1}),aU=Object.freeze({recoveryValueFunc:()=>void 0,resyncEnabled:!0});(f=y||(y={}))[f.INVALID_RULE_NAME=0]="INVALID_RULE_NAME",f[f.DUPLICATE_RULE_NAME=1]="DUPLICATE_RULE_NAME",f[f.INVALID_RULE_OVERRIDE=2]="INVALID_RULE_OVERRIDE",f[f.DUPLICATE_PRODUCTIONS=3]="DUPLICATE_PRODUCTIONS",f[f.UNRESOLVED_SUBRULE_REF=4]="UNRESOLVED_SUBRULE_REF",f[f.LEFT_RECURSION=5]="LEFT_RECURSION",f[f.NONE_LAST_EMPTY_ALT=6]="NONE_LAST_EMPTY_ALT",f[f.AMBIGUOUS_ALTS=7]="AMBIGUOUS_ALTS",f[f.CONFLICT_TOKENS_RULES_NAMESPACE=8]="CONFLICT_TOKENS_RULES_NAMESPACE",f[f.INVALID_TOKEN_NAME=9]="INVALID_TOKEN_NAME",f[f.NO_NON_EMPTY_LOOKAHEAD=10]="NO_NON_EMPTY_LOOKAHEAD",f[f.AMBIGUOUS_PREFIX_ALTS=11]="AMBIGUOUS_PREFIX_ALTS",f[f.TOO_MANY_ALTS=12]="TOO_MANY_ALTS",f[f.CUSTOM_LOOKAHEAD_VALIDATION=13]="CUSTOM_LOOKAHEAD_VALIDATION";class aD{static performSelfAnalysis(e){throw Error("The **static** `performSelfAnalysis` method has been deprecated.	\nUse the **instance** method with the same name instead.")}performSelfAnalysis(){this.TRACE_INIT("performSelfAnalysis",()=>{let e;this.selfAnalysisDone=!0;let t=this.className;this.TRACE_INIT("toFastProps",()=>{ih(this)}),this.TRACE_INIT("Grammar Recording",()=>{try{this.enableRecording(),rU(this.definedRulesNames,e=>{let t;let r=this[e].originalGrammarAction;this.TRACE_INIT(`${e} Rule`,()=>{t=this.topLevelRuleRecord(e,r)}),this.gastProductionsCache[e]=t})}finally{this.disableRecording()}});let r=[];if(this.TRACE_INIT("Grammar Resolving",()=>{r=function(e){let t=rI(e,{errMsgProvider:nI}),r={};return rU(e.rules,e=>{r[e.name]=e}),function(e,t){let r=new nO(e,t);return r.resolveRefs(),r.errors}(r,t.errMsgProvider)}({rules:rJ(this.gastProductionsCache)}),this.definitionErrors=this.definitionErrors.concat(r)}),this.TRACE_INIT("Grammar Validations",()=>{if(r5(r)&&!1===this.skipValidations){var e,i;let r=function(e,t,r,i){let n=rK(e,e=>(function(e,t){let r=new n1;return e.accept(r),rW(rJ(r7(rY(r.allProductions,nJ),e=>e.length>1)),r=>{let i=rH(r),n=t.buildDuplicateFoundError(e,r),a=iA(i),s={message:n,type:y.DUPLICATE_PRODUCTIONS,ruleName:e.name,dslName:a,occurrence:i.idx},o=n0(i);return o&&(s.parameter=o),s})})(e,r)),a=function(e,t,r){let i=[],n=rW(t,e=>e.name);return rU(e,e=>{let t=e.name;if(r1(n,t)){let n=r.buildNamespaceConflictError(e);i.push({message:n,type:y.CONFLICT_TOKENS_RULES_NAMESPACE,ruleName:t})}}),i}(e,t,r),s=rK(e,e=>(function(e,t){let r=new n2;return e.accept(r),rK(r.alternations,r=>r.definition.length>255?[{message:t.buildTooManyAlternativesError({topLevelRule:e,alternation:r}),type:y.TOO_MANY_ALTS,ruleName:e.name,occurrence:r.idx}]:[])})(e,r)),o=rK(e,t=>(function(e,t,r,i){let n=[];if(it(t,(t,r)=>r.name===e.name?t+1:t,0)>1){let t=i.buildDuplicateRuleNameError({topLevelRule:e,grammarName:r});n.push({message:t,type:y.DUPLICATE_RULE_NAME,ruleName:e.name})}return n})(t,e,i,r));return n.concat(a,s,o)}((e=rI(e={rules:rJ(this.gastProductionsCache),tokenTypes:rJ(this.tokensMap),errMsgProvider:nN,grammarName:t},{errMsgProvider:nN})).rules,e.tokenTypes,e.errMsgProvider,e.grammarName),n=rW((i={lookaheadStrategy:this.lookaheadStrategy,rules:rJ(this.gastProductionsCache),tokenTypes:rJ(this.tokensMap),grammarName:t}).lookaheadStrategy.validate({rules:i.rules,tokenTypes:i.tokenTypes,grammarName:i.grammarName}),e=>Object.assign({type:y.CUSTOM_LOOKAHEAD_VALIDATION},e));this.definitionErrors=this.definitionErrors.concat(r,n)}}),r5(this.definitionErrors)&&(this.recoveryEnabled&&this.TRACE_INIT("computeAllProdsFollows",()=>{let e=function(e){let t={};return rU(e,e=>{e2(t,new iN(e).startWalking())}),t}(rJ(this.gastProductionsCache));this.resyncFollows=e}),this.TRACE_INIT("ComputeLookaheadFunctions",()=>{var e,t;null===(t=(e=this.lookaheadStrategy).initialize)||void 0===t||t.call(e,{rules:rJ(this.gastProductionsCache)}),this.preComputeLookaheadFunctions(rJ(this.gastProductionsCache))})),!aD.DEFER_DEFINITION_ERRORS_HANDLING&&!r5(this.definitionErrors))throw e=rW(this.definitionErrors,e=>e.message),Error(`Parser Definition Errors detected:
 ${e.join("\n-------------------------------\n")}`)})}constructor(e,t){if(this.definitionErrors=[],this.selfAnalysisDone=!1,this.initErrorHandler(t),this.initLexerAdapter(),this.initLooksAhead(t),this.initRecognizerEngine(e,t),this.initRecoverable(t),this.initTreeBuilder(t),this.initContentAssist(),this.initGastRecorder(t),this.initPerformanceTracer(t),r$(t,"ignoredIssues"))throw Error("The <ignoredIssues> IParserConfig property has been deprecated.\n	Please use the <IGNORE_AMBIGUITIES> flag on the relevant DSL method instead.\n	See: https://chevrotain.io/docs/guide/resolving_grammar_errors.html#IGNORING_AMBIGUITIES\n	For further details.");this.skipValidations=r$(t,"skipValidations")?t.skipValidations:aL.skipValidations}}aD.DEFER_DEFINITION_ERRORS_HANDLING=!1,function(e,t){t.forEach(t=>{let r=t.prototype;Object.getOwnPropertyNames(r).forEach(i=>{if("constructor"===i)return;let n=Object.getOwnPropertyDescriptor(r,i);n&&(n.get||n.set)?Object.defineProperty(e.prototype,i,n):e.prototype[i]=t.prototype[i]})})}(aD,[al,ah,ay,ax,ab,aT,aS,aE,aC,ak]);class aF extends aD{constructor(e,t=aL){let r=ri(t);r.outputCst=!0,super(e,r)}}return{CstParser:aF,Lexer:nf,createToken:function(e){return nA(e)}}})();class rS{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){let t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return -1}_onMessage(e,t){let r=this.workersResolve[e];if(r&&r(t),this.queue.length){let{resolve:t,msg:r,transfer:i}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(r,i)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(r=>{let i=this._getIdleWorker();-1!==i?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=r,this.workers[i].postMessage(e,t)):this.queue.push({resolve:r,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}class rE extends f.CompressedTexture{constructor(e,t,r,i,n,a){super(e,t,r,n,a),this.isCompressedArrayTexture=!0,this.image.depth=i,this.wrapR=f.ClampToEdgeWrapping}}let rR=new WeakMap,rA=0,rw=class extends f.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new rS,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},e.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this}init(){if(!this.transcoderPending){let e=new f.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);let t=e.loadAsync("basis_transcoder.js"),r=new f.FileLoader(this.manager);r.setPath(this.transcoderPath),r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials);let i=r.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,i]).then(([e,t])=>{let r=rw.BasisWorker.toString(),i=["/* constants */","let _EngineFormat = "+JSON.stringify(rw.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(rw.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(rw.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i])),this.transcoderBinary=t,this.workerPool.setWorkerCreator(()=>{let e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e})}),rA>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),rA++}return this.transcoderPending}load(e,t,r,i){if(null===this.workerConfig)throw Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");let n=new f.FileLoader(this.manager);n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials),n.load(e,e=>{if(rR.has(e))return rR.get(e).promise.then(t).catch(i);this._createTexture(e).then(e=>t?t(e):null).catch(i)},r,i)}_createTextureFrom(e,t){let{mipmaps:r,width:i,height:n,format:a,type:s,error:o,dfdTransferFn:l,dfdFlags:c}=e;if("error"===s)return Promise.reject(o);let u=t.layerCount>1?new rE(r,i,n,t.layerCount,a,f.UnsignedByteType):new f.CompressedTexture(r,i,n,a,f.UnsignedByteType);return u.minFilter=1===r.length?f.LinearFilter:f.LinearMipmapLinearFilter,u.magFilter=f.LinearFilter,u.generateMipmaps=!1,u.needsUpdate=!0,"colorSpace"in u?u.colorSpace=l===m.FVZ?"srgb":"srgb-linear":u.encoding=l===m.FVZ?3001:3e3,u.premultiplyAlpha=!!(c&m.qHj),u}async _createTexture(e,t={}){let r=(0,m.ij3)(new Uint8Array(e));if(r.vkFormat!==m.kXg)return rN(r);let i=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:t},[e])).then(e=>this._createTextureFrom(e.data,r));return rR.set(e,{promise:i}),i}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),rA--,this}};x(rw,"BasisFormat",{ETC1S:0,UASTC_4x4:1}),x(rw,"TranscoderFormat",{ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16}),x(rw,"EngineFormat",{RGBAFormat:f.RGBAFormat,RGBA_ASTC_4x4_Format:f.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:f.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:f.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:f.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:f.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:f.RGB_ETC1_Format,RGB_ETC2_Format:f.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:f.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:f.RGB_S3TC_DXT1_Format}),x(rw,"BasisWorker",function(){let e,t,r;let i=_EngineFormat,n=_TranscoderFormat,a=_BasisFormat;self.addEventListener("message",function(s){let u=s.data;switch(u.type){case"init":var h;e=u.config,h=u.transcoderBinary,t=new Promise(e=>{r={wasmBinary:h,onRuntimeInitialized:e},BASIS(r)}).then(()=>{r.initializeBasis(),void 0===r.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")});break;case"transcode":t.then(()=>{try{let{width:t,height:s,hasAlpha:h,mipmaps:p,format:d,dfdTransferFn:f,dfdFlags:m}=function(t){let s=new r.KTX2File(new Uint8Array(t));function u(){s.close(),s.delete()}if(!s.isValid())throw u(),Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");let h=s.isUASTC()?a.UASTC_4x4:a.ETC1S,p=s.getWidth(),d=s.getHeight(),f=s.getLayers()||1,m=s.getLevels(),g=s.getHasAlpha(),v=s.getDFDTransferFunc(),y=s.getDFDFlags(),{transcoderFormat:x,engineFormat:T}=function(t,r,s,u){let h;let p=t===a.ETC1S?o:l;for(let i=0;i<p.length;i++){let n=p[i];if(e[n.if]&&n.basisFormat.includes(t)&&(!u||!(n.transcoderFormat.length<2))&&(!n.needsPowerOfTwo||c(r)&&c(s)))return{transcoderFormat:n.transcoderFormat[u?1:0],engineFormat:n.engineFormat[u?1:0]}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),{transcoderFormat:n.RGBA32,engineFormat:i.RGBAFormat}}(h,p,d,g);if(!p||!d||!m)throw u(),Error("THREE.KTX2Loader:	Invalid texture");if(!s.startTranscoding())throw u(),Error("THREE.KTX2Loader: .startTranscoding failed");let b=[];for(let e=0;e<m;e++){let t,r;let i=[];for(let n=0;n<f;n++){let a=s.getImageLevelInfo(e,n,0);t=a.origWidth<4?a.origWidth:a.width,r=a.origHeight<4?a.origHeight:a.height;let o=new Uint8Array(s.getImageTranscodedSizeInBytes(e,n,0,x));if(!s.transcodeImage(o,e,n,0,x,0,-1,-1))throw u(),Error("THREE.KTX2Loader: .transcodeImage failed.");i.push(o)}b.push({data:function(e){let t=0;for(let r=0;r<e.length;r++)t+=e[r].byteLength;let r=new Uint8Array(t),i=0;for(let t=0;t<e.length;t++){let n=e[t];r.set(n,i),i+=n.byteLength}return r}(i),width:t,height:r})}return u(),{width:p,height:d,hasAlpha:g,mipmaps:b,format:T,dfdTransferFn:v,dfdFlags:y}}(u.buffer),g=[];for(let e=0;e<p.length;++e)g.push(p[e].data.buffer);self.postMessage({type:"transcode",id:u.id,width:t,height:s,hasAlpha:h,mipmaps:p,format:d,dfdTransferFn:f,dfdFlags:m},g)}catch(e){console.error(e),self.postMessage({type:"error",id:u.id,error:e.message})}})}});let s=[{if:"astcSupported",basisFormat:[a.UASTC_4x4],transcoderFormat:[n.ASTC_4x4,n.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.BC7_M5,n.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.BC1,n.BC3],engineFormat:[i.RGB_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.ETC1,n.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.ETC1],engineFormat:[i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.PVRTC1_4_RGB,n.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],o=s.sort(function(e,t){return e.priorityETC1S-t.priorityETC1S}),l=s.sort(function(e,t){return e.priorityUASTC-t.priorityUASTC});function c(e){return e<=2||(e&e-1)==0&&0!==e}});let rM={[m.qfi]:f.RGBAFormat,[m.IgZ]:f.RGBAFormat,[m.MCP]:f.RGBAFormat,[m.OmG]:f.RGBAFormat,[m.bWS]:f.RGFormat,[m.LR2]:f.RGFormat,[m.gJS]:f.RGFormat,[m.IJq]:f.RGFormat,[m.eQx]:f.RedFormat,[m.wOb]:f.RedFormat,[m.e1Y]:f.RedFormat,[m.tLr]:f.RedFormat},rC={[m.qfi]:f.FloatType,[m.IgZ]:f.HalfFloatType,[m.MCP]:f.UnsignedByteType,[m.OmG]:f.UnsignedByteType,[m.bWS]:f.FloatType,[m.LR2]:f.HalfFloatType,[m.gJS]:f.UnsignedByteType,[m.IJq]:f.UnsignedByteType,[m.eQx]:f.FloatType,[m.wOb]:f.HalfFloatType,[m.e1Y]:f.UnsignedByteType,[m.tLr]:f.UnsignedByteType},rI={[m.OmG]:3001,[m.IJq]:3001,[m.e1Y]:3001};async function rN(e){let t,r;let{vkFormat:i,pixelWidth:n,pixelHeight:a,pixelDepth:s}=e;if(void 0===rM[i])throw Error("THREE.KTX2Loader: Unsupported vkFormat.");let o=e.levels[0];if(e.supercompressionScheme===m.Oi)t=o.levelData;else if(e.supercompressionScheme===m.c6w)u||(u=new Promise(async e=>{let t=new g.L;await t.init(),e(t)})),t=(await u).decode(o.levelData,o.uncompressedByteLength);else throw Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");r=rC[i]===f.FloatType?new Float32Array(t.buffer,t.byteOffset,t.byteLength/Float32Array.BYTES_PER_ELEMENT):rC[i]===f.HalfFloatType?new Uint16Array(t.buffer,t.byteOffset,t.byteLength/Uint16Array.BYTES_PER_ELEMENT):t;let l=0===s?new f.DataTexture(r,n,a):new ry(r,n,a,s);return l.type=rC[i],l.format=rM[i],l.encoding=rI[i]||3e3,l.needsUpdate=!0,Promise.resolve(l)}let{parseBuffer:rO}=(()=>{function e(){this.table=new Uint16Array(16),this.trans=new Uint16Array(288)}function t(t,r){this.source=t,this.sourceIndex=0,this.tag=0,this.bitcount=0,this.dest=r,this.destLen=0,this.ltree=new e,this.dtree=new e}var r,i,n,a,s,o=new e,l=new e,c=new Uint8Array(30),u=new Uint16Array(30),h=new Uint8Array(30),p=new Uint16Array(30),d=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),f=new e,m=new Uint8Array(320);function g(e,t,r,i){var n,a;for(n=0;n<r;++n)e[n]=0;for(n=0;n<30-r;++n)e[n+r]=n/r|0;for(a=i,n=0;n<30;++n)t[n]=a,a+=1<<e[n]}var v=new Uint16Array(16);function y(e,t,r,i){var n,a;for(n=0;n<16;++n)e.table[n]=0;for(n=0;n<i;++n)e.table[t[r+n]]++;for(a=0,e.table[0]=0,n=0;n<16;++n)v[n]=a,a+=e.table[n];for(n=0;n<i;++n)t[r+n]&&(e.trans[v[t[r+n]]++]=n)}function x(e,t,r){if(!t)return r;for(;e.bitcount<24;)e.tag|=e.source[e.sourceIndex++]<<e.bitcount,e.bitcount+=8;var i=e.tag&65535>>>16-t;return e.tag>>>=t,e.bitcount-=t,i+r}function T(e,t){for(;e.bitcount<24;)e.tag|=e.source[e.sourceIndex++]<<e.bitcount,e.bitcount+=8;var r=0,i=0,n=0,a=e.tag;do i=2*i+(1&a),a>>>=1,++n,r+=t.table[n],i-=t.table[n];while(i>=0);return e.tag=a,e.bitcount-=n,t.trans[r+i]}function b(e,t,r){for(;;){var i,n,a,s,o=T(e,t);if(256===o)return 0;if(o<256)e.dest[e.destLen++]=o;else for(o-=257,i=x(e,c[o],u[o]),n=T(e,r),s=a=e.destLen-x(e,h[n],p[n]);s<a+i;++s)e.dest[e.destLen++]=e.dest[s]}}!function(e,t){var r;for(r=0;r<7;++r)e.table[r]=0;for(r=0,e.table[7]=24,e.table[8]=152,e.table[9]=112;r<24;++r)e.trans[r]=256+r;for(r=0;r<144;++r)e.trans[24+r]=r;for(r=0;r<8;++r)e.trans[168+r]=280+r;for(r=0;r<112;++r)e.trans[176+r]=144+r;for(r=0;r<5;++r)t.table[r]=0;for(r=0,t.table[5]=32;r<32;++r)t.trans[r]=r}(o,l),g(c,u,4,3),g(h,p,2,1),c[28]=0,u[28]=258;var S=function(e,r){var i,n,a=new t(e,r);do{switch(i=function(e){e.bitcount--||(e.tag=e.source[e.sourceIndex++],e.bitcount=7);var t=1&e.tag;return e.tag>>>=1,t}(a),x(a,2,0)){case 0:n=function(e){for(var t,r;e.bitcount>8;)e.sourceIndex--,e.bitcount-=8;if((t=256*(t=e.source[e.sourceIndex+1])+e.source[e.sourceIndex])!==(65535&~(256*e.source[e.sourceIndex+3]+e.source[e.sourceIndex+2])))return -3;for(e.sourceIndex+=4,r=t;r;--r)e.dest[e.destLen++]=e.source[e.sourceIndex++];return e.bitcount=0,0}(a);break;case 1:n=b(a,o,l);break;case 2:!function(e,t,r){for(s=0,i=x(e,5,257),n=x(e,5,1),a=x(e,4,4);s<19;++s)m[s]=0;for(s=0;s<a;++s){var i,n,a,s,o,l,c=x(e,3,0);m[d[s]]=c}for(y(f,m,0,19),o=0;o<i+n;){var u=T(e,f);switch(u){case 16:var h=m[o-1];for(l=x(e,2,3);l;--l)m[o++]=h;break;case 17:for(l=x(e,3,3);l;--l)m[o++]=0;break;case 18:for(l=x(e,7,11);l;--l)m[o++]=0;break;default:m[o++]=u}}y(t,m,0,i),y(r,m,i,n)}(a,a.ltree,a.dtree),n=b(a,a.ltree,a.dtree);break;default:n=-3}if(0!==n)throw Error("Data error")}while(!i);return a.destLen<a.dest.length?"function"==typeof a.dest.slice?a.dest.slice(0,a.destLen):a.dest.subarray(0,a.destLen):a.dest};function E(e,t,r,i,n){return Math.pow(1-n,3)*e+3*Math.pow(1-n,2)*n*t+3*(1-n)*Math.pow(n,2)*r+Math.pow(n,3)*i}function R(){this.x1=Number.NaN,this.y1=Number.NaN,this.x2=Number.NaN,this.y2=Number.NaN}function A(){this.commands=[],this.fill="black",this.stroke=null,this.strokeWidth=1}function w(e){throw Error(e)}function M(e,t){e||w(t)}R.prototype.isEmpty=function(){return isNaN(this.x1)||isNaN(this.y1)||isNaN(this.x2)||isNaN(this.y2)},R.prototype.addPoint=function(e,t){"number"==typeof e&&((isNaN(this.x1)||isNaN(this.x2))&&(this.x1=e,this.x2=e),e<this.x1&&(this.x1=e),e>this.x2&&(this.x2=e)),"number"==typeof t&&((isNaN(this.y1)||isNaN(this.y2))&&(this.y1=t,this.y2=t),t<this.y1&&(this.y1=t),t>this.y2&&(this.y2=t))},R.prototype.addX=function(e){this.addPoint(e,null)},R.prototype.addY=function(e){this.addPoint(null,e)},R.prototype.addBezier=function(e,t,r,i,n,a,s,o){var l=[e,t],c=[r,i],u=[n,a],h=[s,o];this.addPoint(e,t),this.addPoint(s,o);for(var p=0;p<=1;p++){var d=6*l[p]-12*c[p]+6*u[p],f=-3*l[p]+9*c[p]-9*u[p]+3*h[p],m=3*c[p]-3*l[p];if(0===f){if(0===d)continue;var g=-m/d;0<g&&g<1&&(0===p&&this.addX(E(l[p],c[p],u[p],h[p],g)),1===p&&this.addY(E(l[p],c[p],u[p],h[p],g)));continue}var v=Math.pow(d,2)-4*m*f;if(!(v<0)){var y=(-d+Math.sqrt(v))/(2*f);0<y&&y<1&&(0===p&&this.addX(E(l[p],c[p],u[p],h[p],y)),1===p&&this.addY(E(l[p],c[p],u[p],h[p],y)));var x=(-d-Math.sqrt(v))/(2*f);0<x&&x<1&&(0===p&&this.addX(E(l[p],c[p],u[p],h[p],x)),1===p&&this.addY(E(l[p],c[p],u[p],h[p],x)))}}},R.prototype.addQuad=function(e,t,r,i,n,a){var s=e+2/3*(r-e),o=t+2/3*(i-t);this.addBezier(e,t,s,o,s+1/3*(n-e),o+1/3*(a-t),n,a)},A.prototype.moveTo=function(e,t){this.commands.push({type:"M",x:e,y:t})},A.prototype.lineTo=function(e,t){this.commands.push({type:"L",x:e,y:t})},A.prototype.curveTo=A.prototype.bezierCurveTo=function(e,t,r,i,n,a){this.commands.push({type:"C",x1:e,y1:t,x2:r,y2:i,x:n,y:a})},A.prototype.quadTo=A.prototype.quadraticCurveTo=function(e,t,r,i){this.commands.push({type:"Q",x1:e,y1:t,x:r,y:i})},A.prototype.close=A.prototype.closePath=function(){this.commands.push({type:"Z"})},A.prototype.extend=function(e){if(e.commands)e=e.commands;else if(e instanceof R){var t=e;this.moveTo(t.x1,t.y1),this.lineTo(t.x2,t.y1),this.lineTo(t.x2,t.y2),this.lineTo(t.x1,t.y2),this.close();return}Array.prototype.push.apply(this.commands,e)},A.prototype.getBoundingBox=function(){for(var e=new R,t=0,r=0,i=0,n=0,a=0;a<this.commands.length;a++){var s=this.commands[a];switch(s.type){case"M":e.addPoint(s.x,s.y),t=i=s.x,r=n=s.y;break;case"L":e.addPoint(s.x,s.y),i=s.x,n=s.y;break;case"Q":e.addQuad(i,n,s.x1,s.y1,s.x,s.y),i=s.x,n=s.y;break;case"C":e.addBezier(i,n,s.x1,s.y1,s.x2,s.y2,s.x,s.y),i=s.x,n=s.y;break;case"Z":i=t,n=r;break;default:throw Error("Unexpected path command "+s.type)}}return e.isEmpty()&&e.addPoint(0,0),e},A.prototype.draw=function(e){e.beginPath();for(var t=0;t<this.commands.length;t+=1){var r=this.commands[t];"M"===r.type?e.moveTo(r.x,r.y):"L"===r.type?e.lineTo(r.x,r.y):"C"===r.type?e.bezierCurveTo(r.x1,r.y1,r.x2,r.y2,r.x,r.y):"Q"===r.type?e.quadraticCurveTo(r.x1,r.y1,r.x,r.y):"Z"===r.type&&e.closePath()}this.fill&&(e.fillStyle=this.fill,e.fill()),this.stroke&&(e.strokeStyle=this.stroke,e.lineWidth=this.strokeWidth,e.stroke())},A.prototype.toPathData=function(e){function t(){for(var t=arguments,r="",i=0;i<arguments.length;i+=1){var n=t[i];n>=0&&i>0&&(r+=" "),r+=Math.round(n)===n?""+Math.round(n):n.toFixed(e)}return r}e=void 0!==e?e:2;for(var r="",i=0;i<this.commands.length;i+=1){var n=this.commands[i];"M"===n.type?r+="M"+t(n.x,n.y):"L"===n.type?r+="L"+t(n.x,n.y):"C"===n.type?r+="C"+t(n.x1,n.y1,n.x2,n.y2,n.x,n.y):"Q"===n.type?r+="Q"+t(n.x1,n.y1,n.x,n.y):"Z"===n.type&&(r+="Z")}return r},A.prototype.toSVG=function(e){var t='<path d="';return t+=this.toPathData(e)+'"',this.fill&&"black"!==this.fill&&(null===this.fill?t+=' fill="none"':t+=' fill="'+this.fill+'"'),this.stroke&&(t+=' stroke="'+this.stroke+'" stroke-width="'+this.strokeWidth+'"'),t+="/>"},A.prototype.toDOMElement=function(e){var t=this.toPathData(e),r=document.createElementNS("http://www.w3.org/2000/svg","path");return r.setAttribute("d",t),r};var C={fail:w,argument:M,assert:M},I={},N={},O={};function P(e){return function(){return e}}N.BYTE=function(e){return C.argument(e>=0&&e<=255,"Byte value should be between 0 and 255."),[e]},O.BYTE=P(1),N.CHAR=function(e){return[e.charCodeAt(0)]},O.CHAR=P(1),N.CHARARRAY=function(e){void 0===e&&(e="",console.warn("Undefined CHARARRAY encountered and treated as an empty string. This is probably caused by a missing glyph name."));for(var t=[],r=0;r<e.length;r+=1)t[r]=e.charCodeAt(r);return t},O.CHARARRAY=function(e){return void 0===e?0:e.length},N.USHORT=function(e){return[e>>8&255,255&e]},O.USHORT=P(2),N.SHORT=function(e){return e>=32768&&(e=-(65536-e)),[e>>8&255,255&e]},O.SHORT=P(2),N.UINT24=function(e){return[e>>16&255,e>>8&255,255&e]},O.UINT24=P(3),N.ULONG=function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]},O.ULONG=P(4),N.LONG=function(e){return e>=2147483648&&(e=-(4294967296-e)),[e>>24&255,e>>16&255,e>>8&255,255&e]},O.LONG=P(4),N.FIXED=N.ULONG,O.FIXED=O.ULONG,N.FWORD=N.SHORT,O.FWORD=O.SHORT,N.UFWORD=N.USHORT,O.UFWORD=O.USHORT,N.LONGDATETIME=function(e){return[0,0,0,0,e>>24&255,e>>16&255,e>>8&255,255&e]},O.LONGDATETIME=P(8),N.TAG=function(e){return C.argument(4===e.length,"Tag should be exactly 4 ASCII characters."),[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]},O.TAG=P(4),N.Card8=N.BYTE,O.Card8=O.BYTE,N.Card16=N.USHORT,O.Card16=O.USHORT,N.OffSize=N.BYTE,O.OffSize=O.BYTE,N.SID=N.USHORT,O.SID=O.USHORT,N.NUMBER=function(e){return e>=-107&&e<=107?[e+139]:e>=108&&e<=1131?[((e-=108)>>8)+247,255&e]:e>=-1131&&e<=-108?[((e=-e-108)>>8)+251,255&e]:e>=-32768&&e<=32767?N.NUMBER16(e):N.NUMBER32(e)},O.NUMBER=function(e){return N.NUMBER(e).length},N.NUMBER16=function(e){return[28,e>>8&255,255&e]},O.NUMBER16=P(3),N.NUMBER32=function(e){return[29,e>>24&255,e>>16&255,e>>8&255,255&e]},O.NUMBER32=P(5),N.REAL=function(e){var t=e.toString(),r=/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/.exec(t);if(r){var i=parseFloat("1e"+((r[2]?+r[2]:0)+r[1].length));t=(Math.round(e*i)/i).toString()}for(var n="",a=0,s=t.length;a<s;a+=1){var o=t[a];"e"===o?n+="-"===t[++a]?"c":"b":"."===o?n+="a":"-"===o?n+="e":n+=o}n+=1&n.length?"f":"ff";for(var l=[30],c=0,u=n.length;c<u;c+=2)l.push(parseInt(n.substr(c,2),16));return l},O.REAL=function(e){return N.REAL(e).length},N.NAME=N.CHARARRAY,O.NAME=O.CHARARRAY,N.STRING=N.CHARARRAY,O.STRING=O.CHARARRAY,I.UTF8=function(e,t,r){for(var i=[],n=0;n<r;n++,t+=1)i[n]=e.getUint8(t);return String.fromCharCode.apply(null,i)},I.UTF16=function(e,t,r){for(var i=[],n=r/2,a=0;a<n;a++,t+=2)i[a]=e.getUint16(t);return String.fromCharCode.apply(null,i)},N.UTF16=function(e){for(var t=[],r=0;r<e.length;r+=1){var i=e.charCodeAt(r);t[t.length]=i>>8&255,t[t.length]=255&i}return t},O.UTF16=function(e){return 2*e.length};var k={"x-mac-croatian":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc\xb0\xa2\xa3\xa7\xb6\xdf\xae\xb4\xa8\xd8\xb1\xb5\xaa\xba\xf8\xbf\xa1\xac\xab \xc0\xc3\xd5\xf7\xa9\xc6\xbb\xb7\xc2\xc1\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9\xaf\xcb\xb8\xca\xe6","x-mac-cyrillic":"\xb0\xa3\xa7\xb6\xae\xa9\xb1\xb5\xac\xab\xbb \xf7","x-mac-gaelic":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc\xb0\xa2\xa3\xa7\xb6\xdf\xae\xa9\xb4\xa8\xc6\xd8\xb1\xe6\xf8\xab\xbb \xc0\xc3\xd5\xff\xb7\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9\xdd\xfd","x-mac-greek":"\xc4\xb9\xb2\xc9\xb3\xd6\xdc\xe0\xe2\xe4\xa8\xe7\xe9\xe8\xea\xeb\xa3\xee\xef\xbd\xf4\xf6\xa6\xf9\xfb\xfc\xdf\xae\xa9\xa7\xb0\xb7\xb1\xa5\xac\xab\xbb \xf7\xad","x-mac-icelandic":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc\xdd\xb0\xa2\xa3\xa7\xb6\xdf\xae\xa9\xb4\xa8\xc6\xd8\xb1\xa5\xb5\xaa\xba\xe6\xf8\xbf\xa1\xac\xab\xbb \xc0\xc3\xd5\xf7\xff\xd0\xf0\xde\xfe\xfd\xb7\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9\xaf\xb8","x-mac-inuit":"\xb0\xb6\xae\xa9 ","x-mac-ce":"\xc4\xc9\xd6\xdc\xe1\xe4\xe9\xed\xf3\xf4\xf6\xf5\xfa\xfc\xb0\xa3\xa7\xb6\xdf\xae\xa9\xa8\xac\xab\xbb \xd5\xf7\xc1\xcd\xd3\xd4\xda\xdd\xfd",macintosh:"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc\xb0\xa2\xa3\xa7\xb6\xdf\xae\xa9\xb4\xa8\xc6\xd8\xb1\xa5\xb5\xaa\xba\xe6\xf8\xbf\xa1\xac\xab\xbb \xc0\xc3\xd5\xf7\xff\xb7\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9\xaf\xb8","x-mac-romanian":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc\xb0\xa2\xa3\xa7\xb6\xdf\xae\xa9\xb4\xa8\xb1\xa5\xb5\xaa\xba\xbf\xa1\xac\xab\xbb \xc0\xc3\xd5\xf7\xff\xb7\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9\xaf\xb8","x-mac-turkish":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc\xb0\xa2\xa3\xa7\xb6\xdf\xae\xa9\xb4\xa8\xc6\xd8\xb1\xa5\xb5\xaa\xba\xe6\xf8\xbf\xa1\xac\xab\xbb \xc0\xc3\xd5\xf7\xff\xb7\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9\xaf\xb8"};I.MACSTRING=function(e,t,r,i){var n=k[i];if(void 0!==n){for(var a="",s=0;s<r;s++){var o=e.getUint8(t+s);o<=127?a+=String.fromCharCode(o):a+=n[127&o]}return a}};var _="function"==typeof WeakMap&&new WeakMap,L=function(e){if(!r)for(var t in r={},k)r[t]=new String(t);var i=r[e];if(void 0!==i){if(_){var n=_.get(i);if(void 0!==n)return n}var a=k[e];if(void 0!==a){for(var s={},o=0;o<a.length;o++)s[a.charCodeAt(o)]=o+128;return _&&_.set(i,s),s}}};function U(e){return e>=-128&&e<=127}N.MACSTRING=function(e,t){var r=L(t);if(void 0!==r){for(var i=[],n=0;n<e.length;n++){var a=e.charCodeAt(n);if(a>=128&&void 0===(a=r[a]))return;i[n]=a}return i}},O.MACSTRING=function(e,t){var r=N.MACSTRING(e,t);return void 0!==r?r.length:0},N.VARDELTAS=function(e){for(var t=0,r=[];t<e.length;){var i=e[t];t=0===i?function(e,t,r){for(var i=0,n=e.length;t<n&&i<64&&0===e[t];)++t,++i;return r.push(128|i-1),t}(e,t,r):i>=-128&&i<=127?function(e,t,r){for(var i=0,n=e.length,a=t;a<n&&i<64;){var s=e[a];if(!U(s)||0===s&&a+1<n&&0===e[a+1])break;++a,++i}r.push(i-1);for(var o=t;o<a;++o)r.push(e[o]+256&255);return a}(e,t,r):function(e,t,r){for(var i=0,n=e.length,a=t;a<n&&i<64;){var s=e[a];if(0===s||U(s)&&a+1<n&&U(e[a+1]))break;++a,++i}r.push(64|i-1);for(var o=t;o<a;++o){var l=e[o];r.push(l+65536>>8&255,l+256&255)}return a}(e,t,r)}return r},N.INDEX=function(e){for(var t=1,r=[1],i=[],n=0;n<e.length;n+=1){var a=N.OBJECT(e[n]);Array.prototype.push.apply(i,a),t+=a.length,r.push(t)}if(0===i.length)return[0,0];for(var s=[],o=1+Math.floor(Math.log(t)/Math.log(2))/8|0,l=[void 0,N.BYTE,N.USHORT,N.UINT24,N.ULONG][o],c=0;c<r.length;c+=1){var u=l(r[c]);Array.prototype.push.apply(s,u)}return Array.prototype.concat(N.Card16(e.length),N.OffSize(o),s,i)},O.INDEX=function(e){return N.INDEX(e).length},N.DICT=function(e){for(var t=[],r=Object.keys(e),i=r.length,n=0;n<i;n+=1){var a=parseInt(r[n],0),s=e[a];t=(t=t.concat(N.OPERAND(s.value,s.type))).concat(N.OPERATOR(a))}return t},O.DICT=function(e){return N.DICT(e).length},N.OPERATOR=function(e){return e<1200?[e]:[12,e-1200]},N.OPERAND=function(e,t){var r=[];if(Array.isArray(t))for(var i=0;i<t.length;i+=1)C.argument(e.length===t.length,"Not enough arguments given for type"+t),r=r.concat(N.OPERAND(e[i],t[i]));else if("SID"===t)r=r.concat(N.NUMBER(e));else if("offset"===t)r=r.concat(N.NUMBER32(e));else if("number"===t)r=r.concat(N.NUMBER(e));else if("real"===t)r=r.concat(N.REAL(e));else throw Error("Unknown operand type "+t);return r},N.OP=N.BYTE,O.OP=O.BYTE;var D="function"==typeof WeakMap&&new WeakMap;function F(e,t,r){if(t.length&&("coverageFormat"!==t[0].name||1===t[0].value))for(var i=0;i<t.length;i+=1){var n=t[i];this[n.name]=n.value}if(this.tableName=e,this.fields=t,r)for(var a=Object.keys(r),s=0;s<a.length;s+=1){var o=a[s],l=r[o];void 0!==this[o]&&(this[o]=l)}}function B(e,t,r){void 0===r&&(r=t.length);var i=Array(t.length+1);i[0]={name:e+"Count",type:"USHORT",value:r};for(var n=0;n<t.length;n++)i[n+1]={name:e+n,type:"USHORT",value:t[n]};return i}function V(e,t,r){var i=t.length,n=Array(i+1);n[0]={name:e+"Count",type:"USHORT",value:i};for(var a=0;a<i;a++)n[a+1]={name:e+a,type:"TABLE",value:r(t[a],a)};return n}function G(e,t,r){var i=t.length,n=[];n[0]={name:e+"Count",type:"USHORT",value:i};for(var a=0;a<i;a++)n=n.concat(r(t[a],a));return n}function z(e){1===e.format?F.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:1}].concat(B("glyph",e.glyphs))):2===e.format?F.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:2}].concat(G("rangeRecord",e.ranges,function(e){return[{name:"startGlyphID",type:"USHORT",value:e.start},{name:"endGlyphID",type:"USHORT",value:e.end},{name:"startCoverageIndex",type:"USHORT",value:e.index}]}))):C.assert(!1,"Coverage format must be 1 or 2.")}function j(e){F.call(this,"scriptListTable",G("scriptRecord",e,function(e,t){var r=e.script,i=r.defaultLangSys;return C.assert(!!i,"Unable to write GSUB: script "+e.tag+" has no default language system."),[{name:"scriptTag"+t,type:"TAG",value:e.tag},{name:"script"+t,type:"TABLE",value:new F("scriptTable",[{name:"defaultLangSys",type:"TABLE",value:new F("defaultLangSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:i.reqFeatureIndex}].concat(B("featureIndex",i.featureIndexes)))}].concat(G("langSys",r.langSysRecords,function(e,t){var r=e.langSys;return[{name:"langSysTag"+t,type:"TAG",value:e.tag},{name:"langSys"+t,type:"TABLE",value:new F("langSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:r.reqFeatureIndex}].concat(B("featureIndex",r.featureIndexes)))}]})))}]}))}function H(e){F.call(this,"featureListTable",G("featureRecord",e,function(e,t){var r=e.feature;return[{name:"featureTag"+t,type:"TAG",value:e.tag},{name:"feature"+t,type:"TABLE",value:new F("featureTable",[{name:"featureParams",type:"USHORT",value:r.featureParams}].concat(B("lookupListIndex",r.lookupListIndexes)))}]}))}function W(e,t){F.call(this,"lookupListTable",V("lookup",e,function(e){var r=t[e.lookupType];return C.assert(!!r,"Unable to write GSUB lookup type "+e.lookupType+" tables."),new F("lookupTable",[{name:"lookupType",type:"USHORT",value:e.lookupType},{name:"lookupFlag",type:"USHORT",value:e.lookupFlag}].concat(V("subtable",e.subtables,r)))}))}N.CHARSTRING=function(e){if(D){var t=D.get(e);if(void 0!==t)return t}for(var r=[],i=e.length,n=0;n<i;n+=1){var a=e[n];r=r.concat(N[a.type](a.value))}return D&&D.set(e,r),r},O.CHARSTRING=function(e){return N.CHARSTRING(e).length},N.OBJECT=function(e){var t=N[e.type];return C.argument(void 0!==t,"No encoding function for type "+e.type),t(e.value)},O.OBJECT=function(e){var t=O[e.type];return C.argument(void 0!==t,"No sizeOf function for type "+e.type),t(e.value)},N.TABLE=function(e){for(var t=[],r=e.fields.length,i=[],n=[],a=0;a<r;a+=1){var s=e.fields[a],o=N[s.type];C.argument(void 0!==o,"No encoding function for field type "+s.type+" ("+s.name+")");var l=e[s.name];void 0===l&&(l=s.value);var c=o(l);"TABLE"===s.type?(n.push(t.length),t=t.concat([0,0]),i.push(c)):t=t.concat(c)}for(var u=0;u<i.length;u+=1){var h=n[u],p=t.length;C.argument(p<65536,"Table "+e.tableName+" too big."),t[h]=p>>8,t[h+1]=255&p,t=t.concat(i[u])}return t},O.TABLE=function(e){for(var t=0,r=e.fields.length,i=0;i<r;i+=1){var n=e.fields[i],a=O[n.type];C.argument(void 0!==a,"No sizeOf function for field type "+n.type+" ("+n.name+")");var s=e[n.name];void 0===s&&(s=n.value),t+=a(s),"TABLE"===n.type&&(t+=2)}return t},N.RECORD=N.TABLE,O.RECORD=O.TABLE,N.LITERAL=function(e){return e},O.LITERAL=function(e){return e.length},F.prototype.encode=function(){return N.TABLE(this)},F.prototype.sizeOf=function(){return O.TABLE(this)},z.prototype=Object.create(F.prototype),z.prototype.constructor=z,j.prototype=Object.create(F.prototype),j.prototype.constructor=j,H.prototype=Object.create(F.prototype),H.prototype.constructor=H,W.prototype=Object.create(F.prototype),W.prototype.constructor=W;var K={Table:F,Record:F,Coverage:z,ScriptList:j,FeatureList:H,LookupList:W,ushortList:B,tableList:V,recordList:G};function X(e,t){return e.getUint8(t)}function Y(e,t){return e.getUint16(t,!1)}function q(e,t){return e.getUint32(t,!1)}function Z(e,t){return e.getInt16(t,!1)+e.getUint16(t+2,!1)/65535}var $={byte:1,uShort:2,short:2,uLong:4,fixed:4,longDateTime:8,tag:4};function Q(e,t){this.data=e,this.offset=t,this.relativeOffset=0}Q.prototype.parseByte=function(){var e=this.data.getUint8(this.offset+this.relativeOffset);return this.relativeOffset+=1,e},Q.prototype.parseChar=function(){var e=this.data.getInt8(this.offset+this.relativeOffset);return this.relativeOffset+=1,e},Q.prototype.parseCard8=Q.prototype.parseByte,Q.prototype.parseUShort=function(){var e=this.data.getUint16(this.offset+this.relativeOffset);return this.relativeOffset+=2,e},Q.prototype.parseCard16=Q.prototype.parseUShort,Q.prototype.parseSID=Q.prototype.parseUShort,Q.prototype.parseOffset16=Q.prototype.parseUShort,Q.prototype.parseShort=function(){var e=this.data.getInt16(this.offset+this.relativeOffset);return this.relativeOffset+=2,e},Q.prototype.parseF2Dot14=function(){var e=this.data.getInt16(this.offset+this.relativeOffset)/16384;return this.relativeOffset+=2,e},Q.prototype.parseULong=function(){var e=q(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,e},Q.prototype.parseOffset32=Q.prototype.parseULong,Q.prototype.parseFixed=function(){var e=Z(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,e},Q.prototype.parseString=function(e){var t=this.data,r=this.offset+this.relativeOffset,i="";this.relativeOffset+=e;for(var n=0;n<e;n++)i+=String.fromCharCode(t.getUint8(r+n));return i},Q.prototype.parseTag=function(){return this.parseString(4)},Q.prototype.parseLongDateTime=function(){var e=q(this.data,this.offset+this.relativeOffset+4);return e-=2082844800,this.relativeOffset+=8,e},Q.prototype.parseVersion=function(e){var t=Y(this.data,this.offset+this.relativeOffset),r=Y(this.data,this.offset+this.relativeOffset+2);return this.relativeOffset+=4,void 0===e&&(e=4096),t+r/e/10},Q.prototype.skip=function(e,t){void 0===t&&(t=1),this.relativeOffset+=$[e]*t},Q.prototype.parseULongList=function(e){void 0===e&&(e=this.parseULong());for(var t=Array(e),r=this.data,i=this.offset+this.relativeOffset,n=0;n<e;n++)t[n]=r.getUint32(i),i+=4;return this.relativeOffset+=4*e,t},Q.prototype.parseOffset16List=Q.prototype.parseUShortList=function(e){void 0===e&&(e=this.parseUShort());for(var t=Array(e),r=this.data,i=this.offset+this.relativeOffset,n=0;n<e;n++)t[n]=r.getUint16(i),i+=2;return this.relativeOffset+=2*e,t},Q.prototype.parseShortList=function(e){for(var t=Array(e),r=this.data,i=this.offset+this.relativeOffset,n=0;n<e;n++)t[n]=r.getInt16(i),i+=2;return this.relativeOffset+=2*e,t},Q.prototype.parseByteList=function(e){for(var t=Array(e),r=this.data,i=this.offset+this.relativeOffset,n=0;n<e;n++)t[n]=r.getUint8(i++);return this.relativeOffset+=e,t},Q.prototype.parseList=function(e,t){t||(t=e,e=this.parseUShort());for(var r=Array(e),i=0;i<e;i++)r[i]=t.call(this);return r},Q.prototype.parseList32=function(e,t){t||(t=e,e=this.parseULong());for(var r=Array(e),i=0;i<e;i++)r[i]=t.call(this);return r},Q.prototype.parseRecordList=function(e,t){t||(t=e,e=this.parseUShort());for(var r=Array(e),i=Object.keys(t),n=0;n<e;n++){for(var a={},s=0;s<i.length;s++){var o=i[s],l=t[o];a[o]=l.call(this)}r[n]=a}return r},Q.prototype.parseRecordList32=function(e,t){t||(t=e,e=this.parseULong());for(var r=Array(e),i=Object.keys(t),n=0;n<e;n++){for(var a={},s=0;s<i.length;s++){var o=i[s],l=t[o];a[o]=l.call(this)}r[n]=a}return r},Q.prototype.parseStruct=function(e){if("function"==typeof e)return e.call(this);for(var t=Object.keys(e),r={},i=0;i<t.length;i++){var n=t[i],a=e[n];r[n]=a.call(this)}return r},Q.prototype.parseValueRecord=function(e){if(void 0===e&&(e=this.parseUShort()),0!==e){var t={};return 1&e&&(t.xPlacement=this.parseShort()),2&e&&(t.yPlacement=this.parseShort()),4&e&&(t.xAdvance=this.parseShort()),8&e&&(t.yAdvance=this.parseShort()),16&e&&(t.xPlaDevice=void 0,this.parseShort()),32&e&&(t.yPlaDevice=void 0,this.parseShort()),64&e&&(t.xAdvDevice=void 0,this.parseShort()),128&e&&(t.yAdvDevice=void 0,this.parseShort()),t}},Q.prototype.parseValueRecordList=function(){for(var e=this.parseUShort(),t=this.parseUShort(),r=Array(t),i=0;i<t;i++)r[i]=this.parseValueRecord(e);return r},Q.prototype.parsePointer=function(e){var t=this.parseOffset16();if(t>0)return new Q(this.data,this.offset+t).parseStruct(e)},Q.prototype.parsePointer32=function(e){var t=this.parseOffset32();if(t>0)return new Q(this.data,this.offset+t).parseStruct(e)},Q.prototype.parseListOfLists=function(e){for(var t=this.parseOffset16List(),r=t.length,i=this.relativeOffset,n=Array(r),a=0;a<r;a++){var s=t[a];if(0===s){n[a]=void 0;continue}if(this.relativeOffset=s,e){for(var o=this.parseOffset16List(),l=Array(o.length),c=0;c<o.length;c++)this.relativeOffset=s+o[c],l[c]=e.call(this);n[a]=l}else n[a]=this.parseUShortList()}return this.relativeOffset=i,n},Q.prototype.parseCoverage=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort(),r=this.parseUShort();if(1===t)return{format:1,glyphs:this.parseUShortList(r)};if(2===t){for(var i=Array(r),n=0;n<r;n++)i[n]={start:this.parseUShort(),end:this.parseUShort(),index:this.parseUShort()};return{format:2,ranges:i}}throw Error("0x"+e.toString(16)+": Coverage format must be 1 or 2.")},Q.prototype.parseClassDef=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();if(1===t)return{format:1,startGlyph:this.parseUShort(),classes:this.parseUShortList()};if(2===t)return{format:2,ranges:this.parseRecordList({start:Q.uShort,end:Q.uShort,classId:Q.uShort})};throw Error("0x"+e.toString(16)+": ClassDef format must be 1 or 2.")},Q.list=function(e,t){return function(){return this.parseList(e,t)}},Q.list32=function(e,t){return function(){return this.parseList32(e,t)}},Q.recordList=function(e,t){return function(){return this.parseRecordList(e,t)}},Q.recordList32=function(e,t){return function(){return this.parseRecordList32(e,t)}},Q.pointer=function(e){return function(){return this.parsePointer(e)}},Q.pointer32=function(e){return function(){return this.parsePointer32(e)}},Q.tag=Q.prototype.parseTag,Q.byte=Q.prototype.parseByte,Q.uShort=Q.offset16=Q.prototype.parseUShort,Q.uShortList=Q.prototype.parseUShortList,Q.uLong=Q.offset32=Q.prototype.parseULong,Q.uLongList=Q.prototype.parseULongList,Q.struct=Q.prototype.parseStruct,Q.coverage=Q.prototype.parseCoverage,Q.classDef=Q.prototype.parseClassDef;var J={reserved:Q.uShort,reqFeatureIndex:Q.uShort,featureIndexes:Q.uShortList};Q.prototype.parseScriptList=function(){return this.parsePointer(Q.recordList({tag:Q.tag,script:Q.pointer({defaultLangSys:Q.pointer(J),langSysRecords:Q.recordList({tag:Q.tag,langSys:Q.pointer(J)})})}))||[]},Q.prototype.parseFeatureList=function(){return this.parsePointer(Q.recordList({tag:Q.tag,feature:Q.pointer({featureParams:Q.offset16,lookupListIndexes:Q.uShortList})}))||[]},Q.prototype.parseLookupList=function(e){return this.parsePointer(Q.list(Q.pointer(function(){var t=this.parseUShort();C.argument(1<=t&&t<=9,"GPOS/GSUB lookup type "+t+" unknown.");var r=this.parseUShort();return{lookupType:t,lookupFlag:r,subtables:this.parseList(Q.pointer(e[t])),markFilteringSet:16&r?this.parseUShort():void 0}})))||[]},Q.prototype.parseFeatureVariationsList=function(){return this.parsePointer32(function(){var e=this.parseUShort(),t=this.parseUShort();return C.argument(1===e&&t<1,"GPOS/GSUB feature variations table unknown."),this.parseRecordList32({conditionSetOffset:Q.offset32,featureTableSubstitutionOffset:Q.offset32})})||[]};var ee={getByte:X,getCard8:X,getUShort:Y,getCard16:Y,getShort:function(e,t){return e.getInt16(t,!1)},getULong:q,getFixed:Z,getTag:function(e,t){for(var r="",i=t;i<t+4;i+=1)r+=String.fromCharCode(e.getInt8(i));return r},getOffset:function(e,t,r){for(var i=0,n=0;n<r;n+=1)i<<=8,i+=e.getUint8(t+n);return i},getBytes:function(e,t,r){for(var i=[],n=t;n<r;n+=1)i.push(e.getUint8(n));return i},bytesToString:function(e){for(var t="",r=0;r<e.length;r+=1)t+=String.fromCharCode(e[r]);return t},Parser:Q},et={parse:function(e,t){var r={};r.version=ee.getUShort(e,t),C.argument(0===r.version,"cmap table version should be 0."),r.numTables=ee.getUShort(e,t+2);for(var i=-1,n=r.numTables-1;n>=0;n-=1){var a=ee.getUShort(e,t+4+8*n),s=ee.getUShort(e,t+4+8*n+2);if(3===a&&(0===s||1===s||10===s)||0===a&&(0===s||1===s||2===s||3===s||4===s)){i=ee.getULong(e,t+4+8*n+4);break}}if(-1===i)throw Error("No valid cmap sub-tables found.");var o=new ee.Parser(e,t+i);if(r.format=o.parseUShort(),12===r.format)!function(e,t){t.parseUShort(),e.length=t.parseULong(),e.language=t.parseULong(),e.groupCount=r=t.parseULong(),e.glyphIndexMap={};for(var r,i=0;i<r;i+=1)for(var n=t.parseULong(),a=t.parseULong(),s=t.parseULong(),o=n;o<=a;o+=1)e.glyphIndexMap[o]=s,s++}(r,o);else if(4===r.format)!function(e,t,r,i,n){e.length=t.parseUShort(),e.language=t.parseUShort(),e.segCount=a=t.parseUShort()>>1,t.skip("uShort",3),e.glyphIndexMap={};for(var a,s=new ee.Parser(r,i+n+14),o=new ee.Parser(r,i+n+16+2*a),l=new ee.Parser(r,i+n+16+4*a),c=new ee.Parser(r,i+n+16+6*a),u=i+n+16+8*a,h=0;h<a-1;h+=1)for(var p=void 0,d=s.parseUShort(),f=o.parseUShort(),m=l.parseShort(),g=c.parseUShort(),v=f;v<=d;v+=1)0!==g?(u=c.offset+c.relativeOffset-2+g+(v-f)*2,0!==(p=ee.getUShort(r,u))&&(p=p+m&65535)):p=v+m&65535,e.glyphIndexMap[v]=p}(r,o,e,t,i);else throw Error("Only format 4 and 12 cmap tables are supported (found format "+r.format+").");return r},make:function(e){var t,r=!0;for(t=e.length-1;t>0;t-=1)if(e.get(t).unicode>65535){console.log("Adding CMAP format 12 (needed!)"),r=!1;break}var i=[{name:"version",type:"USHORT",value:0},{name:"numTables",type:"USHORT",value:r?1:2},{name:"platformID",type:"USHORT",value:3},{name:"encodingID",type:"USHORT",value:1},{name:"offset",type:"ULONG",value:r?12:20}];r||(i=i.concat([{name:"cmap12PlatformID",type:"USHORT",value:3},{name:"cmap12EncodingID",type:"USHORT",value:10},{name:"cmap12Offset",type:"ULONG",value:0}])),i=i.concat([{name:"format",type:"USHORT",value:4},{name:"cmap4Length",type:"USHORT",value:0},{name:"language",type:"USHORT",value:0},{name:"segCountX2",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);var n=new K.Table("cmap",i);for(t=0,n.segments=[];t<e.length;t+=1){for(var a=e.get(t),s=0;s<a.unicodes.length;s+=1)!function(e,t,r){e.segments.push({end:t,start:t,delta:-(t-r),offset:0,glyphIndex:r})}(n,a.unicodes[s],t);n.segments=n.segments.sort(function(e,t){return e.start-t.start})}!function(e){e.segments.push({end:65535,start:65535,delta:1,offset:0})}(n);var o=n.segments.length,l=0,c=[],u=[],h=[],p=[],d=[],f=[];for(t=0;t<o;t+=1){var m=n.segments[t];m.end<=65535&&m.start<=65535?(c=c.concat({name:"end_"+t,type:"USHORT",value:m.end}),u=u.concat({name:"start_"+t,type:"USHORT",value:m.start}),h=h.concat({name:"idDelta_"+t,type:"SHORT",value:m.delta}),p=p.concat({name:"idRangeOffset_"+t,type:"USHORT",value:m.offset}),void 0!==m.glyphId&&(d=d.concat({name:"glyph_"+t,type:"USHORT",value:m.glyphId}))):l+=1,r||void 0===m.glyphIndex||(f=(f=(f=f.concat({name:"cmap12Start_"+t,type:"ULONG",value:m.start})).concat({name:"cmap12End_"+t,type:"ULONG",value:m.end})).concat({name:"cmap12Glyph_"+t,type:"ULONG",value:m.glyphIndex}))}if(n.segCountX2=(o-l)*2,n.searchRange=2*Math.pow(2,Math.floor(Math.log(o-l)/Math.log(2))),n.entrySelector=Math.log(n.searchRange/2)/Math.log(2),n.rangeShift=n.segCountX2-n.searchRange,n.fields=n.fields.concat(c),n.fields.push({name:"reservedPad",type:"USHORT",value:0}),n.fields=n.fields.concat(u),n.fields=n.fields.concat(h),n.fields=n.fields.concat(p),n.fields=n.fields.concat(d),n.cmap4Length=14+2*c.length+2+2*u.length+2*h.length+2*p.length+2*d.length,!r){var g=16+4*f.length;n.cmap12Offset=20+n.cmap4Length,n.fields=n.fields.concat([{name:"cmap12Format",type:"USHORT",value:12},{name:"cmap12Reserved",type:"USHORT",value:0},{name:"cmap12Length",type:"ULONG",value:g},{name:"cmap12Language",type:"ULONG",value:0},{name:"cmap12nGroups",type:"ULONG",value:f.length/3}]),n.fields=n.fields.concat(f)}return n}},er=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","266 ff","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"],ei=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","","endash","dagger","daggerdbl","periodcentered","","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","","questiondown","","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","","ring","cedilla","","hungarumlaut","ogonek","caron","emdash","","","","","","","","","","","","","","","","","AE","","ordfeminine","","","","","Lslash","Oslash","OE","ordmasculine","","","","","","ae","","","","dotlessi","","","lslash","oslash","oe","germandbls"],en=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclamsmall","Hungarumlautsmall","","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","comma","hyphen","period","fraction","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","colon","semicolon","commasuperior","threequartersemdash","periodsuperior","questionsmall","","asuperior","bsuperior","centsuperior","dsuperior","esuperior","","","isuperior","","","lsuperior","msuperior","nsuperior","osuperior","","","rsuperior","ssuperior","tsuperior","","ff","fi","fl","ffi","ffl","parenleftinferior","","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdownsmall","centoldstyle","Lslashsmall","","","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","","Dotaccentsmall","","","Macronsmall","","","figuredash","hypheninferior","","","Ogoneksmall","Ringsmall","Cedillasmall","","","","onequarter","onehalf","threequarters","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","","","zerosuperior","onesuperior","twosuperior","threesuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall"],ea=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"];function es(e){this.font=e}function eo(e){this.cmap=e}function el(e,t){this.encoding=e,this.charset=t}function ec(e){switch(e.version){case 1:this.names=ea.slice();break;case 2:this.names=Array(e.numberOfGlyphs);for(var t=0;t<e.numberOfGlyphs;t++)e.glyphNameIndex[t]<ea.length?this.names[t]=ea[e.glyphNameIndex[t]]:this.names[t]=e.names[e.glyphNameIndex[t]-ea.length];break;case 2.5:this.names=Array(e.numberOfGlyphs);for(var r=0;r<e.numberOfGlyphs;r++)this.names[r]=ea[r+e.glyphNameIndex[r]];break;default:this.names=[]}}es.prototype.charToGlyphIndex=function(e){var t=e.codePointAt(0),r=this.font.glyphs;if(r){for(var i=0;i<r.length;i+=1)for(var n=r.get(i),a=0;a<n.unicodes.length;a+=1)if(n.unicodes[a]===t)return i}return null},eo.prototype.charToGlyphIndex=function(e){return this.cmap.glyphIndexMap[e.codePointAt(0)]||0},el.prototype.charToGlyphIndex=function(e){var t=e.codePointAt(0),r=this.encoding[t];return this.charset.indexOf(r)},ec.prototype.nameToGlyphIndex=function(e){return this.names.indexOf(e)},ec.prototype.glyphIndexToName=function(e){return this.names[e]};var eu={line:function(e,t,r,i,n){e.beginPath(),e.moveTo(t,r),e.lineTo(i,n),e.stroke()}};function eh(e){this.bindConstructorValues(e)}function ep(e,t,r){Object.defineProperty(e,t,{get:function(){return e.path,e[r]},set:function(t){e[r]=t},enumerable:!0,configurable:!0})}function ed(e,t){if(this.font=e,this.glyphs={},Array.isArray(t))for(var r=0;r<t.length;r++){var i=t[r];i.path.unitsPerEm=e.unitsPerEm,this.glyphs[r]=i}this.length=t&&t.length||0}eh.prototype.bindConstructorValues=function(e){var t;this.index=e.index||0,this.name=e.name||null,this.unicode=e.unicode||void 0,this.unicodes=e.unicodes||void 0!==e.unicode?[e.unicode]:[],"xMin"in e&&(this.xMin=e.xMin),"yMin"in e&&(this.yMin=e.yMin),"xMax"in e&&(this.xMax=e.xMax),"yMax"in e&&(this.yMax=e.yMax),"advanceWidth"in e&&(this.advanceWidth=e.advanceWidth),Object.defineProperty(this,"path",(t=e.path||new A,{configurable:!0,get:function(){return"function"==typeof t&&(t=t()),t},set:function(e){t=e}}))},eh.prototype.addUnicode=function(e){0===this.unicodes.length&&(this.unicode=e),this.unicodes.push(e)},eh.prototype.getBoundingBox=function(){return this.path.getBoundingBox()},eh.prototype.getPath=function(e,t,r,i,n){e=void 0!==e?e:0,t=void 0!==t?t:0,r=void 0!==r?r:72,i||(i={});var a,s,o=i.xScale,l=i.yScale;if(i.hinting&&n&&n.hinting&&(s=this.path&&n.hinting.exec(this,r)),s)a=n.hinting.getCommands(s),e=Math.round(e),t=Math.round(t),o=l=1;else{a=this.path.commands;var c=1/(this.path.unitsPerEm||1e3)*r;void 0===o&&(o=c),void 0===l&&(l=c)}for(var u=new A,h=0;h<a.length;h+=1){var p=a[h];"M"===p.type?u.moveTo(e+p.x*o,t+-p.y*l):"L"===p.type?u.lineTo(e+p.x*o,t+-p.y*l):"Q"===p.type?u.quadraticCurveTo(e+p.x1*o,t+-p.y1*l,e+p.x*o,t+-p.y*l):"C"===p.type?u.curveTo(e+p.x1*o,t+-p.y1*l,e+p.x2*o,t+-p.y2*l,e+p.x*o,t+-p.y*l):"Z"===p.type&&u.closePath()}return u},eh.prototype.getContours=function(){if(void 0===this.points)return[];for(var e=[],t=[],r=0;r<this.points.length;r+=1){var i=this.points[r];t.push(i),i.lastPointOfContour&&(e.push(t),t=[])}return C.argument(0===t.length,"There are still points left in the current contour."),e},eh.prototype.getMetrics=function(){for(var e=this.path.commands,t=[],r=[],i=0;i<e.length;i+=1){var n=e[i];"Z"!==n.type&&(t.push(n.x),r.push(n.y)),("Q"===n.type||"C"===n.type)&&(t.push(n.x1),r.push(n.y1)),"C"===n.type&&(t.push(n.x2),r.push(n.y2))}var a={xMin:Math.min.apply(null,t),yMin:Math.min.apply(null,r),xMax:Math.max.apply(null,t),yMax:Math.max.apply(null,r),leftSideBearing:this.leftSideBearing};return isFinite(a.xMin)||(a.xMin=0),isFinite(a.xMax)||(a.xMax=this.advanceWidth),isFinite(a.yMin)||(a.yMin=0),isFinite(a.yMax)||(a.yMax=0),a.rightSideBearing=this.advanceWidth-a.leftSideBearing-(a.xMax-a.xMin),a},eh.prototype.draw=function(e,t,r,i,n){this.getPath(t,r,i,n).draw(e)},eh.prototype.drawPoints=function(e,t,r,i){function n(t,r,i,n){e.beginPath();for(var a=0;a<t.length;a+=1)e.moveTo(r+t[a].x*n,i+t[a].y*n),e.arc(r+t[a].x*n,i+t[a].y*n,2,0,2*Math.PI,!1);e.closePath(),e.fill()}t=void 0!==t?t:0,r=void 0!==r?r:0,i=void 0!==i?i:24;for(var a=1/this.path.unitsPerEm*i,s=[],o=[],l=this.path,c=0;c<l.commands.length;c+=1){var u=l.commands[c];void 0!==u.x&&s.push({x:u.x,y:-u.y}),void 0!==u.x1&&o.push({x:u.x1,y:-u.y1}),void 0!==u.x2&&o.push({x:u.x2,y:-u.y2})}e.fillStyle="blue",n(s,t,r,a),e.fillStyle="red",n(o,t,r,a)},eh.prototype.drawMetrics=function(e,t,r,i){t=void 0!==t?t:0,r=void 0!==r?r:0,i=void 0!==i?i:24,n=1/this.path.unitsPerEm*i,e.lineWidth=1,e.strokeStyle="black",eu.line(e,t,-1e4,t,1e4),eu.line(e,-1e4,r,1e4,r);var n,a=this.xMin||0,s=this.yMin||0,o=this.xMax||0,l=this.yMax||0,c=this.advanceWidth||0;e.strokeStyle="blue",eu.line(e,t+a*n,-1e4,t+a*n,1e4),eu.line(e,t+o*n,-1e4,t+o*n,1e4),eu.line(e,-1e4,r+-s*n,1e4,r+-s*n),eu.line(e,-1e4,r+-l*n,1e4,r+-l*n),e.strokeStyle="green",eu.line(e,t+c*n,-1e4,t+c*n,1e4)},ed.prototype.get=function(e){if(void 0===this.glyphs[e]){this.font._push(e),"function"==typeof this.glyphs[e]&&(this.glyphs[e]=this.glyphs[e]());var t=this.glyphs[e],r=this.font._IndexToUnicodeMap[e];if(r)for(var i=0;i<r.unicodes.length;i++)t.addUnicode(r.unicodes[i]);this.font.cffEncoding?this.font.isCIDFont?t.name="gid"+e:t.name=this.font.cffEncoding.charset[e]:this.font.glyphNames.names&&(t.name=this.font.glyphNames.glyphIndexToName(e)),this.glyphs[e].advanceWidth=this.font._hmtxTableData[e].advanceWidth,this.glyphs[e].leftSideBearing=this.font._hmtxTableData[e].leftSideBearing}else"function"==typeof this.glyphs[e]&&(this.glyphs[e]=this.glyphs[e]());return this.glyphs[e]},ed.prototype.push=function(e,t){this.glyphs[e]=t,this.length++};var ef={GlyphSet:ed,glyphLoader:function(e,t){return new eh({index:t,font:e})},ttfGlyphLoader:function(e,t,r,i,n,a){return function(){var s=new eh({index:t,font:e});return s.path=function(){r(s,i,n);var t=a(e.glyphs,s);return t.unitsPerEm=e.unitsPerEm,t},ep(s,"xMin","_xMin"),ep(s,"xMax","_xMax"),ep(s,"yMin","_yMin"),ep(s,"yMax","_yMax"),s}},cffGlyphLoader:function(e,t,r,i){return function(){var n=new eh({index:t,font:e});return n.path=function(){var t=r(e,n,i);return t.unitsPerEm=e.unitsPerEm,t},n}}};function em(e){return e.length<1240?107:e.length<33900?1131:32768}function eg(e,t,r){var i,n,a=[],s=[],o=ee.getCard16(e,t);if(0!==o){var l=ee.getByte(e,t+2);i=t+(o+1)*l+2;for(var c=t+3,u=0;u<o+1;u+=1)a.push(ee.getOffset(e,c,l)),c+=l;n=i+a[o]}else n=t+2;for(var h=0;h<a.length-1;h+=1){var p=ee.getBytes(e,i+a[h],i+a[h+1]);r&&(p=r(p)),s.push(p)}return{objects:s,startOffset:t,endOffset:n}}function ev(e,t,r){t=void 0!==t?t:0;var i=new ee.Parser(e,t),n=[],a=[];for(r=void 0!==r?r:e.length;i.relativeOffset<r;){var s=i.parseByte();s<=21?(12===s&&(s=1200+i.parseByte()),n.push([s,a]),a=[]):a.push(function(e,t){var r,i;if(28===t)return(r=e.parseByte())<<8|(i=e.parseByte());if(29===t)return r=e.parseByte(),r<<24|(i=e.parseByte())<<16|e.parseByte()<<8|e.parseByte();if(30===t)return function(e){for(var t="",r=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"];;){var i=e.parseByte(),n=i>>4,a=15&i;if(15===n||(t+=r[n],15===a))break;t+=r[a]}return parseFloat(t)}(e);if(t>=32&&t<=246)return t-139;if(t>=247&&t<=250)return(t-247)*256+(r=e.parseByte())+108;if(t>=251&&t<=254)return-(256*(t-251))-(r=e.parseByte())-108;throw Error("Invalid b0 "+t)}(i,s))}return function(e){for(var t={},r=0;r<e.length;r+=1){var i=e[r][0],n=e[r][1],a=void 0;if(a=1===n.length?n[0]:n,t.hasOwnProperty(i)&&!isNaN(t[i]))throw Error("Object "+t+" already has key "+i);t[i]=a}return t}(n)}function ey(e,t){return t=t<=390?er[t]:e[t-391]}function ex(e,t,r){for(var i,n={},a=0;a<t.length;a+=1){var s=t[a];if(Array.isArray(s.type)){var o=[];o.length=s.type.length;for(var l=0;l<s.type.length;l++)void 0===(i=void 0!==e[s.op]?e[s.op][l]:void 0)&&(i=void 0!==s.value&&void 0!==s.value[l]?s.value[l]:null),"SID"===s.type[l]&&(i=ey(r,i)),o[l]=i;n[s.name]=o}else void 0===(i=e[s.op])&&(i=void 0!==s.value?s.value:null),"SID"===s.type&&(i=ey(r,i)),n[s.name]=i}return n}var eT=[{name:"version",op:0,type:"SID"},{name:"notice",op:1,type:"SID"},{name:"copyright",op:1200,type:"SID"},{name:"fullName",op:2,type:"SID"},{name:"familyName",op:3,type:"SID"},{name:"weight",op:4,type:"SID"},{name:"isFixedPitch",op:1201,type:"number",value:0},{name:"italicAngle",op:1202,type:"number",value:0},{name:"underlinePosition",op:1203,type:"number",value:-100},{name:"underlineThickness",op:1204,type:"number",value:50},{name:"paintType",op:1205,type:"number",value:0},{name:"charstringType",op:1206,type:"number",value:2},{name:"fontMatrix",op:1207,type:["real","real","real","real","real","real"],value:[.001,0,0,.001,0,0]},{name:"uniqueId",op:13,type:"number"},{name:"fontBBox",op:5,type:["number","number","number","number"],value:[0,0,0,0]},{name:"strokeWidth",op:1208,type:"number",value:0},{name:"xuid",op:14,type:[],value:null},{name:"charset",op:15,type:"offset",value:0},{name:"encoding",op:16,type:"offset",value:0},{name:"charStrings",op:17,type:"offset",value:0},{name:"private",op:18,type:["number","offset"],value:[0,0]},{name:"ros",op:1230,type:["SID","SID","number"]},{name:"cidFontVersion",op:1231,type:"number",value:0},{name:"cidFontRevision",op:1232,type:"number",value:0},{name:"cidFontType",op:1233,type:"number",value:0},{name:"cidCount",op:1234,type:"number",value:8720},{name:"uidBase",op:1235,type:"number"},{name:"fdArray",op:1236,type:"offset"},{name:"fdSelect",op:1237,type:"offset"},{name:"fontName",op:1238,type:"SID"}],eb=[{name:"subrs",op:19,type:"offset",value:0},{name:"defaultWidthX",op:20,type:"number",value:0},{name:"nominalWidthX",op:21,type:"number",value:0}];function eS(e,t,r,i){for(var n=[],a=0;a<r.length;a+=1){var s=ex(ev(c=new DataView(new Uint8Array(r[a]).buffer),0,c.byteLength),eT,i);s._subrs=[],s._subrsBias=0,s._defaultWidthX=0,s._nominalWidthX=0;var o=s.private[0],l=s.private[1];if(0!==o&&0!==l){var c,u=ex(ev(e,l+t,o),eb,i);if(s._defaultWidthX=u.defaultWidthX,s._nominalWidthX=u.nominalWidthX,0!==u.subrs){var h=eg(e,l+u.subrs+t);s._subrs=h.objects,s._subrsBias=em(s._subrs)}s._privateDict=u}n.push(s)}return n}function eE(e,t,r){var i,n,a,s,o,l,c,u,h=new A,p=[],d=0,f=!1,m=!1,g=0,v=0;if(e.isCIDFont){var y=e.tables.cff.topDict._fdSelect[t.index],x=e.tables.cff.topDict._fdArray[y];o=x._subrs,l=x._subrsBias,c=x._defaultWidthX,u=x._nominalWidthX}else o=e.tables.cff.topDict._subrs,l=e.tables.cff.topDict._subrsBias,c=e.tables.cff.topDict._defaultWidthX,u=e.tables.cff.topDict._nominalWidthX;var T=c;function b(e,t){m&&h.closePath(),h.moveTo(e,t),m=!0}function S(){p.length%2==0||f||(T=p.shift()+u),d+=p.length>>1,p.length=0,f=!0}return!function r(c){for(var y,x,E,R,A,w,M,C,I,N,O,P,k=0;k<c.length;){var _=c[k];switch(k+=1,_){case 1:case 3:case 18:case 23:S();break;case 4:p.length>1&&!f&&(T=p.shift()+u,f=!0),v+=p.pop(),b(g,v);break;case 5:for(;p.length>0;)g+=p.shift(),v+=p.shift(),h.lineTo(g,v);break;case 6:for(;p.length>0&&(g+=p.shift(),h.lineTo(g,v),0!==p.length);)v+=p.shift(),h.lineTo(g,v);break;case 7:for(;p.length>0&&(v+=p.shift(),h.lineTo(g,v),0!==p.length);)g+=p.shift(),h.lineTo(g,v);break;case 8:for(;p.length>0;)i=g+p.shift(),n=v+p.shift(),a=i+p.shift(),s=n+p.shift(),g=a+p.shift(),v=s+p.shift(),h.curveTo(i,n,a,s,g,v);break;case 10:(w=o[A=p.pop()+l])&&r(w);break;case 11:return;case 12:switch(_=c[k],k+=1,_){case 35:i=g+p.shift(),n=v+p.shift(),a=i+p.shift(),s=n+p.shift(),M=a+p.shift(),C=s+p.shift(),I=M+p.shift(),N=C+p.shift(),O=I+p.shift(),P=N+p.shift(),g=O+p.shift(),v=P+p.shift(),p.shift(),h.curveTo(i,n,a,s,M,C),h.curveTo(I,N,O,P,g,v);break;case 34:i=g+p.shift(),n=v,a=i+p.shift(),s=n+p.shift(),M=a+p.shift(),C=s,I=M+p.shift(),N=s,O=I+p.shift(),P=v,g=O+p.shift(),h.curveTo(i,n,a,s,M,C),h.curveTo(I,N,O,P,g,v);break;case 36:i=g+p.shift(),n=v+p.shift(),a=i+p.shift(),s=n+p.shift(),M=a+p.shift(),C=s,I=M+p.shift(),N=s,O=I+p.shift(),P=N+p.shift(),g=O+p.shift(),h.curveTo(i,n,a,s,M,C),h.curveTo(I,N,O,P,g,v);break;case 37:i=g+p.shift(),n=v+p.shift(),a=i+p.shift(),s=n+p.shift(),M=a+p.shift(),C=s+p.shift(),I=M+p.shift(),N=C+p.shift(),O=I+p.shift(),P=N+p.shift(),Math.abs(O-g)>Math.abs(P-v)?g=O+p.shift():v=P+p.shift(),h.curveTo(i,n,a,s,M,C),h.curveTo(I,N,O,P,g,v);break;default:console.log("Glyph "+t.index+": unknown operator 1200"+_),p.length=0}break;case 14:p.length>0&&!f&&(T=p.shift()+u,f=!0),m&&(h.closePath(),m=!1);break;case 19:case 20:S(),k+=d+7>>3;break;case 21:p.length>2&&!f&&(T=p.shift()+u,f=!0),v+=p.pop(),b(g+=p.pop(),v);break;case 22:p.length>1&&!f&&(T=p.shift()+u,f=!0),b(g+=p.pop(),v);break;case 24:for(;p.length>2;)i=g+p.shift(),n=v+p.shift(),a=i+p.shift(),s=n+p.shift(),g=a+p.shift(),v=s+p.shift(),h.curveTo(i,n,a,s,g,v);g+=p.shift(),v+=p.shift(),h.lineTo(g,v);break;case 25:for(;p.length>6;)g+=p.shift(),v+=p.shift(),h.lineTo(g,v);i=g+p.shift(),n=v+p.shift(),a=i+p.shift(),s=n+p.shift(),g=a+p.shift(),v=s+p.shift(),h.curveTo(i,n,a,s,g,v);break;case 26:for(p.length%2&&(g+=p.shift());p.length>0;)i=g,n=v+p.shift(),a=i+p.shift(),s=n+p.shift(),g=a,v=s+p.shift(),h.curveTo(i,n,a,s,g,v);break;case 27:for(p.length%2&&(v+=p.shift());p.length>0;)i=g+p.shift(),n=v,a=i+p.shift(),s=n+p.shift(),g=a+p.shift(),v=s,h.curveTo(i,n,a,s,g,v);break;case 28:y=c[k],x=c[k+1],p.push((y<<24|x<<16)>>16),k+=2;break;case 29:A=p.pop()+e.gsubrsBias,(w=e.gsubrs[A])&&r(w);break;case 30:for(;p.length>0&&(i=g,n=v+p.shift(),a=i+p.shift(),s=n+p.shift(),g=a+p.shift(),v=s+(1===p.length?p.shift():0),h.curveTo(i,n,a,s,g,v),0!==p.length);)i=g+p.shift(),n=v,a=i+p.shift(),v=(s=n+p.shift())+p.shift(),g=a+(1===p.length?p.shift():0),h.curveTo(i,n,a,s,g,v);break;case 31:for(;p.length>0&&(i=g+p.shift(),n=v,a=i+p.shift(),v=(s=n+p.shift())+p.shift(),g=a+(1===p.length?p.shift():0),h.curveTo(i,n,a,s,g,v),0!==p.length);)i=g,n=v+p.shift(),a=i+p.shift(),s=n+p.shift(),g=a+p.shift(),v=s+(1===p.length?p.shift():0),h.curveTo(i,n,a,s,g,v);break;default:_<32?console.log("Glyph "+t.index+": unknown operator "+_):_<247?p.push(_-139):_<251?(y=c[k],k+=1,p.push((_-247)*256+y+108)):_<255?(y=c[k],k+=1,p.push(-(256*(_-251))-y-108)):(y=c[k],x=c[k+1],E=c[k+2],R=c[k+3],k+=4,p.push((y<<24|x<<16|E<<8|R)/65536))}}}(r),t.advanceWidth=T,h}function eR(e,t){var r,i=er.indexOf(e);return i>=0&&(r=i),(i=t.indexOf(e))>=0?r=i+er.length:(r=er.length+t.length,t.push(e)),r}function eA(e,t,r){for(var i={},n=0;n<e.length;n+=1){var a=e[n],s=t[a.name];void 0!==s&&!function e(t,r){if(t===r)return!0;if(!(Array.isArray(t)&&Array.isArray(r))||t.length!==r.length)return!1;for(var i=0;i<t.length;i+=1)if(!e(t[i],r[i]))return!1;return!0}(s,a.value)&&("SID"===a.type&&(s=eR(s,r)),i[a.op]={name:a.name,type:a.type,value:s})}return i}function ew(e,t){var r=new K.Record("Top DICT",[{name:"dict",type:"DICT",value:{}}]);return r.dict=eA(eT,e,t),r}function eM(e){var t=new K.Record("Top DICT INDEX",[{name:"topDicts",type:"INDEX",value:[]}]);return t.topDicts=[{name:"topDict_0",type:"TABLE",value:e}],t}var eC={parse:function(e,t,r,i){r.tables.cff={};var n,a,s,o,l=((s={}).formatMajor=ee.getCard8(e,t),s.formatMinor=ee.getCard8(e,t+1),s.size=ee.getCard8(e,t+2),s.offsetSize=ee.getCard8(e,t+3),s.startOffset=t,s.endOffset=t+4,s),c=eg(e,l.endOffset,ee.bytesToString),u=eg(e,c.endOffset),h=eg(e,u.endOffset,ee.bytesToString),p=eg(e,h.endOffset);r.gsubrs=p.objects,r.gsubrsBias=em(r.gsubrs);var d=eS(e,t,u.objects,h.objects);if(1!==d.length)throw Error("CFF table has too many fonts in 'FontSet' - count of fonts NameIndex.length = "+d.length);var f=d[0];if(r.tables.cff.topDict=f,f._privateDict&&(r.defaultWidthX=f._privateDict.defaultWidthX,r.nominalWidthX=f._privateDict.nominalWidthX),void 0!==f.ros[0]&&void 0!==f.ros[1]&&(r.isCIDFont=!0),r.isCIDFont){var m=f.fdArray,g=f.fdSelect;if(0===m||0===g)throw Error("Font is marked as a CID font, but FDArray and/or FDSelect information is missing");var v=eg(e,m+=t),y=eS(e,t,v.objects,h.objects);f._fdArray=y,g+=t,f._fdSelect=function(e,t,r,i){var n=[],a=new ee.Parser(e,t),s=a.parseCard8();if(0===s)for(var o=0;o<r;o++){if((l=a.parseCard8())>=i)throw Error("CFF table CID Font FDSelect has bad FD index value "+l+" (FD count "+i+")");n.push(l)}else if(3===s){var l,c,u=a.parseCard16(),h=a.parseCard16();if(0!==h)throw Error("CFF Table CID Font FDSelect format 3 range has bad initial GID "+h);for(var p=0;p<u;p++){if(l=a.parseCard8(),c=a.parseCard16(),l>=i)throw Error("CFF table CID Font FDSelect has bad FD index value "+l+" (FD count "+i+")");if(c>r)throw Error("CFF Table CID Font FDSelect format 3 range has bad GID "+c);for(;h<c;h++)n.push(l);h=c}if(c!==r)throw Error("CFF Table CID Font FDSelect format 3 range has bad final GID "+c)}else throw Error("CFF Table CID Font FDSelect table has unsupported format "+s);return n}(e,g,r.numGlyphs,y.length)}var x=t+f.private[1],T=(n=f.private[0],a=h.objects,ex(ev(e,x,n),eb,a));if(r.defaultWidthX=T.defaultWidthX,r.nominalWidthX=T.nominalWidthX,0!==T.subrs){var b=eg(e,x+T.subrs);r.subrs=b.objects,r.subrsBias=em(r.subrs)}else r.subrs=[],r.subrsBias=0;i.lowMemory?(o=function(e,t){var r,i,n=[],a=ee.getCard16(e,t);if(0!==a){var s=ee.getByte(e,t+2);r=t+(a+1)*s+2;for(var o=t+3,l=0;l<a+1;l+=1)n.push(ee.getOffset(e,o,s)),o+=s;i=r+n[a]}else i=t+2;return{offsets:n,startOffset:t,endOffset:i}}(e,t+f.charStrings),r.nGlyphs=o.offsets.length):(o=eg(e,t+f.charStrings),r.nGlyphs=o.objects.length);var S=function(e,t,r,i){var n,a,s=new ee.Parser(e,t);r-=1;var o=[".notdef"],l=s.parseCard8();if(0===l)for(var c=0;c<r;c+=1)n=s.parseSID(),o.push(ey(i,n));else if(1===l)for(;o.length<=r;){n=s.parseSID(),a=s.parseCard8();for(var u=0;u<=a;u+=1)o.push(ey(i,n)),n+=1}else if(2===l)for(;o.length<=r;){n=s.parseSID(),a=s.parseCard16();for(var h=0;h<=a;h+=1)o.push(ey(i,n)),n+=1}else throw Error("Unknown charset format "+l);return o}(e,t+f.charset,r.nGlyphs,h.objects);if(0===f.encoding?r.cffEncoding=new el(ei,S):1===f.encoding?r.cffEncoding=new el(en,S):r.cffEncoding=function(e,t,r){var i,n={},a=new ee.Parser(e,t),s=a.parseCard8();if(0===s)for(var o=a.parseCard8(),l=0;l<o;l+=1)n[i=a.parseCard8()]=l;else if(1===s){var c=a.parseCard8();i=1;for(var u=0;u<c;u+=1)for(var h=a.parseCard8(),p=a.parseCard8(),d=h;d<=h+p;d+=1)n[d]=i,i+=1}else throw Error("Unknown encoding format "+s);return new el(n,r)}(e,t+f.encoding,S),r.encoding=r.encoding||r.cffEncoding,r.glyphs=new ef.GlyphSet(r),i.lowMemory)r._push=function(i){var n=function(e,t,r,i,n){var a=ee.getCard16(r,i),s=0;if(0!==a){var o=ee.getByte(r,i+2);s=i+(a+1)*o+2}var l=ee.getBytes(r,s+t[e],s+t[e+1]);return n&&(l=n(l)),l}(i,o.offsets,e,t+f.charStrings);r.glyphs.push(i,ef.cffGlyphLoader(r,i,eE,n))};else for(var E=0;E<r.nGlyphs;E+=1){var R=o.objects[E];r.glyphs.push(E,ef.cffGlyphLoader(r,E,eE,R))}},make:function(e,t){for(var r,i,n=new K.Table("CFF ",[{name:"header",type:"RECORD"},{name:"nameIndex",type:"RECORD"},{name:"topDictIndex",type:"RECORD"},{name:"stringIndex",type:"RECORD"},{name:"globalSubrIndex",type:"RECORD"},{name:"charsets",type:"RECORD"},{name:"charStringsIndex",type:"RECORD"},{name:"privateDict",type:"RECORD"}]),a=1/t.unitsPerEm,s={version:t.version,fullName:t.fullName,familyName:t.familyName,weight:t.weightName,fontBBox:t.fontBBox||[0,0,0,0],fontMatrix:[a,0,0,a,0,0],charset:999,encoding:0,charStrings:999,private:[0,999]},o=[],l=1;l<e.length;l+=1)i=e.get(l),o.push(i.name);var c=[];n.header=new K.Record("Header",[{name:"major",type:"Card8",value:1},{name:"minor",type:"Card8",value:0},{name:"hdrSize",type:"Card8",value:4},{name:"major",type:"Card8",value:1}]),n.nameIndex=function(e){var t=new K.Record("Name INDEX",[{name:"names",type:"INDEX",value:[]}]);t.names=[];for(var r=0;r<e.length;r+=1)t.names.push({name:"name_"+r,type:"NAME",value:e[r]});return t}([t.postScriptName]);var u=ew(s,c);n.topDictIndex=eM(u),n.globalSubrIndex=new K.Record("Global Subr INDEX",[{name:"subrs",type:"INDEX",value:[]}]),n.charsets=function(e,t){for(var r=new K.Record("Charsets",[{name:"format",type:"Card8",value:0}]),i=0;i<e.length;i+=1){var n=eR(e[i],t);r.fields.push({name:"glyph_"+i,type:"SID",value:n})}return r}(o,c),n.charStringsIndex=function(e){for(var t=new K.Record("CharStrings INDEX",[{name:"charStrings",type:"INDEX",value:[]}]),r=0;r<e.length;r+=1){var i=e.get(r),n=function(e){var t=[],r=e.path;t.push({name:"width",type:"NUMBER",value:e.advanceWidth});for(var i=0,n=0,a=0;a<r.commands.length;a+=1){var s=void 0,o=void 0,l=r.commands[a];if("Q"===l.type){var c=1/3,u=2/3;l={type:"C",x:l.x,y:l.y,x1:Math.round(c*i+u*l.x1),y1:Math.round(c*n+u*l.y1),x2:Math.round(c*l.x+u*l.x1),y2:Math.round(c*l.y+u*l.y1)}}if("M"===l.type)s=Math.round(l.x-i),o=Math.round(l.y-n),t.push({name:"dx",type:"NUMBER",value:s}),t.push({name:"dy",type:"NUMBER",value:o}),t.push({name:"rmoveto",type:"OP",value:21}),i=Math.round(l.x),n=Math.round(l.y);else if("L"===l.type)s=Math.round(l.x-i),o=Math.round(l.y-n),t.push({name:"dx",type:"NUMBER",value:s}),t.push({name:"dy",type:"NUMBER",value:o}),t.push({name:"rlineto",type:"OP",value:5}),i=Math.round(l.x),n=Math.round(l.y);else if("C"===l.type){var h=Math.round(l.x1-i),p=Math.round(l.y1-n),d=Math.round(l.x2-l.x1),f=Math.round(l.y2-l.y1);s=Math.round(l.x-l.x2),o=Math.round(l.y-l.y2),t.push({name:"dx1",type:"NUMBER",value:h}),t.push({name:"dy1",type:"NUMBER",value:p}),t.push({name:"dx2",type:"NUMBER",value:d}),t.push({name:"dy2",type:"NUMBER",value:f}),t.push({name:"dx",type:"NUMBER",value:s}),t.push({name:"dy",type:"NUMBER",value:o}),t.push({name:"rrcurveto",type:"OP",value:8}),i=Math.round(l.x),n=Math.round(l.y)}}return t.push({name:"endchar",type:"OP",value:14}),t}(i);t.charStrings.push({name:i.name,type:"CHARSTRING",value:n})}return t}(e),n.privateDict=((r=new K.Record("Private DICT",[{name:"dict",type:"DICT",value:{}}])).dict=eA(eb,{},c),r),n.stringIndex=function(e){var t=new K.Record("String INDEX",[{name:"strings",type:"INDEX",value:[]}]);t.strings=[];for(var r=0;r<e.length;r+=1)t.strings.push({name:"string_"+r,type:"STRING",value:e[r]});return t}(c);var h=n.header.sizeOf()+n.nameIndex.sizeOf()+n.topDictIndex.sizeOf()+n.stringIndex.sizeOf()+n.globalSubrIndex.sizeOf();return s.charset=h,s.encoding=0,s.charStrings=s.charset+n.charsets.sizeOf(),s.private[1]=s.charStrings+n.charStringsIndex.sizeOf(),u=ew(s,c),n.topDictIndex=eM(u),n}},eI={parse:function(e,t){var r={},i=new ee.Parser(e,t);return r.version=i.parseVersion(),r.fontRevision=Math.round(1e3*i.parseFixed())/1e3,r.checkSumAdjustment=i.parseULong(),r.magicNumber=i.parseULong(),C.argument(1594834165===r.magicNumber,"Font header has wrong magic number."),r.flags=i.parseUShort(),r.unitsPerEm=i.parseUShort(),r.created=i.parseLongDateTime(),r.modified=i.parseLongDateTime(),r.xMin=i.parseShort(),r.yMin=i.parseShort(),r.xMax=i.parseShort(),r.yMax=i.parseShort(),r.macStyle=i.parseUShort(),r.lowestRecPPEM=i.parseUShort(),r.fontDirectionHint=i.parseShort(),r.indexToLocFormat=i.parseShort(),r.glyphDataFormat=i.parseShort(),r},make:function(e){var t=Math.round(new Date().getTime()/1e3)+2082844800,r=t;return e.createdTimestamp&&(r=e.createdTimestamp+2082844800),new K.Table("head",[{name:"version",type:"FIXED",value:65536},{name:"fontRevision",type:"FIXED",value:65536},{name:"checkSumAdjustment",type:"ULONG",value:0},{name:"magicNumber",type:"ULONG",value:1594834165},{name:"flags",type:"USHORT",value:0},{name:"unitsPerEm",type:"USHORT",value:1e3},{name:"created",type:"LONGDATETIME",value:r},{name:"modified",type:"LONGDATETIME",value:t},{name:"xMin",type:"SHORT",value:0},{name:"yMin",type:"SHORT",value:0},{name:"xMax",type:"SHORT",value:0},{name:"yMax",type:"SHORT",value:0},{name:"macStyle",type:"USHORT",value:0},{name:"lowestRecPPEM",type:"USHORT",value:0},{name:"fontDirectionHint",type:"SHORT",value:2},{name:"indexToLocFormat",type:"SHORT",value:0},{name:"glyphDataFormat",type:"SHORT",value:0}],e)}},eN={parse:function(e,t){var r={},i=new ee.Parser(e,t);return r.version=i.parseVersion(),r.ascender=i.parseShort(),r.descender=i.parseShort(),r.lineGap=i.parseShort(),r.advanceWidthMax=i.parseUShort(),r.minLeftSideBearing=i.parseShort(),r.minRightSideBearing=i.parseShort(),r.xMaxExtent=i.parseShort(),r.caretSlopeRise=i.parseShort(),r.caretSlopeRun=i.parseShort(),r.caretOffset=i.parseShort(),i.relativeOffset+=8,r.metricDataFormat=i.parseShort(),r.numberOfHMetrics=i.parseUShort(),r},make:function(e){return new K.Table("hhea",[{name:"version",type:"FIXED",value:65536},{name:"ascender",type:"FWORD",value:0},{name:"descender",type:"FWORD",value:0},{name:"lineGap",type:"FWORD",value:0},{name:"advanceWidthMax",type:"UFWORD",value:0},{name:"minLeftSideBearing",type:"FWORD",value:0},{name:"minRightSideBearing",type:"FWORD",value:0},{name:"xMaxExtent",type:"FWORD",value:0},{name:"caretSlopeRise",type:"SHORT",value:1},{name:"caretSlopeRun",type:"SHORT",value:0},{name:"caretOffset",type:"SHORT",value:0},{name:"reserved1",type:"SHORT",value:0},{name:"reserved2",type:"SHORT",value:0},{name:"reserved3",type:"SHORT",value:0},{name:"reserved4",type:"SHORT",value:0},{name:"metricDataFormat",type:"SHORT",value:0},{name:"numberOfHMetrics",type:"USHORT",value:0}],e)}},eO={make:function(e){for(var t=new K.Table("ltag",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"numTags",type:"ULONG",value:e.length}]),r="",i=12+4*e.length,n=0;n<e.length;++n){var a=r.indexOf(e[n]);a<0&&(a=r.length,r+=e[n]),t.fields.push({name:"offset "+n,type:"USHORT",value:i+a}),t.fields.push({name:"length "+n,type:"USHORT",value:e[n].length})}return t.fields.push({name:"stringPool",type:"CHARARRAY",value:r}),t},parse:function(e,t){var r=new ee.Parser(e,t),i=r.parseULong();C.argument(1===i,"Unsupported ltag table version."),r.skip("uLong",1);for(var n=r.parseULong(),a=[],s=0;s<n;s++){for(var o="",l=t+r.parseUShort(),c=r.parseUShort(),u=l;u<l+c;++u)o+=String.fromCharCode(e.getInt8(u));a.push(o)}return a}},eP={parse:function(e,t){var r={},i=new ee.Parser(e,t);return r.version=i.parseVersion(),r.numGlyphs=i.parseUShort(),1===r.version&&(r.maxPoints=i.parseUShort(),r.maxContours=i.parseUShort(),r.maxCompositePoints=i.parseUShort(),r.maxCompositeContours=i.parseUShort(),r.maxZones=i.parseUShort(),r.maxTwilightPoints=i.parseUShort(),r.maxStorage=i.parseUShort(),r.maxFunctionDefs=i.parseUShort(),r.maxInstructionDefs=i.parseUShort(),r.maxStackElements=i.parseUShort(),r.maxSizeOfInstructions=i.parseUShort(),r.maxComponentElements=i.parseUShort(),r.maxComponentDepth=i.parseUShort()),r},make:function(e){return new K.Table("maxp",[{name:"version",type:"FIXED",value:20480},{name:"numGlyphs",type:"USHORT",value:e}])}},ek=["copyright","fontFamily","fontSubfamily","uniqueID","fullName","version","postScriptName","trademark","manufacturer","designer","description","manufacturerURL","designerURL","license","licenseURL","reserved","preferredFamily","preferredSubfamily","compatibleFullName","sampleText","postScriptFindFontName","wwsFamily","wwsSubfamily"],e_={0:"en",1:"fr",2:"de",3:"it",4:"nl",5:"sv",6:"es",7:"da",8:"pt",9:"no",10:"he",11:"ja",12:"ar",13:"fi",14:"el",15:"is",16:"mt",17:"tr",18:"hr",19:"zh-Hant",20:"ur",21:"hi",22:"th",23:"ko",24:"lt",25:"pl",26:"hu",27:"es",28:"lv",29:"se",30:"fo",31:"fa",32:"ru",33:"zh",34:"nl-BE",35:"ga",36:"sq",37:"ro",38:"cz",39:"sk",40:"si",41:"yi",42:"sr",43:"mk",44:"bg",45:"uk",46:"be",47:"uz",48:"kk",49:"az-Cyrl",50:"az-Arab",51:"hy",52:"ka",53:"mo",54:"ky",55:"tg",56:"tk",57:"mn-CN",58:"mn",59:"ps",60:"ks",61:"ku",62:"sd",63:"bo",64:"ne",65:"sa",66:"mr",67:"bn",68:"as",69:"gu",70:"pa",71:"or",72:"ml",73:"kn",74:"ta",75:"te",76:"si",77:"my",78:"km",79:"lo",80:"vi",81:"id",82:"tl",83:"ms",84:"ms-Arab",85:"am",86:"ti",87:"om",88:"so",89:"sw",90:"rw",91:"rn",92:"ny",93:"mg",94:"eo",128:"cy",129:"eu",130:"ca",131:"la",132:"qu",133:"gn",134:"ay",135:"tt",136:"ug",137:"dz",138:"jv",139:"su",140:"gl",141:"af",142:"br",143:"iu",144:"gd",145:"gv",146:"ga",147:"to",148:"el-polyton",149:"kl",150:"az",151:"nn"},eL={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:5,11:1,12:4,13:0,14:6,15:0,16:0,17:0,18:0,19:2,20:4,21:9,22:21,23:3,24:29,25:29,26:29,27:29,28:29,29:0,30:0,31:4,32:7,33:25,34:0,35:0,36:0,37:0,38:29,39:29,40:0,41:5,42:7,43:7,44:7,45:7,46:7,47:7,48:7,49:7,50:4,51:24,52:23,53:7,54:7,55:7,56:7,57:27,58:7,59:4,60:4,61:4,62:4,63:26,64:9,65:9,66:9,67:13,68:13,69:11,70:10,71:12,72:17,73:16,74:14,75:15,76:18,77:19,78:20,79:22,80:30,81:0,82:0,83:0,84:4,85:28,86:28,87:28,88:0,89:0,90:0,91:0,92:0,93:0,94:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:7,136:4,137:26,138:0,139:0,140:0,141:0,142:0,143:28,144:0,145:0,146:0,147:0,148:6,149:0,150:0,151:0},eU={1078:"af",1052:"sq",1156:"gsw",1118:"am",5121:"ar-DZ",15361:"ar-BH",3073:"ar",2049:"ar-IQ",11265:"ar-JO",13313:"ar-KW",12289:"ar-LB",4097:"ar-LY",6145:"ary",8193:"ar-OM",16385:"ar-QA",1025:"ar-SA",10241:"ar-SY",7169:"aeb",14337:"ar-AE",9217:"ar-YE",1067:"hy",1101:"as",2092:"az-Cyrl",1068:"az",1133:"ba",1069:"eu",1059:"be",2117:"bn",1093:"bn-IN",8218:"bs-Cyrl",5146:"bs",1150:"br",1026:"bg",1027:"ca",3076:"zh-HK",5124:"zh-MO",2052:"zh",4100:"zh-SG",1028:"zh-TW",1155:"co",1050:"hr",4122:"hr-BA",1029:"cs",1030:"da",1164:"prs",1125:"dv",2067:"nl-BE",1043:"nl",3081:"en-AU",10249:"en-BZ",4105:"en-CA",9225:"en-029",16393:"en-IN",6153:"en-IE",8201:"en-JM",17417:"en-MY",5129:"en-NZ",13321:"en-PH",18441:"en-SG",7177:"en-ZA",11273:"en-TT",2057:"en-GB",1033:"en",12297:"en-ZW",1061:"et",1080:"fo",1124:"fil",1035:"fi",2060:"fr-BE",3084:"fr-CA",1036:"fr",5132:"fr-LU",6156:"fr-MC",4108:"fr-CH",1122:"fy",1110:"gl",1079:"ka",3079:"de-AT",1031:"de",5127:"de-LI",4103:"de-LU",2055:"de-CH",1032:"el",1135:"kl",1095:"gu",1128:"ha",1037:"he",1081:"hi",1038:"hu",1039:"is",1136:"ig",1057:"id",1117:"iu",2141:"iu-Latn",2108:"ga",1076:"xh",1077:"zu",1040:"it",2064:"it-CH",1041:"ja",1099:"kn",1087:"kk",1107:"km",1158:"quc",1159:"rw",1089:"sw",1111:"kok",1042:"ko",1088:"ky",1108:"lo",1062:"lv",1063:"lt",2094:"dsb",1134:"lb",1071:"mk",2110:"ms-BN",1086:"ms",1100:"ml",1082:"mt",1153:"mi",1146:"arn",1102:"mr",1148:"moh",1104:"mn",2128:"mn-CN",1121:"ne",1044:"nb",2068:"nn",1154:"oc",1096:"or",1123:"ps",1045:"pl",1046:"pt",2070:"pt-PT",1094:"pa",1131:"qu-BO",2155:"qu-EC",3179:"qu",1048:"ro",1047:"rm",1049:"ru",9275:"smn",4155:"smj-NO",5179:"smj",3131:"se-FI",1083:"se",2107:"se-SE",8251:"sms",6203:"sma-NO",7227:"sms",1103:"sa",7194:"sr-Cyrl-BA",3098:"sr",6170:"sr-Latn-BA",2074:"sr-Latn",1132:"nso",1074:"tn",1115:"si",1051:"sk",1060:"sl",11274:"es-AR",16394:"es-BO",13322:"es-CL",9226:"es-CO",5130:"es-CR",7178:"es-DO",12298:"es-EC",17418:"es-SV",4106:"es-GT",18442:"es-HN",2058:"es-MX",19466:"es-NI",6154:"es-PA",15370:"es-PY",10250:"es-PE",20490:"es-PR",3082:"es",1034:"es",21514:"es-US",14346:"es-UY",8202:"es-VE",2077:"sv-FI",1053:"sv",1114:"syr",1064:"tg",2143:"tzm",1097:"ta",1092:"tt",1098:"te",1054:"th",1105:"bo",1055:"tr",1090:"tk",1152:"ug",1058:"uk",1070:"hsb",1056:"ur",2115:"uz-Cyrl",1091:"uz",1066:"vi",1106:"cy",1160:"wo",1157:"sah",1144:"ii",1130:"yo"},eD="utf-16",eF={0:"macintosh",1:"x-mac-japanese",2:"x-mac-chinesetrad",3:"x-mac-korean",6:"x-mac-greek",7:"x-mac-cyrillic",9:"x-mac-devanagai",10:"x-mac-gurmukhi",11:"x-mac-gujarati",12:"x-mac-oriya",13:"x-mac-bengali",14:"x-mac-tamil",15:"x-mac-telugu",16:"x-mac-kannada",17:"x-mac-malayalam",18:"x-mac-sinhalese",19:"x-mac-burmese",20:"x-mac-khmer",21:"x-mac-thai",22:"x-mac-lao",23:"x-mac-georgian",24:"x-mac-armenian",25:"x-mac-chinesesimp",26:"x-mac-tibetan",27:"x-mac-mongolian",28:"x-mac-ethiopic",29:"x-mac-ce",30:"x-mac-vietnamese",31:"x-mac-extarabic"},eB={15:"x-mac-icelandic",17:"x-mac-turkish",18:"x-mac-croatian",24:"x-mac-ce",25:"x-mac-ce",26:"x-mac-ce",27:"x-mac-ce",28:"x-mac-ce",30:"x-mac-icelandic",37:"x-mac-romanian",38:"x-mac-ce",39:"x-mac-ce",40:"x-mac-ce",143:"x-mac-inuit",146:"x-mac-gaelic"};function eV(e,t,r){switch(e){case 0:return eD;case 1:return eB[r]||eF[t];case 3:if(1===t||10===t)return eD}}function eG(e){var t={};for(var r in e)t[e[r]]=parseInt(r);return t}function ez(e,t,r,i,n,a){return new K.Record("NameRecord",[{name:"platformID",type:"USHORT",value:e},{name:"encodingID",type:"USHORT",value:t},{name:"languageID",type:"USHORT",value:r},{name:"nameID",type:"USHORT",value:i},{name:"length",type:"USHORT",value:n},{name:"offset",type:"USHORT",value:a}])}function ej(e,t){var r=function(e,t){var r=e.length,i=t.length-r+1;i:for(var n=0;n<i;n++)for(;n<i;n++){for(var a=0;a<r;a++)if(t[n+a]!==e[a])continue i;return n}return -1}(e,t);if(r<0){r=t.length;for(var i=0,n=e.length;i<n;++i)t.push(e[i])}return r}var eH={parse:function(e,t,r){for(var i={},n=new ee.Parser(e,t),a=n.parseUShort(),s=n.parseUShort(),o=n.offset+n.parseUShort(),l=0;l<s;l++){var c=n.parseUShort(),u=n.parseUShort(),h=n.parseUShort(),p=n.parseUShort(),d=ek[p]||p,f=n.parseUShort(),m=n.parseUShort(),g=function(e,t,r){switch(e){case 0:if(65535===t)return"und";if(r)return r[t];break;case 1:return e_[t];case 3:return eU[t]}}(c,h,r),v=eV(c,u,h);if(void 0!==v&&void 0!==g){var y=void 0;if(y=v===eD?I.UTF16(e,o+m,f):I.MACSTRING(e,o+m,f,v)){var x=i[d];void 0===x&&(x=i[d]={}),x[g]=y}}}return 1===a&&n.parseUShort(),i},make:function(e,t){var r,i=[],n={},a=eG(ek);for(var s in e){var o=a[s];if(void 0===o&&(o=s),isNaN(r=parseInt(o)))throw Error('Name table entry "'+s+'" does not exist, see nameTableNames for complete list.');n[r]=e[s],i.push(r)}for(var l=eG(e_),c=eG(eU),u=[],h=[],p=0;p<i.length;p++){var d=n[r=i[p]];for(var f in d){var m=d[f],g=1,v=l[f],y=eL[v],x=eV(g,y,v),T=N.MACSTRING(m,x);void 0===T&&(g=0,(v=t.indexOf(f))<0&&(v=t.length,t.push(f)),y=4,T=N.UTF16(m));var b=ej(T,h);u.push(ez(g,y,v,r,T.length,b));var S=c[f];if(void 0!==S){var E=N.UTF16(m),R=ej(E,h);u.push(ez(3,1,S,r,E.length,R))}}}u.sort(function(e,t){return e.platformID-t.platformID||e.encodingID-t.encodingID||e.languageID-t.languageID||e.nameID-t.nameID});for(var A=new K.Table("name",[{name:"format",type:"USHORT",value:0},{name:"count",type:"USHORT",value:u.length},{name:"stringOffset",type:"USHORT",value:6+12*u.length}]),w=0;w<u.length;w++)A.fields.push({name:"record_"+w,type:"RECORD",value:u[w]});return A.fields.push({name:"strings",type:"LITERAL",value:h}),A}},eW=[{begin:0,end:127},{begin:128,end:255},{begin:256,end:383},{begin:384,end:591},{begin:592,end:687},{begin:688,end:767},{begin:768,end:879},{begin:880,end:1023},{begin:11392,end:11519},{begin:1024,end:1279},{begin:1328,end:1423},{begin:1424,end:1535},{begin:42240,end:42559},{begin:1536,end:1791},{begin:1984,end:2047},{begin:2304,end:2431},{begin:2432,end:2559},{begin:2560,end:2687},{begin:2688,end:2815},{begin:2816,end:2943},{begin:2944,end:3071},{begin:3072,end:3199},{begin:3200,end:3327},{begin:3328,end:3455},{begin:3584,end:3711},{begin:3712,end:3839},{begin:4256,end:4351},{begin:6912,end:7039},{begin:4352,end:4607},{begin:7680,end:7935},{begin:7936,end:8191},{begin:8192,end:8303},{begin:8304,end:8351},{begin:8352,end:8399},{begin:8400,end:8447},{begin:8448,end:8527},{begin:8528,end:8591},{begin:8592,end:8703},{begin:8704,end:8959},{begin:8960,end:9215},{begin:9216,end:9279},{begin:9280,end:9311},{begin:9312,end:9471},{begin:9472,end:9599},{begin:9600,end:9631},{begin:9632,end:9727},{begin:9728,end:9983},{begin:9984,end:10175},{begin:12288,end:12351},{begin:12352,end:12447},{begin:12448,end:12543},{begin:12544,end:12591},{begin:12592,end:12687},{begin:43072,end:43135},{begin:12800,end:13055},{begin:13056,end:13311},{begin:44032,end:55215},{begin:55296,end:57343},{begin:67840,end:67871},{begin:19968,end:40959},{begin:57344,end:63743},{begin:12736,end:12783},{begin:64256,end:64335},{begin:64336,end:65023},{begin:65056,end:65071},{begin:65040,end:65055},{begin:65104,end:65135},{begin:65136,end:65279},{begin:65280,end:65519},{begin:65520,end:65535},{begin:3840,end:4095},{begin:1792,end:1871},{begin:1920,end:1983},{begin:3456,end:3583},{begin:4096,end:4255},{begin:4608,end:4991},{begin:5024,end:5119},{begin:5120,end:5759},{begin:5760,end:5791},{begin:5792,end:5887},{begin:6016,end:6143},{begin:6144,end:6319},{begin:10240,end:10495},{begin:40960,end:42127},{begin:5888,end:5919},{begin:66304,end:66351},{begin:66352,end:66383},{begin:66560,end:66639},{begin:118784,end:119039},{begin:119808,end:120831},{begin:1044480,end:1048573},{begin:65024,end:65039},{begin:917504,end:917631},{begin:6400,end:6479},{begin:6480,end:6527},{begin:6528,end:6623},{begin:6656,end:6687},{begin:11264,end:11359},{begin:11568,end:11647},{begin:19904,end:19967},{begin:43008,end:43055},{begin:65536,end:65663},{begin:65856,end:65935},{begin:66432,end:66463},{begin:66464,end:66527},{begin:66640,end:66687},{begin:66688,end:66735},{begin:67584,end:67647},{begin:68096,end:68191},{begin:119552,end:119647},{begin:73728,end:74751},{begin:119648,end:119679},{begin:7040,end:7103},{begin:7168,end:7247},{begin:7248,end:7295},{begin:43136,end:43231},{begin:43264,end:43311},{begin:43312,end:43359},{begin:43520,end:43615},{begin:65936,end:65999},{begin:66e3,end:66047},{begin:66208,end:66271},{begin:127024,end:127135}],eK={parse:function(e,t){var r={},i=new ee.Parser(e,t);r.version=i.parseUShort(),r.xAvgCharWidth=i.parseShort(),r.usWeightClass=i.parseUShort(),r.usWidthClass=i.parseUShort(),r.fsType=i.parseUShort(),r.ySubscriptXSize=i.parseShort(),r.ySubscriptYSize=i.parseShort(),r.ySubscriptXOffset=i.parseShort(),r.ySubscriptYOffset=i.parseShort(),r.ySuperscriptXSize=i.parseShort(),r.ySuperscriptYSize=i.parseShort(),r.ySuperscriptXOffset=i.parseShort(),r.ySuperscriptYOffset=i.parseShort(),r.yStrikeoutSize=i.parseShort(),r.yStrikeoutPosition=i.parseShort(),r.sFamilyClass=i.parseShort(),r.panose=[];for(var n=0;n<10;n++)r.panose[n]=i.parseByte();return r.ulUnicodeRange1=i.parseULong(),r.ulUnicodeRange2=i.parseULong(),r.ulUnicodeRange3=i.parseULong(),r.ulUnicodeRange4=i.parseULong(),r.achVendID=String.fromCharCode(i.parseByte(),i.parseByte(),i.parseByte(),i.parseByte()),r.fsSelection=i.parseUShort(),r.usFirstCharIndex=i.parseUShort(),r.usLastCharIndex=i.parseUShort(),r.sTypoAscender=i.parseShort(),r.sTypoDescender=i.parseShort(),r.sTypoLineGap=i.parseShort(),r.usWinAscent=i.parseUShort(),r.usWinDescent=i.parseUShort(),r.version>=1&&(r.ulCodePageRange1=i.parseULong(),r.ulCodePageRange2=i.parseULong()),r.version>=2&&(r.sxHeight=i.parseShort(),r.sCapHeight=i.parseShort(),r.usDefaultChar=i.parseUShort(),r.usBreakChar=i.parseUShort(),r.usMaxContent=i.parseUShort()),r},make:function(e){return new K.Table("OS/2",[{name:"version",type:"USHORT",value:3},{name:"xAvgCharWidth",type:"SHORT",value:0},{name:"usWeightClass",type:"USHORT",value:0},{name:"usWidthClass",type:"USHORT",value:0},{name:"fsType",type:"USHORT",value:0},{name:"ySubscriptXSize",type:"SHORT",value:650},{name:"ySubscriptYSize",type:"SHORT",value:699},{name:"ySubscriptXOffset",type:"SHORT",value:0},{name:"ySubscriptYOffset",type:"SHORT",value:140},{name:"ySuperscriptXSize",type:"SHORT",value:650},{name:"ySuperscriptYSize",type:"SHORT",value:699},{name:"ySuperscriptXOffset",type:"SHORT",value:0},{name:"ySuperscriptYOffset",type:"SHORT",value:479},{name:"yStrikeoutSize",type:"SHORT",value:49},{name:"yStrikeoutPosition",type:"SHORT",value:258},{name:"sFamilyClass",type:"SHORT",value:0},{name:"bFamilyType",type:"BYTE",value:0},{name:"bSerifStyle",type:"BYTE",value:0},{name:"bWeight",type:"BYTE",value:0},{name:"bProportion",type:"BYTE",value:0},{name:"bContrast",type:"BYTE",value:0},{name:"bStrokeVariation",type:"BYTE",value:0},{name:"bArmStyle",type:"BYTE",value:0},{name:"bLetterform",type:"BYTE",value:0},{name:"bMidline",type:"BYTE",value:0},{name:"bXHeight",type:"BYTE",value:0},{name:"ulUnicodeRange1",type:"ULONG",value:0},{name:"ulUnicodeRange2",type:"ULONG",value:0},{name:"ulUnicodeRange3",type:"ULONG",value:0},{name:"ulUnicodeRange4",type:"ULONG",value:0},{name:"achVendID",type:"CHARARRAY",value:"XXXX"},{name:"fsSelection",type:"USHORT",value:0},{name:"usFirstCharIndex",type:"USHORT",value:0},{name:"usLastCharIndex",type:"USHORT",value:0},{name:"sTypoAscender",type:"SHORT",value:0},{name:"sTypoDescender",type:"SHORT",value:0},{name:"sTypoLineGap",type:"SHORT",value:0},{name:"usWinAscent",type:"USHORT",value:0},{name:"usWinDescent",type:"USHORT",value:0},{name:"ulCodePageRange1",type:"ULONG",value:0},{name:"ulCodePageRange2",type:"ULONG",value:0},{name:"sxHeight",type:"SHORT",value:0},{name:"sCapHeight",type:"SHORT",value:0},{name:"usDefaultChar",type:"USHORT",value:0},{name:"usBreakChar",type:"USHORT",value:0},{name:"usMaxContext",type:"USHORT",value:0}],e)},unicodeRanges:eW,getUnicodeRange:function(e){for(var t=0;t<eW.length;t+=1){var r=eW[t];if(e>=r.begin&&e<r.end)return t}return -1}},eX={parse:function(e,t){var r={},i=new ee.Parser(e,t);switch(r.version=i.parseVersion(),r.italicAngle=i.parseFixed(),r.underlinePosition=i.parseShort(),r.underlineThickness=i.parseShort(),r.isFixedPitch=i.parseULong(),r.minMemType42=i.parseULong(),r.maxMemType42=i.parseULong(),r.minMemType1=i.parseULong(),r.maxMemType1=i.parseULong(),r.version){case 1:r.names=ea.slice();break;case 2:r.numberOfGlyphs=i.parseUShort(),r.glyphNameIndex=Array(r.numberOfGlyphs);for(var n=0;n<r.numberOfGlyphs;n++)r.glyphNameIndex[n]=i.parseUShort();r.names=[];for(var a=0;a<r.numberOfGlyphs;a++)if(r.glyphNameIndex[a]>=ea.length){var s=i.parseChar();r.names.push(i.parseString(s))}break;case 2.5:r.numberOfGlyphs=i.parseUShort(),r.offset=Array(r.numberOfGlyphs);for(var o=0;o<r.numberOfGlyphs;o++)r.offset[o]=i.parseChar()}return r},make:function(){return new K.Table("post",[{name:"version",type:"FIXED",value:196608},{name:"italicAngle",type:"FIXED",value:0},{name:"underlinePosition",type:"FWORD",value:0},{name:"underlineThickness",type:"FWORD",value:0},{name:"isFixedPitch",type:"ULONG",value:0},{name:"minMemType42",type:"ULONG",value:0},{name:"maxMemType42",type:"ULONG",value:0},{name:"minMemType1",type:"ULONG",value:0},{name:"maxMemType1",type:"ULONG",value:0}])}},eY=Array(9);eY[1]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();return 1===t?{substFormat:1,coverage:this.parsePointer(Q.coverage),deltaGlyphId:this.parseUShort()}:2===t?{substFormat:2,coverage:this.parsePointer(Q.coverage),substitute:this.parseOffset16List()}:void C.assert(!1,"0x"+e.toString(16)+": lookup type 1 format must be 1 or 2.")},eY[2]=function(){var e=this.parseUShort();return C.argument(1===e,"GSUB Multiple Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(Q.coverage),sequences:this.parseListOfLists()}},eY[3]=function(){var e=this.parseUShort();return C.argument(1===e,"GSUB Alternate Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(Q.coverage),alternateSets:this.parseListOfLists()}},eY[4]=function(){var e=this.parseUShort();return C.argument(1===e,"GSUB ligature table identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(Q.coverage),ligatureSets:this.parseListOfLists(function(){return{ligGlyph:this.parseUShort(),components:this.parseUShortList(this.parseUShort()-1)}})}};var eq={sequenceIndex:Q.uShort,lookupListIndex:Q.uShort};eY[5]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();if(1===t)return{substFormat:t,coverage:this.parsePointer(Q.coverage),ruleSets:this.parseListOfLists(function(){var e=this.parseUShort(),t=this.parseUShort();return{input:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,eq)}})};if(2===t)return{substFormat:t,coverage:this.parsePointer(Q.coverage),classDef:this.parsePointer(Q.classDef),classSets:this.parseListOfLists(function(){var e=this.parseUShort(),t=this.parseUShort();return{classes:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,eq)}})};if(3===t){var r=this.parseUShort(),i=this.parseUShort();return{substFormat:t,coverages:this.parseList(r,Q.pointer(Q.coverage)),lookupRecords:this.parseRecordList(i,eq)}}C.assert(!1,"0x"+e.toString(16)+": lookup type 5 format must be 1, 2 or 3.")},eY[6]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();return 1===t?{substFormat:1,coverage:this.parsePointer(Q.coverage),chainRuleSets:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(eq)}})}:2===t?{substFormat:2,coverage:this.parsePointer(Q.coverage),backtrackClassDef:this.parsePointer(Q.classDef),inputClassDef:this.parsePointer(Q.classDef),lookaheadClassDef:this.parsePointer(Q.classDef),chainClassSet:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(eq)}})}:3===t?{substFormat:3,backtrackCoverage:this.parseList(Q.pointer(Q.coverage)),inputCoverage:this.parseList(Q.pointer(Q.coverage)),lookaheadCoverage:this.parseList(Q.pointer(Q.coverage)),lookupRecords:this.parseRecordList(eq)}:void C.assert(!1,"0x"+e.toString(16)+": lookup type 6 format must be 1, 2 or 3.")},eY[7]=function(){var e=this.parseUShort();C.argument(1===e,"GSUB Extension Substitution subtable identifier-format must be 1");var t=this.parseUShort(),r=new Q(this.data,this.offset+this.parseULong());return{substFormat:1,lookupType:t,extension:eY[t].call(r)}},eY[8]=function(){var e=this.parseUShort();return C.argument(1===e,"GSUB Reverse Chaining Contextual Single Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(Q.coverage),backtrackCoverage:this.parseList(Q.pointer(Q.coverage)),lookaheadCoverage:this.parseList(Q.pointer(Q.coverage)),substitutes:this.parseUShortList()}};var eZ=Array(9);eZ[1]=function(e){return 1===e.substFormat?new K.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new K.Coverage(e.coverage)},{name:"deltaGlyphID",type:"USHORT",value:e.deltaGlyphId}]):new K.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:2},{name:"coverage",type:"TABLE",value:new K.Coverage(e.coverage)}].concat(K.ushortList("substitute",e.substitute)))},eZ[2]=function(e){return C.assert(1===e.substFormat,"Lookup type 2 substFormat must be 1."),new K.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new K.Coverage(e.coverage)}].concat(K.tableList("seqSet",e.sequences,function(e){return new K.Table("sequenceSetTable",K.ushortList("sequence",e))})))},eZ[3]=function(e){return C.assert(1===e.substFormat,"Lookup type 3 substFormat must be 1."),new K.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new K.Coverage(e.coverage)}].concat(K.tableList("altSet",e.alternateSets,function(e){return new K.Table("alternateSetTable",K.ushortList("alternate",e))})))},eZ[4]=function(e){return C.assert(1===e.substFormat,"Lookup type 4 substFormat must be 1."),new K.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new K.Coverage(e.coverage)}].concat(K.tableList("ligSet",e.ligatureSets,function(e){return new K.Table("ligatureSetTable",K.tableList("ligature",e,function(e){return new K.Table("ligatureTable",[{name:"ligGlyph",type:"USHORT",value:e.ligGlyph}].concat(K.ushortList("component",e.components,e.components.length+1)))}))})))},eZ[6]=function(e){if(1===e.substFormat)return new K.Table("chainContextTable",[{name:"substFormat",type:"USHORT",value:e.substFormat},{name:"coverage",type:"TABLE",value:new K.Coverage(e.coverage)}].concat(K.tableList("chainRuleSet",e.chainRuleSets,function(e){return new K.Table("chainRuleSetTable",K.tableList("chainRule",e,function(e){var t=K.ushortList("backtrackGlyph",e.backtrack,e.backtrack.length).concat(K.ushortList("inputGlyph",e.input,e.input.length+1)).concat(K.ushortList("lookaheadGlyph",e.lookahead,e.lookahead.length)).concat(K.ushortList("substitution",[],e.lookupRecords.length));return e.lookupRecords.forEach(function(e,r){t=t.concat({name:"sequenceIndex"+r,type:"USHORT",value:e.sequenceIndex}).concat({name:"lookupListIndex"+r,type:"USHORT",value:e.lookupListIndex})}),new K.Table("chainRuleTable",t)}))})));if(2===e.substFormat)C.assert(!1,"lookup type 6 format 2 is not yet supported.");else if(3===e.substFormat){var t=[{name:"substFormat",type:"USHORT",value:e.substFormat}];return t.push({name:"backtrackGlyphCount",type:"USHORT",value:e.backtrackCoverage.length}),e.backtrackCoverage.forEach(function(e,r){t.push({name:"backtrackCoverage"+r,type:"TABLE",value:new K.Coverage(e)})}),t.push({name:"inputGlyphCount",type:"USHORT",value:e.inputCoverage.length}),e.inputCoverage.forEach(function(e,r){t.push({name:"inputCoverage"+r,type:"TABLE",value:new K.Coverage(e)})}),t.push({name:"lookaheadGlyphCount",type:"USHORT",value:e.lookaheadCoverage.length}),e.lookaheadCoverage.forEach(function(e,r){t.push({name:"lookaheadCoverage"+r,type:"TABLE",value:new K.Coverage(e)})}),t.push({name:"substitutionCount",type:"USHORT",value:e.lookupRecords.length}),e.lookupRecords.forEach(function(e,r){t=t.concat({name:"sequenceIndex"+r,type:"USHORT",value:e.sequenceIndex}).concat({name:"lookupListIndex"+r,type:"USHORT",value:e.lookupListIndex})}),new K.Table("chainContextTable",t)}C.assert(!1,"lookup type 6 format must be 1, 2 or 3.")};var e$={parse:function(e,t){var r=new Q(e,t=t||0),i=r.parseVersion(1);return(C.argument(1===i||1.1===i,"Unsupported GSUB table version."),1===i)?{version:i,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(eY)}:{version:i,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(eY),variations:r.parseFeatureVariationsList()}},make:function(e){return new K.Table("GSUB",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new K.ScriptList(e.scripts)},{name:"features",type:"TABLE",value:new K.FeatureList(e.features)},{name:"lookups",type:"TABLE",value:new K.LookupList(e.lookups,eZ)}])}},eQ={parse:function(e,t){var r=new ee.Parser(e,t),i=r.parseULong();C.argument(1===i,"Unsupported META table version."),r.parseULong(),r.parseULong();for(var n=r.parseULong(),a={},s=0;s<n;s++){var o=r.parseTag(),l=r.parseULong(),c=r.parseULong(),u=I.UTF8(e,t+l,c);a[o]=u}return a},make:function(e){var t=Object.keys(e).length,r="",i=16+12*t,n=new K.Table("meta",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"offset",type:"ULONG",value:i},{name:"numTags",type:"ULONG",value:t}]);for(var a in e){var s=r.length;r+=e[a],n.fields.push({name:"tag "+a,type:"TAG",value:a}),n.fields.push({name:"offset "+a,type:"ULONG",value:i+s}),n.fields.push({name:"length "+a,type:"ULONG",value:e[a].length})}return n.fields.push({name:"stringPool",type:"CHARARRAY",value:r}),n}};function eJ(e){return Math.log(e)/Math.log(2)|0}function e0(e){for(;e.length%4!=0;)e.push(0);for(var t=0,r=0;r<e.length;r+=4)t+=(e[r]<<24)+(e[r+1]<<16)+(e[r+2]<<8)+e[r+3];return t%4294967296}function e1(e,t,r,i){return new K.Record("Table Record",[{name:"tag",type:"TAG",value:void 0!==e?e:""},{name:"checkSum",type:"ULONG",value:void 0!==t?t:0},{name:"offset",type:"ULONG",value:void 0!==r?r:0},{name:"length",type:"ULONG",value:void 0!==i?i:0}])}function e2(e){var t=new K.Table("sfnt",[{name:"version",type:"TAG",value:"OTTO"},{name:"numTables",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);t.tables=e,t.numTables=e.length;var r=Math.pow(2,eJ(t.numTables));t.searchRange=16*r,t.entrySelector=eJ(r),t.rangeShift=16*t.numTables-t.searchRange;for(var i=[],n=[],a=t.sizeOf()+e1().sizeOf()*t.numTables;a%4!=0;)a+=1,n.push({name:"padding",type:"BYTE",value:0});for(var s=0;s<e.length;s+=1){var o=e[s];C.argument(4===o.tableName.length,"Table name"+o.tableName+" is invalid.");var l=o.sizeOf(),c=e1(o.tableName,e0(o.encode()),a,l);for(i.push({name:c.tag+" Table Record",type:"RECORD",value:c}),n.push({name:o.tableName+" table",type:"RECORD",value:o}),a+=l,C.argument(!isNaN(a),"Something went wrong calculating the offset.");a%4!=0;)a+=1,n.push({name:"padding",type:"BYTE",value:0})}return i.sort(function(e,t){return e.value.tag>t.value.tag?1:-1}),t.fields=t.fields.concat(i),t.fields=t.fields.concat(n),t}function e3(e,t,r){for(var i=0;i<t.length;i+=1){var n=e.charToGlyphIndex(t[i]);if(n>0)return e.glyphs.get(n).getMetrics()}return r}var e4={make:e2,fontToTable:function(e){for(var t,r=[],i=[],n=[],a=[],s=[],o=[],l=[],c=0,u=0,h=0,p=0,d=0,f=0;f<e.glyphs.length;f+=1){var m=e.glyphs.get(f),g=0|m.unicode;if(isNaN(m.advanceWidth))throw Error("Glyph "+m.name+" ("+f+"): advanceWidth is not a number.");(t>g||void 0===t)&&g>0&&(t=g),c<g&&(c=g);var v=eK.getUnicodeRange(g);if(v<32)u|=1<<v;else if(v<64)h|=1<<v-32;else if(v<96)p|=1<<v-64;else if(v<123)d|=1<<v-96;else throw Error("Unicode ranges bits > 123 are reserved for internal usage");if(".notdef"!==m.name){var y=m.getMetrics();r.push(y.xMin),i.push(y.yMin),n.push(y.xMax),a.push(y.yMax),o.push(y.leftSideBearing),l.push(y.rightSideBearing),s.push(m.advanceWidth)}}var x={xMin:Math.min.apply(null,r),yMin:Math.min.apply(null,i),xMax:Math.max.apply(null,n),yMax:Math.max.apply(null,a),advanceWidthMax:Math.max.apply(null,s),advanceWidthAvg:function(e){for(var t=0,r=0;r<e.length;r+=1)t+=e[r];return t/e.length}(s),minLeftSideBearing:Math.min.apply(null,o),maxLeftSideBearing:Math.max.apply(null,o),minRightSideBearing:Math.min.apply(null,l)};x.ascender=e.ascender,x.descender=e.descender;var T=eI.make({flags:3,unitsPerEm:e.unitsPerEm,xMin:x.xMin,yMin:x.yMin,xMax:x.xMax,yMax:x.yMax,lowestRecPPEM:3,createdTimestamp:e.createdTimestamp}),b=eN.make({ascender:x.ascender,descender:x.descender,advanceWidthMax:x.advanceWidthMax,minLeftSideBearing:x.minLeftSideBearing,minRightSideBearing:x.minRightSideBearing,xMaxExtent:x.maxLeftSideBearing+(x.xMax-x.xMin),numberOfHMetrics:e.glyphs.length}),S=eP.make(e.glyphs.length),E=eK.make(Object.assign({xAvgCharWidth:Math.round(x.advanceWidthAvg),usFirstCharIndex:t,usLastCharIndex:c,ulUnicodeRange1:u,ulUnicodeRange2:h,ulUnicodeRange3:p,ulUnicodeRange4:d,sTypoAscender:x.ascender,sTypoDescender:x.descender,sTypoLineGap:0,usWinAscent:x.yMax,usWinDescent:Math.abs(x.yMin),ulCodePageRange1:1,sxHeight:e3(e,"xyvw",{yMax:Math.round(x.ascender/2)}).yMax,sCapHeight:e3(e,"HIKLEFJMNTZBDPRAGOQSUVWXY",x).yMax,usDefaultChar:e.hasChar(" ")?32:0,usBreakChar:e.hasChar(" ")?32:0},e.tables.os2)),R=function(e){for(var t=new K.Table("hmtx",[]),r=0;r<e.length;r+=1){var i=e.get(r),n=i.advanceWidth||0,a=i.leftSideBearing||0;t.fields.push({name:"advanceWidth_"+r,type:"USHORT",value:n}),t.fields.push({name:"leftSideBearing_"+r,type:"SHORT",value:a})}return t}(e.glyphs),A=et.make(e.glyphs),w=e.getEnglishName("fontFamily"),M=e.getEnglishName("fontSubfamily"),C=w+" "+M,I=e.getEnglishName("postScriptName");I||(I=w.replace(/\s/g,"")+"-"+M);var N={};for(var O in e.names)N[O]=e.names[O];N.uniqueID||(N.uniqueID={en:e.getEnglishName("manufacturer")+":"+C}),N.postScriptName||(N.postScriptName={en:I}),N.preferredFamily||(N.preferredFamily=e.names.fontFamily),N.preferredSubfamily||(N.preferredSubfamily=e.names.fontSubfamily);var P=[],k=eH.make(N,P),_=P.length>0?eO.make(P):void 0,L=eX.make(),U=eC.make(e.glyphs,{version:e.getEnglishName("version"),fullName:C,familyName:w,weightName:M,postScriptName:I,unitsPerEm:e.unitsPerEm,fontBBox:[0,x.yMin,x.ascender,x.advanceWidthMax]}),D=e.metas&&Object.keys(e.metas).length>0?eQ.make(e.metas):void 0,F=[T,b,S,E,k,A,L,U,R];_&&F.push(_),e.tables.gsub&&F.push(e$.make(e.tables.gsub)),D&&F.push(D);for(var B=e2(F),V=e0(B.encode()),G=B.fields,z=!1,j=0;j<G.length;j+=1)if("head table"===G[j].name){G[j].value.checkSumAdjustment=2981146554-V,z=!0;break}if(!z)throw Error("Could not find head table with checkSum to adjust.");return B},computeCheckSum:e0};function e5(e,t){for(var r=0,i=e.length-1;r<=i;){var n=r+i>>>1,a=e[n].tag;if(a===t)return n;a<t?r=n+1:i=n-1}return-r-1}function e6(e,t){for(var r=0,i=e.length-1;r<=i;){var n=r+i>>>1,a=e[n];if(a===t)return n;a<t?r=n+1:i=n-1}return-r-1}function e8(e,t){for(var r,i=0,n=e.length-1;i<=n;){var a=i+n>>>1,s=(r=e[a]).start;if(s===t)return r;s<t?i=a+1:n=a-1}if(i>0)return t>(r=e[i-1]).end?0:r}function e9(e,t){this.font=e,this.tableName=t}function e7(e){e9.call(this,e,"gpos")}function te(e){e9.call(this,e,"gsub")}function tt(e,t,r){for(var i=e.subtables,n=0;n<i.length;n++){var a=i[n];if(a.substFormat===t)return a}if(r)return i.push(r),r}function tr(e,t){if(!e)throw t}function ti(e,t,r,i,n){var a;return(t&i)>0?(a=e.parseByte(),(t&n)==0&&(a=-a),a=r+a):a=(t&n)>0?r:r+e.parseShort(),a}function tn(e,t,r){var i=new ee.Parser(t,r);if(e.numberOfContours=i.parseShort(),e._xMin=i.parseShort(),e._yMin=i.parseShort(),e._xMax=i.parseShort(),e._yMax=i.parseShort(),e.numberOfContours>0){for(var n=e.endPointIndices=[],a=0;a<e.numberOfContours;a+=1)n.push(i.parseUShort());e.instructionLength=i.parseUShort(),e.instructions=[];for(var s=0;s<e.instructionLength;s+=1)e.instructions.push(i.parseByte());var o=n[n.length-1]+1;h=[];for(var l=0;l<o;l+=1)if(p=i.parseByte(),h.push(p),(8&p)>0)for(var c=i.parseByte(),u=0;u<c;u+=1)h.push(p),l+=1;if(C.argument(h.length===o,"Bad flags."),n.length>0){var h,p,d,f=[];if(o>0){for(var m=0;m<o;m+=1)p=h[m],(d={}).onCurve=!!(1&p),d.lastPointOfContour=n.indexOf(m)>=0,f.push(d);for(var g=0,v=0;v<o;v+=1)p=h[v],(d=f[v]).x=ti(i,p,g,2,16),g=d.x;for(var y=0,x=0;x<o;x+=1)p=h[x],(d=f[x]).y=ti(i,p,y,4,32),y=d.y}e.points=f}else e.points=[]}else if(0===e.numberOfContours)e.points=[];else{e.isComposite=!0,e.points=[],e.components=[];for(var T=!0;T;){h=i.parseUShort();var b={glyphIndex:i.parseUShort(),xScale:1,scale01:0,scale10:0,yScale:1,dx:0,dy:0};(1&h)>0?(2&h)>0?(b.dx=i.parseShort(),b.dy=i.parseShort()):b.matchedPoints=[i.parseUShort(),i.parseUShort()]:(2&h)>0?(b.dx=i.parseChar(),b.dy=i.parseChar()):b.matchedPoints=[i.parseByte(),i.parseByte()],(8&h)>0?b.xScale=b.yScale=i.parseF2Dot14():(64&h)>0?(b.xScale=i.parseF2Dot14(),b.yScale=i.parseF2Dot14()):(128&h)>0&&(b.xScale=i.parseF2Dot14(),b.scale01=i.parseF2Dot14(),b.scale10=i.parseF2Dot14(),b.yScale=i.parseF2Dot14()),e.components.push(b),T=!!(32&h)}if(256&h){e.instructionLength=i.parseUShort(),e.instructions=[];for(var S=0;S<e.instructionLength;S+=1)e.instructions.push(i.parseByte())}}}function ta(e,t){for(var r=[],i=0;i<e.length;i+=1){var n=e[i],a={x:t.xScale*n.x+t.scale01*n.y+t.dx,y:t.scale10*n.x+t.yScale*n.y+t.dy,onCurve:n.onCurve,lastPointOfContour:n.lastPointOfContour};r.push(a)}return r}function ts(e){var t=new A;if(!e)return t;for(var r=function(e){for(var t=[],r=[],i=0;i<e.length;i+=1){var n=e[i];r.push(n),n.lastPointOfContour&&(t.push(r),r=[])}return C.argument(0===r.length,"There are still points left in the current contour."),t}(e),i=0;i<r.length;++i){var n=r[i],a=null,s=n[n.length-1],o=n[0];if(s.onCurve)t.moveTo(s.x,s.y);else if(o.onCurve)t.moveTo(o.x,o.y);else{var l={x:(s.x+o.x)*.5,y:(s.y+o.y)*.5};t.moveTo(l.x,l.y)}for(var c=0;c<n.length;++c)if(a=s,s=o,o=n[(c+1)%n.length],s.onCurve)t.lineTo(s.x,s.y);else{var u=o;a.onCurve||(s.x,a.x,s.y,a.y),o.onCurve||(u={x:(s.x+o.x)*.5,y:(s.y+o.y)*.5}),t.quadraticCurveTo(s.x,s.y,u.x,u.y)}t.closePath()}return t}function to(e,t){if(t.isComposite)for(var r=0;r<t.components.length;r+=1){var i=t.components[r],n=e.get(i.glyphIndex);if(n.getPath(),n.points){var a=void 0;if(void 0===i.matchedPoints)a=ta(n.points,i);else{if(i.matchedPoints[0]>t.points.length-1||i.matchedPoints[1]>n.points.length-1)throw Error("Matched points out of range in "+t.name);var s=t.points[i.matchedPoints[0]],o=n.points[i.matchedPoints[1]],l={xScale:i.xScale,scale01:i.scale01,scale10:i.scale10,yScale:i.yScale,dx:0,dy:0};o=ta([o],l)[0],l.dx=s.x-o.x,l.dy=s.y-o.y,a=ta(n.points,l)}t.points=t.points.concat(a)}}return ts(t.points)}e9.prototype={searchTag:e5,binSearch:e6,getTable:function(e){var t=this.font.tables[this.tableName];return!t&&e&&(t=this.font.tables[this.tableName]=this.createDefaultTable()),t},getScriptNames:function(){var e=this.getTable();return e?e.scripts.map(function(e){return e.tag}):[]},getDefaultScriptName:function(){var e=this.getTable();if(e){for(var t=!1,r=0;r<e.scripts.length;r++){var i=e.scripts[r].tag;if("DFLT"===i)return i;"latn"===i&&(t=!0)}if(t)return"latn"}},getScriptTable:function(e,t){var r=this.getTable(t);if(r){e=e||"DFLT";var i=r.scripts,n=e5(r.scripts,e);if(n>=0)return i[n].script;if(t){var a={tag:e,script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}};return i.splice(-1-n,0,a),a.script}}},getLangSysTable:function(e,t,r){var i=this.getScriptTable(e,r);if(i){if(!t||"dflt"===t||"DFLT"===t)return i.defaultLangSys;var n=e5(i.langSysRecords,t);if(n>=0)return i.langSysRecords[n].langSys;if(r){var a={tag:t,langSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]}};return i.langSysRecords.splice(-1-n,0,a),a.langSys}}},getFeatureTable:function(e,t,r,i){var n=this.getLangSysTable(e,t,i);if(n){for(var a,s=n.featureIndexes,o=this.font.tables[this.tableName].features,l=0;l<s.length;l++)if((a=o[s[l]]).tag===r)return a.feature;if(i){var c=o.length;return C.assert(0===c||r>=o[c-1].tag,"Features must be added in alphabetical order."),a={tag:r,feature:{params:0,lookupListIndexes:[]}},o.push(a),s.push(c),a.feature}}},getLookupTables:function(e,t,r,i,n){var a=this.getFeatureTable(e,t,r,n),s=[];if(a){for(var o,l=a.lookupListIndexes,c=this.font.tables[this.tableName].lookups,u=0;u<l.length;u++)(o=c[l[u]]).lookupType===i&&s.push(o);if(0===s.length&&n){o={lookupType:i,lookupFlag:0,subtables:[],markFilteringSet:void 0};var h=c.length;return c.push(o),l.push(h),[o]}}return s},getGlyphClass:function(e,t){switch(e.format){case 1:if(e.startGlyph<=t&&t<e.startGlyph+e.classes.length)return e.classes[t-e.startGlyph];return 0;case 2:var r=e8(e.ranges,t);return r?r.classId:0}},getCoverageIndex:function(e,t){switch(e.format){case 1:var r=e6(e.glyphs,t);return r>=0?r:-1;case 2:var i=e8(e.ranges,t);return i?i.index+t-i.start:-1}},expandCoverage:function(e){if(1===e.format)return e.glyphs;for(var t=[],r=e.ranges,i=0;i<r.length;i++)for(var n=r[i],a=n.start,s=n.end,o=a;o<=s;o++)t.push(o);return t}},e7.prototype=e9.prototype,e7.prototype.init=function(){var e=this.getDefaultScriptName();this.defaultKerningTables=this.getKerningTables(e)},e7.prototype.getKerningValue=function(e,t,r){for(var i=0;i<e.length;i++)for(var n=e[i].subtables,a=0;a<n.length;a++){var s=n[a],o=this.getCoverageIndex(s.coverage,t);if(!(o<0))switch(s.posFormat){case 1:for(var l=s.pairSets[o],c=0;c<l.length;c++){var u=l[c];if(u.secondGlyph===r)return u.value1&&u.value1.xAdvance||0}break;case 2:var h=this.getGlyphClass(s.classDef1,t),p=this.getGlyphClass(s.classDef2,r),d=s.classRecords[h][p];return d.value1&&d.value1.xAdvance||0}}return 0},e7.prototype.getKerningTables=function(e,t){if(this.font.tables.gpos)return this.getLookupTables(e,t,"kern",2)},te.prototype=e9.prototype,te.prototype.createDefaultTable=function(){return{version:1,scripts:[{tag:"DFLT",script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}}],features:[],lookups:[]}},te.prototype.getSingle=function(e,t,r){for(var i=[],n=this.getLookupTables(t,r,e,1),a=0;a<n.length;a++)for(var s=n[a].subtables,o=0;o<s.length;o++){var l=s[o],c=this.expandCoverage(l.coverage),u=void 0;if(1===l.substFormat){var h=l.deltaGlyphId;for(u=0;u<c.length;u++){var p=c[u];i.push({sub:p,by:p+h})}}else{var d=l.substitute;for(u=0;u<c.length;u++)i.push({sub:c[u],by:d[u]})}}return i},te.prototype.getMultiple=function(e,t,r){for(var i=[],n=this.getLookupTables(t,r,e,2),a=0;a<n.length;a++)for(var s=n[a].subtables,o=0;o<s.length;o++){var l=s[o],c=this.expandCoverage(l.coverage),u=void 0;for(u=0;u<c.length;u++){var h=c[u],p=l.sequences[u];i.push({sub:h,by:p})}}return i},te.prototype.getAlternates=function(e,t,r){for(var i=[],n=this.getLookupTables(t,r,e,3),a=0;a<n.length;a++)for(var s=n[a].subtables,o=0;o<s.length;o++)for(var l=s[o],c=this.expandCoverage(l.coverage),u=l.alternateSets,h=0;h<c.length;h++)i.push({sub:c[h],by:u[h]});return i},te.prototype.getLigatures=function(e,t,r){for(var i=[],n=this.getLookupTables(t,r,e,4),a=0;a<n.length;a++)for(var s=n[a].subtables,o=0;o<s.length;o++)for(var l=s[o],c=this.expandCoverage(l.coverage),u=l.ligatureSets,h=0;h<c.length;h++)for(var p=c[h],d=u[h],f=0;f<d.length;f++){var m=d[f];i.push({sub:[p].concat(m.components),by:m.ligGlyph})}return i},te.prototype.addSingle=function(e,t,r,i){var n=tt(this.getLookupTables(r,i,e,1,!0)[0],2,{substFormat:2,coverage:{format:1,glyphs:[]},substitute:[]});C.assert(1===n.coverage.format,"Single: unable to modify coverage table format "+n.coverage.format);var a=t.sub,s=this.binSearch(n.coverage.glyphs,a);s<0&&(s=-1-s,n.coverage.glyphs.splice(s,0,a),n.substitute.splice(s,0,0)),n.substitute[s]=t.by},te.prototype.addMultiple=function(e,t,r,i){C.assert(t.by instanceof Array&&t.by.length>1,'Multiple: "by" must be an array of two or more ids');var n=tt(this.getLookupTables(r,i,e,2,!0)[0],1,{substFormat:1,coverage:{format:1,glyphs:[]},sequences:[]});C.assert(1===n.coverage.format,"Multiple: unable to modify coverage table format "+n.coverage.format);var a=t.sub,s=this.binSearch(n.coverage.glyphs,a);s<0&&(s=-1-s,n.coverage.glyphs.splice(s,0,a),n.sequences.splice(s,0,0)),n.sequences[s]=t.by},te.prototype.addAlternate=function(e,t,r,i){var n=tt(this.getLookupTables(r,i,e,3,!0)[0],1,{substFormat:1,coverage:{format:1,glyphs:[]},alternateSets:[]});C.assert(1===n.coverage.format,"Alternate: unable to modify coverage table format "+n.coverage.format);var a=t.sub,s=this.binSearch(n.coverage.glyphs,a);s<0&&(s=-1-s,n.coverage.glyphs.splice(s,0,a),n.alternateSets.splice(s,0,0)),n.alternateSets[s]=t.by},te.prototype.addLigature=function(e,t,r,i){var n=this.getLookupTables(r,i,e,4,!0)[0],a=n.subtables[0];a||(a={substFormat:1,coverage:{format:1,glyphs:[]},ligatureSets:[]},n.subtables[0]=a),C.assert(1===a.coverage.format,"Ligature: unable to modify coverage table format "+a.coverage.format);var s=t.sub[0],o=t.sub.slice(1),l={ligGlyph:t.by,components:o},c=this.binSearch(a.coverage.glyphs,s);if(c>=0){for(var u=a.ligatureSets[c],h=0;h<u.length;h++)if(function(e,t){var r=e.length;if(r!==t.length)return!1;for(var i=0;i<r;i++)if(e[i]!==t[i])return!1;return!0}(u[h].components,o))return;u.push(l)}else c=-1-c,a.coverage.glyphs.splice(c,0,s),a.ligatureSets.splice(c,0,[l])},te.prototype.getFeature=function(e,t,r){if(/ss\d\d/.test(e))return this.getSingle(e,t,r);switch(e){case"aalt":case"salt":return this.getSingle(e,t,r).concat(this.getAlternates(e,t,r));case"dlig":case"liga":case"rlig":return this.getLigatures(e,t,r);case"ccmp":return this.getMultiple(e,t,r).concat(this.getLigatures(e,t,r));case"stch":return this.getMultiple(e,t,r)}},te.prototype.add=function(e,t,r,i){if(/ss\d\d/.test(e))return this.addSingle(e,t,r,i);switch(e){case"aalt":case"salt":if("number"==typeof t.by)return this.addSingle(e,t,r,i);return this.addAlternate(e,t,r,i);case"dlig":case"liga":case"rlig":return this.addLigature(e,t,r,i);case"ccmp":if(t.by instanceof Array)return this.addMultiple(e,t,r,i);return this.addLigature(e,t,r,i)}};var tl={getPath:ts,parse:function(e,t,r,i,n){var a;return n.lowMemory?(a=new ef.GlyphSet(i),i._push=function(n){var s=r[n];s!==r[n+1]?a.push(n,ef.ttfGlyphLoader(i,n,tn,e,t+s,to)):a.push(n,ef.glyphLoader(i,n))},a):function(e,t,r,i){for(var n=new ef.GlyphSet(i),a=0;a<r.length-1;a+=1){var s=r[a];s!==r[a+1]?n.push(a,ef.ttfGlyphLoader(i,a,tn,e,t+s,to)):n.push(a,ef.glyphLoader(i,a))}return n}(e,t,r,i)}};function tc(e){this.font=e,this.getCommands=function(e){return tl.getPath(e).commands},this._fpgmState=this._prepState=void 0,this._errorState=0}function tu(e){return e}function th(e){return Math.sign(e)*Math.round(Math.abs(e))}function tp(e){return Math.sign(e)*Math.round(Math.abs(2*e))/2}function td(e){return Math.sign(e)*(Math.round(Math.abs(e)+.5)-.5)}function tf(e){return Math.sign(e)*Math.ceil(Math.abs(e))}function tm(e){return Math.sign(e)*Math.floor(Math.abs(e))}var tg=function(e){var t=this.srPeriod,r=this.srPhase,i=this.srThreshold,n=1;return(e<0&&(e=-e,n=-1),e+=i-r,(e=Math.trunc(e/t)*t+r)<0)?r*n:e*n},tv={x:1,y:0,axis:"x",distance:function(e,t,r,i){return(r?e.xo:e.x)-(i?t.xo:t.x)},interpolate:function(e,t,r,i){var n,a,s,o,l,c,u;if(!i||i===this){if(n=e.xo-t.xo,a=e.xo-r.xo,l=t.x-t.xo,c=r.x-r.xo,0===(u=(s=Math.abs(n))+(o=Math.abs(a)))){e.x=e.xo+(l+c)/2;return}e.x=e.xo+(l*o+c*s)/u;return}if(n=i.distance(e,t,!0,!0),a=i.distance(e,r,!0,!0),l=i.distance(t,t,!1,!0),c=i.distance(r,r,!1,!0),0===(u=(s=Math.abs(n))+(o=Math.abs(a)))){tv.setRelative(e,e,(l+c)/2,i,!0);return}tv.setRelative(e,e,(l*o+c*s)/u,i,!0)},normalSlope:Number.NEGATIVE_INFINITY,setRelative:function(e,t,r,i,n){if(!i||i===this){e.x=(n?t.xo:t.x)+r;return}var a=n?t.xo:t.x,s=n?t.yo:t.y,o=a+r*i.x,l=s+r*i.y;e.x=o+(e.y-l)/i.normalSlope},slope:0,touch:function(e){e.xTouched=!0},touched:function(e){return e.xTouched},untouch:function(e){e.xTouched=!1}},ty={x:0,y:1,axis:"y",distance:function(e,t,r,i){return(r?e.yo:e.y)-(i?t.yo:t.y)},interpolate:function(e,t,r,i){var n,a,s,o,l,c,u;if(!i||i===this){if(n=e.yo-t.yo,a=e.yo-r.yo,l=t.y-t.yo,c=r.y-r.yo,0===(u=(s=Math.abs(n))+(o=Math.abs(a)))){e.y=e.yo+(l+c)/2;return}e.y=e.yo+(l*o+c*s)/u;return}if(n=i.distance(e,t,!0,!0),a=i.distance(e,r,!0,!0),l=i.distance(t,t,!1,!0),c=i.distance(r,r,!1,!0),0===(u=(s=Math.abs(n))+(o=Math.abs(a)))){ty.setRelative(e,e,(l+c)/2,i,!0);return}ty.setRelative(e,e,(l*o+c*s)/u,i,!0)},normalSlope:0,setRelative:function(e,t,r,i,n){if(!i||i===this){e.y=(n?t.yo:t.y)+r;return}var a=n?t.xo:t.x,s=n?t.yo:t.y,o=a+r*i.x,l=s+r*i.y;e.y=l+i.normalSlope*(e.x-o)},slope:Number.POSITIVE_INFINITY,touch:function(e){e.yTouched=!0},touched:function(e){return e.yTouched},untouch:function(e){e.yTouched=!1}};function tx(e,t){this.x=e,this.y=t,this.axis=void 0,this.slope=t/e,this.normalSlope=-e/t,Object.freeze(this)}function tT(e,t){var r=Math.sqrt(e*e+t*t);return(e/=r,t/=r,1===e&&0===t)?tv:0===e&&1===t?ty:new tx(e,t)}function tb(e,t,r,i){this.x=this.xo=Math.round(64*e)/64,this.y=this.yo=Math.round(64*t)/64,this.lastPointOfContour=r,this.onCurve=i,this.prevPointOnContour=void 0,this.nextPointOnContour=void 0,this.xTouched=!1,this.yTouched=!1,Object.preventExtensions(this)}Object.freeze(tv),Object.freeze(ty),tx.prototype.distance=function(e,t,r,i){return this.x*tv.distance(e,t,r,i)+this.y*ty.distance(e,t,r,i)},tx.prototype.interpolate=function(e,t,r,i){var n,a,s,o,l,c,u;if(s=i.distance(e,t,!0,!0),o=i.distance(e,r,!0,!0),n=i.distance(t,t,!1,!0),a=i.distance(r,r,!1,!0),0===(u=(l=Math.abs(s))+(c=Math.abs(o)))){this.setRelative(e,e,(n+a)/2,i,!0);return}this.setRelative(e,e,(n*c+a*l)/u,i,!0)},tx.prototype.setRelative=function(e,t,r,i,n){i=i||this;var a=n?t.xo:t.x,s=n?t.yo:t.y,o=a+r*i.x,l=s+r*i.y,c=i.normalSlope,u=this.slope,h=e.x,p=e.y;e.x=(u*h-c*o+l-p)/(u-c),e.y=u*(e.x-h)+p},tx.prototype.touch=function(e){e.xTouched=!0,e.yTouched=!0},tb.prototype.nextTouched=function(e){for(var t=this.nextPointOnContour;!e.touched(t)&&t!==this;)t=t.nextPointOnContour;return t},tb.prototype.prevTouched=function(e){for(var t=this.prevPointOnContour;!e.touched(t)&&t!==this;)t=t.prevPointOnContour;return t};var tS=Object.freeze(new tb(0,0)),tE={cvCutIn:17/16,deltaBase:9,deltaShift:.125,loop:1,minDis:1,autoFlip:!0};function tR(e,t){switch(this.env=e,this.stack=[],this.prog=t,e){case"glyf":this.zp0=this.zp1=this.zp2=1,this.rp0=this.rp1=this.rp2=0;case"prep":this.fv=this.pv=this.dpv=tv,this.round=th}}function tA(e){for(var t=e.tZone=Array(e.gZone.length),r=0;r<t.length;r++)t[r]=new tb(0,0)}function tw(e,t){var r,i=e.prog,n=e.ip,a=1;do if(88===(r=i[++n]))a++;else if(89===r)a--;else if(64===r)n+=i[n+1]+1;else if(65===r)n+=2*i[n+1]+1;else if(r>=176&&r<=183)n+=r-176+1;else if(r>=184&&r<=191)n+=(r-184+1)*2;else if(t&&1===a&&27===r)break;while(a>0);e.ip=n}function tM(e,t){exports.DEBUG&&console.log(t.step,"SVTCA["+e.axis+"]"),t.fv=t.pv=t.dpv=e}function tC(e,t){exports.DEBUG&&console.log(t.step,"SPVTCA["+e.axis+"]"),t.pv=t.dpv=e}function tI(e,t){exports.DEBUG&&console.log(t.step,"SFVTCA["+e.axis+"]"),t.fv=e}function tN(e,t){var r,i,n=t.stack,a=n.pop(),s=n.pop(),o=t.z2[a],l=t.z1[s];exports.DEBUG&&console.log("SPVTL["+e+"]",a,s),e?(r=o.y-l.y,i=l.x-o.x):(r=l.x-o.x,i=l.y-o.y),t.pv=t.dpv=tT(r,i)}function tO(e,t){var r,i,n=t.stack,a=n.pop(),s=n.pop(),o=t.z2[a],l=t.z1[s];exports.DEBUG&&console.log("SFVTL["+e+"]",a,s),e?(r=o.y-l.y,i=l.x-o.x):(r=l.x-o.x,i=l.y-o.y),t.fv=tT(r,i)}function tP(e){exports.DEBUG&&console.log(e.step,"POP[]"),e.stack.pop()}function tk(e,t){var r=t.stack.pop(),i=t.z0[r],n=t.fv,a=t.pv;exports.DEBUG&&console.log(t.step,"MDAP["+e+"]",r);var s=a.distance(i,tS);e&&(s=t.round(s)),n.setRelative(i,tS,s,a),n.touch(i),t.rp0=t.rp1=r}function t_(e,t){var r,i,n,a=t.z2,s=a.length-2;exports.DEBUG&&console.log(t.step,"IUP["+e.axis+"]");for(var o=0;o<s;o++)r=a[o],e.touched(r)||(i=r.prevTouched(e))===r||(i===(n=r.nextTouched(e))&&e.setRelative(r,r,e.distance(i,i,!1,!0),e,!0),e.interpolate(r,i,n,e))}function tL(e,t){for(var r=t.stack,i=e?t.rp1:t.rp2,n=(e?t.z0:t.z1)[i],a=t.fv,s=t.pv,o=t.loop,l=t.z2;o--;){var c=r.pop(),u=l[c],h=s.distance(n,n,!1,!0);a.setRelative(u,u,h,s),a.touch(u),exports.DEBUG&&console.log(t.step,(t.loop>1?"loop "+(t.loop-o)+": ":"")+"SHP["+(e?"rp1":"rp2")+"]",c)}t.loop=1}function tU(e,t){var r=t.stack,i=e?t.rp1:t.rp2,n=(e?t.z0:t.z1)[i],a=t.fv,s=t.pv,o=r.pop(),l=t.z2[t.contours[o]],c=l;exports.DEBUG&&console.log(t.step,"SHC["+e+"]",o);var u=s.distance(n,n,!1,!0);do c!==n&&a.setRelative(c,c,u,s),c=c.nextPointOnContour;while(c!==l)}function tD(e,t){var r,i,n=t.stack,a=e?t.rp1:t.rp2,s=(e?t.z0:t.z1)[a],o=t.fv,l=t.pv,c=n.pop();switch(exports.DEBUG&&console.log(t.step,"SHZ["+e+"]",c),c){case 0:r=t.tZone;break;case 1:r=t.gZone;break;default:throw Error("Invalid zone")}for(var u=l.distance(s,s,!1,!0),h=r.length-2,p=0;p<h;p++)i=r[p],o.setRelative(i,i,u,l)}function tF(e,t){var r=t.stack,i=r.pop()/64,n=r.pop(),a=t.z1[n],s=t.z0[t.rp0],o=t.fv,l=t.pv;o.setRelative(a,s,i,l),o.touch(a),exports.DEBUG&&console.log(t.step,"MSIRP["+e+"]",i,n),t.rp1=t.rp0,t.rp2=n,e&&(t.rp0=n)}function tB(e,t){var r=t.stack,i=r.pop(),n=r.pop(),a=t.z0[n],s=t.fv,o=t.pv,l=t.cvt[i];exports.DEBUG&&console.log(t.step,"MIAP["+e+"]",i,"(",l,")",n);var c=o.distance(a,tS);e&&(Math.abs(c-l)<t.cvCutIn&&(c=l),c=t.round(c)),s.setRelative(a,tS,c,o),0===t.zp0&&(a.xo=a.x,a.yo=a.y),s.touch(a),t.rp0=t.rp1=n}function tV(e,t){var r=t.stack,i=r.pop(),n=t.z2[i];exports.DEBUG&&console.log(t.step,"GC["+e+"]",i),r.push(64*t.dpv.distance(n,tS,e,!1))}function tG(e,t){var r=t.stack,i=r.pop(),n=r.pop(),a=t.z1[i],s=t.z0[n],o=t.dpv.distance(s,a,e,e);exports.DEBUG&&console.log(t.step,"MD["+e+"]",i,n,"->",o),t.stack.push(Math.round(64*o))}function tz(e,t){var r=t.stack,i=r.pop(),n=t.fv,a=t.pv,s=t.ppem,o=t.deltaBase+(e-1)*16,l=t.deltaShift,c=t.z0;exports.DEBUG&&console.log(t.step,"DELTAP["+e+"]",i,r);for(var u=0;u<i;u++){var h=r.pop(),p=r.pop();if(o+((240&p)>>4)===s){var d=(15&p)-8;d>=0&&d++,exports.DEBUG&&console.log(t.step,"DELTAPFIX",h,"by",d*l);var f=c[h];n.setRelative(f,f,d*l,a)}}}function tj(e,t){var r=t.stack,i=r.pop();exports.DEBUG&&console.log(t.step,"ROUND[]"),r.push(64*t.round(i/64))}function tH(e,t){var r=t.stack,i=r.pop(),n=t.ppem,a=t.deltaBase+(e-1)*16,s=t.deltaShift;exports.DEBUG&&console.log(t.step,"DELTAC["+e+"]",i,r);for(var o=0;o<i;o++){var l=r.pop(),c=r.pop();if(a+((240&c)>>4)===n){var u=(15&c)-8;u>=0&&u++;var h=u*s;exports.DEBUG&&console.log(t.step,"DELTACFIX",l,"by",h),t.cvt[l]+=h}}}function tW(e,t){var r,i,n=t.stack,a=n.pop(),s=n.pop(),o=t.z2[a],l=t.z1[s];exports.DEBUG&&console.log(t.step,"SDPVTL["+e+"]",a,s),e?(r=o.y-l.y,i=l.x-o.x):(r=l.x-o.x,i=l.y-o.y),t.dpv=tT(r,i)}function tK(e,t){var r=t.stack,i=t.prog,n=t.ip;exports.DEBUG&&console.log(t.step,"PUSHB["+e+"]");for(var a=0;a<e;a++)r.push(i[++n]);t.ip=n}function tX(e,t){var r=t.ip,i=t.prog,n=t.stack;exports.DEBUG&&console.log(t.ip,"PUSHW["+e+"]");for(var a=0;a<e;a++){var s=i[++r]<<8|i[++r];32768&s&&(s=-((65535^s)+1)),n.push(s)}t.ip=r}function tY(e,t,r,i,n,a){var s,o,l,c,u=a.stack,h=e&&u.pop(),p=u.pop(),d=a.rp0,f=a.z0[d],m=a.z1[p],g=a.minDis,v=a.fv,y=a.dpv;l=(o=s=y.distance(m,f,!0,!0))>=0?1:-1,o=Math.abs(o),e&&(c=a.cvt[h],i&&Math.abs(o-c)<a.cvCutIn&&(o=c)),r&&o<g&&(o=g),i&&(o=a.round(o)),v.setRelative(m,f,l*o,y),v.touch(m),exports.DEBUG&&console.log(a.step,(e?"MIRP[":"MDRP[")+(t?"M":"m")+(r?">":"_")+(i?"R":"_")+(0===n?"Gr":1===n?"Bl":2===n?"Wh":"")+"]",e?h+"("+a.cvt[h]+","+c+")":"",p,"(d =",s,"->",l*o,")"),a.rp1=a.rp0,a.rp2=p,t&&(a.rp0=p)}function tq(e){this.char=e,this.state={},this.activeState=null}function tZ(e,t,r){this.contextName=r,this.startIndex=e,this.endOffset=t}function t$(e,t,r){this.contextName=e,this.openRange=null,this.ranges=[],this.checkStart=t,this.checkEnd=r}function tQ(e,t){this.context=e,this.index=t,this.length=e.length,this.current=e[t],this.backtrack=e.slice(0,t),this.lookahead=e.slice(t+1)}function Event(e){this.eventId=e,this.subscribers=[]}function tJ(e){var t=this,r=["start","end","next","newToken","contextStart","contextEnd","insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD","updateContextsRanges"];r.forEach(function(e){Object.defineProperty(t.events,e,{value:new Event(e)})}),e&&r.forEach(function(r){var i=e[r];"function"==typeof i&&t.events[r].subscribe(i)}),["insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD"].forEach(function(e){t.events[e].subscribe(t.updateContextsRanges)})}function t0(e){this.tokens=[],this.registeredContexts={},this.contextCheckers=[],this.events={},this.registeredModifiers=[],tJ.call(this,e)}function t1(e){return/[\u0600-\u065F\u066A-\u06D2\u06FA-\u06FF]/.test(e)}function t2(e){return/[\u0630\u0690\u0621\u0631\u0661\u0671\u0622\u0632\u0672\u0692\u06C2\u0623\u0673\u0693\u06C3\u0624\u0694\u06C4\u0625\u0675\u0695\u06C5\u06E5\u0676\u0696\u06C6\u0627\u0677\u0697\u06C7\u0648\u0688\u0698\u06C8\u0689\u0699\u06C9\u068A\u06CA\u066B\u068B\u06CB\u068C\u068D\u06CD\u06FD\u068E\u06EE\u06FE\u062F\u068F\u06CF\u06EF]/.test(e)}function t3(e){return/[\u0600-\u0605\u060C-\u060E\u0610-\u061B\u061E\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED]/.test(e)}function t4(e){return/[A-z]/.test(e)}function t5(e){this.font=e,this.features={}}function t6(e){this.id=e.id,this.tag=e.tag,this.substitution=e.substitution}function t8(e,t){if(!e)return -1;switch(t.format){case 1:return t.glyphs.indexOf(e);case 2:for(var r=t.ranges,i=0;i<r.length;i++){var n=r[i];if(e>=n.start&&e<=n.end){var a=e-n.start;return n.index+a}}}return -1}function t9(e,t){return -1===t8(e,t.coverage)?null:e+t.deltaGlyphId}function t7(e,t){var r=t8(e,t.coverage);return -1===r?null:t.substitute[r]}function re(e,t){for(var r=[],i=0;i<e.length;i++){var n=e[i],a=t.current,s=t8(a=Array.isArray(a)?a[0]:a,n);-1!==s&&r.push(s)}return r.length!==e.length?-1:r}function rt(e,t){var r=t.inputCoverage.length+t.lookaheadCoverage.length+t.backtrackCoverage.length;if(e.context.length<r)return[];var i=re(t.inputCoverage,e);if(-1===i)return[];var n=t.inputCoverage.length-1;if(e.lookahead.length<t.lookaheadCoverage.length)return[];for(var a=e.lookahead.slice(n);a.length&&t3(a[0].char);)a.shift();var s=new tQ(a,0),o=re(t.lookaheadCoverage,s),l=[].concat(e.backtrack);for(l.reverse();l.length&&t3(l[0].char);)l.shift();if(l.length<t.backtrackCoverage.length)return[];var c=new tQ(l,0),u=re(t.backtrackCoverage,c),h=i.length===t.inputCoverage.length&&o.length===t.lookaheadCoverage.length&&u.length===t.backtrackCoverage.length,p=[];if(h)for(var d=0;d<t.lookupRecords.length;d++)for(var f=t.lookupRecords[d].lookupListIndex,m=this.getLookupByIndex(f),g=0;g<m.subtables.length;g++){var v=m.subtables[g],y=this.getLookupMethod(m,v);if("12"===this.getSubstitutionType(m,v))for(var x=0;x<i.length;x++){var T=y(e.get(x));T&&p.push(T)}}return p}function rr(e,t){var r,i=t8(e.current,t.coverage);if(-1===i)return null;for(var n=t.ligatureSets[i],a=0;a<n.length;a++){r=n[a];for(var s=0;s<r.components.length&&e.lookahead[s]===r.components[s];s++)if(s===r.components.length-1)return r}return null}function ri(e,t){var r=t8(e,t.coverage);return -1===r?null:t.sequences[r]}tc.prototype.exec=function(e,t){if("number"!=typeof t)throw Error("Point size is not a number!");if(!(this._errorState>2)){var r=this.font,i=this._prepState;if(!i||i.ppem!==t){var s=this._fpgmState;if(!s){tR.prototype=tE,(s=this._fpgmState=new tR("fpgm",r.tables.fpgm)).funcs=[],s.font=r,exports.DEBUG&&(console.log("---EXEC FPGM---"),s.step=-1);try{n(s)}catch(e){console.log("Hinting error in FPGM:"+e),this._errorState=3;return}}tR.prototype=s,(i=this._prepState=new tR("prep",r.tables.prep)).ppem=t;var o=r.tables.cvt;if(o)for(var l=i.cvt=Array(o.length),c=t/r.unitsPerEm,u=0;u<o.length;u++)l[u]=o[u]*c;else i.cvt=[];exports.DEBUG&&(console.log("---EXEC PREP---"),i.step=-1);try{n(i)}catch(e){this._errorState<2&&console.log("Hinting error in PREP:"+e),this._errorState=2}}if(!(this._errorState>1))try{return a(e,i)}catch(e){this._errorState<1&&(console.log("Hinting error:"+e),console.log("Note: further hinting errors are silenced")),this._errorState=1;return}}},a=function(e,t){var r,i,a,o=t.ppem/t.font.unitsPerEm,l=e.components;if(tR.prototype=t,l){var c=t.font;i=[],r=[];for(var u=0;u<l.length;u++){var h=l[u],p=c.glyphs.get(h.glyphIndex);a=new tR("glyf",p.instructions),exports.DEBUG&&(console.log("---EXEC COMP "+u+"---"),a.step=-1),s(p,a,o,o);for(var d=Math.round(h.dx*o),f=Math.round(h.dy*o),m=a.gZone,g=a.contours,v=0;v<m.length;v++){var y=m[v];y.xTouched=y.yTouched=!1,y.xo=y.x=y.x+d,y.yo=y.y=y.y+f}var x=i.length;i.push.apply(i,m);for(var T=0;T<g.length;T++)r.push(g[T]+x)}e.instructions&&!a.inhibitGridFit&&((a=new tR("glyf",e.instructions)).gZone=a.z0=a.z1=a.z2=i,a.contours=r,i.push(new tb(0,0),new tb(Math.round(e.advanceWidth*o),0)),exports.DEBUG&&(console.log("---EXEC COMPOSITE---"),a.step=-1),n(a),i.length-=2)}else a=new tR("glyf",e.instructions),exports.DEBUG&&(console.log("---EXEC GLYPH---"),a.step=-1),s(e,a,o,o),i=a.gZone;return i},s=function(e,t,r,i){for(var a,s,o,l=e.points||[],c=l.length,u=t.gZone=t.z0=t.z1=t.z2=[],h=t.contours=[],p=0;p<c;p++)a=l[p],u[p]=new tb(a.x*r,a.y*i,a.lastPointOfContour,a.onCurve);for(var d=0;d<c;d++)a=u[d],s||(s=a,h.push(d)),a.lastPointOfContour?(a.nextPointOnContour=s,s.prevPointOnContour=a,s=void 0):(o=u[d+1],a.nextPointOnContour=o,o.prevPointOnContour=a);if(!t.inhibitGridFit){if(exports.DEBUG){console.log("PROCESSING GLYPH",t.stack);for(var f=0;f<c;f++)console.log(f,u[f].x,u[f].y)}if(u.push(new tb(0,0),new tb(Math.round(e.advanceWidth*r),0)),n(t),u.length-=2,exports.DEBUG){console.log("FINISHED GLYPH",t.stack);for(var m=0;m<c;m++)console.log(m,u[m].x,u[m].y)}}},n=function(e){var t,r=e.prog;if(r){var n=r.length;for(e.ip=0;e.ip<n;e.ip++){if(exports.DEBUG&&e.step++,!(t=i[r[e.ip]]))throw Error("unknown instruction: 0x"+Number(r[e.ip]).toString(16));t(e)}}},i=[tM.bind(void 0,ty),tM.bind(void 0,tv),tC.bind(void 0,ty),tC.bind(void 0,tv),tI.bind(void 0,ty),tI.bind(void 0,tv),tN.bind(void 0,0),tN.bind(void 0,1),tO.bind(void 0,0),tO.bind(void 0,1),function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"SPVFS[]",r,i),e.pv=e.dpv=tT(i,r)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"SPVFS[]",r,i),e.fv=tT(i,r)},function(e){var t=e.stack,r=e.pv;exports.DEBUG&&console.log(e.step,"GPV[]"),t.push(16384*r.x),t.push(16384*r.y)},function(e){var t=e.stack,r=e.fv;exports.DEBUG&&console.log(e.step,"GFV[]"),t.push(16384*r.x),t.push(16384*r.y)},function(e){e.fv=e.pv,exports.DEBUG&&console.log(e.step,"SFVTPV[]")},function(e){var t=e.stack,r=t.pop(),i=t.pop(),n=t.pop(),a=t.pop(),s=t.pop(),o=e.z0,l=e.z1,c=o[r],u=o[i],h=l[n],p=l[a],d=e.z2[s];exports.DEBUG&&console.log("ISECT[], ",r,i,n,a,s);var f=c.x,m=c.y,g=u.x,v=u.y,y=h.x,x=h.y,T=p.x,b=p.y,S=(f-g)*(x-b)-(m-v)*(y-T),E=f*v-m*g,R=y*b-x*T;d.x=(E*(y-T)-R*(f-g))/S,d.y=(E*(x-b)-R*(m-v))/S},function(e){e.rp0=e.stack.pop(),exports.DEBUG&&console.log(e.step,"SRP0[]",e.rp0)},function(e){e.rp1=e.stack.pop(),exports.DEBUG&&console.log(e.step,"SRP1[]",e.rp1)},function(e){e.rp2=e.stack.pop(),exports.DEBUG&&console.log(e.step,"SRP2[]",e.rp2)},function(e){var t=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SZP0[]",t),e.zp0=t,t){case 0:e.tZone||tA(e),e.z0=e.tZone;break;case 1:e.z0=e.gZone;break;default:throw Error("Invalid zone pointer")}},function(e){var t=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SZP1[]",t),e.zp1=t,t){case 0:e.tZone||tA(e),e.z1=e.tZone;break;case 1:e.z1=e.gZone;break;default:throw Error("Invalid zone pointer")}},function(e){var t=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SZP2[]",t),e.zp2=t,t){case 0:e.tZone||tA(e),e.z2=e.tZone;break;case 1:e.z2=e.gZone;break;default:throw Error("Invalid zone pointer")}},function(e){var t=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SZPS[]",t),e.zp0=e.zp1=e.zp2=t,t){case 0:e.tZone||tA(e),e.z0=e.z1=e.z2=e.tZone;break;case 1:e.z0=e.z1=e.z2=e.gZone;break;default:throw Error("Invalid zone pointer")}},function(e){e.loop=e.stack.pop(),exports.DEBUG&&console.log(e.step,"SLOOP[]",e.loop)},function(e){exports.DEBUG&&console.log(e.step,"RTG[]"),e.round=th},function(e){exports.DEBUG&&console.log(e.step,"RTHG[]"),e.round=td},function(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SMD[]",t),e.minDis=t/64},function(e){exports.DEBUG&&console.log(e.step,"ELSE[]"),tw(e,!1)},function(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"JMPR[]",t),e.ip+=t-1},function(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SCVTCI[]",t),e.cvCutIn=t/64},void 0,void 0,function(e){var t=e.stack;exports.DEBUG&&console.log(e.step,"DUP[]"),t.push(t[t.length-1])},tP,function(e){exports.DEBUG&&console.log(e.step,"CLEAR[]"),e.stack.length=0},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"SWAP[]"),t.push(r),t.push(i)},function(e){var t=e.stack;exports.DEBUG&&console.log(e.step,"DEPTH[]"),t.push(t.length)},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"CINDEX[]",r),t.push(t[t.length-r])},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"MINDEX[]",r),t.push(t.splice(t.length-r,1)[0])},void 0,void 0,void 0,function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"LOOPCALL[]",r,i);var a=e.ip,s=e.prog;e.prog=e.funcs[r];for(var o=0;o<i;o++)n(e),exports.DEBUG&&console.log(++e.step,o+1<i?"next loopcall":"done loopcall",o);e.ip=a,e.prog=s},function(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"CALL[]",t);var r=e.ip,i=e.prog;e.prog=e.funcs[t],n(e),e.ip=r,e.prog=i,exports.DEBUG&&console.log(++e.step,"returning from",t)},function(e){if("fpgm"!==e.env)throw Error("FDEF not allowed here");var t=e.stack,r=e.prog,i=e.ip,n=t.pop(),a=i;for(exports.DEBUG&&console.log(e.step,"FDEF[]",n);45!==r[++i];);e.ip=i,e.funcs[n]=r.slice(a+1,i)},void 0,tk.bind(void 0,0),tk.bind(void 0,1),t_.bind(void 0,ty),t_.bind(void 0,tv),tL.bind(void 0,0),tL.bind(void 0,1),tU.bind(void 0,0),tU.bind(void 0,1),tD.bind(void 0,0),tD.bind(void 0,1),function(e){for(var t=e.stack,r=e.loop,i=e.fv,n=t.pop()/64,a=e.z2;r--;){var s=t.pop(),o=a[s];exports.DEBUG&&console.log(e.step,(e.loop>1?"loop "+(e.loop-r)+": ":"")+"SHPIX[]",s,n),i.setRelative(o,o,n),i.touch(o)}e.loop=1},function(e){for(var t=e.stack,r=e.rp1,i=e.rp2,n=e.loop,a=e.z0[r],s=e.z1[i],o=e.fv,l=e.dpv,c=e.z2;n--;){var u=t.pop(),h=c[u];exports.DEBUG&&console.log(e.step,(e.loop>1?"loop "+(e.loop-n)+": ":"")+"IP[]",u,r,"<->",i),o.interpolate(h,a,s,l),o.touch(h)}e.loop=1},tF.bind(void 0,0),tF.bind(void 0,1),function(e){for(var t=e.stack,r=e.rp0,i=e.z0[r],n=e.loop,a=e.fv,s=e.pv,o=e.z1;n--;){var l=t.pop(),c=o[l];exports.DEBUG&&console.log(e.step,(e.loop>1?"loop "+(e.loop-n)+": ":"")+"ALIGNRP[]",l),a.setRelative(c,i,0,s),a.touch(c)}e.loop=1},function(e){exports.DEBUG&&console.log(e.step,"RTDG[]"),e.round=tp},tB.bind(void 0,0),tB.bind(void 0,1),function(e){var t=e.prog,r=e.ip,i=e.stack,n=t[++r];exports.DEBUG&&console.log(e.step,"NPUSHB[]",n);for(var a=0;a<n;a++)i.push(t[++r]);e.ip=r},function(e){var t=e.ip,r=e.prog,i=e.stack,n=r[++t];exports.DEBUG&&console.log(e.step,"NPUSHW[]",n);for(var a=0;a<n;a++){var s=r[++t]<<8|r[++t];32768&s&&(s=-((65535^s)+1)),i.push(s)}e.ip=t},function(e){var t=e.stack,r=e.store;r||(r=e.store=[]);var i=t.pop(),n=t.pop();exports.DEBUG&&console.log(e.step,"WS",i,n),r[n]=i},function(e){var t=e.stack,r=e.store,i=t.pop();exports.DEBUG&&console.log(e.step,"RS",i);var n=r&&r[i]||0;t.push(n)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"WCVTP",r,i),e.cvt[i]=r/64},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"RCVT",r),t.push(64*e.cvt[r])},tV.bind(void 0,0),tV.bind(void 0,1),void 0,tG.bind(void 0,0),tG.bind(void 0,1),function(e){exports.DEBUG&&console.log(e.step,"MPPEM[]"),e.stack.push(e.ppem)},void 0,function(e){exports.DEBUG&&console.log(e.step,"FLIPON[]"),e.autoFlip=!0},void 0,void 0,function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"LT[]",r,i),t.push(i<r?1:0)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"LTEQ[]",r,i),t.push(i<=r?1:0)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"GT[]",r,i),t.push(i>r?1:0)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"GTEQ[]",r,i),t.push(i>=r?1:0)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"EQ[]",r,i),t.push(r===i?1:0)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"NEQ[]",r,i),t.push(r!==i?1:0)},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"ODD[]",r),t.push(Math.trunc(r)%2?1:0)},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"EVEN[]",r),t.push(Math.trunc(r)%2?0:1)},function(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"IF[]",t),!t&&(tw(e,!0),exports.DEBUG&&console.log(e.step,"EIF[]"))},function(e){exports.DEBUG&&console.log(e.step,"EIF[]")},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"AND[]",r,i),t.push(r&&i?1:0)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"OR[]",r,i),t.push(r||i?1:0)},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"NOT[]",r),t.push(r?0:1)},tz.bind(void 0,1),function(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SDB[]",t),e.deltaBase=t},function(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SDS[]",t),e.deltaShift=Math.pow(.5,t)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"ADD[]",r,i),t.push(i+r)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"SUB[]",r,i),t.push(i-r)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"DIV[]",r,i),t.push(64*i/r)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"MUL[]",r,i),t.push(i*r/64)},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"ABS[]",r),t.push(Math.abs(r))},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"NEG[]",r),t.push(-r)},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"FLOOR[]",r),t.push(64*Math.floor(r/64))},function(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"CEILING[]",r),t.push(64*Math.ceil(r/64))},tj.bind(void 0,0),tj.bind(void 0,1),tj.bind(void 0,2),tj.bind(void 0,3),void 0,void 0,void 0,void 0,function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"WCVTF[]",r,i),e.cvt[i]=r*e.ppem/e.font.unitsPerEm},tz.bind(void 0,2),tz.bind(void 0,3),tH.bind(void 0,1),tH.bind(void 0,2),tH.bind(void 0,3),function(e){var t,r=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SROUND[]",r),e.round=tg,192&r){case 0:t=.5;break;case 64:t=1;break;case 128:t=2;break;default:throw Error("invalid SROUND value")}switch(e.srPeriod=t,48&r){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*t;break;case 32:e.srPhase=.5*t;break;case 48:e.srPhase=.75*t;break;default:throw Error("invalid SROUND value")}0==(r&=15)?e.srThreshold=0:e.srThreshold=(r/8-.5)*t},function(e){var t,r=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"S45ROUND[]",r),e.round=tg,192&r){case 0:t=Math.sqrt(2)/2;break;case 64:t=Math.sqrt(2);break;case 128:t=2*Math.sqrt(2);break;default:throw Error("invalid S45ROUND value")}switch(e.srPeriod=t,48&r){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*t;break;case 32:e.srPhase=.5*t;break;case 48:e.srPhase=.75*t;break;default:throw Error("invalid S45ROUND value")}0==(r&=15)?e.srThreshold=0:e.srThreshold=(r/8-.5)*t},void 0,void 0,function(e){exports.DEBUG&&console.log(e.step,"ROFF[]"),e.round=tu},void 0,function(e){exports.DEBUG&&console.log(e.step,"RUTG[]"),e.round=tf},function(e){exports.DEBUG&&console.log(e.step,"RDTG[]"),e.round=tm},tP,tP,void 0,void 0,void 0,void 0,void 0,function(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SCANCTRL[]",t)},tW.bind(void 0,0),tW.bind(void 0,1),function(e){var t=e.stack,r=t.pop(),i=0;exports.DEBUG&&console.log(e.step,"GETINFO[]",r),1&r&&(i=35),32&r&&(i|=4096),t.push(i)},void 0,function(e){var t=e.stack,r=t.pop(),i=t.pop(),n=t.pop();exports.DEBUG&&console.log(e.step,"ROLL[]"),t.push(i),t.push(r),t.push(n)},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"MAX[]",r,i),t.push(Math.max(i,r))},function(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"MIN[]",r,i),t.push(Math.min(i,r))},function(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SCANTYPE[]",t)},function(e){var t=e.stack.pop(),r=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"INSTCTRL[]",t,r),t){case 1:e.inhibitGridFit=!!r;return;case 2:e.ignoreCvt=!!r;return;default:throw Error("invalid INSTCTRL[] selector")}},void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,tK.bind(void 0,1),tK.bind(void 0,2),tK.bind(void 0,3),tK.bind(void 0,4),tK.bind(void 0,5),tK.bind(void 0,6),tK.bind(void 0,7),tK.bind(void 0,8),tX.bind(void 0,1),tX.bind(void 0,2),tX.bind(void 0,3),tX.bind(void 0,4),tX.bind(void 0,5),tX.bind(void 0,6),tX.bind(void 0,7),tX.bind(void 0,8),tY.bind(void 0,0,0,0,0,0),tY.bind(void 0,0,0,0,0,1),tY.bind(void 0,0,0,0,0,2),tY.bind(void 0,0,0,0,0,3),tY.bind(void 0,0,0,0,1,0),tY.bind(void 0,0,0,0,1,1),tY.bind(void 0,0,0,0,1,2),tY.bind(void 0,0,0,0,1,3),tY.bind(void 0,0,0,1,0,0),tY.bind(void 0,0,0,1,0,1),tY.bind(void 0,0,0,1,0,2),tY.bind(void 0,0,0,1,0,3),tY.bind(void 0,0,0,1,1,0),tY.bind(void 0,0,0,1,1,1),tY.bind(void 0,0,0,1,1,2),tY.bind(void 0,0,0,1,1,3),tY.bind(void 0,0,1,0,0,0),tY.bind(void 0,0,1,0,0,1),tY.bind(void 0,0,1,0,0,2),tY.bind(void 0,0,1,0,0,3),tY.bind(void 0,0,1,0,1,0),tY.bind(void 0,0,1,0,1,1),tY.bind(void 0,0,1,0,1,2),tY.bind(void 0,0,1,0,1,3),tY.bind(void 0,0,1,1,0,0),tY.bind(void 0,0,1,1,0,1),tY.bind(void 0,0,1,1,0,2),tY.bind(void 0,0,1,1,0,3),tY.bind(void 0,0,1,1,1,0),tY.bind(void 0,0,1,1,1,1),tY.bind(void 0,0,1,1,1,2),tY.bind(void 0,0,1,1,1,3),tY.bind(void 0,1,0,0,0,0),tY.bind(void 0,1,0,0,0,1),tY.bind(void 0,1,0,0,0,2),tY.bind(void 0,1,0,0,0,3),tY.bind(void 0,1,0,0,1,0),tY.bind(void 0,1,0,0,1,1),tY.bind(void 0,1,0,0,1,2),tY.bind(void 0,1,0,0,1,3),tY.bind(void 0,1,0,1,0,0),tY.bind(void 0,1,0,1,0,1),tY.bind(void 0,1,0,1,0,2),tY.bind(void 0,1,0,1,0,3),tY.bind(void 0,1,0,1,1,0),tY.bind(void 0,1,0,1,1,1),tY.bind(void 0,1,0,1,1,2),tY.bind(void 0,1,0,1,1,3),tY.bind(void 0,1,1,0,0,0),tY.bind(void 0,1,1,0,0,1),tY.bind(void 0,1,1,0,0,2),tY.bind(void 0,1,1,0,0,3),tY.bind(void 0,1,1,0,1,0),tY.bind(void 0,1,1,0,1,1),tY.bind(void 0,1,1,0,1,2),tY.bind(void 0,1,1,0,1,3),tY.bind(void 0,1,1,1,0,0),tY.bind(void 0,1,1,1,0,1),tY.bind(void 0,1,1,1,0,2),tY.bind(void 0,1,1,1,0,3),tY.bind(void 0,1,1,1,1,0),tY.bind(void 0,1,1,1,1,1),tY.bind(void 0,1,1,1,1,2),tY.bind(void 0,1,1,1,1,3)],tq.prototype.setState=function(e,t){return this.state[e]=t,this.activeState={key:e,value:this.state[e]},this.activeState},tq.prototype.getState=function(e){return this.state[e]||null},t0.prototype.inboundIndex=function(e){return e>=0&&e<this.tokens.length},t0.prototype.composeRUD=function(e){var t=this,r=e.map(function(e){return t[e[0]].apply(t,e.slice(1).concat(!0))}),i=function(e){return"object"==typeof e&&e.hasOwnProperty("FAIL")};if(r.every(i))return{FAIL:"composeRUD: one or more operations hasn't completed successfully",report:r.filter(i)};this.dispatch("composeRUD",[r.filter(function(e){return!i(e)})])},t0.prototype.replaceRange=function(e,t,r,i){t=null!==t?t:this.tokens.length;var n=r.every(function(e){return e instanceof tq});if(!(!isNaN(e)&&this.inboundIndex(e))||!n)return{FAIL:"replaceRange: invalid tokens or startIndex."};var a=this.tokens.splice.apply(this.tokens,[e,t].concat(r));return i||this.dispatch("replaceToken",[e,t,r]),[a,r]},t0.prototype.replaceToken=function(e,t,r){if(!(!isNaN(e)&&this.inboundIndex(e))||!(t instanceof tq))return{FAIL:"replaceToken: invalid token or index."};var i=this.tokens.splice(e,1,t);return r||this.dispatch("replaceToken",[e,t]),[i[0],t]},t0.prototype.removeRange=function(e,t,r){t=isNaN(t)?this.tokens.length:t;var i=this.tokens.splice(e,t);return r||this.dispatch("removeRange",[i,e,t]),i},t0.prototype.removeToken=function(e,t){if(!(!isNaN(e)&&this.inboundIndex(e)))return{FAIL:"removeToken: invalid token index."};var r=this.tokens.splice(e,1);return t||this.dispatch("removeToken",[r,e]),r},t0.prototype.insertToken=function(e,t,r){return e.every(function(e){return e instanceof tq})?(this.tokens.splice.apply(this.tokens,[t,0].concat(e)),r||this.dispatch("insertToken",[e,t]),e):{FAIL:"insertToken: invalid token(s)."}},t0.prototype.registerModifier=function(e,t,r){this.events.newToken.subscribe(function(i,n){if(null===t||!0===t.apply(this,[i,n])){var a=r.apply(this,[i,n]);i.setState(e,a)}}),this.registeredModifiers.push(e)},Event.prototype.subscribe=function(e){return"function"==typeof e?this.subscribers.push(e)-1:{FAIL:"invalid '"+this.eventId+"' event handler"}},Event.prototype.unsubscribe=function(e){this.subscribers.splice(e,1)},tQ.prototype.setCurrentIndex=function(e){this.index=e,this.current=this.context[e],this.backtrack=this.context.slice(0,e),this.lookahead=this.context.slice(e+1)},tQ.prototype.get=function(e){switch(!0){case 0===e:return this.current;case e<0&&Math.abs(e)<=this.backtrack.length:return this.backtrack.slice(e)[0];case e>0&&e<=this.lookahead.length:return this.lookahead[e-1];default:return null}},t0.prototype.rangeToText=function(e){if(e instanceof tZ)return this.getRangeTokens(e).map(function(e){return e.char}).join("")},t0.prototype.getText=function(){return this.tokens.map(function(e){return e.char}).join("")},t0.prototype.getContext=function(e){return this.registeredContexts[e]||null},t0.prototype.on=function(e,t){var r=this.events[e];return r?r.subscribe(t):null},t0.prototype.dispatch=function(e,t){var r=this,i=this.events[e];i instanceof Event&&i.subscribers.forEach(function(e){e.apply(r,t||[])})},t0.prototype.registerContextChecker=function(e,t,r){if(this.getContext(e))return{FAIL:"context name '"+e+"' is already registered."};if("function"!=typeof t)return{FAIL:"missing context start check."};if("function"!=typeof r)return{FAIL:"missing context end check."};var i=new t$(e,t,r);return this.registeredContexts[e]=i,this.contextCheckers.push(i),i},t0.prototype.getRangeTokens=function(e){var t=e.startIndex+e.endOffset;return[].concat(this.tokens.slice(e.startIndex,t))},t0.prototype.getContextRanges=function(e){var t=this.getContext(e);return t?t.ranges:{FAIL:"context checker '"+e+"' is not registered."}},t0.prototype.resetContextsRanges=function(){var e=this.registeredContexts;for(var t in e)e.hasOwnProperty(t)&&(e[t].ranges=[])},t0.prototype.updateContextsRanges=function(){this.resetContextsRanges();for(var e=this.tokens.map(function(e){return e.char}),t=0;t<e.length;t++){var r=new tQ(e,t);this.runContextCheck(r)}this.dispatch("updateContextsRanges",[this.registeredContexts])},t0.prototype.setEndOffset=function(e,t){var r=new tZ(this.getContext(t).openRange.startIndex,e,t),i=this.getContext(t).ranges;return r.rangeId=t+"."+i.length,i.push(r),this.getContext(t).openRange=null,r},t0.prototype.runContextCheck=function(e){var t=this,r=e.index;this.contextCheckers.forEach(function(i){var n=i.contextName,a=t.getContext(n).openRange;if(!a&&i.checkStart(e)&&(a=new tZ(r,null,n),t.getContext(n).openRange=a,t.dispatch("contextStart",[n,r])),a&&i.checkEnd(e)){var s=r-a.startIndex+1,o=t.setEndOffset(s,n);t.dispatch("contextEnd",[n,o])}})},t0.prototype.tokenize=function(e){this.tokens=[],this.resetContextsRanges();var t=Array.from(e);this.dispatch("start");for(var r=0;r<t.length;r++){var i=t[r],n=new tQ(t,r);this.dispatch("next",[n]),this.runContextCheck(n);var a=new tq(i);this.tokens.push(a),this.dispatch("newToken",[a,n])}return this.dispatch("end",[this.tokens]),this.tokens},t5.prototype.getDefaultScriptFeaturesIndexes=function(){for(var e=this.font.tables.gsub.scripts,t=0;t<e.length;t++){var r=e[t];if("DFLT"===r.tag)return r.script.defaultLangSys.featureIndexes}return[]},t5.prototype.getScriptFeaturesIndexes=function(e){if(!this.font.tables.gsub)return[];if(!e)return this.getDefaultScriptFeaturesIndexes();for(var t=this.font.tables.gsub.scripts,r=0;r<t.length;r++){var i=t[r];if(i.tag===e&&i.script.defaultLangSys)return i.script.defaultLangSys.featureIndexes;var n=i.langSysRecords;if(n)for(var a=0;a<n.length;a++){var s=n[a];if(s.tag===e)return s.langSys.featureIndexes}}return this.getDefaultScriptFeaturesIndexes()},t5.prototype.mapTagsToFeatures=function(e,t){for(var r={},i=0;i<e.length;i++){var n=e[i].tag,a=e[i].feature;r[n]=a}this.features[t].tags=r},t5.prototype.getScriptFeatures=function(e){var t=this.features[e];if(this.features.hasOwnProperty(e))return t;var r=this.getScriptFeaturesIndexes(e);if(!r)return null;var i=this.font.tables.gsub;return t=r.map(function(e){return i.features[e]}),this.features[e]=t,this.mapTagsToFeatures(t,e),t},t5.prototype.getSubstitutionType=function(e,t){return e.lookupType.toString()+t.substFormat.toString()},t5.prototype.getLookupMethod=function(e,t){var r=this;switch(this.getSubstitutionType(e,t)){case"11":return function(e){return t9.apply(r,[e,t])};case"12":return function(e){return t7.apply(r,[e,t])};case"63":return function(e){return rt.apply(r,[e,t])};case"41":return function(e){return rr.apply(r,[e,t])};case"21":return function(e){return ri.apply(r,[e,t])};default:throw Error("lookupType: "+e.lookupType+" - substFormat: "+t.substFormat+" is not yet supported")}},t5.prototype.lookupFeature=function(e){var t=e.contextParams,r=t.index,i=this.getFeature({tag:e.tag,script:e.script});if(!i)return Error("font '"+this.font.names.fullName.en+"' doesn't support feature '"+e.tag+"' for script '"+e.script+"'.");for(var n=this.getFeatureLookups(i),a=[].concat(t.context),s=0;s<n.length;s++)for(var o=n[s],l=this.getLookupSubtables(o),c=0;c<l.length;c++){var u=l[c],h=this.getSubstitutionType(o,u),p=this.getLookupMethod(o,u),d=void 0;switch(h){case"11":(d=p(t.current))&&a.splice(r,1,new t6({id:11,tag:e.tag,substitution:d}));break;case"12":(d=p(t.current))&&a.splice(r,1,new t6({id:12,tag:e.tag,substitution:d}));break;case"63":Array.isArray(d=p(t))&&d.length&&a.splice(r,1,new t6({id:63,tag:e.tag,substitution:d}));break;case"41":(d=p(t))&&a.splice(r,1,new t6({id:41,tag:e.tag,substitution:d}));break;case"21":(d=p(t.current))&&a.splice(r,1,new t6({id:21,tag:e.tag,substitution:d}))}t=new tQ(a,r),(!Array.isArray(d)||d.length)&&(d=null)}return a.length?a:null},t5.prototype.supports=function(e){if(!e.script)return!1;this.getScriptFeatures(e.script);var t=this.features.hasOwnProperty(e.script);if(!e.tag)return t;var r=this.features[e.script].some(function(t){return t.tag===e.tag});return t&&r},t5.prototype.getLookupSubtables=function(e){return e.subtables||null},t5.prototype.getLookupByIndex=function(e){return this.font.tables.gsub.lookups[e]||null},t5.prototype.getFeatureLookups=function(e){return e.lookupListIndexes.map(this.getLookupByIndex.bind(this))},t5.prototype.getFeature=function(e){if(!this.font)return{FAIL:"No font was found"};this.features.hasOwnProperty(e.script)||this.getScriptFeatures(e.script);var t=this.features[e.script];return t?t.tags[e.tag]?this.features[e.script].tags[e.tag]:null:{FAIL:"No feature for script "+e.script}};var rn={11:function(e,t,r){t[r].setState(e.tag,e.substitution)},12:function(e,t,r){t[r].setState(e.tag,e.substitution)},63:function(e,t,r){e.substitution.forEach(function(i,n){t[r+n].setState(e.tag,i)})},41:function(e,t,r){var i=t[r];i.setState(e.tag,e.substitution.ligGlyph);for(var n=e.substitution.components.length,a=0;a<n;a++)(i=t[r+a+1]).setState("deleted",!0)}};function ra(e,t,r){e instanceof t6&&rn[e.id]&&rn[e.id](e,t,r)}function rs(e){var t=this,r="arab",i=this.featuresTags[r],n=this.tokenizer.getRangeTokens(e);if(1!==n.length){var a=new tQ(n.map(function(e){return e.getState("glyphIndex")}),0),s=new tQ(n.map(function(e){return e.char}),0);n.forEach(function(e,o){if(!t3(e.char)){a.setCurrentIndex(o),s.setCurrentIndex(o);var l,c=0;switch(function(e){for(var t=[].concat(e.backtrack),r=t.length-1;r>=0;r--){var i=t[r],n=t2(i),a=t3(i);if(!n&&!a)return!0;if(n)break}return!1}(s)&&(c|=1),function(e){if(t2(e.current))return!1;for(var t=0;t<e.lookahead.length;t++)if(!t3(e.lookahead[t]))return!0;return!1}(s)&&(c|=2),c){case 1:l="fina";break;case 2:l="init";break;case 3:l="medi"}if(-1!==i.indexOf(l)){var u=t.query.lookupFeature({tag:l,script:r,contextParams:a});if(u instanceof Error)return console.info(u.message);u.forEach(function(e,t){e instanceof t6&&(ra(e,n,t),a.context[t]=e.substitution)})}}})}}function ro(e,t){return new tQ(e.map(function(e){return e.activeState.value}),t||0)}function rl(e){var t=this,r=this.tokenizer.getRangeTokens(e),i=ro(r);i.context.forEach(function(e,n){i.setCurrentIndex(n);var a=t.query.lookupFeature({tag:"rlig",script:"arab",contextParams:i});a.length&&(a.forEach(function(e){return ra(e,r,n)}),i=ro(r))})}function rc(e,t){return new tQ(e.map(function(e){return e.activeState.value}),t||0)}function ru(e){var t=this,r=this.tokenizer.getRangeTokens(e),i=rc(r);i.context.forEach(function(e,n){i.setCurrentIndex(n);var a=t.query.lookupFeature({tag:"liga",script:"latn",contextParams:i});a.length&&(a.forEach(function(e){return ra(e,r,n)}),i=rc(r))})}function rh(e){this.baseDir=e||"ltr",this.tokenizer=new t0,this.featuresTags={}}function rp(e){var t=this.contextChecks[e+"Check"];return this.tokenizer.registerContextChecker(e,t.startCheck,t.endCheck)}function rd(){return rp.call(this,"latinWord"),rp.call(this,"arabicWord"),rp.call(this,"arabicSentence"),this.tokenizer.tokenize(this.text)}function rf(){var e=this;this.tokenizer.getContextRanges("arabicSentence").forEach(function(t){var r=e.tokenizer.getRangeTokens(t);e.tokenizer.replaceRange(t.startIndex,t.endOffset,r.reverse())})}function rm(){if(-1===this.tokenizer.registeredModifiers.indexOf("glyphIndex"))throw Error("glyphIndex modifier is required to apply arabic presentation features.")}function rg(){var e=this;this.featuresTags.hasOwnProperty("arab")&&(rm.call(this),this.tokenizer.getContextRanges("arabicWord").forEach(function(t){rs.call(e,t)}))}function rv(){var e=this,t="arab";this.featuresTags.hasOwnProperty(t)&&-1!==this.featuresTags[t].indexOf("rlig")&&(rm.call(this),this.tokenizer.getContextRanges("arabicWord").forEach(function(t){rl.call(e,t)}))}function ry(){var e=this,t="latn";this.featuresTags.hasOwnProperty(t)&&-1!==this.featuresTags[t].indexOf("liga")&&(rm.call(this),this.tokenizer.getContextRanges("latinWord").forEach(function(t){ru.call(e,t)}))}function rx(e){(e=e||{}).tables=e.tables||{},e.empty||(tr(e.familyName,"When creating a new Font object, familyName is required."),tr(e.styleName,"When creating a new Font object, styleName is required."),tr(e.unitsPerEm,"When creating a new Font object, unitsPerEm is required."),tr(e.ascender,"When creating a new Font object, ascender is required."),tr(e.descender<=0,"When creating a new Font object, negative descender value is required."),this.names={fontFamily:{en:e.familyName||" "},fontSubfamily:{en:e.styleName||" "},fullName:{en:e.fullName||e.familyName+" "+e.styleName},postScriptName:{en:e.postScriptName||(e.familyName+e.styleName).replace(/\s/g,"")},designer:{en:e.designer||" "},designerURL:{en:e.designerURL||" "},manufacturer:{en:e.manufacturer||" "},manufacturerURL:{en:e.manufacturerURL||" "},license:{en:e.license||" "},licenseURL:{en:e.licenseURL||" "},version:{en:e.version||"Version 0.1"},description:{en:e.description||" "},copyright:{en:e.copyright||" "},trademark:{en:e.trademark||" "}},this.unitsPerEm=e.unitsPerEm||1e3,this.ascender=e.ascender,this.descender=e.descender,this.createdTimestamp=e.createdTimestamp,this.tables=Object.assign(e.tables,{os2:Object.assign({usWeightClass:e.weightClass||this.usWeightClasses.MEDIUM,usWidthClass:e.widthClass||this.usWidthClasses.MEDIUM,fsSelection:e.fsSelection||this.fsSelectionValues.REGULAR},e.tables.os2)})),this.supported=!0,this.glyphs=new ef.GlyphSet(this,e.glyphs||[]),this.encoding=new es(this),this.position=new e7(this),this.substitution=new te(this),this.tables=this.tables||{},this._push=null,this._hmtxTableData={},Object.defineProperty(this,"hinting",{get:function(){return this._hinting?this._hinting:"truetype"===this.outlinesFormat?this._hinting=new tc(this):void 0}})}function rT(e,t){var r=JSON.stringify(e),i=256;for(var n in t){var a=parseInt(n);if(a&&!(a<256)){if(JSON.stringify(t[n])===r)return a;i<=a&&(i=a+1)}}return t[i]=e,i}rh.prototype.setText=function(e){this.text=e},rh.prototype.contextChecks={latinWordCheck:{startCheck:function(e){var t=e.current,r=e.get(-1);return null===r&&t4(t)||!t4(r)&&t4(t)},endCheck:function(e){var t=e.get(1);return null===t||!t4(t)}},arabicWordCheck:{startCheck:function(e){var t=e.current,r=e.get(-1);return null===r&&t1(t)||!t1(r)&&t1(t)},endCheck:function(e){var t=e.get(1);return null===t||!t1(t)}},arabicSentenceCheck:{startCheck:function(e){var t=e.current,r=e.get(-1);return(t1(t)||t3(t))&&!t1(r)},endCheck:function(e){var t=e.get(1);switch(!0){case null===t:return!0;case!t1(t)&&!t3(t):var r=/\s/.test(t);if(!r||r&&!e.lookahead.some(function(e){return t1(e)||t3(e)}))return!0;break;default:return!1}}}},rh.prototype.registerFeatures=function(e,t){var r=this,i=t.filter(function(t){return r.query.supports({script:e,tag:t})});this.featuresTags.hasOwnProperty(e)?this.featuresTags[e]=this.featuresTags[e].concat(i):this.featuresTags[e]=i},rh.prototype.applyFeatures=function(e,t){if(!e)throw Error("No valid font was provided to apply features");this.query||(this.query=new t5(e));for(var r=0;r<t.length;r++){var i=t[r];this.query.supports({script:i.script})&&this.registerFeatures(i.script,i.tags)}},rh.prototype.registerModifier=function(e,t,r){this.tokenizer.registerModifier(e,t,r)},rh.prototype.checkContextReady=function(e){return!!this.tokenizer.getContext(e)},rh.prototype.applyFeaturesToContexts=function(){this.checkContextReady("arabicWord")&&(rg.call(this),rv.call(this)),this.checkContextReady("latinWord")&&ry.call(this),this.checkContextReady("arabicSentence")&&rf.call(this)},rh.prototype.processText=function(e){this.text&&this.text===e||(this.setText(e),rd.call(this),this.applyFeaturesToContexts())},rh.prototype.getBidiText=function(e){return this.processText(e),this.tokenizer.getText()},rh.prototype.getTextGlyphs=function(e){this.processText(e);for(var t=[],r=0;r<this.tokenizer.tokens.length;r++){var i=this.tokenizer.tokens[r];if(!i.state.deleted){var n=i.activeState.value;t.push(Array.isArray(n)?n[0]:n)}}return t},rx.prototype.hasChar=function(e){return null!==this.encoding.charToGlyphIndex(e)},rx.prototype.charToGlyphIndex=function(e){return this.encoding.charToGlyphIndex(e)},rx.prototype.charToGlyph=function(e){var t=this.charToGlyphIndex(e),r=this.glyphs.get(t);return r||(r=this.glyphs.get(0)),r},rx.prototype.updateFeatures=function(e){return this.defaultRenderOptions.features.map(function(t){return"latn"===t.script?{script:"latn",tags:t.tags.filter(function(t){return e[t]})}:t})},rx.prototype.stringToGlyphs=function(e,t){var r=this,i=new rh;i.registerModifier("glyphIndex",null,function(e){return r.charToGlyphIndex(e.char)});var n=t?this.updateFeatures(t.features):this.defaultRenderOptions.features;i.applyFeatures(this,n);for(var a=i.getTextGlyphs(e),s=a.length,o=Array(s),l=this.glyphs.get(0),c=0;c<s;c+=1)o[c]=this.glyphs.get(a[c])||l;return o},rx.prototype.nameToGlyphIndex=function(e){return this.glyphNames.nameToGlyphIndex(e)},rx.prototype.nameToGlyph=function(e){var t=this.nameToGlyphIndex(e),r=this.glyphs.get(t);return r||(r=this.glyphs.get(0)),r},rx.prototype.glyphIndexToName=function(e){return this.glyphNames.glyphIndexToName?this.glyphNames.glyphIndexToName(e):""},rx.prototype.getKerningValue=function(e,t){e=e.index||e,t=t.index||t;var r=this.position.defaultKerningTables;return r?this.position.getKerningValue(r,e,t):this.kerningPairs[e+","+t]||0},rx.prototype.defaultRenderOptions={kerning:!0,features:[{script:"arab",tags:["init","medi","fina","rlig"]},{script:"latn",tags:["liga","rlig"]}]},rx.prototype.forEachGlyph=function(e,t,r,i,n,a){t=void 0!==t?t:0,r=void 0!==r?r:0,i=void 0!==i?i:72,n=Object.assign({},this.defaultRenderOptions,n);var s,o=1/this.unitsPerEm*i,l=this.stringToGlyphs(e,n);if(n.kerning){var c=n.script||this.position.getDefaultScriptName();s=this.position.getKerningTables(c,n.language)}for(var u=0;u<l.length;u+=1){var h=l[u];a.call(this,h,t,r,i,n),h.advanceWidth&&(t+=h.advanceWidth*o),n.kerning&&u<l.length-1&&(t+=(s?this.position.getKerningValue(s,h.index,l[u+1].index):this.getKerningValue(h,l[u+1]))*o),n.letterSpacing?t+=n.letterSpacing*i:n.tracking&&(t+=n.tracking/1e3*i)}return t},rx.prototype.getPath=function(e,t,r,i,n){var a=new A;return this.forEachGlyph(e,t,r,i,n,function(e,t,r,i){var s=e.getPath(t,r,i,n,this);a.extend(s)}),a},rx.prototype.getPaths=function(e,t,r,i,n){var a=[];return this.forEachGlyph(e,t,r,i,n,function(e,t,r,i){var s=e.getPath(t,r,i,n,this);a.push(s)}),a},rx.prototype.getAdvanceWidth=function(e,t,r){return this.forEachGlyph(e,0,0,t,r,function(){})},rx.prototype.draw=function(e,t,r,i,n,a){this.getPath(t,r,i,n,a).draw(e)},rx.prototype.drawPoints=function(e,t,r,i,n,a){this.forEachGlyph(t,r,i,n,a,function(t,r,i,n){t.drawPoints(e,r,i,n)})},rx.prototype.drawMetrics=function(e,t,r,i,n,a){this.forEachGlyph(t,r,i,n,a,function(t,r,i,n){t.drawMetrics(e,r,i,n)})},rx.prototype.getEnglishName=function(e){var t=this.names[e];if(t)return t.en},rx.prototype.validate=function(){var e=this;function t(t){var r=e.getEnglishName(t);r&&r.trim().length}t("fontFamily"),t("weightName"),t("manufacturer"),t("copyright"),t("version"),this.unitsPerEm},rx.prototype.toTables=function(){return e4.fontToTable(this)},rx.prototype.toBuffer=function(){return console.warn("Font.toBuffer is deprecated. Use Font.toArrayBuffer instead."),this.toArrayBuffer()},rx.prototype.toArrayBuffer=function(){for(var e=this.toTables().encode(),t=new ArrayBuffer(e.length),r=new Uint8Array(t),i=0;i<e.length;i++)r[i]=e[i];return t},rx.prototype.fsSelectionValues={ITALIC:1,UNDERSCORE:2,NEGATIVE:4,OUTLINED:8,STRIKEOUT:16,BOLD:32,REGULAR:64,USER_TYPO_METRICS:128,WWS:256,OBLIQUE:512},rx.prototype.usWidthClasses={ULTRA_CONDENSED:1,EXTRA_CONDENSED:2,CONDENSED:3,SEMI_CONDENSED:4,MEDIUM:5,SEMI_EXPANDED:6,EXPANDED:7,EXTRA_EXPANDED:8,ULTRA_EXPANDED:9},rx.prototype.usWeightClasses={THIN:100,EXTRA_LIGHT:200,LIGHT:300,NORMAL:400,MEDIUM:500,SEMI_BOLD:600,BOLD:700,EXTRA_BOLD:800,BLACK:900};var rb={make:function(e,t){var r=new K.Table("fvar",[{name:"version",type:"ULONG",value:65536},{name:"offsetToData",type:"USHORT",value:0},{name:"countSizePairs",type:"USHORT",value:2},{name:"axisCount",type:"USHORT",value:e.axes.length},{name:"axisSize",type:"USHORT",value:20},{name:"instanceCount",type:"USHORT",value:e.instances.length},{name:"instanceSize",type:"USHORT",value:4+4*e.axes.length}]);r.offsetToData=r.sizeOf();for(var i=0;i<e.axes.length;i++)r.fields=r.fields.concat(function(e,t,r){var i=rT(t.name,r);return[{name:"tag_"+e,type:"TAG",value:t.tag},{name:"minValue_"+e,type:"FIXED",value:t.minValue<<16},{name:"defaultValue_"+e,type:"FIXED",value:t.defaultValue<<16},{name:"maxValue_"+e,type:"FIXED",value:t.maxValue<<16},{name:"flags_"+e,type:"USHORT",value:0},{name:"nameID_"+e,type:"USHORT",value:i}]}(i,e.axes[i],t));for(var n=0;n<e.instances.length;n++)r.fields=r.fields.concat(function(e,t,r,i){for(var n=[{name:"nameID_"+e,type:"USHORT",value:rT(t.name,i)},{name:"flags_"+e,type:"USHORT",value:0}],a=0;a<r.length;++a){var s=r[a].tag;n.push({name:"axis_"+e+" "+s,type:"FIXED",value:t.coordinates[s]<<16})}return n}(n,e.instances[n],e.axes,t));return r},parse:function(e,t,r){var i=new ee.Parser(e,t),n=i.parseULong();C.argument(65536===n,"Unsupported fvar table version.");var a=i.parseOffset16();i.skip("uShort",1);for(var s=i.parseUShort(),o=i.parseUShort(),l=i.parseUShort(),c=i.parseUShort(),u=[],h=0;h<s;h++)u.push(function(e,t,r){var i={},n=new ee.Parser(e,t);return i.tag=n.parseTag(),i.minValue=n.parseFixed(),i.defaultValue=n.parseFixed(),i.maxValue=n.parseFixed(),n.skip("uShort",1),i.name=r[n.parseUShort()]||{},i}(e,t+a+h*o,r));for(var p=[],d=t+a+s*o,f=0;f<l;f++)p.push(function(e,t,r,i){var n={},a=new ee.Parser(e,t);n.name=i[a.parseUShort()]||{},a.skip("uShort",1),n.coordinates={};for(var s=0;s<r.length;++s)n.coordinates[r[s].tag]=a.parseFixed();return n}(e,d+f*c,u,r));return{axes:u,instances:p}}},rS=function(){return{coverage:this.parsePointer(Q.coverage),attachPoints:this.parseList(Q.pointer(Q.uShortList))}},rE=function(){var e=this.parseUShort();return(C.argument(1===e||2===e||3===e,"Unsupported CaretValue table version."),1===e)?{coordinate:this.parseShort()}:2===e?{pointindex:this.parseShort()}:3===e?{coordinate:this.parseShort()}:void 0},rR=function(){return this.parseList(Q.pointer(rE))},rA=function(){return{coverage:this.parsePointer(Q.coverage),ligGlyphs:this.parseList(Q.pointer(rR))}},rw=function(){return this.parseUShort(),this.parseList(Q.pointer(Q.coverage))},rM={parse:function(e,t){var r=new Q(e,t=t||0),i=r.parseVersion(1);C.argument(1===i||1.2===i||1.3===i,"Unsupported GDEF table version.");var n={version:i,classDef:r.parsePointer(Q.classDef),attachList:r.parsePointer(rS),ligCaretList:r.parsePointer(rA),markAttachClassDef:r.parsePointer(Q.classDef)};return i>=1.2&&(n.markGlyphSets=r.parsePointer(rw)),n}},rC=Array(10);rC[1]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();return 1===t?{posFormat:1,coverage:this.parsePointer(Q.coverage),value:this.parseValueRecord()}:2===t?{posFormat:2,coverage:this.parsePointer(Q.coverage),values:this.parseValueRecordList()}:void C.assert(!1,"0x"+e.toString(16)+": GPOS lookup type 1 format must be 1 or 2.")},rC[2]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();C.assert(1===t||2===t,"0x"+e.toString(16)+": GPOS lookup type 2 format must be 1 or 2.");var r=this.parsePointer(Q.coverage),i=this.parseUShort(),n=this.parseUShort();if(1===t)return{posFormat:t,coverage:r,valueFormat1:i,valueFormat2:n,pairSets:this.parseList(Q.pointer(Q.list(function(){return{secondGlyph:this.parseUShort(),value1:this.parseValueRecord(i),value2:this.parseValueRecord(n)}})))};if(2===t){var a=this.parsePointer(Q.classDef),s=this.parsePointer(Q.classDef),o=this.parseUShort(),l=this.parseUShort();return{posFormat:t,coverage:r,valueFormat1:i,valueFormat2:n,classDef1:a,classDef2:s,class1Count:o,class2Count:l,classRecords:this.parseList(o,Q.list(l,function(){return{value1:this.parseValueRecord(i),value2:this.parseValueRecord(n)}}))}}},rC[3]=function(){return{error:"GPOS Lookup 3 not supported"}},rC[4]=function(){return{error:"GPOS Lookup 4 not supported"}},rC[5]=function(){return{error:"GPOS Lookup 5 not supported"}},rC[6]=function(){return{error:"GPOS Lookup 6 not supported"}},rC[7]=function(){return{error:"GPOS Lookup 7 not supported"}},rC[8]=function(){return{error:"GPOS Lookup 8 not supported"}},rC[9]=function(){return{error:"GPOS Lookup 9 not supported"}};var rI=Array(10),rN={parse:function(e,t){var r=new Q(e,t=t||0),i=r.parseVersion(1);return(C.argument(1===i||1.1===i,"Unsupported GPOS table version "+i),1===i)?{version:i,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(rC)}:{version:i,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(rC),variations:r.parseFeatureVariationsList()}},make:function(e){return new K.Table("GPOS",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new K.ScriptList(e.scripts)},{name:"features",type:"TABLE",value:new K.FeatureList(e.features)},{name:"lookups",type:"TABLE",value:new K.LookupList(e.lookups,rI)}])}},rO={parse:function(e,t){var r=new ee.Parser(e,t),i=r.parseUShort();if(0===i)return function(e){var t={};e.skip("uShort");var r=e.parseUShort();C.argument(0===r,"Unsupported kern sub-table version."),e.skip("uShort",2);var i=e.parseUShort();e.skip("uShort",3);for(var n=0;n<i;n+=1){var a=e.parseUShort(),s=e.parseUShort(),o=e.parseShort();t[a+","+s]=o}return t}(r);if(1===i)return function(e){var t={};e.skip("uShort"),e.parseULong()>1&&console.warn("Only the first kern subtable is supported."),e.skip("uLong");var r=e.parseUShort();if(e.skip("uShort"),0==(255&r)){var i=e.parseUShort();e.skip("uShort",3);for(var n=0;n<i;n+=1){var a=e.parseUShort(),s=e.parseUShort(),o=e.parseShort();t[a+","+s]=o}}return t}(r);throw Error("Unsupported kern table version ("+i+").")}},rP={parse:function(e,t,r,i){for(var n=new ee.Parser(e,t),a=i?n.parseUShort:n.parseULong,s=[],o=0;o<r+1;o+=1){var l=a.call(n);i&&(l*=2),s.push(l)}return s}};function rk(e,t){for(var r=[],i=12,n=0;n<t;n+=1){var a=ee.getTag(e,i),s=ee.getULong(e,i+4),o=ee.getULong(e,i+8),l=ee.getULong(e,i+12);r.push({tag:a,checksum:s,offset:o,length:l,compression:!1}),i+=16}return r}function r_(e,t){if("WOFF"!==t.compression)return{data:e,offset:t.offset};var r=new Uint8Array(e.buffer,t.offset+2,t.compressedLength-2),i=new Uint8Array(t.length);if(S(r,i),i.byteLength!==t.length)throw Error("Decompression error: "+t.tag+" decompressed length doesn't match recorded length");return{data:new DataView(i.buffer,0),offset:0}}return{parseBuffer:function(e,t){t=null==t?{}:t;var r,i,n,a,s,o,l,c,u,h,p,d,f,m,g,v,y,x,T,b,S=new rx({empty:!0}),E=new DataView(e,0),R=[],A=ee.getTag(E,0);if(A===String.fromCharCode(0,1,0,0)||"true"===A||"typ1"===A)S.outlinesFormat="truetype",c=ee.getUShort(E,4),R=rk(E,c);else if("OTTO"===A)S.outlinesFormat="cff",c=ee.getUShort(E,4),R=rk(E,c);else if("wOFF"===A){var w=ee.getTag(E,4);if(w===String.fromCharCode(0,1,0,0))S.outlinesFormat="truetype";else if("OTTO"===w)S.outlinesFormat="cff";else throw Error("Unsupported OpenType flavor "+A);c=ee.getUShort(E,12),R=function(e,t){for(var r=[],i=44,n=0;n<t;n+=1){var a=ee.getTag(e,i),s=ee.getULong(e,i+4),o=ee.getULong(e,i+8),l=ee.getULong(e,i+12),c=void 0;c=o<l&&"WOFF",r.push({tag:a,offset:s,compression:c,compressedLength:o,length:l}),i+=20}return r}(E,c)}else throw Error("Unsupported OpenType signature "+A);for(var M=0;M<c;M+=1){var C=R[M],I=void 0;switch(C.tag){case"cmap":I=r_(E,C),S.tables.cmap=et.parse(I.data,I.offset),S.encoding=new eo(S.tables.cmap);break;case"cvt ":I=r_(E,C),b=new ee.Parser(I.data,I.offset),S.tables.cvt=b.parseShortList(C.length/2);break;case"fvar":h=C;break;case"fpgm":I=r_(E,C),b=new ee.Parser(I.data,I.offset),S.tables.fpgm=b.parseByteList(C.length);break;case"head":I=r_(E,C),S.tables.head=eI.parse(I.data,I.offset),S.unitsPerEm=S.tables.head.unitsPerEm,o=S.tables.head.indexToLocFormat;break;case"hhea":I=r_(E,C),S.tables.hhea=eN.parse(I.data,I.offset),S.ascender=S.tables.hhea.ascender,S.descender=S.tables.hhea.descender,S.numberOfHMetrics=S.tables.hhea.numberOfHMetrics;break;case"hmtx":g=C;break;case"ltag":I=r_(E,C),l=eO.parse(I.data,I.offset);break;case"maxp":I=r_(E,C),S.tables.maxp=eP.parse(I.data,I.offset),S.numGlyphs=S.tables.maxp.numGlyphs;break;case"name":x=C;break;case"OS/2":I=r_(E,C),S.tables.os2=eK.parse(I.data,I.offset);break;case"post":I=r_(E,C),S.tables.post=eX.parse(I.data,I.offset),S.glyphNames=new ec(S.tables.post);break;case"prep":I=r_(E,C),b=new ee.Parser(I.data,I.offset),S.tables.prep=b.parseByteList(C.length);break;case"glyf":p=C;break;case"loca":y=C;break;case"CFF ":u=C;break;case"kern":v=C;break;case"GDEF":d=C;break;case"GPOS":f=C;break;case"GSUB":m=C;break;case"meta":T=C}}var N=r_(E,x);if(S.tables.name=eH.parse(N.data,N.offset,l),S.names=S.tables.name,p&&y){var O=0===o,P=r_(E,y),k=rP.parse(P.data,P.offset,S.numGlyphs,O),_=r_(E,p);S.glyphs=tl.parse(_.data,_.offset,k,S,t)}else if(u){var L=r_(E,u);eC.parse(L.data,L.offset,S,t)}else throw Error("Font doesn't contain TrueType or CFF outlines.");var U=r_(E,g);if(r=U.data,i=U.offset,n=S.numberOfHMetrics,a=S.numGlyphs,s=S.glyphs,t.lowMemory?function(e,t,r,i,n){e._hmtxTableData={};for(var a,s,o=new ee.Parser(t,r),l=0;l<n;l+=1)l<i&&(a=o.parseUShort(),s=o.parseShort()),e._hmtxTableData[l]={advanceWidth:a,leftSideBearing:s}}(S,r,i,n,a):function(e,t,r,i,n){for(var a,s,o=new ee.Parser(e,t),l=0;l<i;l+=1){l<r&&(a=o.parseUShort(),s=o.parseShort());var c=n.get(l);c.advanceWidth=a,c.leftSideBearing=s}}(r,i,n,a,s),t.lowMemory?function(e){e._IndexToUnicodeMap={};for(var t=e.tables.cmap.glyphIndexMap,r=Object.keys(t),i=0;i<r.length;i+=1){var n=r[i],a=t[n];void 0===e._IndexToUnicodeMap[a]?e._IndexToUnicodeMap[a]={unicodes:[parseInt(n)]}:e._IndexToUnicodeMap[a].unicodes.push(parseInt(n))}}(S):function(e){for(var t,r=e.tables.cmap.glyphIndexMap,i=Object.keys(r),n=0;n<i.length;n+=1){var a=i[n],s=r[a];(t=e.glyphs.get(s)).addUnicode(parseInt(a))}for(var o=0;o<e.glyphs.length;o+=1)t=e.glyphs.get(o),e.cffEncoding?e.isCIDFont?t.name="gid"+o:t.name=e.cffEncoding.charset[o]:e.glyphNames.names&&(t.name=e.glyphNames.glyphIndexToName(o))}(S),v){var D=r_(E,v);S.kerningPairs=rO.parse(D.data,D.offset)}else S.kerningPairs={};if(d){var F=r_(E,d);S.tables.gdef=rM.parse(F.data,F.offset)}if(f){var B=r_(E,f);S.tables.gpos=rN.parse(B.data,B.offset),S.position.init()}if(m){var V=r_(E,m);S.tables.gsub=e$.parse(V.data,V.offset)}if(h){var G=r_(E,h);S.tables.fvar=rb.parse(G.data,G.offset,S.names)}if(T){var z=r_(E,T);S.tables.meta=eQ.parse(z.data,z.offset),S.metas=S.tables.meta}return S}}})(),rP=new WeakMap,rk=class extends f.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig=null}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerLimit=e,this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}load(e,t,r,i){let n=new f.FileLoader(this.manager);n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);let a=new f.CompressedTexture;return n.load(e,e=>{if(rP.has(e))return rP.get(e).promise.then(t).catch(i);this._createTexture([e]).then(function(e){a.copy(e),a.needsUpdate=!0,t&&t(a)}).catch(i)},r,i),a}parseInternalAsync(e){let{levels:t}=e,r=new Set;for(let e=0;e<t.length;e++)r.add(t[e].data.buffer);return this._createTexture(Array.from(r),{...e,lowLevel:!0})}_createTexture(e,t={}){let r,i;let n=0;for(let t=0;t<e.length;t++)n+=e[t].byteLength;let a=this._allocateWorker(n).then(n=>(r=n,i=this.workerNextTaskID++,new Promise((n,a)=>{r._callbacks[i]={resolve:n,reject:a},r.postMessage({type:"transcode",id:i,buffers:e,taskConfig:t},e)}))).then(e=>{let{mipmaps:t,width:r,height:i,format:n}=e,a=new f.CompressedTexture(t,r,i,n,f.UnsignedByteType);return a.minFilter=1===t.length?f.LinearFilter:f.LinearMipmapLinearFilter,a.magFilter=f.LinearFilter,a.generateMipmaps=!1,a.needsUpdate=!0,a});return a.catch(()=>!0).then(()=>{r&&i&&(r._taskLoad-=n,delete r._callbacks[i])}),rP.set(e[0],{promise:a}),a}_initTranscoder(){if(!this.transcoderPending){let e=new f.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);let t=new Promise((t,r)=>{e.load("basis_transcoder.js",t,void 0,r)}),r=new f.FileLoader(this.manager);r.setPath(this.transcoderPath),r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials);let i=new Promise((e,t)=>{r.load("basis_transcoder.wasm",e,void 0,t)});this.transcoderPending=Promise.all([t,i]).then(([e,t])=>{let r=rk.BasisWorker.toString(),i=["/* constants */","let _EngineFormat = "+JSON.stringify(rk.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(rk.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(rk.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i])),this.transcoderBinary=t})}return this.transcoderPending}_allocateWorker(e){return this._initTranscoder().then(()=>{if(this.workerPool.length<this.workerLimit){let e=new Worker(this.workerSourceURL);e._callbacks={},e._taskLoad=0,e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:this.transcoderBinary}),e.onmessage=function(t){let r=t.data;switch(r.type){case"transcode":e._callbacks[r.id].resolve(r);break;case"error":e._callbacks[r.id].reject(r);break;default:console.error('THREE.BasisTextureLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort(function(e,t){return e._taskLoad>t._taskLoad?-1:1});let t=this.workerPool[this.workerPool.length-1];return t._taskLoad+=e,t})}dispose(){for(let e=0;e<this.workerPool.length;e++)this.workerPool[e].terminate();return this.workerPool.length=0,this}};x(rk,"BasisFormat",{ETC1S:0,UASTC_4x4:1}),x(rk,"TranscoderFormat",{ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16}),x(rk,"EngineFormat",{RGBAFormat:f.RGBAFormat,RGBA_ASTC_4x4_Format:f.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:f.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:f.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:f.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:f.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:f.RGB_ETC1_Format,RGB_ETC2_Format:f.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:f.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:f.RGB_S3TC_DXT1_Format}),x(rk,"BasisWorker",function(){let e,t,r;let i=_EngineFormat,n=_TranscoderFormat,a=_BasisFormat;onmessage=function(i){let n=i.data;switch(n.type){case"init":var s;e=n.config,s=n.transcoderBinary,t=new Promise(e=>{r={wasmBinary:s,onRuntimeInitialized:e},BASIS(r)}).then(()=>{r.initializeBasis()});break;case"transcode":t.then(()=>{try{let{width:e,height:t,hasAlpha:i,mipmaps:s,format:o}=n.taskConfig.lowLevel?function(e){let{basisFormat:t,width:i,height:n,hasAlpha:s}=e,{transcoderFormat:o,engineFormat:l}=c(t,i,n,s),f=r.getBytesPerBlockOrPixel(o);u(r.isFormatSupported(o),"THREE.BasisTextureLoader: Unsupported format.");let m=[];if(t===a.ETC1S){let t=new r.LowLevelETC1SImageTranscoder,{endpointCount:i,endpointsData:n,selectorCount:a,selectorsData:l,tablesData:c}=e.globalData;try{let r;r=t.decodePalettes(i,n,a,l),u(r,"THREE.BasisTextureLoader: decodePalettes() failed."),r=t.decodeTables(c),u(r,"THREE.BasisTextureLoader: decodeTables() failed.");for(let i=0;i<e.levels.length;i++){let n=e.levels[i],a=e.globalData.imageDescs[i],l=d(o,n.width,n.height),c=new Uint8Array(l);r=t.transcodeImage(o,c,l/f,n.data,h(o,n.width),p(o,n.height),n.width,n.height,n.index,a.rgbSliceByteOffset,a.rgbSliceByteLength,a.alphaSliceByteOffset,a.alphaSliceByteLength,a.imageFlags,s,!1,0,0),u(r,"THREE.BasisTextureLoader: transcodeImage() failed for level "+n.index+"."),m.push({data:c,width:n.width,height:n.height})}}finally{t.delete()}}else for(let t=0;t<e.levels.length;t++){let i=e.levels[t],n=d(o,i.width,i.height),a=new Uint8Array(n);u(r.transcodeUASTCImage(o,a,n/f,i.data,h(o,i.width),p(o,i.height),i.width,i.height,i.index,0,i.data.byteLength,0,s,!1,0,0,-1,-1),"THREE.BasisTextureLoader: transcodeUASTCImage() failed for level "+i.index+"."),m.push({data:a,width:i.width,height:i.height})}return{width:i,height:n,hasAlpha:s,mipmaps:m,format:l}}(n.taskConfig):function(e){let t=new r.BasisFile(new Uint8Array(e)),i=t.isUASTC()?a.UASTC_4x4:a.ETC1S,n=t.getImageWidth(0,0),s=t.getImageHeight(0,0),o=t.getNumLevels(0),l=t.getHasAlpha();function u(){t.close(),t.delete()}let{transcoderFormat:h,engineFormat:p}=c(i,n,s,l);if(!n||!s||!o)throw u(),Error("THREE.BasisTextureLoader:	Invalid texture");if(!t.startTranscoding())throw u(),Error("THREE.BasisTextureLoader: .startTranscoding failed");let d=[];for(let e=0;e<o;e++){let r=t.getImageWidth(0,e),i=t.getImageHeight(0,e),n=new Uint8Array(t.getImageTranscodedSizeInBytes(0,e,h));if(!t.transcodeImage(n,0,e,h,0,l))throw u(),Error("THREE.BasisTextureLoader: .transcodeImage failed.");d.push({data:n,width:r,height:i})}return u(),{width:n,height:s,hasAlpha:l,mipmaps:d,format:p}}(n.buffers[0]),l=[];for(let e=0;e<s.length;++e)l.push(s[e].data.buffer);self.postMessage({type:"transcode",id:n.id,width:e,height:t,hasAlpha:i,mipmaps:s,format:o},l)}catch(e){console.error(e),self.postMessage({type:"error",id:n.id,error:e.message})}})}};let s=[{if:"astcSupported",basisFormat:[a.UASTC_4x4],transcoderFormat:[n.ASTC_4x4,n.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.BC7_M5,n.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.BC1,n.BC3],engineFormat:[i.RGB_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.ETC1,n.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.ETC1,n.ETC1],engineFormat:[i.RGB_ETC1_Format,i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[a.ETC1S,a.UASTC_4x4],transcoderFormat:[n.PVRTC1_4_RGB,n.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],o=s.sort(function(e,t){return e.priorityETC1S-t.priorityETC1S}),l=s.sort(function(e,t){return e.priorityUASTC-t.priorityUASTC});function c(t,r,s,c){let u;let h=t===a.ETC1S?o:l;for(let i=0;i<h.length;i++){let n=h[i];if(e[n.if]&&n.basisFormat.includes(t)&&(!n.needsPowerOfTwo||f(r)&&f(s)))return{transcoderFormat:n.transcoderFormat[c?1:0],engineFormat:n.engineFormat[c?1:0]}}return console.warn("THREE.BasisTextureLoader: No suitable compressed texture format found. Decoding to RGBA32."),{transcoderFormat:n.RGBA32,engineFormat:i.RGBAFormat}}function u(e,t){if(!e)throw Error(t)}function h(e,t){return Math.ceil(t/r.getFormatBlockWidth(e))}function p(e,t){return Math.ceil(t/r.getFormatBlockHeight(e))}function d(e,t,i){let a=r.getBytesPerBlockOrPixel(e);return r.formatIsUncompressed(e)?t*i*a:e===n.PVRTC1_4_RGB||e===n.PVRTC1_4_RGBA?(Math.max(8,t+3&-4)*Math.max(8,i+3&-4)*4+7)/8:h(e,t)*p(e,i)*a}function f(e){return e<=2||(e&e-1)==0&&0!==e}});let r_=new f.Vector3,rL=new f.Vector3;class rU extends null{constructor(e,t){super(e,t),this.isConditionalLine=!0}}class rD{constructor(e,t){this.line=e,this.lineLength=e.length,this.currentCharIndex=0,this.currentChar=" ",this.lineNumber=t}seekNonSpace(){for(;this.currentCharIndex<this.lineLength;){if(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"	"!==this.currentChar)return;this.currentCharIndex++}}getToken(){let e=this.currentCharIndex++;for(;this.currentCharIndex<this.lineLength&&(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"	"!==this.currentChar);)this.currentCharIndex++;let t=this.currentCharIndex;return this.seekNonSpace(),this.line.substring(e,t)}getVector(){return new Vector3(parseFloat(this.getToken()),parseFloat(this.getToken()),parseFloat(this.getToken()))}getRemainingString(){return this.line.substring(this.currentCharIndex,this.lineLength)}isAtTheEnd(){return this.currentCharIndex>=this.lineLength}setToEnd(){this.currentCharIndex=this.lineLength}getLineNumberString(){return this.lineNumber>=0?" at line "+this.lineNumber:""}}function rF(e,t){return e.colorCode===t.colorCode?0:e.colorCode<t.colorCode?-1:1}class rB extends null{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,r,i){let n=this,a=new FileLoader(n.manager);a.setPath(n.path),a.setRequestHeader(n.requestHeader),a.setWithCredentials(n.withCredentials),a.load(e,function(r){try{t(n.parse(r))}catch(t){i?i(t):console.error(t),n.manager.itemError(e)}},r,i)}parse(e){let t=this;function r(e,t,r,n,a,s,o,l){if(0==t||0==r){e.lineTo(l.x,l.y);return}n=n*Math.PI/180,t=Math.abs(t),r=Math.abs(r);let c=(o.x-l.x)/2,u=(o.y-l.y)/2,h=Math.cos(n)*c+Math.sin(n)*u,p=-Math.sin(n)*c+Math.cos(n)*u,d=t*t,f=r*r,m=h*h,g=p*p,v=m/d+g/f;if(v>1){let e=Math.sqrt(v);t*=e,r*=e,d=t*t,f=r*r}let y=d*g+f*m,x=Math.sqrt(Math.max(0,(d*f-y)/y));a===s&&(x=-x);let T=x*t*p/r,b=-x*r*h/t,S=Math.cos(n)*T-Math.sin(n)*b+(o.x+l.x)/2,E=Math.sin(n)*T+Math.cos(n)*b+(o.y+l.y)/2,R=i(1,0,(h-T)/t,(p-b)/r),A=i((h-T)/t,(p-b)/r,(-h-T)/t,(-p-b)/r)%(2*Math.PI);e.currentPath.absellipse(S,E,t,r,R,R+A,0===s,n)}function i(e,t,r,i){let n=Math.acos(Math.max(-1,Math.min(1,(e*r+t*i)/(Math.sqrt(e*e+t*t)*Math.sqrt(r*r+i*i)))));return e*i-t*r<0&&(n=-n),n}function n(e,t){t=Object.assign({},t);let r={};if(e.hasAttribute("class")){let t=e.getAttribute("class").split(/\s/).filter(Boolean).map(e=>e.trim());for(let e=0;e<t.length;e++)r=Object.assign(r,u["."+t[e]])}function i(i,n,a){void 0===a&&(a=function(e){return e.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),e}),e.hasAttribute(i)&&(t[n]=a(e.getAttribute(i))),r[i]&&(t[n]=a(r[i])),e.style&&""!==e.style[i]&&(t[n]=a(e.style[i]))}function n(e){return Math.max(0,Math.min(1,l(e)))}function a(e){return Math.max(0,l(e))}return e.hasAttribute("id")&&(r=Object.assign(r,u["#"+e.getAttribute("id")])),i("fill","fill"),i("fill-opacity","fillOpacity",n),i("fill-rule","fillRule"),i("opacity","opacity",n),i("stroke","stroke"),i("stroke-opacity","strokeOpacity",n),i("stroke-width","strokeWidth",a),i("stroke-linejoin","strokeLineJoin"),i("stroke-linecap","strokeLineCap"),i("stroke-miterlimit","strokeMiterLimit",a),i("visibility","visibility"),t}function a(e,t,r){let i;if("string"!=typeof e)throw TypeError("Invalid input: "+typeof e);let n={WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/},a=0,s=!0,o="",l="",c=[];function u(e,t,r){let i=SyntaxError('Unexpected character "'+e+'" at index '+t+".");throw i.partial=r,i}function h(){""!==o&&(""===l?c.push(Number(o)):c.push(Number(o)*Math.pow(10,Number(l)))),o="",l=""}let p=e.length;for(let d=0;d<p;d++){if(i=e[d],Array.isArray(t)&&t.includes(c.length%r)&&n.FLAGS.test(i)){a=1,o=i,h();continue}if(0===a){if(n.WHITESPACE.test(i))continue;if(n.DIGIT.test(i)||n.SIGN.test(i)){a=1,o=i;continue}if(n.POINT.test(i)){a=2,o=i;continue}n.COMMA.test(i)&&(s&&u(i,d,c),s=!0)}if(1===a){if(n.DIGIT.test(i)){o+=i;continue}if(n.POINT.test(i)){o+=i,a=2;continue}if(n.EXP.test(i)){a=3;continue}n.SIGN.test(i)&&1===o.length&&n.SIGN.test(o[0])&&u(i,d,c)}if(2===a){if(n.DIGIT.test(i)){o+=i;continue}if(n.EXP.test(i)){a=3;continue}n.POINT.test(i)&&"."===o[o.length-1]&&u(i,d,c)}if(3===a){if(n.DIGIT.test(i)){l+=i;continue}if(n.SIGN.test(i)){if(""===l){l+=i;continue}1===l.length&&n.SIGN.test(l)&&u(i,d,c)}}n.WHITESPACE.test(i)?(h(),a=0,s=!1):n.COMMA.test(i)?(h(),a=0,s=!0):n.SIGN.test(i)?(h(),a=1,o=i):n.POINT.test(i)?(h(),a=2,o=i):u(i,d,c)}return h(),c}let s=["mm","cm","in","pt","pc","px"],o={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function l(e){let r,i="px";if("string"==typeof e||e instanceof String)for(let t=0,r=s.length;t<r;t++){let r=s[t];if(e.endsWith(r)){i=r,e=e.substring(0,e.length-r.length);break}}return"px"===i&&"px"!==t.defaultUnit?r=o.in[t.defaultUnit]/t.defaultDPI:(r=o[i][t.defaultUnit])<0&&(r=o[i].in*t.defaultDPI),r*parseFloat(e)}let c=[],u={},h=[],p=new Matrix3,d=new Matrix3,f=new Matrix3,m=new Matrix3,g=new Vector2,v=new Vector3,y=new Matrix3,x=new DOMParser().parseFromString(e,"image/svg+xml");return!function e(t,i){if(1!==t.nodeType)return;let s=function(e){if(!(e.hasAttribute("transform")||"use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))))return null;let t=function(e){let t=new Matrix3;if("use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))){let r=l(e.getAttribute("x")),i=l(e.getAttribute("y"));t.translate(r,i)}if(e.hasAttribute("transform")){let r=e.getAttribute("transform").split(")");for(let e=r.length-1;e>=0;e--){let i=r[e].trim();if(""===i)continue;let n=i.indexOf("("),s=i.length;if(n>0&&n<s){let e=i.substr(0,n),t=a(i.substr(n+1,s-n-1));switch(p.identity(),e){case"translate":if(t.length>=1){let e=t[0],r=e;t.length>=2&&(r=t[1]),p.translate(e,r)}break;case"rotate":if(t.length>=1){let e=0,r=0,i=0;e=-t[0]*Math.PI/180,t.length>=3&&(r=t[1],i=t[2]),d.identity().translate(-r,-i),f.identity().rotate(e),m.multiplyMatrices(f,d),d.identity().translate(r,i),p.multiplyMatrices(d,m)}break;case"scale":if(t.length>=1){let e=t[0],r=e;t.length>=2&&(r=t[1]),p.scale(e,r)}break;case"skewX":1===t.length&&p.set(1,Math.tan(t[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===t.length&&p.set(1,0,0,Math.tan(t[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===t.length&&p.set(t[0],t[2],t[4],t[1],t[3],t[5],0,0,1)}}t.premultiply(p)}}return t}(e);return h.length>0&&t.premultiply(h[h.length-1]),y.copy(t),h.push(t),t}(t),o=!0,x=null;switch(t.nodeName){case"svg":break;case"style":(function(e){if(e.sheet&&e.sheet.cssRules&&e.sheet.cssRules.length)for(let t=0;t<e.sheet.cssRules.length;t++){let r=e.sheet.cssRules[t];if(1!==r.type)continue;let i=r.selectorText.split(/,/gm).filter(Boolean).map(e=>e.trim());for(let e=0;e<i.length;e++)u[i[e]]=Object.assign(u[i[e]]||{},r.style)}})(t);break;case"g":i=n(t,i);break;case"path":i=n(t,i),t.hasAttribute("d")&&(x=function(e){let t=new ShapePath,i=new Vector2,n=new Vector2,s=new Vector2,o=!0,l=!1,c=e.getAttribute("d").match(/[a-df-z][^a-df-z]*/gi);for(let e=0,y=c.length;e<y;e++){var u,h,p,d,f,m,g,v;let y;let x=c[e],T=x.charAt(0),b=x.substr(1).trim();switch(!0===o&&(l=!0,o=!1),T){case"M":y=a(b);for(let e=0,r=y.length;e<r;e+=2)i.x=y[e+0],i.y=y[e+1],n.x=i.x,n.y=i.y,0===e?t.moveTo(i.x,i.y):t.lineTo(i.x,i.y),0===e&&s.copy(i);break;case"H":y=a(b);for(let e=0,r=y.length;e<r;e++)i.x=y[e],n.x=i.x,n.y=i.y,t.lineTo(i.x,i.y),0===e&&!0===l&&s.copy(i);break;case"V":y=a(b);for(let e=0,r=y.length;e<r;e++)i.y=y[e],n.x=i.x,n.y=i.y,t.lineTo(i.x,i.y),0===e&&!0===l&&s.copy(i);break;case"L":y=a(b);for(let e=0,r=y.length;e<r;e+=2)i.x=y[e+0],i.y=y[e+1],n.x=i.x,n.y=i.y,t.lineTo(i.x,i.y),0===e&&!0===l&&s.copy(i);break;case"C":y=a(b);for(let e=0,r=y.length;e<r;e+=6)t.bezierCurveTo(y[e+0],y[e+1],y[e+2],y[e+3],y[e+4],y[e+5]),n.x=y[e+2],n.y=y[e+3],i.x=y[e+4],i.y=y[e+5],0===e&&!0===l&&s.copy(i);break;case"S":y=a(b);for(let e=0,r=y.length;e<r;e+=4)t.bezierCurveTo((u=i.x)-(n.x-u),(h=i.y)-(n.y-h),y[e+0],y[e+1],y[e+2],y[e+3]),n.x=y[e+0],n.y=y[e+1],i.x=y[e+2],i.y=y[e+3],0===e&&!0===l&&s.copy(i);break;case"Q":y=a(b);for(let e=0,r=y.length;e<r;e+=4)t.quadraticCurveTo(y[e+0],y[e+1],y[e+2],y[e+3]),n.x=y[e+0],n.y=y[e+1],i.x=y[e+2],i.y=y[e+3],0===e&&!0===l&&s.copy(i);break;case"T":y=a(b);for(let e=0,r=y.length;e<r;e+=2){let r=(p=i.x)-(n.x-p),a=(d=i.y)-(n.y-d);t.quadraticCurveTo(r,a,y[e+0],y[e+1]),n.x=r,n.y=a,i.x=y[e+0],i.y=y[e+1],0===e&&!0===l&&s.copy(i)}break;case"A":y=a(b,[3,4],7);for(let e=0,a=y.length;e<a;e+=7){if(y[e+5]==i.x&&y[e+6]==i.y)continue;let a=i.clone();i.x=y[e+5],i.y=y[e+6],n.x=i.x,n.y=i.y,r(t,y[e],y[e+1],y[e+2],y[e+3],y[e+4],a,i),0===e&&!0===l&&s.copy(i)}break;case"m":y=a(b);for(let e=0,r=y.length;e<r;e+=2)i.x+=y[e+0],i.y+=y[e+1],n.x=i.x,n.y=i.y,0===e?t.moveTo(i.x,i.y):t.lineTo(i.x,i.y),0===e&&s.copy(i);break;case"h":y=a(b);for(let e=0,r=y.length;e<r;e++)i.x+=y[e],n.x=i.x,n.y=i.y,t.lineTo(i.x,i.y),0===e&&!0===l&&s.copy(i);break;case"v":y=a(b);for(let e=0,r=y.length;e<r;e++)i.y+=y[e],n.x=i.x,n.y=i.y,t.lineTo(i.x,i.y),0===e&&!0===l&&s.copy(i);break;case"l":y=a(b);for(let e=0,r=y.length;e<r;e+=2)i.x+=y[e+0],i.y+=y[e+1],n.x=i.x,n.y=i.y,t.lineTo(i.x,i.y),0===e&&!0===l&&s.copy(i);break;case"c":y=a(b);for(let e=0,r=y.length;e<r;e+=6)t.bezierCurveTo(i.x+y[e+0],i.y+y[e+1],i.x+y[e+2],i.y+y[e+3],i.x+y[e+4],i.y+y[e+5]),n.x=i.x+y[e+2],n.y=i.y+y[e+3],i.x+=y[e+4],i.y+=y[e+5],0===e&&!0===l&&s.copy(i);break;case"s":y=a(b);for(let e=0,r=y.length;e<r;e+=4)t.bezierCurveTo((f=i.x)-(n.x-f),(m=i.y)-(n.y-m),i.x+y[e+0],i.y+y[e+1],i.x+y[e+2],i.y+y[e+3]),n.x=i.x+y[e+0],n.y=i.y+y[e+1],i.x+=y[e+2],i.y+=y[e+3],0===e&&!0===l&&s.copy(i);break;case"q":y=a(b);for(let e=0,r=y.length;e<r;e+=4)t.quadraticCurveTo(i.x+y[e+0],i.y+y[e+1],i.x+y[e+2],i.y+y[e+3]),n.x=i.x+y[e+0],n.y=i.y+y[e+1],i.x+=y[e+2],i.y+=y[e+3],0===e&&!0===l&&s.copy(i);break;case"t":y=a(b);for(let e=0,r=y.length;e<r;e+=2){let r=(g=i.x)-(n.x-g),a=(v=i.y)-(n.y-v);t.quadraticCurveTo(r,a,i.x+y[e+0],i.y+y[e+1]),n.x=r,n.y=a,i.x=i.x+y[e+0],i.y=i.y+y[e+1],0===e&&!0===l&&s.copy(i)}break;case"a":y=a(b,[3,4],7);for(let e=0,a=y.length;e<a;e+=7){if(0==y[e+5]&&0==y[e+6])continue;let a=i.clone();i.x+=y[e+5],i.y+=y[e+6],n.x=i.x,n.y=i.y,r(t,y[e],y[e+1],y[e+2],y[e+3],y[e+4],a,i),0===e&&!0===l&&s.copy(i)}break;case"Z":case"z":t.currentPath.autoClose=!0,t.currentPath.curves.length>0&&(i.copy(s),t.currentPath.currentPoint.copy(i),o=!0);break;default:console.warn(x)}l=!1}return t}(t));break;case"rect":i=n(t,i),x=function(e){let t=l(e.getAttribute("x")||0),r=l(e.getAttribute("y")||0),i=l(e.getAttribute("rx")||e.getAttribute("ry")||0),n=l(e.getAttribute("ry")||e.getAttribute("rx")||0),a=l(e.getAttribute("width")),s=l(e.getAttribute("height")),o=new ShapePath;return o.moveTo(t+i,r),o.lineTo(t+a-i,r),(0!==i||0!==n)&&o.bezierCurveTo(t+a-.448084975506*i,r,t+a,r+.448084975506*n,t+a,r+n),o.lineTo(t+a,r+s-n),(0!==i||0!==n)&&o.bezierCurveTo(t+a,r+s-.448084975506*n,t+a-.448084975506*i,r+s,t+a-i,r+s),o.lineTo(t+i,r+s),(0!==i||0!==n)&&o.bezierCurveTo(t+.448084975506*i,r+s,t,r+s-.448084975506*n,t,r+s-n),o.lineTo(t,r+n),(0!==i||0!==n)&&o.bezierCurveTo(t,r+.448084975506*n,t+.448084975506*i,r,t+i,r),o}(t);break;case"polygon":i=n(t,i),x=function(e){let t=new ShapePath,r=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,function(e,i,n){let a=l(i),s=l(n);0===r?t.moveTo(a,s):t.lineTo(a,s),r++}),t.currentPath.autoClose=!0,t}(t);break;case"polyline":i=n(t,i),x=function(e){let t=new ShapePath,r=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,function(e,i,n){let a=l(i),s=l(n);0===r?t.moveTo(a,s):t.lineTo(a,s),r++}),t.currentPath.autoClose=!1,t}(t);break;case"circle":i=n(t,i),x=function(e){let t=l(e.getAttribute("cx")||0),r=l(e.getAttribute("cy")||0),i=l(e.getAttribute("r")||0),n=new Path;n.absarc(t,r,i,0,2*Math.PI);let a=new ShapePath;return a.subPaths.push(n),a}(t);break;case"ellipse":i=n(t,i),x=function(e){let t=l(e.getAttribute("cx")||0),r=l(e.getAttribute("cy")||0),i=l(e.getAttribute("rx")||0),n=l(e.getAttribute("ry")||0),a=new Path;a.absellipse(t,r,i,n,0,2*Math.PI);let s=new ShapePath;return s.subPaths.push(a),s}(t);break;case"line":i=n(t,i),x=function(e){let t=l(e.getAttribute("x1")||0),r=l(e.getAttribute("y1")||0),i=l(e.getAttribute("x2")||0),n=l(e.getAttribute("y2")||0),a=new ShapePath;return a.moveTo(t,r),a.lineTo(i,n),a.currentPath.autoClose=!1,a}(t);break;case"defs":case"mask":o=!1;break;case"use":i=n(t,i);let T=t.href.baseVal.substring(1),b=t.viewportElement.getElementById(T);b?e(b,i):console.warn("SVGLoader: 'use node' references non-existent node id: "+T)}if(x&&(void 0!==i.fill&&"none"!==i.fill&&x.color.setStyle(i.fill),function(e,t){function r(e){v.set(e.x,e.y,1).applyMatrix3(t),e.set(v.x,v.y)}let i=0!==t.elements[1]||0!==t.elements[3],n=e.subPaths;for(let e=0,a=n.length;e<a;e++){let a=n[e].curves;for(let e=0;e<a.length;e++){let n=a[e];n.isLineCurve?(r(n.v1),r(n.v2)):n.isCubicBezierCurve?(r(n.v0),r(n.v1),r(n.v2),r(n.v3)):n.isQuadraticBezierCurve?(r(n.v0),r(n.v1),r(n.v2)):n.isEllipseCurve&&(i&&console.warn("SVGLoader: Elliptic arc or ellipse rotation or skewing is not implemented."),g.set(n.aX,n.aY),r(g),n.aX=g.x,n.aY=g.y,n.xRadius*=function(e){let t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}(t),n.yRadius*=function(e){let t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}(t))}}}(x,y),c.push(x),x.userData={node:t,style:i}),o){let r=t.childNodes;for(let t=0;t<r.length;t++)e(r[t],i)}s&&(h.pop(),h.length>0?y.copy(h[h.length-1]):y.identity())}(x.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4}),{paths:c,xml:x.documentElement}}static createShapes(e){let t={ORIGIN:0,DESTINATION:1,BETWEEN:2,LEFT:3,RIGHT:4,BEHIND:5,BEYOND:6},r={loc:t.ORIGIN,t:0};function i(e,i,n){let a=n.x-i.x,s=n.y-i.y,o=e.x-i.x,l=e.y-i.y,c=a*l-o*s;if(e.x===i.x&&e.y===i.y){r.loc=t.ORIGIN,r.t=0;return}if(e.x===n.x&&e.y===n.y){r.loc=t.DESTINATION,r.t=1;return}if(c<-Number.EPSILON){r.loc=t.LEFT;return}if(c>Number.EPSILON){r.loc=t.RIGHT;return}if(a*o<0||s*l<0){r.loc=t.BEHIND;return}if(Math.sqrt(a*a+s*s)<Math.sqrt(o*o+l*l)){r.loc=t.BEYOND;return}r.loc=t.BETWEEN,r.t=0!==a?o/a:l/s}let n=0,a=999999999,s=-999999999,o=e.subPaths.map(e=>{let t=e.getPoints(),r=-999999999,i=999999999,o=-999999999,l=999999999;for(let e=0;e<t.length;e++){let n=t[e];n.y>r&&(r=n.y),n.y<i&&(i=n.y),n.x>o&&(o=n.x),n.x<l&&(l=n.x)}return s<=o&&(s=o+1),a>=l&&(a=l-1),{curves:e.curves,points:t,isCW:ShapeUtils.isClockWise(t),identifier:n++,boundingBox:new Box2(new Vector2(l,i),new Vector2(o,r))}}),l=(o=o.filter(e=>e.points.length>1)).map(n=>(function(e,n,a,s,o){(null==o||""===o)&&(o="nonzero");let l=new Vector2;e.boundingBox.getCenter(l);let c=function(e,n,a){let s=new Vector2;n.getCenter(s);let o=[];return a.forEach(n=>{n.boundingBox.containsPoint(s)&&(function(e,n){let a=[],s=[];for(let o=1;o<e.length;o++){let l=e[o-1],c=e[o];for(let e=1;e<n.length;e++){let o=function(e,n,a,s){let o=e.x,l=n.x,c=a.x,u=s.x,h=e.y,p=n.y,d=a.y,f=s.y,m=(u-c)*(h-d)-(f-d)*(o-c),g=(f-d)*(l-o)-(u-c)*(p-h),v=m/g,y=((l-o)*(h-d)-(p-h)*(o-c))/g;if(0===g&&0!==m||v<=0||v>=1||y<0||y>1)return null;if(0===m&&0===g){for(let c=0;c<2;c++){if(i(0===c?a:s,e,n),r.loc==t.ORIGIN){let e=0===c?a:s;return{x:e.x,y:e.y,t:r.t}}if(r.loc==t.BETWEEN)return{x:+(o+r.t*(l-o)).toPrecision(10),y:+(h+r.t*(p-h)).toPrecision(10),t:r.t}}return null}for(let o=0;o<2;o++)if(i(0===o?a:s,e,n),r.loc==t.ORIGIN){let e=0===o?a:s;return{x:e.x,y:e.y,t:r.t}}return{x:+(o+v*(l-o)).toPrecision(10),y:+(h+v*(p-h)).toPrecision(10),t:v}}(l,c,n[e-1],n[e]);null!==o&&void 0===a.find(e=>e.t<=o.t+Number.EPSILON&&e.t>=o.t-Number.EPSILON)&&(a.push(o),s.push(new Vector2(o.x,o.y)))}}return s})(e,n.points).forEach(e=>{o.push({identifier:n.identifier,isCW:n.isCW,point:e})})}),o.sort((e,t)=>e.point.x-t.point.x),o}([new Vector2(a,l.y),new Vector2(s,l.y)],e.boundingBox,n);c.sort((e,t)=>e.point.x-t.point.x);let u=[],h=[];c.forEach(t=>{t.identifier===e.identifier?u.push(t):h.push(t)});let p=u[0].point.x,d=[],f=0;for(;f<h.length&&h[f].point.x<p;)d.length>0&&d[d.length-1]===h[f].identifier?d.pop():d.push(h[f].identifier),f++;if(d.push(e.identifier),"evenodd"===o){let t=d.length%2==0,r=d[d.length-2];return{identifier:e.identifier,isHole:t,for:r}}if("nonzero"===o){let t=!0,r=null,i=null;for(let e=0;e<d.length;e++){let a=d[e];t?(i=n[a].isCW,t=!1,r=a):i!==n[a].isCW&&(i=n[a].isCW,t=!0)}return{identifier:e.identifier,isHole:t,for:r}}console.warn('fill-rule: "'+o+'" is currently not implemented.')})(n,o,a,s,e.userData.style.fillRule)),c=[];return o.forEach(e=>{if(!l[e.identifier].isHole){let t=new Shape;t.curves=e.curves,l.filter(t=>t.isHole&&t.for===e.identifier).forEach(e=>{let r=o[e.identifier],i=new Path;i.curves=r.curves,t.holes.push(i)}),c.push(t)}}),c}static getStrokeStyle(e,t,r,i,n){return{strokeColor:t=void 0!==t?t:"#000",strokeWidth:e=void 0!==e?e:1,strokeLineJoin:r=void 0!==r?r:"miter",strokeLineCap:i=void 0!==i?i:"butt",strokeMiterLimit:n=void 0!==n?n:4}}static pointsToStroke(e,t,r,i){let n=[],a=[],s=[];if(0===rB.pointsToStrokeWithBuffers(e,t,r,i,n,a,s))return null;let o=new BufferGeometry;return o.setAttribute("position",new Float32BufferAttribute(n,3)),o.setAttribute("normal",new Float32BufferAttribute(a,3)),o.setAttribute("uv",new Float32BufferAttribute(s,2)),o}static pointsToStrokeWithBuffers(e,t,r,i,n,a,s,o){let l,c,u,h,p;let d=new Vector2,f=new Vector2,m=new Vector2,g=new Vector2,v=new Vector2,y=new Vector2,x=new Vector2,T=new Vector2,b=new Vector2,S=new Vector2,E=new Vector2,R=new Vector2,A=new Vector2,w=new Vector2,M=new Vector2,C=new Vector2,I=new Vector2;r=void 0!==r?r:12,i=void 0!==i?i:.001,o=void 0!==o?o:0;let N=(e=function(e){let t=!1;for(let r=1,n=e.length-1;r<n;r++)if(e[r].distanceTo(e[r+1])<i){t=!0;break}if(!t)return e;let r=[];r.push(e[0]);for(let t=1,n=e.length-1;t<n;t++)e[t].distanceTo(e[t+1])>=i&&r.push(e[t]);return r.push(e[e.length-1]),r}(e)).length;if(N<2)return 0;let O=e[0].equals(e[N-1]),P=e[0],k=t.strokeWidth/2,_=1/(N-1),L=0,U,D=!1,F=0,B=3*o,V=2*o;G(e[0],e[1],d).multiplyScalar(k),T.copy(e[0]).sub(d),b.copy(e[0]).add(d),S.copy(T),E.copy(b);for(let r=1;r<N;r++){if(l=e[r],c=r===N-1?O?e[1]:void 0:e[r+1],G(P,l,d),m.copy(d).multiplyScalar(k),R.copy(l).sub(m),A.copy(l).add(m),U=L+_,u=!1,void 0!==c){G(l,c,f),m.copy(f).multiplyScalar(k),w.copy(l).sub(m),M.copy(l).add(m),h=!0,m.subVectors(c,P),0>d.dot(m)&&(h=!1),1===r&&(D=h),m.subVectors(c,l),m.normalize();let e=Math.abs(d.dot(m));if(0!==e){let r=k/e;m.multiplyScalar(-r),g.subVectors(l,P),v.copy(g).setLength(r).add(m),C.copy(v).negate();let i=v.length(),n=g.length();g.divideScalar(n),y.subVectors(c,l);let a=y.length();switch(y.divideScalar(a),g.dot(C)<n&&y.dot(C)<a&&(u=!0),I.copy(v).add(l),C.add(l),p=!1,u?h?(M.copy(C),A.copy(C)):(w.copy(C),R.copy(C)):H(),t.strokeLineJoin){case"bevel":W(h,u,U);break;case"round":K(h,u),h?j(l,R,w,U,0):j(l,M,A,U,1);break;default:let s=k*t.strokeMiterLimit/i;s<1?"miter-clip"!==t.strokeLineJoin?W(h,u,U):(K(h,u),h?(y.subVectors(I,R).multiplyScalar(s).add(R),x.subVectors(I,w).multiplyScalar(s).add(w),z(R,U,0),z(y,U,0),z(l,U,.5),z(l,U,.5),z(y,U,0),z(x,U,0),z(l,U,.5),z(x,U,0),z(w,U,0)):(y.subVectors(I,A).multiplyScalar(s).add(A),x.subVectors(I,M).multiplyScalar(s).add(M),z(A,U,1),z(y,U,1),z(l,U,.5),z(l,U,.5),z(y,U,1),z(x,U,1),z(l,U,.5),z(x,U,1),z(M,U,1))):(u?(h?(z(b,L,1),z(T,L,0),z(I,U,0),z(b,L,1),z(I,U,0),z(C,U,1)):(z(b,L,1),z(T,L,0),z(I,U,1),z(T,L,0),z(C,U,0),z(I,U,1)),h?w.copy(I):M.copy(I)):h?(z(R,U,0),z(I,U,0),z(l,U,.5),z(l,U,.5),z(I,U,0),z(w,U,0)):(z(A,U,1),z(I,U,1),z(l,U,.5),z(l,U,.5),z(I,U,1),z(M,U,1)),p=!0)}}else H()}else H();O||r!==N-1||X(e[0],S,E,h,!0,L),L=U,P=l,T.copy(w),b.copy(M)}if(O){if(u&&n){let e=I,t=C;D!==h&&(e=C,t=I),h?(p||D)&&(t.toArray(n,0),t.toArray(n,9),p&&e.toArray(n,3)):(p||!D)&&(t.toArray(n,3),t.toArray(n,9),p&&e.toArray(n,0))}}else X(l,R,A,h,!1,U);return F;function G(e,t,r){return r.subVectors(t,e),r.set(-r.y,r.x).normalize()}function z(e,t,r){n&&(n[B]=e.x,n[B+1]=e.y,n[B+2]=0,a&&(a[B]=0,a[B+1]=0,a[B+2]=1),B+=3,s&&(s[V]=t,s[V+1]=r,V+=2)),F+=3}function j(e,t,i,n,a){d.copy(t).sub(e).normalize(),f.copy(i).sub(e).normalize();let s=Math.PI,o=d.dot(f);1>Math.abs(o)&&(s=Math.abs(Math.acos(o))),s/=r,m.copy(t);for(let t=0,i=r-1;t<i;t++)g.copy(m).rotateAround(e,s),z(m,n,a),z(g,n,a),z(e,n,.5),m.copy(g);z(g,n,a),z(i,n,a),z(e,n,.5)}function H(){z(b,L,1),z(T,L,0),z(R,U,0),z(b,L,1),z(R,U,1),z(A,U,0)}function W(e,t,r){t?(e?(z(b,L,1),z(T,L,0),z(R,U,0),z(b,L,1),z(R,U,0),z(C,U,1),z(R,r,0),z(w,r,0)):(z(b,L,1),z(T,L,0),z(A,U,1),z(T,L,0),z(C,U,0),z(A,U,1),z(A,r,1),z(M,r,0)),z(C,r,.5)):(e?(z(R,r,0),z(w,r,0)):(z(A,r,1),z(M,r,0)),z(l,r,.5))}function K(e,t){t&&(e?(z(b,L,1),z(T,L,0),z(R,U,0),z(b,L,1),z(R,U,0),z(C,U,1),z(R,L,0),z(l,U,.5),z(C,U,1),z(l,U,.5),z(w,L,0),z(C,U,1)):(z(b,L,1),z(T,L,0),z(A,U,1),z(T,L,0),z(C,U,0),z(A,U,1),z(A,L,1),z(C,U,0),z(l,U,.5),z(l,U,.5),z(C,U,0),z(M,L,1)))}function X(e,r,i,a,s,o){switch(t.strokeLineCap){case"round":s?j(e,i,r,o,.5):j(e,r,i,o,.5);break;case"square":if(s)d.subVectors(r,e),f.set(d.y,-d.x),m.addVectors(d,f).add(e),g.subVectors(f,d).add(e),a?(m.toArray(n,3),g.toArray(n,0),g.toArray(n,9)):(m.toArray(n,3),m.toArray(n,9),g.toArray(n,0));else{d.subVectors(i,e),f.set(d.y,-d.x),m.addVectors(d,f).add(e),g.subVectors(f,d).add(e);let t=n.length;a?(m.toArray(n,t-3),g.toArray(n,t-6)):(m.toArray(n,t-6),g.toArray(n,t-3)),g.toArray(n,t-12)}}}}}Float32Array,Int8Array,Int16Array,Int32Array,Uint8Array,Uint16Array,Uint32Array;let rV=new f.Matrix4,rG=new f.Object3D,rz=new f.Vector3;class rj extends null{static createBufferGeometryFromObject(e){let t=new BufferGeometry,r=e.geometry;if(e.isPoints||e.isLine){let e=new Float32BufferAttribute(3*r.vertices.length,3),i=new Float32BufferAttribute(3*r.colors.length,3);if(t.setAttribute("position",e.copyVector3sArray(r.vertices)),t.setAttribute("color",i.copyColorsArray(r.colors)),r.lineDistances&&r.lineDistances.length===r.vertices.length){let e=new Float32BufferAttribute(r.lineDistances.length,1);t.setAttribute("lineDistance",e.copyArray(r.lineDistances))}null!==r.boundingSphere&&(t.boundingSphere=r.boundingSphere.clone()),null!==r.boundingBox&&(t.boundingBox=r.boundingBox.clone())}else e.isMesh&&(t=r.toBufferGeometry());return t}constructor(){super(),this.isGeometry=!0,this.uuid=MathUtils.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}applyMatrix4(e){let t=new Matrix3().getNormalMatrix(e);for(let t=0,r=this.vertices.length;t<r;t++)this.vertices[t].applyMatrix4(e);for(let e=0,r=this.faces.length;e<r;e++){let r=this.faces[e];r.normal.applyMatrix3(t).normalize();for(let e=0,i=r.vertexNormals.length;e<i;e++)r.vertexNormals[e].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this}rotateX(e){return rV.makeRotationX(e),this.applyMatrix4(rV),this}rotateY(e){return rV.makeRotationY(e),this.applyMatrix4(rV),this}rotateZ(e){return rV.makeRotationZ(e),this.applyMatrix4(rV),this}translate(e,t,r){return rV.makeTranslation(e,t,r),this.applyMatrix4(rV),this}scale(e,t,r){return rV.makeScale(e,t,r),this.applyMatrix4(rV),this}lookAt(e){return rG.lookAt(e),rG.updateMatrix(),this.applyMatrix4(rG.matrix),this}fromBufferGeometry(e){let t=this,r=null!==e.index?e.index:void 0,i=e.attributes;if(void 0===i.position)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;let n=i.position,a=i.normal,s=i.color,o=i.uv,l=i.uv2;void 0!==l&&(this.faceVertexUvs[1]=[]);for(let e=0;e<n.count;e++)t.vertices.push(new Vector3().fromBufferAttribute(n,e)),void 0!==s&&t.colors.push(new Color().fromBufferAttribute(s,e));function c(e,r,i,n){let c=void 0===s?[]:[t.colors[e].clone(),t.colors[r].clone(),t.colors[i].clone()],u=void 0===a?[]:[new Vector3().fromBufferAttribute(a,e),new Vector3().fromBufferAttribute(a,r),new Vector3().fromBufferAttribute(a,i)],h=new rW(e,r,i,u,c,n);t.faces.push(h),void 0!==o&&t.faceVertexUvs[0].push([new Vector2().fromBufferAttribute(o,e),new Vector2().fromBufferAttribute(o,r),new Vector2().fromBufferAttribute(o,i)]),void 0!==l&&t.faceVertexUvs[1].push([new Vector2().fromBufferAttribute(l,e),new Vector2().fromBufferAttribute(l,r),new Vector2().fromBufferAttribute(l,i)])}let u=e.groups;if(u.length>0)for(let e=0;e<u.length;e++){let t=u[e],i=t.start,n=t.count;for(let e=i,a=i+n;e<a;e+=3)void 0!==r?c(r.getX(e),r.getX(e+1),r.getX(e+2),t.materialIndex):c(e,e+1,e+2,t.materialIndex)}else if(void 0!==r)for(let e=0;e<r.count;e+=3)c(r.getX(e),r.getX(e+1),r.getX(e+2));else for(let e=0;e<n.count;e+=3)c(e,e+1,e+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(rz).negate(),this.translate(rz.x,rz.y,rz.z),this}normalize(){this.computeBoundingSphere();let e=this.boundingSphere.center,t=this.boundingSphere.radius,r=0===t?1:1/t,i=new Matrix4;return i.set(r,0,0,-r*e.x,0,r,0,-r*e.y,0,0,r,-r*e.z,0,0,0,1),this.applyMatrix4(i),this}computeFaceNormals(){let e=new Vector3,t=new Vector3;for(let r=0,i=this.faces.length;r<i;r++){let i=this.faces[r],n=this.vertices[i.a],a=this.vertices[i.b],s=this.vertices[i.c];e.subVectors(s,a),t.subVectors(n,a),e.cross(t),e.normalize(),i.normal.copy(e)}}computeVertexNormals(e=!0){let t=Array(this.vertices.length);for(let e=0,r=this.vertices.length;e<r;e++)t[e]=new Vector3;if(e){let e=new Vector3,r=new Vector3;for(let i=0,n=this.faces.length;i<n;i++){let n=this.faces[i],a=this.vertices[n.a],s=this.vertices[n.b],o=this.vertices[n.c];e.subVectors(o,s),r.subVectors(a,s),e.cross(r),t[n.a].add(e),t[n.b].add(e),t[n.c].add(e)}}else{this.computeFaceNormals();for(let e=0,r=this.faces.length;e<r;e++){let r=this.faces[e];t[r.a].add(r.normal),t[r.b].add(r.normal),t[r.c].add(r.normal)}}for(let e=0,r=this.vertices.length;e<r;e++)t[e].normalize();for(let e=0,r=this.faces.length;e<r;e++){let r=this.faces[e],i=r.vertexNormals;3===i.length?(i[0].copy(t[r.a]),i[1].copy(t[r.b]),i[2].copy(t[r.c])):(i[0]=t[r.a].clone(),i[1]=t[r.b].clone(),i[2]=t[r.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeFlatVertexNormals(){this.computeFaceNormals();for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e],r=t.vertexNormals;3===r.length?(r[0].copy(t.normal),r[1].copy(t.normal),r[2].copy(t.normal)):(r[0]=t.normal.clone(),r[1]=t.normal.clone(),r[2]=t.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeMorphNormals(){for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e];t.__originalFaceNormal?t.__originalFaceNormal.copy(t.normal):t.__originalFaceNormal=t.normal.clone(),t.__originalVertexNormals||(t.__originalVertexNormals=[]);for(let e=0,r=t.vertexNormals.length;e<r;e++)t.__originalVertexNormals[e]?t.__originalVertexNormals[e].copy(t.vertexNormals[e]):t.__originalVertexNormals[e]=t.vertexNormals[e].clone()}let e=new rj;e.faces=this.faces;for(let t=0,r=this.morphTargets.length;t<r;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];let e=this.morphNormals[t].faceNormals,r=this.morphNormals[t].vertexNormals;for(let t=0,i=this.faces.length;t<i;t++){let t=new Vector3,i={a:new Vector3,b:new Vector3,c:new Vector3};e.push(t),r.push(i)}}let r=this.morphNormals[t];e.vertices=this.morphTargets[t].vertices,e.computeFaceNormals(),e.computeVertexNormals();for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e],i=r.faceNormals[e],n=r.vertexNormals[e];i.copy(t.normal),n.a.copy(t.vertexNormals[0]),n.b.copy(t.vertexNormals[1]),n.c.copy(t.vertexNormals[2])}}for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e];t.normal=t.__originalFaceNormal,t.vertexNormals=t.__originalVertexNormals}}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Box3),this.boundingBox.setFromPoints(this.vertices)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Sphere),this.boundingSphere.setFromPoints(this.vertices)}merge(e,t,r=0){let i;if(!(e&&e.isGeometry)){console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);return}let n=this.vertices.length,a=this.vertices,s=e.vertices,o=this.faces,l=e.faces,c=this.colors,u=e.colors;void 0!==t&&(i=new Matrix3().getNormalMatrix(t));for(let e=0,r=s.length;e<r;e++){let r=s[e].clone();void 0!==t&&r.applyMatrix4(t),a.push(r)}for(let e=0,t=u.length;e<t;e++)c.push(u[e].clone());for(let e=0,t=l.length;e<t;e++){let t,a;let s=l[e],c=s.vertexNormals,u=s.vertexColors,h=new rW(s.a+n,s.b+n,s.c+n);h.normal.copy(s.normal),void 0!==i&&h.normal.applyMatrix3(i).normalize();for(let e=0,r=c.length;e<r;e++)t=c[e].clone(),void 0!==i&&t.applyMatrix3(i).normalize(),h.vertexNormals.push(t);h.color.copy(s.color);for(let e=0,t=u.length;e<t;e++)a=u[e],h.vertexColors.push(a.clone());h.materialIndex=s.materialIndex+r,o.push(h)}for(let t=0,r=e.faceVertexUvs.length;t<r;t++){let r=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,i=r.length;e<i;e++){let i=r[e],n=[];for(let e=0,t=i.length;e<t;e++)n.push(i[e].clone());this.faceVertexUvs[t].push(n)}}}mergeMesh(e){if(!(e&&e.isMesh)){console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e);return}e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)}mergeVertices(e=4){let t={},r=[],i=[],n=Math.pow(10,e);for(let e=0,a=this.vertices.length;e<a;e++){let a=this.vertices[e],s=`${Math.round(a.x*n)}_${Math.round(a.y*n)}_${Math.round(a.z*n)}`;void 0===t[s]?(t[s]=e,r.push(this.vertices[e]),i[e]=r.length-1):i[e]=i[t[s]]}let a=[];for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e];t.a=i[t.a],t.b=i[t.b],t.c=i[t.c];let r=[t.a,t.b,t.c];for(let t=0;t<3;t++)if(r[t]===r[(t+1)%3]){a.push(e);break}}for(let e=a.length-1;e>=0;e--){let t=a[e];this.faces.splice(t,1);for(let e=0,r=this.faceVertexUvs.length;e<r;e++)this.faceVertexUvs[e].splice(t,1)}let s=this.vertices.length-r.length;return this.vertices=r,s}setFromPoints(e){this.vertices=[];for(let t=0,r=e.length;t<r;t++){let r=e[t];this.vertices.push(new Vector3(r.x,r.y,r.z||0))}return this}sortFacesByMaterialIndex(){let e,t;let r=this.faces,i=r.length;for(let e=0;e<i;e++)r[e]._id=e;r.sort(function(e,t){return e.materialIndex-t.materialIndex});let n=this.faceVertexUvs[0],a=this.faceVertexUvs[1];n&&n.length===i&&(e=[]),a&&a.length===i&&(t=[]);for(let s=0;s<i;s++){let i=r[s]._id;e&&e.push(n[i]),t&&t.push(a[i])}e&&(this.faceVertexUvs[0]=e),t&&(this.faceVertexUvs[1]=t)}toJSON(){let e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){let t=this.parameters;for(let r in t)void 0!==t[r]&&(e[r]=t[r]);return e}let t=[];for(let e=0;e<this.vertices.length;e++){let r=this.vertices[e];t.push(r.x,r.y,r.z)}let r=[],i=[],n={},a=[],s={},o=[],l={};for(let e=0;e<this.faces.length;e++){let t=this.faces[e],i=void 0!==this.faceVertexUvs[0][e],n=t.normal.length()>0,a=t.vertexNormals.length>0,s=1!==t.color.r||1!==t.color.g||1!==t.color.b,o=t.vertexColors.length>0,l=0;if(l=c(0,0,0),l=c(l,1,!0),l=c(l,2,!1),l=c(l,3,i),l=c(l,4,n),l=c(l,5,a),l=c(l,6,s),l=c(l,7,o),r.push(l),r.push(t.a,t.b,t.c),r.push(t.materialIndex),i){let t=this.faceVertexUvs[0][e];r.push(p(t[0]),p(t[1]),p(t[2]))}if(n&&r.push(u(t.normal)),a){let e=t.vertexNormals;r.push(u(e[0]),u(e[1]),u(e[2]))}if(s&&r.push(h(t.color)),o){let e=t.vertexColors;r.push(h(e[0]),h(e[1]),h(e[2]))}}function c(e,t,r){return r?e|1<<t:e&~(1<<t)}function u(e){let t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==n[t]||(n[t]=i.length/3,i.push(e.x,e.y,e.z)),n[t]}function h(e){let t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==s[t]||(s[t]=a.length,a.push(e.getHex())),s[t]}function p(e){let t=e.x.toString()+e.y.toString();return void 0!==l[t]||(l[t]=o.length/2,o.push(e.x,e.y)),l[t]}return e.data={},e.data.vertices=t,e.data.normals=i,a.length>0&&(e.data.colors=a),o.length>0&&(e.data.uvs=[o]),e.data.faces=r,e}clone(){return new rj().copy(this)}copy(e){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;let t=e.vertices;for(let e=0,r=t.length;e<r;e++)this.vertices.push(t[e].clone());let r=e.colors;for(let e=0,t=r.length;e<t;e++)this.colors.push(r[e].clone());let i=e.faces;for(let e=0,t=i.length;e<t;e++)this.faces.push(i[e].clone());for(let t=0,r=e.faceVertexUvs.length;t<r;t++){let r=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,i=r.length;e<i;e++){let i=r[e],n=[];for(let e=0,t=i.length;e<t;e++){let t=i[e];n.push(t.clone())}this.faceVertexUvs[t].push(n)}}let n=e.morphTargets;for(let e=0,t=n.length;e<t;e++){let t={};if(t.name=n[e].name,void 0!==n[e].vertices){t.vertices=[];for(let r=0,i=n[e].vertices.length;r<i;r++)t.vertices.push(n[e].vertices[r].clone())}if(void 0!==n[e].normals){t.normals=[];for(let r=0,i=n[e].normals.length;r<i;r++)t.normals.push(n[e].normals[r].clone())}this.morphTargets.push(t)}let a=e.morphNormals;for(let e=0,t=a.length;e<t;e++){let t={};if(void 0!==a[e].vertexNormals){t.vertexNormals=[];for(let r=0,i=a[e].vertexNormals.length;r<i;r++){let i=a[e].vertexNormals[r],n={};n.a=i.a.clone(),n.b=i.b.clone(),n.c=i.c.clone(),t.vertexNormals.push(n)}}if(void 0!==a[e].faceNormals){t.faceNormals=[];for(let r=0,i=a[e].faceNormals.length;r<i;r++)t.faceNormals.push(a[e].faceNormals[r].clone())}this.morphNormals.push(t)}let s=e.skinWeights;for(let e=0,t=s.length;e<t;e++)this.skinWeights.push(s[e].clone());let o=e.skinIndices;for(let e=0,t=o.length;e<t;e++)this.skinIndices.push(o[e].clone());let l=e.lineDistances;for(let e=0,t=l.length;e<t;e++)this.lineDistances.push(l[e]);let c=e.boundingBox;null!==c&&(this.boundingBox=c.clone());let u=e.boundingSphere;return null!==u&&(this.boundingSphere=u.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}toBufferGeometry(){let e=new rH().fromGeometry(this),t=new BufferGeometry,r=new Float32Array(3*e.vertices.length);if(t.setAttribute("position",new BufferAttribute(r,3).copyVector3sArray(e.vertices)),e.normals.length>0){let r=new Float32Array(3*e.normals.length);t.setAttribute("normal",new BufferAttribute(r,3).copyVector3sArray(e.normals))}if(e.colors.length>0){let r=new Float32Array(3*e.colors.length);t.setAttribute("color",new BufferAttribute(r,3).copyColorsArray(e.colors))}if(e.uvs.length>0){let r=new Float32Array(2*e.uvs.length);t.setAttribute("uv",new BufferAttribute(r,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){let r=new Float32Array(2*e.uvs2.length);t.setAttribute("uv2",new BufferAttribute(r,2).copyVector2sArray(e.uvs2))}for(let r in t.groups=e.groups,e.morphTargets){let i=[],n=e.morphTargets[r];for(let e=0,t=n.length;e<t;e++){let t=n[e],r=new Float32BufferAttribute(3*t.data.length,3);r.name=t.name,i.push(r.copyVector3sArray(t.data))}t.morphAttributes[r]=i}if(e.skinIndices.length>0){let r=new Float32BufferAttribute(4*e.skinIndices.length,4);t.setAttribute("skinIndex",r.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){let r=new Float32BufferAttribute(4*e.skinWeights.length,4);t.setAttribute("skinWeight",r.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(t.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(t.boundingBox=e.boundingBox.clone()),t}computeTangents(){console.error("THREE.Geometry: .computeTangents() has been removed.")}computeLineDistances(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")}applyMatrix(e){return console.warn("THREE.Geometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)}dispose(){this.dispatchEvent({type:"dispose"})}}class rH{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(e){let t,r,i;let n=[],a=e.faces;for(r=0;r<a.length;r++){let e=a[r];e.materialIndex!==i&&(i=e.materialIndex,void 0!==t&&(t.count=3*r-t.start,n.push(t)),t={start:3*r,materialIndex:i})}void 0!==t&&(t.count=3*r-t.start,n.push(t)),this.groups=n}fromGeometry(e){let t,r;let i=e.faces,n=e.vertices,a=e.faceVertexUvs,s=a[0]&&a[0].length>0,o=a[1]&&a[1].length>0,l=e.morphTargets,c=l.length;if(c>0){t=[];for(let e=0;e<c;e++)t[e]={name:l[e].name,data:[]};this.morphTargets.position=t}let u=e.morphNormals,h=u.length;if(h>0){r=[];for(let e=0;e<h;e++)r[e]={name:u[e].name,data:[]};this.morphTargets.normal=r}let p=e.skinIndices,d=e.skinWeights,f=p.length===n.length,m=d.length===n.length;n.length>0&&0===i.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let e=0;e<i.length;e++){let g=i[e];this.vertices.push(n[g.a],n[g.b],n[g.c]);let v=g.vertexNormals;if(3===v.length)this.normals.push(v[0],v[1],v[2]);else{let e=g.normal;this.normals.push(e,e,e)}let y=g.vertexColors;if(3===y.length)this.colors.push(y[0],y[1],y[2]);else{let e=g.color;this.colors.push(e,e,e)}if(!0===s){let t=a[0][e];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",e),this.uvs.push(new Vector2,new Vector2,new Vector2))}if(!0===o){let t=a[1][e];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",e),this.uvs2.push(new Vector2,new Vector2,new Vector2))}for(let e=0;e<c;e++){let r=l[e].vertices;t[e].data.push(r[g.a],r[g.b],r[g.c])}for(let t=0;t<h;t++){let i=u[t].vertexNormals[e];r[t].data.push(i.a,i.b,i.c)}f&&this.skinIndices.push(p[g.a],p[g.b],p[g.c]),m&&this.skinWeights.push(d[g.a],d[g.b],d[g.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this}}class rW{constructor(e,t,r,i,n,a=0){this.a=e,this.b=t,this.c=r,this.normal=i&&i.isVector3?i:new Vector3,this.vertexNormals=Array.isArray(i)?i:[],this.color=n&&n.isColor?n:new Color,this.vertexColors=Array.isArray(n)?n:[],this.materialIndex=a}clone(){return new this.constructor().copy(this)}copy(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(let t=0,r=e.vertexNormals.length;t<r;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(let t=0,r=e.vertexColors.length;t<r;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}}}}]);