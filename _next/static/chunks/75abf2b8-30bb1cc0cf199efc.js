"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[630],{959:function(e,t,r){let i,a,n,s,o,l,c,u,h;r.d(t,{zxs:function(){return OrbitControls}});var p,d=r(1305);r(8304);var f=r(2919),m=r(5009),g=Object.defineProperty,__defNormalProp=(e,t,r)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,__publicField=(e,t,r)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,r),r);let v=new d.Vector3,y=new d.Line3,x=new d.Plane,b=new d.Vector3,T=new d.Triangle;let ConvexHull=class ConvexHull{constructor(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new VertexList,this.unassigned=new VertexList,this.vertices=[]}setFromPoints(e){if(e.length>=4){this.makeEmpty();for(let t=0,r=e.length;t<r;t++)this.vertices.push(new VertexNode(e[t]));this.compute()}return this}setFromObject(e){let t=[];return e.updateMatrixWorld(!0),e.traverse(function(e){let r=e.geometry;if(void 0!==r){let i=r.attributes.position;if(void 0!==i)for(let r=0,a=i.count;r<a;r++){let a=new Vector3;a.fromBufferAttribute(i,r).applyMatrix4(e.matrixWorld),t.push(a)}}}),this.setFromPoints(t)}containsPoint(e){let t=this.faces;for(let r=0,i=t.length;r<i;r++){let i=t[r];if(i.distanceToPoint(e)>this.tolerance)return!1}return!0}intersectRay(e,t){let r=this.faces,i=-1/0,a=1/0;for(let t=0,n=r.length;t<n;t++){let n=r[t],s=n.distanceToPoint(e.origin),o=n.normal.dot(e.direction);if(s>0&&o>=0)return null;let l=0!==o?-s/o:0;if(!(l<=0)&&(o>0?a=Math.min(l,a):i=Math.max(l,i),i>a))return null}return i!==-1/0?e.at(i,t):e.at(a,t),t}intersectsRay(e){return null!==this.intersectRay(e,v)}makeEmpty(){return this.faces=[],this.vertices=[],this}addVertexToFace(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this}removeVertexFromFace(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this}removeAllVerticesFromFace(e){if(null!==e.outside){let t=e.outside,r=e.outside;for(;null!==r.next&&r.next.face===e;)r=r.next;return this.assigned.removeSubList(t,r),t.prev=r.next=null,e.outside=null,t}}deleteFaceVertices(e,t){let r=this.removeAllVerticesFromFace(e);if(void 0!==r){if(void 0===t)this.unassigned.appendChain(r);else{let e=r;do{let r=e.next,i=t.distanceToPoint(e.point);i>this.tolerance?this.addVertexToFace(e,t):this.unassigned.append(e),e=r}while(null!==e)}}return this}resolveUnassignedPoints(e){if(!1===this.unassigned.isEmpty()){let t=this.unassigned.first();do{let r=t.next,i=this.tolerance,a=null;for(let r=0;r<e.length;r++){let n=e[r];if(0===n.mark){let e=n.distanceToPoint(t.point);if(e>i&&(i=e,a=n),i>1e3*this.tolerance)break}}null!==a&&this.addVertexToFace(t,a),t=r}while(null!==t)}return this}computeExtremes(){let e=new Vector3,t=new Vector3,r=[],i=[];for(let e=0;e<3;e++)r[e]=i[e]=this.vertices[0];e.copy(this.vertices[0].point),t.copy(this.vertices[0].point);for(let a=0,n=this.vertices.length;a<n;a++){let n=this.vertices[a],s=n.point;for(let t=0;t<3;t++)s.getComponent(t)<e.getComponent(t)&&(e.setComponent(t,s.getComponent(t)),r[t]=n);for(let e=0;e<3;e++)s.getComponent(e)>t.getComponent(e)&&(t.setComponent(e,s.getComponent(e)),i[e]=n)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(e.x),Math.abs(t.x))+Math.max(Math.abs(e.y),Math.abs(t.y))+Math.max(Math.abs(e.z),Math.abs(t.z))),{min:r,max:i}}computeInitialHull(){let e,t;let r=this.vertices,i=this.computeExtremes(),a=i.min,n=i.max,s=0,o=0;for(let e=0;e<3;e++){let t=n[e].point.getComponent(e)-a[e].point.getComponent(e);t>s&&(s=t,o=e)}let l=a[o],c=n[o];s=0,y.set(l.point,c.point);for(let t=0,i=this.vertices.length;t<i;t++){let i=r[t];if(i!==l&&i!==c){y.closestPointToPoint(i.point,!0,b);let t=b.distanceToSquared(i.point);t>s&&(s=t,e=i)}}s=-1,x.setFromCoplanarPoints(l.point,c.point,e.point);for(let i=0,a=this.vertices.length;i<a;i++){let a=r[i];if(a!==l&&a!==c&&a!==e){let e=Math.abs(x.distanceToPoint(a.point));e>s&&(s=e,t=a)}}let u=[];if(0>x.distanceToPoint(t.point)){u.push(S.create(l,c,e),S.create(t,c,l),S.create(t,e,c),S.create(t,l,e));for(let e=0;e<3;e++){let t=(e+1)%3;u[e+1].getEdge(2).setTwin(u[0].getEdge(t)),u[e+1].getEdge(1).setTwin(u[t+1].getEdge(0))}}else{u.push(S.create(l,e,c),S.create(t,l,c),S.create(t,c,e),S.create(t,e,l));for(let e=0;e<3;e++){let t=(e+1)%3;u[e+1].getEdge(2).setTwin(u[0].getEdge((3-e)%3)),u[e+1].getEdge(0).setTwin(u[t+1].getEdge(1))}}for(let e=0;e<4;e++)this.faces.push(u[e]);for(let i=0,a=r.length;i<a;i++){let a=r[i];if(a!==l&&a!==c&&a!==e&&a!==t){s=this.tolerance;let e=null;for(let t=0;t<4;t++){let r=this.faces[t].distanceToPoint(a.point);r>s&&(s=r,e=this.faces[t])}null!==e&&this.addVertexToFace(a,e)}}return this}reindexFaces(){let e=[];for(let t=0;t<this.faces.length;t++){let r=this.faces[t];0===r.mark&&e.push(r)}return this.faces=e,this}nextVertexToAdd(){if(!1===this.assigned.isEmpty()){let e,t=0,r=this.assigned.first().face,i=r.outside;do{let a=r.distanceToPoint(i.point);a>t&&(t=a,e=i),i=i.next}while(null!==i&&i.face===r);return e}}computeHorizon(e,t,r,i){let a;this.deleteFaceVertices(r),r.mark=1,a=null===t?t=r.getEdge(0):t.next;do{let t=a.twin,r=t.face;0===r.mark&&(r.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,t,r,i):i.push(a)),a=a.next}while(a!==t);return this}addAdjoiningFace(e,t){let r=S.create(e,t.tail(),t.head());return this.faces.push(r),r.getEdge(-1).setTwin(t.twin),r.getEdge(0)}addNewFaces(e,t){this.newFaces=[];let r=null,i=null;for(let a=0;a<t.length;a++){let n=t[a],s=this.addAdjoiningFace(e,n);null===r?r=s:s.next.setTwin(i),this.newFaces.push(s.face),i=s}return r.next.setTwin(i),this}addVertexToHull(e){let t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this}cleanup(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this}compute(){let e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}};let S=class Face2{constructor(){this.normal=new Vector3,this.midpoint=new Vector3,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}static create(e,t,r){let i=new Face2,a=new HalfEdge(e,i),n=new HalfEdge(t,i),s=new HalfEdge(r,i);return a.next=s.prev=n,n.next=a.prev=s,s.next=n.prev=a,i.edge=a,i.compute()}getEdge(e){let t=this.edge;for(;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t}compute(){let e=this.edge.tail(),t=this.edge.head(),r=this.edge.next.head();return T.set(e.point,t.point,r.point),T.getNormal(this.normal),T.getMidpoint(this.midpoint),this.area=T.getArea(),this.constant=this.normal.dot(this.midpoint),this}distanceToPoint(e){return this.normal.dot(e)-this.constant}};let HalfEdge=class HalfEdge{constructor(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}head(){return this.vertex}tail(){return this.prev?this.prev.vertex:null}length(){let e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1}lengthSquared(){let e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1}setTwin(e){return this.twin=e,e.twin=this,this}};let VertexNode=class VertexNode{constructor(e){this.point=e,this.prev=null,this.next=null,this.face=null}};let VertexList=class VertexList{constructor(){this.head=null,this.tail=null}first(){return this.head}last(){return this.tail}clear(){return this.head=this.tail=null,this}insertBefore(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this}insertAfter(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this}append(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this}appendChain(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this}remove(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this}removeSubList(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this}isEmpty(){return null===this.head}};let ConvexGeometry=class ConvexGeometry extends null{constructor(e=[]){super();let t=[],r=[],i=new ConvexHull().setFromPoints(e),a=i.faces;for(let e=0;e<a.length;e++){let i=a[e],n=i.edge;do{let e=n.head().point;t.push(e.x,e.y,e.z),r.push(i.normal.x,i.normal.y,i.normal.z),n=n.next}while(n!==i.edge)}this.setAttribute("position",new Float32BufferAttribute(t,3)),this.setAttribute("normal",new Float32BufferAttribute(r,3))}};let E=new d.Vector3;let ConvexObjectBreaker=class ConvexObjectBreaker{constructor(e=1.4,t=1e-4){this.minSizeForBreak=e,this.smallDelta=t,this.tempLine1=new Line3,this.tempPlane1=new Plane,this.tempPlane2=new Plane,this.tempPlane_Cut=new Plane,this.tempCM1=new Vector3,this.tempCM2=new Vector3,this.tempVector3=new Vector3,this.tempVector3_2=new Vector3,this.tempVector3_3=new Vector3,this.tempVector3_P0=new Vector3,this.tempVector3_P1=new Vector3,this.tempVector3_P2=new Vector3,this.tempVector3_N0=new Vector3,this.tempVector3_N1=new Vector3,this.tempVector3_AB=new Vector3,this.tempVector3_CB=new Vector3,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(let e=0;e<900;e++)this.segments[e]=!1}prepareBreakableObject(e,t,r,i,a){let n=e.userData;n.mass=t,n.velocity=r.clone(),n.angularVelocity=i.clone(),n.breakable=a}subdivideByImpact(e,t,r,i,a){let n=[],s=this.tempPlane1,o=this.tempPlane2;this.tempVector3.addVectors(t,r),s.setFromCoplanarPoints(t,e.position,this.tempVector3);let l=a+i,c=this;function subdivideRadial(a,u,h,p){if(Math.random()<.05*p||p>l){n.push(a);return}let d=Math.PI;0===p?(o.normal.copy(s.normal),o.constant=s.constant):p<=i?(d=(h-u)*(.2+.6*Math.random())+u,c.tempVector3_2.copy(e.position).sub(t).applyAxisAngle(r,d).add(t),o.setFromCoplanarPoints(t,c.tempVector3,c.tempVector3_2)):(d=(.5*(1&p)+.2*(2-Math.random()))*Math.PI,c.tempVector3_2.copy(t).sub(a.position).applyAxisAngle(r,d).add(a.position),c.tempVector3_3.copy(r).add(a.position),o.setFromCoplanarPoints(a.position,c.tempVector3_3,c.tempVector3_2)),c.cutByPlane(a,o,c.tempResultObjects);let f=c.tempResultObjects.object1,m=c.tempResultObjects.object2;f&&subdivideRadial(f,u,d,p+1),m&&subdivideRadial(m,d,h,p+1)}return subdivideRadial(e,0,2*Math.PI,0),n}cutByPlane(e,t,r){let i=e.geometry,a=i.attributes.position.array,n=i.attributes.normal.array,s=a.length/3,o=s/3,l=i.getIndex();function getVertexIndex(e,t){let r=3*e+t;return l?l[r]:r}l&&(o=(l=l.array).length/3);let c=[],u=[],h=this.smallDelta,p=s*s;for(let e=0;e<p;e++)this.segments[e]=!1;let d=this.tempVector3_P0,f=this.tempVector3_P1,m=this.tempVector3_N0,g=this.tempVector3_N1;for(let e=0;e<o-1;e++){let t=getVertexIndex(e,0),r=getVertexIndex(e,1),i=getVertexIndex(e,2);m.set(n[t],n[t]+1,n[t]+2);for(let a=e+1;a<o;a++){let e=getVertexIndex(a,0),o=getVertexIndex(a,1),l=getVertexIndex(a,2);g.set(n[e],n[e]+1,n[e]+2);let c=1-m.dot(g)<h;c&&(t===e||t===o||t===l?r===e||r===o||r===l?(this.segments[t*s+r]=!0,this.segments[r*s+t]=!0):(this.segments[i*s+t]=!0,this.segments[t*s+i]=!0):(r===e||r===o||r===l)&&(this.segments[i*s+r]=!0,this.segments[r*s+i]=!0))}}let v=this.tempPlane_Cut;e.updateMatrix(),ConvexObjectBreaker.transformPlaneToLocalSpace(t,e.matrix,v);for(let e=0;e<o;e++){let t=getVertexIndex(e,0),i=getVertexIndex(e,1),n=getVertexIndex(e,2);for(let e=0;e<3;e++){let o=0===e?t:1===e?i:n,l=0===e?i:1===e?n:t,p=this.segments[o*s+l];if(p)continue;this.segments[o*s+l]=!0,this.segments[l*s+o]=!0,d.set(a[3*o],a[3*o+1],a[3*o+2]),f.set(a[3*l],a[3*l+1],a[3*l+2]);let m=0,g=v.distanceToPoint(d);g>h?(m=2,u.push(d.clone())):g<-h?(m=1,c.push(d.clone())):(m=3,c.push(d.clone()),u.push(d.clone()));let y=0;if((g=v.distanceToPoint(f))>h?(y=2,u.push(f.clone())):g<-h?(y=1,c.push(f.clone())):(y=3,c.push(f.clone()),u.push(f.clone())),1===m&&2===y||2===m&&1===y){this.tempLine1.start.copy(d),this.tempLine1.end.copy(f);let e=new Vector3;if(null===(e=v.intersectLine(this.tempLine1,e)))return console.error("Internal error: segment does not intersect plane."),r.segmentedObject1=null,r.segmentedObject2=null,0;c.push(e),u.push(e.clone())}}}let y=.5*e.userData.mass;this.tempCM1.set(0,0,0);let x=0,b=c.length;if(b>0){for(let e=0;e<b;e++)this.tempCM1.add(c[e]);this.tempCM1.divideScalar(b);for(let e=0;e<b;e++){let t=c[e];t.sub(this.tempCM1),x=Math.max(x,t.x,t.y,t.z)}this.tempCM1.add(e.position)}this.tempCM2.set(0,0,0);let T=0,S=u.length;if(S>0){for(let e=0;e<S;e++)this.tempCM2.add(u[e]);this.tempCM2.divideScalar(S);for(let e=0;e<S;e++){let t=u[e];t.sub(this.tempCM2),T=Math.max(T,t.x,t.y,t.z)}this.tempCM2.add(e.position)}let E=null,R=null,A=0;return b>4&&((E=new Mesh(new ConvexGeometry(c),e.material)).position.copy(this.tempCM1),E.quaternion.copy(e.quaternion),this.prepareBreakableObject(E,y,e.userData.velocity,e.userData.angularVelocity,2*x>this.minSizeForBreak),A++),S>4&&((R=new Mesh(new ConvexGeometry(u),e.material)).position.copy(this.tempCM2),R.quaternion.copy(e.quaternion),this.prepareBreakableObject(R,y,e.userData.velocity,e.userData.angularVelocity,2*T>this.minSizeForBreak),A++),r.object1=E,r.object2=R,A}static transformFreeVector(e,t){let r=e.x,i=e.y,a=e.z,n=t.elements;return e.x=n[0]*r+n[4]*i+n[8]*a,e.y=n[1]*r+n[5]*i+n[9]*a,e.z=n[2]*r+n[6]*i+n[10]*a,e}static transformFreeVectorInverse(e,t){let r=e.x,i=e.y,a=e.z,n=t.elements;return e.x=n[0]*r+n[1]*i+n[2]*a,e.y=n[4]*r+n[5]*i+n[6]*a,e.z=n[8]*r+n[9]*i+n[10]*a,e}static transformTiedVectorInverse(e,t){let r=e.x,i=e.y,a=e.z,n=t.elements;return e.x=n[0]*r+n[1]*i+n[2]*a-n[12],e.y=n[4]*r+n[5]*i+n[6]*a-n[13],e.z=n[8]*r+n[9]*i+n[10]*a-n[14],e}static transformPlaneToLocalSpace(e,t,r){r.normal.copy(e.normal),r.constant=e.constant;let i=ConvexObjectBreaker.transformTiedVectorInverse(e.coplanarPoint(E),t);ConvexObjectBreaker.transformFreeVectorInverse(r.normal,t),r.constant=-i.dot(r.normal)}};let RenderableVertex=class RenderableVertex{constructor(){this.position=new Vector3,this.positionWorld=new Vector3,this.positionScreen=new Vector4,this.visible=!0}copy(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)}};function toTrianglesDrawMode(e,t){if(t===d.TrianglesDrawMode)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t!==d.TriangleFanDrawMode&&t!==d.TriangleStripDrawMode)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e;{let r=e.getIndex();if(null===r){let t=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),r=e.getIndex()}let i=r.count-2,a=[];if(r){if(t===d.TriangleFanDrawMode)for(let e=1;e<=i;e++)a.push(r.getX(0)),a.push(r.getX(e)),a.push(r.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(a.push(r.getX(e)),a.push(r.getX(e+1)),a.push(r.getX(e+2))):(a.push(r.getX(e+2)),a.push(r.getX(e+1)),a.push(r.getX(e)))}a.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");let n=e.clone();return n.setIndex(a),n.clearGroups(),n}}async function readAsDataURL(e){let t=await e.arrayBuffer(),r=btoa(String.fromCharCode(...new Uint8Array(t)));return`data:${e.type||""};base64,${r}`}function decompress(e,t=1/0,r=null){a||(a=new d.PlaneGeometry(2,2,1,1)),n||(n=new d.ShaderMaterial({uniforms:{blitTexture:new d.Uniform(e)},vertexShader:`
        varying vec2 vUv;
        void main(){
            vUv = uv;
            gl_Position = vec4(position.xy * 1.0,0.,.999999);
        }
      `,fragmentShader:`
          uniform sampler2D blitTexture; 
          varying vec2 vUv;

          void main(){ 
              gl_FragColor = vec4(vUv.xy, 0, 1);
              
              #ifdef IS_SRGB
              gl_FragColor = LinearTosRGB( texture2D( blitTexture, vUv) );
              #else
              gl_FragColor = texture2D( blitTexture, vUv);
              #endif
          }
      `})),n.uniforms.blitTexture.value=e,n.defines.IS_SRGB="colorSpace"in e?"srgb"===e.colorSpace:3001===e.encoding,n.needsUpdate=!0,s||((s=new d.Mesh(a,n)).frustrumCulled=!1);let o=new d.PerspectiveCamera,l=new d.Scene;l.add(s),r||(r=i=new d.WebGLRenderer({antialias:!1})),r.setSize(Math.min(e.image.width,t),Math.min(e.image.height,t)),r.clear(),r.render(l,o);let c=new d.Texture(r.domElement);return c.minFilter=e.minFilter,c.magFilter=e.magFilter,c.wrapS=e.wrapS,c.wrapT=e.wrapT,c.name=e.name,i&&(i.dispose(),i=null),c}let R={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};let GLTFExporter=class GLTFExporter{constructor(){this.pluginCallbacks=[],this.register(function(e){return new GLTFLightExtension(e)}),this.register(function(e){return new I(e)}),this.register(function(e){return new O(e)}),this.register(function(e){return new N(e)}),this.register(function(e){return new L(e)}),this.register(function(e){return new F(e)}),this.register(function(e){return new k(e)}),this.register(function(e){return new _(e)}),this.register(function(e){return new D(e)}),this.register(function(e){return new U(e)}),this.register(function(e){return new B(e)})}register(e){return -1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return -1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,i){let a=new GLTFWriter,n=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)n.push(this.pluginCallbacks[e](a));a.setPlugins(n),a.write(e,t,i).catch(r)}parseAsync(e,t){let r=this;return new Promise(function(i,a){r.parse(e,i,a,t)})}};let A={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,REPEAT:10497},C="KHR_mesh_quantization",M={};M[d.NearestFilter]=A.NEAREST,M[d.NearestMipmapNearestFilter]=A.NEAREST_MIPMAP_NEAREST,M[d.NearestMipmapLinearFilter]=A.NEAREST_MIPMAP_LINEAR,M[d.LinearFilter]=A.LINEAR,M[d.LinearMipmapNearestFilter]=A.LINEAR_MIPMAP_NEAREST,M[d.LinearMipmapLinearFilter]=A.LINEAR_MIPMAP_LINEAR,M[d.ClampToEdgeWrapping]=A.CLAMP_TO_EDGE,M[d.RepeatWrapping]=A.REPEAT,M[d.MirroredRepeatWrapping]=A.MIRRORED_REPEAT;let P={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},w=new d.Color;function equalArray(e,t){return e.length===t.length&&e.every(function(e,r){return e===t[r]})}function stringToArrayBuffer(e){return new TextEncoder().encode(e).buffer}function isIdentityMatrix(e){return equalArray(e.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}function getMinMax(e,t,r){let i={min:Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let a=t;a<t+r;a++)for(let t=0;t<e.itemSize;t++){let r;e.itemSize>4?r=e.array[a*e.itemSize+t]:(0===t?r=e.getX(a):1===t?r=e.getY(a):2===t?r=e.getZ(a):3===t&&(r=e.getW(a)),!0===e.normalized&&(r=d.MathUtils.normalize(r,e.array))),i.min[t]=Math.min(i.min[t],r),i.max[t]=Math.max(i.max[t],r)}return i}function getPaddedBufferSize(e){return 4*Math.ceil(e/4)}function getPaddedArrayBuffer(e,t=0){let r=getPaddedBufferSize(e.byteLength);if(r!==e.byteLength){let i=new Uint8Array(r);if(i.set(new Uint8Array(e)),0!==t)for(let a=e.byteLength;a<r;a++)i[a]=t;return i.buffer}return e}function getCanvas(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}function getToBlobPromise(e,t){let r;return void 0!==e.toBlob?new Promise(r=>e.toBlob(r,t)):("image/jpeg"===t?r=.92:"image/webp"===t&&(r=.8),e.convertToBlob({type:t,quality:r}))}let GLTFWriter=class GLTFWriter{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}async write(e,t,r={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},r),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e),await Promise.all(this.pending);let i=this.buffers,a=this.json;r=this.options;let n=this.extensionsUsed,s=this.extensionsRequired,o=new Blob(i,{type:"application/octet-stream"}),l=Object.keys(n),c=Object.keys(s);l.length>0&&(a.extensionsUsed=l),c.length>0&&(a.extensionsRequired=c),a.buffers&&a.buffers.length>0&&(a.buffers[0].byteLength=o.size),!0===r.binary?o.arrayBuffer().then(e=>{let r=getPaddedArrayBuffer(e),i=new DataView(new ArrayBuffer(8));i.setUint32(0,r.byteLength,!0),i.setUint32(4,5130562,!0);let n=getPaddedArrayBuffer(stringToArrayBuffer(JSON.stringify(a)),32),s=new DataView(new ArrayBuffer(8));s.setUint32(0,n.byteLength,!0),s.setUint32(4,1313821514,!0);let o=new ArrayBuffer(12),l=new DataView(o);l.setUint32(0,1179937895,!0),l.setUint32(4,2,!0);let c=12+s.byteLength+n.byteLength+i.byteLength+r.byteLength;l.setUint32(8,c,!0);let u=new Blob([o,s,n,i,r],{type:"application/octet-stream"});u.arrayBuffer().then(t)}):(a.buffers&&a.buffers.length>0&&readAsDataURL(o).then(e=>{a.buffers[0].uri=e}),t(a))}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;let r=this.options,i=this.extensionsUsed;try{let a=JSON.parse(JSON.stringify(e.userData));if(r.includeCustomExtensions&&a.gltfExtensions){for(let e in void 0===t.extensions&&(t.extensions={}),a.gltfExtensions)t.extensions[e]=a.gltfExtensions[e],i[e]=!0;delete a.gltfExtensions}Object.keys(a).length>0&&(t.extras=a)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){let t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}let r=this.uids.get(e);return r.get(t)}isNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return!1;let r=new d.Vector3;for(let t=0,i=e.count;t<i;t++)if(Math.abs(r.fromBufferAttribute(e,t).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){let t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);let r=e.clone(),i=new d.Vector3;for(let e=0,t=r.count;e<t;e++)i.fromBufferAttribute(r,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),r.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,r),r}applyTextureTransform(e,t){let r=!1,i={};(0!==t.offset.x||0!==t.offset.y)&&(i.offset=t.offset.toArray(),r=!0),0!==t.rotation&&(i.rotation=t.rotation,r=!0),(1!==t.repeat.x||1!==t.repeat.y)&&(i.scale=t.repeat.toArray(),r=!0),r&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=i,this.extensionsUsed.KHR_texture_transform=!0)}buildMetalRoughTexture(e,t){if(e===t)return e;function getEncodingConversion(e){return("colorSpace"in e?"srgb"===e.colorSpace:3001===e.encoding)?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),e instanceof d.CompressedTexture&&(e=decompress(e)),t instanceof d.CompressedTexture&&(t=decompress(t));let r=e?e.image:null,i=t?t.image:null,a=Math.max(r?r.width:0,i?i.width:0),n=Math.max(r?r.height:0,i?i.height:0),s=getCanvas();s.width=a,s.height=n;let o=s.getContext("2d");o.fillStyle="#00ffff",o.fillRect(0,0,a,n);let l=o.getImageData(0,0,a,n);if(r){o.drawImage(r,0,0,a,n);let t=getEncodingConversion(e),i=o.getImageData(0,0,a,n).data;for(let e=2;e<i.length;e+=4)l.data[e]=256*t(i[e]/256)}if(i){o.drawImage(i,0,0,a,n);let e=getEncodingConversion(t),r=o.getImageData(0,0,a,n).data;for(let t=1;t<r.length;t+=4)l.data[t]=256*e(r[t]/256)}o.putImageData(l,0,0);let c=e||t,u=c.clone();return u.source=new d.Texture(s).source,"colorSpace"in u?u.colorSpace="":u.encoding=3e3,u.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),u}processBuffer(e){let t=this.json,r=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),r.push(e),0}processBufferView(e,t,r,i,a){let n;let s=this.json;switch(s.bufferViews||(s.bufferViews=[]),t){case A.BYTE:case A.UNSIGNED_BYTE:n=1;break;case A.SHORT:case A.UNSIGNED_SHORT:n=2;break;default:n=4}let o=getPaddedBufferSize(i*e.itemSize*n),l=new DataView(new ArrayBuffer(o)),c=0;for(let a=r;a<r+i;a++)for(let r=0;r<e.itemSize;r++){let i;e.itemSize>4?i=e.array[a*e.itemSize+r]:(0===r?i=e.getX(a):1===r?i=e.getY(a):2===r?i=e.getZ(a):3===r&&(i=e.getW(a)),!0===e.normalized&&(i=d.MathUtils.normalize(i,e.array))),t===A.FLOAT?l.setFloat32(c,i,!0):t===A.INT?l.setInt32(c,i,!0):t===A.UNSIGNED_INT?l.setUint32(c,i,!0):t===A.SHORT?l.setInt16(c,i,!0):t===A.UNSIGNED_SHORT?l.setUint16(c,i,!0):t===A.BYTE?l.setInt8(c,i):t===A.UNSIGNED_BYTE&&l.setUint8(c,i),c+=n}let u={buffer:this.processBuffer(l.buffer),byteOffset:this.byteOffset,byteLength:o};void 0!==a&&(u.target=a),a===A.ARRAY_BUFFER&&(u.byteStride=e.itemSize*n),this.byteOffset+=o,s.bufferViews.push(u);let h={id:s.bufferViews.length-1,byteLength:0};return h}processBufferViewImage(e){let t=this,r=t.json;return r.bufferViews||(r.bufferViews=[]),e.arrayBuffer().then(e=>{let i=getPaddedArrayBuffer(e),a={buffer:t.processBuffer(i),byteOffset:t.byteOffset,byteLength:i.byteLength};return t.byteOffset+=i.byteLength,r.bufferViews.push(a)-1})}processAccessor(e,t,r,i){let a,n;let s=this.json;if(e.array.constructor===Float32Array)a=A.FLOAT;else if(e.array.constructor===Int32Array)a=A.INT;else if(e.array.constructor===Uint32Array)a=A.UNSIGNED_INT;else if(e.array.constructor===Int16Array)a=A.SHORT;else if(e.array.constructor===Uint16Array)a=A.UNSIGNED_SHORT;else if(e.array.constructor===Int8Array)a=A.BYTE;else if(e.array.constructor===Uint8Array)a=A.UNSIGNED_BYTE;else throw Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);if(void 0===r&&(r=0),void 0===i&&(i=e.count),0===i)return null;let o=getMinMax(e,r,i);void 0!==t&&(n=e===t.index?A.ELEMENT_ARRAY_BUFFER:A.ARRAY_BUFFER);let l=this.processBufferView(e,a,r,i,n),c={bufferView:l.id,byteOffset:l.byteOffset,componentType:a,count:i,max:o.max,min:o.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(c.normalized=!0),s.accessors||(s.accessors=[]),s.accessors.push(c)-1}processImage(e,t,r,i="image/png"){if(null!==e){let a=this,n=a.cache,s=a.json,o=a.options,l=a.pending;n.images.has(e)||n.images.set(e,{});let c=n.images.get(e),u=i+":flipY/"+r.toString();if(void 0!==c[u])return c[u];s.images||(s.images=[]);let h={mimeType:i},p=getCanvas();p.width=Math.min(e.width,o.maxTextureSize),p.height=Math.min(e.height,o.maxTextureSize);let f=p.getContext("2d");if(!0===r&&(f.translate(0,p.height),f.scale(1,-1)),void 0!==e.data){t!==d.RGBAFormat&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>o.maxTextureSize||e.height>o.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);let r=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<r.length;t+=4)r[t+0]=e.data[t+0],r[t+1]=e.data[t+1],r[t+2]=e.data[t+2],r[t+3]=e.data[t+3];f.putImageData(new ImageData(r,e.width,e.height),0,0)}else f.drawImage(e,0,0,p.width,p.height);!0===o.binary?l.push(getToBlobPromise(p,i).then(e=>a.processBufferViewImage(e)).then(e=>{h.bufferView=e})):void 0!==p.toDataURL?h.uri=p.toDataURL(i):l.push(getToBlobPromise(p,i).then(readAsDataURL).then(e=>{h.uri=e}));let m=s.images.push(h)-1;return c[u]=m,m}throw Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){let t=this.json;t.samplers||(t.samplers=[]);let r={magFilter:M[e.magFilter],minFilter:M[e.minFilter],wrapS:M[e.wrapS],wrapT:M[e.wrapT]};return t.samplers.push(r)-1}processTexture(e){let t=this.options,r=this.cache,i=this.json;if(r.textures.has(e))return r.textures.get(e);i.textures||(i.textures=[]),e instanceof d.CompressedTexture&&(e=decompress(e,t.maxTextureSize));let a=e.userData.mimeType;"image/webp"===a&&(a="image/png");let n={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,a)};e.name&&(n.name=e.name),this._invokeAll(function(t){t.writeTexture&&t.writeTexture(e,n)});let s=i.textures.push(n)-1;return r.textures.set(e,s),s}processMaterial(e){let t=this.cache,r=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;r.materials||(r.materials=[]);let i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");let a=e.color.toArray().concat([e.opacity]);if(equalArray(a,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=a),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=.5,i.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap){let t=this.buildMetalRoughTexture(e.metalnessMap,e.roughnessMap),r={index:this.processTexture(t),channel:t.channel};this.applyTextureTransform(r,t),i.pbrMetallicRoughness.metallicRoughnessTexture=r}if(e.map){let t={index:this.processTexture(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){let t=e.emissive,r=Math.max(t.r,t.g,t.b);if(r>0&&(i.emissiveFactor=e.emissive.toArray()),e.emissiveMap){let t={index:this.processTexture(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){let t={index:this.processTexture(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){let t={index:this.processTexture(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===d.DoubleSide&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),this._invokeAll(function(t){t.writeMaterial&&t.writeMaterial(e,i)});let n=r.materials.push(i)-1;return t.materials.set(e,n),n}processMesh(e){let t;let r=this.cache,i=this.json,a=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,r=e.material.length;t<r;t++)a.push(e.material[t].uuid);else a.push(e.material.uuid);let n=a.join(":");if(r.meshes.has(n))return r.meshes.get(n);let s=e.geometry;t=e.isLineSegments?A.LINES:e.isLineLoop?A.LINE_LOOP:e.isLine?A.LINE_STRIP:e.isPoints?A.POINTS:e.material.wireframe?A.LINES:A.TRIANGLES;let o={},l={},c=[],u=[],h={uv:"TEXCOORD_0",[d.REVISION.replace(/\D+/g,"")>=152?"uv1":"uv2"]:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},p=s.getAttribute("normal");void 0===p||this.isNormalizedNormalAttribute(p)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),s.setAttribute("normal",this.createNormalizedNormalAttribute(p)));let f=null;for(let e in s.attributes){if("morph"===e.slice(0,5))continue;let t=s.attributes[e];e=h[e]||e.toUpperCase();let i=/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/;if(i.test(e)||(e="_"+e),r.attributes.has(this.getUID(t))){l[e]=r.attributes.get(this.getUID(t));continue}f=null;let a=t.array;"JOINTS_0"!==e||a instanceof Uint16Array||a instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),f=new d.BufferAttribute(new Uint16Array(a),t.itemSize,t.normalized));let n=this.processAccessor(f||t,s);null!==n&&(e.startsWith("_")||this.detectMeshQuantization(e,t),l[e]=n,r.attributes.set(this.getUID(t),n))}if(void 0!==p&&s.setAttribute("normal",p),0===Object.keys(l).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){let t=[],i=[],a={};if(void 0!==e.morphTargetDictionary)for(let t in e.morphTargetDictionary)a[e.morphTargetDictionary[t]]=t;for(let n=0;n<e.morphTargetInfluences.length;++n){let o={},l=!1;for(let e in s.morphAttributes){if("position"!==e&&"normal"!==e){l||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}let t=s.morphAttributes[e][n],i=e.toUpperCase(),a=s.attributes[e];if(r.attributes.has(this.getUID(t,!0))){o[i]=r.attributes.get(this.getUID(t,!0));continue}let c=t.clone();if(!s.morphTargetsRelative)for(let e=0,r=t.count;e<r;e++)for(let r=0;r<t.itemSize;r++)0===r&&c.setX(e,t.getX(e)-a.getX(e)),1===r&&c.setY(e,t.getY(e)-a.getY(e)),2===r&&c.setZ(e,t.getZ(e)-a.getZ(e)),3===r&&c.setW(e,t.getW(e)-a.getW(e));o[i]=this.processAccessor(c,s),r.attributes.set(this.getUID(a,!0),o[i])}u.push(o),t.push(e.morphTargetInfluences[n]),void 0!==e.morphTargetDictionary&&i.push(a[n])}o.weights=t,i.length>0&&(o.extras={},o.extras.targetNames=i)}let m=Array.isArray(e.material);if(m&&0===s.groups.length)return null;let g=m?e.material:[e.material],v=m?s.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,i=v.length;e<i;e++){let i={mode:t,attributes:l};if(this.serializeUserData(s,i),u.length>0&&(i.targets=u),null!==s.index){let t=this.getUID(s.index);(void 0!==v[e].start||void 0!==v[e].count)&&(t+=":"+v[e].start+":"+v[e].count),r.attributes.has(t)?i.indices=r.attributes.get(t):(i.indices=this.processAccessor(s.index,s,v[e].start,v[e].count),r.attributes.set(t,i.indices)),null===i.indices&&delete i.indices}let a=this.processMaterial(g[v[e].materialIndex]);null!==a&&(i.material=a),c.push(i)}o.primitives=c,i.meshes||(i.meshes=[]),this._invokeAll(function(t){t.writeMesh&&t.writeMesh(e,o)});let y=i.meshes.push(o)-1;return r.meshes.set(n,y),y}detectMeshQuantization(e,t){let r;if(this.extensionsUsed[C])return;switch(t.array.constructor){case Int8Array:r="byte";break;case Uint8Array:r="unsigned byte";break;case Int16Array:r="short";break;case Uint16Array:r="unsigned short";break;default:return}t.normalized&&(r+=" normalized");let i=e.split("_",1)[0];R[i]&&R[i].includes(r)&&(this.extensionsUsed[C]=!0,this.extensionsRequired[C]=!0)}processCamera(e){let t=this.json;t.cameras||(t.cameras=[]);let r=e.isOrthographicCamera,i={type:r?"orthographic":"perspective"};return r?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:d.MathUtils.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){let r=this.json,i=this.nodeMap;r.animations||(r.animations=[]),e=GLTFExporter.Utils.mergeMorphTargetTracks(e.clone(),t);let a=e.tracks,n=[],s=[];for(let e=0;e<a.length;++e){let r;let o=a[e],l=d.PropertyBinding.parseTrackName(o.name),c=d.PropertyBinding.findNode(t,l.nodeName),u=P[l.propertyName];if("bones"===l.objectName&&(c=!0===c.isSkinnedMesh?c.skeleton.getBoneByName(l.objectIndex):void 0),!c||!u)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',o.name),null;let h=o.values.length/o.times.length;u===P.morphTargetInfluences&&(h/=c.morphTargetInfluences.length),!0===o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(r="CUBICSPLINE",h/=3):r=o.getInterpolation()===d.InterpolateDiscrete?"STEP":"LINEAR",s.push({input:this.processAccessor(new d.BufferAttribute(o.times,1)),output:this.processAccessor(new d.BufferAttribute(o.values,h)),interpolation:r}),n.push({sampler:s.length-1,target:{node:i.get(c),path:u}})}return r.animations.push({name:e.name||"clip_"+r.animations.length,samplers:s,channels:n}),r.animations.length-1}processSkin(e){let t=this.json,r=this.nodeMap,i=t.nodes[r.get(e)],a=e.skeleton;if(void 0===a)return null;let n=e.skeleton.bones[0];if(void 0===n)return null;let s=[],o=new Float32Array(16*a.bones.length),l=new d.Matrix4;for(let t=0;t<a.bones.length;++t)s.push(r.get(a.bones[t])),l.copy(a.boneInverses[t]),l.multiply(e.bindMatrix).toArray(o,16*t);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new d.BufferAttribute(o,16)),joints:s,skeleton:r.get(n)});let c=i.skin=t.skins.length-1;return c}processNode(e){let t=this.json,r=this.options,i=this.nodeMap;t.nodes||(t.nodes=[]);let a={};if(r.trs){let t=e.quaternion.toArray(),r=e.position.toArray(),i=e.scale.toArray();equalArray(t,[0,0,0,1])||(a.rotation=t),equalArray(r,[0,0,0])||(a.translation=r),equalArray(i,[1,1,1])||(a.scale=i)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===isIdentityMatrix(e.matrix)&&(a.matrix=e.matrix.elements);if(""!==e.name&&(a.name=String(e.name)),this.serializeUserData(e,a),e.isMesh||e.isLine||e.isPoints){let t=this.processMesh(e);null!==t&&(a.mesh=t)}else e.isCamera&&(a.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){let t=[];for(let i=0,a=e.children.length;i<a;i++){let a=e.children[i];if(a.visible||!1===r.onlyVisible){let e=this.processNode(a);null!==e&&t.push(e)}}t.length>0&&(a.children=t)}this._invokeAll(function(t){t.writeNode&&t.writeNode(e,a)});let n=t.nodes.push(a)-1;return i.set(e,n),n}processScene(e){let t=this.json,r=this.options;t.scenes||(t.scenes=[],t.scene=0);let i={};""!==e.name&&(i.name=e.name),t.scenes.push(i);let a=[];for(let t=0,i=e.children.length;t<i;t++){let i=e.children[t];if(i.visible||!1===r.onlyVisible){let e=this.processNode(i);null!==e&&a.push(e)}}a.length>0&&(i.nodes=a),this.serializeUserData(e,i)}processObjects(e){let t=new d.Scene;t.name="AuxScene";for(let r=0;r<e.length;r++)t.children.push(e[r]);this.processScene(t)}processInput(e){let t=this.options;e=e instanceof Array?e:[e],this._invokeAll(function(t){t.beforeParse&&t.beforeParse(e)});let r=[];for(let t=0;t<e.length;t++)e[t]instanceof d.Scene?this.processScene(e[t]):r.push(e[t]);r.length>0&&this.processObjects(r);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let r=0;r<t.animations.length;++r)this.processAnimation(t.animations[r],e[0]);this._invokeAll(function(t){t.afterParse&&t.afterParse(e)})}_invokeAll(e){for(let t=0,r=this.plugins.length;t<r;t++)e(this.plugins[t])}};let GLTFLightExtension=class GLTFLightExtension{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight){console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);return}let r=this.writer,i=r.json,a=r.extensionsUsed,n={};e.name&&(n.name=e.name),n.color=e.color.toArray(),n.intensity=e.intensity,e.isDirectionalLight?n.type="directional":e.isPointLight?(n.type="point",e.distance>0&&(n.range=e.distance)):e.isSpotLight&&(n.type="spot",e.distance>0&&(n.range=e.distance),n.spot={},n.spot.innerConeAngle=-((e.penumbra-1)*e.angle*1),n.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),e.target&&(e.target.parent!==e||0!==e.target.position.x||0!==e.target.position.y||-1!==e.target.position.z)&&console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),a[this.name]||(i.extensions=i.extensions||{},i.extensions[this.name]={lights:[]},a[this.name]=!0);let s=i.extensions[this.name].lights;s.push(n),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}};let I=class{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;let r=this.writer,i=r.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},i[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}},k=class{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;let r=this.writer,i=r.extensionsUsed,a={};if(a.clearcoatFactor=e.clearcoat,e.clearcoatMap){let t={index:r.processTexture(e.clearcoatMap),texCoord:e.clearcoatMap.channel};r.applyTextureTransform(t,e.clearcoatMap),a.clearcoatTexture=t}if(a.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){let t={index:r.processTexture(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};r.applyTextureTransform(t,e.clearcoatRoughnessMap),a.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){let t={index:r.processTexture(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};r.applyTextureTransform(t,e.clearcoatNormalMap),a.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},_=class{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;let r=this.writer,i=r.extensionsUsed,a={};if(a.iridescenceFactor=e.iridescence,e.iridescenceMap){let t={index:r.processTexture(e.iridescenceMap),texCoord:e.iridescenceMap.channel};r.applyTextureTransform(t,e.iridescenceMap),a.iridescenceTexture=t}if(a.iridescenceIor=e.iridescenceIOR,a.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],a.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){let t={index:r.processTexture(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};r.applyTextureTransform(t,e.iridescenceThicknessMap),a.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},O=class{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let r=this.writer,i=r.extensionsUsed,a={};if(a.transmissionFactor=e.transmission,e.transmissionMap){let t={index:r.processTexture(e.transmissionMap),texCoord:e.transmissionMap.channel};r.applyTextureTransform(t,e.transmissionMap),a.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},N=class{constructor(e){this.writer=e,this.name="KHR_materials_volume"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;let r=this.writer,i=r.extensionsUsed,a={};if(a.thicknessFactor=e.thickness,e.thicknessMap){let t={index:r.processTexture(e.thicknessMap),texCoord:e.thicknessMap.channel};r.applyTextureTransform(t,e.thicknessMap),a.thicknessTexture=t}a.attenuationDistance=e.attenuationDistance,a.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},L=class{constructor(e){this.writer=e,this.name="KHR_materials_ior"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;let r=this.writer,i=r.extensionsUsed,a={};a.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},F=class{constructor(e){this.writer=e,this.name="KHR_materials_specular"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(w)&&!e.specularIntensityMap&&!e.specularColorTexture)return;let r=this.writer,i=r.extensionsUsed,a={};if(e.specularIntensityMap){let t={index:r.processTexture(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};r.applyTextureTransform(t,e.specularIntensityMap),a.specularTexture=t}if(e.specularColorMap){let t={index:r.processTexture(e.specularColorMap),texCoord:e.specularColorMap.channel};r.applyTextureTransform(t,e.specularColorMap),a.specularColorTexture=t}a.specularFactor=e.specularIntensity,a.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},D=class{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;let r=this.writer,i=r.extensionsUsed,a={};if(e.sheenRoughnessMap){let t={index:r.processTexture(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};r.applyTextureTransform(t,e.sheenRoughnessMap),a.sheenRoughnessTexture=t}if(e.sheenColorMap){let t={index:r.processTexture(e.sheenColorMap),texCoord:e.sheenColorMap.channel};r.applyTextureTransform(t,e.sheenColorMap),a.sheenColorTexture=t}a.sheenRoughnessFactor=e.sheenRoughness,a.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},U=class{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}writeMaterial(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;let r=this.writer,i=r.extensionsUsed,a={};if(e.anisotropyMap){let t={index:r.processTexture(e.anisotropyMap)};r.applyTextureTransform(t,e.anisotropyMap),a.anisotropyTexture=t}a.anisotropyStrength=e.anisotropy,a.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},B=class{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}writeMaterial(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;let r=this.writer,i=r.extensionsUsed,a={};a.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=a,i[this.name]=!0}},V=class{parse(e,t={decodeSpeed:5,encodeSpeed:5,encoderMethod:V.MESH_EDGEBREAKER_ENCODING,quantization:[16,8,8,8,8],exportUvs:!0,exportNormals:!0,exportColor:!1}){let r,i,a;if(e instanceof d.BufferGeometry&&e.isBufferGeometry)throw Error("DRACOExporter: The first parameter of parse() is now an instance of Mesh or Points.");if(void 0===DracoEncoderModule)throw Error("THREE.DRACOExporter: required the draco_encoder to work.");let n=e.geometry,s=DracoEncoderModule(),o=new s.Encoder;if(!n.isBufferGeometry)throw Error("THREE.DRACOExporter.parse(geometry, options): geometry is not a THREE.BufferGeometry instance.");if(e instanceof d.Mesh&&e.isMesh){r=new s.MeshBuilder,i=new s.Mesh;let e=n.getAttribute("position");r.AddFloatAttributeToMesh(i,s.POSITION,e.count,e.itemSize,e.array);let a=n.getIndex();if(null!==a)r.AddFacesToMesh(i,a.count/3,a.array);else{let t=new(e.count>65535?Uint32Array:Uint16Array)(e.count);for(let e=0;e<t.length;e++)t[e]=e;r.AddFacesToMesh(i,e.count,t)}if(t.exportNormals){let e=n.getAttribute("normal");void 0!==e&&r.AddFloatAttributeToMesh(i,s.NORMAL,e.count,e.itemSize,e.array)}if(t.exportUvs){let e=n.getAttribute("uv");void 0!==e&&r.AddFloatAttributeToMesh(i,s.TEX_COORD,e.count,e.itemSize,e.array)}if(t.exportColor){let e=n.getAttribute("color");void 0!==e&&r.AddFloatAttributeToMesh(i,s.COLOR,e.count,e.itemSize,e.array)}}else if(e instanceof d.Points&&e.isPoints){r=new s.PointCloudBuilder,i=new s.PointCloud;let e=n.getAttribute("position");if(r.AddFloatAttribute(i,s.POSITION,e.count,e.itemSize,e.array),t.exportColor){let e=n.getAttribute("color");void 0!==e&&r.AddFloatAttribute(i,s.COLOR,e.count,e.itemSize,e.array)}}else throw Error("DRACOExporter: Unsupported object type.");let l=new s.DracoInt8Array,c=void 0!==t.encodeSpeed?t.encodeSpeed:5,u=void 0!==t.decodeSpeed?t.decodeSpeed:5;if(o.SetSpeedOptions(c,u),void 0!==t.encoderMethod&&o.SetEncodingMethod(t.encoderMethod),void 0!==t.quantization)for(let e=0;e<5;e++)void 0!==t.quantization[e]&&o.SetAttributeQuantization(e,t.quantization[e]);if(a=e instanceof d.Mesh&&e.isMesh?o.EncodeMeshToDracoBuffer(i,l):o.EncodePointCloudToDracoBuffer(i,!0,l),s.destroy(i),0===a)throw Error("THREE.DRACOExporter: Draco encoding failed.");let h=new Int8Array(new ArrayBuffer(a));for(let e=0;e<a;e++)h[e]=l.GetValue(e);return s.destroy(l),s.destroy(o),s.destroy(r),h}};__publicField(V,"MESH_SEQUENTIAL_ENCODING",0),__publicField(V,"TRIANGULAR_MESH",1),__publicField(V,"POSITION",0),__publicField(V,"NORMAL",1),__publicField(V,"COLOR",2),__publicField(V,"TEX_COORD",3),__publicField(V,"GENERIC",4);let G=new d.Vector3,z=new d.Matrix4;function getPosition(e,t){return G.setFromMatrixPosition(e.matrixWorld).applyMatrix4(t)}function setPositionOfBoneToAttributeArray(e,t,r,i){let a=getPosition(r,i);e[3*t+0]=a.x,e[3*t+1]=a.y,e[3*t+2]=a.z}let CapsuleGeometry=class CapsuleGeometry extends null{constructor(e=1,t=1,r=4,i=8){let a=new Path;a.absarc(0,-t/2,e,1.5*Math.PI,0),a.absarc(0,t/2,e,0,.5*Math.PI),super(a.getPoints(r),i),this.type="CapsuleGeometry",this.parameters={radius:e,height:t,capSegments:r,radialSegments:i}}static fromJSON(e){return new CapsuleGeometry(e.radius,e.length,e.capSegments,e.radialSegments)}};let H=new d.Vector3,j=new d.Quaternion,W=new d.Vector3,K=new d.Matrix4,X=0,q=parseInt(d.REVISION.replace(/\D+/g,"")),Y=class extends d.Mesh{constructor(e,t={}){super(e),this.isReflector=!0,this.type="Reflector",this.camera=new d.PerspectiveCamera;let r=this,i=new d.Color(void 0!==t.color?t.color:8355711),a=t.textureWidth||512,n=t.textureHeight||512,s=t.clipBias||0,o=t.shader||Y.ReflectorShader,l=void 0!==t.multisample?t.multisample:4,c=new d.Plane,u=new d.Vector3,h=new d.Vector3,p=new d.Vector3,f=new d.Matrix4,m=new d.Vector3(0,0,-1),g=new d.Vector4,v=new d.Vector3,y=new d.Vector3,x=new d.Vector4,b=new d.Matrix4,T=this.camera,S=new d.WebGLRenderTarget(a,n,{samples:l,type:d.HalfFloatType}),E=new d.ShaderMaterial({uniforms:d.UniformsUtils.clone(o.uniforms),fragmentShader:o.fragmentShader,vertexShader:o.vertexShader});E.uniforms.tDiffuse.value=S.texture,E.uniforms.color.value=i,E.uniforms.textureMatrix.value=b,this.material=E,this.onBeforeRender=function(e,t,i){if(h.setFromMatrixPosition(r.matrixWorld),p.setFromMatrixPosition(i.matrixWorld),f.extractRotation(r.matrixWorld),u.set(0,0,1),u.applyMatrix4(f),v.subVectors(h,p),v.dot(u)>0)return;v.reflect(u).negate(),v.add(h),f.extractRotation(i.matrixWorld),m.set(0,0,-1),m.applyMatrix4(f),m.add(p),y.subVectors(h,m),y.reflect(u).negate(),y.add(h),T.position.copy(v),T.up.set(0,1,0),T.up.applyMatrix4(f),T.up.reflect(u),T.lookAt(y),T.far=i.far,T.updateMatrixWorld(),T.projectionMatrix.copy(i.projectionMatrix),b.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),b.multiply(T.projectionMatrix),b.multiply(T.matrixWorldInverse),b.multiply(r.matrixWorld),c.setFromNormalAndCoplanarPoint(u,h),c.applyMatrix4(T.matrixWorldInverse),g.set(c.normal.x,c.normal.y,c.normal.z,c.constant);let a=T.projectionMatrix;x.x=(Math.sign(g.x)+a.elements[8])/a.elements[0],x.y=(Math.sign(g.y)+a.elements[9])/a.elements[5],x.z=-1,x.w=(1+a.elements[10])/a.elements[14],g.multiplyScalar(2/g.dot(x)),a.elements[2]=g.x,a.elements[6]=g.y,a.elements[10]=g.z+1-s,a.elements[14]=g.w,r.visible=!1;let n=e.getRenderTarget(),o=e.xr.enabled,l=e.shadowMap.autoUpdate,E=e.toneMapping,R=!1;R="outputColorSpace"in e?"srgb"===e.outputColorSpace:3001===e.outputEncoding,e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,"outputColorSpace"in e?e.outputColorSpace="linear-srgb":e.outputEncoding=3e3,e.toneMapping=d.NoToneMapping,e.setRenderTarget(S),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,T),e.xr.enabled=o,e.shadowMap.autoUpdate=l,e.toneMapping=E,"outputColorSpace"in e?e.outputColorSpace=R?"srgb":"srgb-linear":e.outputEncoding=R?3001:3e3,e.setRenderTarget(n);let A=i.viewport;void 0!==A&&e.state.viewport(A),r.visible=!0},this.getRenderTarget=function(){return S},this.dispose=function(){S.dispose(),r.material.dispose()}}};__publicField(Y,"ReflectorShader",{uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:`
		uniform mat4 textureMatrix;
		varying vec4 vUv;

		#include <common>
		#include <logdepthbuf_pars_vertex>

		void main() {

			vUv = textureMatrix * vec4( position, 1.0 );

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

			#include <logdepthbuf_vertex>

		}`,fragmentShader:`
		uniform vec3 color;
		uniform sampler2D tDiffuse;
		varying vec4 vUv;

		#include <logdepthbuf_pars_fragment>

		float blendOverlay( float base, float blend ) {

			return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );

		}

		vec3 blendOverlay( vec3 base, vec3 blend ) {

			return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );

		}

		void main() {

			#include <logdepthbuf_fragment>

			vec4 base = texture2DProj( tDiffuse, vUv );
			gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );

			#include <tonemapping_fragment>
			#include <${q>=154?"colorspace_fragment":"encodings_fragment"}>

		}`});let Z=class extends d.Mesh{constructor(e,t={}){super(e),this.isRefractor=!0,this.type="Refractor",this.camera=new d.PerspectiveCamera;let r=this,i=new d.Color(void 0!==t.color?t.color:8355711),a=t.textureWidth||512,n=t.textureHeight||512,s=t.clipBias||0,o=t.shader||Z.RefractorShader,l=void 0!==t.multisample?t.multisample:4,c=this.camera;c.matrixAutoUpdate=!1,c.userData.refractor=!0;let u=new d.Plane,h=new d.Matrix4,p=new d.WebGLRenderTarget(a,n,{samples:l,type:d.HalfFloatType});this.material=new d.ShaderMaterial({uniforms:d.UniformsUtils.clone(o.uniforms),vertexShader:o.vertexShader,fragmentShader:o.fragmentShader,transparent:!0}),this.material.uniforms.color.value=i,this.material.uniforms.tDiffuse.value=p.texture,this.material.uniforms.textureMatrix.value=h;let f=function(){let e=new d.Vector3,t=new d.Vector3,i=new d.Matrix4,a=new d.Vector3,n=new d.Vector3;return function(s){return e.setFromMatrixPosition(r.matrixWorld),t.setFromMatrixPosition(s.matrixWorld),a.subVectors(e,t),i.extractRotation(r.matrixWorld),n.set(0,0,1),n.applyMatrix4(i),0>a.dot(n)}}(),m=function(){let e=new d.Vector3,t=new d.Vector3,i=new d.Quaternion,a=new d.Vector3;return function(){r.matrixWorld.decompose(t,i,a),e.set(0,0,1).applyQuaternion(i).normalize(),e.negate(),u.setFromNormalAndCoplanarPoint(e,t)}}(),g=function(){let e=new d.Plane,t=new d.Vector4,r=new d.Vector4;return function(i){c.matrixWorld.copy(i.matrixWorld),c.matrixWorldInverse.copy(c.matrixWorld).invert(),c.projectionMatrix.copy(i.projectionMatrix),c.far=i.far,e.copy(u),e.applyMatrix4(c.matrixWorldInverse),t.set(e.normal.x,e.normal.y,e.normal.z,e.constant);let a=c.projectionMatrix;r.x=(Math.sign(t.x)+a.elements[8])/a.elements[0],r.y=(Math.sign(t.y)+a.elements[9])/a.elements[5],r.z=-1,r.w=(1+a.elements[10])/a.elements[14],t.multiplyScalar(2/t.dot(r)),a.elements[2]=t.x,a.elements[6]=t.y,a.elements[10]=t.z+1-s,a.elements[14]=t.w}}();function updateTextureMatrix(e){h.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),h.multiply(e.projectionMatrix),h.multiply(e.matrixWorldInverse),h.multiply(r.matrixWorld)}function render(e,t,i){r.visible=!1;let a=e.getRenderTarget(),n=e.xr.enabled,s=e.shadowMap.autoUpdate,o=e.toneMapping,l=!1;l="outputColorSpace"in e?"srgb"===e.outputColorSpace:3001===e.outputEncoding,e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,"outputColorSpace"in e?e.outputColorSpace="linear-srgb":e.outputEncoding=3e3,e.toneMapping=d.NoToneMapping,e.setRenderTarget(p),!1===e.autoClear&&e.clear(),e.render(t,c),e.xr.enabled=n,e.shadowMap.autoUpdate=s,e.toneMapping=o,e.setRenderTarget(a),"outputColorSpace"in e?e.outputColorSpace=l?"srgb":"srgb-linear":e.outputEncoding=l?3001:3e3;let u=i.viewport;void 0!==u&&e.state.viewport(u),r.visible=!0}this.onBeforeRender=function(e,t,r){!0!==r.userData.refractor&&!0!=!f(r)&&(m(),updateTextureMatrix(r),g(r),render(e,t,r))},this.getRenderTarget=function(){return p},this.dispose=function(){p.dispose(),r.material.dispose()}}};__publicField(Z,"RefractorShader",{uniforms:{color:{value:null},tDiffuse:{value:null},textureMatrix:{value:null}},vertexShader:`

		uniform mat4 textureMatrix;

		varying vec4 vUv;

		void main() {

			vUv = textureMatrix * vec4( position, 1.0 );
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform vec3 color;
		uniform sampler2D tDiffuse;

		varying vec4 vUv;

		float blendOverlay( float base, float blend ) {

			return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );

		}

		vec3 blendOverlay( vec3 base, vec3 blend ) {

			return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );

		}

		void main() {

			vec4 base = texture2DProj( tDiffuse, vUv );
			gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );

			#include <tonemapping_fragment>
			#include <${q>=154?"colorspace_fragment":"encodings_fragment"}>

		}`});let $=new d.BufferGeometry,Q=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),J=new d.InterleavedBuffer(Q,5);$.setIndex([0,1,2,0,2,3]),$.setAttribute("position",new d.InterleavedBufferAttribute(J,3,0,!1)),$.setAttribute("uv",new d.InterleavedBufferAttribute(J,2,3,!1));let ee=class extends d.Mesh{constructor(){super(ee.Geometry,new d.MeshBasicMaterial({opacity:0,transparent:!0})),this.isLensflare=!0,this.type="Lensflare",this.frustumCulled=!1,this.renderOrder=1/0;let e=new d.Vector3,t=new d.Vector3,r=new d.DataTexture(new Uint8Array(768),16,16,d.RGBAFormat);r.minFilter=d.NearestFilter,r.magFilter=d.NearestFilter,r.wrapS=d.ClampToEdgeWrapping,r.wrapT=d.ClampToEdgeWrapping;let i=new d.DataTexture(new Uint8Array(768),16,16,d.RGBAFormat);i.minFilter=d.NearestFilter,i.magFilter=d.NearestFilter,i.wrapS=d.ClampToEdgeWrapping,i.wrapT=d.ClampToEdgeWrapping;let a=ee.Geometry,n=new d.RawShaderMaterial({uniforms:{scale:{value:null},screenPosition:{value:null}},vertexShader:`

				precision highp float;

				uniform vec3 screenPosition;
				uniform vec2 scale;

				attribute vec3 position;

				void main() {

					gl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );

				}`,fragmentShader:`

				precision highp float;

				void main() {

					gl_FragColor = vec4( 1.0, 0.0, 1.0, 1.0 );

				}`,depthTest:!0,depthWrite:!1,transparent:!1}),s=new d.RawShaderMaterial({uniforms:{map:{value:r},scale:{value:null},screenPosition:{value:null}},vertexShader:`

				precision highp float;

				uniform vec3 screenPosition;
				uniform vec2 scale;

				attribute vec3 position;
				attribute vec2 uv;

				varying vec2 vUV;

				void main() {

					vUV = uv;

					gl_Position = vec4( position.xy * scale + screenPosition.xy, screenPosition.z, 1.0 );

				}`,fragmentShader:`

				precision highp float;

				uniform sampler2D map;

				varying vec2 vUV;

				void main() {

					gl_FragColor = texture2D( map, vUV );

				}`,depthTest:!1,depthWrite:!1,transparent:!1}),o=new d.Mesh(a,n),l=[],c=LensflareElement.Shader,u=new d.RawShaderMaterial({uniforms:{map:{value:null},occlusionMap:{value:i},color:{value:new d.Color(16777215)},scale:{value:new d.Vector2},screenPosition:{value:new d.Vector3}},vertexShader:c.vertexShader,fragmentShader:c.fragmentShader,blending:d.AdditiveBlending,transparent:!0,depthWrite:!1}),h=new d.Mesh(a,u);this.addElement=function(e){l.push(e)};let p=new d.Vector2,f=new d.Vector2,m=new d.Box2,g=new d.Vector4;this.onBeforeRender=function(c,d,v){c.getCurrentViewport(g);let y=g.w/g.z,x=g.z/2,b=g.w/2,T=16/g.w;if(p.set(T*y,T),m.min.set(g.x,g.y),m.max.set(g.x+(g.z-16),g.y+(g.w-16)),t.setFromMatrixPosition(this.matrixWorld),t.applyMatrix4(v.matrixWorldInverse),!(t.z>0)&&(e.copy(t).applyMatrix4(v.projectionMatrix),f.x=g.x+e.x*x+x-8,f.y=g.y+e.y*b+b-8,m.containsPoint(f))){c.copyFramebufferToTexture(f,r);let t=n.uniforms;t.scale.value=p,t.screenPosition.value=e,c.renderBufferDirect(v,null,a,n,o,null),c.copyFramebufferToTexture(f,i),(t=s.uniforms).scale.value=p,t.screenPosition.value=e,c.renderBufferDirect(v,null,a,s,o,null);let d=-(2*e.x),m=-(2*e.y);for(let t=0,r=l.length;t<r;t++){let r=l[t],i=u.uniforms;i.color.value.copy(r.color),i.map.value=r.texture,i.screenPosition.value.x=e.x+d*r.distance,i.screenPosition.value.y=e.y+m*r.distance,T=r.size/g.w;let n=g.w/g.z;i.scale.value.set(T*n,T),u.uniformsNeedUpdate=!0,c.renderBufferDirect(v,null,a,u,h,null)}}},this.dispose=function(){n.dispose(),s.dispose(),u.dispose(),r.dispose(),i.dispose();for(let e=0,t=l.length;e<t;e++)l[e].texture.dispose()}}};__publicField(ee,"Geometry",$);let LensflareElement=class LensflareElement{constructor(e,t=1,r=0,i=new d.Color(16777215)){this.texture=e,this.size=t,this.distance=r,this.color=i}};__publicField(LensflareElement,"Shader",{uniforms:{map:{value:null},occlusionMap:{value:null},color:{value:null},scale:{value:null},screenPosition:{value:null}},vertexShader:`

		precision highp float;

		uniform vec3 screenPosition;
		uniform vec2 scale;

		uniform sampler2D occlusionMap;

		attribute vec3 position;
		attribute vec2 uv;

		varying vec2 vUV;
		varying float vVisibility;

		void main() {

			vUV = uv;

			vec2 pos = position.xy;

			vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );
			visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );
			visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );
			visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );
			visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );
			visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );
			visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );
			visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );
			visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );

			vVisibility =        visibility.r / 9.0;
			vVisibility *= 1.0 - visibility.g / 9.0;
			vVisibility *=       visibility.b / 9.0;

			gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );

		}`,fragmentShader:`

		precision highp float;

		uniform sampler2D map;
		uniform vec3 color;

		varying vec2 vUV;
		varying float vVisibility;

		void main() {

			vec4 texture = texture2D( map, vUV );
			texture.a *= vVisibility;
			gl_FragColor = texture;
			gl_FragColor.rgb *= color;

		}`});let SimplexNoise=class SimplexNoise{constructor(e=Math){__publicField(this,"grad3",[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]]),__publicField(this,"grad4",[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]]),__publicField(this,"p",[]),__publicField(this,"perm",[]),__publicField(this,"simplex",[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]),__publicField(this,"dot",(e,t,r)=>e[0]*t+e[1]*r),__publicField(this,"dot3",(e,t,r,i)=>e[0]*t+e[1]*r+e[2]*i),__publicField(this,"dot4",(e,t,r,i,a)=>e[0]*t+e[1]*r+e[2]*i+e[3]*a),__publicField(this,"noise",(e,t)=>{let r,i,a;let n=(e+t)*(.5*(Math.sqrt(3)-1)),s=Math.floor(e+n),o=Math.floor(t+n),l=(3-Math.sqrt(3))/6,c=(s+o)*l,u=e-(s-c),h=t-(o-c),p=0,d=1;u>h&&(p=1,d=0);let f=u-p+l,m=h-d+l,g=u-1+2*l,v=h-1+2*l,y=255&s,x=255&o,b=this.perm[y+this.perm[x]]%12,T=this.perm[y+p+this.perm[x+d]]%12,S=this.perm[y+1+this.perm[x+1]]%12,E=.5-u*u-h*h;E<0?r=0:(E*=E,r=E*E*this.dot(this.grad3[b],u,h));let R=.5-f*f-m*m;R<0?i=0:(R*=R,i=R*R*this.dot(this.grad3[T],f,m));let A=.5-g*g-v*v;return A<0?a=0:(A*=A,a=A*A*this.dot(this.grad3[S],g,v)),70*(r+i+a)}),__publicField(this,"noise3d",(e,t,r)=>{let i,a,n,s,o,l,c,u,h,p;let d=(e+t+r)*(1/3),f=Math.floor(e+d),m=Math.floor(t+d),g=Math.floor(r+d),v=1/6,y=(f+m+g)*v,x=e-(f-y),b=t-(m-y),T=r-(g-y);x>=b?b>=T?(o=1,l=0,c=0,u=1,h=1,p=0):(x>=T?(o=1,l=0,c=0):(o=0,l=0,c=1),u=1,h=0,p=1):b<T?(o=0,l=0,c=1,u=0,h=1,p=1):x<T?(o=0,l=1,c=0,u=0,h=1,p=1):(o=0,l=1,c=0,u=1,h=1,p=0);let S=x-o+v,E=b-l+v,R=T-c+v,A=x-u+2*v,C=b-h+2*v,M=T-p+2*v,P=x-1+3*v,w=b-1+3*v,I=T-1+3*v,k=255&f,_=255&m,O=255&g,N=this.perm[k+this.perm[_+this.perm[O]]]%12,L=this.perm[k+o+this.perm[_+l+this.perm[O+c]]]%12,F=this.perm[k+u+this.perm[_+h+this.perm[O+p]]]%12,D=this.perm[k+1+this.perm[_+1+this.perm[O+1]]]%12,U=.6-x*x-b*b-T*T;U<0?i=0:(U*=U,i=U*U*this.dot3(this.grad3[N],x,b,T));let B=.6-S*S-E*E-R*R;B<0?a=0:(B*=B,a=B*B*this.dot3(this.grad3[L],S,E,R));let V=.6-A*A-C*C-M*M;V<0?n=0:(V*=V,n=V*V*this.dot3(this.grad3[F],A,C,M));let G=.6-P*P-w*w-I*I;return G<0?s=0:(G*=G,s=G*G*this.dot3(this.grad3[D],P,w,I)),32*(i+a+n+s)}),__publicField(this,"noise4d",(e,t,r,i)=>{let a,n,s,o,l,c,u,h,p,d,f,m,g,v,y,x,b;let T=this.grad4,S=this.simplex,E=this.perm,R=(5-Math.sqrt(5))/20,A=(e+t+r+i)*((Math.sqrt(5)-1)/4),C=Math.floor(e+A),M=Math.floor(t+A),P=Math.floor(r+A),w=Math.floor(i+A),I=(C+M+P+w)*R,k=e-(C-I),_=t-(M-I),O=r-(P-I),N=i-(w-I),L=k>_?32:0,F=k>O?16:0,D=_>O?8:0,U=k>N?4:0,B=_>N?2:0,V=O>N?1:0,G=L+F+D+U+B+V;c=S[G][0]>=3?1:0,u=S[G][1]>=3?1:0,h=S[G][2]>=3?1:0,p=S[G][3]>=3?1:0,d=S[G][0]>=2?1:0,f=S[G][1]>=2?1:0,m=S[G][2]>=2?1:0,g=S[G][3]>=2?1:0,v=S[G][0]>=1?1:0,y=S[G][1]>=1?1:0,x=S[G][2]>=1?1:0,b=S[G][3]>=1?1:0;let z=k-c+R,H=_-u+R,j=O-h+R,W=N-p+R,K=k-d+2*R,X=_-f+2*R,q=O-m+2*R,Y=N-g+2*R,Z=k-v+3*R,$=_-y+3*R,Q=O-x+3*R,J=N-b+3*R,ee=k-1+4*R,et=_-1+4*R,er=O-1+4*R,ei=N-1+4*R,ea=255&C,en=255&M,es=255&P,eo=255&w,el=E[ea+E[en+E[es+E[eo]]]]%32,ec=E[ea+c+E[en+u+E[es+h+E[eo+p]]]]%32,eu=E[ea+d+E[en+f+E[es+m+E[eo+g]]]]%32,eh=E[ea+v+E[en+y+E[es+x+E[eo+b]]]]%32,ep=E[ea+1+E[en+1+E[es+1+E[eo+1]]]]%32,ed=.6-k*k-_*_-O*O-N*N;ed<0?a=0:(ed*=ed,a=ed*ed*this.dot4(T[el],k,_,O,N));let ef=.6-z*z-H*H-j*j-W*W;ef<0?n=0:(ef*=ef,n=ef*ef*this.dot4(T[ec],z,H,j,W));let em=.6-K*K-X*X-q*q-Y*Y;em<0?s=0:(em*=em,s=em*em*this.dot4(T[eu],K,X,q,Y));let eg=.6-Z*Z-$*$-Q*Q-J*J;eg<0?o=0:(eg*=eg,o=eg*eg*this.dot4(T[eh],Z,$,Q,J));let ev=.6-ee*ee-et*et-er*er-ei*ei;return ev<0?l=0:(ev*=ev,l=ev*ev*this.dot4(T[ep],ee,et,er,ei)),27*(a+n+s+o+l)});for(let t=0;t<256;t++)this.p[t]=Math.floor(256*e.random());for(let e=0;e<512;e++)this.perm[e]=this.p[255&e]}};let et=class extends d.BufferGeometry{constructor(e={}){super(),this.isLightningStrike=!0,this.type="LightningStrike",this.init(et.copyParameters(e,e)),this.createMesh()}static createRandomGenerator(){let e=[];for(let t=0;t<2053;t++)e.push(Math.random());let t={currentSeed:0,random:function(){let r=e[t.currentSeed];return t.currentSeed=(t.currentSeed+1)%2053,r},getSeed:function(){return t.currentSeed/2053},setSeed:function(e){t.currentSeed=Math.floor(2053*e)%2053}};return t}static copyParameters(e={},t={}){let vecCopy=function(r){return t===e?r:r.clone()};return e.sourceOffset=void 0!==t.sourceOffset?vecCopy(t.sourceOffset):new d.Vector3(0,100,0),e.destOffset=void 0!==t.destOffset?vecCopy(t.destOffset):new d.Vector3(0,0,0),e.timeScale=void 0!==t.timeScale?t.timeScale:1,e.roughness=void 0!==t.roughness?t.roughness:.9,e.straightness=void 0!==t.straightness?t.straightness:.7,e.up0=void 0!==t.up0?vecCopy(t.up0):new d.Vector3(0,0,1),e.up1=void 0!==t.up1?vecCopy(t.up1):new d.Vector3(0,0,1),e.radius0=void 0!==t.radius0?t.radius0:1,e.radius1=void 0!==t.radius1?t.radius1:1,e.radius0Factor=void 0!==t.radius0Factor?t.radius0Factor:.5,e.radius1Factor=void 0!==t.radius1Factor?t.radius1Factor:.2,e.minRadius=void 0!==t.minRadius?t.minRadius:.2,e.isEternal=void 0!==t.isEternal?t.isEternal:void 0===t.birthTime||void 0===t.deathTime,e.birthTime=t.birthTime,e.deathTime=t.deathTime,e.propagationTimeFactor=void 0!==t.propagationTimeFactor?t.propagationTimeFactor:.1,e.vanishingTimeFactor=void 0!==t.vanishingTimeFactor?t.vanishingTimeFactor:.9,e.subrayPeriod=void 0!==t.subrayPeriod?t.subrayPeriod:4,e.subrayDutyCycle=void 0!==t.subrayDutyCycle?t.subrayDutyCycle:.6,e.maxIterations=void 0!==t.maxIterations?t.maxIterations:9,e.isStatic=void 0!==t.isStatic&&t.isStatic,e.ramification=void 0!==t.ramification?t.ramification:5,e.maxSubrayRecursion=void 0!==t.maxSubrayRecursion?t.maxSubrayRecursion:3,e.recursionProbability=void 0!==t.recursionProbability?t.recursionProbability:.6,e.generateUVs=void 0!==t.generateUVs&&t.generateUVs,e.randomGenerator=t.randomGenerator,e.noiseSeed=t.noiseSeed,e.onDecideSubrayCreation=t.onDecideSubrayCreation,e.onSubrayCreation=t.onSubrayCreation,e}update(e){this.isStatic||(this.rayParameters.isEternal||this.rayParameters.birthTime<=e&&e<=this.rayParameters.deathTime?(this.updateMesh(e),e<this.subrays[0].endPropagationTime?this.state=et.RAY_PROPAGATING:e>this.subrays[0].beginVanishingTime?this.state=et.RAY_VANISHING:this.state=et.RAY_STEADY,this.visible=!0):(this.visible=!1,e<this.rayParameters.birthTime?this.state=et.RAY_UNBORN:this.state=et.RAY_EXTINGUISHED))}init(e){this.rayParameters=e,this.maxIterations=void 0!==e.maxIterations?Math.floor(e.maxIterations):9,e.maxIterations=this.maxIterations,this.isStatic=void 0!==e.isStatic&&e.isStatic,e.isStatic=this.isStatic,this.ramification=void 0!==e.ramification?Math.floor(e.ramification):5,e.ramification=this.ramification,this.maxSubrayRecursion=void 0!==e.maxSubrayRecursion?Math.floor(e.maxSubrayRecursion):3,e.maxSubrayRecursion=this.maxSubrayRecursion,this.recursionProbability=void 0!==e.recursionProbability?e.recursionProbability:.6,e.recursionProbability=this.recursionProbability,this.generateUVs=void 0!==e.generateUVs&&e.generateUVs,e.generateUVs=this.generateUVs,void 0!==e.randomGenerator?(this.randomGenerator=e.randomGenerator,this.seedGenerator=e.randomGenerator,void 0!==e.noiseSeed&&this.seedGenerator.setSeed(e.noiseSeed)):(this.randomGenerator=et.createRandomGenerator(),this.seedGenerator=Math),void 0!==e.onDecideSubrayCreation?this.onDecideSubrayCreation=e.onDecideSubrayCreation:(this.createDefaultSubrayCreationCallbacks(),void 0!==e.onSubrayCreation&&(this.onSubrayCreation=e.onSubrayCreation)),this.state=et.RAY_INITIALIZED,this.maxSubrays=Math.ceil(1+Math.pow(this.ramification,Math.max(0,this.maxSubrayRecursion-1))),e.maxSubrays=this.maxSubrays,this.maxRaySegments=2*(1<<this.maxIterations),this.subrays=[];for(let e=0;e<this.maxSubrays;e++)this.subrays.push(this.createSubray());this.raySegments=[];for(let e=0;e<this.maxRaySegments;e++)this.raySegments.push(this.createSegment());this.time=0,this.timeFraction=0,this.currentSegmentCallback=null,this.currentCreateTriangleVertices=this.generateUVs?this.createTriangleVerticesWithUVs:this.createTriangleVerticesWithoutUVs,this.numSubrays=0,this.currentSubray=null,this.currentSegmentIndex=0,this.isInitialSegment=!1,this.subrayProbability=0,this.currentVertex=0,this.currentIndex=0,this.currentCoordinate=0,this.currentUVCoordinate=0,this.vertices=null,this.uvs=null,this.indices=null,this.positionAttribute=null,this.uvsAttribute=null,this.simplexX=new SimplexNoise(this.seedGenerator),this.simplexY=new SimplexNoise(this.seedGenerator),this.simplexZ=new SimplexNoise(this.seedGenerator),this.forwards=new d.Vector3,this.forwardsFill=new d.Vector3,this.side=new d.Vector3,this.down=new d.Vector3,this.middlePos=new d.Vector3,this.middleLinPos=new d.Vector3,this.newPos=new d.Vector3,this.vPos=new d.Vector3,this.cross1=new d.Vector3}createMesh(){let e=1<<this.maxIterations,t=3*(e+1)*this.maxSubrays,r=18*e*this.maxSubrays;this.vertices=new Float32Array(3*t),this.indices=new Uint32Array(r),this.generateUVs&&(this.uvs=new Float32Array(2*t)),this.fillMesh(0),this.setIndex(new d.Uint32BufferAttribute(this.indices,1)),this.positionAttribute=new d.Float32BufferAttribute(this.vertices,3),this.setAttribute("position",this.positionAttribute),this.generateUVs&&(this.uvsAttribute=new d.Float32BufferAttribute(new Float32Array(this.uvs),2),this.setAttribute("uv",this.uvsAttribute)),!this.isStatic&&(this.index.usage=d.DynamicDrawUsage,this.positionAttribute.usage=d.DynamicDrawUsage,this.generateUVs&&(this.uvsAttribute.usage=d.DynamicDrawUsage)),this.vertices=this.positionAttribute.array,this.indices=this.index.array,this.generateUVs&&(this.uvs=this.uvsAttribute.array)}updateMesh(e){this.fillMesh(e),this.drawRange.count=this.currentIndex,this.index.needsUpdate=!0,this.positionAttribute.needsUpdate=!0,this.generateUVs&&(this.uvsAttribute.needsUpdate=!0)}fillMesh(e){let t=this;this.currentVertex=0,this.currentIndex=0,this.currentCoordinate=0,this.currentUVCoordinate=0,this.fractalRay(e,function(r){let i=t.currentSubray;!(e<i.birthTime)&&(this.rayParameters.isEternal&&0==t.currentSubray.recursion?(t.createPrism(r),t.onDecideSubrayCreation(r,t)):e<i.endPropagationTime?t.timeFraction>=r.fraction0*i.propagationTimeFactor&&(t.createPrism(r),t.onDecideSubrayCreation(r,t)):(e<i.beginVanishingTime?t.createPrism(r):t.timeFraction<=i.vanishingTimeFactor+r.fraction1*(1-i.vanishingTimeFactor)&&t.createPrism(r),t.onDecideSubrayCreation(r,t)))})}addNewSubray(){return this.subrays[this.numSubrays++]}initSubray(e,t){e.pos0.copy(t.sourceOffset),e.pos1.copy(t.destOffset),e.up0.copy(t.up0),e.up1.copy(t.up1),e.radius0=t.radius0,e.radius1=t.radius1,e.birthTime=t.birthTime,e.deathTime=t.deathTime,e.timeScale=t.timeScale,e.roughness=t.roughness,e.straightness=t.straightness,e.propagationTimeFactor=t.propagationTimeFactor,e.vanishingTimeFactor=t.vanishingTimeFactor,e.maxIterations=this.maxIterations,e.seed=void 0!==t.noiseSeed?t.noiseSeed:0,e.recursion=0}fractalRay(e,t){this.time=e,this.currentSegmentCallback=t,this.numSubrays=0,this.initSubray(this.addNewSubray(),this.rayParameters);for(let t=0;t<this.numSubrays;t++){let r=this.subrays[t];this.currentSubray=r,this.randomGenerator.setSeed(r.seed),r.endPropagationTime=d.MathUtils.lerp(r.birthTime,r.deathTime,r.propagationTimeFactor),r.beginVanishingTime=d.MathUtils.lerp(r.deathTime,r.birthTime,1-r.vanishingTimeFactor);let i=this.randomGenerator.random;r.linPos0.set(i(),i(),i()).multiplyScalar(1e3),r.linPos1.set(i(),i(),i()).multiplyScalar(1e3),this.timeFraction=(e-r.birthTime)/(r.deathTime-r.birthTime),this.currentSegmentIndex=0,this.isInitialSegment=!0;let a=this.getNewSegment();a.iteration=0,a.pos0.copy(r.pos0),a.pos1.copy(r.pos1),a.linPos0.copy(r.linPos0),a.linPos1.copy(r.linPos1),a.up0.copy(r.up0),a.up1.copy(r.up1),a.radius0=r.radius0,a.radius1=r.radius1,a.fraction0=0,a.fraction1=1,a.positionVariationFactor=1-r.straightness,this.subrayProbability=this.ramification*Math.pow(this.recursionProbability,r.recursion)/(1<<r.maxIterations),this.fractalRayRecursive(a)}this.currentSegmentCallback=null,this.currentSubray=null}fractalRayRecursive(e){if(e.iteration>=this.currentSubray.maxIterations){this.currentSegmentCallback(e);return}this.forwards.subVectors(e.pos1,e.pos0);let t=this.forwards.length();t<1e-6&&(this.forwards.set(0,0,.01),t=this.forwards.length());let r=(e.radius0+e.radius1)*.5,i=(e.fraction0+e.fraction1)*.5,a=this.time*this.currentSubray.timeScale*Math.pow(2,e.iteration);this.middlePos.lerpVectors(e.pos0,e.pos1,.5),this.middleLinPos.lerpVectors(e.linPos0,e.linPos1,.5);let n=this.middleLinPos;this.newPos.set(this.simplexX.noise4d(n.x,n.y,n.z,a),this.simplexY.noise4d(n.x,n.y,n.z,a),this.simplexZ.noise4d(n.x,n.y,n.z,a)),this.newPos.multiplyScalar(e.positionVariationFactor*t),this.newPos.add(this.middlePos);let s=this.getNewSegment();s.pos0.copy(e.pos0),s.pos1.copy(this.newPos),s.linPos0.copy(e.linPos0),s.linPos1.copy(this.middleLinPos),s.up0.copy(e.up0),s.up1.copy(e.up1),s.radius0=e.radius0,s.radius1=r,s.fraction0=e.fraction0,s.fraction1=i,s.positionVariationFactor=e.positionVariationFactor*this.currentSubray.roughness,s.iteration=e.iteration+1;let o=this.getNewSegment();o.pos0.copy(this.newPos),o.pos1.copy(e.pos1),o.linPos0.copy(this.middleLinPos),o.linPos1.copy(e.linPos1),this.cross1.crossVectors(e.up0,this.forwards.normalize()),o.up0.crossVectors(this.forwards,this.cross1).normalize(),o.up1.copy(e.up1),o.radius0=r,o.radius1=e.radius1,o.fraction0=i,o.fraction1=e.fraction1,o.positionVariationFactor=e.positionVariationFactor*this.currentSubray.roughness,o.iteration=e.iteration+1,this.fractalRayRecursive(s),this.fractalRayRecursive(o)}createPrism(e){this.forwardsFill.subVectors(e.pos1,e.pos0).normalize(),this.isInitialSegment&&(this.currentCreateTriangleVertices(e.pos0,e.up0,this.forwardsFill,e.radius0,0),this.isInitialSegment=!1),this.currentCreateTriangleVertices(e.pos1,e.up0,this.forwardsFill,e.radius1,e.fraction1),this.createPrismFaces()}createTriangleVerticesWithoutUVs(e,t,r,i){this.side.crossVectors(t,r).multiplyScalar(i*et.COS30DEG),this.down.copy(t).multiplyScalar(-i*et.SIN30DEG);let a=this.vPos,n=this.vertices;a.copy(e).sub(this.side).add(this.down),n[this.currentCoordinate++]=a.x,n[this.currentCoordinate++]=a.y,n[this.currentCoordinate++]=a.z,a.copy(e).add(this.side).add(this.down),n[this.currentCoordinate++]=a.x,n[this.currentCoordinate++]=a.y,n[this.currentCoordinate++]=a.z,a.copy(t).multiplyScalar(i).add(e),n[this.currentCoordinate++]=a.x,n[this.currentCoordinate++]=a.y,n[this.currentCoordinate++]=a.z,this.currentVertex+=3}createTriangleVerticesWithUVs(e,t,r,i,a){this.side.crossVectors(t,r).multiplyScalar(i*et.COS30DEG),this.down.copy(t).multiplyScalar(-i*et.SIN30DEG);let n=this.vPos,s=this.vertices,o=this.uvs;n.copy(e).sub(this.side).add(this.down),s[this.currentCoordinate++]=n.x,s[this.currentCoordinate++]=n.y,s[this.currentCoordinate++]=n.z,o[this.currentUVCoordinate++]=a,o[this.currentUVCoordinate++]=0,n.copy(e).add(this.side).add(this.down),s[this.currentCoordinate++]=n.x,s[this.currentCoordinate++]=n.y,s[this.currentCoordinate++]=n.z,o[this.currentUVCoordinate++]=a,o[this.currentUVCoordinate++]=.5,n.copy(t).multiplyScalar(i).add(e),s[this.currentCoordinate++]=n.x,s[this.currentCoordinate++]=n.y,s[this.currentCoordinate++]=n.z,o[this.currentUVCoordinate++]=a,o[this.currentUVCoordinate++]=1,this.currentVertex+=3}createPrismFaces(e){let t=this.indices;e=this.currentVertex-6,t[this.currentIndex++]=e+1,t[this.currentIndex++]=e+2,t[this.currentIndex++]=e+5,t[this.currentIndex++]=e+1,t[this.currentIndex++]=e+5,t[this.currentIndex++]=e+4,t[this.currentIndex++]=e+0,t[this.currentIndex++]=e+1,t[this.currentIndex++]=e+4,t[this.currentIndex++]=e+0,t[this.currentIndex++]=e+4,t[this.currentIndex++]=e+3,t[this.currentIndex++]=e+2,t[this.currentIndex++]=e+0,t[this.currentIndex++]=e+3,t[this.currentIndex++]=e+2,t[this.currentIndex++]=e+3,t[this.currentIndex++]=e+5}createDefaultSubrayCreationCallbacks(){let e=this.randomGenerator.random;this.onDecideSubrayCreation=function(t,r){let i=r.currentSubray,a=r.rayParameters.subrayPeriod,n=r.rayParameters.subrayDutyCycle,s=r.rayParameters.isEternal&&0==i.recursion?-e()*a:d.MathUtils.lerp(i.birthTime,i.endPropagationTime,t.fraction0)-e()*a,o=r.time-s,l=Math.floor(o/a),c=e()*(l+1),u=0;if(o%a<=n*a&&(u=r.subrayProbability),i.recursion<r.maxSubrayRecursion&&r.numSubrays<r.maxSubrays&&e()<u){let o=r.addNewSubray(),u=r.randomGenerator.getSeed();o.seed=c,r.randomGenerator.setSeed(c),o.recursion=i.recursion+1,o.maxIterations=Math.max(1,i.maxIterations-1),o.linPos0.set(e(),e(),e()).multiplyScalar(1e3),o.linPos1.set(e(),e(),e()).multiplyScalar(1e3),o.up0.copy(i.up0),o.up1.copy(i.up1),o.radius0=t.radius0*r.rayParameters.radius0Factor,o.radius1=Math.min(r.rayParameters.minRadius,t.radius1*r.rayParameters.radius1Factor),o.birthTime=s+l*a,o.deathTime=o.birthTime+a*n,r.rayParameters.isEternal||0!=i.recursion||(o.birthTime=Math.max(o.birthTime,i.birthTime),o.deathTime=Math.min(o.deathTime,i.deathTime)),o.timeScale=2*i.timeScale,o.roughness=i.roughness,o.straightness=i.straightness,o.propagationTimeFactor=i.propagationTimeFactor,o.vanishingTimeFactor=i.vanishingTimeFactor,r.onSubrayCreation(t,i,o,r),r.randomGenerator.setSeed(u)}};let t=new d.Vector3,r=new d.Vector3,i=new d.Vector3,a=new d.Vector3;this.onSubrayCreation=function(e,t,r,i){i.subrayCylinderPosition(e,t,r,.5,.6,.2)},this.subrayConePosition=function(n,s,o,l,c,u){o.pos0.copy(n.pos0),t.subVectors(s.pos1,s.pos0),r.copy(t).normalize(),t.multiplyScalar(n.fraction0+(1-n.fraction0)*(e()*l));let h=t.length();i.crossVectors(s.up0,r);let p=2*Math.PI*e();i.multiplyScalar(Math.cos(p)),a.copy(s.up0).multiplyScalar(Math.sin(p)),o.pos1.copy(i).add(a).multiplyScalar(h*c*(u+e()*(1-u))).add(t).add(s.pos0)},this.subrayCylinderPosition=function(n,s,o,l,c,u){o.pos0.copy(n.pos0),t.subVectors(s.pos1,s.pos0),r.copy(t).normalize(),t.multiplyScalar(n.fraction0+(1-n.fraction0)*((2*e()-1)*l));let h=t.length();i.crossVectors(s.up0,r);let p=2*Math.PI*e();i.multiplyScalar(Math.cos(p)),a.copy(s.up0).multiplyScalar(Math.sin(p)),o.pos1.copy(i).add(a).multiplyScalar(h*c*(u+e()*(1-u))).add(t).add(s.pos0)}}createSubray(){return{seed:0,maxIterations:0,recursion:0,pos0:new d.Vector3,pos1:new d.Vector3,linPos0:new d.Vector3,linPos1:new d.Vector3,up0:new d.Vector3,up1:new d.Vector3,radius0:0,radius1:0,birthTime:0,deathTime:0,timeScale:0,roughness:0,straightness:0,propagationTimeFactor:0,vanishingTimeFactor:0,endPropagationTime:0,beginVanishingTime:0}}createSegment(){return{iteration:0,pos0:new d.Vector3,pos1:new d.Vector3,linPos0:new d.Vector3,linPos1:new d.Vector3,up0:new d.Vector3,up1:new d.Vector3,radius0:0,radius1:0,fraction0:0,fraction1:0,positionVariationFactor:0}}getNewSegment(){return this.raySegments[this.currentSegmentIndex++]}copy(e){return super.copy(e),this.init(et.copyParameters({},e.rayParameters)),this}clone(){return new this.constructor(et.copyParameters({},this.rayParameters))}};__publicField(et,"RAY_UNBORN",1),__publicField(et,"RAY_PROPAGATING",2),__publicField(et,"RAY_STEADY",3),__publicField(et,"RAY_VANISHING",4),__publicField(et,"RAY_EXTINGUISHED",5),__publicField(et,"COS30DEG",Math.cos(30*Math.PI/180)),__publicField(et,"SIN30DEG",Math.sin(30*Math.PI/180));let er=class extends d.Mesh{constructor(e,t={}){let r;super(e),this.isReflectorForSSRPass=!0,this.type="ReflectorForSSRPass";let i=this,a=new d.Color(void 0!==t.color?t.color:8355711),n=t.textureWidth||512,s=t.textureHeight||512,o=t.clipBias||0,l=t.shader||er.ReflectorShader,c=!0===t.useDepthTexture,u=new d.Vector3(0,1,0),h=new d.Vector3,p=new d.Vector3;i.needsUpdate=!1,i.maxDistance=er.ReflectorShader.uniforms.maxDistance.value,i.opacity=er.ReflectorShader.uniforms.opacity.value,i.color=a,i.resolution=t.resolution||new d.Vector2(window.innerWidth,window.innerHeight),i._distanceAttenuation=er.ReflectorShader.defines.DISTANCE_ATTENUATION,Object.defineProperty(i,"distanceAttenuation",{get:()=>i._distanceAttenuation,set(e){i._distanceAttenuation!==e&&(i._distanceAttenuation=e,i.material.defines.DISTANCE_ATTENUATION=e,i.material.needsUpdate=!0)}}),i._fresnel=er.ReflectorShader.defines.FRESNEL,Object.defineProperty(i,"fresnel",{get:()=>i._fresnel,set(e){i._fresnel!==e&&(i._fresnel=e,i.material.defines.FRESNEL=e,i.material.needsUpdate=!0)}});let f=new d.Vector3,m=new d.Vector3,g=new d.Vector3,v=new d.Matrix4,y=new d.Vector3(0,0,-1),x=new d.Vector3,b=new d.Vector3,T=new d.Matrix4,S=new d.PerspectiveCamera;c&&((r=new d.DepthTexture).type=d.UnsignedShortType,r.minFilter=d.NearestFilter,r.magFilter=d.NearestFilter);let E={depthTexture:c?r:null,type:d.HalfFloatType},R=new d.WebGLRenderTarget(n,s,E),A=new d.ShaderMaterial({transparent:c,defines:Object.assign({},er.ReflectorShader.defines,{useDepthTexture:c}),uniforms:d.UniformsUtils.clone(l.uniforms),fragmentShader:l.fragmentShader,vertexShader:l.vertexShader});A.uniforms.tDiffuse.value=R.texture,A.uniforms.color.value=i.color,A.uniforms.textureMatrix.value=T,c&&(A.uniforms.tDepth.value=R.depthTexture),this.material=A;let C=new d.Plane(new d.Vector3(0,1,0),o),M=[C];this.doRender=function(e,t,r){if(A.uniforms.maxDistance.value=i.maxDistance,A.uniforms.color.value=i.color,A.uniforms.opacity.value=i.opacity,h.copy(r.position).normalize(),p.copy(h).reflect(u),A.uniforms.fresnelCoe.value=(h.dot(p)+1)/2,m.setFromMatrixPosition(i.matrixWorld),g.setFromMatrixPosition(r.matrixWorld),v.extractRotation(i.matrixWorld),f.set(0,0,1),f.applyMatrix4(v),x.subVectors(m,g),x.dot(f)>0)return;x.reflect(f).negate(),x.add(m),v.extractRotation(r.matrixWorld),y.set(0,0,-1),y.applyMatrix4(v),y.add(g),b.subVectors(m,y),b.reflect(f).negate(),b.add(m),S.position.copy(x),S.up.set(0,1,0),S.up.applyMatrix4(v),S.up.reflect(f),S.lookAt(b),S.far=r.far,S.updateMatrixWorld(),S.projectionMatrix.copy(r.projectionMatrix),A.uniforms.virtualCameraNear.value=r.near,A.uniforms.virtualCameraFar.value=r.far,A.uniforms.virtualCameraMatrixWorld.value=S.matrixWorld,A.uniforms.virtualCameraProjectionMatrix.value=r.projectionMatrix,A.uniforms.virtualCameraProjectionMatrixInverse.value=r.projectionMatrixInverse,A.uniforms.resolution.value=i.resolution,T.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),T.multiply(S.projectionMatrix),T.multiply(S.matrixWorldInverse),T.multiply(i.matrixWorld);let a=e.getRenderTarget(),n=e.xr.enabled,s=e.shadowMap.autoUpdate,o=e.clippingPlanes;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.clippingPlanes=M,e.setRenderTarget(R),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),e.render(t,S),e.xr.enabled=n,e.shadowMap.autoUpdate=s,e.clippingPlanes=o,e.setRenderTarget(a);let l=r.viewport;void 0!==l&&e.state.viewport(l)},this.getRenderTarget=function(){return R}}};__publicField(er,"ReflectorShader",{defines:{DISTANCE_ATTENUATION:!0,FRESNEL:!0},uniforms:{color:{value:null},tDiffuse:{value:null},tDepth:{value:null},textureMatrix:{value:new d.Matrix4},maxDistance:{value:180},opacity:{value:.5},fresnelCoe:{value:null},virtualCameraNear:{value:null},virtualCameraFar:{value:null},virtualCameraProjectionMatrix:{value:new d.Matrix4},virtualCameraMatrixWorld:{value:new d.Matrix4},virtualCameraProjectionMatrixInverse:{value:new d.Matrix4},resolution:{value:new d.Vector2}},vertexShader:`
		uniform mat4 textureMatrix;
		varying vec4 vUv;

		void main() {

			vUv = textureMatrix * vec4( position, 1.0 );

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`
		uniform vec3 color;
		uniform sampler2D tDiffuse;
		uniform sampler2D tDepth;
		uniform float maxDistance;
		uniform float opacity;
		uniform float fresnelCoe;
		uniform float virtualCameraNear;
		uniform float virtualCameraFar;
		uniform mat4 virtualCameraProjectionMatrix;
		uniform mat4 virtualCameraProjectionMatrixInverse;
		uniform mat4 virtualCameraMatrixWorld;
		uniform vec2 resolution;
		varying vec4 vUv;
		#include <packing>
		float blendOverlay( float base, float blend ) {
			return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );
		}
		vec3 blendOverlay( vec3 base, vec3 blend ) {
			return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );
		}
		float getDepth( const in vec2 uv ) {
			return texture2D( tDepth, uv ).x;
		}
		float getViewZ( const in float depth ) {
			return perspectiveDepthToViewZ( depth, virtualCameraNear, virtualCameraFar );
		}
		vec3 getViewPosition( const in vec2 uv, const in float depth/*clip space*/, const in float clipW ) {
			vec4 clipPosition = vec4( ( vec3( uv, depth ) - 0.5 ) * 2.0, 1.0 );//ndc
			clipPosition *= clipW; //clip
			return ( virtualCameraProjectionMatrixInverse * clipPosition ).xyz;//view
		}
		void main() {
			vec4 base = texture2DProj( tDiffuse, vUv );
			#ifdef useDepthTexture
				vec2 uv=(gl_FragCoord.xy-.5)/resolution.xy;
				uv.x=1.-uv.x;
				float depth = texture2DProj( tDepth, vUv ).r;
				float viewZ = getViewZ( depth );
				float clipW = virtualCameraProjectionMatrix[2][3] * viewZ+virtualCameraProjectionMatrix[3][3];
				vec3 viewPosition=getViewPosition( uv, depth, clipW );
				vec3 worldPosition=(virtualCameraMatrixWorld*vec4(viewPosition,1)).xyz;
				if(worldPosition.y>maxDistance) discard;
				float op=opacity;
				#ifdef DISTANCE_ATTENUATION
					float ratio=1.-(worldPosition.y/maxDistance);
					float attenuation=ratio*ratio;
					op=opacity*attenuation;
				#endif
				#ifdef FRESNEL
					op*=fresnelCoe;
				#endif
				gl_FragColor = vec4( blendOverlay( base.rgb, color ), op );
			#else
				gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );
			#endif
		}
	`});let ei={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new d.Vector3},up:{value:new d.Vector3(0,1,0)}},vertexShader:`
      uniform vec3 sunPosition;
      uniform float rayleigh;
      uniform float turbidity;
      uniform float mieCoefficient;
      uniform vec3 up;

      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      // constants for atmospheric scattering
      const float e = 2.71828182845904523536028747135266249775724709369995957;
      const float pi = 3.141592653589793238462643383279502884197169;

      // wavelength of used primaries, according to preetham
      const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );
      // this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:
      // (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))
      const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );

      // mie stuff
      // K coefficient for the primaries
      const float v = 4.0;
      const vec3 K = vec3( 0.686, 0.678, 0.666 );
      // MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K
      const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );

      // earth shadow hack
      // cutoffAngle = pi / 1.95;
      const float cutoffAngle = 1.6110731556870734;
      const float steepness = 1.5;
      const float EE = 1000.0;

      float sunIntensity( float zenithAngleCos ) {
        zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );
        return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );
      }

      vec3 totalMie( float T ) {
        float c = ( 0.2 * T ) * 10E-18;
        return 0.434 * c * MieConst;
      }

      void main() {

        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
        vWorldPosition = worldPosition.xyz;

        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        gl_Position.z = gl_Position.w; // set z to camera.far

        vSunDirection = normalize( sunPosition );

        vSunE = sunIntensity( dot( vSunDirection, up ) );

        vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );

        float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );

      // extinction (absorbtion + out scattering)
      // rayleigh coefficients
        vBetaR = totalRayleigh * rayleighCoefficient;

      // mie coefficients
        vBetaM = totalMie( turbidity ) * mieCoefficient;

      }
    `,fragmentShader:`
      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      uniform float mieDirectionalG;
      uniform vec3 up;

      const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );

      // constants for atmospheric scattering
      const float pi = 3.141592653589793238462643383279502884197169;

      const float n = 1.0003; // refractive index of air
      const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)

      // optical length at zenith for molecules
      const float rayleighZenithLength = 8.4E3;
      const float mieZenithLength = 1.25E3;
      // 66 arc seconds -> degrees, and the cosine of that
      const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;

      // 3.0 / ( 16.0 * pi )
      const float THREE_OVER_SIXTEENPI = 0.05968310365946075;
      // 1.0 / ( 4.0 * pi )
      const float ONE_OVER_FOURPI = 0.07957747154594767;

      float rayleighPhase( float cosTheta ) {
        return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );
      }

      float hgPhase( float cosTheta, float g ) {
        float g2 = pow( g, 2.0 );
        float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );
        return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );
      }

      void main() {

        vec3 direction = normalize( vWorldPosition - cameraPos );

      // optical length
      // cutoff angle at 90 to avoid singularity in next formula.
        float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );
        float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );
        float sR = rayleighZenithLength * inverse;
        float sM = mieZenithLength * inverse;

      // combined extinction factor
        vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );

      // in scattering
        float cosTheta = dot( direction, vSunDirection );

        float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );
        vec3 betaRTheta = vBetaR * rPhase;

        float mPhase = hgPhase( cosTheta, mieDirectionalG );
        vec3 betaMTheta = vBetaM * mPhase;

        vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );
        Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );

      // nightsky
        float theta = acos( direction.y ); // elevation --> y-axis, [-pi/2, pi/2]
        float phi = atan( direction.z, direction.x ); // azimuth --> x-axis [-pi/2, pi/2]
        vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );
        vec3 L0 = vec3( 0.1 ) * Fex;

      // composition + solar disc
        float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );
        L0 += ( vSunE * 19000.0 * Fex ) * sundisk;

        vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );

        vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );

        gl_FragColor = vec4( retColor, 1.0 );

      #include <tonemapping_fragment>
      #include <${q>=154?"colorspace_fragment":"encodings_fragment"}>

      }
    `},ea=new d.ShaderMaterial({name:"SkyShader",fragmentShader:ei.fragmentShader,vertexShader:ei.vertexShader,uniforms:d.UniformsUtils.clone(ei.uniforms),side:d.BackSide,depthWrite:!1});let Sky=class Sky extends d.Mesh{constructor(){super(new d.BoxGeometry(1,1,1),ea)}};__publicField(Sky,"SkyShader",ei),__publicField(Sky,"material",ea);let en=class extends d.Mesh{constructor(e,t={}){super(e),this.isWater=!0,this.type="Water";let r=this,i=new d.Color(void 0!==t.color?t.color:16777215),a=t.textureWidth||512,n=t.textureHeight||512,s=t.clipBias||0,o=t.flowDirection||new d.Vector2(1,0),l=t.flowSpeed||.03,c=t.reflectivity||.02,u=t.scale||1,h=t.shader||en.WaterShader,p=void 0!==t.encoding?t.encoding:3e3,f=t.flowMap||void 0,m=t.normalMap0,g=t.normalMap1,v=new d.Matrix4,y=new d.Clock;if(void 0===Y){console.error("THREE.Water: Required component Reflector not found.");return}if(void 0===Z){console.error("THREE.Water: Required component Refractor not found.");return}let x=new Y(e,{textureWidth:a,textureHeight:n,clipBias:s,encoding:p}),b=new Z(e,{textureWidth:a,textureHeight:n,clipBias:s,encoding:p});function updateTextureMatrix(e){v.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),v.multiply(e.projectionMatrix),v.multiply(e.matrixWorldInverse),v.multiply(r.matrixWorld)}function updateFlow(){let e=y.getDelta(),t=r.material.uniforms.config;t.value.x+=l*e,t.value.y=t.value.x+.075,t.value.x>=.15?(t.value.x=0,t.value.y=.075):t.value.y>=.15&&(t.value.y=t.value.y-.15)}x.matrixAutoUpdate=!1,b.matrixAutoUpdate=!1,this.material=new d.ShaderMaterial({uniforms:d.UniformsUtils.merge([d.UniformsLib.fog,h.uniforms]),vertexShader:h.vertexShader,fragmentShader:h.fragmentShader,transparent:!0,fog:!0}),void 0!==f?(this.material.defines.USE_FLOWMAP="",this.material.uniforms.tFlowMap={type:"t",value:f}):this.material.uniforms.flowDirection={type:"v2",value:o},m.wrapS=m.wrapT=d.RepeatWrapping,g.wrapS=g.wrapT=d.RepeatWrapping,this.material.uniforms.tReflectionMap.value=x.getRenderTarget().texture,this.material.uniforms.tRefractionMap.value=b.getRenderTarget().texture,this.material.uniforms.tNormalMap0.value=m,this.material.uniforms.tNormalMap1.value=g,this.material.uniforms.color.value=i,this.material.uniforms.reflectivity.value=c,this.material.uniforms.textureMatrix.value=v,this.material.uniforms.config.value.x=0,this.material.uniforms.config.value.y=.075,this.material.uniforms.config.value.z=.075,this.material.uniforms.config.value.w=u,this.onBeforeRender=function(e,t,i){updateTextureMatrix(i),updateFlow(),r.visible=!1,x.matrixWorld.copy(r.matrixWorld),b.matrixWorld.copy(r.matrixWorld),x.onBeforeRender(e,t,i),b.onBeforeRender(e,t,i),r.visible=!0}}};function _getMipmapMaterial(){var e=new d.RawShaderMaterial({uniforms:{roughnessMap:{value:null},normalMap:{value:null},texelSize:{value:new d.Vector2(1,1)}},vertexShader:`
			precision mediump float;
			precision mediump int;

			attribute vec3 position;
			attribute vec2 uv;

			varying vec2 vUv;

			void main() {

				vUv = uv;

				gl_Position = vec4( position, 1.0 );

			}
		`,fragmentShader:`
			precision mediump float;
			precision mediump int;

			varying vec2 vUv;

			uniform sampler2D roughnessMap;
			uniform sampler2D normalMap;
			uniform vec2 texelSize;

			#define ENVMAP_TYPE_CUBE_UV

			vec4 envMapTexelToLinear( vec4 a ) { return a; }

			#include <cube_uv_reflection_fragment>

			float roughnessToVariance( float roughness ) {

				float variance = 0.0;

				if ( roughness >= r1 ) {

					variance = ( r0 - roughness ) * ( v1 - v0 ) / ( r0 - r1 ) + v0;

				} else if ( roughness >= r4 ) {

					variance = ( r1 - roughness ) * ( v4 - v1 ) / ( r1 - r4 ) + v1;

				} else if ( roughness >= r5 ) {

					variance = ( r4 - roughness ) * ( v5 - v4 ) / ( r4 - r5 ) + v4;

				} else {

					float roughness2 = roughness * roughness;

					variance = 1.79 * roughness2 * roughness2;

				}

				return variance;

			}

			float varianceToRoughness( float variance ) {

				float roughness = 0.0;

				if ( variance >= v1 ) {

					roughness = ( v0 - variance ) * ( r1 - r0 ) / ( v0 - v1 ) + r0;

				} else if ( variance >= v4 ) {

					roughness = ( v1 - variance ) * ( r4 - r1 ) / ( v1 - v4 ) + r1;

				} else if ( variance >= v5 ) {

					roughness = ( v4 - variance ) * ( r5 - r4 ) / ( v4 - v5 ) + r4;

				} else {

					roughness = pow( 0.559 * variance, 0.25 ); // 0.559 = 1.0 / 1.79

				}

				return roughness;

			}

			void main() {

				gl_FragColor = texture2D( roughnessMap, vUv, - 1.0 );

				if ( texelSize.x == 0.0 ) return;

				float roughness = gl_FragColor.g;

				float variance = roughnessToVariance( roughness );

				vec3 avgNormal;

				for ( float x = - 1.0; x < 2.0; x += 2.0 ) {

					for ( float y = - 1.0; y < 2.0; y += 2.0 ) {

						vec2 uv = vUv + vec2( x, y ) * 0.25 * texelSize;

						avgNormal += normalize( texture2D( normalMap, uv, - 1.0 ).xyz - 0.5 );

					}

				}

				variance += 1.0 - 0.25 * length( avgNormal );

				gl_FragColor.g = varianceToRoughness( variance );

			}
		`,blending:d.NoBlending,depthTest:!1,depthWrite:!1});return e.type="RoughnessMipmapper",e}__publicField(en,"WaterShader",{uniforms:{color:{value:null},reflectivity:{value:0},tReflectionMap:{value:null},tRefractionMap:{value:null},tNormalMap0:{value:null},tNormalMap1:{value:null},textureMatrix:{value:null},config:{value:new d.Vector4}},vertexShader:`

		#include <common>
		#include <fog_pars_vertex>
		#include <logdepthbuf_pars_vertex>

		uniform mat4 textureMatrix;

		varying vec4 vCoord;
		varying vec2 vUv;
		varying vec3 vToEye;

		void main() {

			vUv = uv;
			vCoord = textureMatrix * vec4( position, 1.0 );

			vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
			vToEye = cameraPosition - worldPosition.xyz;

			vec4 mvPosition =  viewMatrix * worldPosition; // used in fog_vertex
			gl_Position = projectionMatrix * mvPosition;

			#include <logdepthbuf_vertex>
			#include <fog_vertex>

		}`,fragmentShader:`

		#include <common>
		#include <fog_pars_fragment>
		#include <logdepthbuf_pars_fragment>

		uniform sampler2D tReflectionMap;
		uniform sampler2D tRefractionMap;
		uniform sampler2D tNormalMap0;
		uniform sampler2D tNormalMap1;

		#ifdef USE_FLOWMAP
			uniform sampler2D tFlowMap;
		#else
			uniform vec2 flowDirection;
		#endif

		uniform vec3 color;
		uniform float reflectivity;
		uniform vec4 config;

		varying vec4 vCoord;
		varying vec2 vUv;
		varying vec3 vToEye;

		void main() {

			#include <logdepthbuf_fragment>

			float flowMapOffset0 = config.x;
			float flowMapOffset1 = config.y;
			float halfCycle = config.z;
			float scale = config.w;

			vec3 toEye = normalize( vToEye );

			// determine flow direction
			vec2 flow;
			#ifdef USE_FLOWMAP
				flow = texture2D( tFlowMap, vUv ).rg * 2.0 - 1.0;
			#else
				flow = flowDirection;
			#endif
			flow.x *= - 1.0;

			// sample normal maps (distort uvs with flowdata)
			vec4 normalColor0 = texture2D( tNormalMap0, ( vUv * scale ) + flow * flowMapOffset0 );
			vec4 normalColor1 = texture2D( tNormalMap1, ( vUv * scale ) + flow * flowMapOffset1 );

			// linear interpolate to get the final normal color
			float flowLerp = abs( halfCycle - flowMapOffset0 ) / halfCycle;
			vec4 normalColor = mix( normalColor0, normalColor1, flowLerp );

			// calculate normal vector
			vec3 normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );

			// calculate the fresnel term to blend reflection and refraction maps
			float theta = max( dot( toEye, normal ), 0.0 );
			float reflectance = reflectivity + ( 1.0 - reflectivity ) * pow( ( 1.0 - theta ), 5.0 );

			// calculate final uv coords
			vec3 coord = vCoord.xyz / vCoord.w;
			vec2 uv = coord.xy + coord.z * normal.xz * 0.05;

			vec4 reflectColor = texture2D( tReflectionMap, vec2( 1.0 - uv.x, uv.y ) );
			vec4 refractColor = texture2D( tRefractionMap, uv );

			// multiply water color with the mix of both textures
			gl_FragColor = vec4( color, 1.0 ) * mix( refractColor, reflectColor, reflectance );

			#include <tonemapping_fragment>
			#include <${q>=154?"colorspace_fragment":"encodings_fragment"}>
			#include <fog_fragment>

		}`});function getBoneByName(e,t){for(let r=0,i=getBones(t);r<i.length;r++)if(e===i[r].name)return i[r]}function getBones(e){return Array.isArray(e)?e:e.bones}let es={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform float opacity;\nuniform sampler2D tDiffuse;\nvarying vec2 vUv;\n#include <packing>\nvoid main() {\n	float depth = 1.0 - unpackRGBAToDepth( texture2D( tDiffuse, vUv ) );\n	gl_FragColor = vec4( vec3( depth ), opacity );\n}"};d.MeshPhongMaterial;let eo={c:null,u:[new d.Vector3,new d.Vector3,new d.Vector3],e:[]},el={c:null,u:[new d.Vector3,new d.Vector3,new d.Vector3],e:[]},ec=[[],[],[]],eu=[[],[],[]],eh=[],ep=new d.Vector3,ed=new d.Vector3,ef=new d.Vector3,em=new d.Vector3,eg=new d.Vector3,ev=new d.Vector3,ey=new d.Matrix3,ex=new d.Box3,eb=new d.Matrix4,eT=new d.Matrix4,eS=new d.Ray;let OBB=class OBB{constructor(e=new d.Vector3,t=new d.Vector3,r=new d.Matrix3){this.center=e,this.halfSize=t,this.rotation=r}set(e,t,r){return this.center=e,this.halfSize=t,this.rotation=r,this}copy(e){return this.center.copy(e.center),this.halfSize.copy(e.halfSize),this.rotation.copy(e.rotation),this}clone(){return new this.constructor().copy(this)}getSize(e){return e.copy(this.halfSize).multiplyScalar(2)}clampPoint(e,t){let r=this.halfSize;em.subVectors(e,this.center),this.rotation.extractBasis(ep,ed,ef),t.copy(this.center);let i=d.MathUtils.clamp(em.dot(ep),-r.x,r.x);t.add(ep.multiplyScalar(i));let a=d.MathUtils.clamp(em.dot(ed),-r.y,r.y);t.add(ed.multiplyScalar(a));let n=d.MathUtils.clamp(em.dot(ef),-r.z,r.z);return t.add(ef.multiplyScalar(n)),t}containsPoint(e){return em.subVectors(e,this.center),this.rotation.extractBasis(ep,ed,ef),Math.abs(em.dot(ep))<=this.halfSize.x&&Math.abs(em.dot(ed))<=this.halfSize.y&&Math.abs(em.dot(ef))<=this.halfSize.z}intersectsBox3(e){return this.intersectsOBB(eE.fromBox3(e))}intersectsSphere(e){return this.clampPoint(e.center,ev),ev.distanceToSquared(e.center)<=e.radius*e.radius}intersectsOBB(e,t=Number.EPSILON){let r,i;eo.c=this.center,eo.e[0]=this.halfSize.x,eo.e[1]=this.halfSize.y,eo.e[2]=this.halfSize.z,this.rotation.extractBasis(eo.u[0],eo.u[1],eo.u[2]),el.c=e.center,el.e[0]=e.halfSize.x,el.e[1]=e.halfSize.y,el.e[2]=e.halfSize.z,e.rotation.extractBasis(el.u[0],el.u[1],el.u[2]);for(let e=0;e<3;e++)for(let t=0;t<3;t++)ec[e][t]=eo.u[e].dot(el.u[t]);em.subVectors(el.c,eo.c),eh[0]=em.dot(eo.u[0]),eh[1]=em.dot(eo.u[1]),eh[2]=em.dot(eo.u[2]);for(let e=0;e<3;e++)for(let r=0;r<3;r++)eu[e][r]=Math.abs(ec[e][r])+t;for(let e=0;e<3;e++)if(r=eo.e[e],i=el.e[0]*eu[e][0]+el.e[1]*eu[e][1]+el.e[2]*eu[e][2],Math.abs(eh[e])>r+i)return!1;for(let e=0;e<3;e++)if(r=eo.e[0]*eu[0][e]+eo.e[1]*eu[1][e]+eo.e[2]*eu[2][e],i=el.e[e],Math.abs(eh[0]*ec[0][e]+eh[1]*ec[1][e]+eh[2]*ec[2][e])>r+i)return!1;return r=eo.e[1]*eu[2][0]+eo.e[2]*eu[1][0],i=el.e[1]*eu[0][2]+el.e[2]*eu[0][1],!(Math.abs(eh[2]*ec[1][0]-eh[1]*ec[2][0])>r+i)&&(r=eo.e[1]*eu[2][1]+eo.e[2]*eu[1][1],i=el.e[0]*eu[0][2]+el.e[2]*eu[0][0],!(Math.abs(eh[2]*ec[1][1]-eh[1]*ec[2][1])>r+i)&&(r=eo.e[1]*eu[2][2]+eo.e[2]*eu[1][2],i=el.e[0]*eu[0][1]+el.e[1]*eu[0][0],!(Math.abs(eh[2]*ec[1][2]-eh[1]*ec[2][2])>r+i)&&(r=eo.e[0]*eu[2][0]+eo.e[2]*eu[0][0],i=el.e[1]*eu[1][2]+el.e[2]*eu[1][1],!(Math.abs(eh[0]*ec[2][0]-eh[2]*ec[0][0])>r+i)&&(r=eo.e[0]*eu[2][1]+eo.e[2]*eu[0][1],i=el.e[0]*eu[1][2]+el.e[2]*eu[1][0],!(Math.abs(eh[0]*ec[2][1]-eh[2]*ec[0][1])>r+i)&&(r=eo.e[0]*eu[2][2]+eo.e[2]*eu[0][2],i=el.e[0]*eu[1][1]+el.e[1]*eu[1][0],!(Math.abs(eh[0]*ec[2][2]-eh[2]*ec[0][2])>r+i)&&(r=eo.e[0]*eu[1][0]+eo.e[1]*eu[0][0],i=el.e[1]*eu[2][2]+el.e[2]*eu[2][1],!(Math.abs(eh[1]*ec[0][0]-eh[0]*ec[1][0])>r+i)&&(r=eo.e[0]*eu[1][1]+eo.e[1]*eu[0][1],i=el.e[0]*eu[2][2]+el.e[2]*eu[2][0],!(Math.abs(eh[1]*ec[0][1]-eh[0]*ec[1][1])>r+i)&&(r=eo.e[0]*eu[1][2]+eo.e[1]*eu[0][2],i=el.e[0]*eu[2][1]+el.e[1]*eu[2][0],!(Math.abs(eh[1]*ec[0][2]-eh[0]*ec[1][2])>r+i)))))))))}intersectsPlane(e){this.rotation.extractBasis(ep,ed,ef);let t=this.halfSize.x*Math.abs(e.normal.dot(ep))+this.halfSize.y*Math.abs(e.normal.dot(ed))+this.halfSize.z*Math.abs(e.normal.dot(ef)),r=e.normal.dot(this.center)-e.constant;return Math.abs(r)<=t}intersectRay(e,t){return(this.getSize(eg),ex.setFromCenterAndSize(em.set(0,0,0),eg),eb.setFromMatrix3(this.rotation),eb.setPosition(this.center),eT.copy(eb).invert(),eS.copy(e).applyMatrix4(eT),eS.intersectBox(ex,t))?t.applyMatrix4(eb):null}intersectsRay(e){return null!==this.intersectRay(e,em)}fromBox3(e){return e.getCenter(this.center),e.getSize(this.halfSize).multiplyScalar(.5),this.rotation.identity(),this}equals(e){return e.center.equals(this.center)&&e.halfSize.equals(this.halfSize)&&e.rotation.equals(this.rotation)}applyMatrix4(e){let t=e.elements,r=em.set(t[0],t[1],t[2]).length(),i=em.set(t[4],t[5],t[6]).length(),a=em.set(t[8],t[9],t[10]).length(),n=e.determinant();n<0&&(r=-r),ey.setFromMatrix4(e);let s=1/r,o=1/i,l=1/a;return ey.elements[0]*=s,ey.elements[1]*=s,ey.elements[2]*=s,ey.elements[3]*=o,ey.elements[4]*=o,ey.elements[5]*=o,ey.elements[6]*=l,ey.elements[7]*=l,ey.elements[8]*=l,this.rotation.multiply(ey),this.halfSize.x*=r,this.halfSize.y*=i,this.halfSize.z*=a,em.setFromMatrixPosition(e),this.center.add(em),this}};let eE=new OBB,eR=new d.Vector3,eA=new d.Vector3,eC=new d.Vector3;let Capsule=class Capsule{constructor(e=new d.Vector3(0,0,0),t=new d.Vector3(0,1,0),r=1){this.start=e,this.end=t,this.radius=r}clone(){return new Capsule(this.start.clone(),this.end.clone(),this.radius)}set(e,t,r){this.start.copy(e),this.end.copy(t),this.radius=r}copy(e){this.start.copy(e.start),this.end.copy(e.end),this.radius=e.radius}getCenter(e){return e.copy(this.end).add(this.start).multiplyScalar(.5)}translate(e){this.start.add(e),this.end.add(e)}checkAABBAxis(e,t,r,i,a,n,s,o,l){return(a-e<l||a-r<l)&&(e-n<l||r-n<l)&&(s-t<l||s-i<l)&&(t-o<l||i-o<l)}intersectsBox(e){return this.checkAABBAxis(this.start.x,this.start.y,this.end.x,this.end.y,e.min.x,e.max.x,e.min.y,e.max.y,this.radius)&&this.checkAABBAxis(this.start.x,this.start.z,this.end.x,this.end.z,e.min.x,e.max.x,e.min.z,e.max.z,this.radius)&&this.checkAABBAxis(this.start.y,this.start.z,this.end.y,this.end.z,e.min.y,e.max.y,e.min.z,e.max.z,this.radius)}lineLineMinimumPoints(e,t){let r,i;let a=eR.copy(e.end).sub(e.start),n=eA.copy(t.end).sub(t.start),s=eC.copy(t.start).sub(e.start),o=a.dot(n),l=a.dot(a),c=n.dot(n),u=n.dot(s),h=a.dot(s),p=l*c-o*o;if(1e-10>Math.abs(p)){let e=-u/c,t=(o-u)/c;Math.abs(e-.5)<Math.abs(t-.5)?(r=0,i=e):(r=1,i=t)}else i=((r=(u*o+h*c)/p)*o-u)/c;i=Math.max(0,Math.min(1,i)),r=Math.max(0,Math.min(1,r));let d=a.multiplyScalar(r).add(e.start),f=n.multiplyScalar(i).add(t.start);return[d,f]}};let eM=new d.Vector3,eP=new d.Vector3,ew=new d.Plane,eI=new d.Line3,ek=new d.Line3,e_=new d.Sphere,eO=new Capsule;let Octree=class Octree{constructor(e){this.triangles=[],this.box=e,this.subTrees=[]}addTriangle(e){return this.bounds||(this.bounds=new Box3),this.bounds.min.x=Math.min(this.bounds.min.x,e.a.x,e.b.x,e.c.x),this.bounds.min.y=Math.min(this.bounds.min.y,e.a.y,e.b.y,e.c.y),this.bounds.min.z=Math.min(this.bounds.min.z,e.a.z,e.b.z,e.c.z),this.bounds.max.x=Math.max(this.bounds.max.x,e.a.x,e.b.x,e.c.x),this.bounds.max.y=Math.max(this.bounds.max.y,e.a.y,e.b.y,e.c.y),this.bounds.max.z=Math.max(this.bounds.max.z,e.a.z,e.b.z,e.c.z),this.triangles.push(e),this}calcBox(){return this.box=this.bounds.clone(),this.box.min.x-=.01,this.box.min.y-=.01,this.box.min.z-=.01,this}split(e){let t;if(!this.box)return;let r=[],i=eP.copy(this.box.max).sub(this.box.min).multiplyScalar(.5);for(let e=0;e<2;e++)for(let t=0;t<2;t++)for(let a=0;a<2;a++){let n=new Box3,s=eM.set(e,t,a);n.min.copy(this.box.min).add(s.multiply(i)),n.max.copy(n.min).add(i),r.push(new Octree(n))}for(;t=this.triangles.pop();)for(let e=0;e<r.length;e++)r[e].box.intersectsTriangle(t)&&r[e].triangles.push(t);for(let t=0;t<r.length;t++){let i=r[t].triangles.length;i>8&&e<16&&r[t].split(e+1),0!==i&&this.subTrees.push(r[t])}return this}build(){return this.calcBox(),this.split(0),this}getRayTriangles(e,t){for(let r=0;r<this.subTrees.length;r++){let i=this.subTrees[r];if(e.intersectsBox(i.box)){if(i.triangles.length>0)for(let e=0;e<i.triangles.length;e++)-1===t.indexOf(i.triangles[e])&&t.push(i.triangles[e]);else i.getRayTriangles(e,t)}}return t}triangleCapsuleIntersect(e,t){t.getPlane(ew);let r=ew.distanceToPoint(e.start)-e.radius,i=ew.distanceToPoint(e.end)-e.radius;if(r>0&&i>0||r<-e.radius&&i<-e.radius)return!1;let a=eM.copy(e.start).lerp(e.end,Math.abs(r/(Math.abs(r)+Math.abs(i))));if(t.containsPoint(a))return{normal:ew.normal.clone(),point:a.clone(),depth:Math.abs(Math.min(r,i))};let n=e.radius*e.radius,s=eI.set(e.start,e.end),o=[[t.a,t.b],[t.b,t.c],[t.c,t.a]];for(let t=0;t<o.length;t++){let r=ek.set(o[t][0],o[t][1]),[i,a]=e.lineLineMinimumPoints(s,r);if(i.distanceToSquared(a)<n)return{normal:i.clone().sub(a).normalize(),point:a.clone(),depth:e.radius-i.distanceTo(a)}}return!1}triangleSphereIntersect(e,t){if(t.getPlane(ew),!e.intersectsPlane(ew))return!1;let r=Math.abs(ew.distanceToSphere(e)),i=e.radius*e.radius-r*r,a=ew.projectPoint(e.center,eM);if(t.containsPoint(e.center))return{normal:ew.normal.clone(),point:a.clone(),depth:Math.abs(ew.distanceToSphere(e))};let n=[[t.a,t.b],[t.b,t.c],[t.c,t.a]];for(let t=0;t<n.length;t++){eI.set(n[t][0],n[t][1]),eI.closestPointToPoint(a,!0,eP);let r=eP.distanceToSquared(e.center);if(r<i)return{normal:e.center.clone().sub(eP).normalize(),point:eP.clone(),depth:e.radius-Math.sqrt(r)}}return!1}getSphereTriangles(e,t){for(let r=0;r<this.subTrees.length;r++){let i=this.subTrees[r];if(e.intersectsBox(i.box)){if(i.triangles.length>0)for(let e=0;e<i.triangles.length;e++)-1===t.indexOf(i.triangles[e])&&t.push(i.triangles[e]);else i.getSphereTriangles(e,t)}}}getCapsuleTriangles(e,t){for(let r=0;r<this.subTrees.length;r++){let i=this.subTrees[r];if(e.intersectsBox(i.box)){if(i.triangles.length>0)for(let e=0;e<i.triangles.length;e++)-1===t.indexOf(i.triangles[e])&&t.push(i.triangles[e]);else i.getCapsuleTriangles(e,t)}}}sphereIntersect(e){e_.copy(e);let t=[],r,i=!1;this.getSphereTriangles(e,t);for(let e=0;e<t.length;e++)(r=this.triangleSphereIntersect(e_,t[e]))&&(i=!0,e_.center.add(r.normal.multiplyScalar(r.depth)));if(i){let t=e_.center.clone().sub(e.center),r=t.length();return{normal:t.normalize(),depth:r}}return!1}capsuleIntersect(e){eO.copy(e);let t=[],r,i=!1;this.getCapsuleTriangles(eO,t);for(let e=0;e<t.length;e++)(r=this.triangleCapsuleIntersect(eO,t[e]))&&(i=!0,eO.translate(r.normal.multiplyScalar(r.depth)));if(i){let t=eO.getCenter(new Vector3).sub(e.getCenter(eM)),r=t.length();return{normal:t.normalize(),depth:r}}return!1}rayIntersect(e){if(0===e.direction.length())return;let t=[],r,i,a=1e100;this.getRayTriangles(e,t);for(let n=0;n<t.length;n++){let s=e.intersectTriangle(t[n].a,t[n].b,t[n].c,!0,eM);if(s){let o=s.sub(e.origin).length();a>o&&(i=s.clone().add(e.origin),a=o,r=t[n])}}return a<1e100&&{distance:a,triangle:r,position:i}}fromGraphNode(e){return e.updateWorldMatrix(!0,!0),e.traverse(e=>{if(!0===e.isMesh){let t,r=!1;null!==e.geometry.index?(r=!0,t=e.geometry.toNonIndexed()):t=e.geometry;let i=t.getAttribute("position");for(let t=0;t<i.count;t+=3){let r=new Vector3().fromBufferAttribute(i,t),a=new Vector3().fromBufferAttribute(i,t+1),n=new Vector3().fromBufferAttribute(i,t+2);r.applyMatrix4(e.matrixWorld),a.applyMatrix4(e.matrixWorld),n.applyMatrix4(e.matrixWorld),this.addTriangle(new Triangle$1(r,a,n))}r&&t.dispose()}}),this.build(),this}};var eN=((p=eN||{})[p.NONE=-1]="NONE",p[p.ROTATE=0]="ROTATE",p[p.DOLLY=1]="DOLLY",p[p.PAN=2]="PAN",p[p.TOUCH_ROTATE=3]="TOUCH_ROTATE",p[p.TOUCH_PAN=4]="TOUCH_PAN",p[p.TOUCH_DOLLY_PAN=5]="TOUCH_DOLLY_PAN",p[p.TOUCH_DOLLY_ROTATE=6]="TOUCH_DOLLY_ROTATE",p);let eL=new d.Ray,eF=new d.Plane,eD=Math.cos(70*(Math.PI/180)),moduloWrapAround=(e,t)=>(e%t+t)%t;let OrbitControls=class OrbitControls extends d.EventDispatcher{constructor(e,t){super(),__publicField(this,"object"),__publicField(this,"domElement"),__publicField(this,"enabled",!0),__publicField(this,"target",new d.Vector3),__publicField(this,"minDistance",0),__publicField(this,"maxDistance",1/0),__publicField(this,"minZoom",0),__publicField(this,"maxZoom",1/0),__publicField(this,"minPolarAngle",0),__publicField(this,"maxPolarAngle",Math.PI),__publicField(this,"minAzimuthAngle",-1/0),__publicField(this,"maxAzimuthAngle",1/0),__publicField(this,"enableDamping",!1),__publicField(this,"dampingFactor",.05),__publicField(this,"enableZoom",!0),__publicField(this,"zoomSpeed",1),__publicField(this,"enableRotate",!0),__publicField(this,"rotateSpeed",1),__publicField(this,"enablePan",!0),__publicField(this,"panSpeed",1),__publicField(this,"screenSpacePanning",!0),__publicField(this,"keyPanSpeed",7),__publicField(this,"zoomToCursor",!1),__publicField(this,"autoRotate",!1),__publicField(this,"autoRotateSpeed",2),__publicField(this,"reverseOrbit",!1),__publicField(this,"reverseHorizontalOrbit",!1),__publicField(this,"reverseVerticalOrbit",!1),__publicField(this,"keys",{LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"}),__publicField(this,"mouseButtons",{LEFT:d.MOUSE.ROTATE,MIDDLE:d.MOUSE.DOLLY,RIGHT:d.MOUSE.PAN}),__publicField(this,"touches",{ONE:d.TOUCH.ROTATE,TWO:d.TOUCH.DOLLY_PAN}),__publicField(this,"target0"),__publicField(this,"position0"),__publicField(this,"zoom0"),__publicField(this,"_domElementKeyEvents",null),__publicField(this,"getPolarAngle"),__publicField(this,"getAzimuthalAngle"),__publicField(this,"setPolarAngle"),__publicField(this,"setAzimuthalAngle"),__publicField(this,"getDistance"),__publicField(this,"listenToKeyEvents"),__publicField(this,"stopListenToKeyEvents"),__publicField(this,"saveState"),__publicField(this,"reset"),__publicField(this,"update"),__publicField(this,"connect"),__publicField(this,"dispose"),this.object=e,this.domElement=t,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=()=>c.phi,this.getAzimuthalAngle=()=>c.theta,this.setPolarAngle=e=>{let t=moduloWrapAround(e,2*Math.PI),i=c.phi;i<0&&(i+=2*Math.PI),t<0&&(t+=2*Math.PI);let a=Math.abs(t-i);2*Math.PI-a<a&&(t<i?t+=2*Math.PI:i+=2*Math.PI),u.phi=t-i,r.update()},this.setAzimuthalAngle=e=>{let t=moduloWrapAround(e,2*Math.PI),i=c.theta;i<0&&(i+=2*Math.PI),t<0&&(t+=2*Math.PI);let a=Math.abs(t-i);2*Math.PI-a<a&&(t<i?t+=2*Math.PI:i+=2*Math.PI),u.theta=t-i,r.update()},this.getDistance=()=>r.object.position.distanceTo(r.target),this.listenToKeyEvents=e=>{e.addEventListener("keydown",onKeyDown),this._domElementKeyEvents=e},this.stopListenToKeyEvents=()=>{this._domElementKeyEvents.removeEventListener("keydown",onKeyDown),this._domElementKeyEvents=null},this.saveState=()=>{r.target0.copy(r.target),r.position0.copy(r.object.position),r.zoom0=r.object.zoom},this.reset=()=>{r.target.copy(r.target0),r.object.position.copy(r.position0),r.object.zoom=r.zoom0,r.object.updateProjectionMatrix(),r.dispatchEvent(i),r.update(),o=s.NONE},this.update=(()=>{let t=new d.Vector3,a=new d.Vector3(0,1,0),n=new d.Quaternion().setFromUnitVectors(e.up,a),f=n.clone().invert(),m=new d.Vector3,g=new d.Quaternion,v=2*Math.PI;return function(){let y=r.object.position;n.setFromUnitVectors(e.up,a),f.copy(n).invert(),t.copy(y).sub(r.target),t.applyQuaternion(n),c.setFromVector3(t),r.autoRotate&&o===s.NONE&&rotateLeft(getAutoRotationAngle()),r.enableDamping?(c.theta+=u.theta*r.dampingFactor,c.phi+=u.phi*r.dampingFactor):(c.theta+=u.theta,c.phi+=u.phi);let x=r.minAzimuthAngle,b=r.maxAzimuthAngle;isFinite(x)&&isFinite(b)&&(x<-Math.PI?x+=v:x>Math.PI&&(x-=v),b<-Math.PI?b+=v:b>Math.PI&&(b-=v),x<=b?c.theta=Math.max(x,Math.min(b,c.theta)):c.theta=c.theta>(x+b)/2?Math.max(x,c.theta):Math.min(b,c.theta)),c.phi=Math.max(r.minPolarAngle,Math.min(r.maxPolarAngle,c.phi)),c.makeSafe(),!0===r.enableDamping?r.target.addScaledVector(p,r.dampingFactor):r.target.add(p),r.zoomToCursor&&A||r.object.isOrthographicCamera?c.radius=clampDistance(c.radius):c.radius=clampDistance(c.radius*h),t.setFromSpherical(c),t.applyQuaternion(f),y.copy(r.target).add(t),r.object.lookAt(r.target),!0===r.enableDamping?(u.theta*=1-r.dampingFactor,u.phi*=1-r.dampingFactor,p.multiplyScalar(1-r.dampingFactor)):(u.set(0,0,0),p.set(0,0,0));let T=!1;if(r.zoomToCursor&&A){let i=null;if(r.object instanceof d.PerspectiveCamera&&r.object.isPerspectiveCamera){let e=t.length();i=clampDistance(e*h);let a=e-i;r.object.position.addScaledVector(E,a),r.object.updateMatrixWorld()}else if(r.object.isOrthographicCamera){let e=new d.Vector3(R.x,R.y,0);e.unproject(r.object),r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/h)),r.object.updateProjectionMatrix(),T=!0;let a=new d.Vector3(R.x,R.y,0);a.unproject(r.object),r.object.position.sub(a).add(e),r.object.updateMatrixWorld(),i=t.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),r.zoomToCursor=!1;null!==i&&(r.screenSpacePanning?r.target.set(0,0,-1).transformDirection(r.object.matrix).multiplyScalar(i).add(r.object.position):(eL.origin.copy(r.object.position),eL.direction.set(0,0,-1).transformDirection(r.object.matrix),Math.abs(r.object.up.dot(eL.direction))<eD?e.lookAt(r.target):(eF.setFromNormalAndCoplanarPoint(r.object.up,r.target),eL.intersectPlane(eF,r.target))))}else r.object instanceof d.OrthographicCamera&&r.object.isOrthographicCamera&&(r.object.zoom=Math.max(r.minZoom,Math.min(r.maxZoom,r.object.zoom/h)),r.object.updateProjectionMatrix(),T=!0);return h=1,A=!1,!!(T||m.distanceToSquared(r.object.position)>l||8*(1-g.dot(r.object.quaternion))>l)&&(r.dispatchEvent(i),m.copy(r.object.position),g.copy(r.object.quaternion),T=!1,!0)}})(),this.connect=e=>{e===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),r.domElement=e,r.domElement.style.touchAction="none",r.domElement.addEventListener("contextmenu",onContextMenu),r.domElement.addEventListener("pointerdown",onPointerDown),r.domElement.addEventListener("pointercancel",onPointerCancel),r.domElement.addEventListener("wheel",onMouseWheel)},this.dispose=()=>{var e,t,i,a,n,s;null==(e=r.domElement)||e.removeEventListener("contextmenu",onContextMenu),null==(t=r.domElement)||t.removeEventListener("pointerdown",onPointerDown),null==(i=r.domElement)||i.removeEventListener("pointercancel",onPointerCancel),null==(a=r.domElement)||a.removeEventListener("wheel",onMouseWheel),null==(n=r.domElement)||n.removeEventListener("pointermove",onPointerMove),null==(s=r.domElement)||s.removeEventListener("pointerup",onPointerUp),null!==r._domElementKeyEvents&&r._domElementKeyEvents.removeEventListener("keydown",onKeyDown)};let r=this,i={type:"change"},a={type:"start"},n={type:"end"},s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},o=s.NONE,l=1e-6,c=new d.Spherical,u=new d.Spherical,h=1,p=new d.Vector3,f=new d.Vector2,m=new d.Vector2,g=new d.Vector2,v=new d.Vector2,y=new d.Vector2,x=new d.Vector2,b=new d.Vector2,T=new d.Vector2,S=new d.Vector2,E=new d.Vector3,R=new d.Vector2,A=!1,C=[],M={};function getAutoRotationAngle(){return 2*Math.PI/60/60*r.autoRotateSpeed}function getZoomScale(){return Math.pow(.95,r.zoomSpeed)}function rotateLeft(e){r.reverseOrbit||r.reverseHorizontalOrbit?u.theta+=e:u.theta-=e}function rotateUp(e){r.reverseOrbit||r.reverseVerticalOrbit?u.phi+=e:u.phi-=e}let P=(()=>{let e=new d.Vector3;return function(t,r){e.setFromMatrixColumn(r,0),e.multiplyScalar(-t),p.add(e)}})(),w=(()=>{let e=new d.Vector3;return function(t,i){!0===r.screenSpacePanning?e.setFromMatrixColumn(i,1):(e.setFromMatrixColumn(i,0),e.crossVectors(r.object.up,e)),e.multiplyScalar(t),p.add(e)}})(),I=(()=>{let e=new d.Vector3;return function(t,i){let a=r.domElement;if(a&&r.object instanceof d.PerspectiveCamera&&r.object.isPerspectiveCamera){let n=r.object.position;e.copy(n).sub(r.target);let s=e.length();P(2*t*(s*=Math.tan(r.object.fov/2*Math.PI/180))/a.clientHeight,r.object.matrix),w(2*i*s/a.clientHeight,r.object.matrix)}else a&&r.object instanceof d.OrthographicCamera&&r.object.isOrthographicCamera?(P(t*(r.object.right-r.object.left)/r.object.zoom/a.clientWidth,r.object.matrix),w(i*(r.object.top-r.object.bottom)/r.object.zoom/a.clientHeight,r.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),r.enablePan=!1)}})();function dollyOut(e){r.object instanceof d.PerspectiveCamera&&r.object.isPerspectiveCamera||r.object instanceof d.OrthographicCamera&&r.object.isOrthographicCamera?h/=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function dollyIn(e){r.object instanceof d.PerspectiveCamera&&r.object.isPerspectiveCamera||r.object instanceof d.OrthographicCamera&&r.object.isOrthographicCamera?h*=e:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),r.enableZoom=!1)}function updateMouseParameters(e){if(!r.zoomToCursor||!r.domElement)return;A=!0;let t=r.domElement.getBoundingClientRect(),i=e.clientX-t.left,a=e.clientY-t.top,n=t.width,s=t.height;R.x=i/n*2-1,R.y=-(2*(a/s))+1,E.set(R.x,R.y,1).unproject(r.object).sub(r.object.position).normalize()}function clampDistance(e){return Math.max(r.minDistance,Math.min(r.maxDistance,e))}function handleMouseDownRotate(e){f.set(e.clientX,e.clientY)}function handleMouseDownDolly(e){updateMouseParameters(e),b.set(e.clientX,e.clientY)}function handleMouseDownPan(e){v.set(e.clientX,e.clientY)}function handleMouseMoveRotate(e){m.set(e.clientX,e.clientY),g.subVectors(m,f).multiplyScalar(r.rotateSpeed);let t=r.domElement;t&&(rotateLeft(2*Math.PI*g.x/t.clientHeight),rotateUp(2*Math.PI*g.y/t.clientHeight)),f.copy(m),r.update()}function handleMouseMoveDolly(e){T.set(e.clientX,e.clientY),S.subVectors(T,b),S.y>0?dollyOut(getZoomScale()):S.y<0&&dollyIn(getZoomScale()),b.copy(T),r.update()}function handleMouseMovePan(e){y.set(e.clientX,e.clientY),x.subVectors(y,v).multiplyScalar(r.panSpeed),I(x.x,x.y),v.copy(y),r.update()}function handleMouseWheel(e){updateMouseParameters(e),e.deltaY<0?dollyIn(getZoomScale()):e.deltaY>0&&dollyOut(getZoomScale()),r.update()}function handleKeyDown(e){let t=!1;switch(e.code){case r.keys.UP:I(0,r.keyPanSpeed),t=!0;break;case r.keys.BOTTOM:I(0,-r.keyPanSpeed),t=!0;break;case r.keys.LEFT:I(r.keyPanSpeed,0),t=!0;break;case r.keys.RIGHT:I(-r.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),r.update())}function handleTouchStartRotate(){if(1==C.length)f.set(C[0].pageX,C[0].pageY);else{let e=.5*(C[0].pageX+C[1].pageX),t=.5*(C[0].pageY+C[1].pageY);f.set(e,t)}}function handleTouchStartPan(){if(1==C.length)v.set(C[0].pageX,C[0].pageY);else{let e=.5*(C[0].pageX+C[1].pageX),t=.5*(C[0].pageY+C[1].pageY);v.set(e,t)}}function handleTouchStartDolly(){let e=C[0].pageX-C[1].pageX,t=C[0].pageY-C[1].pageY;b.set(0,Math.sqrt(e*e+t*t))}function handleTouchStartDollyPan(){r.enableZoom&&handleTouchStartDolly(),r.enablePan&&handleTouchStartPan()}function handleTouchStartDollyRotate(){r.enableZoom&&handleTouchStartDolly(),r.enableRotate&&handleTouchStartRotate()}function handleTouchMoveRotate(e){if(1==C.length)m.set(e.pageX,e.pageY);else{let t=getSecondPointerPosition(e),r=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);m.set(r,i)}g.subVectors(m,f).multiplyScalar(r.rotateSpeed);let t=r.domElement;t&&(rotateLeft(2*Math.PI*g.x/t.clientHeight),rotateUp(2*Math.PI*g.y/t.clientHeight)),f.copy(m)}function handleTouchMovePan(e){if(1==C.length)y.set(e.pageX,e.pageY);else{let t=getSecondPointerPosition(e),r=.5*(e.pageX+t.x),i=.5*(e.pageY+t.y);y.set(r,i)}x.subVectors(y,v).multiplyScalar(r.panSpeed),I(x.x,x.y),v.copy(y)}function handleTouchMoveDolly(e){let t=getSecondPointerPosition(e),i=e.pageX-t.x,a=e.pageY-t.y;T.set(0,Math.sqrt(i*i+a*a)),S.set(0,Math.pow(T.y/b.y,r.zoomSpeed)),dollyOut(S.y),b.copy(T)}function handleTouchMoveDollyPan(e){r.enableZoom&&handleTouchMoveDolly(e),r.enablePan&&handleTouchMovePan(e)}function handleTouchMoveDollyRotate(e){r.enableZoom&&handleTouchMoveDolly(e),r.enableRotate&&handleTouchMoveRotate(e)}function onPointerDown(e){var t,i,a;!1!==r.enabled&&(0===C.length&&(null==(t=r.domElement)||t.setPointerCapture(e.pointerId),null==(i=r.domElement)||i.addEventListener("pointermove",onPointerMove),null==(a=r.domElement)||a.addEventListener("pointerup",onPointerUp)),addPointer(e),"touch"===e.pointerType?onTouchStart(e):onMouseDown(e))}function onPointerMove(e){!1!==r.enabled&&("touch"===e.pointerType?onTouchMove(e):onMouseMove(e))}function onPointerUp(e){var t,i,a;removePointer(e),0===C.length&&(null==(t=r.domElement)||t.releasePointerCapture(e.pointerId),null==(i=r.domElement)||i.removeEventListener("pointermove",onPointerMove),null==(a=r.domElement)||a.removeEventListener("pointerup",onPointerUp)),r.dispatchEvent(n),o=s.NONE}function onPointerCancel(e){removePointer(e)}function onMouseDown(e){let t;switch(e.button){case 0:t=r.mouseButtons.LEFT;break;case 1:t=r.mouseButtons.MIDDLE;break;case 2:t=r.mouseButtons.RIGHT;break;default:t=-1}switch(t){case d.MOUSE.DOLLY:if(!1===r.enableZoom)return;handleMouseDownDolly(e),o=s.DOLLY;break;case d.MOUSE.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===r.enablePan)return;handleMouseDownPan(e),o=s.PAN}else{if(!1===r.enableRotate)return;handleMouseDownRotate(e),o=s.ROTATE}break;case d.MOUSE.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===r.enableRotate)return;handleMouseDownRotate(e),o=s.ROTATE}else{if(!1===r.enablePan)return;handleMouseDownPan(e),o=s.PAN}break;default:o=s.NONE}o!==s.NONE&&r.dispatchEvent(a)}function onMouseMove(e){if(!1!==r.enabled)switch(o){case s.ROTATE:if(!1===r.enableRotate)return;handleMouseMoveRotate(e);break;case s.DOLLY:if(!1===r.enableZoom)return;handleMouseMoveDolly(e);break;case s.PAN:if(!1===r.enablePan)return;handleMouseMovePan(e)}}function onMouseWheel(e){!1!==r.enabled&&!1!==r.enableZoom&&(o===s.NONE||o===s.ROTATE)&&(e.preventDefault(),r.dispatchEvent(a),handleMouseWheel(e),r.dispatchEvent(n))}function onKeyDown(e){!1!==r.enabled&&!1!==r.enablePan&&handleKeyDown(e)}function onTouchStart(e){switch(trackPointer(e),C.length){case 1:switch(r.touches.ONE){case d.TOUCH.ROTATE:if(!1===r.enableRotate)return;handleTouchStartRotate(),o=s.TOUCH_ROTATE;break;case d.TOUCH.PAN:if(!1===r.enablePan)return;handleTouchStartPan(),o=s.TOUCH_PAN;break;default:o=s.NONE}break;case 2:switch(r.touches.TWO){case d.TOUCH.DOLLY_PAN:if(!1===r.enableZoom&&!1===r.enablePan)return;handleTouchStartDollyPan(),o=s.TOUCH_DOLLY_PAN;break;case d.TOUCH.DOLLY_ROTATE:if(!1===r.enableZoom&&!1===r.enableRotate)return;handleTouchStartDollyRotate(),o=s.TOUCH_DOLLY_ROTATE;break;default:o=s.NONE}break;default:o=s.NONE}o!==s.NONE&&r.dispatchEvent(a)}function onTouchMove(e){switch(trackPointer(e),o){case s.TOUCH_ROTATE:if(!1===r.enableRotate)return;handleTouchMoveRotate(e),r.update();break;case s.TOUCH_PAN:if(!1===r.enablePan)return;handleTouchMovePan(e),r.update();break;case s.TOUCH_DOLLY_PAN:if(!1===r.enableZoom&&!1===r.enablePan)return;handleTouchMoveDollyPan(e),r.update();break;case s.TOUCH_DOLLY_ROTATE:if(!1===r.enableZoom&&!1===r.enableRotate)return;handleTouchMoveDollyRotate(e),r.update();break;default:o=s.NONE}}function onContextMenu(e){!1!==r.enabled&&e.preventDefault()}function addPointer(e){C.push(e)}function removePointer(e){delete M[e.pointerId];for(let t=0;t<C.length;t++)if(C[t].pointerId==e.pointerId){C.splice(t,1);return}}function trackPointer(e){let t=M[e.pointerId];void 0===t&&(t=new d.Vector2,M[e.pointerId]=t),t.set(e.pageX,e.pageY)}function getSecondPointerPosition(e){let t=e.pointerId===C[0].pointerId?C[1]:C[0];return M[t.pointerId]}void 0!==t&&this.connect(t),this.update()}};let Pass=class Pass{constructor(){__publicField(this,"enabled",!0),__publicField(this,"needsSwap",!0),__publicField(this,"clear",!1),__publicField(this,"renderToScreen",!1)}setSize(e,t){}render(e,t,r,i,a){console.error("THREE.Pass: .render() must be implemented in derived pass.")}};let FullScreenQuad=class FullScreenQuad{constructor(e){__publicField(this,"camera",new d.OrthographicCamera(-1,1,1,-1,0,1)),__publicField(this,"geometry",new d.PlaneGeometry(2,2)),__publicField(this,"mesh"),this.mesh=new d.Mesh(this.geometry,e)}get material(){return this.mesh.material}set material(e){this.mesh.material=e}dispose(){this.mesh.geometry.dispose()}render(e){e.render(this.mesh,this.camera)}};let eU={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform float opacity;\nuniform sampler2D tDiffuse;\nvarying vec2 vUv;\nvoid main() {\n	vec4 texel = texture2D( tDiffuse, vUv );\n	gl_FragColor = opacity * texel;\n}"},eB={defines:{PERSPECTIVE_CAMERA:1,KERNEL_SIZE:32},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tDepth:{value:null},tNoise:{value:null},kernel:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new d.Vector2},cameraProjectionMatrix:{value:new d.Matrix4},cameraInverseProjectionMatrix:{value:new d.Matrix4},kernelRadius:{value:8},minDistance:{value:.005},maxDistance:{value:.05}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D tDiffuse;\nuniform sampler2D tNormal;\nuniform sampler2D tDepth;\nuniform sampler2D tNoise;\nuniform vec3 kernel[ KERNEL_SIZE ];\nuniform vec2 resolution;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform mat4 cameraProjectionMatrix;\nuniform mat4 cameraInverseProjectionMatrix;\nuniform float kernelRadius;\nuniform float minDistance;\nuniform float maxDistance;\nvarying vec2 vUv;\n#include <packing>\nfloat getDepth( const in vec2 screenPosition ) {\n	return texture2D( tDepth, screenPosition ).x;\n}\nfloat getLinearDepth( const in vec2 screenPosition ) {\n	#if PERSPECTIVE_CAMERA == 1\n		float fragCoordZ = texture2D( tDepth, screenPosition ).x;\n		float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n		return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n	#else\n		return texture2D( tDepth, screenPosition ).x;\n	#endif\n}\nfloat getViewZ( const in float depth ) {\n	#if PERSPECTIVE_CAMERA == 1\n		return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n	#else\n		return orthographicDepthToViewZ( depth, cameraNear, cameraFar );\n	#endif\n}\nvec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {\n	float clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];\n	vec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );\n	clipPosition *= clipW; // unprojection.\n	return ( cameraInverseProjectionMatrix * clipPosition ).xyz;\n}\nvec3 getViewNormal( const in vec2 screenPosition ) {\n	return unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );\n}\nvoid main() {\n	float depth = getDepth( vUv );\n	float viewZ = getViewZ( depth );\n	vec3 viewPosition = getViewPosition( vUv, depth, viewZ );\n	vec3 viewNormal = getViewNormal( vUv );\n vec2 noiseScale = vec2( resolution.x / 4.0, resolution.y / 4.0 );\n	vec3 random = texture2D( tNoise, vUv * noiseScale ).xyz;\n	vec3 tangent = normalize( random - viewNormal * dot( random, viewNormal ) );\n	vec3 bitangent = cross( viewNormal, tangent );\n	mat3 kernelMatrix = mat3( tangent, bitangent, viewNormal );\n float occlusion = 0.0;\n for ( int i = 0; i < KERNEL_SIZE; i ++ ) {\n		vec3 sampleVector = kernelMatrix * kernel[ i ];\n		vec3 samplePoint = viewPosition + ( sampleVector * kernelRadius );\n		vec4 samplePointNDC = cameraProjectionMatrix * vec4( samplePoint, 1.0 );\n		samplePointNDC /= samplePointNDC.w;\n		vec2 samplePointUv = samplePointNDC.xy * 0.5 + 0.5;\n		float realDepth = getLinearDepth( samplePointUv );\n		float sampleDepth = viewZToOrthographicDepth( samplePoint.z, cameraNear, cameraFar );\n		float delta = sampleDepth - realDepth;\n		if ( delta > minDistance && delta < maxDistance ) {\n			occlusion += 1.0;\n		}\n	}\n	occlusion = clamp( occlusion / float( KERNEL_SIZE ), 0.0, 1.0 );\n	gl_FragColor = vec4( vec3( 1.0 - occlusion ), 1.0 );\n}"},eV={defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D tDepth;\nuniform float cameraNear;\nuniform float cameraFar;\nvarying vec2 vUv;\n#include <packing>\nfloat getLinearDepth( const in vec2 screenPosition ) {\n	#if PERSPECTIVE_CAMERA == 1\n		float fragCoordZ = texture2D( tDepth, screenPosition ).x;\n		float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n		return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n	#else\n		return texture2D( tDepth, screenPosition ).x;\n	#endif\n}\nvoid main() {\n	float depth = getLinearDepth( vUv );\n	gl_FragColor = vec4( vec3( 1.0 - depth ), 1.0 );\n}"},eG={uniforms:{tDiffuse:{value:null},resolution:{value:new d.Vector2}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D tDiffuse;\nuniform vec2 resolution;\nvarying vec2 vUv;\nvoid main() {\n	vec2 texelSize = ( 1.0 / resolution );\n	float result = 0.0;\n	for ( int i = - 2; i <= 2; i ++ ) {\n		for ( int j = - 2; j <= 2; j ++ ) {\n			vec2 offset = ( vec2( float( i ), float( j ) ) ) * texelSize;\n			result += texture2D( tDiffuse, vUv + offset ).r;\n		}\n	}\n	gl_FragColor = vec4( vec3( result / ( 5.0 * 5.0 ) ), 1.0 );\n}"},ez=class extends Pass{constructor(e,t,r,i){super(),this.width=void 0!==r?r:512,this.height=void 0!==i?i:512,this.clear=!0,this.camera=t,this.scene=e,this.kernelRadius=8,this.kernelSize=32,this.kernel=[],this.noiseTexture=null,this.output=0,this.minDistance=.005,this.maxDistance=.1,this._visibilityCache=new Map,this.generateSampleKernel(),this.generateRandomKernelRotations();let a=new d.DepthTexture;a.format=d.DepthStencilFormat,a.type=d.UnsignedInt248Type,this.beautyRenderTarget=new d.WebGLRenderTarget(this.width,this.height),this.normalRenderTarget=new d.WebGLRenderTarget(this.width,this.height,{minFilter:d.NearestFilter,magFilter:d.NearestFilter,depthTexture:a}),this.ssaoRenderTarget=new d.WebGLRenderTarget(this.width,this.height),this.blurRenderTarget=this.ssaoRenderTarget.clone(),void 0===eB&&console.error("THREE.SSAOPass: The pass relies on SSAOShader."),this.ssaoMaterial=new d.ShaderMaterial({defines:Object.assign({},eB.defines),uniforms:d.UniformsUtils.clone(eB.uniforms),vertexShader:eB.vertexShader,fragmentShader:eB.fragmentShader,blending:d.NoBlending}),this.ssaoMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.ssaoMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.ssaoMaterial.uniforms.tDepth.value=this.normalRenderTarget.depthTexture,this.ssaoMaterial.uniforms.tNoise.value=this.noiseTexture,this.ssaoMaterial.uniforms.kernel.value=this.kernel,this.ssaoMaterial.uniforms.cameraNear.value=this.camera.near,this.ssaoMaterial.uniforms.cameraFar.value=this.camera.far,this.ssaoMaterial.uniforms.resolution.value.set(this.width,this.height),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.normalMaterial=new d.MeshNormalMaterial,this.normalMaterial.blending=d.NoBlending,this.blurMaterial=new d.ShaderMaterial({defines:Object.assign({},eG.defines),uniforms:d.UniformsUtils.clone(eG.uniforms),vertexShader:eG.vertexShader,fragmentShader:eG.fragmentShader}),this.blurMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.blurMaterial.uniforms.resolution.value.set(this.width,this.height),this.depthRenderMaterial=new d.ShaderMaterial({defines:Object.assign({},eV.defines),uniforms:d.UniformsUtils.clone(eV.uniforms),vertexShader:eV.vertexShader,fragmentShader:eV.fragmentShader,blending:d.NoBlending}),this.depthRenderMaterial.uniforms.tDepth.value=this.normalRenderTarget.depthTexture,this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this.copyMaterial=new d.ShaderMaterial({uniforms:d.UniformsUtils.clone(eU.uniforms),vertexShader:eU.vertexShader,fragmentShader:eU.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:d.DstColorFactor,blendDst:d.ZeroFactor,blendEquation:d.AddEquation,blendSrcAlpha:d.DstAlphaFactor,blendDstAlpha:d.ZeroFactor,blendEquationAlpha:d.AddEquation}),this.fsQuad=new FullScreenQuad(null),this.originalClearColor=new d.Color}dispose(){this.beautyRenderTarget.dispose(),this.normalRenderTarget.dispose(),this.ssaoRenderTarget.dispose(),this.blurRenderTarget.dispose(),this.normalMaterial.dispose(),this.blurMaterial.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose(),this.fsQuad.dispose()}render(e,t){switch(!1===e.capabilities.isWebGL2&&(this.noiseTexture.format=d.LuminanceFormat),e.setRenderTarget(this.beautyRenderTarget),e.clear(),e.render(this.scene,this.camera),this.overrideVisibility(),this.renderOverride(e,this.normalMaterial,this.normalRenderTarget,7829503,1),this.restoreVisibility(),this.ssaoMaterial.uniforms.kernelRadius.value=this.kernelRadius,this.ssaoMaterial.uniforms.minDistance.value=this.minDistance,this.ssaoMaterial.uniforms.maxDistance.value=this.maxDistance,this.renderPass(e,this.ssaoMaterial,this.ssaoRenderTarget),this.renderPass(e,this.blurMaterial,this.blurRenderTarget),this.output){case ez.OUTPUT.SSAO:this.copyMaterial.uniforms.tDiffuse.value=this.ssaoRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case ez.OUTPUT.Blur:this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case ez.OUTPUT.Beauty:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case ez.OUTPUT.Depth:this.renderPass(e,this.depthRenderMaterial,this.renderToScreen?null:t);break;case ez.OUTPUT.Normal:this.copyMaterial.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case ez.OUTPUT.Default:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t),this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.copyMaterial.blending=d.CustomBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;default:console.warn("THREE.SSAOPass: Unknown output type.")}}renderPass(e,t,r,i,a){e.getClearColor(this.originalClearColor);let n=e.getClearAlpha(),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,null!=i&&(e.setClearColor(i),e.setClearAlpha(a||0),e.clear()),this.fsQuad.material=t,this.fsQuad.render(e),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(n)}renderOverride(e,t,r,i,a){e.getClearColor(this.originalClearColor);let n=e.getClearAlpha(),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,i=t.clearColor||i,a=t.clearAlpha||a,null!=i&&(e.setClearColor(i),e.setClearAlpha(a||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(n)}setSize(e,t){this.width=e,this.height=t,this.beautyRenderTarget.setSize(e,t),this.ssaoRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.blurRenderTarget.setSize(e,t),this.ssaoMaterial.uniforms.resolution.value.set(e,t),this.ssaoMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssaoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.blurMaterial.uniforms.resolution.value.set(e,t)}generateSampleKernel(){let e=this.kernelSize,t=this.kernel;for(let r=0;r<e;r++){let i=new d.Vector3;i.x=2*Math.random()-1,i.y=2*Math.random()-1,i.z=Math.random(),i.normalize();let a=r/e;a=d.MathUtils.lerp(.1,1,a*a),i.multiplyScalar(a),t.push(i)}}generateRandomKernelRotations(){void 0===SimplexNoise&&console.error("THREE.SSAOPass: The pass relies on SimplexNoise.");let e=new SimplexNoise,t=new Float32Array(16);for(let r=0;r<16;r++){let i=2*Math.random()-1,a=2*Math.random()-1;t[r]=e.noise3d(i,a,0)}this.noiseTexture=new d.DataTexture(t,4,4,d.RedFormat,d.FloatType),this.noiseTexture.wrapS=d.RepeatWrapping,this.noiseTexture.wrapT=d.RepeatWrapping,this.noiseTexture.needsUpdate=!0}overrideVisibility(){let e=this.scene,t=this._visibilityCache;e.traverse(function(e){t.set(e,e.visible),(e.isPoints||e.isLine)&&(e.visible=!1)})}restoreVisibility(){let e=this.scene,t=this._visibilityCache;e.traverse(function(e){let r=t.get(e);e.visible=r}),t.clear()}};__publicField(ez,"OUTPUT",{Default:0,SSAO:1,Blur:2,Beauty:3,Depth:4,Normal:5});let eH={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new d.Color(0)},defaultOpacity:{value:0}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D tDiffuse;\nuniform vec3 defaultColor;\nuniform float defaultOpacity;\nuniform float luminosityThreshold;\nuniform float smoothWidth;\nvarying vec2 vUv;\nvoid main() {\n	vec4 texel = texture2D( tDiffuse, vUv );\n	vec3 luma = vec3( 0.299, 0.587, 0.114 );\n	float v = dot( texel.xyz, luma );\n	vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );\n	float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n	gl_FragColor = mix( outputColor, texel, alpha );\n}"},ej=class extends Pass{constructor(e,t,r,i){super(),this.strength=void 0!==t?t:1,this.radius=r,this.threshold=i,this.resolution=void 0!==e?new d.Vector2(e.x,e.y):new d.Vector2(256,256),this.clearColor=new d.Color(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let a=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);this.renderTargetBright=new d.WebGLRenderTarget(a,n,{type:d.HalfFloatType}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let e=0;e<this.nMips;e++){let t=new d.WebGLRenderTarget(a,n,{type:d.HalfFloatType});t.texture.name="UnrealBloomPass.h"+e,t.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(t);let r=new d.WebGLRenderTarget(a,n,{type:d.HalfFloatType});r.texture.name="UnrealBloomPass.v"+e,r.texture.generateMipmaps=!1,this.renderTargetsVertical.push(r),a=Math.round(a/2),n=Math.round(n/2)}this.highPassUniforms=d.UniformsUtils.clone(eH.uniforms),this.highPassUniforms.luminosityThreshold.value=i,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new d.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:eH.vertexShader,fragmentShader:eH.fragmentShader,defines:{}}),this.separableBlurMaterials=[];let s=[3,5,7,9,11];a=Math.round(this.resolution.x/2),n=Math.round(this.resolution.y/2);for(let e=0;e<this.nMips;e++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(s[e])),this.separableBlurMaterials[e].uniforms.texSize.value=new d.Vector2(a,n),a=Math.round(a/2),n=Math.round(n/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=t,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0,this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new d.Vector3(1,1,1),new d.Vector3(1,1,1),new d.Vector3(1,1,1),new d.Vector3(1,1,1),new d.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,this.copyUniforms=d.UniformsUtils.clone(eU.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new d.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:eU.vertexShader,fragmentShader:eU.fragmentShader,blending:d.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new d.Color,this.oldClearAlpha=1,this.basic=new d.MeshBasicMaterial,this.fsQuad=new FullScreenQuad(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.materialCopy.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(e,t){let r=Math.round(e/2),i=Math.round(t/2);this.renderTargetBright.setSize(r,i);for(let e=0;e<this.nMips;e++)this.renderTargetsHorizontal[e].setSize(r,i),this.renderTargetsVertical[e].setSize(r,i),this.separableBlurMaterials[e].uniforms.texSize.value=new d.Vector2(r,i),r=Math.round(r/2),i=Math.round(i/2)}render(e,t,r,i,a){e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();let n=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),a&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=r.texture,e.setRenderTarget(null),e.clear(),this.fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=r.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this.fsQuad.render(e);let s=this.renderTargetBright;for(let t=0;t<this.nMips;t++)this.fsQuad.material=this.separableBlurMaterials[t],this.separableBlurMaterials[t].uniforms.colorTexture.value=s.texture,this.separableBlurMaterials[t].uniforms.direction.value=ej.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[t]),e.clear(),this.fsQuad.render(e),this.separableBlurMaterials[t].uniforms.colorTexture.value=this.renderTargetsHorizontal[t].texture,this.separableBlurMaterials[t].uniforms.direction.value=ej.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[t]),e.clear(),this.fsQuad.render(e),s=this.renderTargetsVertical[t];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this.fsQuad.render(e),this.fsQuad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,a&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?e.setRenderTarget(null):e.setRenderTarget(r),this.fsQuad.render(e),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=n}getSeperableBlurMaterial(e){return new d.ShaderMaterial({defines:{KERNEL_RADIUS:e,SIGMA:e},uniforms:{colorTexture:{value:null},texSize:{value:new d.Vector2(.5,.5)},direction:{value:new d.Vector2(.5,.5)}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`#include <common>
				varying vec2 vUv;
				uniform sampler2D colorTexture;
				uniform vec2 texSize;
				uniform vec2 direction;

				float gaussianPdf(in float x, in float sigma) {
					return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;
				}
				void main() {
					vec2 invSize = 1.0 / texSize;
					float fSigma = float(SIGMA);
					float weightSum = gaussianPdf(0.0, fSigma);
					vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;
					for( int i = 1; i < KERNEL_RADIUS; i ++ ) {
						float x = float(i);
						float w = gaussianPdf(x, fSigma);
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;
						diffuseSum += (sample1 + sample2) * w;
						weightSum += 2.0 * w;
					}
					gl_FragColor = vec4(diffuseSum/weightSum, 1.0);
				}`})}getCompositeMaterial(e){return new d.ShaderMaterial({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`varying vec2 vUv;
				void main() {
					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
				}`,fragmentShader:`varying vec2 vUv;
				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor(const in float factor) {
					float mirrorFactor = 1.2 - factor;
					return mix(factor, mirrorFactor, bloomRadius);
				}

				void main() {
					gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +
						lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +
						lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +
						lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +
						lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
				}`})}};__publicField(ej,"BlurDirectionX",new d.Vector2(1,0)),__publicField(ej,"BlurDirectionY",new d.Vector2(0,1));let eW={defines:{NUM_SAMPLES:7,NUM_RINGS:4,NORMAL_TEXTURE:0,DIFFUSE_TEXTURE:0,DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},tDiffuse:{value:null},tNormal:{value:null},size:{value:new d.Vector2(512,512)},cameraNear:{value:1},cameraFar:{value:100},cameraProjectionMatrix:{value:new d.Matrix4},cameraInverseProjectionMatrix:{value:new d.Matrix4},scale:{value:1},intensity:{value:.1},bias:{value:.5},minResolution:{value:0},kernelRadius:{value:100},randomSeed:{value:0}},vertexShader:"varying vec2 vUv;\nvoid main() {\n	vUv = uv;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"#include <common>\nvarying vec2 vUv;\n#if DIFFUSE_TEXTURE == 1\nuniform sampler2D tDiffuse;\n#endif\nuniform sampler2D tDepth;\n#if NORMAL_TEXTURE == 1\nuniform sampler2D tNormal;\n#endif\nuniform float cameraNear;\nuniform float cameraFar;\nuniform mat4 cameraProjectionMatrix;\nuniform mat4 cameraInverseProjectionMatrix;\nuniform float scale;\nuniform float intensity;\nuniform float bias;\nuniform float kernelRadius;\nuniform float minResolution;\nuniform vec2 size;\nuniform float randomSeed;\n// RGBA depth\n#include <packing>\nvec4 getDefaultColor( const in vec2 screenPosition ) {\n	#if DIFFUSE_TEXTURE == 1\n	return texture2D( tDiffuse, vUv );\n	#else\n	return vec4( 1.0 );\n	#endif\n}\nfloat getDepth( const in vec2 screenPosition ) {\n	#if DEPTH_PACKING == 1\n	return unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );\n	#else\n	return texture2D( tDepth, screenPosition ).x;\n	#endif\n}\nfloat getViewZ( const in float depth ) {\n	#if PERSPECTIVE_CAMERA == 1\n	return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n	#else\n	return orthographicDepthToViewZ( depth, cameraNear, cameraFar );\n	#endif\n}\nvec3 getViewPosition( const in vec2 screenPosition, const in float depth, const in float viewZ ) {\n	float clipW = cameraProjectionMatrix[2][3] * viewZ + cameraProjectionMatrix[3][3];\n	vec4 clipPosition = vec4( ( vec3( screenPosition, depth ) - 0.5 ) * 2.0, 1.0 );\n	clipPosition *= clipW; // unprojection.\n	return ( cameraInverseProjectionMatrix * clipPosition ).xyz;\n}\nvec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPosition ) {\n	#if NORMAL_TEXTURE == 1\n	return unpackRGBToNormal( texture2D( tNormal, screenPosition ).xyz );\n	#else\n	return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n	#endif\n}\nfloat scaleDividedByCameraFar;\nfloat minResolutionMultipliedByCameraFar;\nfloat getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n	vec3 viewDelta = sampleViewPosition - centerViewPosition;\n	float viewDistance = length( viewDelta );\n	float scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n	return max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - bias) / (1.0 + pow2( scaledScreenDistance ) );\n}\n// moving costly divides into consts\nconst float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\nconst float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\nfloat getAmbientOcclusion( const in vec3 centerViewPosition ) {\n	// precompute some variables require in getOcclusion.\n	scaleDividedByCameraFar = scale / cameraFar;\n	minResolutionMultipliedByCameraFar = minResolution * cameraFar;\n	vec3 centerViewNormal = getViewNormal( centerViewPosition, vUv );\n	// jsfiddle that shows sample pattern: https://jsfiddle.net/a16ff1p7/\n	float angle = rand( vUv + randomSeed ) * PI2;\n	vec2 radius = vec2( kernelRadius * INV_NUM_SAMPLES ) / size;\n	vec2 radiusStep = radius;\n	float occlusionSum = 0.0;\n	float weightSum = 0.0;\n	for( int i = 0; i < NUM_SAMPLES; i ++ ) {\n		vec2 sampleUv = vUv + vec2( cos( angle ), sin( angle ) ) * radius;\n		radius += radiusStep;\n		angle += ANGLE_STEP;\n		float sampleDepth = getDepth( sampleUv );\n		if( sampleDepth >= ( 1.0 - EPSILON ) ) {\n			continue;\n		}\n		float sampleViewZ = getViewZ( sampleDepth );\n		vec3 sampleViewPosition = getViewPosition( sampleUv, sampleDepth, sampleViewZ );\n		occlusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n		weightSum += 1.0;\n	}\n	if( weightSum == 0.0 ) discard;\n	return occlusionSum * ( intensity / weightSum );\n}\nvoid main() {\n	float centerDepth = getDepth( vUv );\n	if( centerDepth >= ( 1.0 - EPSILON ) ) {\n		discard;\n	}\n	float centerViewZ = getViewZ( centerDepth );\n	vec3 viewPosition = getViewPosition( vUv, centerDepth, centerViewZ );\n	float ambientOcclusion = getAmbientOcclusion( viewPosition );\n	gl_FragColor = getDefaultColor( vUv );\n	gl_FragColor.xyz *=  1.0 - ambientOcclusion;\n}"},eK={defines:{KERNEL_RADIUS:4,DEPTH_PACKING:1,PERSPECTIVE_CAMERA:1},uniforms:{tDiffuse:{value:null},size:{value:new d.Vector2(512,512)},sampleUvOffsets:{value:[new d.Vector2(0,0)]},sampleWeights:{value:[1]},tDepth:{value:null},cameraNear:{value:10},cameraFar:{value:1e3},depthCutoff:{value:10}},vertexShader:"#include <common>\nuniform vec2 size;\nvarying vec2 vUv;\nvarying vec2 vInvSize;\nvoid main() {\n	vUv = uv;\n	vInvSize = 1.0 / size;\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"#include <common>\n#include <packing>\nuniform sampler2D tDiffuse;\nuniform sampler2D tDepth;\nuniform float cameraNear;\nuniform float cameraFar;\nuniform float depthCutoff;\nuniform vec2 sampleUvOffsets[ KERNEL_RADIUS + 1 ];\nuniform float sampleWeights[ KERNEL_RADIUS + 1 ];\nvarying vec2 vUv;\nvarying vec2 vInvSize;\nfloat getDepth( const in vec2 screenPosition ) {\n	#if DEPTH_PACKING == 1\n	return unpackRGBAToDepth( texture2D( tDepth, screenPosition ) );\n	#else\n	return texture2D( tDepth, screenPosition ).x;\n	#endif\n}\nfloat getViewZ( const in float depth ) {\n	#if PERSPECTIVE_CAMERA == 1\n	return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );\n	#else\n	return orthographicDepthToViewZ( depth, cameraNear, cameraFar );\n	#endif\n}\nvoid main() {\n	float depth = getDepth( vUv );\n	if( depth >= ( 1.0 - EPSILON ) ) {\n		discard;\n	}\n	float centerViewZ = -getViewZ( depth );\n	bool rBreak = false, lBreak = false;\n	float weightSum = sampleWeights[0];\n	vec4 diffuseSum = texture2D( tDiffuse, vUv ) * weightSum;\n	for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n		float sampleWeight = sampleWeights[i];\n		vec2 sampleUvOffset = sampleUvOffsets[i] * vInvSize;\n		vec2 sampleUv = vUv + sampleUvOffset;\n		float viewZ = -getViewZ( getDepth( sampleUv ) );\n		if( abs( viewZ - centerViewZ ) > depthCutoff ) rBreak = true;\n		if( ! rBreak ) {\n			diffuseSum += texture2D( tDiffuse, sampleUv ) * sampleWeight;\n			weightSum += sampleWeight;\n		}\n		sampleUv = vUv - sampleUvOffset;\n		viewZ = -getViewZ( getDepth( sampleUv ) );\n		if( abs( viewZ - centerViewZ ) > depthCutoff ) lBreak = true;\n		if( ! lBreak ) {\n			diffuseSum += texture2D( tDiffuse, sampleUv ) * sampleWeight;\n			weightSum += sampleWeight;\n		}\n	}\n	gl_FragColor = diffuseSum / weightSum;\n}"},eX={createSampleWeights:(e,t)=>{let gaussian=(e,t)=>Math.exp(-(e*e)/(2*(t*t)))/(Math.sqrt(2*Math.PI)*t),r=[];for(let i=0;i<=e;i++)r.push(gaussian(i,t));return r},createSampleOffsets:(e,t)=>{let r=[];for(let i=0;i<=e;i++)r.push(t.clone().multiplyScalar(i));return r},configure:(e,t,r,i)=>{e.defines.KERNEL_RADIUS=t,e.uniforms.sampleUvOffsets.value=eX.createSampleOffsets(t,i),e.uniforms.sampleWeights.value=eX.createSampleWeights(t,r),e.needsUpdate=!0}};let SAOPass=class SAOPass extends Pass{constructor(e,t,r=!1,i=!1,a=new d.Vector2(256,256)){let n;super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.supportsDepthTextureExtension=r,this.supportsNormalTexture=i,this.originalClearColor=new d.Color,this._oldClearColor=new d.Color,this.oldClearAlpha=1,this.params={output:0,saoBias:.5,saoIntensity:.18,saoScale:1,saoKernelRadius:100,saoMinResolution:0,saoBlur:!0,saoBlurRadius:8,saoBlurStdDev:4,saoBlurDepthCutoff:.01},this.resolution=new d.Vector2(a.x,a.y),this.saoRenderTarget=new d.WebGLRenderTarget(this.resolution.x,this.resolution.y,{type:d.HalfFloatType}),this.blurIntermediateRenderTarget=this.saoRenderTarget.clone(),this.beautyRenderTarget=this.saoRenderTarget.clone(),this.normalRenderTarget=new d.WebGLRenderTarget(this.resolution.x,this.resolution.y,{minFilter:d.NearestFilter,magFilter:d.NearestFilter,type:d.HalfFloatType}),this.depthRenderTarget=this.normalRenderTarget.clone(),this.supportsDepthTextureExtension&&((n=new d.DepthTexture).type=d.UnsignedShortType,this.beautyRenderTarget.depthTexture=n,this.beautyRenderTarget.depthBuffer=!0),this.depthMaterial=new d.MeshDepthMaterial,this.depthMaterial.depthPacking=d.RGBADepthPacking,this.depthMaterial.blending=d.NoBlending,this.normalMaterial=new d.MeshNormalMaterial,this.normalMaterial.blending=d.NoBlending,this.saoMaterial=new d.ShaderMaterial({defines:Object.assign({},eW.defines),fragmentShader:eW.fragmentShader,vertexShader:eW.vertexShader,uniforms:d.UniformsUtils.clone(eW.uniforms)}),this.saoMaterial.extensions.derivatives=!0,this.saoMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.saoMaterial.defines.NORMAL_TEXTURE=this.supportsNormalTexture?1:0,this.saoMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.saoMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?n:this.depthRenderTarget.texture,this.saoMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.saoMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.saoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.saoMaterial.uniforms.cameraProjectionMatrix.value=this.camera.projectionMatrix,this.saoMaterial.blending=d.NoBlending,this.vBlurMaterial=new d.ShaderMaterial({uniforms:d.UniformsUtils.clone(eK.uniforms),defines:Object.assign({},eK.defines),vertexShader:eK.vertexShader,fragmentShader:eK.fragmentShader}),this.vBlurMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.vBlurMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.vBlurMaterial.uniforms.tDiffuse.value=this.saoRenderTarget.texture,this.vBlurMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?n:this.depthRenderTarget.texture,this.vBlurMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.vBlurMaterial.blending=d.NoBlending,this.hBlurMaterial=new d.ShaderMaterial({uniforms:d.UniformsUtils.clone(eK.uniforms),defines:Object.assign({},eK.defines),vertexShader:eK.vertexShader,fragmentShader:eK.fragmentShader}),this.hBlurMaterial.defines.DEPTH_PACKING=this.supportsDepthTextureExtension?0:1,this.hBlurMaterial.defines.PERSPECTIVE_CAMERA=this.camera.isPerspectiveCamera?1:0,this.hBlurMaterial.uniforms.tDiffuse.value=this.blurIntermediateRenderTarget.texture,this.hBlurMaterial.uniforms.tDepth.value=this.supportsDepthTextureExtension?n:this.depthRenderTarget.texture,this.hBlurMaterial.uniforms.size.value.set(this.resolution.x,this.resolution.y),this.hBlurMaterial.blending=d.NoBlending,this.materialCopy=new d.ShaderMaterial({uniforms:d.UniformsUtils.clone(eU.uniforms),vertexShader:eU.vertexShader,fragmentShader:eU.fragmentShader,blending:d.NoBlending}),this.materialCopy.transparent=!0,this.materialCopy.depthTest=!1,this.materialCopy.depthWrite=!1,this.materialCopy.blending=d.CustomBlending,this.materialCopy.blendSrc=d.DstColorFactor,this.materialCopy.blendDst=d.ZeroFactor,this.materialCopy.blendEquation=d.AddEquation,this.materialCopy.blendSrcAlpha=d.DstAlphaFactor,this.materialCopy.blendDstAlpha=d.ZeroFactor,this.materialCopy.blendEquationAlpha=d.AddEquation,this.depthCopy=new d.ShaderMaterial({uniforms:d.UniformsUtils.clone(es.uniforms),vertexShader:es.vertexShader,fragmentShader:es.fragmentShader,blending:d.NoBlending}),this.fsQuad=new FullScreenQuad(null)}render(e,t,r){if(this.renderToScreen&&(this.materialCopy.blending=d.NoBlending,this.materialCopy.uniforms.tDiffuse.value=r.texture,this.materialCopy.needsUpdate=!0,this.renderPass(e,this.materialCopy,null)),1===this.params.output)return;e.getClearColor(this._oldClearColor),this.oldClearAlpha=e.getClearAlpha();let i=e.autoClear;e.autoClear=!1,e.setRenderTarget(this.depthRenderTarget),e.clear(),this.saoMaterial.uniforms.bias.value=this.params.saoBias,this.saoMaterial.uniforms.intensity.value=this.params.saoIntensity,this.saoMaterial.uniforms.scale.value=this.params.saoScale,this.saoMaterial.uniforms.kernelRadius.value=this.params.saoKernelRadius,this.saoMaterial.uniforms.minResolution.value=this.params.saoMinResolution,this.saoMaterial.uniforms.cameraNear.value=this.camera.near,this.saoMaterial.uniforms.cameraFar.value=this.camera.far;let a=this.params.saoBlurDepthCutoff*(this.camera.far-this.camera.near);this.vBlurMaterial.uniforms.depthCutoff.value=a,this.hBlurMaterial.uniforms.depthCutoff.value=a,this.vBlurMaterial.uniforms.cameraNear.value=this.camera.near,this.vBlurMaterial.uniforms.cameraFar.value=this.camera.far,this.hBlurMaterial.uniforms.cameraNear.value=this.camera.near,this.hBlurMaterial.uniforms.cameraFar.value=this.camera.far,this.params.saoBlurRadius=Math.floor(this.params.saoBlurRadius),(this.prevStdDev!==this.params.saoBlurStdDev||this.prevNumSamples!==this.params.saoBlurRadius)&&(eX.configure(this.vBlurMaterial,this.params.saoBlurRadius,this.params.saoBlurStdDev,new d.Vector2(0,1)),eX.configure(this.hBlurMaterial,this.params.saoBlurRadius,this.params.saoBlurStdDev,new d.Vector2(1,0)),this.prevStdDev=this.params.saoBlurStdDev,this.prevNumSamples=this.params.saoBlurRadius),e.setClearColor(0),e.setRenderTarget(this.beautyRenderTarget),e.clear(),e.render(this.scene,this.camera),this.supportsDepthTextureExtension||this.renderOverride(e,this.depthMaterial,this.depthRenderTarget,0,1),this.supportsNormalTexture&&this.renderOverride(e,this.normalMaterial,this.normalRenderTarget,7829503,1),this.renderPass(e,this.saoMaterial,this.saoRenderTarget,16777215,1),this.params.saoBlur&&(this.renderPass(e,this.vBlurMaterial,this.blurIntermediateRenderTarget,16777215,1),this.renderPass(e,this.hBlurMaterial,this.saoRenderTarget,16777215,1));let n=this.materialCopy;3===this.params.output?this.supportsDepthTextureExtension?(this.materialCopy.uniforms.tDiffuse.value=this.beautyRenderTarget.depthTexture,this.materialCopy.needsUpdate=!0):(this.depthCopy.uniforms.tDiffuse.value=this.depthRenderTarget.texture,this.depthCopy.needsUpdate=!0,n=this.depthCopy):(4===this.params.output?this.materialCopy.uniforms.tDiffuse.value=this.normalRenderTarget.texture:this.materialCopy.uniforms.tDiffuse.value=this.saoRenderTarget.texture,this.materialCopy.needsUpdate=!0),0===this.params.output?n.blending=d.CustomBlending:n.blending=d.NoBlending,this.renderPass(e,n,this.renderToScreen?null:r),e.setClearColor(this._oldClearColor,this.oldClearAlpha),e.autoClear=i}renderPass(e,t,r,i,a){e.getClearColor(this.originalClearColor);let n=e.getClearAlpha(),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,null!=i&&(e.setClearColor(i),e.setClearAlpha(a||0),e.clear()),this.fsQuad.material=t,this.fsQuad.render(e),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(n)}renderOverride(e,t,r,i,a){e.getClearColor(this.originalClearColor);let n=e.getClearAlpha(),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,i=t.clearColor||i,a=t.clearAlpha||a,null!=i&&(e.setClearColor(i),e.setClearAlpha(a||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(n)}setSize(e,t){this.beautyRenderTarget.setSize(e,t),this.saoRenderTarget.setSize(e,t),this.blurIntermediateRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.depthRenderTarget.setSize(e,t),this.saoMaterial.uniforms.size.value.set(e,t),this.saoMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.saoMaterial.uniforms.cameraProjectionMatrix.value=this.camera.projectionMatrix,this.saoMaterial.needsUpdate=!0,this.vBlurMaterial.uniforms.size.value.set(e,t),this.vBlurMaterial.needsUpdate=!0,this.hBlurMaterial.uniforms.size.value.set(e,t),this.hBlurMaterial.needsUpdate=!0}dispose(){this.saoRenderTarget.dispose(),this.blurIntermediateRenderTarget.dispose(),this.beautyRenderTarget.dispose(),this.normalRenderTarget.dispose(),this.depthRenderTarget.dispose(),this.depthMaterial.dispose(),this.normalMaterial.dispose(),this.saoMaterial.dispose(),this.vBlurMaterial.dispose(),this.hBlurMaterial.dispose(),this.materialCopy.dispose(),this.depthCopy.dispose(),this.fsQuad.dispose()}};__publicField(SAOPass,"OUTPUT",{Beauty:1,Default:0,SAO:2,Depth:3,Normal:4});let eY={defines:{MAX_STEP:0,isPerspectiveCamera:!0,isDistanceAttenuation:!0,isFresnel:!0,isInfiniteThick:!1,isSelective:!1},uniforms:{tDiffuse:{value:null},tNormal:{value:null},tMetalness:{value:null},tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null},resolution:{value:new d.Vector2},cameraProjectionMatrix:{value:new d.Matrix4},cameraInverseProjectionMatrix:{value:new d.Matrix4},opacity:{value:.5},maxDistance:{value:180},cameraRange:{value:0},surfDist:{value:.007},thickTolerance:{value:.03}},vertexShader:`

    varying vec2 vUv;

    void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }

  `,fragmentShader:`
		// precision highp float;
		precision highp sampler2D;
		varying vec2 vUv;
		uniform sampler2D tDepth;
		uniform sampler2D tNormal;
		uniform sampler2D tMetalness;
		uniform sampler2D tDiffuse;
		uniform float cameraRange;
		uniform vec2 resolution;
		uniform float opacity;
		uniform float cameraNear;
		uniform float cameraFar;
		uniform float maxDistance;
		uniform float surfDist;
		uniform mat4 cameraProjectionMatrix;
		uniform mat4 cameraInverseProjectionMatrix;
		uniform float thickTolerance;
		#include <packing>
		float pointToLineDistance(vec3 x0, vec3 x1, vec3 x2) {
			//x0: point, x1: linePointA, x2: linePointB
			//https://mathworld.wolfram.com/Point-LineDistance3-Dimensional.html
			return length(cross(x0-x1,x0-x2))/length(x2-x1);
		}
		float pointPlaneDistance(vec3 point,vec3 planePoint,vec3 planeNormal){
			// https://mathworld.wolfram.com/Point-PlaneDistance.html
			//// https://en.wikipedia.org/wiki/Plane_(geometry)
			//// http://paulbourke.net/geometry/pointlineplane/
			float a=planeNormal.x,b=planeNormal.y,c=planeNormal.z;
			float x0=point.x,y0=point.y,z0=point.z;
			float x=planePoint.x,y=planePoint.y,z=planePoint.z;
			float d=-(a*x+b*y+c*z);
			float distance=(a*x0+b*y0+c*z0+d)/sqrt(a*a+b*b+c*c);
			return distance;
		}
		float getDepth( const in vec2 uv ) {
			return texture2D( tDepth, uv ).x;
		}
		float getViewZ( const in float depth ) {
			#ifdef isPerspectiveCamera
				return perspectiveDepthToViewZ( depth, cameraNear, cameraFar );
			#else
				return orthographicDepthToViewZ( depth, cameraNear, cameraFar );
			#endif
		}
		vec3 getViewPosition( const in vec2 uv, const in float depth/*clip space*/, const in float clipW ) {
			vec4 clipPosition = vec4( ( vec3( uv, depth ) - 0.5 ) * 2.0, 1.0 );//ndc
			clipPosition *= clipW; //clip
			return ( cameraInverseProjectionMatrix * clipPosition ).xyz;//view
		}
		vec3 getViewNormal( const in vec2 uv ) {
			return unpackRGBToNormal( texture2D( tNormal, uv ).xyz );
		}
		vec2 viewPositionToXY(vec3 viewPosition){
			vec2 xy;
			vec4 clip=cameraProjectionMatrix*vec4(viewPosition,1);
			xy=clip.xy;//clip
			float clipW=clip.w;
			xy/=clipW;//NDC
			xy=(xy+1.)/2.;//uv
			xy*=resolution;//screen
			return xy;
		}
		void main(){
			#ifdef isSelective
				float metalness=texture2D(tMetalness,vUv).r;
				if(metalness==0.) return;
			#endif

			float depth = getDepth( vUv );
			float viewZ = getViewZ( depth );
			if(-viewZ>=cameraFar) return;

			float clipW = cameraProjectionMatrix[2][3] * viewZ+cameraProjectionMatrix[3][3];
			vec3 viewPosition=getViewPosition( vUv, depth, clipW );

			vec2 d0=gl_FragCoord.xy;
			vec2 d1;

			vec3 viewNormal=getViewNormal( vUv );

			#ifdef isPerspectiveCamera
				vec3 viewIncidenceDir=normalize(viewPosition);
				vec3 viewReflectDir=reflect(viewIncidenceDir,viewNormal);
			#else
				vec3 viewIncidenceDir=vec3(0,0,-1);
				vec3 viewReflectDir=reflect(viewIncidenceDir,viewNormal);
			#endif

			float maxReflectRayLen=maxDistance/dot(-viewIncidenceDir,viewNormal);
			// dot(a,b)==length(a)*length(b)*cos(theta) // https://www.mathsisfun.com/algebra/vectors-dot-product.html
			// if(a.isNormalized&&b.isNormalized) dot(a,b)==cos(theta)
			// maxDistance/maxReflectRayLen=cos(theta)
			// maxDistance/maxReflectRayLen==dot(a,b)
			// maxReflectRayLen==maxDistance/dot(a,b)

			vec3 d1viewPosition=viewPosition+viewReflectDir*maxReflectRayLen;
			#ifdef isPerspectiveCamera
				if(d1viewPosition.z>-cameraNear){
					//https://tutorial.math.lamar.edu/Classes/CalcIII/EqnsOfLines.aspx
					float t=(-cameraNear-viewPosition.z)/viewReflectDir.z;
					d1viewPosition=viewPosition+viewReflectDir*t;
				}
			#endif
			d1=viewPositionToXY(d1viewPosition);

			float totalLen=length(d1-d0);
			float xLen=d1.x-d0.x;
			float yLen=d1.y-d0.y;
			float totalStep=max(abs(xLen),abs(yLen));
			float xSpan=xLen/totalStep;
			float ySpan=yLen/totalStep;
			for(float i=0.;i<MAX_STEP;i++){
				if(i>=totalStep) break;
				vec2 xy=vec2(d0.x+i*xSpan,d0.y+i*ySpan);
				if(xy.x<0.||xy.x>resolution.x||xy.y<0.||xy.y>resolution.y) break;
				float s=length(xy-d0)/totalLen;
				vec2 uv=xy/resolution;

				float d = getDepth(uv);
				float vZ = getViewZ( d );
				if(-vZ>=cameraFar) continue;
				float cW = cameraProjectionMatrix[2][3] * vZ+cameraProjectionMatrix[3][3];
				vec3 vP=getViewPosition( uv, d, cW );

				#ifdef isPerspectiveCamera
					// https://www.comp.nus.edu.sg/~lowkl/publications/lowk_persp_interp_techrep.pdf
					float recipVPZ=1./viewPosition.z;
					float viewReflectRayZ=1./(recipVPZ+s*(1./d1viewPosition.z-recipVPZ));
					float sD=surfDist*cW;
				#else
					float viewReflectRayZ=viewPosition.z+s*(d1viewPosition.z-viewPosition.z);
					float sD=surfDist;
				#endif
				if(viewReflectRayZ-sD>vZ) continue;

				#ifdef isInfiniteThick
					if(viewReflectRayZ+thickTolerance*clipW<vP.z) break;
				#endif
				float away=pointToLineDistance(vP,viewPosition,d1viewPosition);

				float op=opacity;

				if(away<sD){
					vec3 vN=getViewNormal( uv );
					if(dot(viewReflectDir,vN)>=0.) continue;
					float distance=pointPlaneDistance(vP,viewPosition,viewNormal);
					if(distance>maxDistance) break;
					#ifdef isDistanceAttenuation
						float ratio=1.-(distance/maxDistance);
						float attenuation=ratio*ratio;
						op=opacity*attenuation;
					#endif
					#ifdef isFresnel
						float fresnel=(dot(viewIncidenceDir,viewReflectDir)+1.)/2.;
						op*=fresnel;
					#endif
					vec4 reflectColor=texture2D(tDiffuse,uv);
					gl_FragColor.xyz=reflectColor.xyz;
					gl_FragColor.a=op;
					break;
				}
			}
		}
	`},eZ={defines:{PERSPECTIVE_CAMERA:1},uniforms:{tDepth:{value:null},cameraNear:{value:null},cameraFar:{value:null}},vertexShader:`

    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }

  `,fragmentShader:`

    uniform sampler2D tDepth;

    uniform float cameraNear;
    uniform float cameraFar;

    varying vec2 vUv;

    #include <packing>

		float getLinearDepth( const in vec2 uv ) {

			#if PERSPECTIVE_CAMERA == 1

				float fragCoordZ = texture2D( tDepth, uv ).x;
				float viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );
				return viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );

			#else

				return texture2D( tDepth, uv ).x;

			#endif

		}

    void main() {

    	float depth = getLinearDepth( vUv );
			float d = 1.0 - depth;
			// d=(d-.999)*1000.;
    	gl_FragColor = vec4( vec3( d ), 1.0 );

    }

  `},e$={uniforms:{tDiffuse:{value:null},resolution:{value:new d.Vector2},opacity:{value:.5}},vertexShader:`

    varying vec2 vUv;

    void main() {

    	vUv = uv;
    	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }

  `,fragmentShader:`

    uniform sampler2D tDiffuse;
    uniform vec2 resolution;
    varying vec2 vUv;
    void main() {
			//reverse engineering from PhotoShop blur filter, then change coefficient

    	vec2 texelSize = ( 1.0 / resolution );

			vec4 c=texture2D(tDiffuse,vUv);

			vec2 offset;

			offset=(vec2(-1,0))*texelSize;
			vec4 cl=texture2D(tDiffuse,vUv+offset);

			offset=(vec2(1,0))*texelSize;
			vec4 cr=texture2D(tDiffuse,vUv+offset);

			offset=(vec2(0,-1))*texelSize;
			vec4 cb=texture2D(tDiffuse,vUv+offset);

			offset=(vec2(0,1))*texelSize;
			vec4 ct=texture2D(tDiffuse,vUv+offset);

			// float coeCenter=.5;
			// float coeSide=.125;
			float coeCenter=.2;
			float coeSide=.2;
			float a=c.a*coeCenter+cl.a*coeSide+cr.a*coeSide+cb.a*coeSide+ct.a*coeSide;
			vec3 rgb=(c.rgb*c.a*coeCenter+cl.rgb*cl.a*coeSide+cr.rgb*cr.a*coeSide+cb.rgb*cb.a*coeSide+ct.rgb*ct.a*coeSide)/a;
			gl_FragColor=vec4(rgb,a);

		}
	`},eQ=class extends Pass{constructor({renderer:e,scene:t,camera:r,width:i,height:a,selects:n,bouncing:s=!1,groundReflector:o}){super(),this.width=void 0!==i?i:512,this.height=void 0!==a?a:512,this.clear=!0,this.renderer=e,this.scene=t,this.camera=r,this.groundReflector=o,this.opacity=eY.uniforms.opacity.value,this.output=0,this.maxDistance=eY.uniforms.maxDistance.value,this.thickness=eY.uniforms.thickness.value,this.tempColor=new d.Color,this._selects=n,this.selective=Array.isArray(this._selects),Object.defineProperty(this,"selects",{get(){return this._selects},set(e){this._selects!==e&&(this._selects=e,Array.isArray(e)?(this.selective=!0,this.ssrMaterial.defines.SELECTIVE=!0):(this.selective=!1,this.ssrMaterial.defines.SELECTIVE=!1),this.ssrMaterial.needsUpdate=!0)}}),this._bouncing=s,Object.defineProperty(this,"bouncing",{get(){return this._bouncing},set(e){this._bouncing!==e&&(this._bouncing=e,e?this.ssrMaterial.uniforms.tDiffuse.value=this.prevRenderTarget.texture:this.ssrMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture)}}),this.blur=!0,this._distanceAttenuation=eY.defines.DISTANCE_ATTENUATION,Object.defineProperty(this,"distanceAttenuation",{get(){return this._distanceAttenuation},set(e){this._distanceAttenuation!==e&&(this._distanceAttenuation=e,this.ssrMaterial.defines.DISTANCE_ATTENUATION=e,this.ssrMaterial.needsUpdate=!0)}}),this._fresnel=eY.defines.FRESNEL,Object.defineProperty(this,"fresnel",{get(){return this._fresnel},set(e){this._fresnel!==e&&(this._fresnel=e,this.ssrMaterial.defines.FRESNEL=e,this.ssrMaterial.needsUpdate=!0)}}),this._infiniteThick=eY.defines.INFINITE_THICK,Object.defineProperty(this,"infiniteThick",{get(){return this._infiniteThick},set(e){this._infiniteThick!==e&&(this._infiniteThick=e,this.ssrMaterial.defines.INFINITE_THICK=e,this.ssrMaterial.needsUpdate=!0)}});let l=new d.DepthTexture;l.type=d.UnsignedShortType,l.minFilter=d.NearestFilter,l.magFilter=d.NearestFilter,this.beautyRenderTarget=new d.WebGLRenderTarget(this.width,this.height,{minFilter:d.NearestFilter,magFilter:d.NearestFilter,type:d.HalfFloatType,depthTexture:l,depthBuffer:!0}),this.prevRenderTarget=new d.WebGLRenderTarget(this.width,this.height,{minFilter:d.NearestFilter,magFilter:d.NearestFilter}),this.normalRenderTarget=new d.WebGLRenderTarget(this.width,this.height,{minFilter:d.NearestFilter,magFilter:d.NearestFilter,type:d.HalfFloatType}),this.metalnessRenderTarget=new d.WebGLRenderTarget(this.width,this.height,{minFilter:d.NearestFilter,magFilter:d.NearestFilter,type:d.HalfFloatType}),this.ssrRenderTarget=new d.WebGLRenderTarget(this.width,this.height,{minFilter:d.NearestFilter,magFilter:d.NearestFilter}),this.blurRenderTarget=this.ssrRenderTarget.clone(),this.blurRenderTarget2=this.ssrRenderTarget.clone(),this.ssrMaterial=new d.ShaderMaterial({defines:Object.assign({},eY.defines,{MAX_STEP:Math.sqrt(this.width*this.width+this.height*this.height)}),uniforms:d.UniformsUtils.clone(eY.uniforms),vertexShader:eY.vertexShader,fragmentShader:eY.fragmentShader,blending:d.NoBlending}),this.ssrMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.ssrMaterial.uniforms.tNormal.value=this.normalRenderTarget.texture,this.ssrMaterial.defines.SELECTIVE=this.selective,this.ssrMaterial.needsUpdate=!0,this.ssrMaterial.uniforms.tMetalness.value=this.metalnessRenderTarget.texture,this.ssrMaterial.uniforms.tDepth.value=this.beautyRenderTarget.depthTexture,this.ssrMaterial.uniforms.cameraNear.value=this.camera.near,this.ssrMaterial.uniforms.cameraFar.value=this.camera.far,this.ssrMaterial.uniforms.thickness.value=this.thickness,this.ssrMaterial.uniforms.resolution.value.set(this.width,this.height),this.ssrMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssrMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.normalMaterial=new d.MeshNormalMaterial,this.normalMaterial.blending=d.NoBlending,this.metalnessOnMaterial=new d.MeshBasicMaterial({color:"white"}),this.metalnessOffMaterial=new d.MeshBasicMaterial({color:"black"}),this.blurMaterial=new d.ShaderMaterial({defines:Object.assign({},e$.defines),uniforms:d.UniformsUtils.clone(e$.uniforms),vertexShader:e$.vertexShader,fragmentShader:e$.fragmentShader}),this.blurMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.blurMaterial.uniforms.resolution.value.set(this.width,this.height),this.blurMaterial2=new d.ShaderMaterial({defines:Object.assign({},e$.defines),uniforms:d.UniformsUtils.clone(e$.uniforms),vertexShader:e$.vertexShader,fragmentShader:e$.fragmentShader}),this.blurMaterial2.uniforms.tDiffuse.value=this.blurRenderTarget.texture,this.blurMaterial2.uniforms.resolution.value.set(this.width,this.height),this.depthRenderMaterial=new d.ShaderMaterial({defines:Object.assign({},eZ.defines),uniforms:d.UniformsUtils.clone(eZ.uniforms),vertexShader:eZ.vertexShader,fragmentShader:eZ.fragmentShader,blending:d.NoBlending}),this.depthRenderMaterial.uniforms.tDepth.value=this.beautyRenderTarget.depthTexture,this.depthRenderMaterial.uniforms.cameraNear.value=this.camera.near,this.depthRenderMaterial.uniforms.cameraFar.value=this.camera.far,this.copyMaterial=new d.ShaderMaterial({uniforms:d.UniformsUtils.clone(eU.uniforms),vertexShader:eU.vertexShader,fragmentShader:eU.fragmentShader,transparent:!0,depthTest:!1,depthWrite:!1,blendSrc:d.SrcAlphaFactor,blendDst:d.OneMinusSrcAlphaFactor,blendEquation:d.AddEquation,blendSrcAlpha:d.SrcAlphaFactor,blendDstAlpha:d.OneMinusSrcAlphaFactor,blendEquationAlpha:d.AddEquation}),this.fsQuad=new FullScreenQuad(null),this.originalClearColor=new d.Color}dispose(){this.beautyRenderTarget.dispose(),this.prevRenderTarget.dispose(),this.normalRenderTarget.dispose(),this.metalnessRenderTarget.dispose(),this.ssrRenderTarget.dispose(),this.blurRenderTarget.dispose(),this.blurRenderTarget2.dispose(),this.normalMaterial.dispose(),this.metalnessOnMaterial.dispose(),this.metalnessOffMaterial.dispose(),this.blurMaterial.dispose(),this.blurMaterial2.dispose(),this.copyMaterial.dispose(),this.depthRenderMaterial.dispose(),this.fsQuad.dispose()}render(e,t){switch(e.setRenderTarget(this.beautyRenderTarget),e.clear(),this.groundReflector&&(this.groundReflector.visible=!1,this.groundReflector.doRender(this.renderer,this.scene,this.camera),this.groundReflector.visible=!0),e.render(this.scene,this.camera),this.groundReflector&&(this.groundReflector.visible=!1),this.renderOverride(e,this.normalMaterial,this.normalRenderTarget,0,0),this.selective&&this.renderMetalness(e,this.metalnessOnMaterial,this.metalnessRenderTarget,0,0),this.ssrMaterial.uniforms.opacity.value=this.opacity,this.ssrMaterial.uniforms.maxDistance.value=this.maxDistance,this.ssrMaterial.uniforms.thickness.value=this.thickness,this.renderPass(e,this.ssrMaterial,this.ssrRenderTarget),this.blur&&(this.renderPass(e,this.blurMaterial,this.blurRenderTarget),this.renderPass(e,this.blurMaterial2,this.blurRenderTarget2)),this.output){case eQ.OUTPUT.Default:this.bouncing?(this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.prevRenderTarget),this.blur?this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget2.texture:this.copyMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.copyMaterial.blending=d.NormalBlending,this.renderPass(e,this.copyMaterial,this.prevRenderTarget),this.copyMaterial.uniforms.tDiffuse.value=this.prevRenderTarget.texture,this.copyMaterial.blending=d.NoBlending):(this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t),this.blur?this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget2.texture:this.copyMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.copyMaterial.blending=d.NormalBlending),this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case eQ.OUTPUT.SSR:this.blur?this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget2.texture:this.copyMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t),this.bouncing&&(this.blur?this.copyMaterial.uniforms.tDiffuse.value=this.blurRenderTarget2.texture:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.prevRenderTarget),this.copyMaterial.uniforms.tDiffuse.value=this.ssrRenderTarget.texture,this.copyMaterial.blending=d.NormalBlending,this.renderPass(e,this.copyMaterial,this.prevRenderTarget));break;case eQ.OUTPUT.Beauty:this.copyMaterial.uniforms.tDiffuse.value=this.beautyRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case eQ.OUTPUT.Depth:this.renderPass(e,this.depthRenderMaterial,this.renderToScreen?null:t);break;case eQ.OUTPUT.Normal:this.copyMaterial.uniforms.tDiffuse.value=this.normalRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;case eQ.OUTPUT.Metalness:this.copyMaterial.uniforms.tDiffuse.value=this.metalnessRenderTarget.texture,this.copyMaterial.blending=d.NoBlending,this.renderPass(e,this.copyMaterial,this.renderToScreen?null:t);break;default:console.warn("THREE.SSRPass: Unknown output type.")}}renderPass(e,t,r,i,a){this.originalClearColor.copy(e.getClearColor(this.tempColor));let n=e.getClearAlpha(this.tempColor),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,null!=i&&(e.setClearColor(i),e.setClearAlpha(a||0),e.clear()),this.fsQuad.material=t,this.fsQuad.render(e),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(n)}renderOverride(e,t,r,i,a){this.originalClearColor.copy(e.getClearColor(this.tempColor));let n=e.getClearAlpha(this.tempColor),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,i=t.clearColor||i,a=t.clearAlpha||a,null!=i&&(e.setClearColor(i),e.setClearAlpha(a||0),e.clear()),this.scene.overrideMaterial=t,e.render(this.scene,this.camera),this.scene.overrideMaterial=null,e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(n)}renderMetalness(e,t,r,i,a){this.originalClearColor.copy(e.getClearColor(this.tempColor));let n=e.getClearAlpha(this.tempColor),s=e.autoClear;e.setRenderTarget(r),e.autoClear=!1,i=t.clearColor||i,a=t.clearAlpha||a,null!=i&&(e.setClearColor(i),e.setClearAlpha(a||0),e.clear()),this.scene.traverseVisible(e=>{e._SSRPassBackupMaterial=e.material,this._selects.includes(e)?e.material=this.metalnessOnMaterial:e.material=this.metalnessOffMaterial}),e.render(this.scene,this.camera),this.scene.traverseVisible(e=>{e.material=e._SSRPassBackupMaterial}),e.autoClear=s,e.setClearColor(this.originalClearColor),e.setClearAlpha(n)}setSize(e,t){this.width=e,this.height=t,this.ssrMaterial.defines.MAX_STEP=Math.sqrt(e*e+t*t),this.ssrMaterial.needsUpdate=!0,this.beautyRenderTarget.setSize(e,t),this.prevRenderTarget.setSize(e,t),this.ssrRenderTarget.setSize(e,t),this.normalRenderTarget.setSize(e,t),this.metalnessRenderTarget.setSize(e,t),this.blurRenderTarget.setSize(e,t),this.blurRenderTarget2.setSize(e,t),this.ssrMaterial.uniforms.resolution.value.set(e,t),this.ssrMaterial.uniforms.cameraProjectionMatrix.value.copy(this.camera.projectionMatrix),this.ssrMaterial.uniforms.cameraInverseProjectionMatrix.value.copy(this.camera.projectionMatrixInverse),this.blurMaterial.uniforms.resolution.value.set(e,t),this.blurMaterial2.uniforms.resolution.value.set(e,t)}};__publicField(eQ,"OUTPUT",{Default:0,SSR:1,Beauty:3,Depth:4,Normal:5,Metalness:7});function GLTFRegistry(){let e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}let eJ={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};let GLTFLightsExtension=class GLTFLightsExtension{constructor(e){this.parser=e,this.name=eJ.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){let e=this.parser,t=this.parser.json.nodes||[];for(let r=0,i=t.length;r<i;r++){let i=t[r];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){let t;let r=this.parser,i="light:"+e,a=r.cache.get(i);if(a)return a;let n=r.json,s=n.extensions&&n.extensions[this.name]||{},o=s.lights||[],l=o[e],c=new Color(16777215);void 0!==l.color&&c.fromArray(l.color);let u=void 0!==l.range?l.range:0;switch(l.type){case"directional":(t=new DirectionalLight(c)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new PointLight(c)).distance=u;break;case"spot":(t=new SpotLight(c)).distance=u,l.spot=l.spot||{},l.spot.innerConeAngle=void 0!==l.spot.innerConeAngle?l.spot.innerConeAngle:0,l.spot.outerConeAngle=void 0!==l.spot.outerConeAngle?l.spot.outerConeAngle:Math.PI/4,t.angle=l.spot.outerConeAngle,t.penumbra=1-l.spot.innerConeAngle/l.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw Error("THREE.GLTFLoader: Unexpected light type: "+l.type)}return t.position.set(0,0,0),t.decay=2,assignExtrasToUserData(t,l),void 0!==l.intensity&&(t.intensity=l.intensity),t.name=r.createUniqueName(l.name||"light_"+e),a=Promise.resolve(t),r.cache.add(i,a),a}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){let t=this,r=this.parser,i=r.json,a=i.nodes[e],n=a.extensions&&a.extensions[this.name]||{},s=n.light;return void 0===s?null:this._loadLight(s).then(function(e){return r._getNodeRef(t.cache,s,e)})}};let GLTFMaterialsUnlitExtension=class GLTFMaterialsUnlitExtension{constructor(){this.name=eJ.KHR_MATERIALS_UNLIT}getMaterialType(){return MeshBasicMaterial}extendParams(e,t,r){let i=[];e.color=new Color(1,1,1),e.opacity=1;let a=t.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){let t=a.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==a.baseColorTexture&&i.push(r.assignTexture(e,"map",a.baseColorTexture,3001))}return Promise.all(i)}};let GLTFMaterialsEmissiveStrengthExtension=class GLTFMaterialsEmissiveStrengthExtension{constructor(e){this.parser=e,this.name=eJ.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let a=i.extensions[this.name].emissiveStrength;return void 0!==a&&(t.emissiveIntensity=a),Promise.resolve()}};let GLTFMaterialsClearcoatExtension=class GLTFMaterialsClearcoatExtension{constructor(e){this.parser=e,this.name=eJ.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){let t=this.parser,r=t.json.materials[e];return r.extensions&&r.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let a=[],n=i.extensions[this.name];if(void 0!==n.clearcoatFactor&&(t.clearcoat=n.clearcoatFactor),void 0!==n.clearcoatTexture&&a.push(r.assignTexture(t,"clearcoatMap",n.clearcoatTexture)),void 0!==n.clearcoatRoughnessFactor&&(t.clearcoatRoughness=n.clearcoatRoughnessFactor),void 0!==n.clearcoatRoughnessTexture&&a.push(r.assignTexture(t,"clearcoatRoughnessMap",n.clearcoatRoughnessTexture)),void 0!==n.clearcoatNormalTexture&&(a.push(r.assignTexture(t,"clearcoatNormalMap",n.clearcoatNormalTexture)),void 0!==n.clearcoatNormalTexture.scale)){let e=n.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Vector2(e,e)}return Promise.all(a)}};let GLTFMaterialsIridescenceExtension=class GLTFMaterialsIridescenceExtension{constructor(e){this.parser=e,this.name=eJ.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){let t=this.parser,r=t.json.materials[e];return r.extensions&&r.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let a=[],n=i.extensions[this.name];return void 0!==n.iridescenceFactor&&(t.iridescence=n.iridescenceFactor),void 0!==n.iridescenceTexture&&a.push(r.assignTexture(t,"iridescenceMap",n.iridescenceTexture)),void 0!==n.iridescenceIor&&(t.iridescenceIOR=n.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==n.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=n.iridescenceThicknessMinimum),void 0!==n.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=n.iridescenceThicknessMaximum),void 0!==n.iridescenceThicknessTexture&&a.push(r.assignTexture(t,"iridescenceThicknessMap",n.iridescenceThicknessTexture)),Promise.all(a)}};let GLTFMaterialsSheenExtension=class GLTFMaterialsSheenExtension{constructor(e){this.parser=e,this.name=eJ.KHR_MATERIALS_SHEEN}getMaterialType(e){let t=this.parser,r=t.json.materials[e];return r.extensions&&r.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let a=[];t.sheenColor=new Color(0,0,0),t.sheenRoughness=0,t.sheen=1;let n=i.extensions[this.name];return void 0!==n.sheenColorFactor&&t.sheenColor.fromArray(n.sheenColorFactor),void 0!==n.sheenRoughnessFactor&&(t.sheenRoughness=n.sheenRoughnessFactor),void 0!==n.sheenColorTexture&&a.push(r.assignTexture(t,"sheenColorMap",n.sheenColorTexture,3001)),void 0!==n.sheenRoughnessTexture&&a.push(r.assignTexture(t,"sheenRoughnessMap",n.sheenRoughnessTexture)),Promise.all(a)}};let GLTFMaterialsTransmissionExtension=class GLTFMaterialsTransmissionExtension{constructor(e){this.parser=e,this.name=eJ.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){let t=this.parser,r=t.json.materials[e];return r.extensions&&r.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let a=[],n=i.extensions[this.name];return void 0!==n.transmissionFactor&&(t.transmission=n.transmissionFactor),void 0!==n.transmissionTexture&&a.push(r.assignTexture(t,"transmissionMap",n.transmissionTexture)),Promise.all(a)}};let GLTFMaterialsVolumeExtension=class GLTFMaterialsVolumeExtension{constructor(e){this.parser=e,this.name=eJ.KHR_MATERIALS_VOLUME}getMaterialType(e){let t=this.parser,r=t.json.materials[e];return r.extensions&&r.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let a=[],n=i.extensions[this.name];t.thickness=void 0!==n.thicknessFactor?n.thicknessFactor:0,void 0!==n.thicknessTexture&&a.push(r.assignTexture(t,"thicknessMap",n.thicknessTexture)),t.attenuationDistance=n.attenuationDistance||1/0;let s=n.attenuationColor||[1,1,1];return t.attenuationColor=new Color(s[0],s[1],s[2]),Promise.all(a)}};let GLTFMaterialsIorExtension=class GLTFMaterialsIorExtension{constructor(e){this.parser=e,this.name=eJ.KHR_MATERIALS_IOR}getMaterialType(e){let t=this.parser,r=t.json.materials[e];return r.extensions&&r.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let a=i.extensions[this.name];return t.ior=void 0!==a.ior?a.ior:1.5,Promise.resolve()}};let GLTFMaterialsSpecularExtension=class GLTFMaterialsSpecularExtension{constructor(e){this.parser=e,this.name=eJ.KHR_MATERIALS_SPECULAR}getMaterialType(e){let t=this.parser,r=t.json.materials[e];return r.extensions&&r.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let a=[],n=i.extensions[this.name];t.specularIntensity=void 0!==n.specularFactor?n.specularFactor:1,void 0!==n.specularTexture&&a.push(r.assignTexture(t,"specularIntensityMap",n.specularTexture));let s=n.specularColorFactor||[1,1,1];return t.specularColor=new Color(s[0],s[1],s[2]),void 0!==n.specularColorTexture&&a.push(r.assignTexture(t,"specularColorMap",n.specularColorTexture,3001)),Promise.all(a)}};let GLTFMaterialsAnisotropyExtension=class GLTFMaterialsAnisotropyExtension{constructor(e){this.parser=e,this.name=eJ.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){let t=this.parser,r=t.json.materials[e];return r.extensions&&r.extensions[this.name]?MeshPhysicalMaterial:null}extendMaterialParams(e,t){let r=this.parser,i=r.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();let a=[],n=i.extensions[this.name];return void 0!==n.anisotropyStrength&&(t.anisotropy=n.anisotropyStrength),void 0!==n.anisotropyRotation&&(t.anisotropyRotation=n.anisotropyRotation),void 0!==n.anisotropyTexture&&a.push(r.assignTexture(t,"anisotropyMap",n.anisotropyTexture)),Promise.all(a)}};let GLTFTextureBasisUExtension=class GLTFTextureBasisUExtension{constructor(e){this.parser=e,this.name=eJ.KHR_TEXTURE_BASISU}loadTexture(e){let t=this.parser,r=t.json,i=r.textures[e];if(!i.extensions||!i.extensions[this.name])return null;let a=i.extensions[this.name],n=t.options.ktx2Loader;if(!n){if(!(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures")}return t.loadTextureImage(e,a.source,n)}};let GLTFTextureWebPExtension=class GLTFTextureWebPExtension{constructor(e){this.parser=e,this.name=eJ.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){let t=this.name,r=this.parser,i=r.json,a=i.textures[e];if(!a.extensions||!a.extensions[t])return null;let n=a.extensions[t],s=i.images[n.source],o=r.textureLoader;if(s.uri){let e=r.options.manager.getHandler(s.uri);null!==e&&(o=e)}return this.detectSupport().then(function(a){if(a)return r.loadTextureImage(e,n.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){let t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}};let GLTFTextureAVIFExtension=class GLTFTextureAVIFExtension{constructor(e){this.parser=e,this.name=eJ.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){let t=this.name,r=this.parser,i=r.json,a=i.textures[e];if(!a.extensions||!a.extensions[t])return null;let n=a.extensions[t],s=i.images[n.source],o=r.textureLoader;if(s.uri){let e=r.options.manager.getHandler(s.uri);null!==e&&(o=e)}return this.detectSupport().then(function(a){if(a)return r.loadTextureImage(e,n.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){let t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}})),this.isSupported}};let GLTFMeshoptCompression=class GLTFMeshoptCompression{constructor(e){this.name=eJ.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){let t=this.parser.json,r=t.bufferViews[e];if(!r.extensions||!r.extensions[this.name])return null;{let e=r.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),a=this.parser.options.meshoptDecoder;if(!a||!a.supported){if(!(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0))return null;throw Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files")}return i.then(function(t){let r=e.byteOffset||0,i=e.byteLength||0,n=e.count,s=e.byteStride,o=new Uint8Array(t,r,i);return a.decodeGltfBufferAsync?a.decodeGltfBufferAsync(n,s,o,e.mode,e.filter).then(function(e){return e.buffer}):a.ready.then(function(){let t=new ArrayBuffer(n*s);return a.decodeGltfBuffer(new Uint8Array(t),n,s,o,e.mode,e.filter),t})})}}};let GLTFMeshGpuInstancing=class GLTFMeshGpuInstancing{constructor(e){this.name=eJ.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){let t=this.parser.json,r=t.nodes[e];if(!r.extensions||!r.extensions[this.name]||void 0===r.mesh)return null;let i=t.meshes[r.mesh];for(let e of i.primitives)if(e.mode!==e3.TRIANGLES&&e.mode!==e3.TRIANGLE_STRIP&&e.mode!==e3.TRIANGLE_FAN&&void 0!==e.mode)return null;let a=r.extensions[this.name],n=a.attributes,s=[],o={};for(let e in n)s.push(this.parser.getDependency("accessor",n[e]).then(t=>(o[e]=t,o[e])));return s.length<1?null:(s.push(this.parser.createNodeMesh(e)),Promise.all(s).then(e=>{let t=e.pop(),r=t.isGroup?t.children:[t],i=e[0].count,a=[];for(let e of r){let t=new Matrix4,r=new Vector3,n=new Quaternion,s=new Vector3(1,1,1),l=new InstancedMesh(e.geometry,e.material,i);for(let e=0;e<i;e++)o.TRANSLATION&&r.fromBufferAttribute(o.TRANSLATION,e),o.ROTATION&&n.fromBufferAttribute(o.ROTATION,e),o.SCALE&&s.fromBufferAttribute(o.SCALE,e),l.setMatrixAt(e,t.compose(r,n,s));for(let t in o)"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,o[t]);Object3D.prototype.copy.call(l,e),this.parser.assignFinalMaterial(l),a.push(l)}return t.isGroup?(t.clear(),t.add(...a),t):a[0]}))}};let e0="glTF",e1={JSON:1313821514,BIN:5130562};let GLTFBinaryExtension=class GLTFBinaryExtension{constructor(e){this.name=eJ.KHR_BINARY_GLTF,this.content=null,this.body=null;let t=new DataView(e,0,12);if(this.header={magic:LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==e0)throw Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw Error("THREE.GLTFLoader: Legacy binary file detected.");let r=this.header.length-12,i=new DataView(e,12),a=0;for(;a<r;){let t=i.getUint32(a,!0);a+=4;let r=i.getUint32(a,!0);if(a+=4,r===e1.JSON){let r=new Uint8Array(e,12+a,t);this.content=LoaderUtils.decodeText(r)}else if(r===e1.BIN){let r=12+a;this.body=e.slice(r,r+t)}a+=t}if(null===this.content)throw Error("THREE.GLTFLoader: JSON content not found.")}};let GLTFDracoMeshCompressionExtension=class GLTFDracoMeshCompressionExtension{constructor(e,t){if(!t)throw Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=eJ.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){let r=this.json,i=this.dracoLoader,a=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,s={},o={},l={};for(let e in n){let t=e9[e]||e.toLowerCase();s[t]=n[e]}for(let t in e.attributes){let i=e9[t]||t.toLowerCase();if(void 0!==n[t]){let a=r.accessors[e.attributes[t]],n=e4[a.componentType];l[i]=n.name,o[i]=!0===a.normalized}}return t.getDependency("bufferView",a).then(function(e){return new Promise(function(t){i.decodeDracoFile(e,function(e){for(let t in e.attributes){let r=e.attributes[t],i=o[t];void 0!==i&&(r.normalized=i)}t(e)},s,l)})})}};let GLTFTextureTransformExtension=class GLTFTextureTransformExtension{constructor(){this.name=eJ.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(void 0===t.texCoord||t.texCoord===e.channel)&&void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}};let GLTFMeshQuantizationExtension=class GLTFMeshQuantizationExtension{constructor(){this.name=eJ.KHR_MESH_QUANTIZATION}};let GLTFCubicSplineInterpolant=class GLTFCubicSplineInterpolant extends null{constructor(e,t,r,i){super(e,t,r,i)}copySampleValue_(e){let t=this.resultBuffer,r=this.sampleValues,i=this.valueSize,a=e*i*3+i;for(let e=0;e!==i;e++)t[e]=r[a+e];return t}interpolate_(e,t,r,i){let a=this.resultBuffer,n=this.sampleValues,s=this.valueSize,o=2*s,l=3*s,c=i-t,u=(r-t)/c,h=u*u,p=h*u,d=e*l,f=d-l,m=-2*p+3*h,g=p-h,v=1-m,y=g-h+u;for(let e=0;e!==s;e++){let t=n[f+e+s],r=n[f+e+o]*c,i=n[d+e+s],l=n[d+e]*c;a[e]=v*t+y*r+m*i+g*l}return a}};let e2=new d.Quaternion;let GLTFCubicSplineQuaternionInterpolant=class GLTFCubicSplineQuaternionInterpolant extends null{interpolate_(e,t,r,i){let a=super.interpolate_(e,t,r,i);return e2.fromArray(a).normalize().toArray(a),a}};let e3={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},e4={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},e5={9728:d.NearestFilter,9729:d.LinearFilter,9984:d.NearestMipmapNearestFilter,9985:d.LinearMipmapNearestFilter,9986:d.NearestMipmapLinearFilter,9987:d.LinearMipmapLinearFilter},e6={33071:d.ClampToEdgeWrapping,33648:d.MirroredRepeatWrapping,10497:d.RepeatWrapping},e8={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},e9={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...q>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},e7={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},te={CUBICSPLINE:void 0,LINEAR:d.InterpolateLinear,STEP:d.InterpolateDiscrete},tt={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function createDefaultMaterial(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:FrontSide})),e.DefaultMaterial}function addUnknownExtensionsToUserData(e,t,r){for(let i in r.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=r.extensions[i])}function assignExtrasToUserData(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function addMorphTargets(e,t,r){let i=!1,a=!1,n=!1;for(let e=0,r=t.length;e<r;e++){let r=t[e];if(void 0!==r.POSITION&&(i=!0),void 0!==r.NORMAL&&(a=!0),void 0!==r.COLOR_0&&(n=!0),i&&a&&n)break}if(!i&&!a&&!n)return Promise.resolve(e);let s=[],o=[],l=[];for(let c=0,u=t.length;c<u;c++){let u=t[c];if(i){let t=void 0!==u.POSITION?r.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(a){let t=void 0!==u.NORMAL?r.getDependency("accessor",u.NORMAL):e.attributes.normal;o.push(t)}if(n){let t=void 0!==u.COLOR_0?r.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(o),Promise.all(l)]).then(function(t){let r=t[0],s=t[1],o=t[2];return i&&(e.morphAttributes.position=r),a&&(e.morphAttributes.normal=s),n&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e})}function updateMorphTargets(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let r=0,i=t.weights.length;r<i;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){let r=t.extras.targetNames;if(e.morphTargetInfluences.length===r.length){e.morphTargetDictionary={};for(let t=0,i=r.length;t<i;t++)e.morphTargetDictionary[r[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function createPrimitiveKey(e){let t;let r=e.extensions&&e.extensions[eJ.KHR_DRACO_MESH_COMPRESSION];if(t=r?"draco:"+r.bufferView+":"+r.indices+":"+createAttributesKey(r.attributes):e.indices+":"+createAttributesKey(e.attributes)+":"+e.mode,void 0!==e.targets)for(let r=0,i=e.targets.length;r<i;r++)t+=":"+createAttributesKey(e.targets[r]);return t}function createAttributesKey(e){let t="",r=Object.keys(e).sort();for(let i=0,a=r.length;i<a;i++)t+=r[i]+":"+e[r[i]]+";";return t}function getNormalizedComponentScale(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function getImageURIMimeType(e){return e.search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":"image/png"}let tr=new d.Matrix4;let GLTFParser=class GLTFParser{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,i=!1,a=-1;"undefined"!=typeof navigator&&void 0!==navigator.userAgent&&(r=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),a=(i=navigator.userAgent.indexOf("Firefox")>-1)?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||r||i&&a<98?this.textureLoader=new TextureLoader(this.options.manager):this.textureLoader=new ImageBitmapLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){let r=this,i=this.json,a=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])}).then(function(t){let n={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:r,userData:{}};addUnknownExtensionsToUserData(a,n,i),assignExtrasToUserData(n,i),Promise.all(r._invokeAll(function(e){return e.afterRoot&&e.afterRoot(n)})).then(function(){e(n)})}).catch(t)}_markDefs(){let e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[];for(let r=0,i=t.length;r<i;r++){let i=t[r].joints;for(let t=0,r=i.length;t<r;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){let i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(r[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,r){if(e.refs[t]<=1)return r;let i=r.clone(),updateMappings=(e,t)=>{let r=this.associations.get(e);for(let[i,a]of(null!=r&&this.associations.set(t,r),e.children.entries()))updateMappings(a,t.children[i])};return updateMappings(r,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){let t=Object.values(this.plugins);t.push(this);for(let r=0;r<t.length;r++){let i=e(t[r]);if(i)return i}return null}_invokeAll(e){let t=Object.values(this.plugins);t.unshift(this);let r=[];for(let i=0;i<t.length;i++){let a=e(t[i]);a&&r.push(a)}return r}getDependency(e,t){let r=e+":"+t,i=this.cache.get(r);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":i=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(!(i=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)})))throw Error("Unknown type: "+e)}this.cache.add(r,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){let r=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map(function(t,i){return r.getDependency(e,i)})),this.cache.add(e,t)}return t}loadBuffer(e){let t=this.json.buffers[e],r=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[eJ.KHR_BINARY_GLTF].body);let i=this.options;return new Promise(function(e,a){r.load(LoaderUtils.resolveURL(t.uri,i.path),e,void 0,function(){a(Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){let t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){let r=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+r)})}loadAccessor(e){let t=this,r=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){let e=e8[i.type],t=e4[i.componentType],r=!0===i.normalized,a=new t(i.count*e);return Promise.resolve(new BufferAttribute(a,e,r))}let a=[];return void 0!==i.bufferView?a.push(this.getDependency("bufferView",i.bufferView)):a.push(null),void 0!==i.sparse&&(a.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(a).then(function(e){let a,n;let s=e[0],o=e8[i.type],l=e4[i.componentType],c=l.BYTES_PER_ELEMENT,u=c*o,h=i.byteOffset||0,p=void 0!==i.bufferView?r.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;if(p&&p!==u){let e=Math.floor(h/p),r="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count,u=t.cache.get(r);u||(a=new l(s,e*p,i.count*p/c),u=new InterleavedBuffer(a,p/c),t.cache.add(r,u)),n=new InterleavedBufferAttribute(u,o,h%p/c,d)}else a=null===s?new l(i.count*o):new l(s,h,i.count*o),n=new BufferAttribute(a,o,d);if(void 0!==i.sparse){let t=e8.SCALAR,r=e4[i.sparse.indices.componentType],a=i.sparse.indices.byteOffset||0,c=i.sparse.values.byteOffset||0,u=new r(e[1],a,i.sparse.count*t),h=new l(e[2],c,i.sparse.count*o);null!==s&&(n=new BufferAttribute(n.array.slice(),n.itemSize,n.normalized));for(let e=0,t=u.length;e<t;e++){let t=u[e];if(n.setX(t,h[e*o]),o>=2&&n.setY(t,h[e*o+1]),o>=3&&n.setZ(t,h[e*o+2]),o>=4&&n.setW(t,h[e*o+3]),o>=5)throw Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return n})}loadTexture(e){let t=this.json,r=this.options,i=t.textures[e],a=i.source,n=t.images[a],s=this.textureLoader;if(n.uri){let e=r.manager.getHandler(n.uri);null!==e&&(s=e)}return this.loadTextureImage(e,a,s)}loadTextureImage(e,t,r){let i=this,a=this.json,n=a.textures[e],s=a.images[t],o=(s.uri||s.bufferView)+":"+n.sampler;if(this.textureCache[o])return this.textureCache[o];let l=this.loadImageSource(t,r).then(function(t){t.flipY=!1,t.name=n.name||s.name||"",""===t.name&&"string"==typeof s.uri&&!1===s.uri.startsWith("data:image/")&&(t.name=s.uri);let r=a.samplers||{},o=r[n.sampler]||{};return t.magFilter=e5[o.magFilter]||LinearFilter,t.minFilter=e5[o.minFilter]||LinearMipmapLinearFilter,t.wrapS=e6[o.wrapS]||RepeatWrapping,t.wrapT=e6[o.wrapT]||RepeatWrapping,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[o]=l,l}loadImageSource(e,t){let r=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());let a=r.images[e],n=self.URL||self.webkitURL,s=a.uri||"",o=!1;if(void 0!==a.bufferView)s=this.getDependency("bufferView",a.bufferView).then(function(e){o=!0;let t=new Blob([e],{type:a.mimeType});return s=n.createObjectURL(t)});else if(void 0===a.uri)throw Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");let l=Promise.resolve(s).then(function(e){return new Promise(function(r,a){let n=r;!0===t.isImageBitmapLoader&&(n=function(e){let t=new Texture(e);t.needsUpdate=!0,r(t)}),t.load(LoaderUtils.resolveURL(e,i.path),n,void 0,a)})}).then(function(e){return!0===o&&n.revokeObjectURL(s),e.userData.mimeType=a.mimeType||getImageURIMimeType(a.uri),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",s),e});return this.sourceCache[e]=l,l}assignTexture(e,t,r,i){let a=this;return this.getDependency("texture",r.index).then(function(n){if(!n)return null;if(void 0!==r.texCoord&&r.texCoord>0&&((n=n.clone()).channel=r.texCoord),a.extensions[eJ.KHR_TEXTURE_TRANSFORM]){let e=void 0!==r.extensions?r.extensions[eJ.KHR_TEXTURE_TRANSFORM]:void 0;if(e){let t=a.associations.get(n);n=a.extensions[eJ.KHR_TEXTURE_TRANSFORM].extendTexture(n,e),a.associations.set(n,t)}}return void 0!==i&&("colorSpace"in n?n.colorSpace=3001===i?"srgb":"srgb-linear":n.encoding=i),e[t]=n,n})}assignFinalMaterial(e){let t=e.geometry,r=e.material,i=void 0===t.attributes.tangent,a=void 0!==t.attributes.color,n=void 0===t.attributes.normal;if(e.isPoints){let e="PointsMaterial:"+r.uuid,t=this.cache.get(e);t||(t=new PointsMaterial,Material.prototype.copy.call(t,r),t.color.copy(r.color),t.map=r.map,t.sizeAttenuation=!1,this.cache.add(e,t)),r=t}else if(e.isLine){let e="LineBasicMaterial:"+r.uuid,t=this.cache.get(e);t||(t=new LineBasicMaterial,Material.prototype.copy.call(t,r),t.color.copy(r.color),t.map=r.map,this.cache.add(e,t)),r=t}if(i||a||n){let e="ClonedMaterial:"+r.uuid+":";i&&(e+="derivative-tangents:"),a&&(e+="vertex-colors:"),n&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=r.clone(),a&&(t.vertexColors=!0),n&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(r))),r=t}e.material=r}getMaterialType(){return MeshStandardMaterial}loadMaterial(e){let t;let r=this,i=this.json,a=this.extensions,n=i.materials[e],s={},o=n.extensions||{},l=[];if(o[eJ.KHR_MATERIALS_UNLIT]){let e=a[eJ.KHR_MATERIALS_UNLIT];t=e.getMaterialType(),l.push(e.extendParams(s,n,r))}else{let i=n.pbrMetallicRoughness||{};if(s.color=new Color(1,1,1),s.opacity=1,Array.isArray(i.baseColorFactor)){let e=i.baseColorFactor;s.color.fromArray(e),s.opacity=e[3]}void 0!==i.baseColorTexture&&l.push(r.assignTexture(s,"map",i.baseColorTexture,3001)),s.metalness=void 0!==i.metallicFactor?i.metallicFactor:1,s.roughness=void 0!==i.roughnessFactor?i.roughnessFactor:1,void 0!==i.metallicRoughnessTexture&&(l.push(r.assignTexture(s,"metalnessMap",i.metallicRoughnessTexture)),l.push(r.assignTexture(s,"roughnessMap",i.metallicRoughnessTexture))),t=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,s)})))}!0===n.doubleSided&&(s.side=DoubleSide);let c=n.alphaMode||tt.OPAQUE;if(c===tt.BLEND?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,c===tt.MASK&&(s.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&t!==MeshBasicMaterial&&(l.push(r.assignTexture(s,"normalMap",n.normalTexture)),s.normalScale=new Vector2(1,1),void 0!==n.normalTexture.scale)){let e=n.normalTexture.scale;s.normalScale.set(e,e)}return void 0!==n.occlusionTexture&&t!==MeshBasicMaterial&&(l.push(r.assignTexture(s,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(s.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&t!==MeshBasicMaterial&&(s.emissive=new Color().fromArray(n.emissiveFactor)),void 0!==n.emissiveTexture&&t!==MeshBasicMaterial&&l.push(r.assignTexture(s,"emissiveMap",n.emissiveTexture,3001)),Promise.all(l).then(function(){let i=new t(s);return n.name&&(i.name=n.name),assignExtrasToUserData(i,n),r.associations.set(i,{materials:e}),n.extensions&&addUnknownExtensionsToUserData(a,i,n),i})}createUniqueName(e){let t=PropertyBinding.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){let t=this,r=this.extensions,i=this.primitiveCache;function createDracoPrimitive(e){return r[eJ.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(r){return addPrimitiveAttributes(r,e,t)})}let a=[];for(let r=0,n=e.length;r<n;r++){let n=e[r],s=createPrimitiveKey(n),o=i[s];if(o)a.push(o.promise);else{let e;e=n.extensions&&n.extensions[eJ.KHR_DRACO_MESH_COMPRESSION]?createDracoPrimitive(n):addPrimitiveAttributes(new BufferGeometry,n,t),i[s]={primitive:n,promise:e},a.push(e)}}return Promise.all(a)}loadMesh(e){let t=this,r=this.json,i=this.extensions,a=r.meshes[e],n=a.primitives,s=[];for(let e=0,t=n.length;e<t;e++){let t=void 0===n[e].material?createDefaultMaterial(this.cache):this.getDependency("material",n[e].material);s.push(t)}return s.push(t.loadGeometries(n)),Promise.all(s).then(function(r){let s=r.slice(0,r.length-1),o=r[r.length-1],l=[];for(let r=0,c=o.length;r<c;r++){let c;let u=o[r],h=n[r],p=s[r];if(h.mode===e3.TRIANGLES||h.mode===e3.TRIANGLE_STRIP||h.mode===e3.TRIANGLE_FAN||void 0===h.mode)!0===(c=!0===a.isSkinnedMesh?new SkinnedMesh(u,p):new Mesh(u,p)).isSkinnedMesh&&c.normalizeSkinWeights(),h.mode===e3.TRIANGLE_STRIP?c.geometry=toTrianglesDrawMode(c.geometry,TriangleStripDrawMode):h.mode===e3.TRIANGLE_FAN&&(c.geometry=toTrianglesDrawMode(c.geometry,TriangleFanDrawMode));else if(h.mode===e3.LINES)c=new LineSegments(u,p);else if(h.mode===e3.LINE_STRIP)c=new Line(u,p);else if(h.mode===e3.LINE_LOOP)c=new LineLoop(u,p);else if(h.mode===e3.POINTS)c=new Points(u,p);else throw Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);Object.keys(c.geometry.morphAttributes).length>0&&updateMorphTargets(c,a),c.name=t.createUniqueName(a.name||"mesh_"+e),assignExtrasToUserData(c,a),h.extensions&&addUnknownExtensionsToUserData(i,c,h),t.assignFinalMaterial(c),l.push(c)}for(let r=0,i=l.length;r<i;r++)t.associations.set(l[r],{meshes:e,primitives:r});if(1===l.length)return a.extensions&&addUnknownExtensionsToUserData(i,l[0],a),l[0];let c=new Group;a.extensions&&addUnknownExtensionsToUserData(i,c,a),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c})}loadCamera(e){let t;let r=this.json.cameras[e],i=r[r.type];if(!i){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return"perspective"===r.type?t=new PerspectiveCamera(MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===r.type&&(t=new OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),assignExtrasToUserData(t,r),Promise.resolve(t)}loadSkin(e){let t=this.json.skins[e],r=[];for(let e=0,i=t.joints.length;e<i;e++)r.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?r.push(this.getDependency("accessor",t.inverseBindMatrices)):r.push(null),Promise.all(r).then(function(e){let r=e.pop(),i=[],a=[];for(let n=0,s=e.length;n<s;n++){let s=e[n];if(s){i.push(s);let e=new Matrix4;null!==r&&e.fromArray(r.array,16*n),a.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[n])}return new Skeleton(i,a)})}loadAnimation(e){let t=this.json,r=t.animations[e],i=r.name?r.name:"animation_"+e,a=[],n=[],s=[],o=[],l=[];for(let e=0,t=r.channels.length;e<t;e++){let t=r.channels[e],i=r.samplers[t.sampler],c=t.target,u=c.node,h=void 0!==r.parameters?r.parameters[i.input]:i.input,p=void 0!==r.parameters?r.parameters[i.output]:i.output;void 0!==c.node&&(a.push(this.getDependency("node",u)),n.push(this.getDependency("accessor",h)),s.push(this.getDependency("accessor",p)),o.push(i),l.push(c))}return Promise.all([Promise.all(a),Promise.all(n),Promise.all(s),Promise.all(o),Promise.all(l)]).then(function(e){let t=e[0],r=e[1],a=e[2],n=e[3],s=e[4],o=[];for(let e=0,i=t.length;e<i;e++){let i;let l=t[e],c=r[e],u=a[e],h=n[e],p=s[e];if(void 0===l)continue;switch(l.updateMatrix(),e7[p.path]){case e7.weights:i=NumberKeyframeTrack;break;case e7.rotation:i=QuaternionKeyframeTrack;break;case e7.position:case e7.scale:default:i=VectorKeyframeTrack}let d=l.name?l.name:l.uuid,f=void 0!==h.interpolation?te[h.interpolation]:InterpolateLinear,m=[];e7[p.path]===e7.weights?l.traverse(function(e){e.morphTargetInfluences&&m.push(e.name?e.name:e.uuid)}):m.push(d);let g=u.array;if(u.normalized){let e=getNormalizedComponentScale(g.constructor),t=new Float32Array(g.length);for(let r=0,i=g.length;r<i;r++)t[r]=g[r]*e;g=t}for(let e=0,t=m.length;e<t;e++){let t=new i(m[e]+"."+e7[p.path],c.array,g,f);"CUBICSPLINE"===h.interpolation&&(t.createInterpolant=function(e){let t=this instanceof QuaternionKeyframeTrack?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant;return new t(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),o.push(t)}}return new AnimationClip(i,void 0,o)})}createNodeMesh(e){let t=this.json,r=this,i=t.nodes[e];return void 0===i.mesh?null:r.getDependency("mesh",i.mesh).then(function(e){let t=r._getNodeRef(r.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,r=i.weights.length;t<r;t++)e.morphTargetInfluences[t]=i.weights[t]}),t})}loadNode(e){let t=this.json,r=t.nodes[e],i=this._loadNodeShallow(e),a=[],n=r.children||[];for(let e=0,t=n.length;e<t;e++)a.push(this.getDependency("node",n[e]));let s=void 0===r.skin?Promise.resolve(null):this.getDependency("skin",r.skin);return Promise.all([i,Promise.all(a),s]).then(function(e){let t=e[0],r=e[1],i=e[2];null!==i&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(i,tr)});for(let e=0,i=r.length;e<i;e++)t.add(r[e]);return t})}_loadNodeShallow(e){let t=this.json,r=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];let a=t.nodes[e],n=a.name?i.createUniqueName(a.name):"",s=[],o=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return o&&s.push(o),void 0!==a.camera&&s.push(i.getDependency("camera",a.camera).then(function(e){return i._getNodeRef(i.cameraCache,a.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){s.push(e)}),this.nodeCache[e]=Promise.all(s).then(function(t){let s;if((s=!0===a.isBone?new Bone:t.length>1?new Group:1===t.length?t[0]:new Object3D)!==t[0])for(let e=0,r=t.length;e<r;e++)s.add(t[e]);if(a.name&&(s.userData.name=a.name,s.name=n),assignExtrasToUserData(s,a),a.extensions&&addUnknownExtensionsToUserData(r,s,a),void 0!==a.matrix){let e=new Matrix4;e.fromArray(a.matrix),s.applyMatrix4(e)}else void 0!==a.translation&&s.position.fromArray(a.translation),void 0!==a.rotation&&s.quaternion.fromArray(a.rotation),void 0!==a.scale&&s.scale.fromArray(a.scale);return i.associations.has(s)||i.associations.set(s,{}),i.associations.get(s).nodes=e,s}),this.nodeCache[e]}loadScene(e){let t=this.extensions,r=this.json.scenes[e],i=this,a=new Group;r.name&&(a.name=i.createUniqueName(r.name)),assignExtrasToUserData(a,r),r.extensions&&addUnknownExtensionsToUserData(t,a,r);let n=r.nodes||[],s=[];for(let e=0,t=n.length;e<t;e++)s.push(i.getDependency("node",n[e]));return Promise.all(s).then(function(e){for(let t=0,r=e.length;t<r;t++)a.add(e[t]);return i.associations=(e=>{let t=new Map;for(let[e,r]of i.associations)(e instanceof Material||e instanceof Texture)&&t.set(e,r);return e.traverse(e=>{let r=i.associations.get(e);null!=r&&t.set(e,r)}),t})(a),a})}};function computeBounds(e,t,r){let i=t.attributes,a=new Box3;if(void 0===i.POSITION)return;{let e=r.json.accessors[i.POSITION],t=e.min,n=e.max;if(void 0!==t&&void 0!==n){if(a.set(new Vector3(t[0],t[1],t[2]),new Vector3(n[0],n[1],n[2])),e.normalized){let t=getNormalizedComponentScale(e4[e.componentType]);a.min.multiplyScalar(t),a.max.multiplyScalar(t)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}let n=t.targets;if(void 0!==n){let e=new Vector3,t=new Vector3;for(let i=0,a=n.length;i<a;i++){let a=n[i];if(void 0!==a.POSITION){let i=r.json.accessors[a.POSITION],n=i.min,s=i.max;if(void 0!==n&&void 0!==s){if(t.setX(Math.max(Math.abs(n[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(n[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(n[2]),Math.abs(s[2]))),i.normalized){let e=getNormalizedComponentScale(e4[i.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}a.expandByVector(e)}e.boundingBox=a;let s=new Sphere;a.getCenter(s.center),s.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=s}function addPrimitiveAttributes(e,t,r){let i=t.attributes,a=[];function assignAttributeAccessor(t,i){return r.getDependency("accessor",t).then(function(t){e.setAttribute(i,t)})}for(let t in i){let r=e9[t]||t.toLowerCase();r in e.attributes||a.push(assignAttributeAccessor(i[t],r))}if(void 0!==t.indices&&!e.index){let i=r.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});a.push(i)}return assignExtrasToUserData(e,t),computeBounds(e,t,r),Promise.all(a).then(function(){return void 0!==t.targets?addMorphTargets(e,t.targets,r):e})}d.Object3D;let ti=class{static createButton(e,t={}){let r=document.createElement("button");function showEnterVR(){let i=null;async function onSessionStarted(t){t.addEventListener("end",onSessionEnded),await e.xr.setSession(t),r.textContent="EXIT VR",i=t}function onSessionEnded(){i.removeEventListener("end",onSessionEnded),r.textContent="ENTER VR",i=null}r.style.display="",r.style.cursor="pointer",r.style.left="calc(50% - 50px)",r.style.width="100px",r.textContent="ENTER VR",r.onmouseenter=()=>{r.style.opacity="1.0"},r.onmouseleave=()=>{r.style.opacity="0.5"},r.onclick=()=>{var e;if(null===i){let r=[t.optionalFeatures,"local-floor","bounded-floor","hand-tracking"].flat().filter(Boolean);null==(e=navigator.xr)||e.requestSession("immersive-vr",{...t,optionalFeatures:r}).then(onSessionStarted)}else i.end()}}function disableButton(){r.style.display="",r.style.cursor="auto",r.style.left="calc(50% - 75px)",r.style.width="150px",r.onmouseenter=null,r.onmouseleave=null,r.onclick=null}function showWebXRNotFound(){disableButton(),r.textContent="VR NOT SUPPORTED"}function stylizeElement(e){e.style.position="absolute",e.style.bottom="20px",e.style.padding="12px 6px",e.style.border="1px solid #fff",e.style.borderRadius="4px",e.style.background="rgba(0,0,0,0.1)",e.style.color="#fff",e.style.font="normal 13px sans-serif",e.style.textAlign="center",e.style.opacity="0.5",e.style.outline="none",e.style.zIndex="999"}if("xr"in navigator)return stylizeElement(r),r.id="VRButton",r.style.display="none",navigator.xr.isSessionSupported("immersive-vr").then(e=>{e?showEnterVR():showWebXRNotFound(),e&&ti.xrSessionIsGranted&&r.click()}),r;{let e=document.createElement("a");return!1===window.isSecureContext?(e.href=document.location.href.replace(/^http:/,"https:"),e.innerHTML="WEBXR NEEDS HTTPS"):(e.href="https://immersiveweb.dev/",e.innerHTML="WEBXR NOT AVAILABLE"),e.style.left="calc(50% - 90px)",e.style.width="180px",e.style.textDecoration="none",stylizeElement(e),e}}static registerSessionGrantedListener(){"undefined"!=typeof navigator&&"xr"in navigator&&navigator.xr.addEventListener("sessiongranted",()=>{ti.xrSessionIsGranted=!0})}};__publicField(ti,"xrSessionIsGranted",!1),ti.registerSessionGrantedListener();let ta={ComponentState:{DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"},ComponentProperty:{BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"},ComponentType:{TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"},ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:{TRANSFORM:"transform",VISIBILITY:"visibility"}};async function fetchJsonFile(e){let t=await fetch(e);if(t.ok)return t.json();throw Error(t.statusText)}let tn={xAxis:0,yAxis:0,button:0,state:ta.ComponentState.DEFAULT};function normalizeAxes(e=0,t=0){let r=e,i=t;if(Math.sqrt(e*e+t*t)>1){let a=Math.atan2(t,e);r=Math.cos(a),i=Math.sin(a)}let a={normalizedXAxis:.5*r+.5,normalizedYAxis:.5*i+.5};return a}let VisualResponse=class VisualResponse{constructor(e){__publicField(this,"value"),__publicField(this,"componentProperty"),__publicField(this,"states"),__publicField(this,"valueNodeName"),__publicField(this,"valueNodeProperty"),__publicField(this,"minNodeName"),__publicField(this,"maxNodeName"),__publicField(this,"valueNode"),__publicField(this,"minNode"),__publicField(this,"maxNode"),this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===ta.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(tn)}updateFromComponent({xAxis:e,yAxis:t,button:r,state:i}){let{normalizedXAxis:a,normalizedYAxis:n}=normalizeAxes(e,t);switch(this.componentProperty){case ta.ComponentProperty.X_AXIS:this.value=this.states.includes(i)?a:.5;break;case ta.ComponentProperty.Y_AXIS:this.value=this.states.includes(i)?n:.5;break;case ta.ComponentProperty.BUTTON:this.value=this.states.includes(i)&&r?r:0;break;case ta.ComponentProperty.STATE:this.valueNodeProperty===ta.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(i):this.value=this.states.includes(i)?1:0;break;default:throw Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}};d.BufferGeometry;let ts=new d.Matrix4;let CSMFrustum=class CSMFrustum{constructor(e){e=e||{},this.vertices={near:[new d.Vector3,new d.Vector3,new d.Vector3,new d.Vector3],far:[new d.Vector3,new d.Vector3,new d.Vector3,new d.Vector3]},void 0!==e.projectionMatrix&&this.setFromProjectionMatrix(e.projectionMatrix,e.maxFar||1e4)}setFromProjectionMatrix(e,t){let r=0===e.elements[11];return ts.copy(e).invert(),this.vertices.near[0].set(1,1,-1),this.vertices.near[1].set(1,-1,-1),this.vertices.near[2].set(-1,-1,-1),this.vertices.near[3].set(-1,1,-1),this.vertices.near.forEach(function(e){e.applyMatrix4(ts)}),this.vertices.far[0].set(1,1,1),this.vertices.far[1].set(1,-1,1),this.vertices.far[2].set(-1,-1,1),this.vertices.far[3].set(-1,1,1),this.vertices.far.forEach(function(e){e.applyMatrix4(ts);let i=Math.abs(e.z);r?e.z*=Math.min(t/i,1):e.multiplyScalar(Math.min(t/i,1))}),this.vertices}split(e,t){for(;e.length>t.length;)t.push(new CSMFrustum);t.length=e.length;for(let r=0;r<e.length;r++){let i=t[r];if(0===r)for(let e=0;e<4;e++)i.vertices.near[e].copy(this.vertices.near[e]);else for(let t=0;t<4;t++)i.vertices.near[t].lerpVectors(this.vertices.near[t],this.vertices.far[t],e[r-1]);if(r===e.length-1)for(let e=0;e<4;e++)i.vertices.far[e].copy(this.vertices.far[e]);else for(let t=0;t<4;t++)i.vertices.far[t].lerpVectors(this.vertices.near[t],this.vertices.far[t],e[r])}}toSpace(e,t){for(let r=0;r<4;r++)t.vertices.near[r].copy(this.vertices.near[r]).applyMatrix4(e),t.vertices.far[r].copy(this.vertices.far[r]).applyMatrix4(e)}};let to=new WeakMap;function findSpan(e,t,r){let i=r.length-e-1;if(t>=r[i])return i-1;if(t<=r[e])return e;let a=e,n=i,s=Math.floor((a+n)/2);for(;t<r[s]||t>=r[s+1];)t<r[s]?n=s:a=s,s=Math.floor((a+n)/2);return s}function calcBasisFunctions(e,t,r,i){let a=[],n=[],s=[];a[0]=1;for(let o=1;o<=r;++o){n[o]=t-i[e+1-o],s[o]=i[e+o]-t;let r=0;for(let e=0;e<o;++e){let t=s[e+1],i=n[o-e],l=a[e]/(t+i);a[e]=r+t*l,r=i*l}a[o]=r}return a}function calcBSplinePoint(e,t,r,i){let a=findSpan(e,i,t),n=calcBasisFunctions(a,i,e,t),s=new Vector4(0,0,0,0);for(let t=0;t<=e;++t){let i=r[a-e+t],o=n[t],l=i.w*o;s.x+=i.x*l,s.y+=i.y*l,s.z+=i.z*l,s.w+=i.w*o}return s}function calcBasisFunctionDerivatives(e,t,r,i,a){let n=[];for(let e=0;e<=r;++e)n[e]=0;let s=[];for(let e=0;e<=i;++e)s[e]=n.slice(0);let o=[];for(let e=0;e<=r;++e)o[e]=n.slice(0);o[0][0]=1;let l=n.slice(0),c=n.slice(0);for(let i=1;i<=r;++i){l[i]=t-a[e+1-i],c[i]=a[e+i]-t;let r=0;for(let e=0;e<i;++e){let t=c[e+1],a=l[i-e];o[i][e]=t+a;let n=o[e][i-1]/o[i][e];o[e][i]=r+t*n,r=a*n}o[i][i]=r}for(let e=0;e<=r;++e)s[0][e]=o[e][r];for(let e=0;e<=r;++e){let t=0,a=1,l=[];for(let e=0;e<=r;++e)l[e]=n.slice(0);l[0][0]=1;for(let n=1;n<=i;++n){let i=0,c=e-n,u=r-n;e>=n&&(l[a][0]=l[t][0]/o[u+1][c],i=l[a][0]*o[c][u]);let h=c>=-1?1:-c,p=e-1<=u?n-1:r-e;for(let e=h;e<=p;++e)l[a][e]=(l[t][e]-l[t][e-1])/o[u+1][c+e],i+=l[a][e]*o[c+e][u];e<=u&&(l[a][n]=-l[t][n-1]/o[u+1][e],i+=l[a][n]*o[e][u]),s[n][e]=i;let d=t;t=a,a=d}}let u=r;for(let e=1;e<=i;++e){for(let t=0;t<=r;++t)s[e][t]*=u;u*=r-e}return s}function calcBSplineDerivatives(e,t,r,i,a){let n=a<e?a:e,s=[],o=findSpan(e,i,t),l=calcBasisFunctionDerivatives(o,i,e,n,t),c=[];for(let e=0;e<r.length;++e){let t=r[e].clone(),i=t.w;t.x*=i,t.y*=i,t.z*=i,c[e]=t}for(let t=0;t<=n;++t){let r=c[o-e].clone().multiplyScalar(l[t][0]);for(let i=1;i<=e;++i)r.add(c[o-e+i].clone().multiplyScalar(l[t][i]));s[t]=r}for(let e=n+1;e<=a+1;++e)s[e]=new Vector4(0,0,0);return s}function calcKoverI(e,t){let r=1;for(let t=2;t<=e;++t)r*=t;let i=1;for(let e=2;e<=t;++e)i*=e;for(let r=2;r<=e-t;++r)i*=r;return r/i}function calcRationalCurveDerivatives(e){let t=e.length,r=[],i=[];for(let a=0;a<t;++a){let t=e[a];r[a]=new Vector3(t.x,t.y,t.z),i[a]=t.w}let a=[];for(let e=0;e<t;++e){let t=r[e].clone();for(let r=1;r<=e;++r)t.sub(a[e-r].clone().multiplyScalar(calcKoverI(e,r)*i[r]));a[e]=t.divideScalar(i[0])}return a}function calcNURBSDerivatives(e,t,r,i,a){let n=calcBSplineDerivatives(e,t,r,i,a);return calcRationalCurveDerivatives(n)}let NURBSCurve=class NURBSCurve extends null{constructor(e,t,r,i,a){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=i||0,this.endKnot=a||this.knots.length-1;for(let e=0;e<r.length;++e){let t=r[e];this.controlPoints[e]=new Vector4(t.x,t.y,t.z,t.w)}}getPoint(e,t){let r=t||new Vector3,i=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),a=calcBSplinePoint(this.degree,this.knots,this.controlPoints,i);return 1!=a.w&&a.divideScalar(a.w),r.set(a.x,a.y,a.z)}getTangent(e,t){let r=t||new Vector3,i=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),a=calcNURBSDerivatives(this.degree,this.knots,this.controlPoints,i,1);return r.copy(a[1]).normalize(),r}};function convertFBXTimeToSeconds(e){return e/46186158e3}function getData(e,t,r,i){let a;switch(i.mappingType){case"ByPolygonVertex":a=e;break;case"ByPolygon":a=t;break;case"ByVertice":a=r;break;case"AllSame":a=i.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+i.mappingType)}"IndexToDirect"===i.referenceType&&(a=i.indices[a]);let n=a*i.dataSize,s=n+i.dataSize;return slice(null,i.buffer,n,s)}let tl=new d.Euler,tc=new d.Vector3;function generateTransform(e){let t=new Matrix4,r=new Matrix4,i=new Matrix4,a=new Matrix4,n=new Matrix4,s=new Matrix4,o=new Matrix4,l=new Matrix4,c=new Matrix4,u=new Matrix4,h=new Matrix4,p=new Matrix4,d=e.inheritType?e.inheritType:0;if(e.translation&&t.setPosition(tc.fromArray(e.translation)),e.preRotation){let t=e.preRotation.map(MathUtils.degToRad);t.push(e.eulerOrder),r.makeRotationFromEuler(tl.fromArray(t))}if(e.rotation){let t=e.rotation.map(MathUtils.degToRad);t.push(e.eulerOrder),i.makeRotationFromEuler(tl.fromArray(t))}if(e.postRotation){let t=e.postRotation.map(MathUtils.degToRad);t.push(e.eulerOrder),a.makeRotationFromEuler(tl.fromArray(t)),a.invert()}e.scale&&n.scale(tc.fromArray(e.scale)),e.scalingOffset&&o.setPosition(tc.fromArray(e.scalingOffset)),e.scalingPivot&&s.setPosition(tc.fromArray(e.scalingPivot)),e.rotationOffset&&l.setPosition(tc.fromArray(e.rotationOffset)),e.rotationPivot&&c.setPosition(tc.fromArray(e.rotationPivot)),e.parentMatrixWorld&&(h.copy(e.parentMatrix),u.copy(e.parentMatrixWorld));let f=r.clone().multiply(i).multiply(a),m=new Matrix4;m.extractRotation(u);let g=new Matrix4;g.copyPosition(u);let v=g.clone().invert().multiply(u),y=m.clone().invert().multiply(v),x=new Matrix4;if(0===d)x.copy(m).multiply(f).multiply(y).multiply(n);else if(1===d)x.copy(m).multiply(y).multiply(f).multiply(n);else{let e=new Matrix4().scale(new Vector3().setFromMatrixScale(h)),t=e.clone().invert(),r=y.clone().multiply(t);x.copy(m).multiply(f).multiply(r).multiply(n)}let b=c.clone().invert(),T=s.clone().invert(),S=t.clone().multiply(l).multiply(c).multiply(r).multiply(i).multiply(a).multiply(b).multiply(o).multiply(s).multiply(n).multiply(T),E=new Matrix4().copyPosition(S),R=u.clone().multiply(E);return p.copyPosition(R),(S=p.clone().multiply(x)).premultiply(u.invert()),S}function getEulerOrder(e){return 6===(e=e||0)?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),"ZYX"):["ZYX","YZX","XZY","ZXY","YXZ","XYZ"][e]}function slice(e,t,r,i){for(let a=r,n=0;a<i;a++,n++)e[n]=t[a];return e}function inject(e,t,r){return e.slice(0,t).concat(r).concat(e.slice(t))}let Font=class Font{constructor(e){__publicField(this,"data"),this.data=e}generateShapes(e,t=100,r){let i=[],a={letterSpacing:0,lineHeight:1,...r},n=createPaths(e,t,this.data,a);for(let e=0,t=n.length;e<t;e++)Array.prototype.push.apply(i,n[e].toShapes(!1));return i}};function createPaths(e,t,r,i){let a=Array.from(e),n=t/r.resolution,s=(r.boundingBox.yMax-r.boundingBox.yMin+r.underlineThickness)*n,o=[],l=0,c=0;for(let e=0;e<a.length;e++){let t=a[e];if("\n"===t)l=0,c-=s*i.lineHeight;else{let e=createPath(t,n,l,c,r);e&&(l+=e.offsetX+i.letterSpacing,o.push(e.path))}}return o}function createPath(e,t,r,i,a){let n,s,o,l,c,u,h,p;let f=a.glyphs[e]||a.glyphs["?"];if(!f){console.error('THREE.Font: character "'+e+'" does not exists in font family '+a.familyName+".");return}let m=new d.ShapePath;if(f.o){let e=f._cachedOutline||(f._cachedOutline=f.o.split(" "));for(let a=0,d=e.length;a<d;){let d=e[a++];switch(d){case"m":n=parseInt(e[a++])*t+r,s=parseInt(e[a++])*t+i,m.moveTo(n,s);break;case"l":n=parseInt(e[a++])*t+r,s=parseInt(e[a++])*t+i,m.lineTo(n,s);break;case"q":o=parseInt(e[a++])*t+r,l=parseInt(e[a++])*t+i,c=parseInt(e[a++])*t+r,u=parseInt(e[a++])*t+i,m.quadraticCurveTo(c,u,o,l);break;case"b":o=parseInt(e[a++])*t+r,l=parseInt(e[a++])*t+i,c=parseInt(e[a++])*t+r,u=parseInt(e[a++])*t+i,h=parseInt(e[a++])*t+r,p=parseInt(e[a++])*t+i,m.bezierCurveTo(c,u,h,p,o,l)}}}return{offsetX:f.ha*t,path:m}}__publicField(Font,"isFont"),__publicField(Font,"type");let TGALoader=class TGALoader extends null{constructor(e){super(e)}parse(e){function tgaCheckHeader(e){switch(e.image_type){case r:case n:(e.colormap_length>256||24!==e.colormap_size||1!==e.colormap_type)&&console.error("THREE.TGALoader: Invalid type colormap data for indexed type.");break;case i:case a:case s:case o:e.colormap_type&&console.error("THREE.TGALoader: Invalid type colormap data for colormap type.");break;case t:console.error("THREE.TGALoader: No data.");default:console.error('THREE.TGALoader: Invalid type "%s".',e.image_type)}(e.width<=0||e.height<=0)&&console.error("THREE.TGALoader: Invalid image size."),8!==e.pixel_size&&16!==e.pixel_size&&24!==e.pixel_size&&32!==e.pixel_size&&console.error('THREE.TGALoader: Invalid pixel size "%s".',e.pixel_size)}function tgaParse(e,t,r,i,a){let n,s;let o=r.pixel_size>>3,l=r.width*r.height*o;if(t&&(s=a.subarray(i,i+=r.colormap_length*(r.colormap_size>>3))),e){let e,t,r;n=new Uint8Array(l);let s=0,c=new Uint8Array(o);for(;s<l;)if(t=(127&(e=a[i++]))+1,128&e){for(r=0;r<o;++r)c[r]=a[i++];for(r=0;r<t;++r)n.set(c,s+r*o);s+=o*t}else{for(t*=o,r=0;r<t;++r)n[s+r]=a[i++];s+=t}}else n=a.subarray(i,i+=t?r.width*r.height:l);return{pixel_data:n,palettes:s}}function tgaGetImageData8bits(e,t,r,i,a,n,s,o,l){let c,u=0,h,p,d=g.width;for(p=t;p!==i;p+=r)for(h=a;h!==s;h+=n,u++)c=o[u],e[(h+d*p)*4+3]=255,e[(h+d*p)*4+2]=l[3*c+0],e[(h+d*p)*4+1]=l[3*c+1],e[(h+d*p)*4+0]=l[3*c+2];return e}function tgaGetImageData16bits(e,t,r,i,a,n,s,o){let l,c=0,u,h,p=g.width;for(h=t;h!==i;h+=r)for(u=a;u!==s;u+=n,c+=2)l=o[c+0]+(o[c+1]<<8),e[(u+p*h)*4+0]=(31744&l)>>7,e[(u+p*h)*4+1]=(992&l)>>2,e[(u+p*h)*4+2]=(31&l)>>3,e[(u+p*h)*4+3]=32768&l?0:255;return e}function tgaGetImageData24bits(e,t,r,i,a,n,s,o){let l=0,c,u,h=g.width;for(u=t;u!==i;u+=r)for(c=a;c!==s;c+=n,l+=3)e[(c+h*u)*4+3]=255,e[(c+h*u)*4+2]=o[l+0],e[(c+h*u)*4+1]=o[l+1],e[(c+h*u)*4+0]=o[l+2];return e}function tgaGetImageData32bits(e,t,r,i,a,n,s,o){let l=0,c,u,h=g.width;for(u=t;u!==i;u+=r)for(c=a;c!==s;c+=n,l+=4)e[(c+h*u)*4+2]=o[l+0],e[(c+h*u)*4+1]=o[l+1],e[(c+h*u)*4+0]=o[l+2],e[(c+h*u)*4+3]=o[l+3];return e}function tgaGetImageDataGrey8bits(e,t,r,i,a,n,s,o){let l,c=0,u,h,p=g.width;for(h=t;h!==i;h+=r)for(u=a;u!==s;u+=n,c++)l=o[c],e[(u+p*h)*4+0]=l,e[(u+p*h)*4+1]=l,e[(u+p*h)*4+2]=l,e[(u+p*h)*4+3]=255;return e}function tgaGetImageDataGrey16bits(e,t,r,i,a,n,s,o){let l=0,c,u,h=g.width;for(u=t;u!==i;u+=r)for(c=a;c!==s;c+=n,l+=2)e[(c+h*u)*4+0]=o[l+0],e[(c+h*u)*4+1]=o[l+0],e[(c+h*u)*4+2]=o[l+0],e[(c+h*u)*4+3]=o[l+1];return e}function getTgaRGBA(e,t,r,i,a){let n,s,o,f,m,v;switch((g.flags&l)>>c){default:case p:n=0,o=1,m=t,s=0,f=1,v=r;break;case u:n=0,o=1,m=t,s=r-1,f=-1,v=-1;break;case d:n=t-1,o=-1,m=-1,s=0,f=1,v=r;break;case h:n=t-1,o=-1,m=-1,s=r-1,f=-1,v=-1}if(x)switch(g.pixel_size){case 8:tgaGetImageDataGrey8bits(e,s,f,v,n,o,m,i);break;case 16:tgaGetImageDataGrey16bits(e,s,f,v,n,o,m,i);break;default:console.error("THREE.TGALoader: Format not supported.")}else switch(g.pixel_size){case 8:tgaGetImageData8bits(e,s,f,v,n,o,m,i,a);break;case 16:tgaGetImageData16bits(e,s,f,v,n,o,m,i);break;case 24:tgaGetImageData24bits(e,s,f,v,n,o,m,i);break;case 32:tgaGetImageData32bits(e,s,f,v,n,o,m,i);break;default:console.error("THREE.TGALoader: Format not supported.")}return e}let t=0,r=1,i=2,a=3,n=9,s=10,o=11,l=48,c=4,u=0,h=1,p=2,d=3;e.length<19&&console.error("THREE.TGALoader: Not enough data to contain header.");let f=0,m=new Uint8Array(e),g={id_length:m[f++],colormap_type:m[f++],image_type:m[f++],colormap_index:m[f++]|m[f++]<<8,colormap_length:m[f++]|m[f++]<<8,colormap_size:m[f++],origin:[m[f++]|m[f++]<<8,m[f++]|m[f++]<<8],width:m[f++]|m[f++]<<8,height:m[f++]|m[f++]<<8,pixel_size:m[f++],flags:m[f++]};tgaCheckHeader(g),g.id_length+f>e.length&&console.error("THREE.TGALoader: No data."),f+=g.id_length;let v=!1,y=!1,x=!1;switch(g.image_type){case n:v=!0,y=!0;break;case r:y=!0;break;case s:v=!0;break;case i:break;case o:v=!0,x=!0;break;case a:x=!0}let b=new Uint8Array(g.width*g.height*4),T=tgaParse(v,y,g,f,m);return getTgaRGBA(b,g.width,g.height,T.pixel_data,T.palettes),{data:b,width:g.width,height:g.height,flipY:!0,generateMipmaps:!0,minFilter:LinearMipmapLinearFilter}}};let Data3DTexture=class Data3DTexture extends d.Texture{constructor(e=null,t=1,r=1,i=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:r,depth:i},this.magFilter=d.NearestFilter,this.minFilter=d.NearestFilter,this.wrapR=d.ClampToEdgeWrapping,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}};let{CstParser:tu,Lexer:th,createToken:tp}=(()=>{var e,t,r,i,a,n,s,o,l,c,u,h,p,d="object"==typeof global&&global&&global.Object===Object&&global,f="object"==typeof self&&self&&self.Object===Object&&self,m=d||f||Function("return this")(),g=m.Symbol,v=Object.prototype,y=v.hasOwnProperty,x=v.toString,b=g?g.toStringTag:void 0;function getRawTag(e){var t=y.call(e,b),r=e[b];try{e[b]=void 0;var i=!0}catch(e){}var a=x.call(e);return i&&(t?e[b]=r:delete e[b]),a}var T=Object.prototype.toString;function objectToString(e){return T.call(e)}var S=g?g.toStringTag:void 0;function baseGetTag(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":S&&S in Object(e)?getRawTag(e):objectToString(e)}function isObjectLike(e){return null!=e&&"object"==typeof e}function isSymbol(e){return"symbol"==typeof e||isObjectLike(e)&&"[object Symbol]"==baseGetTag(e)}function arrayMap(e,t){for(var r=-1,i=null==e?0:e.length,a=Array(i);++r<i;)a[r]=t(e[r],r,e);return a}var E=Array.isArray,R=1/0,A=g?g.prototype:void 0,C=A?A.toString:void 0;function baseToString(e){if("string"==typeof e)return e;if(E(e))return arrayMap(e,baseToString)+"";if(isSymbol(e))return C?C.call(e):"";var t=e+"";return"0"==t&&1/e==-R?"-0":t}var M=/\s/;function trimmedEndIndex(e){for(var t=e.length;t--&&M.test(e.charAt(t)););return t}var P=/^\s+/;function baseTrim(e){return e?e.slice(0,trimmedEndIndex(e)+1).replace(P,""):e}function isObject(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var w=0/0,I=/^[-+]0x[0-9a-f]+$/i,k=/^0b[01]+$/i,_=/^0o[0-7]+$/i,O=parseInt;function toNumber(e){if("number"==typeof e)return e;if(isSymbol(e))return w;if(isObject(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=isObject(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=baseTrim(e);var r=k.test(e);return r||_.test(e)?O(e.slice(2),r?2:8):I.test(e)?w:+e}var N=1/0;function toFinite(e){return e?(e=toNumber(e))===N||e===-N?(e<0?-1:1)*17976931348623157e292:e==e?e:0:0===e?e:0}function toInteger(e){var t=toFinite(e),r=t%1;return t==t?r?t-r:t:0}function identity(e){return e}function isFunction(e){if(!isObject(e))return!1;var t=baseGetTag(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}var L=m["__core-js_shared__"],F=(a=/[^.]+$/.exec(L&&L.keys&&L.keys.IE_PROTO||""))?"Symbol(src)_1."+a:"";function isMasked(e){return!!F&&F in e}var D=Function.prototype.toString;function toSource(e){if(null!=e){try{return D.call(e)}catch(e){}try{return e+""}catch(e){}}return""}var U=/^\[object .+?Constructor\]$/,B=Object.prototype,V=Function.prototype.toString,G=B.hasOwnProperty,z=RegExp("^"+V.call(G).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function baseIsNative(e){return!(!isObject(e)||isMasked(e))&&(isFunction(e)?z:U).test(toSource(e))}function getValue(e,t){return null==e?void 0:e[t]}function getNative(e,t){var r=getValue(e,t);return baseIsNative(r)?r:void 0}var H=getNative(m,"WeakMap"),j=Object.create,W=function(){function object(){}return function(e){if(!isObject(e))return{};if(j)return j(e);object.prototype=e;var t=new object;return object.prototype=void 0,t}}();function apply(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)}function noop(){}function copyArray(e,t){var r=-1,i=e.length;for(t||(t=Array(i));++r<i;)t[r]=e[r];return t}var K=Date.now;function shortOut(e){var t=0,r=0;return function(){var i=K(),a=16-(i-r);if(r=i,a>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}function constant(e){return function(){return e}}var X=function(){try{var e=getNative(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),q=shortOut(X?function(e,t){return X(e,"toString",{configurable:!0,enumerable:!1,value:constant(t),writable:!0})}:identity);function arrayEach(e,t){for(var r=-1,i=null==e?0:e.length;++r<i&&!1!==t(e[r],r,e););return e}function baseFindIndex(e,t,r,i){for(var a=e.length,n=r+(i?1:-1);i?n--:++n<a;)if(t(e[n],n,e))return n;return -1}function baseIsNaN(e){return e!=e}function strictIndexOf(e,t,r){for(var i=r-1,a=e.length;++i<a;)if(e[i]===t)return i;return -1}function baseIndexOf(e,t,r){return t==t?strictIndexOf(e,t,r):baseFindIndex(e,baseIsNaN,r)}function arrayIncludes(e,t){return!!(null==e?0:e.length)&&baseIndexOf(e,t,0)>-1}var Y=/^(?:0|[1-9]\d*)$/;function isIndex(e,t){var r=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==r||"symbol"!=r&&Y.test(e))&&e>-1&&e%1==0&&e<t}function baseAssignValue(e,t,r){"__proto__"==t&&X?X(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r}function eq(e,t){return e===t||e!=e&&t!=t}var Z=Object.prototype.hasOwnProperty;function assignValue(e,t,r){var i=e[t];Z.call(e,t)&&eq(i,r)&&(void 0!==r||t in e)||baseAssignValue(e,t,r)}function copyObject(e,t,r,i){var a=!r;r||(r={});for(var n=-1,s=t.length;++n<s;){var o=t[n],l=i?i(r[o],e[o],o,r,e):void 0;void 0===l&&(l=e[o]),a?baseAssignValue(r,o,l):assignValue(r,o,l)}return r}var $=Math.max;function overRest(e,t,r){return t=$(void 0===t?e.length-1:t,0),function(){for(var i=arguments,a=-1,n=$(i.length-t,0),s=Array(n);++a<n;)s[a]=i[t+a];a=-1;for(var o=Array(t+1);++a<t;)o[a]=i[a];return o[t]=r(s),apply(e,this,o)}}function baseRest(e,t){return q(overRest(e,t,identity),e+"")}function isLength(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}function isArrayLike(e){return null!=e&&isLength(e.length)&&!isFunction(e)}function isIterateeCall(e,t,r){if(!isObject(r))return!1;var i=typeof t;return("number"==i?!!(isArrayLike(r)&&isIndex(t,r.length)):"string"==i&&t in r)&&eq(r[t],e)}function createAssigner(e){return baseRest(function(t,r){var i=-1,a=r.length,n=a>1?r[a-1]:void 0,s=a>2?r[2]:void 0;for(n=e.length>3&&"function"==typeof n?(a--,n):void 0,s&&isIterateeCall(r[0],r[1],s)&&(n=a<3?void 0:n,a=1),t=Object(t);++i<a;){var o=r[i];o&&e(t,o,i,n)}return t})}var Q=Object.prototype;function isPrototype(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Q)}function baseTimes(e,t){for(var r=-1,i=Array(e);++r<e;)i[r]=t(r);return i}function baseIsArguments(e){return isObjectLike(e)&&"[object Arguments]"==baseGetTag(e)}var J=Object.prototype,ee=J.hasOwnProperty,et=J.propertyIsEnumerable,er=baseIsArguments(function(){return arguments}())?baseIsArguments:function(e){return isObjectLike(e)&&ee.call(e,"callee")&&!et.call(e,"callee")};function stubFalse(){return!1}var ei="object"==typeof exports&&exports&&!exports.nodeType&&exports,ea=ei&&"object"==typeof module&&module&&!module.nodeType&&module,en=ea&&ea.exports===ei?m.Buffer:void 0,es=en?en.isBuffer:void 0;let eo=es||stubFalse;var el={};function baseIsTypedArray(e){return isObjectLike(e)&&isLength(e.length)&&!!el[baseGetTag(e)]}function baseUnary(e){return function(t){return e(t)}}el["[object Float32Array]"]=el["[object Float64Array]"]=el["[object Int8Array]"]=el["[object Int16Array]"]=el["[object Int32Array]"]=el["[object Uint8Array]"]=el["[object Uint8ClampedArray]"]=el["[object Uint16Array]"]=el["[object Uint32Array]"]=!0,el["[object Arguments]"]=el["[object Array]"]=el["[object ArrayBuffer]"]=el["[object Boolean]"]=el["[object DataView]"]=el["[object Date]"]=el["[object Error]"]=el["[object Function]"]=el["[object Map]"]=el["[object Number]"]=el["[object Object]"]=el["[object RegExp]"]=el["[object Set]"]=el["[object String]"]=el["[object WeakMap]"]=!1;var ec="object"==typeof exports&&exports&&!exports.nodeType&&exports,eu=ec&&"object"==typeof module&&module&&!module.nodeType&&module,eh=eu&&eu.exports===ec&&d.process,ep=function(){try{var e=eu&&eu.require&&eu.require("util").types;if(e)return e;return eh&&eh.binding&&eh.binding("util")}catch(e){}}(),ed=ep&&ep.isTypedArray,ef=ed?baseUnary(ed):baseIsTypedArray,em=Object.prototype.hasOwnProperty;function arrayLikeKeys(e,t){var r=E(e),i=!r&&er(e),a=!r&&!i&&eo(e),n=!r&&!i&&!a&&ef(e),s=r||i||a||n,o=s?baseTimes(e.length,String):[],l=o.length;for(var c in e)(t||em.call(e,c))&&!(s&&("length"==c||a&&("offset"==c||"parent"==c)||n&&("buffer"==c||"byteLength"==c||"byteOffset"==c)||isIndex(c,l)))&&o.push(c);return o}function overArg(e,t){return function(r){return e(t(r))}}var eg=overArg(Object.keys,Object),ev=Object.prototype.hasOwnProperty;function baseKeys(e){if(!isPrototype(e))return eg(e);var t=[];for(var r in Object(e))ev.call(e,r)&&"constructor"!=r&&t.push(r);return t}function keys(e){return isArrayLike(e)?arrayLikeKeys(e):baseKeys(e)}var ey=Object.prototype.hasOwnProperty,ex=createAssigner(function(e,t){if(isPrototype(t)||isArrayLike(t)){copyObject(t,keys(t),e);return}for(var r in t)ey.call(t,r)&&assignValue(e,r,t[r])});function nativeKeysIn(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t}var eb=Object.prototype.hasOwnProperty;function baseKeysIn(e){if(!isObject(e))return nativeKeysIn(e);var t=isPrototype(e),r=[];for(var i in e)"constructor"==i&&(t||!eb.call(e,i))||r.push(i);return r}function keysIn(e){return isArrayLike(e)?arrayLikeKeys(e,!0):baseKeysIn(e)}var eT=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,eS=/^\w*$/;function isKey(e,t){if(E(e))return!1;var r=typeof e;return!!("number"==r||"symbol"==r||"boolean"==r||null==e||isSymbol(e))||eS.test(e)||!eT.test(e)||null!=t&&e in Object(t)}var eE=getNative(Object,"create");function hashClear(){this.__data__=eE?eE(null):{},this.size=0}function hashDelete(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var eR=Object.prototype.hasOwnProperty;function hashGet(e){var t=this.__data__;if(eE){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return eR.call(t,e)?t[e]:void 0}var eA=Object.prototype.hasOwnProperty;function hashHas(e){var t=this.__data__;return eE?void 0!==t[e]:eA.call(t,e)}function hashSet(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=eE&&void 0===t?"__lodash_hash_undefined__":t,this}function Hash(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}function listCacheClear(){this.__data__=[],this.size=0}function assocIndexOf(e,t){for(var r=e.length;r--;)if(eq(e[r][0],t))return r;return -1}Hash.prototype.clear=hashClear,Hash.prototype.delete=hashDelete,Hash.prototype.get=hashGet,Hash.prototype.has=hashHas,Hash.prototype.set=hashSet;var eC=Array.prototype.splice;function listCacheDelete(e){var t=this.__data__,r=assocIndexOf(t,e);return!(r<0)&&(r==t.length-1?t.pop():eC.call(t,r,1),--this.size,!0)}function listCacheGet(e){var t=this.__data__,r=assocIndexOf(t,e);return r<0?void 0:t[r][1]}function listCacheHas(e){return assocIndexOf(this.__data__,e)>-1}function listCacheSet(e,t){var r=this.__data__,i=assocIndexOf(r,e);return i<0?(++this.size,r.push([e,t])):r[i][1]=t,this}function ListCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}ListCache.prototype.clear=listCacheClear,ListCache.prototype.delete=listCacheDelete,ListCache.prototype.get=listCacheGet,ListCache.prototype.has=listCacheHas,ListCache.prototype.set=listCacheSet;var eM=getNative(m,"Map");function mapCacheClear(){this.size=0,this.__data__={hash:new Hash,map:new(eM||ListCache),string:new Hash}}function isKeyable(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}function getMapData(e,t){var r=e.__data__;return isKeyable(t)?r["string"==typeof t?"string":"hash"]:r.map}function mapCacheDelete(e){var t=getMapData(this,e).delete(e);return this.size-=t?1:0,t}function mapCacheGet(e){return getMapData(this,e).get(e)}function mapCacheHas(e){return getMapData(this,e).has(e)}function mapCacheSet(e,t){var r=getMapData(this,e),i=r.size;return r.set(e,t),this.size+=r.size==i?0:1,this}function MapCache(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var i=e[t];this.set(i[0],i[1])}}function memoize(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw TypeError("Expected a function");var memoized=function(){var r=arguments,i=t?t.apply(this,r):r[0],a=memoized.cache;if(a.has(i))return a.get(i);var n=e.apply(this,r);return memoized.cache=a.set(i,n)||a,n};return memoized.cache=new(memoize.Cache||MapCache),memoized}MapCache.prototype.clear=mapCacheClear,MapCache.prototype.delete=mapCacheDelete,MapCache.prototype.get=mapCacheGet,MapCache.prototype.has=mapCacheHas,MapCache.prototype.set=mapCacheSet,memoize.Cache=MapCache;var eP=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,ew=/\\(\\)?/g,eI=(t=(e=memoize(function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(eP,function(e,r,i,a){t.push(i?a.replace(ew,"$1"):r||e)}),t},function(e){return 500===t.size&&t.clear(),e})).cache,e);function toString(e){return null==e?"":baseToString(e)}function castPath(e,t){return E(e)?e:isKey(e,t)?[e]:eI(toString(e))}var ek=1/0;function toKey(e){if("string"==typeof e||isSymbol(e))return e;var t=e+"";return"0"==t&&1/e==-ek?"-0":t}function baseGet(e,t){t=castPath(t,e);for(var r=0,i=t.length;null!=e&&r<i;)e=e[toKey(t[r++])];return r&&r==i?e:void 0}function get2(e,t,r){var i=null==e?void 0:baseGet(e,t);return void 0===i?r:i}function arrayPush(e,t){for(var r=-1,i=t.length,a=e.length;++r<i;)e[a+r]=t[r];return e}var e_=g?g.isConcatSpreadable:void 0;function isFlattenable(e){return E(e)||er(e)||!!(e_&&e&&e[e_])}function baseFlatten(e,t,r,i,a){var n=-1,s=e.length;for(r||(r=isFlattenable),a||(a=[]);++n<s;){var o=e[n];t>0&&r(o)?t>1?baseFlatten(o,t-1,r,i,a):arrayPush(a,o):i||(a[a.length]=o)}return a}function flatten(e){return(null==e?0:e.length)?baseFlatten(e,1):[]}var eO=overArg(Object.getPrototypeOf,Object);function baseSlice(e,t,r){var i=-1,a=e.length;t<0&&(t=-t>a?0:a+t),(r=r>a?a:r)<0&&(r+=a),a=t>r?0:r-t>>>0,t>>>=0;for(var n=Array(a);++i<a;)n[i]=e[i+t];return n}function arrayReduce(e,t,r,i){var a=-1,n=null==e?0:e.length;for(i&&n&&(r=e[++a]);++a<n;)r=t(r,e[a],a,e);return r}function stackClear(){this.__data__=new ListCache,this.size=0}function stackDelete(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r}function stackGet(e){return this.__data__.get(e)}function stackHas(e){return this.__data__.has(e)}function stackSet(e,t){var r=this.__data__;if(r instanceof ListCache){var i=r.__data__;if(!eM||i.length<199)return i.push([e,t]),this.size=++r.size,this;r=this.__data__=new MapCache(i)}return r.set(e,t),this.size=r.size,this}function Stack(e){var t=this.__data__=new ListCache(e);this.size=t.size}function baseAssign(e,t){return e&&copyObject(t,keys(t),e)}function baseAssignIn(e,t){return e&&copyObject(t,keysIn(t),e)}Stack.prototype.clear=stackClear,Stack.prototype.delete=stackDelete,Stack.prototype.get=stackGet,Stack.prototype.has=stackHas,Stack.prototype.set=stackSet;var eN="object"==typeof exports&&exports&&!exports.nodeType&&exports,eL=eN&&"object"==typeof module&&module&&!module.nodeType&&module,eF=eL&&eL.exports===eN?m.Buffer:void 0,eD=eF?eF.allocUnsafe:void 0;function cloneBuffer(e,t){if(t)return e.slice();var r=e.length,i=eD?eD(r):new e.constructor(r);return e.copy(i),i}function arrayFilter(e,t){for(var r=-1,i=null==e?0:e.length,a=0,n=[];++r<i;){var s=e[r];t(s,r,e)&&(n[a++]=s)}return n}function stubArray(){return[]}var eU=Object.prototype.propertyIsEnumerable,eB=Object.getOwnPropertySymbols,eV=eB?function(e){return null==e?[]:arrayFilter(eB(e=Object(e)),function(t){return eU.call(e,t)})}:stubArray;function copySymbols(e,t){return copyObject(e,eV(e),t)}var eG=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)arrayPush(t,eV(e)),e=eO(e);return t}:stubArray;function copySymbolsIn(e,t){return copyObject(e,eG(e),t)}function baseGetAllKeys(e,t,r){var i=t(e);return E(e)?i:arrayPush(i,r(e))}function getAllKeys(e){return baseGetAllKeys(e,keys,eV)}function getAllKeysIn(e){return baseGetAllKeys(e,keysIn,eG)}var ez=getNative(m,"DataView"),eH=getNative(m,"Promise"),ej=getNative(m,"Set"),eW="[object Map]",eK="[object Promise]",eX="[object Set]",eY="[object WeakMap]",eZ="[object DataView]",e$=toSource(ez),eQ=toSource(eM),eJ=toSource(eH),e0=toSource(ej),e1=toSource(H),e2=baseGetTag;(ez&&e2(new ez(new ArrayBuffer(1)))!=eZ||eM&&e2(new eM)!=eW||eH&&e2(eH.resolve())!=eK||ej&&e2(new ej)!=eX||H&&e2(new H)!=eY)&&(e2=function(e){var t=baseGetTag(e),r="[object Object]"==t?e.constructor:void 0,i=r?toSource(r):"";if(i)switch(i){case e$:return eZ;case eQ:return eW;case eJ:return eK;case e0:return eX;case e1:return eY}return t});let e3=e2;var e4=Object.prototype.hasOwnProperty;function initCloneArray(e){var t=e.length,r=new e.constructor(t);return t&&"string"==typeof e[0]&&e4.call(e,"index")&&(r.index=e.index,r.input=e.input),r}var e5=m.Uint8Array;function cloneArrayBuffer(e){var t=new e.constructor(e.byteLength);return new e5(t).set(new e5(e)),t}function cloneDataView(e,t){var r=t?cloneArrayBuffer(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)}var e6=/\w*$/;function cloneRegExp(e){var t=new e.constructor(e.source,e6.exec(e));return t.lastIndex=e.lastIndex,t}var e8=g?g.prototype:void 0,e9=e8?e8.valueOf:void 0;function cloneSymbol(e){return e9?Object(e9.call(e)):{}}function cloneTypedArray(e,t){var r=t?cloneArrayBuffer(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)}function initCloneByTag(e,t,r){var i=e.constructor;switch(t){case"[object ArrayBuffer]":return cloneArrayBuffer(e);case"[object Boolean]":case"[object Date]":return new i(+e);case"[object DataView]":return cloneDataView(e,r);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return cloneTypedArray(e,r);case"[object Map]":case"[object Set]":return new i;case"[object Number]":case"[object String]":return new i(e);case"[object RegExp]":return cloneRegExp(e);case"[object Symbol]":return cloneSymbol(e)}}function initCloneObject(e){return"function"!=typeof e.constructor||isPrototype(e)?{}:W(eO(e))}function baseIsMap(e){return isObjectLike(e)&&"[object Map]"==e3(e)}var e7=ep&&ep.isMap,te=e7?baseUnary(e7):baseIsMap;function baseIsSet(e){return isObjectLike(e)&&"[object Set]"==e3(e)}var tt=ep&&ep.isSet,tr=tt?baseUnary(tt):baseIsSet,ti="[object Arguments]",ta="[object Function]",tn="[object Object]",ts={};function baseClone(e,t,r,i,a,n){var s,o=1&t,l=2&t,c=4&t;if(r&&(s=a?r(e,i,a,n):r(e)),void 0!==s)return s;if(!isObject(e))return e;var u=E(e);if(u){if(s=initCloneArray(e),!o)return copyArray(e,s)}else{var h=e3(e),p=h==ta||"[object GeneratorFunction]"==h;if(eo(e))return cloneBuffer(e,o);if(h==tn||h==ti||p&&!a){if(s=l||p?{}:initCloneObject(e),!o)return l?copySymbolsIn(e,baseAssignIn(s,e)):copySymbols(e,baseAssign(s,e))}else{if(!ts[h])return a?e:{};s=initCloneByTag(e,h,o)}}n||(n=new Stack);var d=n.get(e);if(d)return d;n.set(e,s),tr(e)?e.forEach(function(i){s.add(baseClone(i,t,r,i,e,n))}):te(e)&&e.forEach(function(i,a){s.set(a,baseClone(i,t,r,a,e,n))});var f=c?l?getAllKeysIn:getAllKeys:l?keysIn:keys,m=u?void 0:f(e);return arrayEach(m||e,function(i,a){m&&(i=e[a=i]),assignValue(s,a,baseClone(i,t,r,a,e,n))}),s}function clone2(e){return baseClone(e,4)}function compact(e){for(var t=-1,r=null==e?0:e.length,i=0,a=[];++t<r;){var n=e[t];n&&(a[i++]=n)}return a}function setCacheAdd(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this}function setCacheHas(e){return this.__data__.has(e)}function SetCache(e){var t=-1,r=null==e?0:e.length;for(this.__data__=new MapCache;++t<r;)this.add(e[t])}function arraySome(e,t){for(var r=-1,i=null==e?0:e.length;++r<i;)if(t(e[r],r,e))return!0;return!1}function cacheHas(e,t){return e.has(t)}function equalArrays(e,t,r,i,a,n){var s=1&r,o=e.length,l=t.length;if(o!=l&&!(s&&l>o))return!1;var c=n.get(e),u=n.get(t);if(c&&u)return c==t&&u==e;var h=-1,p=!0,d=2&r?new SetCache:void 0;for(n.set(e,t),n.set(t,e);++h<o;){var f=e[h],m=t[h];if(i)var g=s?i(m,f,h,t,e,n):i(f,m,h,e,t,n);if(void 0!==g){if(g)continue;p=!1;break}if(d){if(!arraySome(t,function(e,t){if(!cacheHas(d,t)&&(f===e||a(f,e,r,i,n)))return d.push(t)})){p=!1;break}}else if(!(f===m||a(f,m,r,i,n))){p=!1;break}}return n.delete(e),n.delete(t),p}function mapToArray(e){var t=-1,r=Array(e.size);return e.forEach(function(e,i){r[++t]=[i,e]}),r}function setToArray(e){var t=-1,r=Array(e.size);return e.forEach(function(e){r[++t]=e}),r}ts[ti]=ts["[object Array]"]=ts["[object ArrayBuffer]"]=ts["[object DataView]"]=ts["[object Boolean]"]=ts["[object Date]"]=ts["[object Float32Array]"]=ts["[object Float64Array]"]=ts["[object Int8Array]"]=ts["[object Int16Array]"]=ts["[object Int32Array]"]=ts["[object Map]"]=ts["[object Number]"]=ts[tn]=ts["[object RegExp]"]=ts["[object Set]"]=ts["[object String]"]=ts["[object Symbol]"]=ts["[object Uint8Array]"]=ts["[object Uint8ClampedArray]"]=ts["[object Uint16Array]"]=ts["[object Uint32Array]"]=!0,ts["[object Error]"]=ts[ta]=ts["[object WeakMap]"]=!1,SetCache.prototype.add=SetCache.prototype.push=setCacheAdd,SetCache.prototype.has=setCacheHas;var to=g?g.prototype:void 0,tl=to?to.valueOf:void 0;function equalByTag(e,t,r,i,a,n,s){switch(r){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)break;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":if(e.byteLength!=t.byteLength||!n(new e5(e),new e5(t)))break;return!0;case"[object Boolean]":case"[object Date]":case"[object Number]":return eq(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var o=mapToArray;case"[object Set]":var l=1&i;if(o||(o=setToArray),e.size!=t.size&&!l)break;var c=s.get(e);if(c)return c==t;i|=2,s.set(e,t);var u=equalArrays(o(e),o(t),i,a,n,s);return s.delete(e),u;case"[object Symbol]":if(tl)return tl.call(e)==tl.call(t)}return!1}var tc=Object.prototype.hasOwnProperty;function equalObjects(e,t,r,i,a,n){var s=1&r,o=getAllKeys(e),l=o.length;if(l!=getAllKeys(t).length&&!s)return!1;for(var c=l;c--;){var u=o[c];if(!(s?u in t:tc.call(t,u)))return!1}var h=n.get(e),p=n.get(t);if(h&&p)return h==t&&p==e;var d=!0;n.set(e,t),n.set(t,e);for(var f=s;++c<l;){var m=e[u=o[c]],g=t[u];if(i)var v=s?i(g,m,u,t,e,n):i(m,g,u,e,t,n);if(!(void 0===v?m===g||a(m,g,r,i,n):v)){d=!1;break}f||(f="constructor"==u)}if(d&&!f){var y=e.constructor,x=t.constructor;y!=x&&"constructor"in e&&"constructor"in t&&!("function"==typeof y&&y instanceof y&&"function"==typeof x&&x instanceof x)&&(d=!1)}return n.delete(e),n.delete(t),d}var tu="[object Arguments]",th="[object Array]",tp="[object Object]",td=Object.prototype.hasOwnProperty;function baseIsEqualDeep(e,t,r,i,a,n){var s=E(e),o=E(t),l=s?th:e3(e),c=o?th:e3(t);l=l==tu?tp:l,c=c==tu?tp:c;var u=l==tp,h=c==tp,p=l==c;if(p&&eo(e)){if(!eo(t))return!1;s=!0,u=!1}if(p&&!u)return n||(n=new Stack),s||ef(e)?equalArrays(e,t,r,i,a,n):equalByTag(e,t,l,r,i,a,n);if(!(1&r)){var d=u&&td.call(e,"__wrapped__"),f=h&&td.call(t,"__wrapped__");if(d||f){var m=d?e.value():e,g=f?t.value():t;return n||(n=new Stack),a(m,g,r,i,n)}}return!!p&&(n||(n=new Stack),equalObjects(e,t,r,i,a,n))}function baseIsEqual(e,t,r,i,a){return e===t||(null!=e&&null!=t&&(isObjectLike(e)||isObjectLike(t))?baseIsEqualDeep(e,t,r,i,baseIsEqual,a):e!=e&&t!=t)}function baseIsMatch(e,t,r,i){var a=r.length,n=a,s=!i;if(null==e)return!n;for(e=Object(e);a--;){var o=r[a];if(s&&o[2]?o[1]!==e[o[0]]:!(o[0]in e))return!1}for(;++a<n;){var l=(o=r[a])[0],c=e[l],u=o[1];if(s&&o[2]){if(void 0===c&&!(l in e))return!1}else{var h=new Stack;if(i)var p=i(c,u,l,e,t,h);if(!(void 0===p?baseIsEqual(u,c,3,i,h):p))return!1}}return!0}function getMatchData(e){for(var t=keys(e),r=t.length;r--;){var i=t[r],a=e[i];t[r]=[i,a,a==a&&!isObject(a)]}return t}function matchesStrictComparable(e,t){return function(r){return null!=r&&r[e]===t&&(void 0!==t||e in Object(r))}}function baseMatches(e){var t=getMatchData(e);return 1==t.length&&t[0][2]?matchesStrictComparable(t[0][0],t[0][1]):function(r){return r===e||baseIsMatch(r,e,t)}}function baseHasIn(e,t){return null!=e&&t in Object(e)}function hasPath(e,t,r){t=castPath(t,e);for(var i=-1,a=t.length,n=!1;++i<a;){var s=toKey(t[i]);if(!(n=null!=e&&r(e,s)))break;e=e[s]}return n||++i!=a?n:!!(a=null==e?0:e.length)&&isLength(a)&&isIndex(s,a)&&(E(e)||er(e))}function hasIn(e,t){return null!=e&&hasPath(e,t,baseHasIn)}function baseMatchesProperty(e,t){var r;return isKey(e)&&(r=t)==r&&!isObject(r)?matchesStrictComparable(toKey(e),t):function(r){var i=get2(r,e);return void 0===i&&i===t?hasIn(r,e):baseIsEqual(t,i,3)}}function baseProperty(e){return function(t){return null==t?void 0:t[e]}}function basePropertyDeep(e){return function(t){return baseGet(t,e)}}function property2(e){return isKey(e)?baseProperty(toKey(e)):basePropertyDeep(e)}function baseIteratee(e){return"function"==typeof e?e:null==e?identity:"object"==typeof e?E(e)?baseMatchesProperty(e[0],e[1]):baseMatches(e):property2(e)}function arrayAggregator(e,t,r,i){for(var a=-1,n=null==e?0:e.length;++a<n;){var s=e[a];t(i,s,r(s),e)}return i}var baseFor=function(e,t,r){for(var i=-1,a=Object(e),n=r(e),s=n.length;s--;){var o=n[++i];if(!1===t(a[o],o,a))break}return e},baseEach=function(e,t){if(null==e)return e;if(!isArrayLike(e)){var i,a;return i=e,a=t,i&&baseFor(i,a,keys)}for(var n=e.length,s=r?n:-1,o=Object(e);(r?s--:++s<n)&&!1!==t(o[s],s,o););return e};function baseAggregator(e,t,r,i){return baseEach(e,function(e,a,n){t(i,e,r(e),n)}),i}function createAggregator(e,t){return function(r,i){var a=E(r)?arrayAggregator:baseAggregator,n=t?t():{};return a(r,e,baseIteratee(i),n)}}var tf=Object.prototype,tm=tf.hasOwnProperty,tg=baseRest(function(e,t){e=Object(e);var r=-1,i=t.length,a=i>2?t[2]:void 0;for(a&&isIterateeCall(t[0],t[1],a)&&(i=1);++r<i;)for(var n=t[r],s=keysIn(n),o=-1,l=s.length;++o<l;){var c=s[o],u=e[c];(void 0===u||eq(u,tf[c])&&!tm.call(e,c))&&(e[c]=n[c])}return e});function isArrayLikeObject(e){return isObjectLike(e)&&isArrayLike(e)}function arrayIncludesWith(e,t,r){for(var i=-1,a=null==e?0:e.length;++i<a;)if(r(t,e[i]))return!0;return!1}function baseDifference(e,t,r,i){var a=-1,n=arrayIncludes,s=!0,o=e.length,l=[],c=t.length;if(!o)return l;r&&(t=arrayMap(t,baseUnary(r))),i?(n=arrayIncludesWith,s=!1):t.length>=200&&(n=cacheHas,s=!1,t=new SetCache(t));e:for(;++a<o;){var u=e[a],h=null==r?u:r(u);if(u=i||0!==u?u:0,s&&h==h){for(var p=c;p--;)if(t[p]===h)continue e;l.push(u)}else n(t,h,i)||l.push(u)}return l}var tv=baseRest(function(e,t){return isArrayLikeObject(e)?baseDifference(e,baseFlatten(t,1,isArrayLikeObject,!0)):[]});function last(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}function drop(e,t,r){var i=null==e?0:e.length;return i?baseSlice(e,(t=r||void 0===t?1:toInteger(t))<0?0:t,i):[]}function dropRight(e,t,r){var i=null==e?0:e.length;return i?baseSlice(e,0,(t=i-(t=r||void 0===t?1:toInteger(t)))<0?0:t):[]}function castFunction(e){return"function"==typeof e?e:identity}function forEach(e,t){return(E(e)?arrayEach:baseEach)(e,castFunction(t))}function arrayEvery(e,t){for(var r=-1,i=null==e?0:e.length;++r<i;)if(!t(e[r],r,e))return!1;return!0}function baseEvery(e,t){var r=!0;return baseEach(e,function(e,i,a){return r=!!t(e,i,a)}),r}function every(e,t,r){var i=E(e)?arrayEvery:baseEvery;return r&&isIterateeCall(e,t,r)&&(t=void 0),i(e,baseIteratee(t))}function baseFilter(e,t){var r=[];return baseEach(e,function(e,i,a){t(e,i,a)&&r.push(e)}),r}function filter(e,t){return(E(e)?arrayFilter:baseFilter)(e,baseIteratee(t))}var ty=Math.max,tx=(i=function(e,t,r){var i=null==e?0:e.length;if(!i)return -1;var a=null==r?0:toInteger(r);return a<0&&(a=ty(i+a,0)),baseFindIndex(e,baseIteratee(t),a)},function(e,t,r){var a=Object(e);if(!isArrayLike(e)){var n=baseIteratee(t);e=keys(e),t=function(e){return n(a[e],e,a)}}var s=i(e,t,r);return s>-1?a[n?e[s]:s]:void 0});function head(e){return e&&e.length?e[0]:void 0}function baseMap(e,t){var r=-1,i=isArrayLike(e)?Array(e.length):[];return baseEach(e,function(e,a,n){i[++r]=t(e,a,n)}),i}function map(e,t){return(E(e)?arrayMap:baseMap)(e,baseIteratee(t))}function flatMap(e,t){return baseFlatten(map(e,t),1)}var tb=Object.prototype.hasOwnProperty,tT=createAggregator(function(e,t,r){tb.call(e,r)?e[r].push(t):baseAssignValue(e,r,[t])}),tS=Object.prototype.hasOwnProperty;function baseHas(e,t){return null!=e&&tS.call(e,t)}function has(e,t){return null!=e&&hasPath(e,t,baseHas)}function isString(e){return"string"==typeof e||!E(e)&&isObjectLike(e)&&"[object String]"==baseGetTag(e)}function baseValues(e,t){return arrayMap(t,function(t){return e[t]})}function values(e){return null==e?[]:baseValues(e,keys(e))}var tE=Math.max;function includes(e,t,r,i){e=isArrayLike(e)?e:values(e),r=r&&!i?toInteger(r):0;var a=e.length;return r<0&&(r=tE(a+r,0)),isString(e)?r<=a&&e.indexOf(t,r)>-1:!!a&&baseIndexOf(e,t,r)>-1}var tR=Math.max;function indexOf(e,t,r){var i=null==e?0:e.length;if(!i)return -1;var a=null==r?0:toInteger(r);return a<0&&(a=tR(i+a,0)),baseIndexOf(e,t,a)}var tA=Object.prototype.hasOwnProperty;function isEmpty(e){if(null==e)return!0;if(isArrayLike(e)&&(E(e)||"string"==typeof e||"function"==typeof e.splice||eo(e)||ef(e)||er(e)))return!e.length;var t=e3(e);if("[object Map]"==t||"[object Set]"==t)return!e.size;if(isPrototype(e))return!baseKeys(e).length;for(var r in e)if(tA.call(e,r))return!1;return!0}function baseIsRegExp(e){return isObjectLike(e)&&"[object RegExp]"==baseGetTag(e)}var tC=ep&&ep.isRegExp,tM=tC?baseUnary(tC):baseIsRegExp;function isUndefined(e){return void 0===e}function negate(e){if("function"!=typeof e)throw TypeError("Expected a function");return function(){var t=arguments;switch(t.length){case 0:return!e.call(this);case 1:return!e.call(this,t[0]);case 2:return!e.call(this,t[0],t[1]);case 3:return!e.call(this,t[0],t[1],t[2])}return!e.apply(this,t)}}function baseSet(e,t,r,i){if(!isObject(e))return e;t=castPath(t,e);for(var a=-1,n=t.length,s=n-1,o=e;null!=o&&++a<n;){var l=toKey(t[a]),c=r;if("__proto__"===l||"constructor"===l||"prototype"===l)break;if(a!=s){var u=o[l];void 0===(c=i?i(u,l,o):void 0)&&(c=isObject(u)?u:isIndex(t[a+1])?[]:{})}assignValue(o,l,c),o=o[l]}return e}function basePickBy(e,t,r){for(var i=-1,a=t.length,n={};++i<a;){var s=t[i],o=baseGet(e,s);r(o,s)&&baseSet(n,castPath(s,e),o)}return n}function pickBy(e,t){if(null==e)return{};var r=arrayMap(getAllKeysIn(e),function(e){return[e]});return t=baseIteratee(t),basePickBy(e,r,function(e,r){return t(e,r[0])})}function baseReduce(e,t,r,i,a){return a(e,function(e,a,n){r=i?(i=!1,e):t(r,e,a,n)}),r}function reduce(e,t,r){var i=E(e)?arrayReduce:baseReduce,a=arguments.length<3;return i(e,baseIteratee(t),r,a,baseEach)}function reject(e,t){return(E(e)?arrayFilter:baseFilter)(e,negate(baseIteratee(t)))}function baseSome(e,t){var r;return baseEach(e,function(e,i,a){return!(r=t(e,i,a))}),!!r}function some(e,t,r){var i=E(e)?arraySome:baseSome;return r&&isIterateeCall(e,t,r)&&(t=void 0),i(e,baseIteratee(t))}var tP=ej&&1/setToArray(new ej([,-0]))[1]==1/0?function(e){return new ej(e)}:noop;function baseUniq(e,t,r){var i=-1,a=arrayIncludes,n=e.length,s=!0,o=[],l=o;if(r)s=!1,a=arrayIncludesWith;else if(n>=200){var c=t?null:tP(e);if(c)return setToArray(c);s=!1,a=cacheHas,l=new SetCache}else l=t?[]:o;e:for(;++i<n;){var u=e[i],h=t?t(u):u;if(u=r||0!==u?u:0,s&&h==h){for(var p=l.length;p--;)if(l[p]===h)continue e;t&&l.push(h),o.push(u)}else a(l,h,r)||(l!==o&&l.push(h),o.push(u))}return o}function uniq(e){return e&&e.length?baseUniq(e):[]}function PRINT_ERROR(e){console&&console.error&&console.error(`Error: ${e}`)}function PRINT_WARNING(e){console&&console.warn&&console.warn(`Warning: ${e}`)}function timer(e){let t=new Date().getTime(),r=e(),i=new Date().getTime();return{time:i-t,value:r}}function toFastProperties(e){function FakeConstructor(){}FakeConstructor.prototype=e;let t=new FakeConstructor;function fakeAccess(){return typeof t.bar}return fakeAccess(),fakeAccess(),e}function tokenLabel$1(e){return hasTokenLabel$1(e)?e.LABEL:e.name}function hasTokenLabel$1(e){return isString(e.LABEL)&&""!==e.LABEL}let AbstractProduction=class AbstractProduction{get definition(){return this._definition}set definition(e){this._definition=e}constructor(e){this._definition=e}accept(e){e.visit(this),forEach(this.definition,t=>{t.accept(e)})}};let NonTerminal=class NonTerminal extends AbstractProduction{constructor(e){super([]),this.idx=1,ex(this,pickBy(e,e=>void 0!==e))}set definition(e){}get definition(){return void 0!==this.referencedRule?this.referencedRule.definition:[]}accept(e){e.visit(this)}};let Rule=class Rule extends AbstractProduction{constructor(e){super(e.definition),this.orgText="",ex(this,pickBy(e,e=>void 0!==e))}};let Alternative=class Alternative extends AbstractProduction{constructor(e){super(e.definition),this.ignoreAmbiguities=!1,ex(this,pickBy(e,e=>void 0!==e))}};let Option=class Option extends AbstractProduction{constructor(e){super(e.definition),this.idx=1,ex(this,pickBy(e,e=>void 0!==e))}};let RepetitionMandatory=class RepetitionMandatory extends AbstractProduction{constructor(e){super(e.definition),this.idx=1,ex(this,pickBy(e,e=>void 0!==e))}};let RepetitionMandatoryWithSeparator=class RepetitionMandatoryWithSeparator extends AbstractProduction{constructor(e){super(e.definition),this.idx=1,ex(this,pickBy(e,e=>void 0!==e))}};let Repetition=class Repetition extends AbstractProduction{constructor(e){super(e.definition),this.idx=1,ex(this,pickBy(e,e=>void 0!==e))}};let RepetitionWithSeparator=class RepetitionWithSeparator extends AbstractProduction{constructor(e){super(e.definition),this.idx=1,ex(this,pickBy(e,e=>void 0!==e))}};let Alternation=class Alternation extends AbstractProduction{get definition(){return this._definition}set definition(e){this._definition=e}constructor(e){super(e.definition),this.idx=1,this.ignoreAmbiguities=!1,this.hasPredicates=!1,ex(this,pickBy(e,e=>void 0!==e))}};let Terminal=class Terminal{constructor(e){this.idx=1,ex(this,pickBy(e,e=>void 0!==e))}accept(e){e.visit(this)}};function serializeGrammar(e){return map(e,serializeProduction)}function serializeProduction(e){function convertDefinition(e){return map(e,serializeProduction)}if(e instanceof NonTerminal){let t={type:"NonTerminal",name:e.nonTerminalName,idx:e.idx};return isString(e.label)&&(t.label=e.label),t}if(e instanceof Alternative)return{type:"Alternative",definition:convertDefinition(e.definition)};if(e instanceof Option)return{type:"Option",idx:e.idx,definition:convertDefinition(e.definition)};if(e instanceof RepetitionMandatory)return{type:"RepetitionMandatory",idx:e.idx,definition:convertDefinition(e.definition)};if(e instanceof RepetitionMandatoryWithSeparator)return{type:"RepetitionMandatoryWithSeparator",idx:e.idx,separator:serializeProduction(new Terminal({terminalType:e.separator})),definition:convertDefinition(e.definition)};if(e instanceof RepetitionWithSeparator)return{type:"RepetitionWithSeparator",idx:e.idx,separator:serializeProduction(new Terminal({terminalType:e.separator})),definition:convertDefinition(e.definition)};if(e instanceof Repetition)return{type:"Repetition",idx:e.idx,definition:convertDefinition(e.definition)};else if(e instanceof Alternation)return{type:"Alternation",idx:e.idx,definition:convertDefinition(e.definition)};else if(e instanceof Terminal){let t={type:"Terminal",name:e.terminalType.name,label:tokenLabel$1(e.terminalType),idx:e.idx};isString(e.label)&&(t.terminalLabel=e.label);let r=e.terminalType.PATTERN;return e.terminalType.PATTERN&&(t.pattern=tM(r)?r.source:r),t}else if(e instanceof Rule)return{type:"Rule",name:e.name,orgText:e.orgText,definition:convertDefinition(e.definition)};else throw Error("non exhaustive match")}let GAstVisitor=class GAstVisitor{visit(e){switch(e.constructor){case NonTerminal:return this.visitNonTerminal(e);case Alternative:return this.visitAlternative(e);case Option:return this.visitOption(e);case RepetitionMandatory:return this.visitRepetitionMandatory(e);case RepetitionMandatoryWithSeparator:return this.visitRepetitionMandatoryWithSeparator(e);case RepetitionWithSeparator:return this.visitRepetitionWithSeparator(e);case Repetition:return this.visitRepetition(e);case Alternation:return this.visitAlternation(e);case Terminal:return this.visitTerminal(e);case Rule:return this.visitRule(e);default:throw Error("non exhaustive match")}}visitNonTerminal(e){}visitAlternative(e){}visitOption(e){}visitRepetition(e){}visitRepetitionMandatory(e){}visitRepetitionMandatoryWithSeparator(e){}visitRepetitionWithSeparator(e){}visitAlternation(e){}visitTerminal(e){}visitRule(e){}};function isSequenceProd(e){return e instanceof Alternative||e instanceof Option||e instanceof Repetition||e instanceof RepetitionMandatory||e instanceof RepetitionMandatoryWithSeparator||e instanceof RepetitionWithSeparator||e instanceof Terminal||e instanceof Rule}function isOptionalProd(e,t=[]){let r=e instanceof Option||e instanceof Repetition||e instanceof RepetitionWithSeparator;return!!r||(e instanceof Alternation?some(e.definition,e=>isOptionalProd(e,t)):!(e instanceof NonTerminal&&includes(t,e))&&e instanceof AbstractProduction&&(e instanceof NonTerminal&&t.push(e),every(e.definition,e=>isOptionalProd(e,t))))}function isBranchingProd(e){return e instanceof Alternation}function getProductionDslName(e){if(e instanceof NonTerminal)return"SUBRULE";if(e instanceof Option)return"OPTION";if(e instanceof Alternation)return"OR";if(e instanceof RepetitionMandatory)return"AT_LEAST_ONE";if(e instanceof RepetitionMandatoryWithSeparator)return"AT_LEAST_ONE_SEP";if(e instanceof RepetitionWithSeparator)return"MANY_SEP";if(e instanceof Repetition)return"MANY";else if(e instanceof Terminal)return"CONSUME";else throw Error("non exhaustive match")}let RestWalker=class RestWalker{walk(e,t=[]){forEach(e.definition,(r,i)=>{let a=drop(e.definition,i+1);if(r instanceof NonTerminal)this.walkProdRef(r,a,t);else if(r instanceof Terminal)this.walkTerminal(r,a,t);else if(r instanceof Alternative)this.walkFlat(r,a,t);else if(r instanceof Option)this.walkOption(r,a,t);else if(r instanceof RepetitionMandatory)this.walkAtLeastOne(r,a,t);else if(r instanceof RepetitionMandatoryWithSeparator)this.walkAtLeastOneSep(r,a,t);else if(r instanceof RepetitionWithSeparator)this.walkManySep(r,a,t);else if(r instanceof Repetition)this.walkMany(r,a,t);else if(r instanceof Alternation)this.walkOr(r,a,t);else throw Error("non exhaustive match")})}walkTerminal(e,t,r){}walkProdRef(e,t,r){}walkFlat(e,t,r){let i=t.concat(r);this.walk(e,i)}walkOption(e,t,r){let i=t.concat(r);this.walk(e,i)}walkAtLeastOne(e,t,r){let i=[new Option({definition:e.definition})].concat(t,r);this.walk(e,i)}walkAtLeastOneSep(e,t,r){let i=restForRepetitionWithSeparator(e,t,r);this.walk(e,i)}walkMany(e,t,r){let i=[new Option({definition:e.definition})].concat(t,r);this.walk(e,i)}walkManySep(e,t,r){let i=restForRepetitionWithSeparator(e,t,r);this.walk(e,i)}walkOr(e,t,r){let i=t.concat(r);forEach(e.definition,e=>{let t=new Alternative({definition:[e]});this.walk(t,i)})}};function restForRepetitionWithSeparator(e,t,r){let i=[new Option({definition:[new Terminal({terminalType:e.separator})].concat(e.definition)})],a=i.concat(t,r);return a}function first(e){if(e instanceof NonTerminal)return first(e.referencedRule);if(e instanceof Terminal)return firstForTerminal(e);if(isSequenceProd(e))return firstForSequence(e);if(isBranchingProd(e))return firstForBranching(e);throw Error("non exhaustive match")}function firstForSequence(e){let t,r=[],i=e.definition,a=0,n=i.length>a,s=!0;for(;n&&s;)s=isOptionalProd(t=i[a]),r=r.concat(first(t)),a+=1,n=i.length>a;return uniq(r)}function firstForBranching(e){let t=map(e.definition,e=>first(e));return uniq(flatten(t))}function firstForTerminal(e){return[e.terminalType]}let tw="_~IN~_";let ResyncFollowsWalker=class ResyncFollowsWalker extends RestWalker{constructor(e){super(),this.topProd=e,this.follows={}}startWalking(){return this.walk(this.topProd),this.follows}walkTerminal(e,t,r){}walkProdRef(e,t,r){let i=buildBetweenProdsFollowPrefix(e.referencedRule,e.idx)+this.topProd.name,a=t.concat(r),n=new Alternative({definition:a}),s=first(n);this.follows[i]=s}};function computeAllProdsFollows(e){let t={};return forEach(e,e=>{let r=new ResyncFollowsWalker(e).startWalking();ex(t,r)}),t}function buildBetweenProdsFollowPrefix(e,t){return e.name+t+tw}function cc(e){return e.charCodeAt(0)}function insertToSet(e,t){Array.isArray(e)?e.forEach(function(e){t.push(e)}):t.push(e)}function addFlag(e,t){if(!0===e[t])throw"duplicate flag "+t;e[t],e[t]=!0}function ASSERT_EXISTS(e){if(void 0===e)throw Error("Internal Error - Should never get here!");return!0}function ASSERT_NEVER_REACH_HERE(){throw Error("Internal Error - Should never get here!")}function isCharacter(e){return"Character"===e.type}let tI=[];for(let e=cc("0");e<=cc("9");e++)tI.push(e);let tk=[cc("_")].concat(tI);for(let e=cc("a");e<=cc("z");e++)tk.push(e);for(let e=cc("A");e<=cc("Z");e++)tk.push(e);let t_=[cc(" "),cc("\f"),cc("\n"),cc("\r"),cc("	"),cc("\v"),cc("	"),cc("\xa0"),cc(" "),cc(" "),cc(" "),cc(" "),cc(" "),cc(" "),cc(" "),cc(" "),cc(" "),cc(" "),cc(" "),cc(" "),cc("\u2028"),cc("\u2029"),cc(" "),cc(" "),cc("　"),cc("\uFEFF")],tO=/[0-9a-fA-F]/,tN=/[0-9]/,tL=/[1-9]/;let RegExpParser=class RegExpParser{constructor(){this.idx=0,this.input="",this.groupIdx=0}saveState(){return{idx:this.idx,input:this.input,groupIdx:this.groupIdx}}restoreState(e){this.idx=e.idx,this.input=e.input,this.groupIdx=e.groupIdx}pattern(e){this.idx=0,this.input=e,this.groupIdx=0,this.consumeChar("/");let t=this.disjunction();this.consumeChar("/");let r={type:"Flags",loc:{begin:this.idx,end:e.length},global:!1,ignoreCase:!1,multiLine:!1,unicode:!1,sticky:!1};for(;this.isRegExpFlag();)switch(this.popChar()){case"g":addFlag(r,"global");break;case"i":addFlag(r,"ignoreCase");break;case"m":addFlag(r,"multiLine");break;case"u":addFlag(r,"unicode");break;case"y":addFlag(r,"sticky")}if(this.idx!==this.input.length)throw Error("Redundant input: "+this.input.substring(this.idx));return{type:"Pattern",flags:r,value:t,loc:this.loc(0)}}disjunction(){let e=[],t=this.idx;for(e.push(this.alternative());"|"===this.peekChar();)this.consumeChar("|"),e.push(this.alternative());return{type:"Disjunction",value:e,loc:this.loc(t)}}alternative(){let e=[],t=this.idx;for(;this.isTerm();)e.push(this.term());return{type:"Alternative",value:e,loc:this.loc(t)}}term(){return this.isAssertion()?this.assertion():this.atom()}assertion(){let e=this.idx;switch(this.popChar()){case"^":return{type:"StartAnchor",loc:this.loc(e)};case"$":return{type:"EndAnchor",loc:this.loc(e)};case"\\":switch(this.popChar()){case"b":return{type:"WordBoundary",loc:this.loc(e)};case"B":return{type:"NonWordBoundary",loc:this.loc(e)}}throw Error("Invalid Assertion Escape");case"(":let t;switch(this.consumeChar("?"),this.popChar()){case"=":t="Lookahead";break;case"!":t="NegativeLookahead"}ASSERT_EXISTS(t);let r=this.disjunction();return this.consumeChar(")"),{type:t,value:r,loc:this.loc(e)}}return ASSERT_NEVER_REACH_HERE()}quantifier(e=!1){let t;let r=this.idx;switch(this.popChar()){case"*":t={atLeast:0,atMost:1/0};break;case"+":t={atLeast:1,atMost:1/0};break;case"?":t={atLeast:0,atMost:1};break;case"{":let i=this.integerIncludingZero();switch(this.popChar()){case"}":t={atLeast:i,atMost:i};break;case",":t=this.isDigit()?{atLeast:i,atMost:this.integerIncludingZero()}:{atLeast:i,atMost:1/0},this.consumeChar("}")}if(!0===e&&void 0===t)return;ASSERT_EXISTS(t)}if((!0!==e||void 0!==t)&&ASSERT_EXISTS(t))return"?"===this.peekChar(0)?(this.consumeChar("?"),t.greedy=!1):t.greedy=!0,t.type="Quantifier",t.loc=this.loc(r),t}atom(){let e;let t=this.idx;switch(this.peekChar()){case".":e=this.dotAll();break;case"\\":e=this.atomEscape();break;case"[":e=this.characterClass();break;case"(":e=this.group()}if(void 0===e&&this.isPatternCharacter()&&(e=this.patternCharacter()),ASSERT_EXISTS(e))return e.loc=this.loc(t),this.isQuantifier()&&(e.quantifier=this.quantifier()),e}dotAll(){return this.consumeChar("."),{type:"Set",complement:!0,value:[cc("\n"),cc("\r"),cc("\u2028"),cc("\u2029")]}}atomEscape(){switch(this.consumeChar("\\"),this.peekChar()){case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":return this.decimalEscapeAtom();case"d":case"D":case"s":case"S":case"w":case"W":return this.characterClassEscape();case"f":case"n":case"r":case"t":case"v":return this.controlEscapeAtom();case"c":return this.controlLetterEscapeAtom();case"0":return this.nulCharacterAtom();case"x":return this.hexEscapeSequenceAtom();case"u":return this.regExpUnicodeEscapeSequenceAtom();default:return this.identityEscapeAtom()}}decimalEscapeAtom(){let e=this.positiveInteger();return{type:"GroupBackReference",value:e}}characterClassEscape(){let e;let t=!1;switch(this.popChar()){case"d":e=tI;break;case"D":e=tI,t=!0;break;case"s":e=t_;break;case"S":e=t_,t=!0;break;case"w":e=tk;break;case"W":e=tk,t=!0}if(ASSERT_EXISTS(e))return{type:"Set",value:e,complement:t}}controlEscapeAtom(){let e;switch(this.popChar()){case"f":e=cc("\f");break;case"n":e=cc("\n");break;case"r":e=cc("\r");break;case"t":e=cc("	");break;case"v":e=cc("\v")}if(ASSERT_EXISTS(e))return{type:"Character",value:e}}controlLetterEscapeAtom(){this.consumeChar("c");let e=this.popChar();if(!1===/[a-zA-Z]/.test(e))throw Error("Invalid ");let t=e.toUpperCase().charCodeAt(0)-64;return{type:"Character",value:t}}nulCharacterAtom(){return this.consumeChar("0"),{type:"Character",value:cc("\x00")}}hexEscapeSequenceAtom(){return this.consumeChar("x"),this.parseHexDigits(2)}regExpUnicodeEscapeSequenceAtom(){return this.consumeChar("u"),this.parseHexDigits(4)}identityEscapeAtom(){let e=this.popChar();return{type:"Character",value:cc(e)}}classPatternCharacterAtom(){switch(this.peekChar()){case"\n":case"\r":case"\u2028":case"\u2029":case"\\":case"]":throw Error("TBD");default:let e=this.popChar();return{type:"Character",value:cc(e)}}}characterClass(){let e=[],t=!1;for(this.consumeChar("["),"^"===this.peekChar(0)&&(this.consumeChar("^"),t=!0);this.isClassAtom();){let t=this.classAtom();if(t.type,isCharacter(t)&&this.isRangeDash()){this.consumeChar("-");let r=this.classAtom();if(r.type,isCharacter(r)){if(r.value<t.value)throw Error("Range out of order in character class");e.push({from:t.value,to:r.value})}else insertToSet(t.value,e),e.push(cc("-")),insertToSet(r.value,e)}else insertToSet(t.value,e)}return this.consumeChar("]"),{type:"Set",complement:t,value:e}}classAtom(){switch(this.peekChar()){case"]":case"\n":case"\r":case"\u2028":case"\u2029":throw Error("TBD");case"\\":return this.classEscape();default:return this.classPatternCharacterAtom()}}classEscape(){switch(this.consumeChar("\\"),this.peekChar()){case"b":return this.consumeChar("b"),{type:"Character",value:cc("\b")};case"d":case"D":case"s":case"S":case"w":case"W":return this.characterClassEscape();case"f":case"n":case"r":case"t":case"v":return this.controlEscapeAtom();case"c":return this.controlLetterEscapeAtom();case"0":return this.nulCharacterAtom();case"x":return this.hexEscapeSequenceAtom();case"u":return this.regExpUnicodeEscapeSequenceAtom();default:return this.identityEscapeAtom()}}group(){let e=!0;(this.consumeChar("("),"?"===this.peekChar(0))?(this.consumeChar("?"),this.consumeChar(":"),e=!1):this.groupIdx++;let t=this.disjunction();this.consumeChar(")");let r={type:"Group",capturing:e,value:t};return e&&(r.idx=this.groupIdx),r}positiveInteger(){let e=this.popChar();if(!1===tL.test(e))throw Error("Expecting a positive integer");for(;tN.test(this.peekChar(0));)e+=this.popChar();return parseInt(e,10)}integerIncludingZero(){let e=this.popChar();if(!1===tN.test(e))throw Error("Expecting an integer");for(;tN.test(this.peekChar(0));)e+=this.popChar();return parseInt(e,10)}patternCharacter(){let e=this.popChar();switch(e){case"\n":case"\r":case"\u2028":case"\u2029":case"^":case"$":case"\\":case".":case"*":case"+":case"?":case"(":case")":case"[":case"|":throw Error("TBD");default:return{type:"Character",value:cc(e)}}}isRegExpFlag(){switch(this.peekChar(0)){case"g":case"i":case"m":case"u":case"y":return!0;default:return!1}}isRangeDash(){return"-"===this.peekChar()&&this.isClassAtom(1)}isDigit(){return tN.test(this.peekChar(0))}isClassAtom(e=0){switch(this.peekChar(e)){case"]":case"\n":case"\r":case"\u2028":case"\u2029":return!1;default:return!0}}isTerm(){return this.isAtom()||this.isAssertion()}isAtom(){if(this.isPatternCharacter())return!0;switch(this.peekChar(0)){case".":case"\\":case"[":case"(":return!0;default:return!1}}isAssertion(){switch(this.peekChar(0)){case"^":case"$":return!0;case"\\":switch(this.peekChar(1)){case"b":case"B":return!0;default:return!1}case"(":return"?"===this.peekChar(1)&&("="===this.peekChar(2)||"!"===this.peekChar(2));default:return!1}}isQuantifier(){let e=this.saveState();try{return void 0!==this.quantifier(!0)}catch(e){return!1}finally{this.restoreState(e)}}isPatternCharacter(){switch(this.peekChar()){case"^":case"$":case"\\":case".":case"*":case"+":case"?":case"(":case")":case"[":case"|":case"/":case"\n":case"\r":case"\u2028":case"\u2029":return!1;default:return!0}}parseHexDigits(e){let t="";for(let r=0;r<e;r++){let e=this.popChar();if(!1===tO.test(e))throw Error("Expecting a HexDecimal digits");t+=e}let r=parseInt(t,16);return{type:"Character",value:r}}peekChar(e=0){return this.input[this.idx+e]}popChar(){let e=this.peekChar(0);return this.consumeChar(void 0),e}consumeChar(e){if(void 0!==e&&this.input[this.idx]!==e)throw Error("Expected: '"+e+"' but found: '"+this.input[this.idx]+"' at offset: "+this.idx);if(this.idx>=this.input.length)throw Error("Unexpected end of input");this.idx++}loc(e){return{begin:e,end:this.idx}}};let BaseRegExpVisitor=class BaseRegExpVisitor{visitChildren(e){for(let t in e){let r=e[t];e.hasOwnProperty(t)&&(void 0!==r.type?this.visit(r):Array.isArray(r)&&r.forEach(e=>{this.visit(e)},this))}}visit(e){switch(e.type){case"Pattern":this.visitPattern(e);break;case"Flags":this.visitFlags(e);break;case"Disjunction":this.visitDisjunction(e);break;case"Alternative":this.visitAlternative(e);break;case"StartAnchor":this.visitStartAnchor(e);break;case"EndAnchor":this.visitEndAnchor(e);break;case"WordBoundary":this.visitWordBoundary(e);break;case"NonWordBoundary":this.visitNonWordBoundary(e);break;case"Lookahead":this.visitLookahead(e);break;case"NegativeLookahead":this.visitNegativeLookahead(e);break;case"Character":this.visitCharacter(e);break;case"Set":this.visitSet(e);break;case"Group":this.visitGroup(e);break;case"GroupBackReference":this.visitGroupBackReference(e);break;case"Quantifier":this.visitQuantifier(e)}this.visitChildren(e)}visitPattern(e){}visitFlags(e){}visitDisjunction(e){}visitAlternative(e){}visitStartAnchor(e){}visitEndAnchor(e){}visitWordBoundary(e){}visitNonWordBoundary(e){}visitLookahead(e){}visitNegativeLookahead(e){}visitCharacter(e){}visitSet(e){}visitGroup(e){}visitGroupBackReference(e){}visitQuantifier(e){}};let tF={},tD=new RegExpParser;function getRegExpAst(e){let t=e.toString();if(tF.hasOwnProperty(t))return tF[t];{let e=tD.pattern(t);return tF[t]=e,e}}function clearRegExpParserCache(){tF={}}let tU="Complement Sets are not supported for first char optimization",tB='Unable to use "first char" lexer optimizations:\n';function getOptimizedStartCodesIndices(e,t=!1){try{let t=getRegExpAst(e),r=firstCharOptimizedIndices(t.value,{},t.flags.ignoreCase);return r}catch(r){if(r.message===tU)t&&PRINT_WARNING(`${tB}	Unable to optimize: < ${e.toString()} >
	Complement Sets cannot be automatically optimized.
	This will disable the lexer's first char optimizations.
	See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#COMPLEMENT for details.`);else{let r="";t&&(r="\n	This will disable the lexer's first char optimizations.\n	See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#REGEXP_PARSING for details."),PRINT_ERROR(`${tB}
	Failed parsing: < ${e.toString()} >
	Using the @chevrotain/regexp-to-ast library
	Please open an issue at: https://github.com/chevrotain/chevrotain/issues`+r)}}return[]}function firstCharOptimizedIndices(e,t,r){switch(e.type){case"Disjunction":for(let i=0;i<e.value.length;i++)firstCharOptimizedIndices(e.value[i],t,r);break;case"Alternative":let i=e.value;for(let e=0;e<i.length;e++){let a=i[e];switch(a.type){case"EndAnchor":case"GroupBackReference":case"Lookahead":case"NegativeLookahead":case"StartAnchor":case"WordBoundary":case"NonWordBoundary":continue}switch(a.type){case"Character":addOptimizedIdxToResult(a.value,t,r);break;case"Set":if(!0===a.complement)throw Error(tU);forEach(a.value,e=>{if("number"==typeof e)addOptimizedIdxToResult(e,t,r);else if(!0===r)for(let i=e.from;i<=e.to;i++)addOptimizedIdxToResult(i,t,r);else{for(let i=e.from;i<=e.to&&i<tX;i++)addOptimizedIdxToResult(i,t,r);if(e.to>=tX){let r=e.from>=tX?e.from:tX,i=e.to,a=charCodeToOptimizedIndex(r),n=charCodeToOptimizedIndex(i);for(let e=a;e<=n;e++)t[e]=e}}});break;case"Group":firstCharOptimizedIndices(a.value,t,r);break;default:throw Error("Non Exhaustive Match")}let n=void 0!==a.quantifier&&0===a.quantifier.atLeast;if("Group"===a.type&&!1===isWholeOptional(a)||"Group"!==a.type&&!1===n)break}break;default:throw Error("non exhaustive match!")}return values(t)}function addOptimizedIdxToResult(e,t,r){let i=charCodeToOptimizedIndex(e);t[i]=i,!0===r&&handleIgnoreCase(e,t)}function handleIgnoreCase(e,t){let r=String.fromCharCode(e),i=r.toUpperCase();if(i!==r){let e=charCodeToOptimizedIndex(i.charCodeAt(0));t[e]=e}else{let e=r.toLowerCase();if(e!==r){let r=charCodeToOptimizedIndex(e.charCodeAt(0));t[r]=r}}}function findCode(e,t){return tx(e.value,e=>"number"==typeof e?includes(t,e):void 0!==tx(t,t=>e.from<=t&&t<=e.to))}function isWholeOptional(e){let t=e.quantifier;return!!t&&0===t.atLeast||!!e.value&&(E(e.value)?every(e.value,isWholeOptional):isWholeOptional(e.value))}let CharCodeFinder=class CharCodeFinder extends BaseRegExpVisitor{constructor(e){super(),this.targetCharCodes=e,this.found=!1}visitChildren(e){if(!0!==this.found){switch(e.type){case"Lookahead":this.visitLookahead(e);return;case"NegativeLookahead":this.visitNegativeLookahead(e);return}super.visitChildren(e)}}visitCharacter(e){includes(this.targetCharCodes,e.value)&&(this.found=!0)}visitSet(e){e.complement?void 0===findCode(e,this.targetCharCodes)&&(this.found=!0):void 0!==findCode(e,this.targetCharCodes)&&(this.found=!0)}};function canMatchCharCode(e,t){if(!(t instanceof RegExp))return void 0!==tx(t,t=>includes(e,t.charCodeAt(0)));{let r=getRegExpAst(t),i=new CharCodeFinder(e);return i.visit(r),i.found}}let tV="PATTERN",tG="defaultMode",tz="modes",tH="boolean"==typeof RegExp("(?:)").sticky;function analyzeTokenTypes(e,t){let r,i,a,n,s,o,l,c,u,h,p,d;t=tg(t,{useSticky:tH,debug:!1,safeMode:!1,positionTracking:"full",lineTerminatorCharacters:["\r","\n"],tracer:(e,t)=>t()});let f=t.tracer;f("initCharCodeToOptimizedIndexMap",()=>{initCharCodeToOptimizedIndexMap()}),f("Reject Lexer.NA",()=>{r=reject(e,e=>e[tV]===Lexer2.NA)});let m=!1;f("Transform Patterns",()=>{m=!1,i=map(r,e=>{let r=e[tV];if(tM(r)){let e=r.source;return 1!==e.length||"^"===e||"$"===e||"."===e||r.ignoreCase?2!==e.length||"\\"!==e[0]||includes(["d","D","s","S","t","r","n","t","0","c","b","B","f","v","w","W"],e[1])?t.useSticky?addStickyFlag(r):addStartOfInput(r):e[1]:e}if(isFunction(r))return m=!0,{exec:r};if("object"==typeof r)return m=!0,r;if("string"==typeof r){if(1===r.length)return r;{let e=r.replace(/[\\^$.*+?()[\]{}|]/g,"\\$&"),i=new RegExp(e);return t.useSticky?addStickyFlag(i):addStartOfInput(i)}}throw Error("non exhaustive match")})}),f("misc mapping",()=>{a=map(r,e=>e.tokenTypeIdx),n=map(r,e=>{let t=e.GROUP;if(t!==Lexer2.SKIPPED){if(isString(t))return t;if(isUndefined(t))return!1;throw Error("non exhaustive match")}}),s=map(r,e=>{let t=e.LONGER_ALT;if(t){let e=E(t)?map(t,e=>indexOf(r,e)):[indexOf(r,t)];return e}}),o=map(r,e=>e.PUSH_MODE),l=map(r,e=>has(e,"POP_MODE"))}),f("Line Terminator Handling",()=>{let e=getCharCodes(t.lineTerminatorCharacters);c=map(r,e=>!1),"onlyOffset"!==t.positionTracking&&(c=map(r,t=>has(t,"LINE_BREAKS")?!!t.LINE_BREAKS:!1===checkLineBreaksIssues(t,e)&&canMatchCharCode(e,t.PATTERN)))}),f("Misc Mapping #2",()=>{u=map(r,isCustomPattern),h=map(i,isShortPattern),p=reduce(r,(e,t)=>{let r=t.GROUP;return isString(r)&&r!==Lexer2.SKIPPED&&(e[r]=[]),e},{}),d=map(i,(e,t)=>({pattern:i[t],longerAlt:s[t],canLineTerminator:c[t],isCustom:u[t],short:h[t],group:n[t],push:o[t],pop:l[t],tokenTypeIdx:a[t],tokenType:r[t]}))});let g=!0,v=[];return t.safeMode||f("First Char Optimization",()=>{v=reduce(r,(e,r,i)=>{if("string"==typeof r.PATTERN){let t=r.PATTERN.charCodeAt(0),a=charCodeToOptimizedIndex(t);addToMapOfArrays(e,a,d[i])}else if(E(r.START_CHARS_HINT)){let t;forEach(r.START_CHARS_HINT,r=>{let a="string"==typeof r?r.charCodeAt(0):r,n=charCodeToOptimizedIndex(a);t!==n&&(t=n,addToMapOfArrays(e,n,d[i]))})}else if(tM(r.PATTERN)){if(r.PATTERN.unicode)g=!1,t.ensureOptimizations&&PRINT_ERROR(`${tB}	Unable to analyze < ${r.PATTERN.toString()} > pattern.
	The regexp unicode flag is not currently supported by the regexp-to-ast library.
	This will disable the lexer's first char optimizations.
	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#UNICODE_OPTIMIZE`);else{let a=getOptimizedStartCodesIndices(r.PATTERN,t.ensureOptimizations);isEmpty(a)&&(g=!1),forEach(a,t=>{addToMapOfArrays(e,t,d[i])})}}else t.ensureOptimizations&&PRINT_ERROR(`${tB}	TokenType: <${r.name}> is using a custom token pattern without providing <start_chars_hint> parameter.
	This will disable the lexer's first char optimizations.
	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#CUSTOM_OPTIMIZE`),g=!1;return e},[])}),{emptyGroups:p,patternIdxToConfig:d,charCodeToPatternIdxToConfig:v,hasCustom:m,canBeOptimized:g}}function validatePatterns(e,t){let r=[],i=findMissingPatterns(e);r=r.concat(i.errors);let a=findInvalidPatterns(i.valid),n=a.valid;return(r=(r=(r=(r=r.concat(a.errors)).concat(validateRegExpPattern(n))).concat(findInvalidGroupType(n))).concat(findModesThatDoNotExist(n,t))).concat(findUnreachablePatterns(n))}function validateRegExpPattern(e){let t=[],r=filter(e,e=>tM(e[tV]));return(t=(t=(t=(t=t.concat(findEndOfInputAnchor(r))).concat(findStartOfInputAnchor(r))).concat(findUnsupportedFlags(r))).concat(findDuplicatePatterns(r))).concat(findEmptyMatchRegExps(r))}function findMissingPatterns(e){let t=filter(e,e=>!has(e,tV)),r=map(t,e=>({message:"Token Type: ->"+e.name+"<- missing static 'PATTERN' property",type:c.MISSING_PATTERN,tokenTypes:[e]})),i=tv(e,t);return{errors:r,valid:i}}function findInvalidPatterns(e){let t=filter(e,e=>{let t=e[tV];return!tM(t)&&!isFunction(t)&&!has(t,"exec")&&!isString(t)}),r=map(t,e=>({message:"Token Type: ->"+e.name+"<- static 'PATTERN' can only be a RegExp, a Function matching the {CustomPatternMatcherFunc} type or an Object matching the {ICustomPattern} interface.",type:c.INVALID_PATTERN,tokenTypes:[e]})),i=tv(e,t);return{errors:r,valid:i}}let tj=/[^\\][$]/;function findEndOfInputAnchor(e){let EndAnchorFinder=class EndAnchorFinder extends BaseRegExpVisitor{constructor(){super(...arguments),this.found=!1}visitEndAnchor(e){this.found=!0}};let t=filter(e,e=>{let t=e.PATTERN;try{let e=getRegExpAst(t),r=new EndAnchorFinder;return r.visit(e),r.found}catch(e){return tj.test(t.source)}}),r=map(t,e=>({message:"Unexpected RegExp Anchor Error:\n	Token Type: ->"+e.name+"<- static 'PATTERN' cannot contain end of input anchor '$'\n	See chevrotain.io/docs/guide/resolving_lexer_errors.html#ANCHORS	for details.",type:c.EOI_ANCHOR_FOUND,tokenTypes:[e]}));return r}function findEmptyMatchRegExps(e){let t=filter(e,e=>{let t=e.PATTERN;return t.test("")}),r=map(t,e=>({message:"Token Type: ->"+e.name+"<- static 'PATTERN' must not match an empty string",type:c.EMPTY_MATCH_PATTERN,tokenTypes:[e]}));return r}let tW=/[^\\[][\^]|^\^/;function findStartOfInputAnchor(e){let StartAnchorFinder=class StartAnchorFinder extends BaseRegExpVisitor{constructor(){super(...arguments),this.found=!1}visitStartAnchor(e){this.found=!0}};let t=filter(e,e=>{let t=e.PATTERN;try{let e=getRegExpAst(t),r=new StartAnchorFinder;return r.visit(e),r.found}catch(e){return tW.test(t.source)}}),r=map(t,e=>({message:"Unexpected RegExp Anchor Error:\n	Token Type: ->"+e.name+"<- static 'PATTERN' cannot contain start of input anchor '^'\n	See https://chevrotain.io/docs/guide/resolving_lexer_errors.html#ANCHORS	for details.",type:c.SOI_ANCHOR_FOUND,tokenTypes:[e]}));return r}function findUnsupportedFlags(e){let t=filter(e,e=>{let t=e[tV];return t instanceof RegExp&&(t.multiline||t.global)}),r=map(t,e=>({message:"Token Type: ->"+e.name+"<- static 'PATTERN' may NOT contain global('g') or multiline('m')",type:c.UNSUPPORTED_FLAGS_FOUND,tokenTypes:[e]}));return r}function findDuplicatePatterns(e){let t=[],r=map(e,r=>reduce(e,(e,i)=>(r.PATTERN.source!==i.PATTERN.source||includes(t,i)||i.PATTERN===Lexer2.NA||(t.push(i),e.push(i)),e),[]));r=compact(r);let i=filter(r,e=>e.length>1),a=map(i,e=>{let t=map(e,e=>e.name),r=head(e).PATTERN;return{message:`The same RegExp pattern ->${r}<-has been used in all of the following Token Types: ${t.join(", ")} <-`,type:c.DUPLICATE_PATTERNS_FOUND,tokenTypes:e}});return a}function findInvalidGroupType(e){let t=filter(e,e=>{if(!has(e,"GROUP"))return!1;let t=e.GROUP;return t!==Lexer2.SKIPPED&&t!==Lexer2.NA&&!isString(t)}),r=map(t,e=>({message:"Token Type: ->"+e.name+"<- static 'GROUP' can only be Lexer.SKIPPED/Lexer.NA/A String",type:c.INVALID_GROUP_TYPE_FOUND,tokenTypes:[e]}));return r}function findModesThatDoNotExist(e,t){let r=filter(e,e=>void 0!==e.PUSH_MODE&&!includes(t,e.PUSH_MODE)),i=map(r,e=>{let t=`Token Type: ->${e.name}<- static 'PUSH_MODE' value cannot refer to a Lexer Mode ->${e.PUSH_MODE}<-which does not exist`;return{message:t,type:c.PUSH_MODE_DOES_NOT_EXIST,tokenTypes:[e]}});return i}function findUnreachablePatterns(e){let t=[],r=reduce(e,(e,t,r)=>{let i=t.PATTERN;return i===Lexer2.NA||(isString(i)?e.push({str:i,idx:r,tokenType:t}):tM(i)&&noMetaChar(i)&&e.push({str:i.source,idx:r,tokenType:t})),e},[]);return forEach(e,(e,i)=>{forEach(r,({str:r,idx:a,tokenType:n})=>{if(i<a&&testTokenType(r,e.PATTERN)){let r=`Token: ->${n.name}<- can never be matched.
Because it appears AFTER the Token Type ->${e.name}<-in the lexer's definition.
See https://chevrotain.io/docs/guide/resolving_lexer_errors.html#UNREACHABLE`;t.push({message:r,type:c.UNREACHABLE_PATTERN,tokenTypes:[e,n]})}})}),t}function testTokenType(e,t){if(tM(t)){let r=t.exec(e);return null!==r&&0===r.index}if(isFunction(t))return t(e,0,[],{});if(has(t,"exec"))return t.exec(e,0,[],{});if("string"==typeof t)return t===e;throw Error("non exhaustive match")}function noMetaChar(e){return void 0===tx([".","\\","[","]","|","^","$","(",")","?","*","+","{"],t=>-1!==e.source.indexOf(t))}function addStartOfInput(e){let t=e.ignoreCase?"i":"";return RegExp(`^(?:${e.source})`,t)}function addStickyFlag(e){let t=e.ignoreCase?"iy":"y";return RegExp(`${e.source}`,t)}function performRuntimeChecks(e,t,r){let i=[];return has(e,tG)||i.push({message:"A MultiMode Lexer cannot be initialized without a <"+tG+"> property in its definition\n",type:c.MULTI_MODE_LEXER_WITHOUT_DEFAULT_MODE}),has(e,tz)||i.push({message:"A MultiMode Lexer cannot be initialized without a <"+tz+"> property in its definition\n",type:c.MULTI_MODE_LEXER_WITHOUT_MODES_PROPERTY}),has(e,tz)&&has(e,tG)&&!has(e.modes,e.defaultMode)&&i.push({message:`A MultiMode Lexer cannot be initialized with a ${tG}: <${e.defaultMode}>which does not exist
`,type:c.MULTI_MODE_LEXER_DEFAULT_MODE_VALUE_DOES_NOT_EXIST}),has(e,tz)&&forEach(e.modes,(e,t)=>{forEach(e,(r,a)=>{if(isUndefined(r))i.push({message:`A Lexer cannot be initialized using an undefined Token Type. Mode:<${t}> at index: <${a}>
`,type:c.LEXER_DEFINITION_CANNOT_CONTAIN_UNDEFINED});else if(has(r,"LONGER_ALT")){let a=E(r.LONGER_ALT)?r.LONGER_ALT:[r.LONGER_ALT];forEach(a,a=>{isUndefined(a)||includes(e,a)||i.push({message:`A MultiMode Lexer cannot be initialized with a longer_alt <${a.name}> on token <${r.name}> outside of mode <${t}>
`,type:c.MULTI_MODE_LEXER_LONGER_ALT_NOT_IN_CURRENT_MODE})})}})}),i}function performWarningRuntimeChecks(e,t,r){let i=[],a=!1,n=compact(flatten(values(e.modes))),s=reject(n,e=>e[tV]===Lexer2.NA),o=getCharCodes(r);return t&&forEach(s,e=>{let t=checkLineBreaksIssues(e,o);if(!1!==t){let r=buildLineBreakIssueMessage(e,t),a={message:r,type:t.issue,tokenType:e};i.push(a)}else has(e,"LINE_BREAKS")?!0===e.LINE_BREAKS&&(a=!0):canMatchCharCode(o,e.PATTERN)&&(a=!0)}),t&&!a&&i.push({message:"Warning: No LINE_BREAKS Found.\n	This Lexer has been defined to track line and column information,\n	But none of the Token Types can be identified as matching a line terminator.\n	See https://chevrotain.io/docs/guide/resolving_lexer_errors.html#LINE_BREAKS \n	for details.",type:c.NO_LINE_BREAKS_FLAGS}),i}function cloneEmptyGroups(e){let t={},r=keys(e);return forEach(r,r=>{let i=e[r];if(E(i))t[r]=[];else throw Error("non exhaustive match")}),t}function isCustomPattern(e){let t=e.PATTERN;if(tM(t))return!1;if(isFunction(t)||has(t,"exec"))return!0;if(isString(t))return!1;throw Error("non exhaustive match")}function isShortPattern(e){return!!isString(e)&&1===e.length&&e.charCodeAt(0)}let tK={test:function(e){let t=e.length;for(let r=this.lastIndex;r<t;r++){let t=e.charCodeAt(r);if(10===t)return this.lastIndex=r+1,!0;if(13===t)return 10===e.charCodeAt(r+1)?this.lastIndex=r+2:this.lastIndex=r+1,!0}return!1},lastIndex:0};function checkLineBreaksIssues(e,t){if(has(e,"LINE_BREAKS"))return!1;if(tM(e.PATTERN)){try{canMatchCharCode(t,e.PATTERN)}catch(e){return{issue:c.IDENTIFY_TERMINATOR,errMsg:e.message}}return!1}if(isString(e.PATTERN))return!1;if(isCustomPattern(e))return{issue:c.CUSTOM_LINE_BREAK};throw Error("non exhaustive match")}function buildLineBreakIssueMessage(e,t){if(t.issue===c.IDENTIFY_TERMINATOR)return`Warning: unable to identify line terminator usage in pattern.
	The problem is in the <${e.name}> Token Type
	 Root cause: ${t.errMsg}.
	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#IDENTIFY_TERMINATOR`;if(t.issue===c.CUSTOM_LINE_BREAK)return`Warning: A Custom Token Pattern should specify the <line_breaks> option.
	The problem is in the <${e.name}> Token Type
	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#CUSTOM_LINE_BREAK`;throw Error("non exhaustive match")}function getCharCodes(e){let t=map(e,e=>isString(e)?e.charCodeAt(0):e);return t}function addToMapOfArrays(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}let tX=256,tq=[];function charCodeToOptimizedIndex(e){return e<tX?e:tq[e]}function initCharCodeToOptimizedIndexMap(){if(isEmpty(tq)){tq=Array(65536);for(let e=0;e<65536;e++)tq[e]=e>255?255+~~(e/255):e}}function tokenStructuredMatcher(e,t){let r=e.tokenTypeIdx;return r===t.tokenTypeIdx||!0===t.isParent&&!0===t.categoryMatchesMap[r]}function tokenStructuredMatcherNoCategories(e,t){return e.tokenTypeIdx===t.tokenTypeIdx}let tY=1,tZ={};function augmentTokenTypes(e){let t=expandCategories(e);assignTokenDefaultProps(t),assignCategoriesMapProp(t),assignCategoriesTokensProp(t),forEach(t,e=>{e.isParent=e.categoryMatches.length>0})}function expandCategories(e){let t=clone2(e),r=e,i=!0;for(;i;){r=compact(flatten(map(r,e=>e.CATEGORIES)));let e=tv(r,t);t=t.concat(e),isEmpty(e)?i=!1:r=e}return t}function assignTokenDefaultProps(e){forEach(e,e=>{hasShortKeyProperty(e)||(tZ[tY]=e,e.tokenTypeIdx=tY++),hasCategoriesProperty(e)&&!E(e.CATEGORIES)&&(e.CATEGORIES=[e.CATEGORIES]),hasCategoriesProperty(e)||(e.CATEGORIES=[]),hasExtendingTokensTypesProperty(e)||(e.categoryMatches=[]),hasExtendingTokensTypesMapProperty(e)||(e.categoryMatchesMap={})})}function assignCategoriesTokensProp(e){forEach(e,e=>{e.categoryMatches=[],forEach(e.categoryMatchesMap,(t,r)=>{e.categoryMatches.push(tZ[r].tokenTypeIdx)})})}function assignCategoriesMapProp(e){forEach(e,e=>{singleAssignCategoriesToksMap([],e)})}function singleAssignCategoriesToksMap(e,t){forEach(e,e=>{t.categoryMatchesMap[e.tokenTypeIdx]=!0}),forEach(t.CATEGORIES,r=>{let i=e.concat(t);includes(i,r)||singleAssignCategoriesToksMap(i,r)})}function hasShortKeyProperty(e){return has(e,"tokenTypeIdx")}function hasCategoriesProperty(e){return has(e,"CATEGORIES")}function hasExtendingTokensTypesProperty(e){return has(e,"categoryMatches")}function hasExtendingTokensTypesMapProperty(e){return has(e,"categoryMatchesMap")}function isTokenType(e){return has(e,"tokenTypeIdx")}(n=c||(c={}))[n.MISSING_PATTERN=0]="MISSING_PATTERN",n[n.INVALID_PATTERN=1]="INVALID_PATTERN",n[n.EOI_ANCHOR_FOUND=2]="EOI_ANCHOR_FOUND",n[n.UNSUPPORTED_FLAGS_FOUND=3]="UNSUPPORTED_FLAGS_FOUND",n[n.DUPLICATE_PATTERNS_FOUND=4]="DUPLICATE_PATTERNS_FOUND",n[n.INVALID_GROUP_TYPE_FOUND=5]="INVALID_GROUP_TYPE_FOUND",n[n.PUSH_MODE_DOES_NOT_EXIST=6]="PUSH_MODE_DOES_NOT_EXIST",n[n.MULTI_MODE_LEXER_WITHOUT_DEFAULT_MODE=7]="MULTI_MODE_LEXER_WITHOUT_DEFAULT_MODE",n[n.MULTI_MODE_LEXER_WITHOUT_MODES_PROPERTY=8]="MULTI_MODE_LEXER_WITHOUT_MODES_PROPERTY",n[n.MULTI_MODE_LEXER_DEFAULT_MODE_VALUE_DOES_NOT_EXIST=9]="MULTI_MODE_LEXER_DEFAULT_MODE_VALUE_DOES_NOT_EXIST",n[n.LEXER_DEFINITION_CANNOT_CONTAIN_UNDEFINED=10]="LEXER_DEFINITION_CANNOT_CONTAIN_UNDEFINED",n[n.SOI_ANCHOR_FOUND=11]="SOI_ANCHOR_FOUND",n[n.EMPTY_MATCH_PATTERN=12]="EMPTY_MATCH_PATTERN",n[n.NO_LINE_BREAKS_FLAGS=13]="NO_LINE_BREAKS_FLAGS",n[n.UNREACHABLE_PATTERN=14]="UNREACHABLE_PATTERN",n[n.IDENTIFY_TERMINATOR=15]="IDENTIFY_TERMINATOR",n[n.CUSTOM_LINE_BREAK=16]="CUSTOM_LINE_BREAK",n[n.MULTI_MODE_LEXER_LONGER_ALT_NOT_IN_CURRENT_MODE=17]="MULTI_MODE_LEXER_LONGER_ALT_NOT_IN_CURRENT_MODE";let t$={deferDefinitionErrorsHandling:!1,positionTracking:"full",lineTerminatorsPattern:/\n|\r\n?/g,lineTerminatorCharacters:["\n","\r"],ensureOptimizations:!1,safeMode:!1,errorMessageProvider:{buildUnableToPopLexerModeMessage:e=>`Unable to pop Lexer Mode after encountering Token ->${e.image}<- The Mode Stack is empty`,buildUnexpectedCharactersMessage:(e,t,r,i,a)=>`unexpected character: ->${e.charAt(t)}<- at offset: ${t}, skipped ${r} characters.`},traceInitPerf:!1,skipValidations:!1,recoveryEnabled:!0};Object.freeze(t$);let Lexer2=class Lexer2{constructor(e,t=t$){if(this.lexerDefinition=e,this.lexerDefinitionErrors=[],this.lexerDefinitionWarning=[],this.patternIdxToConfig={},this.charCodeToPatternIdxToConfig={},this.modes=[],this.emptyGroups={},this.trackStartLines=!0,this.trackEndLines=!0,this.hasCustom=!1,this.canModeBeOptimized={},this.TRACE_INIT=(e,t)=>{if(!0!==this.traceInitPerf)return t();{this.traceInitIndent++;let r=Array(this.traceInitIndent+1).join("	");this.traceInitIndent<this.traceInitMaxIdent&&console.log(`${r}--> <${e}>`);let{time:i,value:a}=timer(t),n=i>10?console.warn:console.log;return this.traceInitIndent<this.traceInitMaxIdent&&n(`${r}<-- <${e}> time: ${i}ms`),this.traceInitIndent--,a}},"boolean"==typeof t)throw Error("The second argument to the Lexer constructor is now an ILexerConfig Object.\na boolean 2nd argument is no longer supported");this.config=ex({},t$,t);let r=this.config.traceInitPerf;!0===r?(this.traceInitMaxIdent=1/0,this.traceInitPerf=!0):"number"==typeof r&&(this.traceInitMaxIdent=r,this.traceInitPerf=!0),this.traceInitIndent=-1,this.TRACE_INIT("Lexer Constructor",()=>{let r;let i=!0;this.TRACE_INIT("Lexer Config handling",()=>{if(this.config.lineTerminatorsPattern===t$.lineTerminatorsPattern)this.config.lineTerminatorsPattern=tK;else if(this.config.lineTerminatorCharacters===t$.lineTerminatorCharacters)throw Error("Error: Missing <lineTerminatorCharacters> property on the Lexer config.\n	For details See: https://chevrotain.io/docs/guide/resolving_lexer_errors.html#MISSING_LINE_TERM_CHARS");if(t.safeMode&&t.ensureOptimizations)throw Error('"safeMode" and "ensureOptimizations" flags are mutually exclusive.');this.trackStartLines=/full|onlyStart/i.test(this.config.positionTracking),this.trackEndLines=/full/i.test(this.config.positionTracking),E(e)?r={modes:{defaultMode:clone2(e)},defaultMode:tG}:(i=!1,r=clone2(e))}),!1===this.config.skipValidations&&(this.TRACE_INIT("performRuntimeChecks",()=>{this.lexerDefinitionErrors=this.lexerDefinitionErrors.concat(performRuntimeChecks(r,this.trackStartLines,this.config.lineTerminatorCharacters))}),this.TRACE_INIT("performWarningRuntimeChecks",()=>{this.lexerDefinitionWarning=this.lexerDefinitionWarning.concat(performWarningRuntimeChecks(r,this.trackStartLines,this.config.lineTerminatorCharacters))})),r.modes=r.modes?r.modes:{},forEach(r.modes,(e,t)=>{r.modes[t]=reject(e,e=>isUndefined(e))});let a=keys(r.modes);if(forEach(r.modes,(e,r)=>{this.TRACE_INIT(`Mode: <${r}> processing`,()=>{if(this.modes.push(r),!1===this.config.skipValidations&&this.TRACE_INIT("validatePatterns",()=>{this.lexerDefinitionErrors=this.lexerDefinitionErrors.concat(validatePatterns(e,a))}),isEmpty(this.lexerDefinitionErrors)){let i;augmentTokenTypes(e),this.TRACE_INIT("analyzeTokenTypes",()=>{i=analyzeTokenTypes(e,{lineTerminatorCharacters:this.config.lineTerminatorCharacters,positionTracking:t.positionTracking,ensureOptimizations:t.ensureOptimizations,safeMode:t.safeMode,tracer:this.TRACE_INIT})}),this.patternIdxToConfig[r]=i.patternIdxToConfig,this.charCodeToPatternIdxToConfig[r]=i.charCodeToPatternIdxToConfig,this.emptyGroups=ex({},this.emptyGroups,i.emptyGroups),this.hasCustom=i.hasCustom||this.hasCustom,this.canModeBeOptimized[r]=i.canBeOptimized}})}),this.defaultMode=r.defaultMode,!isEmpty(this.lexerDefinitionErrors)&&!this.config.deferDefinitionErrorsHandling){let e=map(this.lexerDefinitionErrors,e=>e.message),t=e.join("-----------------------\n");throw Error("Errors detected in definition of Lexer:\n"+t)}forEach(this.lexerDefinitionWarning,e=>{PRINT_WARNING(e.message)}),this.TRACE_INIT("Choosing sub-methods implementations",()=>{if(tH?(this.chopInput=identity,this.match=this.matchWithTest):(this.updateLastIndex=noop,this.match=this.matchWithExec),i&&(this.handleModes=noop),!1===this.trackStartLines&&(this.computeNewColumn=identity),!1===this.trackEndLines&&(this.updateTokenEndLineColumnLocation=noop),/full/i.test(this.config.positionTracking))this.createTokenInstance=this.createFullToken;else if(/onlyStart/i.test(this.config.positionTracking))this.createTokenInstance=this.createStartOnlyToken;else if(/onlyOffset/i.test(this.config.positionTracking))this.createTokenInstance=this.createOffsetOnlyToken;else throw Error(`Invalid <positionTracking> config option: "${this.config.positionTracking}"`);this.hasCustom?(this.addToken=this.addTokenUsingPush,this.handlePayload=this.handlePayloadWithCustom):(this.addToken=this.addTokenUsingMemberAccess,this.handlePayload=this.handlePayloadNoCustom)}),this.TRACE_INIT("Failed Optimization Warnings",()=>{let e=reduce(this.canModeBeOptimized,(e,t,r)=>(!1===t&&e.push(r),e),[]);if(t.ensureOptimizations&&!isEmpty(e))throw Error(`Lexer Modes: < ${e.join(", ")} > cannot be optimized.
	 Disable the "ensureOptimizations" lexer config flag to silently ignore this and run the lexer in an un-optimized mode.
	 Or inspect the console log for details on how to resolve these issues.`)}),this.TRACE_INIT("clearRegExpParserCache",()=>{clearRegExpParserCache()}),this.TRACE_INIT("toFastProperties",()=>{toFastProperties(this)})})}tokenize(e,t=this.defaultMode){if(!isEmpty(this.lexerDefinitionErrors)){let e=map(this.lexerDefinitionErrors,e=>e.message),t=e.join("-----------------------\n");throw Error("Unable to Tokenize because Errors detected in definition of Lexer:\n"+t)}return this.tokenizeInternal(e,t)}tokenizeInternal(e,t){let r,i,a,n,s,o,l,c,u,h,p,d,f,m,g,v,y;let x=e,b=x.length,T=0,S=0,E=this.hasCustom?0:Math.floor(e.length/10),R=Array(E),A=[],C=this.trackStartLines?1:void 0,M=this.trackStartLines?1:void 0,P=cloneEmptyGroups(this.emptyGroups),w=this.trackStartLines,I=this.config.lineTerminatorsPattern,k=0,_=[],O=[],N=[],L=[];function getPossiblePatternsSlow(){return _}function getPossiblePatternsOptimized(e){let t=charCodeToOptimizedIndex(e),r=O[t];return void 0===r?L:r}Object.freeze(L);let pop_mode=e=>{if(1===N.length&&void 0===e.tokenType.PUSH_MODE){let t=this.config.errorMessageProvider.buildUnableToPopLexerModeMessage(e);A.push({offset:e.startOffset,line:e.startLine,column:e.startColumn,length:e.image.length,message:t})}else{N.pop();let e=last(N);_=this.patternIdxToConfig[e],O=this.charCodeToPatternIdxToConfig[e],k=_.length;let t=this.canModeBeOptimized[e]&&!1===this.config.safeMode;v=O&&t?getPossiblePatternsOptimized:getPossiblePatternsSlow}};function push_mode(e){N.push(e),O=this.charCodeToPatternIdxToConfig[e],k=(_=this.patternIdxToConfig[e]).length,k=_.length;let t=this.canModeBeOptimized[e]&&!1===this.config.safeMode;v=O&&t?getPossiblePatternsOptimized:getPossiblePatternsSlow}push_mode.call(this,t);let F=this.config.recoveryEnabled;for(;T<b;){o=null;let t=x.charCodeAt(T),E=v(t),O=E.length;for(r=0;r<O;r++){y=E[r];let i=y.pattern;l=null;let u=y.short;if(!1!==u?t===u&&(o=i):!0===y.isCustom?null!==(g=i.exec(x,T,R,P))?(o=g[0],void 0!==g.payload&&(l=g.payload)):o=null:(this.updateLastIndex(i,T),o=this.match(i,e,T)),null!==o){if(void 0!==(s=y.longerAlt)){let t=s.length;for(a=0;a<t;a++){let t=_[s[a]],r=t.pattern;if(c=null,!0===t.isCustom?null!==(g=r.exec(x,T,R,P))?(n=g[0],void 0!==g.payload&&(c=g.payload)):n=null:(this.updateLastIndex(r,T),n=this.match(r,e,T)),n&&n.length>o.length){o=n,l=c,y=t;break}}}break}}if(null!==o){if(u=o.length,void 0!==(h=y.group)&&(p=y.tokenTypeIdx,d=this.createTokenInstance(o,T,p,y.tokenType,C,M,u),this.handlePayload(d,l),!1===h?S=this.addToken(R,S,d):P[h].push(d)),e=this.chopInput(e,u),T+=u,M=this.computeNewColumn(M,u),!0===w&&!0===y.canLineTerminator){let e,t,r=0;I.lastIndex=0;do!0===(e=I.test(o))&&(t=I.lastIndex-1,r++);while(!0===e);0!==r&&(C+=r,M=u-t,this.updateTokenEndLineColumnLocation(d,h,t,r,C,M,u))}this.handleModes(y,pop_mode,push_mode,d)}else{let t=T,r=C,a=M,n=!1===F;for(;!1===n&&T<b;)for(e=this.chopInput(e,1),T++,i=0;i<k;i++){let t=_[i],r=t.pattern,a=t.short;if(!1!==a?x.charCodeAt(T)===a&&(n=!0):!0===t.isCustom?n=null!==r.exec(x,T,R,P):(this.updateLastIndex(r,T),n=null!==r.exec(e)),!0===n)break}if(f=T-t,M=this.computeNewColumn(M,f),m=this.config.errorMessageProvider.buildUnexpectedCharactersMessage(x,t,f,r,a),A.push({offset:t,line:r,column:a,length:f,message:m}),!1===F)break}}return this.hasCustom||(R.length=S),{tokens:R,groups:P,errors:A}}handleModes(e,t,r,i){if(!0===e.pop){let a=e.push;t(i),void 0!==a&&r.call(this,a)}else void 0!==e.push&&r.call(this,e.push)}chopInput(e,t){return e.substring(t)}updateLastIndex(e,t){e.lastIndex=t}updateTokenEndLineColumnLocation(e,t,r,i,a,n,s){let o,l;void 0===t||(l=(o=r===s-1)?-1:0,1===i&&!0===o||(e.endLine=a+l,e.endColumn=n-1+-l))}computeNewColumn(e,t){return e+t}createOffsetOnlyToken(e,t,r,i){return{image:e,startOffset:t,tokenTypeIdx:r,tokenType:i}}createStartOnlyToken(e,t,r,i,a,n){return{image:e,startOffset:t,startLine:a,startColumn:n,tokenTypeIdx:r,tokenType:i}}createFullToken(e,t,r,i,a,n,s){return{image:e,startOffset:t,endOffset:t+s-1,startLine:a,endLine:a,startColumn:n,endColumn:n+s-1,tokenTypeIdx:r,tokenType:i}}addTokenUsingPush(e,t,r){return e.push(r),t}addTokenUsingMemberAccess(e,t,r){return e[t]=r,++t}handlePayloadNoCustom(e,t){}handlePayloadWithCustom(e,t){null!==t&&(e.payload=t)}matchWithTest(e,t,r){let i=e.test(t);return!0===i?t.substring(r,e.lastIndex):null}matchWithExec(e,t){let r=e.exec(t);return null!==r?r[0]:null}};function tokenLabel(e){return hasTokenLabel(e)?e.LABEL:e.name}function hasTokenLabel(e){return isString(e.LABEL)&&""!==e.LABEL}Lexer2.SKIPPED="This marks a skipped Token pattern, this means each token identified by it willbe consumed and then thrown into oblivion, this can be used to for example to completely ignore whitespace.",Lexer2.NA=/NOT_APPLICABLE/;let tQ="categories",tJ="label",t0="group",t1="push_mode",t2="pop_mode",t3="longer_alt",t4="line_breaks",t5="start_chars_hint";function createToken2(e){return createTokenInternal(e)}function createTokenInternal(e){let t=e.pattern,r={};if(r.name=e.name,isUndefined(t)||(r.PATTERN=t),has(e,"parent"))throw"The parent property is no longer supported.\nSee: https://github.com/chevrotain/chevrotain/issues/564#issuecomment-349062346 for details.";return has(e,tQ)&&(r.CATEGORIES=e[tQ]),augmentTokenTypes([r]),has(e,tJ)&&(r.LABEL=e[tJ]),has(e,t0)&&(r.GROUP=e[t0]),has(e,t2)&&(r.POP_MODE=e[t2]),has(e,t1)&&(r.PUSH_MODE=e[t1]),has(e,t3)&&(r.LONGER_ALT=e[t3]),has(e,t4)&&(r.LINE_BREAKS=e[t4]),has(e,t5)&&(r.START_CHARS_HINT=e[t5]),r}let t6=createTokenInternal({name:"EOF",pattern:Lexer2.NA});function createTokenInstance(e,t,r,i,a,n,s,o){return{image:t,startOffset:r,endOffset:i,startLine:a,endLine:n,startColumn:s,endColumn:o,tokenTypeIdx:e.tokenTypeIdx,tokenType:e}}function tokenMatcher(e,t){return tokenStructuredMatcher(e,t)}augmentTokenTypes([t6]);let t8={buildMismatchTokenMessage({expected:e,actual:t,previous:r,ruleName:i}){let a=hasTokenLabel(e),n=a?`--> ${tokenLabel(e)} <--`:`token of type --> ${e.name} <--`,s=`Expecting ${n} but found --> '${t.image}' <--`;return s},buildNotAllInputParsedMessage:({firstRedundant:e,ruleName:t})=>"Redundant input, expecting EOF but found: "+e.image,buildNoViableAltMessage({expectedPathsPerAlt:e,actual:t,previous:r,customUserDescription:i,ruleName:a}){let n="Expecting: ",s=head(t).image,o="\nbut found: '"+s+"'";if(i)return n+i+o;{let t=reduce(e,(e,t)=>e.concat(t),[]),r=map(t,e=>`[${map(e,e=>tokenLabel(e)).join(", ")}]`),i=map(r,(e,t)=>`  ${t+1}. ${e}`),a=`one of these possible Token sequences:
${i.join("\n")}`;return n+a+o}},buildEarlyExitMessage({expectedIterationPaths:e,actual:t,customUserDescription:r,ruleName:i}){let a="Expecting: ",n=head(t).image,s="\nbut found: '"+n+"'";if(r)return a+r+s;{let t=map(e,e=>`[${map(e,e=>tokenLabel(e)).join(",")}]`),r=`expecting at least one iteration which starts with one of these possible Token sequences::
  <${t.join(" ,")}>`;return a+r+s}}};Object.freeze(t8);let t9={buildRuleNotFoundError(e,t){let r="Invalid grammar, reference to a rule which is not defined: ->"+t.nonTerminalName+"<-\ninside top level rule: ->"+e.name+"<-";return r}},t7={buildDuplicateFoundError(e,t){function getExtraProductionArgument2(e){return e instanceof Terminal?e.terminalType.name:e instanceof NonTerminal?e.nonTerminalName:""}let r=e.name,i=head(t),a=i.idx,n=getProductionDslName(i),s=getExtraProductionArgument2(i),o=`->${n}${a>0?a:""}<- ${s?`with argument: ->${s}<-`:""}
                  appears more than once (${t.length} times) in the top level rule: ->${r}<-.                  
                  For further details see: https://chevrotain.io/docs/FAQ.html#NUMERICAL_SUFFIXES 
                  `;return(o=o.replace(/[ \t]+/g," ")).replace(/\s\s+/g,"\n")},buildNamespaceConflictError(e){let t=`Namespace conflict found in grammar.
The grammar has both a Terminal(Token) and a Non-Terminal(Rule) named: <${e.name}>.
To resolve this make sure each Terminal and Non-Terminal names are unique
This is easy to accomplish by using the convention that Terminal names start with an uppercase letter
and Non-Terminal names start with a lower case letter.`;return t},buildAlternationPrefixAmbiguityError(e){let t=map(e.prefixPath,e=>tokenLabel(e)).join(", "),r=0===e.alternation.idx?"":e.alternation.idx,i=`Ambiguous alternatives: <${e.ambiguityIndices.join(" ,")}> due to common lookahead prefix
in <OR${r}> inside <${e.topLevelRule.name}> Rule,
<${t}> may appears as a prefix path in all these alternatives.
See: https://chevrotain.io/docs/guide/resolving_grammar_errors.html#COMMON_PREFIX
For Further details.`;return i},buildAlternationAmbiguityError(e){let t=map(e.prefixPath,e=>tokenLabel(e)).join(", "),r=0===e.alternation.idx?"":e.alternation.idx;return`Ambiguous Alternatives Detected: <${e.ambiguityIndices.join(" ,")}> in <OR${r}> inside <${e.topLevelRule.name}> Rule,
<${t}> may appears as a prefix path in all these alternatives.
See: https://chevrotain.io/docs/guide/resolving_grammar_errors.html#AMBIGUOUS_ALTERNATIVES
For Further details.`},buildEmptyRepetitionError(e){let t=getProductionDslName(e.repetition);0!==e.repetition.idx&&(t+=e.repetition.idx);let r=`The repetition <${t}> within Rule <${e.topLevelRule.name}> can never consume any tokens.
This could lead to an infinite loop.`;return r},buildTokenNameError:e=>"deprecated",buildEmptyAlternationError(e){let t=`Ambiguous empty alternative: <${e.emptyChoiceIdx+1}> in <OR${e.alternation.idx}> inside <${e.topLevelRule.name}> Rule.
Only the last alternative may be an empty alternative.`;return t},buildTooManyAlternativesError(e){let t=`An Alternation cannot have more than 256 alternatives:
<OR${e.alternation.idx}> inside <${e.topLevelRule.name}> Rule.
 has ${e.alternation.definition.length+1} alternatives.`;return t},buildLeftRecursionError(e){let t=e.topLevelRule.name,r=map(e.leftRecursionPath,e=>e.name),i=`${t} --> ${r.concat([t]).join(" --> ")}`,a=`Left Recursion found in grammar.
rule: <${t}> can be invoked from itself (directly or indirectly)
without consuming any Tokens. The grammar path that causes this is: 
 ${i}
 To fix this refactor your grammar to remove the left recursion.
see: https://en.wikipedia.org/wiki/LL_parser#Left_factoring.`;return a},buildInvalidRuleNameError:e=>"deprecated",buildDuplicateRuleNameError(e){let t;t=e.topLevelRule instanceof Rule?e.topLevelRule.name:e.topLevelRule;let r=`Duplicate definition, rule: ->${t}<- is already defined in the grammar: ->${e.grammarName}<-`;return r}};function resolveGrammar$1(e,t){let r=new GastRefResolverVisitor(e,t);return r.resolveRefs(),r.errors}let GastRefResolverVisitor=class GastRefResolverVisitor extends GAstVisitor{constructor(e,t){super(),this.nameToTopRule=e,this.errMsgProvider=t,this.errors=[]}resolveRefs(){forEach(values(this.nameToTopRule),e=>{this.currTopLevel=e,e.accept(this)})}visitNonTerminal(e){let t=this.nameToTopRule[e.nonTerminalName];if(t)e.referencedRule=t;else{let t=this.errMsgProvider.buildRuleNotFoundError(this.currTopLevel,e);this.errors.push({message:t,type:p.UNRESOLVED_SUBRULE_REF,ruleName:this.currTopLevel.name,unresolvedRefName:e.nonTerminalName})}}};let AbstractNextPossibleTokensWalker=class AbstractNextPossibleTokensWalker extends RestWalker{constructor(e,t){super(),this.topProd=e,this.path=t,this.possibleTokTypes=[],this.nextProductionName="",this.nextProductionOccurrence=0,this.found=!1,this.isAtEndOfPath=!1}startWalking(){if(this.found=!1,this.path.ruleStack[0]!==this.topProd.name)throw Error("The path does not start with the walker's top Rule!");return this.ruleStack=clone2(this.path.ruleStack).reverse(),this.occurrenceStack=clone2(this.path.occurrenceStack).reverse(),this.ruleStack.pop(),this.occurrenceStack.pop(),this.updateExpectedNext(),this.walk(this.topProd),this.possibleTokTypes}walk(e,t=[]){this.found||super.walk(e,t)}walkProdRef(e,t,r){if(e.referencedRule.name===this.nextProductionName&&e.idx===this.nextProductionOccurrence){let i=t.concat(r);this.updateExpectedNext(),this.walk(e.referencedRule,i)}}updateExpectedNext(){isEmpty(this.ruleStack)?(this.nextProductionName="",this.nextProductionOccurrence=0,this.isAtEndOfPath=!0):(this.nextProductionName=this.ruleStack.pop(),this.nextProductionOccurrence=this.occurrenceStack.pop())}};let NextAfterTokenWalker=class NextAfterTokenWalker extends AbstractNextPossibleTokensWalker{constructor(e,t){super(e,t),this.path=t,this.nextTerminalName="",this.nextTerminalOccurrence=0,this.nextTerminalName=this.path.lastTok.name,this.nextTerminalOccurrence=this.path.lastTokOccurrence}walkTerminal(e,t,r){if(this.isAtEndOfPath&&e.terminalType.name===this.nextTerminalName&&e.idx===this.nextTerminalOccurrence&&!this.found){let e=t.concat(r),i=new Alternative({definition:e});this.possibleTokTypes=first(i),this.found=!0}}};let AbstractNextTerminalAfterProductionWalker=class AbstractNextTerminalAfterProductionWalker extends RestWalker{constructor(e,t){super(),this.topRule=e,this.occurrence=t,this.result={token:void 0,occurrence:void 0,isEndOfRule:void 0}}startWalking(){return this.walk(this.topRule),this.result}};let NextTerminalAfterManyWalker=class NextTerminalAfterManyWalker extends AbstractNextTerminalAfterProductionWalker{walkMany(e,t,r){if(e.idx===this.occurrence){let e=head(t.concat(r));this.result.isEndOfRule=void 0===e,e instanceof Terminal&&(this.result.token=e.terminalType,this.result.occurrence=e.idx)}else super.walkMany(e,t,r)}};let NextTerminalAfterManySepWalker=class NextTerminalAfterManySepWalker extends AbstractNextTerminalAfterProductionWalker{walkManySep(e,t,r){if(e.idx===this.occurrence){let e=head(t.concat(r));this.result.isEndOfRule=void 0===e,e instanceof Terminal&&(this.result.token=e.terminalType,this.result.occurrence=e.idx)}else super.walkManySep(e,t,r)}};let NextTerminalAfterAtLeastOneWalker=class NextTerminalAfterAtLeastOneWalker extends AbstractNextTerminalAfterProductionWalker{walkAtLeastOne(e,t,r){if(e.idx===this.occurrence){let e=head(t.concat(r));this.result.isEndOfRule=void 0===e,e instanceof Terminal&&(this.result.token=e.terminalType,this.result.occurrence=e.idx)}else super.walkAtLeastOne(e,t,r)}};let NextTerminalAfterAtLeastOneSepWalker=class NextTerminalAfterAtLeastOneSepWalker extends AbstractNextTerminalAfterProductionWalker{walkAtLeastOneSep(e,t,r){if(e.idx===this.occurrence){let e=head(t.concat(r));this.result.isEndOfRule=void 0===e,e instanceof Terminal&&(this.result.token=e.terminalType,this.result.occurrence=e.idx)}else super.walkAtLeastOneSep(e,t,r)}};function possiblePathsFrom(e,t,r=[]){r=clone2(r);let i=[],a=0;function remainingPathWith(t){return t.concat(drop(e,a+1))}function getAlternativesForProd(e){let a=possiblePathsFrom(remainingPathWith(e),t,r);return i.concat(a)}for(;r.length<t&&a<e.length;){let t=e[a];if(t instanceof Alternative||t instanceof NonTerminal)return getAlternativesForProd(t.definition);if(t instanceof Option)i=getAlternativesForProd(t.definition);else if(t instanceof RepetitionMandatory){let e=t.definition.concat([new Repetition({definition:t.definition})]);return getAlternativesForProd(e)}else if(t instanceof RepetitionMandatoryWithSeparator){let e=[new Alternative({definition:t.definition}),new Repetition({definition:[new Terminal({terminalType:t.separator})].concat(t.definition)})];return getAlternativesForProd(e)}else if(t instanceof RepetitionWithSeparator){let e=t.definition.concat([new Repetition({definition:[new Terminal({terminalType:t.separator})].concat(t.definition)})]);i=getAlternativesForProd(e)}else if(t instanceof Repetition){let e=t.definition.concat([new Repetition({definition:t.definition})]);i=getAlternativesForProd(e)}else if(t instanceof Alternation)return forEach(t.definition,e=>{!1===isEmpty(e.definition)&&(i=getAlternativesForProd(e.definition))}),i;else if(t instanceof Terminal)r.push(t.terminalType);else throw Error("non exhaustive match");a++}return i.push({partialPath:r,suffixDef:drop(e,a)}),i}function nextPossibleTokensAfter(e,t,r,i){let a="EXIT_NONE_TERMINAL",n=[a],s="EXIT_ALTERNATIVE",o=!1,l=t.length,c=l-i-1,u=[],h=[];for(h.push({idx:-1,def:e,ruleStack:[],occurrenceStack:[]});!isEmpty(h);){let e=h.pop();if(e===s){o&&last(h).idx<=c&&h.pop();continue}let i=e.def,p=e.idx,d=e.ruleStack,f=e.occurrenceStack;if(isEmpty(i))continue;let m=i[0];if(m===a){let e={idx:p,def:drop(i),ruleStack:dropRight(d),occurrenceStack:dropRight(f)};h.push(e)}else if(m instanceof Terminal){if(p<l-1){let e=p+1,a=t[e];if(r(a,m.terminalType)){let t={idx:e,def:drop(i),ruleStack:d,occurrenceStack:f};h.push(t)}}else if(p===l-1)u.push({nextTokenType:m.terminalType,nextTokenOccurrence:m.idx,ruleStack:d,occurrenceStack:f}),o=!0;else throw Error("non exhaustive match")}else if(m instanceof NonTerminal){let e=clone2(d);e.push(m.nonTerminalName);let t=clone2(f);t.push(m.idx);let r={idx:p,def:m.definition.concat(n,drop(i)),ruleStack:e,occurrenceStack:t};h.push(r)}else if(m instanceof Option){let e={idx:p,def:drop(i),ruleStack:d,occurrenceStack:f};h.push(e),h.push(s);let t={idx:p,def:m.definition.concat(drop(i)),ruleStack:d,occurrenceStack:f};h.push(t)}else if(m instanceof RepetitionMandatory){let e=new Repetition({definition:m.definition,idx:m.idx}),t=m.definition.concat([e],drop(i)),r={idx:p,def:t,ruleStack:d,occurrenceStack:f};h.push(r)}else if(m instanceof RepetitionMandatoryWithSeparator){let e=new Terminal({terminalType:m.separator}),t=new Repetition({definition:[e].concat(m.definition),idx:m.idx}),r=m.definition.concat([t],drop(i)),a={idx:p,def:r,ruleStack:d,occurrenceStack:f};h.push(a)}else if(m instanceof RepetitionWithSeparator){let e={idx:p,def:drop(i),ruleStack:d,occurrenceStack:f};h.push(e),h.push(s);let t=new Terminal({terminalType:m.separator}),r=new Repetition({definition:[t].concat(m.definition),idx:m.idx}),a=m.definition.concat([r],drop(i)),n={idx:p,def:a,ruleStack:d,occurrenceStack:f};h.push(n)}else if(m instanceof Repetition){let e={idx:p,def:drop(i),ruleStack:d,occurrenceStack:f};h.push(e),h.push(s);let t=new Repetition({definition:m.definition,idx:m.idx}),r=m.definition.concat([t],drop(i)),a={idx:p,def:r,ruleStack:d,occurrenceStack:f};h.push(a)}else if(m instanceof Alternation)for(let e=m.definition.length-1;e>=0;e--){let t=m.definition[e],r={idx:p,def:t.definition.concat(drop(i)),ruleStack:d,occurrenceStack:f};h.push(r),h.push(s)}else if(m instanceof Alternative)h.push({idx:p,def:m.definition.concat(drop(i)),ruleStack:d,occurrenceStack:f});else if(m instanceof Rule)h.push(expandTopLevelRule(m,p,d,f));else throw Error("non exhaustive match")}return u}function expandTopLevelRule(e,t,r,i){let a=clone2(r);a.push(e.name);let n=clone2(i);return n.push(1),{idx:t,def:e.definition,ruleStack:a,occurrenceStack:n}}function getProdType(e){if(e instanceof Option||"Option"===e)return u.OPTION;if(e instanceof Repetition||"Repetition"===e)return u.REPETITION;if(e instanceof RepetitionMandatory||"RepetitionMandatory"===e)return u.REPETITION_MANDATORY;if(e instanceof RepetitionMandatoryWithSeparator||"RepetitionMandatoryWithSeparator"===e)return u.REPETITION_MANDATORY_WITH_SEPARATOR;if(e instanceof RepetitionWithSeparator||"RepetitionWithSeparator"===e)return u.REPETITION_WITH_SEPARATOR;if(e instanceof Alternation||"Alternation"===e)return u.ALTERNATION;throw Error("non exhaustive match")}function buildLookaheadFuncForOr(e,t,r,i,a,n){let s=getLookaheadPathsForOr(e,t,r),o=areTokenCategoriesNotUsed(s)?tokenStructuredMatcherNoCategories:tokenStructuredMatcher;return n(s,i,o,a)}function buildLookaheadFuncForOptionalProd(e,t,r,i,a,n){let s=getLookaheadPathsForOptionalProd(e,t,a,r),o=areTokenCategoriesNotUsed(s)?tokenStructuredMatcherNoCategories:tokenStructuredMatcher;return n(s[0],o,i)}function buildAlternativesLookAheadFunc(e,t,r,i){let a=e.length,n=every(e,e=>every(e,e=>1===e.length));if(t)return function(t){let i=map(t,e=>e.GATE);for(let t=0;t<a;t++){let a=e[t],n=a.length,s=i[t];if(void 0===s||!1!==s.call(this))t:for(let e=0;e<n;e++){let i=a[e],n=i.length;for(let e=0;e<n;e++){let t=this.LA(e+1);if(!1===r(t,i[e]))continue t}return t}}};if(!n||i)return function(){for(let t=0;t<a;t++){let i=e[t],a=i.length;t:for(let e=0;e<a;e++){let a=i[e],n=a.length;for(let e=0;e<n;e++){let t=this.LA(e+1);if(!1===r(t,a[e]))continue t}return t}}};{let t=map(e,e=>flatten(e)),r=reduce(t,(e,t,r)=>(forEach(t,t=>{has(e,t.tokenTypeIdx)||(e[t.tokenTypeIdx]=r),forEach(t.categoryMatches,t=>{has(e,t)||(e[t]=r)})}),e),{});return function(){let e=this.LA(1);return r[e.tokenTypeIdx]}}}function buildSingleAlternativeLookaheadFunction(e,t,r){let i=every(e,e=>1===e.length),a=e.length;if(!i||r)return function(){t:for(let r=0;r<a;r++){let i=e[r],a=i.length;for(let e=0;e<a;e++){let r=this.LA(e+1);if(!1===t(r,i[e]))continue t}return!0}return!1};{let t=flatten(e);if(1===t.length&&isEmpty(t[0].categoryMatches)){let e=t[0],r=e.tokenTypeIdx;return function(){return this.LA(1).tokenTypeIdx===r}}{let e=reduce(t,(e,t,r)=>(e[t.tokenTypeIdx]=!0,forEach(t.categoryMatches,t=>{e[t]=!0}),e),[]);return function(){let t=this.LA(1);return!0===e[t.tokenTypeIdx]}}}}(s=u||(u={}))[s.OPTION=0]="OPTION",s[s.REPETITION=1]="REPETITION",s[s.REPETITION_MANDATORY=2]="REPETITION_MANDATORY",s[s.REPETITION_MANDATORY_WITH_SEPARATOR=3]="REPETITION_MANDATORY_WITH_SEPARATOR",s[s.REPETITION_WITH_SEPARATOR=4]="REPETITION_WITH_SEPARATOR",s[s.ALTERNATION=5]="ALTERNATION";let RestDefinitionFinderWalker=class RestDefinitionFinderWalker extends RestWalker{constructor(e,t,r){super(),this.topProd=e,this.targetOccurrence=t,this.targetProdType=r}startWalking(){return this.walk(this.topProd),this.restDef}checkIsTarget(e,t,r,i){return e.idx===this.targetOccurrence&&this.targetProdType===t&&(this.restDef=r.concat(i),!0)}walkOption(e,t,r){this.checkIsTarget(e,u.OPTION,t,r)||super.walkOption(e,t,r)}walkAtLeastOne(e,t,r){this.checkIsTarget(e,u.REPETITION_MANDATORY,t,r)||super.walkOption(e,t,r)}walkAtLeastOneSep(e,t,r){this.checkIsTarget(e,u.REPETITION_MANDATORY_WITH_SEPARATOR,t,r)||super.walkOption(e,t,r)}walkMany(e,t,r){this.checkIsTarget(e,u.REPETITION,t,r)||super.walkOption(e,t,r)}walkManySep(e,t,r){this.checkIsTarget(e,u.REPETITION_WITH_SEPARATOR,t,r)||super.walkOption(e,t,r)}};let InsideDefinitionFinderVisitor=class InsideDefinitionFinderVisitor extends GAstVisitor{constructor(e,t,r){super(),this.targetOccurrence=e,this.targetProdType=t,this.targetRef=r,this.result=[]}checkIsTarget(e,t){e.idx===this.targetOccurrence&&this.targetProdType===t&&(void 0===this.targetRef||e===this.targetRef)&&(this.result=e.definition)}visitOption(e){this.checkIsTarget(e,u.OPTION)}visitRepetition(e){this.checkIsTarget(e,u.REPETITION)}visitRepetitionMandatory(e){this.checkIsTarget(e,u.REPETITION_MANDATORY)}visitRepetitionMandatoryWithSeparator(e){this.checkIsTarget(e,u.REPETITION_MANDATORY_WITH_SEPARATOR)}visitRepetitionWithSeparator(e){this.checkIsTarget(e,u.REPETITION_WITH_SEPARATOR)}visitAlternation(e){this.checkIsTarget(e,u.ALTERNATION)}};function initializeArrayOfArrays(e){let t=Array(e);for(let r=0;r<e;r++)t[r]=[];return t}function pathToHashKeys(e){let t=[""];for(let r=0;r<e.length;r++){let i=e[r],a=[];for(let e=0;e<t.length;e++){let r=t[e];a.push(r+"_"+i.tokenTypeIdx);for(let e=0;e<i.categoryMatches.length;e++){let t="_"+i.categoryMatches[e];a.push(r+t)}}t=a}return t}function isUniquePrefixHash(e,t,r){for(let i=0;i<e.length;i++){if(i===r)continue;let a=e[i];for(let e=0;e<t.length;e++){let r=t[e];if(!0===a[r])return!1}}return!0}function lookAheadSequenceFromAlternatives(e,t){let r=map(e,e=>possiblePathsFrom([e],1)),i=initializeArrayOfArrays(r.length),a=map(r,e=>{let t={};return forEach(e,e=>{let r=pathToHashKeys(e.partialPath);forEach(r,e=>{t[e]=!0})}),t}),n=r;for(let e=1;e<=t;e++){let r=n;n=initializeArrayOfArrays(r.length);for(let s=0;s<r.length;s++){let o=r[s];for(let r=0;r<o.length;r++){let l=o[r].partialPath,c=o[r].suffixDef,u=pathToHashKeys(l),h=isUniquePrefixHash(a,u,s);if(h||isEmpty(c)||l.length===t){let e=i[s];if(!1===containsPath(e,l)){e.push(l);for(let e=0;e<u.length;e++){let t=u[e];a[s][t]=!0}}}else{let t=possiblePathsFrom(c,e+1,l);n[s]=n[s].concat(t),forEach(t,e=>{let t=pathToHashKeys(e.partialPath);forEach(t,e=>{a[s][e]=!0})})}}}}return i}function getLookaheadPathsForOr(e,t,r,i){let a=new InsideDefinitionFinderVisitor(e,u.ALTERNATION,i);return t.accept(a),lookAheadSequenceFromAlternatives(a.result,r)}function getLookaheadPathsForOptionalProd(e,t,r,i){let a=new InsideDefinitionFinderVisitor(e,r);t.accept(a);let n=a.result,s=new RestDefinitionFinderWalker(t,e,r),o=s.startWalking(),l=new Alternative({definition:n}),c=new Alternative({definition:o});return lookAheadSequenceFromAlternatives([l,c],i)}function containsPath(e,t){r:for(let r=0;r<e.length;r++){let i=e[r];if(i.length===t.length){for(let e=0;e<i.length;e++){let r=t[e],a=i[e],n=r===a||void 0!==a.categoryMatchesMap[r.tokenTypeIdx];if(!1===n)continue r}return!0}}return!1}function isStrictPrefixOfPath(e,t){return e.length<t.length&&every(e,(e,r)=>{let i=t[r];return e===i||i.categoryMatchesMap[e.tokenTypeIdx]})}function areTokenCategoriesNotUsed(e){return every(e,e=>every(e,e=>every(e,e=>isEmpty(e.categoryMatches))))}function validateLookahead(e){let t=e.lookaheadStrategy.validate({rules:e.rules,tokenTypes:e.tokenTypes,grammarName:e.grammarName});return map(t,e=>Object.assign({type:p.CUSTOM_LOOKAHEAD_VALIDATION},e))}function validateGrammar$1(e,t,r,i){let a=flatMap(e,e=>validateDuplicateProductions(e,r)),n=checkTerminalAndNoneTerminalsNameSpace(e,t,r),s=flatMap(e,e=>validateTooManyAlts(e,r)),o=flatMap(e,t=>validateRuleDoesNotAlreadyExist(t,e,i,r));return a.concat(n,s,o)}function validateDuplicateProductions(e,t){let r=new OccurrenceValidationCollector;e.accept(r);let i=r.allProductions,a=tT(i,identifyProductionForDuplicates),n=pickBy(a,e=>e.length>1),s=map(values(n),r=>{let i=head(r),a=t.buildDuplicateFoundError(e,r),n=getProductionDslName(i),s={message:a,type:p.DUPLICATE_PRODUCTIONS,ruleName:e.name,dslName:n,occurrence:i.idx},o=getExtraProductionArgument(i);return o&&(s.parameter=o),s});return s}function identifyProductionForDuplicates(e){return`${getProductionDslName(e)}_#_${e.idx}_#_${getExtraProductionArgument(e)}`}function getExtraProductionArgument(e){return e instanceof Terminal?e.terminalType.name:e instanceof NonTerminal?e.nonTerminalName:""}let OccurrenceValidationCollector=class OccurrenceValidationCollector extends GAstVisitor{constructor(){super(...arguments),this.allProductions=[]}visitNonTerminal(e){this.allProductions.push(e)}visitOption(e){this.allProductions.push(e)}visitRepetitionWithSeparator(e){this.allProductions.push(e)}visitRepetitionMandatory(e){this.allProductions.push(e)}visitRepetitionMandatoryWithSeparator(e){this.allProductions.push(e)}visitRepetition(e){this.allProductions.push(e)}visitAlternation(e){this.allProductions.push(e)}visitTerminal(e){this.allProductions.push(e)}};function validateRuleDoesNotAlreadyExist(e,t,r,i){let a=[],n=reduce(t,(t,r)=>r.name===e.name?t+1:t,0);if(n>1){let t=i.buildDuplicateRuleNameError({topLevelRule:e,grammarName:r});a.push({message:t,type:p.DUPLICATE_RULE_NAME,ruleName:e.name})}return a}function validateRuleIsOverridden(e,t,r){let i=[];return includes(t,e)||i.push({message:`Invalid rule override, rule: ->${e}<- cannot be overridden in the grammar: ->${r}<-as it is not defined in any of the super grammars `,type:p.INVALID_RULE_OVERRIDE,ruleName:e}),i}function validateNoLeftRecursion(e,t,r,i=[]){let a=[],n=getFirstNoneTerminal(t.definition);if(isEmpty(n))return[];{let t=e.name,s=includes(n,e);s&&a.push({message:r.buildLeftRecursionError({topLevelRule:e,leftRecursionPath:i}),type:p.LEFT_RECURSION,ruleName:t});let o=tv(n,i.concat([e])),l=flatMap(o,t=>{let a=clone2(i);return a.push(t),validateNoLeftRecursion(e,t,r,a)});return a.concat(l)}}function getFirstNoneTerminal(e){let t=[];if(isEmpty(e))return t;let r=head(e);if(r instanceof NonTerminal)t.push(r.referencedRule);else if(r instanceof Alternative||r instanceof Option||r instanceof RepetitionMandatory||r instanceof RepetitionMandatoryWithSeparator||r instanceof RepetitionWithSeparator||r instanceof Repetition)t=t.concat(getFirstNoneTerminal(r.definition));else if(r instanceof Alternation)t=flatten(map(r.definition,e=>getFirstNoneTerminal(e.definition)));else if(r instanceof Terminal);else throw Error("non exhaustive match");let i=isOptionalProd(r),a=e.length>1;if(!i||!a)return t;{let r=drop(e);return t.concat(getFirstNoneTerminal(r))}}let OrCollector=class OrCollector extends GAstVisitor{constructor(){super(...arguments),this.alternations=[]}visitAlternation(e){this.alternations.push(e)}};function validateEmptyOrAlternative(e,t){let r=new OrCollector;e.accept(r);let i=r.alternations,a=flatMap(i,r=>{let i=dropRight(r.definition);return flatMap(i,(i,a)=>{let n=nextPossibleTokensAfter([i],[],tokenStructuredMatcher,1);return isEmpty(n)?[{message:t.buildEmptyAlternationError({topLevelRule:e,alternation:r,emptyChoiceIdx:a}),type:p.NONE_LAST_EMPTY_ALT,ruleName:e.name,occurrence:r.idx,alternative:a+1}]:[]})});return a}function validateAmbiguousAlternationAlternatives(e,t,r){let i=new OrCollector;e.accept(i);let a=i.alternations;a=reject(a,e=>!0===e.ignoreAmbiguities);let n=flatMap(a,i=>{let a=i.idx,n=i.maxLookahead||t,s=getLookaheadPathsForOr(a,e,n,i),o=checkAlternativesAmbiguities(s,i,e,r),l=checkPrefixAlternativesAmbiguities(s,i,e,r);return o.concat(l)});return n}let RepetitionCollector=class RepetitionCollector extends GAstVisitor{constructor(){super(...arguments),this.allProductions=[]}visitRepetitionWithSeparator(e){this.allProductions.push(e)}visitRepetitionMandatory(e){this.allProductions.push(e)}visitRepetitionMandatoryWithSeparator(e){this.allProductions.push(e)}visitRepetition(e){this.allProductions.push(e)}};function validateTooManyAlts(e,t){let r=new OrCollector;e.accept(r);let i=r.alternations,a=flatMap(i,r=>r.definition.length>255?[{message:t.buildTooManyAlternativesError({topLevelRule:e,alternation:r}),type:p.TOO_MANY_ALTS,ruleName:e.name,occurrence:r.idx}]:[]);return a}function validateSomeNonEmptyLookaheadPath(e,t,r){let i=[];return forEach(e,e=>{let a=new RepetitionCollector;e.accept(a);let n=a.allProductions;forEach(n,a=>{let n=getProdType(a),s=a.maxLookahead||t,o=a.idx,l=getLookaheadPathsForOptionalProd(o,e,n,s),c=l[0];if(isEmpty(flatten(c))){let t=r.buildEmptyRepetitionError({topLevelRule:e,repetition:a});i.push({message:t,type:p.NO_NON_EMPTY_LOOKAHEAD,ruleName:e.name})}})}),i}function checkAlternativesAmbiguities(e,t,r,i){let a=[],n=reduce(e,(r,i,n)=>(!0===t.definition[n].ignoreAmbiguities||forEach(i,i=>{let s=[n];forEach(e,(e,r)=>{n!==r&&containsPath(e,i)&&!0!==t.definition[r].ignoreAmbiguities&&s.push(r)}),s.length>1&&!containsPath(a,i)&&(a.push(i),r.push({alts:s,path:i}))}),r),[]),s=map(n,e=>{let a=map(e.alts,e=>e+1),n=i.buildAlternationAmbiguityError({topLevelRule:r,alternation:t,ambiguityIndices:a,prefixPath:e.path});return{message:n,type:p.AMBIGUOUS_ALTS,ruleName:r.name,occurrence:t.idx,alternatives:e.alts}});return s}function checkPrefixAlternativesAmbiguities(e,t,r,i){let a=reduce(e,(e,t,r)=>{let i=map(t,e=>({idx:r,path:e}));return e.concat(i)},[]),n=compact(flatMap(a,e=>{let n=t.definition[e.idx];if(!0===n.ignoreAmbiguities)return[];let s=e.idx,o=e.path,l=filter(a,e=>!0!==t.definition[e.idx].ignoreAmbiguities&&e.idx<s&&isStrictPrefixOfPath(e.path,o)),c=map(l,e=>{let a=[e.idx+1,s+1],n=0===t.idx?"":t.idx,o=i.buildAlternationPrefixAmbiguityError({topLevelRule:r,alternation:t,ambiguityIndices:a,prefixPath:e.path});return{message:o,type:p.AMBIGUOUS_PREFIX_ALTS,ruleName:r.name,occurrence:n,alternatives:a}});return c}));return n}function checkTerminalAndNoneTerminalsNameSpace(e,t,r){let i=[],a=map(t,e=>e.name);return forEach(e,e=>{let t=e.name;if(includes(a,t)){let a=r.buildNamespaceConflictError(e);i.push({message:a,type:p.CONFLICT_TOKENS_RULES_NAMESPACE,ruleName:t})}}),i}function resolveGrammar(e){let t=tg(e,{errMsgProvider:t9}),r={};return forEach(e.rules,e=>{r[e.name]=e}),resolveGrammar$1(r,t.errMsgProvider)}function validateGrammar(e){return validateGrammar$1((e=tg(e,{errMsgProvider:t7})).rules,e.tokenTypes,e.errMsgProvider,e.grammarName)}let re="MismatchedTokenException",rt="NoViableAltException",rr="EarlyExitException",ri="NotAllInputParsedException",ra=[re,rt,rr,ri];function isRecognitionException(e){return includes(ra,e.name)}Object.freeze(ra);let RecognitionException=class RecognitionException extends Error{constructor(e,t){super(e),this.token=t,this.resyncedTokens=[],Object.setPrototypeOf(this,new.target.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}};let MismatchedTokenException=class MismatchedTokenException extends RecognitionException{constructor(e,t,r){super(e,t),this.previousToken=r,this.name=re}};let NoViableAltException=class NoViableAltException extends RecognitionException{constructor(e,t,r){super(e,t),this.previousToken=r,this.name=rt}};let NotAllInputParsedException=class NotAllInputParsedException extends RecognitionException{constructor(e,t){super(e,t),this.name=ri}};let EarlyExitException=class EarlyExitException extends RecognitionException{constructor(e,t,r){super(e,t),this.previousToken=r,this.name=rr}};let rn={},rs="InRuleRecoveryException";let InRuleRecoveryException=class InRuleRecoveryException extends Error{constructor(e){super(e),this.name=rs}};let Recoverable=class Recoverable{initRecoverable(e){this.firstAfterRepMap={},this.resyncFollows={},this.recoveryEnabled=has(e,"recoveryEnabled")?e.recoveryEnabled:rd.recoveryEnabled,this.recoveryEnabled&&(this.attemptInRepetitionRecovery=attemptInRepetitionRecovery)}getTokenToInsert(e){let t=createTokenInstance(e,"",NaN,NaN,NaN,NaN,NaN,NaN);return t.isInsertedInRecovery=!0,t}canTokenTypeBeInsertedInRecovery(e){return!0}canTokenTypeBeDeletedInRecovery(e){return!0}tryInRepetitionRecovery(e,t,r,i){let a=this.findReSyncTokenType(),n=this.exportLexerState(),s=[],o=!1,l=this.LA(1),c=this.LA(1),generateErrorMessage=()=>{let e=this.LA(0),t=this.errorMessageProvider.buildMismatchTokenMessage({expected:i,actual:l,previous:e,ruleName:this.getCurrRuleFullName()}),r=new MismatchedTokenException(t,l,this.LA(0));r.resyncedTokens=dropRight(s),this.SAVE_ERROR(r)};for(;!o;){if(this.tokenMatcher(c,i)){generateErrorMessage();return}if(r.call(this)){generateErrorMessage(),e.apply(this,t);return}this.tokenMatcher(c,a)?o=!0:(c=this.SKIP_TOKEN(),this.addToResyncTokens(c,s))}this.importLexerState(n)}shouldInRepetitionRecoveryBeTried(e,t,r){return!(!1===r||this.tokenMatcher(this.LA(1),e)||this.isBackTracking()||this.canPerformInRuleRecovery(e,this.getFollowsForInRuleRecovery(e,t)))}getFollowsForInRuleRecovery(e,t){let r=this.getCurrentGrammarPath(e,t),i=this.getNextPossibleTokenTypes(r);return i}tryInRuleRecovery(e,t){if(this.canRecoverWithSingleTokenInsertion(e,t)){let t=this.getTokenToInsert(e);return t}if(this.canRecoverWithSingleTokenDeletion(e)){let e=this.SKIP_TOKEN();return this.consumeToken(),e}throw new InRuleRecoveryException("sad sad panda")}canPerformInRuleRecovery(e,t){return this.canRecoverWithSingleTokenInsertion(e,t)||this.canRecoverWithSingleTokenDeletion(e)}canRecoverWithSingleTokenInsertion(e,t){if(!this.canTokenTypeBeInsertedInRecovery(e)||isEmpty(t))return!1;let r=this.LA(1),i=void 0!==tx(t,e=>this.tokenMatcher(r,e));return i}canRecoverWithSingleTokenDeletion(e){if(!this.canTokenTypeBeDeletedInRecovery(e))return!1;let t=this.tokenMatcher(this.LA(2),e);return t}isInCurrentRuleReSyncSet(e){let t=this.getCurrFollowKey(),r=this.getFollowSetFromFollowKey(t);return includes(r,e)}findReSyncTokenType(){let e=this.flattenFollowSet(),t=this.LA(1),r=2;for(;;){let i=tx(e,e=>{let r=tokenMatcher(t,e);return r});if(void 0!==i)return i;t=this.LA(r),r++}}getCurrFollowKey(){if(1===this.RULE_STACK.length)return rn;let e=this.getLastExplicitRuleShortName(),t=this.getLastExplicitRuleOccurrenceIndex(),r=this.getPreviousExplicitRuleShortName();return{ruleName:this.shortRuleNameToFullName(e),idxInCallingRule:t,inRule:this.shortRuleNameToFullName(r)}}buildFullFollowKeyStack(){let e=this.RULE_STACK,t=this.RULE_OCCURRENCE_STACK;return map(e,(r,i)=>0===i?rn:{ruleName:this.shortRuleNameToFullName(r),idxInCallingRule:t[i],inRule:this.shortRuleNameToFullName(e[i-1])})}flattenFollowSet(){let e=map(this.buildFullFollowKeyStack(),e=>this.getFollowSetFromFollowKey(e));return flatten(e)}getFollowSetFromFollowKey(e){if(e===rn)return[t6];let t=e.ruleName+e.idxInCallingRule+tw+e.inRule;return this.resyncFollows[t]}addToResyncTokens(e,t){return this.tokenMatcher(e,t6)||t.push(e),t}reSyncTo(e){let t=[],r=this.LA(1);for(;!1===this.tokenMatcher(r,e);)r=this.SKIP_TOKEN(),this.addToResyncTokens(r,t);return dropRight(t)}attemptInRepetitionRecovery(e,t,r,i,a,n,s){}getCurrentGrammarPath(e,t){let r=this.getHumanReadableRuleStack(),i=clone2(this.RULE_OCCURRENCE_STACK);return{ruleStack:r,occurrenceStack:i,lastTok:e,lastTokOccurrence:t}}getHumanReadableRuleStack(){return map(this.RULE_STACK,e=>this.shortRuleNameToFullName(e))}};function attemptInRepetitionRecovery(e,t,r,i,a,n,s){let o=this.getKeyForAutomaticLookahead(i,a),l=this.firstAfterRepMap[o];if(void 0===l){let e=this.getCurrRuleFullName(),t=this.getGAstProductions()[e],r=new n(t,a);l=r.startWalking(),this.firstAfterRepMap[o]=l}let c=l.token,u=l.occurrence,h=l.isEndOfRule;1===this.RULE_STACK.length&&h&&void 0===c&&(c=t6,u=1),void 0!==c&&void 0!==u&&this.shouldInRepetitionRecoveryBeTried(c,u,s)&&this.tryInRepetitionRecovery(e,t,r,c)}let LLkLookaheadStrategy=class LLkLookaheadStrategy{constructor(e){var t;this.maxLookahead=null!==(t=null==e?void 0:e.maxLookahead)&&void 0!==t?t:rd.maxLookahead}validate(e){let t=this.validateNoLeftRecursion(e.rules);if(isEmpty(t)){let r=this.validateEmptyOrAlternatives(e.rules),i=this.validateAmbiguousAlternationAlternatives(e.rules,this.maxLookahead),a=this.validateSomeNonEmptyLookaheadPath(e.rules,this.maxLookahead),n=[...t,...r,...i,...a];return n}return t}validateNoLeftRecursion(e){return flatMap(e,e=>validateNoLeftRecursion(e,e,t7))}validateEmptyOrAlternatives(e){return flatMap(e,e=>validateEmptyOrAlternative(e,t7))}validateAmbiguousAlternationAlternatives(e,t){return flatMap(e,e=>validateAmbiguousAlternationAlternatives(e,t,t7))}validateSomeNonEmptyLookaheadPath(e,t){return validateSomeNonEmptyLookaheadPath(e,t,t7)}buildLookaheadForAlternation(e){return buildLookaheadFuncForOr(e.prodOccurrence,e.rule,e.maxLookahead,e.hasPredicates,e.dynamicTokensEnabled,buildAlternativesLookAheadFunc)}buildLookaheadForOptional(e){return buildLookaheadFuncForOptionalProd(e.prodOccurrence,e.rule,e.maxLookahead,e.dynamicTokensEnabled,getProdType(e.prodType),buildSingleAlternativeLookaheadFunction)}};let LooksAhead=class LooksAhead{initLooksAhead(e){this.dynamicTokensEnabled=has(e,"dynamicTokensEnabled")?e.dynamicTokensEnabled:rd.dynamicTokensEnabled,this.maxLookahead=has(e,"maxLookahead")?e.maxLookahead:rd.maxLookahead,this.lookaheadStrategy=has(e,"lookaheadStrategy")?e.lookaheadStrategy:new LLkLookaheadStrategy({maxLookahead:this.maxLookahead}),this.lookAheadFuncsCache=new Map}preComputeLookaheadFunctions(e){forEach(e,e=>{this.TRACE_INIT(`${e.name} Rule Lookahead`,()=>{let{alternation:t,repetition:r,option:i,repetitionMandatory:a,repetitionMandatoryWithSeparator:n,repetitionWithSeparator:s}=collectMethods(e);forEach(t,t=>{let r=0===t.idx?"":t.idx;this.TRACE_INIT(`${getProductionDslName(t)}${r}`,()=>{var r;let i=this.lookaheadStrategy.buildLookaheadForAlternation({prodOccurrence:t.idx,rule:e,maxLookahead:t.maxLookahead||this.maxLookahead,hasPredicates:t.hasPredicates,dynamicTokensEnabled:this.dynamicTokensEnabled}),a=(r=this.fullRuleNameToShort[e.name],256|t.idx|r);this.setLaFuncCache(a,i)})}),forEach(r,t=>{this.computeLookaheadFunc(e,t.idx,768,"Repetition",t.maxLookahead,getProductionDslName(t))}),forEach(i,t=>{this.computeLookaheadFunc(e,t.idx,512,"Option",t.maxLookahead,getProductionDslName(t))}),forEach(a,t=>{this.computeLookaheadFunc(e,t.idx,1024,"RepetitionMandatory",t.maxLookahead,getProductionDslName(t))}),forEach(n,t=>{this.computeLookaheadFunc(e,t.idx,1536,"RepetitionMandatoryWithSeparator",t.maxLookahead,getProductionDslName(t))}),forEach(s,t=>{this.computeLookaheadFunc(e,t.idx,1280,"RepetitionWithSeparator",t.maxLookahead,getProductionDslName(t))})})})}computeLookaheadFunc(e,t,r,i,a,n){this.TRACE_INIT(`${n}${0===t?"":t}`,()=>{let n=this.lookaheadStrategy.buildLookaheadForOptional({prodOccurrence:t,rule:e,maxLookahead:a||this.maxLookahead,dynamicTokensEnabled:this.dynamicTokensEnabled,prodType:i}),s=t|r|this.fullRuleNameToShort[e.name];this.setLaFuncCache(s,n)})}getKeyForAutomaticLookahead(e,t){let r=this.getLastExplicitRuleShortName();return t|e|r}getLaFuncFromCache(e){return this.lookAheadFuncsCache.get(e)}setLaFuncCache(e,t){this.lookAheadFuncsCache.set(e,t)}};let DslMethodsCollectorVisitor=class DslMethodsCollectorVisitor extends GAstVisitor{constructor(){super(...arguments),this.dslMethods={option:[],alternation:[],repetition:[],repetitionWithSeparator:[],repetitionMandatory:[],repetitionMandatoryWithSeparator:[]}}reset(){this.dslMethods={option:[],alternation:[],repetition:[],repetitionWithSeparator:[],repetitionMandatory:[],repetitionMandatoryWithSeparator:[]}}visitOption(e){this.dslMethods.option.push(e)}visitRepetitionWithSeparator(e){this.dslMethods.repetitionWithSeparator.push(e)}visitRepetitionMandatory(e){this.dslMethods.repetitionMandatory.push(e)}visitRepetitionMandatoryWithSeparator(e){this.dslMethods.repetitionMandatoryWithSeparator.push(e)}visitRepetition(e){this.dslMethods.repetition.push(e)}visitAlternation(e){this.dslMethods.alternation.push(e)}};let ro=new DslMethodsCollectorVisitor;function collectMethods(e){ro.reset(),e.accept(ro);let t=ro.dslMethods;return ro.reset(),t}function setNodeLocationOnlyOffset(e,t){!0===isNaN(e.startOffset)?(e.startOffset=t.startOffset,e.endOffset=t.endOffset):e.endOffset<t.endOffset==!0&&(e.endOffset=t.endOffset)}function setNodeLocationFull(e,t){!0===isNaN(e.startOffset)?(e.startOffset=t.startOffset,e.startColumn=t.startColumn,e.startLine=t.startLine,e.endOffset=t.endOffset,e.endColumn=t.endColumn,e.endLine=t.endLine):e.endOffset<t.endOffset==!0&&(e.endOffset=t.endOffset,e.endColumn=t.endColumn,e.endLine=t.endLine)}function addTerminalToCst(e,t,r){void 0===e.children[r]?e.children[r]=[t]:e.children[r].push(t)}function addNoneTerminalToCst(e,t,r){void 0===e.children[t]?e.children[t]=[r]:e.children[t].push(r)}function defineNameProp(e,t){Object.defineProperty(e,"name",{enumerable:!1,configurable:!0,writable:!1,value:t})}function defaultVisit(e,t){let r=keys(e),i=r.length;for(let a=0;a<i;a++){let i=r[a],n=e[i],s=n.length;for(let e=0;e<s;e++){let r=n[e];void 0===r.tokenTypeIdx&&this[r.name](r.children,t)}}}function createBaseSemanticVisitorConstructor(e,t){let derivedConstructor=function(){};return defineNameProp(derivedConstructor,e+"BaseSemantics"),derivedConstructor.prototype={visit:function(e,t){if(E(e)&&(e=e[0]),!isUndefined(e))return this[e.name](e.children,t)},validateVisitor:function(){let e=validateVisitor(this,t);if(!isEmpty(e)){let t=map(e,e=>e.msg);throw Error(`Errors Detected in CST Visitor <${this.constructor.name}>:
	${t.join("\n\n").replace(/\n/g,"\n	")}`)}}},derivedConstructor.prototype.constructor=derivedConstructor,derivedConstructor._RULE_NAMES=t,derivedConstructor}function createBaseVisitorConstructorWithDefaults(e,t,r){let derivedConstructor=function(){};defineNameProp(derivedConstructor,e+"BaseSemanticsWithDefaults");let i=Object.create(r.prototype);return forEach(t,e=>{i[e]=defaultVisit}),derivedConstructor.prototype=i,derivedConstructor.prototype.constructor=derivedConstructor,derivedConstructor}function validateVisitor(e,t){let r=validateMissingCstMethods(e,t);return r}function validateMissingCstMethods(e,t){let r=filter(t,t=>!1===isFunction(e[t])),i=map(r,t=>({msg:`Missing visitor method: <${t}> on ${e.constructor.name} CST Visitor.`,type:h.MISSING_METHOD,methodName:t}));return compact(i)}(o=h||(h={}))[o.REDUNDANT_METHOD=0]="REDUNDANT_METHOD",o[o.MISSING_METHOD=1]="MISSING_METHOD";let TreeBuilder=class TreeBuilder{initTreeBuilder(e){if(this.CST_STACK=[],this.outputCst=e.outputCst,this.nodeLocationTracking=has(e,"nodeLocationTracking")?e.nodeLocationTracking:rd.nodeLocationTracking,this.outputCst){if(/full/i.test(this.nodeLocationTracking))this.recoveryEnabled?(this.setNodeLocationFromToken=setNodeLocationFull,this.setNodeLocationFromNode=setNodeLocationFull,this.cstPostRule=noop,this.setInitialNodeLocation=this.setInitialNodeLocationFullRecovery):(this.setNodeLocationFromToken=noop,this.setNodeLocationFromNode=noop,this.cstPostRule=this.cstPostRuleFull,this.setInitialNodeLocation=this.setInitialNodeLocationFullRegular);else if(/onlyOffset/i.test(this.nodeLocationTracking))this.recoveryEnabled?(this.setNodeLocationFromToken=setNodeLocationOnlyOffset,this.setNodeLocationFromNode=setNodeLocationOnlyOffset,this.cstPostRule=noop,this.setInitialNodeLocation=this.setInitialNodeLocationOnlyOffsetRecovery):(this.setNodeLocationFromToken=noop,this.setNodeLocationFromNode=noop,this.cstPostRule=this.cstPostRuleOnlyOffset,this.setInitialNodeLocation=this.setInitialNodeLocationOnlyOffsetRegular);else if(/none/i.test(this.nodeLocationTracking))this.setNodeLocationFromToken=noop,this.setNodeLocationFromNode=noop,this.cstPostRule=noop,this.setInitialNodeLocation=noop;else throw Error(`Invalid <nodeLocationTracking> config option: "${e.nodeLocationTracking}"`)}else this.cstInvocationStateUpdate=noop,this.cstFinallyStateUpdate=noop,this.cstPostTerminal=noop,this.cstPostNonTerminal=noop,this.cstPostRule=noop}setInitialNodeLocationOnlyOffsetRecovery(e){e.location={startOffset:NaN,endOffset:NaN}}setInitialNodeLocationOnlyOffsetRegular(e){e.location={startOffset:this.LA(1).startOffset,endOffset:NaN}}setInitialNodeLocationFullRecovery(e){e.location={startOffset:NaN,startLine:NaN,startColumn:NaN,endOffset:NaN,endLine:NaN,endColumn:NaN}}setInitialNodeLocationFullRegular(e){let t=this.LA(1);e.location={startOffset:t.startOffset,startLine:t.startLine,startColumn:t.startColumn,endOffset:NaN,endLine:NaN,endColumn:NaN}}cstInvocationStateUpdate(e){let t={name:e,children:Object.create(null)};this.setInitialNodeLocation(t),this.CST_STACK.push(t)}cstFinallyStateUpdate(){this.CST_STACK.pop()}cstPostRuleFull(e){let t=this.LA(0),r=e.location;r.startOffset<=t.startOffset==!0?(r.endOffset=t.endOffset,r.endLine=t.endLine,r.endColumn=t.endColumn):(r.startOffset=NaN,r.startLine=NaN,r.startColumn=NaN)}cstPostRuleOnlyOffset(e){let t=this.LA(0),r=e.location;r.startOffset<=t.startOffset==!0?r.endOffset=t.endOffset:r.startOffset=NaN}cstPostTerminal(e,t){let r=this.CST_STACK[this.CST_STACK.length-1];addTerminalToCst(r,t,e),this.setNodeLocationFromToken(r.location,t)}cstPostNonTerminal(e,t){let r=this.CST_STACK[this.CST_STACK.length-1];addNoneTerminalToCst(r,t,e),this.setNodeLocationFromNode(r.location,e.location)}getBaseCstVisitorConstructor(){if(isUndefined(this.baseCstVisitorConstructor)){let e=createBaseSemanticVisitorConstructor(this.className,keys(this.gastProductionsCache));return this.baseCstVisitorConstructor=e,e}return this.baseCstVisitorConstructor}getBaseCstVisitorConstructorWithDefaults(){if(isUndefined(this.baseCstVisitorWithDefaultsConstructor)){let e=createBaseVisitorConstructorWithDefaults(this.className,keys(this.gastProductionsCache),this.getBaseCstVisitorConstructor());return this.baseCstVisitorWithDefaultsConstructor=e,e}return this.baseCstVisitorWithDefaultsConstructor}getLastExplicitRuleShortName(){let e=this.RULE_STACK;return e[e.length-1]}getPreviousExplicitRuleShortName(){let e=this.RULE_STACK;return e[e.length-2]}getLastExplicitRuleOccurrenceIndex(){let e=this.RULE_OCCURRENCE_STACK;return e[e.length-1]}};let LexerAdapter=class LexerAdapter{initLexerAdapter(){this.tokVector=[],this.tokVectorLength=0,this.currIdx=-1}set input(e){if(!0!==this.selfAnalysisDone)throw Error("Missing <performSelfAnalysis> invocation at the end of the Parser's constructor.");this.reset(),this.tokVector=e,this.tokVectorLength=e.length}get input(){return this.tokVector}SKIP_TOKEN(){return this.currIdx<=this.tokVector.length-2?(this.consumeToken(),this.LA(1)):rp}LA(e){let t=this.currIdx+e;return t<0||this.tokVectorLength<=t?rp:this.tokVector[t]}consumeToken(){this.currIdx++}exportLexerState(){return this.currIdx}importLexerState(e){this.currIdx=e}resetLexerState(){this.currIdx=-1}moveToTerminatedState(){this.currIdx=this.tokVector.length-1}getLexerPosition(){return this.exportLexerState()}};let RecognizerApi=class RecognizerApi{ACTION(e){return e.call(this)}consume(e,t,r){return this.consumeInternal(t,e,r)}subrule(e,t,r){return this.subruleInternal(t,e,r)}option(e,t){return this.optionInternal(t,e)}or(e,t){return this.orInternal(t,e)}many(e,t){return this.manyInternal(e,t)}atLeastOne(e,t){return this.atLeastOneInternal(e,t)}CONSUME(e,t){return this.consumeInternal(e,0,t)}CONSUME1(e,t){return this.consumeInternal(e,1,t)}CONSUME2(e,t){return this.consumeInternal(e,2,t)}CONSUME3(e,t){return this.consumeInternal(e,3,t)}CONSUME4(e,t){return this.consumeInternal(e,4,t)}CONSUME5(e,t){return this.consumeInternal(e,5,t)}CONSUME6(e,t){return this.consumeInternal(e,6,t)}CONSUME7(e,t){return this.consumeInternal(e,7,t)}CONSUME8(e,t){return this.consumeInternal(e,8,t)}CONSUME9(e,t){return this.consumeInternal(e,9,t)}SUBRULE(e,t){return this.subruleInternal(e,0,t)}SUBRULE1(e,t){return this.subruleInternal(e,1,t)}SUBRULE2(e,t){return this.subruleInternal(e,2,t)}SUBRULE3(e,t){return this.subruleInternal(e,3,t)}SUBRULE4(e,t){return this.subruleInternal(e,4,t)}SUBRULE5(e,t){return this.subruleInternal(e,5,t)}SUBRULE6(e,t){return this.subruleInternal(e,6,t)}SUBRULE7(e,t){return this.subruleInternal(e,7,t)}SUBRULE8(e,t){return this.subruleInternal(e,8,t)}SUBRULE9(e,t){return this.subruleInternal(e,9,t)}OPTION(e){return this.optionInternal(e,0)}OPTION1(e){return this.optionInternal(e,1)}OPTION2(e){return this.optionInternal(e,2)}OPTION3(e){return this.optionInternal(e,3)}OPTION4(e){return this.optionInternal(e,4)}OPTION5(e){return this.optionInternal(e,5)}OPTION6(e){return this.optionInternal(e,6)}OPTION7(e){return this.optionInternal(e,7)}OPTION8(e){return this.optionInternal(e,8)}OPTION9(e){return this.optionInternal(e,9)}OR(e){return this.orInternal(e,0)}OR1(e){return this.orInternal(e,1)}OR2(e){return this.orInternal(e,2)}OR3(e){return this.orInternal(e,3)}OR4(e){return this.orInternal(e,4)}OR5(e){return this.orInternal(e,5)}OR6(e){return this.orInternal(e,6)}OR7(e){return this.orInternal(e,7)}OR8(e){return this.orInternal(e,8)}OR9(e){return this.orInternal(e,9)}MANY(e){this.manyInternal(0,e)}MANY1(e){this.manyInternal(1,e)}MANY2(e){this.manyInternal(2,e)}MANY3(e){this.manyInternal(3,e)}MANY4(e){this.manyInternal(4,e)}MANY5(e){this.manyInternal(5,e)}MANY6(e){this.manyInternal(6,e)}MANY7(e){this.manyInternal(7,e)}MANY8(e){this.manyInternal(8,e)}MANY9(e){this.manyInternal(9,e)}MANY_SEP(e){this.manySepFirstInternal(0,e)}MANY_SEP1(e){this.manySepFirstInternal(1,e)}MANY_SEP2(e){this.manySepFirstInternal(2,e)}MANY_SEP3(e){this.manySepFirstInternal(3,e)}MANY_SEP4(e){this.manySepFirstInternal(4,e)}MANY_SEP5(e){this.manySepFirstInternal(5,e)}MANY_SEP6(e){this.manySepFirstInternal(6,e)}MANY_SEP7(e){this.manySepFirstInternal(7,e)}MANY_SEP8(e){this.manySepFirstInternal(8,e)}MANY_SEP9(e){this.manySepFirstInternal(9,e)}AT_LEAST_ONE(e){this.atLeastOneInternal(0,e)}AT_LEAST_ONE1(e){return this.atLeastOneInternal(1,e)}AT_LEAST_ONE2(e){this.atLeastOneInternal(2,e)}AT_LEAST_ONE3(e){this.atLeastOneInternal(3,e)}AT_LEAST_ONE4(e){this.atLeastOneInternal(4,e)}AT_LEAST_ONE5(e){this.atLeastOneInternal(5,e)}AT_LEAST_ONE6(e){this.atLeastOneInternal(6,e)}AT_LEAST_ONE7(e){this.atLeastOneInternal(7,e)}AT_LEAST_ONE8(e){this.atLeastOneInternal(8,e)}AT_LEAST_ONE9(e){this.atLeastOneInternal(9,e)}AT_LEAST_ONE_SEP(e){this.atLeastOneSepFirstInternal(0,e)}AT_LEAST_ONE_SEP1(e){this.atLeastOneSepFirstInternal(1,e)}AT_LEAST_ONE_SEP2(e){this.atLeastOneSepFirstInternal(2,e)}AT_LEAST_ONE_SEP3(e){this.atLeastOneSepFirstInternal(3,e)}AT_LEAST_ONE_SEP4(e){this.atLeastOneSepFirstInternal(4,e)}AT_LEAST_ONE_SEP5(e){this.atLeastOneSepFirstInternal(5,e)}AT_LEAST_ONE_SEP6(e){this.atLeastOneSepFirstInternal(6,e)}AT_LEAST_ONE_SEP7(e){this.atLeastOneSepFirstInternal(7,e)}AT_LEAST_ONE_SEP8(e){this.atLeastOneSepFirstInternal(8,e)}AT_LEAST_ONE_SEP9(e){this.atLeastOneSepFirstInternal(9,e)}RULE(e,t,r=rf){if(includes(this.definedRulesNames,e)){let t=t7.buildDuplicateRuleNameError({topLevelRule:e,grammarName:this.className}),r={message:t,type:p.DUPLICATE_RULE_NAME,ruleName:e};this.definitionErrors.push(r)}this.definedRulesNames.push(e);let i=this.defineRule(e,t,r);return this[e]=i,i}OVERRIDE_RULE(e,t,r=rf){let i=validateRuleIsOverridden(e,this.definedRulesNames,this.className);this.definitionErrors=this.definitionErrors.concat(i);let a=this.defineRule(e,t,r);return this[e]=a,a}BACKTRACK(e,t){return function(){this.isBackTrackingStack.push(1);let r=this.saveRecogState();try{return e.apply(this,t),!0}catch(e){if(isRecognitionException(e))return!1;throw e}finally{this.reloadRecogState(r),this.isBackTrackingStack.pop()}}}getGAstProductions(){return this.gastProductionsCache}getSerializedGastProductions(){return serializeGrammar(values(this.gastProductionsCache))}};let RecognizerEngine=class RecognizerEngine{initRecognizerEngine(e,t){if(this.className=this.constructor.name,this.shortRuleNameToFull={},this.fullRuleNameToShort={},this.ruleShortNameIdx=256,this.tokenMatcher=tokenStructuredMatcherNoCategories,this.subruleIdx=0,this.definedRulesNames=[],this.tokensMap={},this.isBackTrackingStack=[],this.RULE_STACK=[],this.RULE_OCCURRENCE_STACK=[],this.gastProductionsCache={},has(t,"serializedGrammar"))throw Error("The Parser's configuration can no longer contain a <serializedGrammar> property.\n	See: https://chevrotain.io/docs/changes/BREAKING_CHANGES.html#_6-0-0\n	For Further details.");if(E(e)){if(isEmpty(e))throw Error("A Token Vocabulary cannot be empty.\n	Note that the first argument for the parser constructor\n	is no longer a Token vector (since v4.0).");if("number"==typeof e[0].startOffset)throw Error("The Parser constructor no longer accepts a token vector as the first argument.\n	See: https://chevrotain.io/docs/changes/BREAKING_CHANGES.html#_4-0-0\n	For Further details.")}if(E(e))this.tokensMap=reduce(e,(e,t)=>(e[t.name]=t,e),{});else if(has(e,"modes")&&every(flatten(values(e.modes)),isTokenType)){let t=flatten(values(e.modes)),r=uniq(t);this.tokensMap=reduce(r,(e,t)=>(e[t.name]=t,e),{})}else if(isObject(e))this.tokensMap=clone2(e);else throw Error("<tokensDictionary> argument must be An Array of Token constructors, A dictionary of Token constructors or an IMultiModeLexerDefinition");this.tokensMap.EOF=t6;let r=has(e,"modes")?flatten(values(e.modes)):values(e),i=every(r,e=>isEmpty(e.categoryMatches));this.tokenMatcher=i?tokenStructuredMatcherNoCategories:tokenStructuredMatcher,augmentTokenTypes(values(this.tokensMap))}defineRule(e,t,r){let i;if(this.selfAnalysisDone)throw Error(`Grammar rule <${e}> may not be defined after the 'performSelfAnalysis' method has been called'
Make sure that all grammar rule definitions are done before 'performSelfAnalysis' is called.`);let a=has(r,"resyncEnabled")?r.resyncEnabled:rf.resyncEnabled,n=has(r,"recoveryValueFunc")?r.recoveryValueFunc:rf.recoveryValueFunc,s=this.ruleShortNameIdx<<12;this.ruleShortNameIdx++,this.shortRuleNameToFull[s]=e,this.fullRuleNameToShort[e]=s,i=!0===this.outputCst?function(...r){try{this.ruleInvocationStateUpdate(s,e,this.subruleIdx),t.apply(this,r);let i=this.CST_STACK[this.CST_STACK.length-1];return this.cstPostRule(i),i}catch(e){return this.invokeRuleCatch(e,a,n)}finally{this.ruleFinallyStateUpdate()}}:function(...r){try{return this.ruleInvocationStateUpdate(s,e,this.subruleIdx),t.apply(this,r)}catch(e){return this.invokeRuleCatch(e,a,n)}finally{this.ruleFinallyStateUpdate()}};let o=Object.assign(i,{ruleName:e,originalGrammarAction:t});return o}invokeRuleCatch(e,t,r){let i=1===this.RULE_STACK.length,a=t&&!this.isBackTracking()&&this.recoveryEnabled;if(isRecognitionException(e)){if(a){let t=this.findReSyncTokenType();if(this.isInCurrentRuleReSyncSet(t)){if(e.resyncedTokens=this.reSyncTo(t),!this.outputCst)return r(e);{let e=this.CST_STACK[this.CST_STACK.length-1];return e.recoveredNode=!0,e}}if(this.outputCst){let t=this.CST_STACK[this.CST_STACK.length-1];t.recoveredNode=!0,e.partialCstResult=t}throw e}if(i)return this.moveToTerminatedState(),r(e)}throw e}optionInternal(e,t){let r=this.getKeyForAutomaticLookahead(512,t);return this.optionInternalLogic(e,t,r)}optionInternalLogic(e,t,r){let i,a=this.getLaFuncFromCache(r);if("function"!=typeof e){i=e.DEF;let t=e.GATE;if(void 0!==t){let e=a;a=()=>t.call(this)&&e.call(this)}}else i=e;if(!0===a.call(this))return i.call(this)}atLeastOneInternal(e,t){let r=this.getKeyForAutomaticLookahead(1024,e);return this.atLeastOneInternalLogic(e,t,r)}atLeastOneInternalLogic(e,t,r){let i,a=this.getLaFuncFromCache(r);if("function"!=typeof t){i=t.DEF;let e=t.GATE;if(void 0!==e){let t=a;a=()=>e.call(this)&&t.call(this)}}else i=t;if(!0===a.call(this)){let e=this.doSingleRepetition(i);for(;!0===a.call(this)&&!0===e;)e=this.doSingleRepetition(i)}else throw this.raiseEarlyExitException(e,u.REPETITION_MANDATORY,t.ERR_MSG);this.attemptInRepetitionRecovery(this.atLeastOneInternal,[e,t],a,1024,e,NextTerminalAfterAtLeastOneWalker)}atLeastOneSepFirstInternal(e,t){let r=this.getKeyForAutomaticLookahead(1536,e);this.atLeastOneSepFirstInternalLogic(e,t,r)}atLeastOneSepFirstInternalLogic(e,t,r){let i=t.DEF,a=t.SEP,n=this.getLaFuncFromCache(r);if(!0===n.call(this)){i.call(this);let separatorLookAheadFunc=()=>this.tokenMatcher(this.LA(1),a);for(;!0===this.tokenMatcher(this.LA(1),a);)this.CONSUME(a),i.call(this);this.attemptInRepetitionRecovery(this.repetitionSepSecondInternal,[e,a,separatorLookAheadFunc,i,NextTerminalAfterAtLeastOneSepWalker],separatorLookAheadFunc,1536,e,NextTerminalAfterAtLeastOneSepWalker)}else throw this.raiseEarlyExitException(e,u.REPETITION_MANDATORY_WITH_SEPARATOR,t.ERR_MSG)}manyInternal(e,t){let r=this.getKeyForAutomaticLookahead(768,e);return this.manyInternalLogic(e,t,r)}manyInternalLogic(e,t,r){let i,a=this.getLaFuncFromCache(r);if("function"!=typeof t){i=t.DEF;let e=t.GATE;if(void 0!==e){let t=a;a=()=>e.call(this)&&t.call(this)}}else i=t;let n=!0;for(;!0===a.call(this)&&!0===n;)n=this.doSingleRepetition(i);this.attemptInRepetitionRecovery(this.manyInternal,[e,t],a,768,e,NextTerminalAfterManyWalker,n)}manySepFirstInternal(e,t){let r=this.getKeyForAutomaticLookahead(1280,e);this.manySepFirstInternalLogic(e,t,r)}manySepFirstInternalLogic(e,t,r){let i=t.DEF,a=t.SEP,n=this.getLaFuncFromCache(r);if(!0===n.call(this)){i.call(this);let separatorLookAheadFunc=()=>this.tokenMatcher(this.LA(1),a);for(;!0===this.tokenMatcher(this.LA(1),a);)this.CONSUME(a),i.call(this);this.attemptInRepetitionRecovery(this.repetitionSepSecondInternal,[e,a,separatorLookAheadFunc,i,NextTerminalAfterManySepWalker],separatorLookAheadFunc,1280,e,NextTerminalAfterManySepWalker)}}repetitionSepSecondInternal(e,t,r,i,a){for(;r();)this.CONSUME(t),i.call(this);this.attemptInRepetitionRecovery(this.repetitionSepSecondInternal,[e,t,r,i,a],r,1536,e,a)}doSingleRepetition(e){let t=this.getLexerPosition();e.call(this);let r=this.getLexerPosition();return r>t}orInternal(e,t){let r=this.getKeyForAutomaticLookahead(256,t),i=E(e)?e:e.DEF,a=this.getLaFuncFromCache(r),n=a.call(this,i);if(void 0!==n){let e=i[n];return e.ALT.call(this)}this.raiseNoAltException(t,e.ERR_MSG)}ruleFinallyStateUpdate(){if(this.RULE_STACK.pop(),this.RULE_OCCURRENCE_STACK.pop(),this.cstFinallyStateUpdate(),0===this.RULE_STACK.length&&!1===this.isAtEndOfInput()){let e=this.LA(1),t=this.errorMessageProvider.buildNotAllInputParsedMessage({firstRedundant:e,ruleName:this.getCurrRuleFullName()});this.SAVE_ERROR(new NotAllInputParsedException(t,e))}}subruleInternal(e,t,r){let i;try{let a=void 0!==r?r.ARGS:void 0;return this.subruleIdx=t,i=e.apply(this,a),this.cstPostNonTerminal(i,void 0!==r&&void 0!==r.LABEL?r.LABEL:e.ruleName),i}catch(t){throw this.subruleInternalError(t,r,e.ruleName)}}subruleInternalError(e,t,r){throw isRecognitionException(e)&&void 0!==e.partialCstResult&&(this.cstPostNonTerminal(e.partialCstResult,void 0!==t&&void 0!==t.LABEL?t.LABEL:r),delete e.partialCstResult),e}consumeInternal(e,t,r){let i;try{let t=this.LA(1);!0===this.tokenMatcher(t,e)?(this.consumeToken(),i=t):this.consumeInternalError(e,t,r)}catch(r){i=this.consumeInternalRecovery(e,t,r)}return this.cstPostTerminal(void 0!==r&&void 0!==r.LABEL?r.LABEL:e.name,i),i}consumeInternalError(e,t,r){let i;let a=this.LA(0);throw i=void 0!==r&&r.ERR_MSG?r.ERR_MSG:this.errorMessageProvider.buildMismatchTokenMessage({expected:e,actual:t,previous:a,ruleName:this.getCurrRuleFullName()}),this.SAVE_ERROR(new MismatchedTokenException(i,t,a))}consumeInternalRecovery(e,t,r){if(this.recoveryEnabled&&"MismatchedTokenException"===r.name&&!this.isBackTracking()){let i=this.getFollowsForInRuleRecovery(e,t);try{return this.tryInRuleRecovery(e,i)}catch(e){if(e.name===rs)throw r;throw e}}else throw r}saveRecogState(){let e=this.errors,t=clone2(this.RULE_STACK);return{errors:e,lexerState:this.exportLexerState(),RULE_STACK:t,CST_STACK:this.CST_STACK}}reloadRecogState(e){this.errors=e.errors,this.importLexerState(e.lexerState),this.RULE_STACK=e.RULE_STACK}ruleInvocationStateUpdate(e,t,r){this.RULE_OCCURRENCE_STACK.push(r),this.RULE_STACK.push(e),this.cstInvocationStateUpdate(t)}isBackTracking(){return 0!==this.isBackTrackingStack.length}getCurrRuleFullName(){let e=this.getLastExplicitRuleShortName();return this.shortRuleNameToFull[e]}shortRuleNameToFullName(e){return this.shortRuleNameToFull[e]}isAtEndOfInput(){return this.tokenMatcher(this.LA(1),t6)}reset(){this.resetLexerState(),this.subruleIdx=0,this.isBackTrackingStack=[],this.errors=[],this.RULE_STACK=[],this.CST_STACK=[],this.RULE_OCCURRENCE_STACK=[]}};let ErrorHandler=class ErrorHandler{initErrorHandler(e){this._errors=[],this.errorMessageProvider=has(e,"errorMessageProvider")?e.errorMessageProvider:rd.errorMessageProvider}SAVE_ERROR(e){if(isRecognitionException(e))return e.context={ruleStack:this.getHumanReadableRuleStack(),ruleOccurrenceStack:clone2(this.RULE_OCCURRENCE_STACK)},this._errors.push(e),e;throw Error("Trying to save an Error which is not a RecognitionException")}get errors(){return clone2(this._errors)}set errors(e){this._errors=e}raiseEarlyExitException(e,t,r){let i=this.getCurrRuleFullName(),a=this.getGAstProductions()[i],n=getLookaheadPathsForOptionalProd(e,a,t,this.maxLookahead),s=n[0],o=[];for(let e=1;e<=this.maxLookahead;e++)o.push(this.LA(e));let l=this.errorMessageProvider.buildEarlyExitMessage({expectedIterationPaths:s,actual:o,previous:this.LA(0),customUserDescription:r,ruleName:i});throw this.SAVE_ERROR(new EarlyExitException(l,this.LA(1),this.LA(0)))}raiseNoAltException(e,t){let r=this.getCurrRuleFullName(),i=this.getGAstProductions()[r],a=getLookaheadPathsForOr(e,i,this.maxLookahead),n=[];for(let e=1;e<=this.maxLookahead;e++)n.push(this.LA(e));let s=this.LA(0),o=this.errorMessageProvider.buildNoViableAltMessage({expectedPathsPerAlt:a,actual:n,previous:s,customUserDescription:t,ruleName:this.getCurrRuleFullName()});throw this.SAVE_ERROR(new NoViableAltException(o,this.LA(1),s))}};let ContentAssist=class ContentAssist{initContentAssist(){}computeContentAssist(e,t){let r=this.gastProductionsCache[e];if(isUndefined(r))throw Error(`Rule ->${e}<- does not exist in this grammar.`);return nextPossibleTokensAfter([r],t,this.tokenMatcher,this.maxLookahead)}getNextPossibleTokenTypes(e){let t=head(e.ruleStack),r=this.getGAstProductions(),i=r[t],a=new NextAfterTokenWalker(i,e).startWalking();return a}};let rl={description:"This Object indicates the Parser is during Recording Phase"};Object.freeze(rl);let rc=createTokenInternal({name:"RECORDING_PHASE_TOKEN",pattern:Lexer2.NA});augmentTokenTypes([rc]);let ru=createTokenInstance(rc,"This IToken indicates the Parser is in Recording Phase\n	See: https://chevrotain.io/docs/guide/internals.html#grammar-recording for details",-1,-1,-1,-1,-1,-1);Object.freeze(ru);let rh={name:"This CSTNode indicates the Parser is in Recording Phase\n	See: https://chevrotain.io/docs/guide/internals.html#grammar-recording for details",children:{}};let GastRecorder=class GastRecorder{initGastRecorder(e){this.recordingProdStack=[],this.RECORDING_PHASE=!1}enableRecording(){this.RECORDING_PHASE=!0,this.TRACE_INIT("Enable Recording",()=>{for(let e=0;e<10;e++){let t=e>0?e:"";this[`CONSUME${t}`]=function(t,r){return this.consumeInternalRecord(t,e,r)},this[`SUBRULE${t}`]=function(t,r){return this.subruleInternalRecord(t,e,r)},this[`OPTION${t}`]=function(t){return this.optionInternalRecord(t,e)},this[`OR${t}`]=function(t){return this.orInternalRecord(t,e)},this[`MANY${t}`]=function(t){this.manyInternalRecord(e,t)},this[`MANY_SEP${t}`]=function(t){this.manySepFirstInternalRecord(e,t)},this[`AT_LEAST_ONE${t}`]=function(t){this.atLeastOneInternalRecord(e,t)},this[`AT_LEAST_ONE_SEP${t}`]=function(t){this.atLeastOneSepFirstInternalRecord(e,t)}}this.consume=function(e,t,r){return this.consumeInternalRecord(t,e,r)},this.subrule=function(e,t,r){return this.subruleInternalRecord(t,e,r)},this.option=function(e,t){return this.optionInternalRecord(t,e)},this.or=function(e,t){return this.orInternalRecord(t,e)},this.many=function(e,t){this.manyInternalRecord(e,t)},this.atLeastOne=function(e,t){this.atLeastOneInternalRecord(e,t)},this.ACTION=this.ACTION_RECORD,this.BACKTRACK=this.BACKTRACK_RECORD,this.LA=this.LA_RECORD})}disableRecording(){this.RECORDING_PHASE=!1,this.TRACE_INIT("Deleting Recording methods",()=>{for(let e=0;e<10;e++){let t=e>0?e:"";delete this[`CONSUME${t}`],delete this[`SUBRULE${t}`],delete this[`OPTION${t}`],delete this[`OR${t}`],delete this[`MANY${t}`],delete this[`MANY_SEP${t}`],delete this[`AT_LEAST_ONE${t}`],delete this[`AT_LEAST_ONE_SEP${t}`]}delete this.consume,delete this.subrule,delete this.option,delete this.or,delete this.many,delete this.atLeastOne,delete this.ACTION,delete this.BACKTRACK,delete this.LA})}ACTION_RECORD(e){}BACKTRACK_RECORD(e,t){return()=>!0}LA_RECORD(e){return rp}topLevelRuleRecord(e,t){try{let r=new Rule({definition:[],name:e});return r.name=e,this.recordingProdStack.push(r),t.call(this),this.recordingProdStack.pop(),r}catch(e){if(!0!==e.KNOWN_RECORDER_ERROR)try{e.message=e.message+'\n	 This error was thrown during the "grammar recording phase" For more info see:\n	https://chevrotain.io/docs/guide/internals.html#grammar-recording'}catch(t){throw e}throw e}}optionInternalRecord(e,t){return recordProd.call(this,Option,e,t)}atLeastOneInternalRecord(e,t){recordProd.call(this,RepetitionMandatory,t,e)}atLeastOneSepFirstInternalRecord(e,t){recordProd.call(this,RepetitionMandatoryWithSeparator,t,e,!0)}manyInternalRecord(e,t){recordProd.call(this,Repetition,t,e)}manySepFirstInternalRecord(e,t){recordProd.call(this,RepetitionWithSeparator,t,e,!0)}orInternalRecord(e,t){return recordOrProd.call(this,e,t)}subruleInternalRecord(e,t,r){if(assertMethodIdxIsValid(t),!e||!1===has(e,"ruleName")){let r=Error(`<SUBRULE${getIdxSuffix(t)}> argument is invalid expecting a Parser method reference but got: <${JSON.stringify(e)}>
 inside top level rule: <${this.recordingProdStack[0].name}>`);throw r.KNOWN_RECORDER_ERROR=!0,r}let i=last(this.recordingProdStack),a=e.ruleName,n=new NonTerminal({idx:t,nonTerminalName:a,label:null==r?void 0:r.LABEL,referencedRule:void 0});return i.definition.push(n),this.outputCst?rh:rl}consumeInternalRecord(e,t,r){if(assertMethodIdxIsValid(t),!hasShortKeyProperty(e)){let r=Error(`<CONSUME${getIdxSuffix(t)}> argument is invalid expecting a TokenType reference but got: <${JSON.stringify(e)}>
 inside top level rule: <${this.recordingProdStack[0].name}>`);throw r.KNOWN_RECORDER_ERROR=!0,r}let i=last(this.recordingProdStack),a=new Terminal({idx:t,terminalType:e,label:null==r?void 0:r.LABEL});return i.definition.push(a),ru}};function recordProd(e,t,r,i=!1){assertMethodIdxIsValid(r);let a=last(this.recordingProdStack),n=isFunction(t)?t:t.DEF,s=new e({definition:[],idx:r});return i&&(s.separator=t.SEP),has(t,"MAX_LOOKAHEAD")&&(s.maxLookahead=t.MAX_LOOKAHEAD),this.recordingProdStack.push(s),n.call(this),a.definition.push(s),this.recordingProdStack.pop(),rl}function recordOrProd(e,t){assertMethodIdxIsValid(t);let r=last(this.recordingProdStack),i=!1===E(e),a=!1===i?e:e.DEF,n=new Alternation({definition:[],idx:t,ignoreAmbiguities:i&&!0===e.IGNORE_AMBIGUITIES});has(e,"MAX_LOOKAHEAD")&&(n.maxLookahead=e.MAX_LOOKAHEAD);let s=some(a,e=>isFunction(e.GATE));return n.hasPredicates=s,r.definition.push(n),forEach(a,e=>{let t=new Alternative({definition:[]});n.definition.push(t),has(e,"IGNORE_AMBIGUITIES")?t.ignoreAmbiguities=e.IGNORE_AMBIGUITIES:has(e,"GATE")&&(t.ignoreAmbiguities=!0),this.recordingProdStack.push(t),e.ALT.call(this),this.recordingProdStack.pop()}),rl}function getIdxSuffix(e){return 0===e?"":`${e}`}function assertMethodIdxIsValid(e){if(e<0||e>255){let t=Error(`Invalid DSL Method idx value: <${e}>
	Idx value must be a none negative value smaller than 256`);throw t.KNOWN_RECORDER_ERROR=!0,t}}let PerformanceTracer=class PerformanceTracer{initPerformanceTracer(e){if(has(e,"traceInitPerf")){let t=e.traceInitPerf,r="number"==typeof t;this.traceInitMaxIdent=r?t:1/0,this.traceInitPerf=r?t>0:t}else this.traceInitMaxIdent=0,this.traceInitPerf=rd.traceInitPerf;this.traceInitIndent=-1}TRACE_INIT(e,t){if(!0!==this.traceInitPerf)return t();{this.traceInitIndent++;let r=Array(this.traceInitIndent+1).join("	");this.traceInitIndent<this.traceInitMaxIdent&&console.log(`${r}--> <${e}>`);let{time:i,value:a}=timer(t),n=i>10?console.warn:console.log;return this.traceInitIndent<this.traceInitMaxIdent&&n(`${r}<-- <${e}> time: ${i}ms`),this.traceInitIndent--,a}}};function applyMixins(e,t){t.forEach(t=>{let r=t.prototype;Object.getOwnPropertyNames(r).forEach(i=>{if("constructor"===i)return;let a=Object.getOwnPropertyDescriptor(r,i);a&&(a.get||a.set)?Object.defineProperty(e.prototype,i,a):e.prototype[i]=t.prototype[i]})})}let rp=createTokenInstance(t6,"",NaN,NaN,NaN,NaN,NaN,NaN);Object.freeze(rp);let rd=Object.freeze({recoveryEnabled:!1,maxLookahead:3,dynamicTokensEnabled:!1,outputCst:!0,errorMessageProvider:t8,nodeLocationTracking:"none",traceInitPerf:!1,skipValidations:!1}),rf=Object.freeze({recoveryValueFunc:()=>void 0,resyncEnabled:!0});(l=p||(p={}))[l.INVALID_RULE_NAME=0]="INVALID_RULE_NAME",l[l.DUPLICATE_RULE_NAME=1]="DUPLICATE_RULE_NAME",l[l.INVALID_RULE_OVERRIDE=2]="INVALID_RULE_OVERRIDE",l[l.DUPLICATE_PRODUCTIONS=3]="DUPLICATE_PRODUCTIONS",l[l.UNRESOLVED_SUBRULE_REF=4]="UNRESOLVED_SUBRULE_REF",l[l.LEFT_RECURSION=5]="LEFT_RECURSION",l[l.NONE_LAST_EMPTY_ALT=6]="NONE_LAST_EMPTY_ALT",l[l.AMBIGUOUS_ALTS=7]="AMBIGUOUS_ALTS",l[l.CONFLICT_TOKENS_RULES_NAMESPACE=8]="CONFLICT_TOKENS_RULES_NAMESPACE",l[l.INVALID_TOKEN_NAME=9]="INVALID_TOKEN_NAME",l[l.NO_NON_EMPTY_LOOKAHEAD=10]="NO_NON_EMPTY_LOOKAHEAD",l[l.AMBIGUOUS_PREFIX_ALTS=11]="AMBIGUOUS_PREFIX_ALTS",l[l.TOO_MANY_ALTS=12]="TOO_MANY_ALTS",l[l.CUSTOM_LOOKAHEAD_VALIDATION=13]="CUSTOM_LOOKAHEAD_VALIDATION";let Parser2=class Parser2{static performSelfAnalysis(e){throw Error("The **static** `performSelfAnalysis` method has been deprecated.	\nUse the **instance** method with the same name instead.")}performSelfAnalysis(){this.TRACE_INIT("performSelfAnalysis",()=>{let e;this.selfAnalysisDone=!0;let t=this.className;this.TRACE_INIT("toFastProps",()=>{toFastProperties(this)}),this.TRACE_INIT("Grammar Recording",()=>{try{this.enableRecording(),forEach(this.definedRulesNames,e=>{let t;let r=this[e],i=r.originalGrammarAction;this.TRACE_INIT(`${e} Rule`,()=>{t=this.topLevelRuleRecord(e,i)}),this.gastProductionsCache[e]=t})}finally{this.disableRecording()}});let r=[];if(this.TRACE_INIT("Grammar Resolving",()=>{r=resolveGrammar({rules:values(this.gastProductionsCache)}),this.definitionErrors=this.definitionErrors.concat(r)}),this.TRACE_INIT("Grammar Validations",()=>{if(isEmpty(r)&&!1===this.skipValidations){let e=validateGrammar({rules:values(this.gastProductionsCache),tokenTypes:values(this.tokensMap),errMsgProvider:t7,grammarName:t}),r=validateLookahead({lookaheadStrategy:this.lookaheadStrategy,rules:values(this.gastProductionsCache),tokenTypes:values(this.tokensMap),grammarName:t});this.definitionErrors=this.definitionErrors.concat(e,r)}}),isEmpty(this.definitionErrors)&&(this.recoveryEnabled&&this.TRACE_INIT("computeAllProdsFollows",()=>{let e=computeAllProdsFollows(values(this.gastProductionsCache));this.resyncFollows=e}),this.TRACE_INIT("ComputeLookaheadFunctions",()=>{var e,t;null===(t=(e=this.lookaheadStrategy).initialize)||void 0===t||t.call(e,{rules:values(this.gastProductionsCache)}),this.preComputeLookaheadFunctions(values(this.gastProductionsCache))})),!Parser2.DEFER_DEFINITION_ERRORS_HANDLING&&!isEmpty(this.definitionErrors))throw e=map(this.definitionErrors,e=>e.message),Error(`Parser Definition Errors detected:
 ${e.join("\n-------------------------------\n")}`)})}constructor(e,t){if(this.definitionErrors=[],this.selfAnalysisDone=!1,this.initErrorHandler(t),this.initLexerAdapter(),this.initLooksAhead(t),this.initRecognizerEngine(e,t),this.initRecoverable(t),this.initTreeBuilder(t),this.initContentAssist(),this.initGastRecorder(t),this.initPerformanceTracer(t),has(t,"ignoredIssues"))throw Error("The <ignoredIssues> IParserConfig property has been deprecated.\n	Please use the <IGNORE_AMBIGUITIES> flag on the relevant DSL method instead.\n	See: https://chevrotain.io/docs/guide/resolving_grammar_errors.html#IGNORING_AMBIGUITIES\n	For further details.");this.skipValidations=has(t,"skipValidations")?t.skipValidations:rd.skipValidations}};Parser2.DEFER_DEFINITION_ERRORS_HANDLING=!1,applyMixins(Parser2,[Recoverable,LooksAhead,TreeBuilder,LexerAdapter,RecognizerEngine,RecognizerApi,ErrorHandler,ContentAssist,GastRecorder,PerformanceTracer]);let CstParser2=class CstParser2 extends Parser2{constructor(e,t=rd){let r=clone2(t);r.outputCst=!0,super(e,r)}};return{CstParser:CstParser2,Lexer:Lexer2,createToken:createToken2}})();let WorkerPool=class WorkerPool{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){let t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return -1}_onMessage(e,t){let r=this.workersResolve[e];if(r&&r(t),this.queue.length){let{resolve:t,msg:r,transfer:i}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(r,i)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(r=>{let i=this._getIdleWorker();-1!==i?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=r,this.workers[i].postMessage(e,t)):this.queue.push({resolve:r,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}};let CompressedArrayTexture=class CompressedArrayTexture extends d.CompressedTexture{constructor(e,t,r,i,a,n){super(e,t,r,a,n),this.isCompressedArrayTexture=!0,this.image.depth=i,this.wrapR=d.ClampToEdgeWrapping}};let td=new WeakMap,tf=0,tm=class extends d.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new WorkerPool,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},e.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this}init(){if(!this.transcoderPending){let e=new d.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);let t=e.loadAsync("basis_transcoder.js"),r=new d.FileLoader(this.manager);r.setPath(this.transcoderPath),r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials);let i=r.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,i]).then(([e,t])=>{let r=tm.BasisWorker.toString(),i=["/* constants */","let _EngineFormat = "+JSON.stringify(tm.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(tm.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(tm.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i])),this.transcoderBinary=t,this.workerPool.setWorkerCreator(()=>{let e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e})}),tf>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),tf++}return this.transcoderPending}load(e,t,r,i){if(null===this.workerConfig)throw Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");let a=new d.FileLoader(this.manager);a.setResponseType("arraybuffer"),a.setWithCredentials(this.withCredentials),a.load(e,e=>{if(td.has(e)){let r=td.get(e);return r.promise.then(t).catch(i)}this._createTexture(e).then(e=>t?t(e):null).catch(i)},r,i)}_createTextureFrom(e,t){let{mipmaps:r,width:i,height:a,format:n,type:s,error:o,dfdTransferFn:l,dfdFlags:c}=e;if("error"===s)return Promise.reject(o);let u=t.layerCount>1?new CompressedArrayTexture(r,i,a,t.layerCount,n,d.UnsignedByteType):new d.CompressedTexture(r,i,a,n,d.UnsignedByteType);return u.minFilter=1===r.length?d.LinearFilter:d.LinearMipmapLinearFilter,u.magFilter=d.LinearFilter,u.generateMipmaps=!1,u.needsUpdate=!0,"colorSpace"in u?u.colorSpace=l===f.FVZ?"srgb":"srgb-linear":u.encoding=l===f.FVZ?3001:3e3,u.premultiplyAlpha=!!(c&f.qHj),u}async _createTexture(e,t={}){let r=(0,f.ij3)(new Uint8Array(e));if(r.vkFormat!==f.kXg)return createDataTexture(r);let i=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:t},[e])).then(e=>this._createTextureFrom(e.data,r));return td.set(e,{promise:i}),i}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),tf--,this}};__publicField(tm,"BasisFormat",{ETC1S:0,UASTC_4x4:1}),__publicField(tm,"TranscoderFormat",{ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16}),__publicField(tm,"EngineFormat",{RGBAFormat:d.RGBAFormat,RGBA_ASTC_4x4_Format:d.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:d.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:d.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:d.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:d.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:d.RGB_ETC1_Format,RGB_ETC2_Format:d.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:d.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:d.RGB_S3TC_DXT1_Format}),__publicField(tm,"BasisWorker",function(){let e,t,r;let i=_EngineFormat,a=_TranscoderFormat,n=_BasisFormat;function init2(e){t=new Promise(t=>{r={wasmBinary:e,onRuntimeInitialized:t},BASIS(r)}).then(()=>{r.initializeBasis(),void 0===r.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function transcode(e){let t=new r.KTX2File(new Uint8Array(e));function cleanup(){t.close(),t.delete()}if(!t.isValid())throw cleanup(),Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");let i=t.isUASTC()?n.UASTC_4x4:n.ETC1S,a=t.getWidth(),s=t.getHeight(),o=t.getLayers()||1,l=t.getLevels(),c=t.getHasAlpha(),u=t.getDFDTransferFunc(),h=t.getDFDFlags(),{transcoderFormat:p,engineFormat:d}=getTranscoderFormat(i,a,s,c);if(!a||!s||!l)throw cleanup(),Error("THREE.KTX2Loader:	Invalid texture");if(!t.startTranscoding())throw cleanup(),Error("THREE.KTX2Loader: .startTranscoding failed");let f=[];for(let e=0;e<l;e++){let r,i;let a=[];for(let n=0;n<o;n++){let s=t.getImageLevelInfo(e,n,0);r=s.origWidth<4?s.origWidth:s.width,i=s.origHeight<4?s.origHeight:s.height;let o=new Uint8Array(t.getImageTranscodedSizeInBytes(e,n,0,p)),l=t.transcodeImage(o,e,n,0,p,0,-1,-1);if(!l)throw cleanup(),Error("THREE.KTX2Loader: .transcodeImage failed.");a.push(o)}f.push({data:concat(a),width:r,height:i})}return cleanup(),{width:a,height:s,hasAlpha:c,mipmaps:f,format:d,dfdTransferFn:u,dfdFlags:h}}self.addEventListener("message",function(r){let i=r.data;switch(i.type){case"init":e=i.config,init2(i.transcoderBinary);break;case"transcode":t.then(()=>{try{let{width:e,height:t,hasAlpha:r,mipmaps:a,format:n,dfdTransferFn:s,dfdFlags:o}=transcode(i.buffer),l=[];for(let e=0;e<a.length;++e)l.push(a[e].data.buffer);self.postMessage({type:"transcode",id:i.id,width:e,height:t,hasAlpha:r,mipmaps:a,format:n,dfdTransferFn:s,dfdFlags:o},l)}catch(e){console.error(e),self.postMessage({type:"error",id:i.id,error:e.message})}})}});let s=[{if:"astcSupported",basisFormat:[n.UASTC_4x4],transcoderFormat:[a.ASTC_4x4,a.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.BC7_M5,a.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.BC1,a.BC3],engineFormat:[i.RGB_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.ETC1,a.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.ETC1],engineFormat:[i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.PVRTC1_4_RGB,a.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],o=s.sort(function(e,t){return e.priorityETC1S-t.priorityETC1S}),l=s.sort(function(e,t){return e.priorityUASTC-t.priorityUASTC});function getTranscoderFormat(t,r,s,c){let u;let h=t===n.ETC1S?o:l;for(let i=0;i<h.length;i++){let a=h[i];if(e[a.if]&&a.basisFormat.includes(t)&&(!c||!(a.transcoderFormat.length<2))&&(!a.needsPowerOfTwo||isPowerOfTwo(r)&&isPowerOfTwo(s)))return{transcoderFormat:a.transcoderFormat[c?1:0],engineFormat:a.engineFormat[c?1:0]}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),{transcoderFormat:a.RGBA32,engineFormat:i.RGBAFormat}}function isPowerOfTwo(e){return e<=2||(e&e-1)==0&&0!==e}function concat(e){let t=0;for(let r=0;r<e.length;r++){let i=e[r];t+=i.byteLength}let r=new Uint8Array(t),i=0;for(let t=0;t<e.length;t++){let a=e[t];r.set(a,i),i+=a.byteLength}return r}});let tg={[f.qfi]:d.RGBAFormat,[f.IgZ]:d.RGBAFormat,[f.MCP]:d.RGBAFormat,[f.OmG]:d.RGBAFormat,[f.bWS]:d.RGFormat,[f.LR2]:d.RGFormat,[f.gJS]:d.RGFormat,[f.IJq]:d.RGFormat,[f.eQx]:d.RedFormat,[f.wOb]:d.RedFormat,[f.e1Y]:d.RedFormat,[f.tLr]:d.RedFormat},tv={[f.qfi]:d.FloatType,[f.IgZ]:d.HalfFloatType,[f.MCP]:d.UnsignedByteType,[f.OmG]:d.UnsignedByteType,[f.bWS]:d.FloatType,[f.LR2]:d.HalfFloatType,[f.gJS]:d.UnsignedByteType,[f.IJq]:d.UnsignedByteType,[f.eQx]:d.FloatType,[f.wOb]:d.HalfFloatType,[f.e1Y]:d.UnsignedByteType,[f.tLr]:d.UnsignedByteType},ty={[f.OmG]:3001,[f.IJq]:3001,[f.e1Y]:3001};async function createDataTexture(e){let t,r;let{vkFormat:i,pixelWidth:a,pixelHeight:n,pixelDepth:s}=e;if(void 0===tg[i])throw Error("THREE.KTX2Loader: Unsupported vkFormat.");let o=e.levels[0];if(e.supercompressionScheme===f.Oi)t=o.levelData;else if(e.supercompressionScheme===f.c6w)u||(u=new Promise(async e=>{let t=new m.L;await t.init(),e(t)})),t=(await u).decode(o.levelData,o.uncompressedByteLength);else throw Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");r=tv[i]===d.FloatType?new Float32Array(t.buffer,t.byteOffset,t.byteLength/Float32Array.BYTES_PER_ELEMENT):tv[i]===d.HalfFloatType?new Uint16Array(t.buffer,t.byteOffset,t.byteLength/Uint16Array.BYTES_PER_ELEMENT):t;let l=0===s?new d.DataTexture(r,a,n):new Data3DTexture(r,a,n,s);return l.type=tv[i],l.format=tg[i],l.encoding=ty[i]||3e3,l.needsUpdate=!0,Promise.resolve(l)}let{parseBuffer:tx}=(()=>{function Tree(){this.table=new Uint16Array(16),this.trans=new Uint16Array(288)}function Data(e,t){this.source=e,this.sourceIndex=0,this.tag=0,this.bitcount=0,this.dest=t,this.destLen=0,this.ltree=new Tree,this.dtree=new Tree}var e,t,r,i,a,n=new Tree,s=new Tree,o=new Uint8Array(30),l=new Uint16Array(30),c=new Uint8Array(30),u=new Uint16Array(30),h=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),p=new Tree,d=new Uint8Array(320);function tinf_build_bits_base(e,t,r,i){var a,n;for(a=0;a<r;++a)e[a]=0;for(a=0;a<30-r;++a)e[a+r]=a/r|0;for(n=i,a=0;a<30;++a)t[a]=n,n+=1<<e[a]}function tinf_build_fixed_trees(e,t){var r;for(r=0;r<7;++r)e.table[r]=0;for(r=0,e.table[7]=24,e.table[8]=152,e.table[9]=112;r<24;++r)e.trans[r]=256+r;for(r=0;r<144;++r)e.trans[24+r]=r;for(r=0;r<8;++r)e.trans[168+r]=280+r;for(r=0;r<112;++r)e.trans[176+r]=144+r;for(r=0;r<5;++r)t.table[r]=0;for(r=0,t.table[5]=32;r<32;++r)t.trans[r]=r}var f=new Uint16Array(16);function tinf_build_tree(e,t,r,i){var a,n;for(a=0;a<16;++a)e.table[a]=0;for(a=0;a<i;++a)e.table[t[r+a]]++;for(n=0,e.table[0]=0,a=0;a<16;++a)f[a]=n,n+=e.table[a];for(a=0;a<i;++a)t[r+a]&&(e.trans[f[t[r+a]]++]=a)}function tinf_getbit(e){e.bitcount--||(e.tag=e.source[e.sourceIndex++],e.bitcount=7);var t=1&e.tag;return e.tag>>>=1,t}function tinf_read_bits(e,t,r){if(!t)return r;for(;e.bitcount<24;)e.tag|=e.source[e.sourceIndex++]<<e.bitcount,e.bitcount+=8;var i=e.tag&65535>>>16-t;return e.tag>>>=t,e.bitcount-=t,i+r}function tinf_decode_symbol(e,t){for(;e.bitcount<24;)e.tag|=e.source[e.sourceIndex++]<<e.bitcount,e.bitcount+=8;var r=0,i=0,a=0,n=e.tag;do i=2*i+(1&n),n>>>=1,++a,r+=t.table[a],i-=t.table[a];while(i>=0);return e.tag=n,e.bitcount-=a,t.trans[r+i]}function tinf_decode_trees(e,t,r){for(s=0,i=tinf_read_bits(e,5,257),a=tinf_read_bits(e,5,1),n=tinf_read_bits(e,4,4);s<19;++s)d[s]=0;for(s=0;s<n;++s){var i,a,n,s,o,l,c=tinf_read_bits(e,3,0);d[h[s]]=c}for(tinf_build_tree(p,d,0,19),o=0;o<i+a;){var u=tinf_decode_symbol(e,p);switch(u){case 16:var f=d[o-1];for(l=tinf_read_bits(e,2,3);l;--l)d[o++]=f;break;case 17:for(l=tinf_read_bits(e,3,3);l;--l)d[o++]=0;break;case 18:for(l=tinf_read_bits(e,7,11);l;--l)d[o++]=0;break;default:d[o++]=u}}tinf_build_tree(t,d,0,i),tinf_build_tree(r,d,i,a)}function tinf_inflate_block_data(e,t,r){for(;;){var i,a,n,s,h=tinf_decode_symbol(e,t);if(256===h)return 0;if(h<256)e.dest[e.destLen++]=h;else for(h-=257,i=tinf_read_bits(e,o[h],l[h]),a=tinf_decode_symbol(e,r),s=n=e.destLen-tinf_read_bits(e,c[a],u[a]);s<n+i;++s)e.dest[e.destLen++]=e.dest[s]}}function tinf_inflate_uncompressed_block(e){for(var t,r;e.bitcount>8;)e.sourceIndex--,e.bitcount-=8;if((t=256*(t=e.source[e.sourceIndex+1])+e.source[e.sourceIndex])!==(65535&~(256*e.source[e.sourceIndex+3]+e.source[e.sourceIndex+2])))return -3;for(e.sourceIndex+=4,r=t;r;--r)e.dest[e.destLen++]=e.source[e.sourceIndex++];return e.bitcount=0,0}function tinf_uncompress(e,t){var r,i,a=new Data(e,t);do{switch(r=tinf_getbit(a),tinf_read_bits(a,2,0)){case 0:i=tinf_inflate_uncompressed_block(a);break;case 1:i=tinf_inflate_block_data(a,n,s);break;case 2:tinf_decode_trees(a,a.ltree,a.dtree),i=tinf_inflate_block_data(a,a.ltree,a.dtree);break;default:i=-3}if(0!==i)throw Error("Data error")}while(!r);return a.destLen<a.dest.length?"function"==typeof a.dest.slice?a.dest.slice(0,a.destLen):a.dest.subarray(0,a.destLen):a.dest}tinf_build_fixed_trees(n,s),tinf_build_bits_base(o,l,4,3),tinf_build_bits_base(c,u,2,1),o[28]=0,l[28]=258;var m=tinf_uncompress;function derive(e,t,r,i,a){return Math.pow(1-a,3)*e+3*Math.pow(1-a,2)*a*t+3*(1-a)*Math.pow(a,2)*r+Math.pow(a,3)*i}function BoundingBox(){this.x1=Number.NaN,this.y1=Number.NaN,this.x2=Number.NaN,this.y2=Number.NaN}function Path2(){this.commands=[],this.fill="black",this.stroke=null,this.strokeWidth=1}function fail(e){throw Error(e)}function argument(e,t){e||fail(t)}BoundingBox.prototype.isEmpty=function(){return isNaN(this.x1)||isNaN(this.y1)||isNaN(this.x2)||isNaN(this.y2)},BoundingBox.prototype.addPoint=function(e,t){"number"==typeof e&&((isNaN(this.x1)||isNaN(this.x2))&&(this.x1=e,this.x2=e),e<this.x1&&(this.x1=e),e>this.x2&&(this.x2=e)),"number"==typeof t&&((isNaN(this.y1)||isNaN(this.y2))&&(this.y1=t,this.y2=t),t<this.y1&&(this.y1=t),t>this.y2&&(this.y2=t))},BoundingBox.prototype.addX=function(e){this.addPoint(e,null)},BoundingBox.prototype.addY=function(e){this.addPoint(null,e)},BoundingBox.prototype.addBezier=function(e,t,r,i,a,n,s,o){var l=[e,t],c=[r,i],u=[a,n],h=[s,o];this.addPoint(e,t),this.addPoint(s,o);for(var p=0;p<=1;p++){var d=6*l[p]-12*c[p]+6*u[p],f=-3*l[p]+9*c[p]-9*u[p]+3*h[p],m=3*c[p]-3*l[p];if(0===f){if(0===d)continue;var g=-m/d;0<g&&g<1&&(0===p&&this.addX(derive(l[p],c[p],u[p],h[p],g)),1===p&&this.addY(derive(l[p],c[p],u[p],h[p],g)));continue}var v=Math.pow(d,2)-4*m*f;if(!(v<0)){var y=(-d+Math.sqrt(v))/(2*f);0<y&&y<1&&(0===p&&this.addX(derive(l[p],c[p],u[p],h[p],y)),1===p&&this.addY(derive(l[p],c[p],u[p],h[p],y)));var x=(-d-Math.sqrt(v))/(2*f);0<x&&x<1&&(0===p&&this.addX(derive(l[p],c[p],u[p],h[p],x)),1===p&&this.addY(derive(l[p],c[p],u[p],h[p],x)))}}},BoundingBox.prototype.addQuad=function(e,t,r,i,a,n){var s=e+2/3*(r-e),o=t+2/3*(i-t),l=s+1/3*(a-e),c=o+1/3*(n-t);this.addBezier(e,t,s,o,l,c,a,n)},Path2.prototype.moveTo=function(e,t){this.commands.push({type:"M",x:e,y:t})},Path2.prototype.lineTo=function(e,t){this.commands.push({type:"L",x:e,y:t})},Path2.prototype.curveTo=Path2.prototype.bezierCurveTo=function(e,t,r,i,a,n){this.commands.push({type:"C",x1:e,y1:t,x2:r,y2:i,x:a,y:n})},Path2.prototype.quadTo=Path2.prototype.quadraticCurveTo=function(e,t,r,i){this.commands.push({type:"Q",x1:e,y1:t,x:r,y:i})},Path2.prototype.close=Path2.prototype.closePath=function(){this.commands.push({type:"Z"})},Path2.prototype.extend=function(e){if(e.commands)e=e.commands;else if(e instanceof BoundingBox){var t=e;this.moveTo(t.x1,t.y1),this.lineTo(t.x2,t.y1),this.lineTo(t.x2,t.y2),this.lineTo(t.x1,t.y2),this.close();return}Array.prototype.push.apply(this.commands,e)},Path2.prototype.getBoundingBox=function(){for(var e=new BoundingBox,t=0,r=0,i=0,a=0,n=0;n<this.commands.length;n++){var s=this.commands[n];switch(s.type){case"M":e.addPoint(s.x,s.y),t=i=s.x,r=a=s.y;break;case"L":e.addPoint(s.x,s.y),i=s.x,a=s.y;break;case"Q":e.addQuad(i,a,s.x1,s.y1,s.x,s.y),i=s.x,a=s.y;break;case"C":e.addBezier(i,a,s.x1,s.y1,s.x2,s.y2,s.x,s.y),i=s.x,a=s.y;break;case"Z":i=t,a=r;break;default:throw Error("Unexpected path command "+s.type)}}return e.isEmpty()&&e.addPoint(0,0),e},Path2.prototype.draw=function(e){e.beginPath();for(var t=0;t<this.commands.length;t+=1){var r=this.commands[t];"M"===r.type?e.moveTo(r.x,r.y):"L"===r.type?e.lineTo(r.x,r.y):"C"===r.type?e.bezierCurveTo(r.x1,r.y1,r.x2,r.y2,r.x,r.y):"Q"===r.type?e.quadraticCurveTo(r.x1,r.y1,r.x,r.y):"Z"===r.type&&e.closePath()}this.fill&&(e.fillStyle=this.fill,e.fill()),this.stroke&&(e.strokeStyle=this.stroke,e.lineWidth=this.strokeWidth,e.stroke())},Path2.prototype.toPathData=function(e){function floatToString(t){return Math.round(t)===t?""+Math.round(t):t.toFixed(e)}function packValues(){for(var e=arguments,t="",r=0;r<arguments.length;r+=1){var i=e[r];i>=0&&r>0&&(t+=" "),t+=floatToString(i)}return t}e=void 0!==e?e:2;for(var t="",r=0;r<this.commands.length;r+=1){var i=this.commands[r];"M"===i.type?t+="M"+packValues(i.x,i.y):"L"===i.type?t+="L"+packValues(i.x,i.y):"C"===i.type?t+="C"+packValues(i.x1,i.y1,i.x2,i.y2,i.x,i.y):"Q"===i.type?t+="Q"+packValues(i.x1,i.y1,i.x,i.y):"Z"===i.type&&(t+="Z")}return t},Path2.prototype.toSVG=function(e){var t='<path d="';return t+=this.toPathData(e)+'"',this.fill&&"black"!==this.fill&&(null===this.fill?t+=' fill="none"':t+=' fill="'+this.fill+'"'),this.stroke&&(t+=' stroke="'+this.stroke+'" stroke-width="'+this.strokeWidth+'"'),t+="/>"},Path2.prototype.toDOMElement=function(e){var t=this.toPathData(e),r=document.createElementNS("http://www.w3.org/2000/svg","path");return r.setAttribute("d",t),r};var g={fail,argument,assert:argument},v={},y={},x={};function constant(e){return function(){return e}}y.BYTE=function(e){return g.argument(e>=0&&e<=255,"Byte value should be between 0 and 255."),[e]},x.BYTE=constant(1),y.CHAR=function(e){return[e.charCodeAt(0)]},x.CHAR=constant(1),y.CHARARRAY=function(e){void 0===e&&(e="",console.warn("Undefined CHARARRAY encountered and treated as an empty string. This is probably caused by a missing glyph name."));for(var t=[],r=0;r<e.length;r+=1)t[r]=e.charCodeAt(r);return t},x.CHARARRAY=function(e){return void 0===e?0:e.length},y.USHORT=function(e){return[e>>8&255,255&e]},x.USHORT=constant(2),y.SHORT=function(e){return e>=32768&&(e=-(65536-e)),[e>>8&255,255&e]},x.SHORT=constant(2),y.UINT24=function(e){return[e>>16&255,e>>8&255,255&e]},x.UINT24=constant(3),y.ULONG=function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]},x.ULONG=constant(4),y.LONG=function(e){return e>=2147483648&&(e=-(4294967296-e)),[e>>24&255,e>>16&255,e>>8&255,255&e]},x.LONG=constant(4),y.FIXED=y.ULONG,x.FIXED=x.ULONG,y.FWORD=y.SHORT,x.FWORD=x.SHORT,y.UFWORD=y.USHORT,x.UFWORD=x.USHORT,y.LONGDATETIME=function(e){return[0,0,0,0,e>>24&255,e>>16&255,e>>8&255,255&e]},x.LONGDATETIME=constant(8),y.TAG=function(e){return g.argument(4===e.length,"Tag should be exactly 4 ASCII characters."),[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]},x.TAG=constant(4),y.Card8=y.BYTE,x.Card8=x.BYTE,y.Card16=y.USHORT,x.Card16=x.USHORT,y.OffSize=y.BYTE,x.OffSize=x.BYTE,y.SID=y.USHORT,x.SID=x.USHORT,y.NUMBER=function(e){return e>=-107&&e<=107?[e+139]:e>=108&&e<=1131?[((e-=108)>>8)+247,255&e]:e>=-1131&&e<=-108?[((e=-e-108)>>8)+251,255&e]:e>=-32768&&e<=32767?y.NUMBER16(e):y.NUMBER32(e)},x.NUMBER=function(e){return y.NUMBER(e).length},y.NUMBER16=function(e){return[28,e>>8&255,255&e]},x.NUMBER16=constant(3),y.NUMBER32=function(e){return[29,e>>24&255,e>>16&255,e>>8&255,255&e]},x.NUMBER32=constant(5),y.REAL=function(e){var t=e.toString(),r=/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/.exec(t);if(r){var i=parseFloat("1e"+((r[2]?+r[2]:0)+r[1].length));t=(Math.round(e*i)/i).toString()}for(var a="",n=0,s=t.length;n<s;n+=1){var o=t[n];"e"===o?a+="-"===t[++n]?"c":"b":"."===o?a+="a":"-"===o?a+="e":a+=o}a+=1&a.length?"f":"ff";for(var l=[30],c=0,u=a.length;c<u;c+=2)l.push(parseInt(a.substr(c,2),16));return l},x.REAL=function(e){return y.REAL(e).length},y.NAME=y.CHARARRAY,x.NAME=x.CHARARRAY,y.STRING=y.CHARARRAY,x.STRING=x.CHARARRAY,v.UTF8=function(e,t,r){for(var i=[],a=0;a<r;a++,t+=1)i[a]=e.getUint8(t);return String.fromCharCode.apply(null,i)},v.UTF16=function(e,t,r){for(var i=[],a=r/2,n=0;n<a;n++,t+=2)i[n]=e.getUint16(t);return String.fromCharCode.apply(null,i)},y.UTF16=function(e){for(var t=[],r=0;r<e.length;r+=1){var i=e.charCodeAt(r);t[t.length]=i>>8&255,t[t.length]=255&i}return t},x.UTF16=function(e){return 2*e.length};var b={"x-mac-croatian":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc†\xb0\xa2\xa3\xa7•\xb6\xdf\xaeŠ™\xb4\xa8≠Ž\xd8∞\xb1≤≥∆\xb5∂∑∏š∫\xaa\xbaΩž\xf8\xbf\xa1\xac√ƒ≈Ć\xabČ… \xc0\xc3\xd5ŒœĐ—“”‘’\xf7◊\xa9⁄€‹›\xc6\xbb–\xb7‚„‰\xc2ć\xc1č\xc8\xcd\xce\xcf\xcc\xd3\xd4đ\xd2\xda\xdb\xd9ıˆ˜\xafπ\xcb˚\xb8\xca\xe6ˇ","x-mac-cyrillic":"АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ†\xb0Ґ\xa3\xa7•\xb6І\xae\xa9™Ђђ≠Ѓѓ∞\xb1≤≥і\xb5ґЈЄєЇїЉљЊњјЅ\xac√ƒ≈∆\xab\xbb… ЋћЌќѕ–—“”‘’\xf7„ЎўЏџ№Ёёяабвгдежзийклмнопрстуфхцчшщъыьэю","x-mac-gaelic":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc†\xb0\xa2\xa3\xa7•\xb6\xdf\xae\xa9™\xb4\xa8≠\xc6\xd8Ḃ\xb1≤≥ḃĊċḊḋḞḟĠġṀ\xe6\xf8ṁṖṗɼƒſṠ\xab\xbb… \xc0\xc3\xd5Œœ–—“”‘’ṡẛ\xffŸṪ€‹›Ŷŷṫ\xb7Ỳỳ⁊\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4♣\xd2\xda\xdb\xd9ı\xdd\xfdŴŵẄẅẀẁẂẃ","x-mac-greek":"\xc4\xb9\xb2\xc9\xb3\xd6\xdc΅\xe0\xe2\xe4΄\xa8\xe7\xe9\xe8\xea\xeb\xa3™\xee\xef•\xbd‰\xf4\xf6\xa6€\xf9\xfb\xfc†ΓΔΘΛΞΠ\xdf\xae\xa9ΣΪ\xa7≠\xb0\xb7Α\xb1≤≥\xa5ΒΕΖΗΙΚΜΦΫΨΩάΝ\xacΟΡ≈Τ\xab\xbb… ΥΧΆΈœ–―“”‘’\xf7ΉΊΌΎέήίόΏύαβψδεφγηιξκλμνοπώρστθωςχυζϊϋΐΰ\xad","x-mac-icelandic":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc\xdd\xb0\xa2\xa3\xa7•\xb6\xdf\xae\xa9™\xb4\xa8≠\xc6\xd8∞\xb1≤≥\xa5\xb5∂∑∏π∫\xaa\xbaΩ\xe6\xf8\xbf\xa1\xac√ƒ≈∆\xab\xbb… \xc0\xc3\xd5Œœ–—“”‘’\xf7◊\xffŸ⁄€\xd0\xf0\xde\xfe\xfd\xb7‚„‰\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9ıˆ˜\xaf˘˙˚\xb8˝˛ˇ","x-mac-inuit":"ᐃᐄᐅᐆᐊᐋᐱᐲᐳᐴᐸᐹᑉᑎᑏᑐᑑᑕᑖᑦᑭᑮᑯᑰᑲᑳᒃᒋᒌᒍᒎᒐᒑ\xb0ᒡᒥᒦ•\xb6ᒧ\xae\xa9™ᒨᒪᒫᒻᓂᓃᓄᓅᓇᓈᓐᓯᓰᓱᓲᓴᓵᔅᓕᓖᓗᓘᓚᓛᓪᔨᔩᔪᔫᔭ… ᔮᔾᕕᕖᕗ–—“”‘’ᕘᕙᕚᕝᕆᕇᕈᕉᕋᕌᕐᕿᖀᖁᖂᖃᖄᖅᖏᖐᖑᖒᖓᖔᖕᙱᙲᙳᙴᙵᙶᖖᖠᖡᖢᖣᖤᖥᖦᕼŁł","x-mac-ce":"\xc4Āā\xc9Ą\xd6\xdc\xe1ąČ\xe4čĆć\xe9ŹźĎ\xedďĒēĖ\xf3ė\xf4\xf6\xf5\xfaĚě\xfc†\xb0Ę\xa3\xa7•\xb6\xdf\xae\xa9™ę\xa8≠ģĮįĪ≤≥īĶ∂∑łĻļĽľĹĺŅņŃ\xac√ńŇ∆\xab\xbb… ňŐ\xd5őŌ–—“”‘’\xf7◊ōŔŕŘ‹›řŖŗŠ‚„šŚś\xc1Ťť\xcdŽžŪ\xd3\xd4ūŮ\xdaůŰűŲų\xdd\xfdķŻŁżĢˇ",macintosh:"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc†\xb0\xa2\xa3\xa7•\xb6\xdf\xae\xa9™\xb4\xa8≠\xc6\xd8∞\xb1≤≥\xa5\xb5∂∑∏π∫\xaa\xbaΩ\xe6\xf8\xbf\xa1\xac√ƒ≈∆\xab\xbb… \xc0\xc3\xd5Œœ–—“”‘’\xf7◊\xffŸ⁄€‹›ﬁﬂ‡\xb7‚„‰\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9ıˆ˜\xaf˘˙˚\xb8˝˛ˇ","x-mac-romanian":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc†\xb0\xa2\xa3\xa7•\xb6\xdf\xae\xa9™\xb4\xa8≠ĂȘ∞\xb1≤≥\xa5\xb5∂∑∏π∫\xaa\xbaΩăș\xbf\xa1\xac√ƒ≈∆\xab\xbb… \xc0\xc3\xd5Œœ–—“”‘’\xf7◊\xffŸ⁄€‹›Țț‡\xb7‚„‰\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9ıˆ˜\xaf˘˙˚\xb8˝˛ˇ","x-mac-turkish":"\xc4\xc5\xc7\xc9\xd1\xd6\xdc\xe1\xe0\xe2\xe4\xe3\xe5\xe7\xe9\xe8\xea\xeb\xed\xec\xee\xef\xf1\xf3\xf2\xf4\xf6\xf5\xfa\xf9\xfb\xfc†\xb0\xa2\xa3\xa7•\xb6\xdf\xae\xa9™\xb4\xa8≠\xc6\xd8∞\xb1≤≥\xa5\xb5∂∑∏π∫\xaa\xbaΩ\xe6\xf8\xbf\xa1\xac√ƒ≈∆\xab\xbb… \xc0\xc3\xd5Œœ–—“”‘’\xf7◊\xffŸĞğİıŞş‡\xb7‚„‰\xc2\xca\xc1\xcb\xc8\xcd\xce\xcf\xcc\xd3\xd4\xd2\xda\xdb\xd9ˆ˜\xaf˘˙˚\xb8˝˛ˇ"};v.MACSTRING=function(e,t,r,i){var a=b[i];if(void 0!==a){for(var n="",s=0;s<r;s++){var o=e.getUint8(t+s);o<=127?n+=String.fromCharCode(o):n+=a[127&o]}return n}};var T="function"==typeof WeakMap&&new WeakMap,getMacEncodingTable=function(t){if(!e)for(var r in e={},b)e[r]=new String(r);var i=e[t];if(void 0!==i){if(T){var a=T.get(i);if(void 0!==a)return a}var n=b[t];if(void 0!==n){for(var s={},o=0;o<n.length;o++)s[n.charCodeAt(o)]=o+128;return T&&T.set(i,s),s}}};function isByteEncodable(e){return e>=-128&&e<=127}function encodeVarDeltaRunAsZeroes(e,t,r){for(var i=0,a=e.length;t<a&&i<64&&0===e[t];)++t,++i;return r.push(128|i-1),t}function encodeVarDeltaRunAsBytes(e,t,r){for(var i=0,a=e.length,n=t;n<a&&i<64;){var s=e[n];if(!isByteEncodable(s)||0===s&&n+1<a&&0===e[n+1])break;++n,++i}r.push(i-1);for(var o=t;o<n;++o)r.push(e[o]+256&255);return n}function encodeVarDeltaRunAsWords(e,t,r){for(var i=0,a=e.length,n=t;n<a&&i<64;){var s=e[n];if(0===s||isByteEncodable(s)&&n+1<a&&isByteEncodable(e[n+1]))break;++n,++i}r.push(64|i-1);for(var o=t;o<n;++o){var l=e[o];r.push(l+65536>>8&255,l+256&255)}return n}y.MACSTRING=function(e,t){var r=getMacEncodingTable(t);if(void 0!==r){for(var i=[],a=0;a<e.length;a++){var n=e.charCodeAt(a);if(n>=128&&void 0===(n=r[n]))return;i[a]=n}return i}},x.MACSTRING=function(e,t){var r=y.MACSTRING(e,t);return void 0!==r?r.length:0},y.VARDELTAS=function(e){for(var t=0,r=[];t<e.length;){var i=e[t];t=0===i?encodeVarDeltaRunAsZeroes(e,t,r):i>=-128&&i<=127?encodeVarDeltaRunAsBytes(e,t,r):encodeVarDeltaRunAsWords(e,t,r)}return r},y.INDEX=function(e){for(var t=1,r=[1],i=[],a=0;a<e.length;a+=1){var n=y.OBJECT(e[a]);Array.prototype.push.apply(i,n),t+=n.length,r.push(t)}if(0===i.length)return[0,0];for(var s=[],o=1+Math.floor(Math.log(t)/Math.log(2))/8|0,l=[void 0,y.BYTE,y.USHORT,y.UINT24,y.ULONG][o],c=0;c<r.length;c+=1){var u=l(r[c]);Array.prototype.push.apply(s,u)}return Array.prototype.concat(y.Card16(e.length),y.OffSize(o),s,i)},x.INDEX=function(e){return y.INDEX(e).length},y.DICT=function(e){for(var t=[],r=Object.keys(e),i=r.length,a=0;a<i;a+=1){var n=parseInt(r[a],0),s=e[n];t=(t=t.concat(y.OPERAND(s.value,s.type))).concat(y.OPERATOR(n))}return t},x.DICT=function(e){return y.DICT(e).length},y.OPERATOR=function(e){return e<1200?[e]:[12,e-1200]},y.OPERAND=function(e,t){var r=[];if(Array.isArray(t))for(var i=0;i<t.length;i+=1)g.argument(e.length===t.length,"Not enough arguments given for type"+t),r=r.concat(y.OPERAND(e[i],t[i]));else if("SID"===t)r=r.concat(y.NUMBER(e));else if("offset"===t)r=r.concat(y.NUMBER32(e));else if("number"===t)r=r.concat(y.NUMBER(e));else if("real"===t)r=r.concat(y.REAL(e));else throw Error("Unknown operand type "+t);return r},y.OP=y.BYTE,x.OP=x.BYTE;var S="function"==typeof WeakMap&&new WeakMap;function Table(e,t,r){if(t.length&&("coverageFormat"!==t[0].name||1===t[0].value))for(var i=0;i<t.length;i+=1){var a=t[i];this[a.name]=a.value}if(this.tableName=e,this.fields=t,r)for(var n=Object.keys(r),s=0;s<n.length;s+=1){var o=n[s],l=r[o];void 0!==this[o]&&(this[o]=l)}}function ushortList(e,t,r){void 0===r&&(r=t.length);var i=Array(t.length+1);i[0]={name:e+"Count",type:"USHORT",value:r};for(var a=0;a<t.length;a++)i[a+1]={name:e+a,type:"USHORT",value:t[a]};return i}function tableList(e,t,r){var i=t.length,a=Array(i+1);a[0]={name:e+"Count",type:"USHORT",value:i};for(var n=0;n<i;n++)a[n+1]={name:e+n,type:"TABLE",value:r(t[n],n)};return a}function recordList(e,t,r){var i=t.length,a=[];a[0]={name:e+"Count",type:"USHORT",value:i};for(var n=0;n<i;n++)a=a.concat(r(t[n],n));return a}function Coverage(e){1===e.format?Table.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:1}].concat(ushortList("glyph",e.glyphs))):2===e.format?Table.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:2}].concat(recordList("rangeRecord",e.ranges,function(e){return[{name:"startGlyphID",type:"USHORT",value:e.start},{name:"endGlyphID",type:"USHORT",value:e.end},{name:"startCoverageIndex",type:"USHORT",value:e.index}]}))):g.assert(!1,"Coverage format must be 1 or 2.")}function ScriptList(e){Table.call(this,"scriptListTable",recordList("scriptRecord",e,function(e,t){var r=e.script,i=r.defaultLangSys;return g.assert(!!i,"Unable to write GSUB: script "+e.tag+" has no default language system."),[{name:"scriptTag"+t,type:"TAG",value:e.tag},{name:"script"+t,type:"TABLE",value:new Table("scriptTable",[{name:"defaultLangSys",type:"TABLE",value:new Table("defaultLangSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:i.reqFeatureIndex}].concat(ushortList("featureIndex",i.featureIndexes)))}].concat(recordList("langSys",r.langSysRecords,function(e,t){var r=e.langSys;return[{name:"langSysTag"+t,type:"TAG",value:e.tag},{name:"langSys"+t,type:"TABLE",value:new Table("langSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:r.reqFeatureIndex}].concat(ushortList("featureIndex",r.featureIndexes)))}]})))}]}))}function FeatureList(e){Table.call(this,"featureListTable",recordList("featureRecord",e,function(e,t){var r=e.feature;return[{name:"featureTag"+t,type:"TAG",value:e.tag},{name:"feature"+t,type:"TABLE",value:new Table("featureTable",[{name:"featureParams",type:"USHORT",value:r.featureParams}].concat(ushortList("lookupListIndex",r.lookupListIndexes)))}]}))}function LookupList(e,t){Table.call(this,"lookupListTable",tableList("lookup",e,function(e){var r=t[e.lookupType];return g.assert(!!r,"Unable to write GSUB lookup type "+e.lookupType+" tables."),new Table("lookupTable",[{name:"lookupType",type:"USHORT",value:e.lookupType},{name:"lookupFlag",type:"USHORT",value:e.lookupFlag}].concat(tableList("subtable",e.subtables,r)))}))}y.CHARSTRING=function(e){if(S){var t=S.get(e);if(void 0!==t)return t}for(var r=[],i=e.length,a=0;a<i;a+=1){var n=e[a];r=r.concat(y[n.type](n.value))}return S&&S.set(e,r),r},x.CHARSTRING=function(e){return y.CHARSTRING(e).length},y.OBJECT=function(e){var t=y[e.type];return g.argument(void 0!==t,"No encoding function for type "+e.type),t(e.value)},x.OBJECT=function(e){var t=x[e.type];return g.argument(void 0!==t,"No sizeOf function for type "+e.type),t(e.value)},y.TABLE=function(e){for(var t=[],r=e.fields.length,i=[],a=[],n=0;n<r;n+=1){var s=e.fields[n],o=y[s.type];g.argument(void 0!==o,"No encoding function for field type "+s.type+" ("+s.name+")");var l=e[s.name];void 0===l&&(l=s.value);var c=o(l);"TABLE"===s.type?(a.push(t.length),t=t.concat([0,0]),i.push(c)):t=t.concat(c)}for(var u=0;u<i.length;u+=1){var h=a[u],p=t.length;g.argument(p<65536,"Table "+e.tableName+" too big."),t[h]=p>>8,t[h+1]=255&p,t=t.concat(i[u])}return t},x.TABLE=function(e){for(var t=0,r=e.fields.length,i=0;i<r;i+=1){var a=e.fields[i],n=x[a.type];g.argument(void 0!==n,"No sizeOf function for field type "+a.type+" ("+a.name+")");var s=e[a.name];void 0===s&&(s=a.value),t+=n(s),"TABLE"===a.type&&(t+=2)}return t},y.RECORD=y.TABLE,x.RECORD=x.TABLE,y.LITERAL=function(e){return e},x.LITERAL=function(e){return e.length},Table.prototype.encode=function(){return y.TABLE(this)},Table.prototype.sizeOf=function(){return x.TABLE(this)},Coverage.prototype=Object.create(Table.prototype),Coverage.prototype.constructor=Coverage,ScriptList.prototype=Object.create(Table.prototype),ScriptList.prototype.constructor=ScriptList,FeatureList.prototype=Object.create(Table.prototype),FeatureList.prototype.constructor=FeatureList,LookupList.prototype=Object.create(Table.prototype),LookupList.prototype.constructor=LookupList;var E={Table,Record:Table,Coverage,ScriptList,FeatureList,LookupList,ushortList,tableList,recordList};function getByte(e,t){return e.getUint8(t)}function getUShort(e,t){return e.getUint16(t,!1)}function getShort(e,t){return e.getInt16(t,!1)}function getULong(e,t){return e.getUint32(t,!1)}function getFixed(e,t){return e.getInt16(t,!1)+e.getUint16(t+2,!1)/65535}function getTag(e,t){for(var r="",i=t;i<t+4;i+=1)r+=String.fromCharCode(e.getInt8(i));return r}function getOffset(e,t,r){for(var i=0,a=0;a<r;a+=1)i<<=8,i+=e.getUint8(t+a);return i}function getBytes(e,t,r){for(var i=[],a=t;a<r;a+=1)i.push(e.getUint8(a));return i}function bytesToString(e){for(var t="",r=0;r<e.length;r+=1)t+=String.fromCharCode(e[r]);return t}var R={byte:1,uShort:2,short:2,uLong:4,fixed:4,longDateTime:8,tag:4};function Parser2(e,t){this.data=e,this.offset=t,this.relativeOffset=0}Parser2.prototype.parseByte=function(){var e=this.data.getUint8(this.offset+this.relativeOffset);return this.relativeOffset+=1,e},Parser2.prototype.parseChar=function(){var e=this.data.getInt8(this.offset+this.relativeOffset);return this.relativeOffset+=1,e},Parser2.prototype.parseCard8=Parser2.prototype.parseByte,Parser2.prototype.parseUShort=function(){var e=this.data.getUint16(this.offset+this.relativeOffset);return this.relativeOffset+=2,e},Parser2.prototype.parseCard16=Parser2.prototype.parseUShort,Parser2.prototype.parseSID=Parser2.prototype.parseUShort,Parser2.prototype.parseOffset16=Parser2.prototype.parseUShort,Parser2.prototype.parseShort=function(){var e=this.data.getInt16(this.offset+this.relativeOffset);return this.relativeOffset+=2,e},Parser2.prototype.parseF2Dot14=function(){var e=this.data.getInt16(this.offset+this.relativeOffset)/16384;return this.relativeOffset+=2,e},Parser2.prototype.parseULong=function(){var e=getULong(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,e},Parser2.prototype.parseOffset32=Parser2.prototype.parseULong,Parser2.prototype.parseFixed=function(){var e=getFixed(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,e},Parser2.prototype.parseString=function(e){var t=this.data,r=this.offset+this.relativeOffset,i="";this.relativeOffset+=e;for(var a=0;a<e;a++)i+=String.fromCharCode(t.getUint8(r+a));return i},Parser2.prototype.parseTag=function(){return this.parseString(4)},Parser2.prototype.parseLongDateTime=function(){var e=getULong(this.data,this.offset+this.relativeOffset+4);return e-=2082844800,this.relativeOffset+=8,e},Parser2.prototype.parseVersion=function(e){var t=getUShort(this.data,this.offset+this.relativeOffset),r=getUShort(this.data,this.offset+this.relativeOffset+2);return this.relativeOffset+=4,void 0===e&&(e=4096),t+r/e/10},Parser2.prototype.skip=function(e,t){void 0===t&&(t=1),this.relativeOffset+=R[e]*t},Parser2.prototype.parseULongList=function(e){void 0===e&&(e=this.parseULong());for(var t=Array(e),r=this.data,i=this.offset+this.relativeOffset,a=0;a<e;a++)t[a]=r.getUint32(i),i+=4;return this.relativeOffset+=4*e,t},Parser2.prototype.parseOffset16List=Parser2.prototype.parseUShortList=function(e){void 0===e&&(e=this.parseUShort());for(var t=Array(e),r=this.data,i=this.offset+this.relativeOffset,a=0;a<e;a++)t[a]=r.getUint16(i),i+=2;return this.relativeOffset+=2*e,t},Parser2.prototype.parseShortList=function(e){for(var t=Array(e),r=this.data,i=this.offset+this.relativeOffset,a=0;a<e;a++)t[a]=r.getInt16(i),i+=2;return this.relativeOffset+=2*e,t},Parser2.prototype.parseByteList=function(e){for(var t=Array(e),r=this.data,i=this.offset+this.relativeOffset,a=0;a<e;a++)t[a]=r.getUint8(i++);return this.relativeOffset+=e,t},Parser2.prototype.parseList=function(e,t){t||(t=e,e=this.parseUShort());for(var r=Array(e),i=0;i<e;i++)r[i]=t.call(this);return r},Parser2.prototype.parseList32=function(e,t){t||(t=e,e=this.parseULong());for(var r=Array(e),i=0;i<e;i++)r[i]=t.call(this);return r},Parser2.prototype.parseRecordList=function(e,t){t||(t=e,e=this.parseUShort());for(var r=Array(e),i=Object.keys(t),a=0;a<e;a++){for(var n={},s=0;s<i.length;s++){var o=i[s],l=t[o];n[o]=l.call(this)}r[a]=n}return r},Parser2.prototype.parseRecordList32=function(e,t){t||(t=e,e=this.parseULong());for(var r=Array(e),i=Object.keys(t),a=0;a<e;a++){for(var n={},s=0;s<i.length;s++){var o=i[s],l=t[o];n[o]=l.call(this)}r[a]=n}return r},Parser2.prototype.parseStruct=function(e){if("function"==typeof e)return e.call(this);for(var t=Object.keys(e),r={},i=0;i<t.length;i++){var a=t[i],n=e[a];r[a]=n.call(this)}return r},Parser2.prototype.parseValueRecord=function(e){if(void 0===e&&(e=this.parseUShort()),0!==e){var t={};return 1&e&&(t.xPlacement=this.parseShort()),2&e&&(t.yPlacement=this.parseShort()),4&e&&(t.xAdvance=this.parseShort()),8&e&&(t.yAdvance=this.parseShort()),16&e&&(t.xPlaDevice=void 0,this.parseShort()),32&e&&(t.yPlaDevice=void 0,this.parseShort()),64&e&&(t.xAdvDevice=void 0,this.parseShort()),128&e&&(t.yAdvDevice=void 0,this.parseShort()),t}},Parser2.prototype.parseValueRecordList=function(){for(var e=this.parseUShort(),t=this.parseUShort(),r=Array(t),i=0;i<t;i++)r[i]=this.parseValueRecord(e);return r},Parser2.prototype.parsePointer=function(e){var t=this.parseOffset16();if(t>0)return new Parser2(this.data,this.offset+t).parseStruct(e)},Parser2.prototype.parsePointer32=function(e){var t=this.parseOffset32();if(t>0)return new Parser2(this.data,this.offset+t).parseStruct(e)},Parser2.prototype.parseListOfLists=function(e){for(var t=this.parseOffset16List(),r=t.length,i=this.relativeOffset,a=Array(r),n=0;n<r;n++){var s=t[n];if(0===s){a[n]=void 0;continue}if(this.relativeOffset=s,e){for(var o=this.parseOffset16List(),l=Array(o.length),c=0;c<o.length;c++)this.relativeOffset=s+o[c],l[c]=e.call(this);a[n]=l}else a[n]=this.parseUShortList()}return this.relativeOffset=i,a},Parser2.prototype.parseCoverage=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort(),r=this.parseUShort();if(1===t)return{format:1,glyphs:this.parseUShortList(r)};if(2===t){for(var i=Array(r),a=0;a<r;a++)i[a]={start:this.parseUShort(),end:this.parseUShort(),index:this.parseUShort()};return{format:2,ranges:i}}throw Error("0x"+e.toString(16)+": Coverage format must be 1 or 2.")},Parser2.prototype.parseClassDef=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();if(1===t)return{format:1,startGlyph:this.parseUShort(),classes:this.parseUShortList()};if(2===t)return{format:2,ranges:this.parseRecordList({start:Parser2.uShort,end:Parser2.uShort,classId:Parser2.uShort})};throw Error("0x"+e.toString(16)+": ClassDef format must be 1 or 2.")},Parser2.list=function(e,t){return function(){return this.parseList(e,t)}},Parser2.list32=function(e,t){return function(){return this.parseList32(e,t)}},Parser2.recordList=function(e,t){return function(){return this.parseRecordList(e,t)}},Parser2.recordList32=function(e,t){return function(){return this.parseRecordList32(e,t)}},Parser2.pointer=function(e){return function(){return this.parsePointer(e)}},Parser2.pointer32=function(e){return function(){return this.parsePointer32(e)}},Parser2.tag=Parser2.prototype.parseTag,Parser2.byte=Parser2.prototype.parseByte,Parser2.uShort=Parser2.offset16=Parser2.prototype.parseUShort,Parser2.uShortList=Parser2.prototype.parseUShortList,Parser2.uLong=Parser2.offset32=Parser2.prototype.parseULong,Parser2.uLongList=Parser2.prototype.parseULongList,Parser2.struct=Parser2.prototype.parseStruct,Parser2.coverage=Parser2.prototype.parseCoverage,Parser2.classDef=Parser2.prototype.parseClassDef;var A={reserved:Parser2.uShort,reqFeatureIndex:Parser2.uShort,featureIndexes:Parser2.uShortList};Parser2.prototype.parseScriptList=function(){return this.parsePointer(Parser2.recordList({tag:Parser2.tag,script:Parser2.pointer({defaultLangSys:Parser2.pointer(A),langSysRecords:Parser2.recordList({tag:Parser2.tag,langSys:Parser2.pointer(A)})})}))||[]},Parser2.prototype.parseFeatureList=function(){return this.parsePointer(Parser2.recordList({tag:Parser2.tag,feature:Parser2.pointer({featureParams:Parser2.offset16,lookupListIndexes:Parser2.uShortList})}))||[]},Parser2.prototype.parseLookupList=function(e){return this.parsePointer(Parser2.list(Parser2.pointer(function(){var t=this.parseUShort();g.argument(1<=t&&t<=9,"GPOS/GSUB lookup type "+t+" unknown.");var r=this.parseUShort();return{lookupType:t,lookupFlag:r,subtables:this.parseList(Parser2.pointer(e[t])),markFilteringSet:16&r?this.parseUShort():void 0}})))||[]},Parser2.prototype.parseFeatureVariationsList=function(){return this.parsePointer32(function(){var e=this.parseUShort(),t=this.parseUShort();return g.argument(1===e&&t<1,"GPOS/GSUB feature variations table unknown."),this.parseRecordList32({conditionSetOffset:Parser2.offset32,featureTableSubstitutionOffset:Parser2.offset32})})||[]};var C={getByte,getCard8:getByte,getUShort,getCard16:getUShort,getShort,getULong,getFixed,getTag,getOffset,getBytes,bytesToString,Parser:Parser2};function parseCmapTableFormat12(e,t){t.parseUShort(),e.length=t.parseULong(),e.language=t.parseULong(),e.groupCount=r=t.parseULong(),e.glyphIndexMap={};for(var r,i=0;i<r;i+=1)for(var a=t.parseULong(),n=t.parseULong(),s=t.parseULong(),o=a;o<=n;o+=1)e.glyphIndexMap[o]=s,s++}function parseCmapTableFormat4(e,t,r,i,a){e.length=t.parseUShort(),e.language=t.parseUShort(),e.segCount=n=t.parseUShort()>>1,t.skip("uShort",3),e.glyphIndexMap={};for(var n,s=new C.Parser(r,i+a+14),o=new C.Parser(r,i+a+16+2*n),l=new C.Parser(r,i+a+16+4*n),c=new C.Parser(r,i+a+16+6*n),u=i+a+16+8*n,h=0;h<n-1;h+=1)for(var p=void 0,d=s.parseUShort(),f=o.parseUShort(),m=l.parseShort(),g=c.parseUShort(),v=f;v<=d;v+=1)0!==g?(u=c.offset+c.relativeOffset-2+g+(v-f)*2,0!==(p=C.getUShort(r,u))&&(p=p+m&65535)):p=v+m&65535,e.glyphIndexMap[v]=p}function addSegment(e,t,r){e.segments.push({end:t,start:t,delta:-(t-r),offset:0,glyphIndex:r})}function addTerminatorSegment(e){e.segments.push({end:65535,start:65535,delta:1,offset:0})}var M={parse:function(e,t){var r={};r.version=C.getUShort(e,t),g.argument(0===r.version,"cmap table version should be 0."),r.numTables=C.getUShort(e,t+2);for(var i=-1,a=r.numTables-1;a>=0;a-=1){var n=C.getUShort(e,t+4+8*a),s=C.getUShort(e,t+4+8*a+2);if(3===n&&(0===s||1===s||10===s)||0===n&&(0===s||1===s||2===s||3===s||4===s)){i=C.getULong(e,t+4+8*a+4);break}}if(-1===i)throw Error("No valid cmap sub-tables found.");var o=new C.Parser(e,t+i);if(r.format=o.parseUShort(),12===r.format)parseCmapTableFormat12(r,o);else if(4===r.format)parseCmapTableFormat4(r,o,e,t,i);else throw Error("Only format 4 and 12 cmap tables are supported (found format "+r.format+").");return r},make:function(e){var t,r=!0;for(t=e.length-1;t>0;t-=1)if(e.get(t).unicode>65535){console.log("Adding CMAP format 12 (needed!)"),r=!1;break}var i=[{name:"version",type:"USHORT",value:0},{name:"numTables",type:"USHORT",value:r?1:2},{name:"platformID",type:"USHORT",value:3},{name:"encodingID",type:"USHORT",value:1},{name:"offset",type:"ULONG",value:r?12:20}];r||(i=i.concat([{name:"cmap12PlatformID",type:"USHORT",value:3},{name:"cmap12EncodingID",type:"USHORT",value:10},{name:"cmap12Offset",type:"ULONG",value:0}])),i=i.concat([{name:"format",type:"USHORT",value:4},{name:"cmap4Length",type:"USHORT",value:0},{name:"language",type:"USHORT",value:0},{name:"segCountX2",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);var a=new E.Table("cmap",i);for(t=0,a.segments=[];t<e.length;t+=1){for(var n=e.get(t),s=0;s<n.unicodes.length;s+=1)addSegment(a,n.unicodes[s],t);a.segments=a.segments.sort(function(e,t){return e.start-t.start})}addTerminatorSegment(a);var o=a.segments.length,l=0,c=[],u=[],h=[],p=[],d=[],f=[];for(t=0;t<o;t+=1){var m=a.segments[t];m.end<=65535&&m.start<=65535?(c=c.concat({name:"end_"+t,type:"USHORT",value:m.end}),u=u.concat({name:"start_"+t,type:"USHORT",value:m.start}),h=h.concat({name:"idDelta_"+t,type:"SHORT",value:m.delta}),p=p.concat({name:"idRangeOffset_"+t,type:"USHORT",value:m.offset}),void 0!==m.glyphId&&(d=d.concat({name:"glyph_"+t,type:"USHORT",value:m.glyphId}))):l+=1,r||void 0===m.glyphIndex||(f=(f=(f=f.concat({name:"cmap12Start_"+t,type:"ULONG",value:m.start})).concat({name:"cmap12End_"+t,type:"ULONG",value:m.end})).concat({name:"cmap12Glyph_"+t,type:"ULONG",value:m.glyphIndex}))}if(a.segCountX2=(o-l)*2,a.searchRange=2*Math.pow(2,Math.floor(Math.log(o-l)/Math.log(2))),a.entrySelector=Math.log(a.searchRange/2)/Math.log(2),a.rangeShift=a.segCountX2-a.searchRange,a.fields=a.fields.concat(c),a.fields.push({name:"reservedPad",type:"USHORT",value:0}),a.fields=a.fields.concat(u),a.fields=a.fields.concat(h),a.fields=a.fields.concat(p),a.fields=a.fields.concat(d),a.cmap4Length=14+2*c.length+2+2*u.length+2*h.length+2*p.length+2*d.length,!r){var g=16+4*f.length;a.cmap12Offset=20+a.cmap4Length,a.fields=a.fields.concat([{name:"cmap12Format",type:"USHORT",value:12},{name:"cmap12Reserved",type:"USHORT",value:0},{name:"cmap12Length",type:"ULONG",value:g},{name:"cmap12Language",type:"ULONG",value:0},{name:"cmap12nGroups",type:"ULONG",value:f.length/3}]),a.fields=a.fields.concat(f)}return a}},P=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","266 ff","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"],w=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","","endash","dagger","daggerdbl","periodcentered","","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","","questiondown","","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","","ring","cedilla","","hungarumlaut","ogonek","caron","emdash","","","","","","","","","","","","","","","","","AE","","ordfeminine","","","","","Lslash","Oslash","OE","ordmasculine","","","","","","ae","","","","dotlessi","","","lslash","oslash","oe","germandbls"],I=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclamsmall","Hungarumlautsmall","","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","comma","hyphen","period","fraction","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","colon","semicolon","commasuperior","threequartersemdash","periodsuperior","questionsmall","","asuperior","bsuperior","centsuperior","dsuperior","esuperior","","","isuperior","","","lsuperior","msuperior","nsuperior","osuperior","","","rsuperior","ssuperior","tsuperior","","ff","fi","fl","ffi","ffl","parenleftinferior","","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdownsmall","centoldstyle","Lslashsmall","","","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","","Dotaccentsmall","","","Macronsmall","","","figuredash","hypheninferior","","","Ogoneksmall","Ringsmall","Cedillasmall","","","","onequarter","onehalf","threequarters","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","","","zerosuperior","onesuperior","twosuperior","threesuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall"],k=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"];function DefaultEncoding(e){this.font=e}function CmapEncoding(e){this.cmap=e}function CffEncoding(e,t){this.encoding=e,this.charset=t}function GlyphNames(e){switch(e.version){case 1:this.names=k.slice();break;case 2:this.names=Array(e.numberOfGlyphs);for(var t=0;t<e.numberOfGlyphs;t++)e.glyphNameIndex[t]<k.length?this.names[t]=k[e.glyphNameIndex[t]]:this.names[t]=e.names[e.glyphNameIndex[t]-k.length];break;case 2.5:this.names=Array(e.numberOfGlyphs);for(var r=0;r<e.numberOfGlyphs;r++)this.names[r]=k[r+e.glyphNameIndex[r]];break;default:this.names=[]}}function addGlyphNamesAll(e){for(var t,r=e.tables.cmap.glyphIndexMap,i=Object.keys(r),a=0;a<i.length;a+=1){var n=i[a],s=r[n];(t=e.glyphs.get(s)).addUnicode(parseInt(n))}for(var o=0;o<e.glyphs.length;o+=1)t=e.glyphs.get(o),e.cffEncoding?e.isCIDFont?t.name="gid"+o:t.name=e.cffEncoding.charset[o]:e.glyphNames.names&&(t.name=e.glyphNames.glyphIndexToName(o))}function addGlyphNamesToUnicodeMap(e){e._IndexToUnicodeMap={};for(var t=e.tables.cmap.glyphIndexMap,r=Object.keys(t),i=0;i<r.length;i+=1){var a=r[i],n=t[a];void 0===e._IndexToUnicodeMap[n]?e._IndexToUnicodeMap[n]={unicodes:[parseInt(a)]}:e._IndexToUnicodeMap[n].unicodes.push(parseInt(a))}}function addGlyphNames(e,t){t.lowMemory?addGlyphNamesToUnicodeMap(e):addGlyphNamesAll(e)}DefaultEncoding.prototype.charToGlyphIndex=function(e){var t=e.codePointAt(0),r=this.font.glyphs;if(r){for(var i=0;i<r.length;i+=1)for(var a=r.get(i),n=0;n<a.unicodes.length;n+=1)if(a.unicodes[n]===t)return i}return null},CmapEncoding.prototype.charToGlyphIndex=function(e){return this.cmap.glyphIndexMap[e.codePointAt(0)]||0},CffEncoding.prototype.charToGlyphIndex=function(e){var t=e.codePointAt(0),r=this.encoding[t];return this.charset.indexOf(r)},GlyphNames.prototype.nameToGlyphIndex=function(e){return this.names.indexOf(e)},GlyphNames.prototype.glyphIndexToName=function(e){return this.names[e]};var _={line:function(e,t,r,i,a){e.beginPath(),e.moveTo(t,r),e.lineTo(i,a),e.stroke()}};function getPathDefinition(e,t){var r=t||new Path2;return{configurable:!0,get:function(){return"function"==typeof r&&(r=r()),r},set:function(e){r=e}}}function Glyph(e){this.bindConstructorValues(e)}function defineDependentProperty(e,t,r){Object.defineProperty(e,t,{get:function(){return e.path,e[r]},set:function(t){e[r]=t},enumerable:!0,configurable:!0})}function GlyphSet(e,t){if(this.font=e,this.glyphs={},Array.isArray(t))for(var r=0;r<t.length;r++){var i=t[r];i.path.unitsPerEm=e.unitsPerEm,this.glyphs[r]=i}this.length=t&&t.length||0}Glyph.prototype.bindConstructorValues=function(e){this.index=e.index||0,this.name=e.name||null,this.unicode=e.unicode||void 0,this.unicodes=e.unicodes||void 0!==e.unicode?[e.unicode]:[],"xMin"in e&&(this.xMin=e.xMin),"yMin"in e&&(this.yMin=e.yMin),"xMax"in e&&(this.xMax=e.xMax),"yMax"in e&&(this.yMax=e.yMax),"advanceWidth"in e&&(this.advanceWidth=e.advanceWidth),Object.defineProperty(this,"path",getPathDefinition(this,e.path))},Glyph.prototype.addUnicode=function(e){0===this.unicodes.length&&(this.unicode=e),this.unicodes.push(e)},Glyph.prototype.getBoundingBox=function(){return this.path.getBoundingBox()},Glyph.prototype.getPath=function(e,t,r,i,a){e=void 0!==e?e:0,t=void 0!==t?t:0,r=void 0!==r?r:72,i||(i={});var n,s,o=i.xScale,l=i.yScale;if(i.hinting&&a&&a.hinting&&(s=this.path&&a.hinting.exec(this,r)),s)n=a.hinting.getCommands(s),e=Math.round(e),t=Math.round(t),o=l=1;else{n=this.path.commands;var c=1/(this.path.unitsPerEm||1e3)*r;void 0===o&&(o=c),void 0===l&&(l=c)}for(var u=new Path2,h=0;h<n.length;h+=1){var p=n[h];"M"===p.type?u.moveTo(e+p.x*o,t+-p.y*l):"L"===p.type?u.lineTo(e+p.x*o,t+-p.y*l):"Q"===p.type?u.quadraticCurveTo(e+p.x1*o,t+-p.y1*l,e+p.x*o,t+-p.y*l):"C"===p.type?u.curveTo(e+p.x1*o,t+-p.y1*l,e+p.x2*o,t+-p.y2*l,e+p.x*o,t+-p.y*l):"Z"===p.type&&u.closePath()}return u},Glyph.prototype.getContours=function(){if(void 0===this.points)return[];for(var e=[],t=[],r=0;r<this.points.length;r+=1){var i=this.points[r];t.push(i),i.lastPointOfContour&&(e.push(t),t=[])}return g.argument(0===t.length,"There are still points left in the current contour."),e},Glyph.prototype.getMetrics=function(){for(var e=this.path.commands,t=[],r=[],i=0;i<e.length;i+=1){var a=e[i];"Z"!==a.type&&(t.push(a.x),r.push(a.y)),("Q"===a.type||"C"===a.type)&&(t.push(a.x1),r.push(a.y1)),"C"===a.type&&(t.push(a.x2),r.push(a.y2))}var n={xMin:Math.min.apply(null,t),yMin:Math.min.apply(null,r),xMax:Math.max.apply(null,t),yMax:Math.max.apply(null,r),leftSideBearing:this.leftSideBearing};return isFinite(n.xMin)||(n.xMin=0),isFinite(n.xMax)||(n.xMax=this.advanceWidth),isFinite(n.yMin)||(n.yMin=0),isFinite(n.yMax)||(n.yMax=0),n.rightSideBearing=this.advanceWidth-n.leftSideBearing-(n.xMax-n.xMin),n},Glyph.prototype.draw=function(e,t,r,i,a){this.getPath(t,r,i,a).draw(e)},Glyph.prototype.drawPoints=function(e,t,r,i){function drawCircles(t,r,i,a){e.beginPath();for(var n=0;n<t.length;n+=1)e.moveTo(r+t[n].x*a,i+t[n].y*a),e.arc(r+t[n].x*a,i+t[n].y*a,2,0,2*Math.PI,!1);e.closePath(),e.fill()}t=void 0!==t?t:0,r=void 0!==r?r:0,i=void 0!==i?i:24;for(var a=1/this.path.unitsPerEm*i,n=[],s=[],o=this.path,l=0;l<o.commands.length;l+=1){var c=o.commands[l];void 0!==c.x&&n.push({x:c.x,y:-c.y}),void 0!==c.x1&&s.push({x:c.x1,y:-c.y1}),void 0!==c.x2&&s.push({x:c.x2,y:-c.y2})}e.fillStyle="blue",drawCircles(n,t,r,a),e.fillStyle="red",drawCircles(s,t,r,a)},Glyph.prototype.drawMetrics=function(e,t,r,i){t=void 0!==t?t:0,r=void 0!==r?r:0,i=void 0!==i?i:24,a=1/this.path.unitsPerEm*i,e.lineWidth=1,e.strokeStyle="black",_.line(e,t,-1e4,t,1e4),_.line(e,-1e4,r,1e4,r);var a,n=this.xMin||0,s=this.yMin||0,o=this.xMax||0,l=this.yMax||0,c=this.advanceWidth||0;e.strokeStyle="blue",_.line(e,t+n*a,-1e4,t+n*a,1e4),_.line(e,t+o*a,-1e4,t+o*a,1e4),_.line(e,-1e4,r+-s*a,1e4,r+-s*a),_.line(e,-1e4,r+-l*a,1e4,r+-l*a),e.strokeStyle="green",_.line(e,t+c*a,-1e4,t+c*a,1e4)},GlyphSet.prototype.get=function(e){if(void 0===this.glyphs[e]){this.font._push(e),"function"==typeof this.glyphs[e]&&(this.glyphs[e]=this.glyphs[e]());var t=this.glyphs[e],r=this.font._IndexToUnicodeMap[e];if(r)for(var i=0;i<r.unicodes.length;i++)t.addUnicode(r.unicodes[i]);this.font.cffEncoding?this.font.isCIDFont?t.name="gid"+e:t.name=this.font.cffEncoding.charset[e]:this.font.glyphNames.names&&(t.name=this.font.glyphNames.glyphIndexToName(e)),this.glyphs[e].advanceWidth=this.font._hmtxTableData[e].advanceWidth,this.glyphs[e].leftSideBearing=this.font._hmtxTableData[e].leftSideBearing}else"function"==typeof this.glyphs[e]&&(this.glyphs[e]=this.glyphs[e]());return this.glyphs[e]},GlyphSet.prototype.push=function(e,t){this.glyphs[e]=t,this.length++};var O={GlyphSet,glyphLoader:function(e,t){return new Glyph({index:t,font:e})},ttfGlyphLoader:function(e,t,r,i,a,n){return function(){var s=new Glyph({index:t,font:e});return s.path=function(){r(s,i,a);var t=n(e.glyphs,s);return t.unitsPerEm=e.unitsPerEm,t},defineDependentProperty(s,"xMin","_xMin"),defineDependentProperty(s,"xMax","_xMax"),defineDependentProperty(s,"yMin","_yMin"),defineDependentProperty(s,"yMax","_yMax"),s}},cffGlyphLoader:function(e,t,r,i){return function(){var a=new Glyph({index:t,font:e});return a.path=function(){var t=r(e,a,i);return t.unitsPerEm=e.unitsPerEm,t},a}}};function equals(e,t){if(e===t)return!0;if(!(Array.isArray(e)&&Array.isArray(t))||e.length!==t.length)return!1;for(var r=0;r<e.length;r+=1)if(!equals(e[r],t[r]))return!1;return!0}function calcCFFSubroutineBias(e){return e.length<1240?107:e.length<33900?1131:32768}function parseCFFIndex(e,t,r){var i,a,n=[],s=[],o=C.getCard16(e,t);if(0!==o){var l=C.getByte(e,t+2);i=t+(o+1)*l+2;for(var c=t+3,u=0;u<o+1;u+=1)n.push(C.getOffset(e,c,l)),c+=l;a=i+n[o]}else a=t+2;for(var h=0;h<n.length-1;h+=1){var p=C.getBytes(e,i+n[h],i+n[h+1]);r&&(p=r(p)),s.push(p)}return{objects:s,startOffset:t,endOffset:a}}function parseCFFIndexLowMemory(e,t){var r,i,a=[],n=C.getCard16(e,t);if(0!==n){var s=C.getByte(e,t+2);r=t+(n+1)*s+2;for(var o=t+3,l=0;l<n+1;l+=1)a.push(C.getOffset(e,o,s)),o+=s;i=r+a[n]}else i=t+2;return{offsets:a,startOffset:t,endOffset:i}}function getCffIndexObject(e,t,r,i,a){var n=C.getCard16(r,i),s=0;if(0!==n){var o=C.getByte(r,i+2);s=i+(n+1)*o+2}var l=C.getBytes(r,s+t[e],s+t[e+1]);return a&&(l=a(l)),l}function parseFloatOperand(e){for(var t="",r=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"];;){var i=e.parseByte(),a=i>>4,n=15&i;if(15===a||(t+=r[a],15===n))break;t+=r[n]}return parseFloat(t)}function parseOperand(e,t){var r,i;if(28===t)return(r=e.parseByte())<<8|(i=e.parseByte());if(29===t)return r=e.parseByte(),r<<24|(i=e.parseByte())<<16|e.parseByte()<<8|e.parseByte();if(30===t)return parseFloatOperand(e);if(t>=32&&t<=246)return t-139;if(t>=247&&t<=250)return(t-247)*256+(r=e.parseByte())+108;if(t>=251&&t<=254)return-(256*(t-251))-(r=e.parseByte())-108;throw Error("Invalid b0 "+t)}function entriesToObject(e){for(var t={},r=0;r<e.length;r+=1){var i=e[r][0],a=e[r][1],n=void 0;if(n=1===a.length?a[0]:a,t.hasOwnProperty(i)&&!isNaN(t[i]))throw Error("Object "+t+" already has key "+i);t[i]=n}return t}function parseCFFDict(e,t,r){t=void 0!==t?t:0;var i=new C.Parser(e,t),a=[],n=[];for(r=void 0!==r?r:e.length;i.relativeOffset<r;){var s=i.parseByte();s<=21?(12===s&&(s=1200+i.parseByte()),a.push([s,n]),n=[]):n.push(parseOperand(i,s))}return entriesToObject(a)}function getCFFString(e,t){return t=t<=390?P[t]:e[t-391]}function interpretDict(e,t,r){for(var i,a={},n=0;n<t.length;n+=1){var s=t[n];if(Array.isArray(s.type)){var o=[];o.length=s.type.length;for(var l=0;l<s.type.length;l++)void 0===(i=void 0!==e[s.op]?e[s.op][l]:void 0)&&(i=void 0!==s.value&&void 0!==s.value[l]?s.value[l]:null),"SID"===s.type[l]&&(i=getCFFString(r,i)),o[l]=i;a[s.name]=o}else void 0===(i=e[s.op])&&(i=void 0!==s.value?s.value:null),"SID"===s.type&&(i=getCFFString(r,i)),a[s.name]=i}return a}function parseCFFHeader(e,t){var r={};return r.formatMajor=C.getCard8(e,t),r.formatMinor=C.getCard8(e,t+1),r.size=C.getCard8(e,t+2),r.offsetSize=C.getCard8(e,t+3),r.startOffset=t,r.endOffset=t+4,r}var N=[{name:"version",op:0,type:"SID"},{name:"notice",op:1,type:"SID"},{name:"copyright",op:1200,type:"SID"},{name:"fullName",op:2,type:"SID"},{name:"familyName",op:3,type:"SID"},{name:"weight",op:4,type:"SID"},{name:"isFixedPitch",op:1201,type:"number",value:0},{name:"italicAngle",op:1202,type:"number",value:0},{name:"underlinePosition",op:1203,type:"number",value:-100},{name:"underlineThickness",op:1204,type:"number",value:50},{name:"paintType",op:1205,type:"number",value:0},{name:"charstringType",op:1206,type:"number",value:2},{name:"fontMatrix",op:1207,type:["real","real","real","real","real","real"],value:[.001,0,0,.001,0,0]},{name:"uniqueId",op:13,type:"number"},{name:"fontBBox",op:5,type:["number","number","number","number"],value:[0,0,0,0]},{name:"strokeWidth",op:1208,type:"number",value:0},{name:"xuid",op:14,type:[],value:null},{name:"charset",op:15,type:"offset",value:0},{name:"encoding",op:16,type:"offset",value:0},{name:"charStrings",op:17,type:"offset",value:0},{name:"private",op:18,type:["number","offset"],value:[0,0]},{name:"ros",op:1230,type:["SID","SID","number"]},{name:"cidFontVersion",op:1231,type:"number",value:0},{name:"cidFontRevision",op:1232,type:"number",value:0},{name:"cidFontType",op:1233,type:"number",value:0},{name:"cidCount",op:1234,type:"number",value:8720},{name:"uidBase",op:1235,type:"number"},{name:"fdArray",op:1236,type:"offset"},{name:"fdSelect",op:1237,type:"offset"},{name:"fontName",op:1238,type:"SID"}],L=[{name:"subrs",op:19,type:"offset",value:0},{name:"defaultWidthX",op:20,type:"number",value:0},{name:"nominalWidthX",op:21,type:"number",value:0}];function parseCFFTopDict(e,t){return interpretDict(parseCFFDict(e,0,e.byteLength),N,t)}function gatherCFFTopDicts(e,t,r,i){for(var a=[],n=0;n<r.length;n+=1){var s=parseCFFTopDict(new DataView(new Uint8Array(r[n]).buffer),i);s._subrs=[],s._subrsBias=0,s._defaultWidthX=0,s._nominalWidthX=0;var o=s.private[0],l=s.private[1];if(0!==o&&0!==l){var c=interpretDict(parseCFFDict(e,l+t,o),L,i);if(s._defaultWidthX=c.defaultWidthX,s._nominalWidthX=c.nominalWidthX,0!==c.subrs){var u=parseCFFIndex(e,l+c.subrs+t);s._subrs=u.objects,s._subrsBias=calcCFFSubroutineBias(s._subrs)}s._privateDict=c}a.push(s)}return a}function parseCFFCharset(e,t,r,i){var a,n,s=new C.Parser(e,t);r-=1;var o=[".notdef"],l=s.parseCard8();if(0===l)for(var c=0;c<r;c+=1)a=s.parseSID(),o.push(getCFFString(i,a));else if(1===l)for(;o.length<=r;){a=s.parseSID(),n=s.parseCard8();for(var u=0;u<=n;u+=1)o.push(getCFFString(i,a)),a+=1}else if(2===l)for(;o.length<=r;){a=s.parseSID(),n=s.parseCard16();for(var h=0;h<=n;h+=1)o.push(getCFFString(i,a)),a+=1}else throw Error("Unknown charset format "+l);return o}function parseCFFEncoding(e,t,r){var i,a={},n=new C.Parser(e,t),s=n.parseCard8();if(0===s)for(var o=n.parseCard8(),l=0;l<o;l+=1)a[i=n.parseCard8()]=l;else if(1===s){var c=n.parseCard8();i=1;for(var u=0;u<c;u+=1)for(var h=n.parseCard8(),p=n.parseCard8(),d=h;d<=h+p;d+=1)a[d]=i,i+=1}else throw Error("Unknown encoding format "+s);return new CffEncoding(a,r)}function parseCFFCharstring(e,t,r){var i,a,n,s,o,l,c,u,h=new Path2,p=[],d=0,f=!1,m=!1,g=0,v=0;if(e.isCIDFont){var y=e.tables.cff.topDict._fdSelect[t.index],x=e.tables.cff.topDict._fdArray[y];o=x._subrs,l=x._subrsBias,c=x._defaultWidthX,u=x._nominalWidthX}else o=e.tables.cff.topDict._subrs,l=e.tables.cff.topDict._subrsBias,c=e.tables.cff.topDict._defaultWidthX,u=e.tables.cff.topDict._nominalWidthX;var b=c;function newContour(e,t){m&&h.closePath(),h.moveTo(e,t),m=!0}function parseStems(){p.length%2==0||f||(b=p.shift()+u),d+=p.length>>1,p.length=0,f=!0}function parse2(r){for(var c,y,x,T,S,E,R,A,C,M,P,w,I=0;I<r.length;){var k=r[I];switch(I+=1,k){case 1:case 3:case 18:case 23:parseStems();break;case 4:p.length>1&&!f&&(b=p.shift()+u,f=!0),v+=p.pop(),newContour(g,v);break;case 5:for(;p.length>0;)g+=p.shift(),v+=p.shift(),h.lineTo(g,v);break;case 6:for(;p.length>0&&(g+=p.shift(),h.lineTo(g,v),0!==p.length);)v+=p.shift(),h.lineTo(g,v);break;case 7:for(;p.length>0&&(v+=p.shift(),h.lineTo(g,v),0!==p.length);)g+=p.shift(),h.lineTo(g,v);break;case 8:for(;p.length>0;)i=g+p.shift(),a=v+p.shift(),n=i+p.shift(),s=a+p.shift(),g=n+p.shift(),v=s+p.shift(),h.curveTo(i,a,n,s,g,v);break;case 10:(E=o[S=p.pop()+l])&&parse2(E);break;case 11:return;case 12:switch(k=r[I],I+=1,k){case 35:i=g+p.shift(),a=v+p.shift(),n=i+p.shift(),s=a+p.shift(),R=n+p.shift(),A=s+p.shift(),C=R+p.shift(),M=A+p.shift(),P=C+p.shift(),w=M+p.shift(),g=P+p.shift(),v=w+p.shift(),p.shift(),h.curveTo(i,a,n,s,R,A),h.curveTo(C,M,P,w,g,v);break;case 34:i=g+p.shift(),a=v,n=i+p.shift(),s=a+p.shift(),R=n+p.shift(),A=s,C=R+p.shift(),M=s,P=C+p.shift(),w=v,g=P+p.shift(),h.curveTo(i,a,n,s,R,A),h.curveTo(C,M,P,w,g,v);break;case 36:i=g+p.shift(),a=v+p.shift(),n=i+p.shift(),s=a+p.shift(),R=n+p.shift(),A=s,C=R+p.shift(),M=s,P=C+p.shift(),w=M+p.shift(),g=P+p.shift(),h.curveTo(i,a,n,s,R,A),h.curveTo(C,M,P,w,g,v);break;case 37:i=g+p.shift(),a=v+p.shift(),n=i+p.shift(),s=a+p.shift(),R=n+p.shift(),A=s+p.shift(),C=R+p.shift(),M=A+p.shift(),P=C+p.shift(),w=M+p.shift(),Math.abs(P-g)>Math.abs(w-v)?g=P+p.shift():v=w+p.shift(),h.curveTo(i,a,n,s,R,A),h.curveTo(C,M,P,w,g,v);break;default:console.log("Glyph "+t.index+": unknown operator 1200"+k),p.length=0}break;case 14:p.length>0&&!f&&(b=p.shift()+u,f=!0),m&&(h.closePath(),m=!1);break;case 19:case 20:parseStems(),I+=d+7>>3;break;case 21:p.length>2&&!f&&(b=p.shift()+u,f=!0),v+=p.pop(),newContour(g+=p.pop(),v);break;case 22:p.length>1&&!f&&(b=p.shift()+u,f=!0),newContour(g+=p.pop(),v);break;case 24:for(;p.length>2;)i=g+p.shift(),a=v+p.shift(),n=i+p.shift(),s=a+p.shift(),g=n+p.shift(),v=s+p.shift(),h.curveTo(i,a,n,s,g,v);g+=p.shift(),v+=p.shift(),h.lineTo(g,v);break;case 25:for(;p.length>6;)g+=p.shift(),v+=p.shift(),h.lineTo(g,v);i=g+p.shift(),a=v+p.shift(),n=i+p.shift(),s=a+p.shift(),g=n+p.shift(),v=s+p.shift(),h.curveTo(i,a,n,s,g,v);break;case 26:for(p.length%2&&(g+=p.shift());p.length>0;)i=g,a=v+p.shift(),n=i+p.shift(),s=a+p.shift(),g=n,v=s+p.shift(),h.curveTo(i,a,n,s,g,v);break;case 27:for(p.length%2&&(v+=p.shift());p.length>0;)i=g+p.shift(),a=v,n=i+p.shift(),s=a+p.shift(),g=n+p.shift(),v=s,h.curveTo(i,a,n,s,g,v);break;case 28:c=r[I],y=r[I+1],p.push((c<<24|y<<16)>>16),I+=2;break;case 29:S=p.pop()+e.gsubrsBias,(E=e.gsubrs[S])&&parse2(E);break;case 30:for(;p.length>0&&(i=g,a=v+p.shift(),n=i+p.shift(),s=a+p.shift(),g=n+p.shift(),v=s+(1===p.length?p.shift():0),h.curveTo(i,a,n,s,g,v),0!==p.length);)i=g+p.shift(),a=v,n=i+p.shift(),v=(s=a+p.shift())+p.shift(),g=n+(1===p.length?p.shift():0),h.curveTo(i,a,n,s,g,v);break;case 31:for(;p.length>0&&(i=g+p.shift(),a=v,n=i+p.shift(),v=(s=a+p.shift())+p.shift(),g=n+(1===p.length?p.shift():0),h.curveTo(i,a,n,s,g,v),0!==p.length);)i=g,a=v+p.shift(),n=i+p.shift(),s=a+p.shift(),g=n+p.shift(),v=s+(1===p.length?p.shift():0),h.curveTo(i,a,n,s,g,v);break;default:k<32?console.log("Glyph "+t.index+": unknown operator "+k):k<247?p.push(k-139):k<251?(c=r[I],I+=1,p.push((k-247)*256+c+108)):k<255?(c=r[I],I+=1,p.push(-(256*(k-251))-c-108)):(c=r[I],y=r[I+1],x=r[I+2],T=r[I+3],I+=4,p.push((c<<24|y<<16|x<<8|T)/65536))}}}return parse2(r),t.advanceWidth=b,h}function parseCFFFDSelect(e,t,r,i){var a=[],n=new C.Parser(e,t),s=n.parseCard8();if(0===s)for(var o=0;o<r;o++){if((l=n.parseCard8())>=i)throw Error("CFF table CID Font FDSelect has bad FD index value "+l+" (FD count "+i+")");a.push(l)}else if(3===s){var l,c,u=n.parseCard16(),h=n.parseCard16();if(0!==h)throw Error("CFF Table CID Font FDSelect format 3 range has bad initial GID "+h);for(var p=0;p<u;p++){if(l=n.parseCard8(),c=n.parseCard16(),l>=i)throw Error("CFF table CID Font FDSelect has bad FD index value "+l+" (FD count "+i+")");if(c>r)throw Error("CFF Table CID Font FDSelect format 3 range has bad GID "+c);for(;h<c;h++)a.push(l);h=c}if(c!==r)throw Error("CFF Table CID Font FDSelect format 3 range has bad final GID "+c)}else throw Error("CFF Table CID Font FDSelect table has unsupported format "+s);return a}function encodeString(e,t){var r,i=P.indexOf(e);return i>=0&&(r=i),(i=t.indexOf(e))>=0?r=i+P.length:(r=P.length+t.length,t.push(e)),r}function makeHeader(){return new E.Record("Header",[{name:"major",type:"Card8",value:1},{name:"minor",type:"Card8",value:0},{name:"hdrSize",type:"Card8",value:4},{name:"major",type:"Card8",value:1}])}function makeNameIndex(e){var t=new E.Record("Name INDEX",[{name:"names",type:"INDEX",value:[]}]);t.names=[];for(var r=0;r<e.length;r+=1)t.names.push({name:"name_"+r,type:"NAME",value:e[r]});return t}function makeDict(e,t,r){for(var i={},a=0;a<e.length;a+=1){var n=e[a],s=t[n.name];void 0===s||equals(s,n.value)||("SID"===n.type&&(s=encodeString(s,r)),i[n.op]={name:n.name,type:n.type,value:s})}return i}function makeTopDict(e,t){var r=new E.Record("Top DICT",[{name:"dict",type:"DICT",value:{}}]);return r.dict=makeDict(N,e,t),r}function makeTopDictIndex(e){var t=new E.Record("Top DICT INDEX",[{name:"topDicts",type:"INDEX",value:[]}]);return t.topDicts=[{name:"topDict_0",type:"TABLE",value:e}],t}function makeStringIndex(e){var t=new E.Record("String INDEX",[{name:"strings",type:"INDEX",value:[]}]);t.strings=[];for(var r=0;r<e.length;r+=1)t.strings.push({name:"string_"+r,type:"STRING",value:e[r]});return t}function makeGlobalSubrIndex(){return new E.Record("Global Subr INDEX",[{name:"subrs",type:"INDEX",value:[]}])}function makeCharsets(e,t){for(var r=new E.Record("Charsets",[{name:"format",type:"Card8",value:0}]),i=0;i<e.length;i+=1){var a=encodeString(e[i],t);r.fields.push({name:"glyph_"+i,type:"SID",value:a})}return r}function glyphToOps(e){var t=[],r=e.path;t.push({name:"width",type:"NUMBER",value:e.advanceWidth});for(var i=0,a=0,n=0;n<r.commands.length;n+=1){var s=void 0,o=void 0,l=r.commands[n];if("Q"===l.type){var c=1/3,u=2/3;l={type:"C",x:l.x,y:l.y,x1:Math.round(c*i+u*l.x1),y1:Math.round(c*a+u*l.y1),x2:Math.round(c*l.x+u*l.x1),y2:Math.round(c*l.y+u*l.y1)}}if("M"===l.type)s=Math.round(l.x-i),o=Math.round(l.y-a),t.push({name:"dx",type:"NUMBER",value:s}),t.push({name:"dy",type:"NUMBER",value:o}),t.push({name:"rmoveto",type:"OP",value:21}),i=Math.round(l.x),a=Math.round(l.y);else if("L"===l.type)s=Math.round(l.x-i),o=Math.round(l.y-a),t.push({name:"dx",type:"NUMBER",value:s}),t.push({name:"dy",type:"NUMBER",value:o}),t.push({name:"rlineto",type:"OP",value:5}),i=Math.round(l.x),a=Math.round(l.y);else if("C"===l.type){var h=Math.round(l.x1-i),p=Math.round(l.y1-a),d=Math.round(l.x2-l.x1),f=Math.round(l.y2-l.y1);s=Math.round(l.x-l.x2),o=Math.round(l.y-l.y2),t.push({name:"dx1",type:"NUMBER",value:h}),t.push({name:"dy1",type:"NUMBER",value:p}),t.push({name:"dx2",type:"NUMBER",value:d}),t.push({name:"dy2",type:"NUMBER",value:f}),t.push({name:"dx",type:"NUMBER",value:s}),t.push({name:"dy",type:"NUMBER",value:o}),t.push({name:"rrcurveto",type:"OP",value:8}),i=Math.round(l.x),a=Math.round(l.y)}}return t.push({name:"endchar",type:"OP",value:14}),t}function makeCharStringsIndex(e){for(var t=new E.Record("CharStrings INDEX",[{name:"charStrings",type:"INDEX",value:[]}]),r=0;r<e.length;r+=1){var i=e.get(r),a=glyphToOps(i);t.charStrings.push({name:i.name,type:"CHARSTRING",value:a})}return t}function makePrivateDict(e,t){var r=new E.Record("Private DICT",[{name:"dict",type:"DICT",value:{}}]);return r.dict=makeDict(L,e,t),r}var F={parse:function(e,t,r,i){r.tables.cff={};var a,n,s,o=parseCFFHeader(e,t),l=parseCFFIndex(e,o.endOffset,C.bytesToString),c=parseCFFIndex(e,l.endOffset),u=parseCFFIndex(e,c.endOffset,C.bytesToString),h=parseCFFIndex(e,u.endOffset);r.gsubrs=h.objects,r.gsubrsBias=calcCFFSubroutineBias(r.gsubrs);var p=gatherCFFTopDicts(e,t,c.objects,u.objects);if(1!==p.length)throw Error("CFF table has too many fonts in 'FontSet' - count of fonts NameIndex.length = "+p.length);var d=p[0];if(r.tables.cff.topDict=d,d._privateDict&&(r.defaultWidthX=d._privateDict.defaultWidthX,r.nominalWidthX=d._privateDict.nominalWidthX),void 0!==d.ros[0]&&void 0!==d.ros[1]&&(r.isCIDFont=!0),r.isCIDFont){var f=d.fdArray,m=d.fdSelect;if(0===f||0===m)throw Error("Font is marked as a CID font, but FDArray and/or FDSelect information is missing");var g=parseCFFIndex(e,f+=t),v=gatherCFFTopDicts(e,t,g.objects,u.objects);d._fdArray=v,m+=t,d._fdSelect=parseCFFFDSelect(e,m,r.numGlyphs,v.length)}var y=t+d.private[1],x=(a=d.private[0],n=u.objects,interpretDict(parseCFFDict(e,y,a),L,n));if(r.defaultWidthX=x.defaultWidthX,r.nominalWidthX=x.nominalWidthX,0!==x.subrs){var b=parseCFFIndex(e,y+x.subrs);r.subrs=b.objects,r.subrsBias=calcCFFSubroutineBias(r.subrs)}else r.subrs=[],r.subrsBias=0;i.lowMemory?(s=parseCFFIndexLowMemory(e,t+d.charStrings),r.nGlyphs=s.offsets.length):(s=parseCFFIndex(e,t+d.charStrings),r.nGlyphs=s.objects.length);var T=parseCFFCharset(e,t+d.charset,r.nGlyphs,u.objects);if(0===d.encoding?r.cffEncoding=new CffEncoding(w,T):1===d.encoding?r.cffEncoding=new CffEncoding(I,T):r.cffEncoding=parseCFFEncoding(e,t+d.encoding,T),r.encoding=r.encoding||r.cffEncoding,r.glyphs=new O.GlyphSet(r),i.lowMemory)r._push=function(i){var a=getCffIndexObject(i,s.offsets,e,t+d.charStrings);r.glyphs.push(i,O.cffGlyphLoader(r,i,parseCFFCharstring,a))};else for(var S=0;S<r.nGlyphs;S+=1){var E=s.objects[S];r.glyphs.push(S,O.cffGlyphLoader(r,S,parseCFFCharstring,E))}},make:function(e,t){for(var r,i=new E.Table("CFF ",[{name:"header",type:"RECORD"},{name:"nameIndex",type:"RECORD"},{name:"topDictIndex",type:"RECORD"},{name:"stringIndex",type:"RECORD"},{name:"globalSubrIndex",type:"RECORD"},{name:"charsets",type:"RECORD"},{name:"charStringsIndex",type:"RECORD"},{name:"privateDict",type:"RECORD"}]),a=1/t.unitsPerEm,n={version:t.version,fullName:t.fullName,familyName:t.familyName,weight:t.weightName,fontBBox:t.fontBBox||[0,0,0,0],fontMatrix:[a,0,0,a,0,0],charset:999,encoding:0,charStrings:999,private:[0,999]},s=[],o=1;o<e.length;o+=1)r=e.get(o),s.push(r.name);var l=[];i.header=makeHeader(),i.nameIndex=makeNameIndex([t.postScriptName]);var c=makeTopDict(n,l);i.topDictIndex=makeTopDictIndex(c),i.globalSubrIndex=makeGlobalSubrIndex(),i.charsets=makeCharsets(s,l),i.charStringsIndex=makeCharStringsIndex(e),i.privateDict=makePrivateDict({},l),i.stringIndex=makeStringIndex(l);var u=i.header.sizeOf()+i.nameIndex.sizeOf()+i.topDictIndex.sizeOf()+i.stringIndex.sizeOf()+i.globalSubrIndex.sizeOf();return n.charset=u,n.encoding=0,n.charStrings=n.charset+i.charsets.sizeOf(),n.private[1]=n.charStrings+i.charStringsIndex.sizeOf(),c=makeTopDict(n,l),i.topDictIndex=makeTopDictIndex(c),i}},D={parse:function(e,t){var r={},i=new C.Parser(e,t);return r.version=i.parseVersion(),r.fontRevision=Math.round(1e3*i.parseFixed())/1e3,r.checkSumAdjustment=i.parseULong(),r.magicNumber=i.parseULong(),g.argument(1594834165===r.magicNumber,"Font header has wrong magic number."),r.flags=i.parseUShort(),r.unitsPerEm=i.parseUShort(),r.created=i.parseLongDateTime(),r.modified=i.parseLongDateTime(),r.xMin=i.parseShort(),r.yMin=i.parseShort(),r.xMax=i.parseShort(),r.yMax=i.parseShort(),r.macStyle=i.parseUShort(),r.lowestRecPPEM=i.parseUShort(),r.fontDirectionHint=i.parseShort(),r.indexToLocFormat=i.parseShort(),r.glyphDataFormat=i.parseShort(),r},make:function(e){var t=Math.round(new Date().getTime()/1e3)+2082844800,r=t;return e.createdTimestamp&&(r=e.createdTimestamp+2082844800),new E.Table("head",[{name:"version",type:"FIXED",value:65536},{name:"fontRevision",type:"FIXED",value:65536},{name:"checkSumAdjustment",type:"ULONG",value:0},{name:"magicNumber",type:"ULONG",value:1594834165},{name:"flags",type:"USHORT",value:0},{name:"unitsPerEm",type:"USHORT",value:1e3},{name:"created",type:"LONGDATETIME",value:r},{name:"modified",type:"LONGDATETIME",value:t},{name:"xMin",type:"SHORT",value:0},{name:"yMin",type:"SHORT",value:0},{name:"xMax",type:"SHORT",value:0},{name:"yMax",type:"SHORT",value:0},{name:"macStyle",type:"USHORT",value:0},{name:"lowestRecPPEM",type:"USHORT",value:0},{name:"fontDirectionHint",type:"SHORT",value:2},{name:"indexToLocFormat",type:"SHORT",value:0},{name:"glyphDataFormat",type:"SHORT",value:0}],e)}},U={parse:function(e,t){var r={},i=new C.Parser(e,t);return r.version=i.parseVersion(),r.ascender=i.parseShort(),r.descender=i.parseShort(),r.lineGap=i.parseShort(),r.advanceWidthMax=i.parseUShort(),r.minLeftSideBearing=i.parseShort(),r.minRightSideBearing=i.parseShort(),r.xMaxExtent=i.parseShort(),r.caretSlopeRise=i.parseShort(),r.caretSlopeRun=i.parseShort(),r.caretOffset=i.parseShort(),i.relativeOffset+=8,r.metricDataFormat=i.parseShort(),r.numberOfHMetrics=i.parseUShort(),r},make:function(e){return new E.Table("hhea",[{name:"version",type:"FIXED",value:65536},{name:"ascender",type:"FWORD",value:0},{name:"descender",type:"FWORD",value:0},{name:"lineGap",type:"FWORD",value:0},{name:"advanceWidthMax",type:"UFWORD",value:0},{name:"minLeftSideBearing",type:"FWORD",value:0},{name:"minRightSideBearing",type:"FWORD",value:0},{name:"xMaxExtent",type:"FWORD",value:0},{name:"caretSlopeRise",type:"SHORT",value:1},{name:"caretSlopeRun",type:"SHORT",value:0},{name:"caretOffset",type:"SHORT",value:0},{name:"reserved1",type:"SHORT",value:0},{name:"reserved2",type:"SHORT",value:0},{name:"reserved3",type:"SHORT",value:0},{name:"reserved4",type:"SHORT",value:0},{name:"metricDataFormat",type:"SHORT",value:0},{name:"numberOfHMetrics",type:"USHORT",value:0}],e)}};function parseHmtxTableAll(e,t,r,i,a){for(var n,s,o=new C.Parser(e,t),l=0;l<i;l+=1){l<r&&(n=o.parseUShort(),s=o.parseShort());var c=a.get(l);c.advanceWidth=n,c.leftSideBearing=s}}function parseHmtxTableOnLowMemory(e,t,r,i,a){e._hmtxTableData={};for(var n,s,o=new C.Parser(t,r),l=0;l<a;l+=1)l<i&&(n=o.parseUShort(),s=o.parseShort()),e._hmtxTableData[l]={advanceWidth:n,leftSideBearing:s}}var B={parse:function(e,t,r,i,a,n,s){s.lowMemory?parseHmtxTableOnLowMemory(e,t,r,i,a):parseHmtxTableAll(t,r,i,a,n)},make:function(e){for(var t=new E.Table("hmtx",[]),r=0;r<e.length;r+=1){var i=e.get(r),a=i.advanceWidth||0,n=i.leftSideBearing||0;t.fields.push({name:"advanceWidth_"+r,type:"USHORT",value:a}),t.fields.push({name:"leftSideBearing_"+r,type:"SHORT",value:n})}return t}},V={make:function(e){for(var t=new E.Table("ltag",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"numTags",type:"ULONG",value:e.length}]),r="",i=12+4*e.length,a=0;a<e.length;++a){var n=r.indexOf(e[a]);n<0&&(n=r.length,r+=e[a]),t.fields.push({name:"offset "+a,type:"USHORT",value:i+n}),t.fields.push({name:"length "+a,type:"USHORT",value:e[a].length})}return t.fields.push({name:"stringPool",type:"CHARARRAY",value:r}),t},parse:function(e,t){var r=new C.Parser(e,t),i=r.parseULong();g.argument(1===i,"Unsupported ltag table version."),r.skip("uLong",1);for(var a=r.parseULong(),n=[],s=0;s<a;s++){for(var o="",l=t+r.parseUShort(),c=r.parseUShort(),u=l;u<l+c;++u)o+=String.fromCharCode(e.getInt8(u));n.push(o)}return n}},G={parse:function(e,t){var r={},i=new C.Parser(e,t);return r.version=i.parseVersion(),r.numGlyphs=i.parseUShort(),1===r.version&&(r.maxPoints=i.parseUShort(),r.maxContours=i.parseUShort(),r.maxCompositePoints=i.parseUShort(),r.maxCompositeContours=i.parseUShort(),r.maxZones=i.parseUShort(),r.maxTwilightPoints=i.parseUShort(),r.maxStorage=i.parseUShort(),r.maxFunctionDefs=i.parseUShort(),r.maxInstructionDefs=i.parseUShort(),r.maxStackElements=i.parseUShort(),r.maxSizeOfInstructions=i.parseUShort(),r.maxComponentElements=i.parseUShort(),r.maxComponentDepth=i.parseUShort()),r},make:function(e){return new E.Table("maxp",[{name:"version",type:"FIXED",value:20480},{name:"numGlyphs",type:"USHORT",value:e}])}},z=["copyright","fontFamily","fontSubfamily","uniqueID","fullName","version","postScriptName","trademark","manufacturer","designer","description","manufacturerURL","designerURL","license","licenseURL","reserved","preferredFamily","preferredSubfamily","compatibleFullName","sampleText","postScriptFindFontName","wwsFamily","wwsSubfamily"],H={0:"en",1:"fr",2:"de",3:"it",4:"nl",5:"sv",6:"es",7:"da",8:"pt",9:"no",10:"he",11:"ja",12:"ar",13:"fi",14:"el",15:"is",16:"mt",17:"tr",18:"hr",19:"zh-Hant",20:"ur",21:"hi",22:"th",23:"ko",24:"lt",25:"pl",26:"hu",27:"es",28:"lv",29:"se",30:"fo",31:"fa",32:"ru",33:"zh",34:"nl-BE",35:"ga",36:"sq",37:"ro",38:"cz",39:"sk",40:"si",41:"yi",42:"sr",43:"mk",44:"bg",45:"uk",46:"be",47:"uz",48:"kk",49:"az-Cyrl",50:"az-Arab",51:"hy",52:"ka",53:"mo",54:"ky",55:"tg",56:"tk",57:"mn-CN",58:"mn",59:"ps",60:"ks",61:"ku",62:"sd",63:"bo",64:"ne",65:"sa",66:"mr",67:"bn",68:"as",69:"gu",70:"pa",71:"or",72:"ml",73:"kn",74:"ta",75:"te",76:"si",77:"my",78:"km",79:"lo",80:"vi",81:"id",82:"tl",83:"ms",84:"ms-Arab",85:"am",86:"ti",87:"om",88:"so",89:"sw",90:"rw",91:"rn",92:"ny",93:"mg",94:"eo",128:"cy",129:"eu",130:"ca",131:"la",132:"qu",133:"gn",134:"ay",135:"tt",136:"ug",137:"dz",138:"jv",139:"su",140:"gl",141:"af",142:"br",143:"iu",144:"gd",145:"gv",146:"ga",147:"to",148:"el-polyton",149:"kl",150:"az",151:"nn"},j={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:5,11:1,12:4,13:0,14:6,15:0,16:0,17:0,18:0,19:2,20:4,21:9,22:21,23:3,24:29,25:29,26:29,27:29,28:29,29:0,30:0,31:4,32:7,33:25,34:0,35:0,36:0,37:0,38:29,39:29,40:0,41:5,42:7,43:7,44:7,45:7,46:7,47:7,48:7,49:7,50:4,51:24,52:23,53:7,54:7,55:7,56:7,57:27,58:7,59:4,60:4,61:4,62:4,63:26,64:9,65:9,66:9,67:13,68:13,69:11,70:10,71:12,72:17,73:16,74:14,75:15,76:18,77:19,78:20,79:22,80:30,81:0,82:0,83:0,84:4,85:28,86:28,87:28,88:0,89:0,90:0,91:0,92:0,93:0,94:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:7,136:4,137:26,138:0,139:0,140:0,141:0,142:0,143:28,144:0,145:0,146:0,147:0,148:6,149:0,150:0,151:0},W={1078:"af",1052:"sq",1156:"gsw",1118:"am",5121:"ar-DZ",15361:"ar-BH",3073:"ar",2049:"ar-IQ",11265:"ar-JO",13313:"ar-KW",12289:"ar-LB",4097:"ar-LY",6145:"ary",8193:"ar-OM",16385:"ar-QA",1025:"ar-SA",10241:"ar-SY",7169:"aeb",14337:"ar-AE",9217:"ar-YE",1067:"hy",1101:"as",2092:"az-Cyrl",1068:"az",1133:"ba",1069:"eu",1059:"be",2117:"bn",1093:"bn-IN",8218:"bs-Cyrl",5146:"bs",1150:"br",1026:"bg",1027:"ca",3076:"zh-HK",5124:"zh-MO",2052:"zh",4100:"zh-SG",1028:"zh-TW",1155:"co",1050:"hr",4122:"hr-BA",1029:"cs",1030:"da",1164:"prs",1125:"dv",2067:"nl-BE",1043:"nl",3081:"en-AU",10249:"en-BZ",4105:"en-CA",9225:"en-029",16393:"en-IN",6153:"en-IE",8201:"en-JM",17417:"en-MY",5129:"en-NZ",13321:"en-PH",18441:"en-SG",7177:"en-ZA",11273:"en-TT",2057:"en-GB",1033:"en",12297:"en-ZW",1061:"et",1080:"fo",1124:"fil",1035:"fi",2060:"fr-BE",3084:"fr-CA",1036:"fr",5132:"fr-LU",6156:"fr-MC",4108:"fr-CH",1122:"fy",1110:"gl",1079:"ka",3079:"de-AT",1031:"de",5127:"de-LI",4103:"de-LU",2055:"de-CH",1032:"el",1135:"kl",1095:"gu",1128:"ha",1037:"he",1081:"hi",1038:"hu",1039:"is",1136:"ig",1057:"id",1117:"iu",2141:"iu-Latn",2108:"ga",1076:"xh",1077:"zu",1040:"it",2064:"it-CH",1041:"ja",1099:"kn",1087:"kk",1107:"km",1158:"quc",1159:"rw",1089:"sw",1111:"kok",1042:"ko",1088:"ky",1108:"lo",1062:"lv",1063:"lt",2094:"dsb",1134:"lb",1071:"mk",2110:"ms-BN",1086:"ms",1100:"ml",1082:"mt",1153:"mi",1146:"arn",1102:"mr",1148:"moh",1104:"mn",2128:"mn-CN",1121:"ne",1044:"nb",2068:"nn",1154:"oc",1096:"or",1123:"ps",1045:"pl",1046:"pt",2070:"pt-PT",1094:"pa",1131:"qu-BO",2155:"qu-EC",3179:"qu",1048:"ro",1047:"rm",1049:"ru",9275:"smn",4155:"smj-NO",5179:"smj",3131:"se-FI",1083:"se",2107:"se-SE",8251:"sms",6203:"sma-NO",7227:"sms",1103:"sa",7194:"sr-Cyrl-BA",3098:"sr",6170:"sr-Latn-BA",2074:"sr-Latn",1132:"nso",1074:"tn",1115:"si",1051:"sk",1060:"sl",11274:"es-AR",16394:"es-BO",13322:"es-CL",9226:"es-CO",5130:"es-CR",7178:"es-DO",12298:"es-EC",17418:"es-SV",4106:"es-GT",18442:"es-HN",2058:"es-MX",19466:"es-NI",6154:"es-PA",15370:"es-PY",10250:"es-PE",20490:"es-PR",3082:"es",1034:"es",21514:"es-US",14346:"es-UY",8202:"es-VE",2077:"sv-FI",1053:"sv",1114:"syr",1064:"tg",2143:"tzm",1097:"ta",1092:"tt",1098:"te",1054:"th",1105:"bo",1055:"tr",1090:"tk",1152:"ug",1058:"uk",1070:"hsb",1056:"ur",2115:"uz-Cyrl",1091:"uz",1066:"vi",1106:"cy",1160:"wo",1157:"sah",1144:"ii",1130:"yo"};function getLanguageCode(e,t,r){switch(e){case 0:if(65535===t)return"und";if(r)return r[t];break;case 1:return H[t];case 3:return W[t]}}var K="utf-16",X={0:"macintosh",1:"x-mac-japanese",2:"x-mac-chinesetrad",3:"x-mac-korean",6:"x-mac-greek",7:"x-mac-cyrillic",9:"x-mac-devanagai",10:"x-mac-gurmukhi",11:"x-mac-gujarati",12:"x-mac-oriya",13:"x-mac-bengali",14:"x-mac-tamil",15:"x-mac-telugu",16:"x-mac-kannada",17:"x-mac-malayalam",18:"x-mac-sinhalese",19:"x-mac-burmese",20:"x-mac-khmer",21:"x-mac-thai",22:"x-mac-lao",23:"x-mac-georgian",24:"x-mac-armenian",25:"x-mac-chinesesimp",26:"x-mac-tibetan",27:"x-mac-mongolian",28:"x-mac-ethiopic",29:"x-mac-ce",30:"x-mac-vietnamese",31:"x-mac-extarabic"},q={15:"x-mac-icelandic",17:"x-mac-turkish",18:"x-mac-croatian",24:"x-mac-ce",25:"x-mac-ce",26:"x-mac-ce",27:"x-mac-ce",28:"x-mac-ce",30:"x-mac-icelandic",37:"x-mac-romanian",38:"x-mac-ce",39:"x-mac-ce",40:"x-mac-ce",143:"x-mac-inuit",146:"x-mac-gaelic"};function getEncoding(e,t,r){switch(e){case 0:return K;case 1:return q[r]||X[t];case 3:if(1===t||10===t)return K}}function reverseDict(e){var t={};for(var r in e)t[e[r]]=parseInt(r);return t}function makeNameRecord(e,t,r,i,a,n){return new E.Record("NameRecord",[{name:"platformID",type:"USHORT",value:e},{name:"encodingID",type:"USHORT",value:t},{name:"languageID",type:"USHORT",value:r},{name:"nameID",type:"USHORT",value:i},{name:"length",type:"USHORT",value:a},{name:"offset",type:"USHORT",value:n}])}function findSubArray(e,t){var r=e.length,i=t.length-r+1;i:for(var a=0;a<i;a++)for(;a<i;a++){for(var n=0;n<r;n++)if(t[a+n]!==e[n])continue i;return a}return -1}function addStringToPool(e,t){var r=findSubArray(e,t);if(r<0){r=t.length;for(var i=0,a=e.length;i<a;++i)t.push(e[i])}return r}var Y={parse:function(e,t,r){for(var i={},a=new C.Parser(e,t),n=a.parseUShort(),s=a.parseUShort(),o=a.offset+a.parseUShort(),l=0;l<s;l++){var c=a.parseUShort(),u=a.parseUShort(),h=a.parseUShort(),p=a.parseUShort(),d=z[p]||p,f=a.parseUShort(),m=a.parseUShort(),g=getLanguageCode(c,h,r),y=getEncoding(c,u,h);if(void 0!==y&&void 0!==g){var x=void 0;if(x=y===K?v.UTF16(e,o+m,f):v.MACSTRING(e,o+m,f,y)){var b=i[d];void 0===b&&(b=i[d]={}),b[g]=x}}}return 1===n&&a.parseUShort(),i},make:function(e,t){var r,i=[],a={},n=reverseDict(z);for(var s in e){var o=n[s];if(void 0===o&&(o=s),isNaN(r=parseInt(o)))throw Error('Name table entry "'+s+'" does not exist, see nameTableNames for complete list.');a[r]=e[s],i.push(r)}for(var l=reverseDict(H),c=reverseDict(W),u=[],h=[],p=0;p<i.length;p++){var d=a[r=i[p]];for(var f in d){var m=d[f],g=1,v=l[f],x=j[v],b=getEncoding(g,x,v),T=y.MACSTRING(m,b);void 0===T&&(g=0,(v=t.indexOf(f))<0&&(v=t.length,t.push(f)),x=4,T=y.UTF16(m));var S=addStringToPool(T,h);u.push(makeNameRecord(g,x,v,r,T.length,S));var R=c[f];if(void 0!==R){var A=y.UTF16(m),C=addStringToPool(A,h);u.push(makeNameRecord(3,1,R,r,A.length,C))}}}u.sort(function(e,t){return e.platformID-t.platformID||e.encodingID-t.encodingID||e.languageID-t.languageID||e.nameID-t.nameID});for(var M=new E.Table("name",[{name:"format",type:"USHORT",value:0},{name:"count",type:"USHORT",value:u.length},{name:"stringOffset",type:"USHORT",value:6+12*u.length}]),P=0;P<u.length;P++)M.fields.push({name:"record_"+P,type:"RECORD",value:u[P]});return M.fields.push({name:"strings",type:"LITERAL",value:h}),M}},Z=[{begin:0,end:127},{begin:128,end:255},{begin:256,end:383},{begin:384,end:591},{begin:592,end:687},{begin:688,end:767},{begin:768,end:879},{begin:880,end:1023},{begin:11392,end:11519},{begin:1024,end:1279},{begin:1328,end:1423},{begin:1424,end:1535},{begin:42240,end:42559},{begin:1536,end:1791},{begin:1984,end:2047},{begin:2304,end:2431},{begin:2432,end:2559},{begin:2560,end:2687},{begin:2688,end:2815},{begin:2816,end:2943},{begin:2944,end:3071},{begin:3072,end:3199},{begin:3200,end:3327},{begin:3328,end:3455},{begin:3584,end:3711},{begin:3712,end:3839},{begin:4256,end:4351},{begin:6912,end:7039},{begin:4352,end:4607},{begin:7680,end:7935},{begin:7936,end:8191},{begin:8192,end:8303},{begin:8304,end:8351},{begin:8352,end:8399},{begin:8400,end:8447},{begin:8448,end:8527},{begin:8528,end:8591},{begin:8592,end:8703},{begin:8704,end:8959},{begin:8960,end:9215},{begin:9216,end:9279},{begin:9280,end:9311},{begin:9312,end:9471},{begin:9472,end:9599},{begin:9600,end:9631},{begin:9632,end:9727},{begin:9728,end:9983},{begin:9984,end:10175},{begin:12288,end:12351},{begin:12352,end:12447},{begin:12448,end:12543},{begin:12544,end:12591},{begin:12592,end:12687},{begin:43072,end:43135},{begin:12800,end:13055},{begin:13056,end:13311},{begin:44032,end:55215},{begin:55296,end:57343},{begin:67840,end:67871},{begin:19968,end:40959},{begin:57344,end:63743},{begin:12736,end:12783},{begin:64256,end:64335},{begin:64336,end:65023},{begin:65056,end:65071},{begin:65040,end:65055},{begin:65104,end:65135},{begin:65136,end:65279},{begin:65280,end:65519},{begin:65520,end:65535},{begin:3840,end:4095},{begin:1792,end:1871},{begin:1920,end:1983},{begin:3456,end:3583},{begin:4096,end:4255},{begin:4608,end:4991},{begin:5024,end:5119},{begin:5120,end:5759},{begin:5760,end:5791},{begin:5792,end:5887},{begin:6016,end:6143},{begin:6144,end:6319},{begin:10240,end:10495},{begin:40960,end:42127},{begin:5888,end:5919},{begin:66304,end:66351},{begin:66352,end:66383},{begin:66560,end:66639},{begin:118784,end:119039},{begin:119808,end:120831},{begin:1044480,end:1048573},{begin:65024,end:65039},{begin:917504,end:917631},{begin:6400,end:6479},{begin:6480,end:6527},{begin:6528,end:6623},{begin:6656,end:6687},{begin:11264,end:11359},{begin:11568,end:11647},{begin:19904,end:19967},{begin:43008,end:43055},{begin:65536,end:65663},{begin:65856,end:65935},{begin:66432,end:66463},{begin:66464,end:66527},{begin:66640,end:66687},{begin:66688,end:66735},{begin:67584,end:67647},{begin:68096,end:68191},{begin:119552,end:119647},{begin:73728,end:74751},{begin:119648,end:119679},{begin:7040,end:7103},{begin:7168,end:7247},{begin:7248,end:7295},{begin:43136,end:43231},{begin:43264,end:43311},{begin:43312,end:43359},{begin:43520,end:43615},{begin:65936,end:65999},{begin:66e3,end:66047},{begin:66208,end:66271},{begin:127024,end:127135}];function getUnicodeRange(e){for(var t=0;t<Z.length;t+=1){var r=Z[t];if(e>=r.begin&&e<r.end)return t}return -1}var $={parse:function(e,t){var r={},i=new C.Parser(e,t);r.version=i.parseUShort(),r.xAvgCharWidth=i.parseShort(),r.usWeightClass=i.parseUShort(),r.usWidthClass=i.parseUShort(),r.fsType=i.parseUShort(),r.ySubscriptXSize=i.parseShort(),r.ySubscriptYSize=i.parseShort(),r.ySubscriptXOffset=i.parseShort(),r.ySubscriptYOffset=i.parseShort(),r.ySuperscriptXSize=i.parseShort(),r.ySuperscriptYSize=i.parseShort(),r.ySuperscriptXOffset=i.parseShort(),r.ySuperscriptYOffset=i.parseShort(),r.yStrikeoutSize=i.parseShort(),r.yStrikeoutPosition=i.parseShort(),r.sFamilyClass=i.parseShort(),r.panose=[];for(var a=0;a<10;a++)r.panose[a]=i.parseByte();return r.ulUnicodeRange1=i.parseULong(),r.ulUnicodeRange2=i.parseULong(),r.ulUnicodeRange3=i.parseULong(),r.ulUnicodeRange4=i.parseULong(),r.achVendID=String.fromCharCode(i.parseByte(),i.parseByte(),i.parseByte(),i.parseByte()),r.fsSelection=i.parseUShort(),r.usFirstCharIndex=i.parseUShort(),r.usLastCharIndex=i.parseUShort(),r.sTypoAscender=i.parseShort(),r.sTypoDescender=i.parseShort(),r.sTypoLineGap=i.parseShort(),r.usWinAscent=i.parseUShort(),r.usWinDescent=i.parseUShort(),r.version>=1&&(r.ulCodePageRange1=i.parseULong(),r.ulCodePageRange2=i.parseULong()),r.version>=2&&(r.sxHeight=i.parseShort(),r.sCapHeight=i.parseShort(),r.usDefaultChar=i.parseUShort(),r.usBreakChar=i.parseUShort(),r.usMaxContent=i.parseUShort()),r},make:function(e){return new E.Table("OS/2",[{name:"version",type:"USHORT",value:3},{name:"xAvgCharWidth",type:"SHORT",value:0},{name:"usWeightClass",type:"USHORT",value:0},{name:"usWidthClass",type:"USHORT",value:0},{name:"fsType",type:"USHORT",value:0},{name:"ySubscriptXSize",type:"SHORT",value:650},{name:"ySubscriptYSize",type:"SHORT",value:699},{name:"ySubscriptXOffset",type:"SHORT",value:0},{name:"ySubscriptYOffset",type:"SHORT",value:140},{name:"ySuperscriptXSize",type:"SHORT",value:650},{name:"ySuperscriptYSize",type:"SHORT",value:699},{name:"ySuperscriptXOffset",type:"SHORT",value:0},{name:"ySuperscriptYOffset",type:"SHORT",value:479},{name:"yStrikeoutSize",type:"SHORT",value:49},{name:"yStrikeoutPosition",type:"SHORT",value:258},{name:"sFamilyClass",type:"SHORT",value:0},{name:"bFamilyType",type:"BYTE",value:0},{name:"bSerifStyle",type:"BYTE",value:0},{name:"bWeight",type:"BYTE",value:0},{name:"bProportion",type:"BYTE",value:0},{name:"bContrast",type:"BYTE",value:0},{name:"bStrokeVariation",type:"BYTE",value:0},{name:"bArmStyle",type:"BYTE",value:0},{name:"bLetterform",type:"BYTE",value:0},{name:"bMidline",type:"BYTE",value:0},{name:"bXHeight",type:"BYTE",value:0},{name:"ulUnicodeRange1",type:"ULONG",value:0},{name:"ulUnicodeRange2",type:"ULONG",value:0},{name:"ulUnicodeRange3",type:"ULONG",value:0},{name:"ulUnicodeRange4",type:"ULONG",value:0},{name:"achVendID",type:"CHARARRAY",value:"XXXX"},{name:"fsSelection",type:"USHORT",value:0},{name:"usFirstCharIndex",type:"USHORT",value:0},{name:"usLastCharIndex",type:"USHORT",value:0},{name:"sTypoAscender",type:"SHORT",value:0},{name:"sTypoDescender",type:"SHORT",value:0},{name:"sTypoLineGap",type:"SHORT",value:0},{name:"usWinAscent",type:"USHORT",value:0},{name:"usWinDescent",type:"USHORT",value:0},{name:"ulCodePageRange1",type:"ULONG",value:0},{name:"ulCodePageRange2",type:"ULONG",value:0},{name:"sxHeight",type:"SHORT",value:0},{name:"sCapHeight",type:"SHORT",value:0},{name:"usDefaultChar",type:"USHORT",value:0},{name:"usBreakChar",type:"USHORT",value:0},{name:"usMaxContext",type:"USHORT",value:0}],e)},unicodeRanges:Z,getUnicodeRange},Q={parse:function(e,t){var r={},i=new C.Parser(e,t);switch(r.version=i.parseVersion(),r.italicAngle=i.parseFixed(),r.underlinePosition=i.parseShort(),r.underlineThickness=i.parseShort(),r.isFixedPitch=i.parseULong(),r.minMemType42=i.parseULong(),r.maxMemType42=i.parseULong(),r.minMemType1=i.parseULong(),r.maxMemType1=i.parseULong(),r.version){case 1:r.names=k.slice();break;case 2:r.numberOfGlyphs=i.parseUShort(),r.glyphNameIndex=Array(r.numberOfGlyphs);for(var a=0;a<r.numberOfGlyphs;a++)r.glyphNameIndex[a]=i.parseUShort();r.names=[];for(var n=0;n<r.numberOfGlyphs;n++)if(r.glyphNameIndex[n]>=k.length){var s=i.parseChar();r.names.push(i.parseString(s))}break;case 2.5:r.numberOfGlyphs=i.parseUShort(),r.offset=Array(r.numberOfGlyphs);for(var o=0;o<r.numberOfGlyphs;o++)r.offset[o]=i.parseChar()}return r},make:function(){return new E.Table("post",[{name:"version",type:"FIXED",value:196608},{name:"italicAngle",type:"FIXED",value:0},{name:"underlinePosition",type:"FWORD",value:0},{name:"underlineThickness",type:"FWORD",value:0},{name:"isFixedPitch",type:"ULONG",value:0},{name:"minMemType42",type:"ULONG",value:0},{name:"maxMemType42",type:"ULONG",value:0},{name:"minMemType1",type:"ULONG",value:0},{name:"maxMemType1",type:"ULONG",value:0}])}},J=Array(9);J[1]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();return 1===t?{substFormat:1,coverage:this.parsePointer(Parser2.coverage),deltaGlyphId:this.parseUShort()}:2===t?{substFormat:2,coverage:this.parsePointer(Parser2.coverage),substitute:this.parseOffset16List()}:void g.assert(!1,"0x"+e.toString(16)+": lookup type 1 format must be 1 or 2.")},J[2]=function(){var e=this.parseUShort();return g.argument(1===e,"GSUB Multiple Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(Parser2.coverage),sequences:this.parseListOfLists()}},J[3]=function(){var e=this.parseUShort();return g.argument(1===e,"GSUB Alternate Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(Parser2.coverage),alternateSets:this.parseListOfLists()}},J[4]=function(){var e=this.parseUShort();return g.argument(1===e,"GSUB ligature table identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(Parser2.coverage),ligatureSets:this.parseListOfLists(function(){return{ligGlyph:this.parseUShort(),components:this.parseUShortList(this.parseUShort()-1)}})}};var ee={sequenceIndex:Parser2.uShort,lookupListIndex:Parser2.uShort};function parseGsubTable(e,t){var r=new Parser2(e,t=t||0),i=r.parseVersion(1);return(g.argument(1===i||1.1===i,"Unsupported GSUB table version."),1===i)?{version:i,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(J)}:{version:i,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(J),variations:r.parseFeatureVariationsList()}}J[5]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();if(1===t)return{substFormat:t,coverage:this.parsePointer(Parser2.coverage),ruleSets:this.parseListOfLists(function(){var e=this.parseUShort(),t=this.parseUShort();return{input:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,ee)}})};if(2===t)return{substFormat:t,coverage:this.parsePointer(Parser2.coverage),classDef:this.parsePointer(Parser2.classDef),classSets:this.parseListOfLists(function(){var e=this.parseUShort(),t=this.parseUShort();return{classes:this.parseUShortList(e-1),lookupRecords:this.parseRecordList(t,ee)}})};if(3===t){var r=this.parseUShort(),i=this.parseUShort();return{substFormat:t,coverages:this.parseList(r,Parser2.pointer(Parser2.coverage)),lookupRecords:this.parseRecordList(i,ee)}}g.assert(!1,"0x"+e.toString(16)+": lookup type 5 format must be 1, 2 or 3.")},J[6]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();return 1===t?{substFormat:1,coverage:this.parsePointer(Parser2.coverage),chainRuleSets:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(ee)}})}:2===t?{substFormat:2,coverage:this.parsePointer(Parser2.coverage),backtrackClassDef:this.parsePointer(Parser2.classDef),inputClassDef:this.parsePointer(Parser2.classDef),lookaheadClassDef:this.parsePointer(Parser2.classDef),chainClassSet:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(ee)}})}:3===t?{substFormat:3,backtrackCoverage:this.parseList(Parser2.pointer(Parser2.coverage)),inputCoverage:this.parseList(Parser2.pointer(Parser2.coverage)),lookaheadCoverage:this.parseList(Parser2.pointer(Parser2.coverage)),lookupRecords:this.parseRecordList(ee)}:void g.assert(!1,"0x"+e.toString(16)+": lookup type 6 format must be 1, 2 or 3.")},J[7]=function(){var e=this.parseUShort();g.argument(1===e,"GSUB Extension Substitution subtable identifier-format must be 1");var t=this.parseUShort(),r=new Parser2(this.data,this.offset+this.parseULong());return{substFormat:1,lookupType:t,extension:J[t].call(r)}},J[8]=function(){var e=this.parseUShort();return g.argument(1===e,"GSUB Reverse Chaining Contextual Single Substitution Subtable identifier-format must be 1"),{substFormat:e,coverage:this.parsePointer(Parser2.coverage),backtrackCoverage:this.parseList(Parser2.pointer(Parser2.coverage)),lookaheadCoverage:this.parseList(Parser2.pointer(Parser2.coverage)),substitutes:this.parseUShortList()}};var et=Array(9);et[1]=function(e){return 1===e.substFormat?new E.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new E.Coverage(e.coverage)},{name:"deltaGlyphID",type:"USHORT",value:e.deltaGlyphId}]):new E.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:2},{name:"coverage",type:"TABLE",value:new E.Coverage(e.coverage)}].concat(E.ushortList("substitute",e.substitute)))},et[2]=function(e){return g.assert(1===e.substFormat,"Lookup type 2 substFormat must be 1."),new E.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new E.Coverage(e.coverage)}].concat(E.tableList("seqSet",e.sequences,function(e){return new E.Table("sequenceSetTable",E.ushortList("sequence",e))})))},et[3]=function(e){return g.assert(1===e.substFormat,"Lookup type 3 substFormat must be 1."),new E.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new E.Coverage(e.coverage)}].concat(E.tableList("altSet",e.alternateSets,function(e){return new E.Table("alternateSetTable",E.ushortList("alternate",e))})))},et[4]=function(e){return g.assert(1===e.substFormat,"Lookup type 4 substFormat must be 1."),new E.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new E.Coverage(e.coverage)}].concat(E.tableList("ligSet",e.ligatureSets,function(e){return new E.Table("ligatureSetTable",E.tableList("ligature",e,function(e){return new E.Table("ligatureTable",[{name:"ligGlyph",type:"USHORT",value:e.ligGlyph}].concat(E.ushortList("component",e.components,e.components.length+1)))}))})))},et[6]=function(e){if(1===e.substFormat)return new E.Table("chainContextTable",[{name:"substFormat",type:"USHORT",value:e.substFormat},{name:"coverage",type:"TABLE",value:new E.Coverage(e.coverage)}].concat(E.tableList("chainRuleSet",e.chainRuleSets,function(e){return new E.Table("chainRuleSetTable",E.tableList("chainRule",e,function(e){var t=E.ushortList("backtrackGlyph",e.backtrack,e.backtrack.length).concat(E.ushortList("inputGlyph",e.input,e.input.length+1)).concat(E.ushortList("lookaheadGlyph",e.lookahead,e.lookahead.length)).concat(E.ushortList("substitution",[],e.lookupRecords.length));return e.lookupRecords.forEach(function(e,r){t=t.concat({name:"sequenceIndex"+r,type:"USHORT",value:e.sequenceIndex}).concat({name:"lookupListIndex"+r,type:"USHORT",value:e.lookupListIndex})}),new E.Table("chainRuleTable",t)}))})));if(2===e.substFormat)g.assert(!1,"lookup type 6 format 2 is not yet supported.");else if(3===e.substFormat){var t=[{name:"substFormat",type:"USHORT",value:e.substFormat}];return t.push({name:"backtrackGlyphCount",type:"USHORT",value:e.backtrackCoverage.length}),e.backtrackCoverage.forEach(function(e,r){t.push({name:"backtrackCoverage"+r,type:"TABLE",value:new E.Coverage(e)})}),t.push({name:"inputGlyphCount",type:"USHORT",value:e.inputCoverage.length}),e.inputCoverage.forEach(function(e,r){t.push({name:"inputCoverage"+r,type:"TABLE",value:new E.Coverage(e)})}),t.push({name:"lookaheadGlyphCount",type:"USHORT",value:e.lookaheadCoverage.length}),e.lookaheadCoverage.forEach(function(e,r){t.push({name:"lookaheadCoverage"+r,type:"TABLE",value:new E.Coverage(e)})}),t.push({name:"substitutionCount",type:"USHORT",value:e.lookupRecords.length}),e.lookupRecords.forEach(function(e,r){t=t.concat({name:"sequenceIndex"+r,type:"USHORT",value:e.sequenceIndex}).concat({name:"lookupListIndex"+r,type:"USHORT",value:e.lookupListIndex})}),new E.Table("chainContextTable",t)}g.assert(!1,"lookup type 6 format must be 1, 2 or 3.")};var er={parse:parseGsubTable,make:function(e){return new E.Table("GSUB",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new E.ScriptList(e.scripts)},{name:"features",type:"TABLE",value:new E.FeatureList(e.features)},{name:"lookups",type:"TABLE",value:new E.LookupList(e.lookups,et)}])}},ei={parse:function(e,t){var r=new C.Parser(e,t),i=r.parseULong();g.argument(1===i,"Unsupported META table version."),r.parseULong(),r.parseULong();for(var a=r.parseULong(),n={},s=0;s<a;s++){var o=r.parseTag(),l=r.parseULong(),c=r.parseULong(),u=v.UTF8(e,t+l,c);n[o]=u}return n},make:function(e){var t=Object.keys(e).length,r="",i=16+12*t,a=new E.Table("meta",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"offset",type:"ULONG",value:i},{name:"numTags",type:"ULONG",value:t}]);for(var n in e){var s=r.length;r+=e[n],a.fields.push({name:"tag "+n,type:"TAG",value:n}),a.fields.push({name:"offset "+n,type:"ULONG",value:i+s}),a.fields.push({name:"length "+n,type:"ULONG",value:e[n].length})}return a.fields.push({name:"stringPool",type:"CHARARRAY",value:r}),a}};function log2(e){return Math.log(e)/Math.log(2)|0}function computeCheckSum(e){for(;e.length%4!=0;)e.push(0);for(var t=0,r=0;r<e.length;r+=4)t+=(e[r]<<24)+(e[r+1]<<16)+(e[r+2]<<8)+e[r+3];return t%4294967296}function makeTableRecord(e,t,r,i){return new E.Record("Table Record",[{name:"tag",type:"TAG",value:void 0!==e?e:""},{name:"checkSum",type:"ULONG",value:void 0!==t?t:0},{name:"offset",type:"ULONG",value:void 0!==r?r:0},{name:"length",type:"ULONG",value:void 0!==i?i:0}])}function makeSfntTable(e){var t=new E.Table("sfnt",[{name:"version",type:"TAG",value:"OTTO"},{name:"numTables",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);t.tables=e,t.numTables=e.length;var r=Math.pow(2,log2(t.numTables));t.searchRange=16*r,t.entrySelector=log2(r),t.rangeShift=16*t.numTables-t.searchRange;for(var i=[],a=[],n=t.sizeOf()+makeTableRecord().sizeOf()*t.numTables;n%4!=0;)n+=1,a.push({name:"padding",type:"BYTE",value:0});for(var s=0;s<e.length;s+=1){var o=e[s];g.argument(4===o.tableName.length,"Table name"+o.tableName+" is invalid.");var l=o.sizeOf(),c=makeTableRecord(o.tableName,computeCheckSum(o.encode()),n,l);for(i.push({name:c.tag+" Table Record",type:"RECORD",value:c}),a.push({name:o.tableName+" table",type:"RECORD",value:o}),n+=l,g.argument(!isNaN(n),"Something went wrong calculating the offset.");n%4!=0;)n+=1,a.push({name:"padding",type:"BYTE",value:0})}return i.sort(function(e,t){return e.value.tag>t.value.tag?1:-1}),t.fields=t.fields.concat(i),t.fields=t.fields.concat(a),t}function metricsForChar(e,t,r){for(var i=0;i<t.length;i+=1){var a=e.charToGlyphIndex(t[i]);if(a>0)return e.glyphs.get(a).getMetrics()}return r}function average(e){for(var t=0,r=0;r<e.length;r+=1)t+=e[r];return t/e.length}function fontToSfntTable(e){for(var t,r=[],i=[],a=[],n=[],s=[],o=[],l=[],c=0,u=0,h=0,p=0,d=0,f=0;f<e.glyphs.length;f+=1){var m=e.glyphs.get(f),g=0|m.unicode;if(isNaN(m.advanceWidth))throw Error("Glyph "+m.name+" ("+f+"): advanceWidth is not a number.");(t>g||void 0===t)&&g>0&&(t=g),c<g&&(c=g);var v=$.getUnicodeRange(g);if(v<32)u|=1<<v;else if(v<64)h|=1<<v-32;else if(v<96)p|=1<<v-64;else if(v<123)d|=1<<v-96;else throw Error("Unicode ranges bits > 123 are reserved for internal usage");if(".notdef"!==m.name){var y=m.getMetrics();r.push(y.xMin),i.push(y.yMin),a.push(y.xMax),n.push(y.yMax),o.push(y.leftSideBearing),l.push(y.rightSideBearing),s.push(m.advanceWidth)}}var x={xMin:Math.min.apply(null,r),yMin:Math.min.apply(null,i),xMax:Math.max.apply(null,a),yMax:Math.max.apply(null,n),advanceWidthMax:Math.max.apply(null,s),advanceWidthAvg:average(s),minLeftSideBearing:Math.min.apply(null,o),maxLeftSideBearing:Math.max.apply(null,o),minRightSideBearing:Math.min.apply(null,l)};x.ascender=e.ascender,x.descender=e.descender;var b=D.make({flags:3,unitsPerEm:e.unitsPerEm,xMin:x.xMin,yMin:x.yMin,xMax:x.xMax,yMax:x.yMax,lowestRecPPEM:3,createdTimestamp:e.createdTimestamp}),T=U.make({ascender:x.ascender,descender:x.descender,advanceWidthMax:x.advanceWidthMax,minLeftSideBearing:x.minLeftSideBearing,minRightSideBearing:x.minRightSideBearing,xMaxExtent:x.maxLeftSideBearing+(x.xMax-x.xMin),numberOfHMetrics:e.glyphs.length}),S=G.make(e.glyphs.length),E=$.make(Object.assign({xAvgCharWidth:Math.round(x.advanceWidthAvg),usFirstCharIndex:t,usLastCharIndex:c,ulUnicodeRange1:u,ulUnicodeRange2:h,ulUnicodeRange3:p,ulUnicodeRange4:d,sTypoAscender:x.ascender,sTypoDescender:x.descender,sTypoLineGap:0,usWinAscent:x.yMax,usWinDescent:Math.abs(x.yMin),ulCodePageRange1:1,sxHeight:metricsForChar(e,"xyvw",{yMax:Math.round(x.ascender/2)}).yMax,sCapHeight:metricsForChar(e,"HIKLEFJMNTZBDPRAGOQSUVWXY",x).yMax,usDefaultChar:e.hasChar(" ")?32:0,usBreakChar:e.hasChar(" ")?32:0},e.tables.os2)),R=B.make(e.glyphs),A=M.make(e.glyphs),C=e.getEnglishName("fontFamily"),P=e.getEnglishName("fontSubfamily"),w=C+" "+P,I=e.getEnglishName("postScriptName");I||(I=C.replace(/\s/g,"")+"-"+P);var k={};for(var _ in e.names)k[_]=e.names[_];k.uniqueID||(k.uniqueID={en:e.getEnglishName("manufacturer")+":"+w}),k.postScriptName||(k.postScriptName={en:I}),k.preferredFamily||(k.preferredFamily=e.names.fontFamily),k.preferredSubfamily||(k.preferredSubfamily=e.names.fontSubfamily);var O=[],N=Y.make(k,O),L=O.length>0?V.make(O):void 0,z=Q.make(),H=F.make(e.glyphs,{version:e.getEnglishName("version"),fullName:w,familyName:C,weightName:P,postScriptName:I,unitsPerEm:e.unitsPerEm,fontBBox:[0,x.yMin,x.ascender,x.advanceWidthMax]}),j=e.metas&&Object.keys(e.metas).length>0?ei.make(e.metas):void 0,W=[b,T,S,E,N,A,z,H,R];L&&W.push(L),e.tables.gsub&&W.push(er.make(e.tables.gsub)),j&&W.push(j);for(var K=makeSfntTable(W),X=computeCheckSum(K.encode()),q=K.fields,Z=!1,J=0;J<q.length;J+=1)if("head table"===q[J].name){q[J].value.checkSumAdjustment=2981146554-X,Z=!0;break}if(!Z)throw Error("Could not find head table with checkSum to adjust.");return K}var ea={make:makeSfntTable,fontToTable:fontToSfntTable,computeCheckSum};function searchTag(e,t){for(var r=0,i=e.length-1;r<=i;){var a=r+i>>>1,n=e[a].tag;if(n===t)return a;n<t?r=a+1:i=a-1}return-r-1}function binSearch(e,t){for(var r=0,i=e.length-1;r<=i;){var a=r+i>>>1,n=e[a];if(n===t)return a;n<t?r=a+1:i=a-1}return-r-1}function searchRange(e,t){for(var r,i=0,a=e.length-1;i<=a;){var n=i+a>>>1,s=(r=e[n]).start;if(s===t)return r;s<t?i=n+1:a=n-1}if(i>0)return t>(r=e[i-1]).end?0:r}function Layout(e,t){this.font=e,this.tableName=t}function Position(e){Layout.call(this,e,"gpos")}function Substitution(e){Layout.call(this,e,"gsub")}function arraysEqual(e,t){var r=e.length;if(r!==t.length)return!1;for(var i=0;i<r;i++)if(e[i]!==t[i])return!1;return!0}function getSubstFormat(e,t,r){for(var i=e.subtables,a=0;a<i.length;a++){var n=i[a];if(n.substFormat===t)return n}if(r)return i.push(r),r}function checkArgument(e,t){if(!e)throw t}function parseGlyphCoordinate(e,t,r,i,a){var n;return(t&i)>0?(n=e.parseByte(),(t&a)==0&&(n=-n),n=r+n):n=(t&a)>0?r:r+e.parseShort(),n}function parseGlyph(e,t,r){var i=new C.Parser(t,r);if(e.numberOfContours=i.parseShort(),e._xMin=i.parseShort(),e._yMin=i.parseShort(),e._xMax=i.parseShort(),e._yMax=i.parseShort(),e.numberOfContours>0){for(var a=e.endPointIndices=[],n=0;n<e.numberOfContours;n+=1)a.push(i.parseUShort());e.instructionLength=i.parseUShort(),e.instructions=[];for(var s=0;s<e.instructionLength;s+=1)e.instructions.push(i.parseByte());var o=a[a.length-1]+1;h=[];for(var l=0;l<o;l+=1)if(p=i.parseByte(),h.push(p),(8&p)>0)for(var c=i.parseByte(),u=0;u<c;u+=1)h.push(p),l+=1;if(g.argument(h.length===o,"Bad flags."),a.length>0){var h,p,d,f=[];if(o>0){for(var m=0;m<o;m+=1)p=h[m],(d={}).onCurve=!!(1&p),d.lastPointOfContour=a.indexOf(m)>=0,f.push(d);for(var v=0,y=0;y<o;y+=1)p=h[y],(d=f[y]).x=parseGlyphCoordinate(i,p,v,2,16),v=d.x;for(var x=0,b=0;b<o;b+=1)p=h[b],(d=f[b]).y=parseGlyphCoordinate(i,p,x,4,32),x=d.y}e.points=f}else e.points=[]}else if(0===e.numberOfContours)e.points=[];else{e.isComposite=!0,e.points=[],e.components=[];for(var T=!0;T;){h=i.parseUShort();var S={glyphIndex:i.parseUShort(),xScale:1,scale01:0,scale10:0,yScale:1,dx:0,dy:0};(1&h)>0?(2&h)>0?(S.dx=i.parseShort(),S.dy=i.parseShort()):S.matchedPoints=[i.parseUShort(),i.parseUShort()]:(2&h)>0?(S.dx=i.parseChar(),S.dy=i.parseChar()):S.matchedPoints=[i.parseByte(),i.parseByte()],(8&h)>0?S.xScale=S.yScale=i.parseF2Dot14():(64&h)>0?(S.xScale=i.parseF2Dot14(),S.yScale=i.parseF2Dot14()):(128&h)>0&&(S.xScale=i.parseF2Dot14(),S.scale01=i.parseF2Dot14(),S.scale10=i.parseF2Dot14(),S.yScale=i.parseF2Dot14()),e.components.push(S),T=!!(32&h)}if(256&h){e.instructionLength=i.parseUShort(),e.instructions=[];for(var E=0;E<e.instructionLength;E+=1)e.instructions.push(i.parseByte())}}}function transformPoints(e,t){for(var r=[],i=0;i<e.length;i+=1){var a=e[i],n={x:t.xScale*a.x+t.scale01*a.y+t.dx,y:t.scale10*a.x+t.yScale*a.y+t.dy,onCurve:a.onCurve,lastPointOfContour:a.lastPointOfContour};r.push(n)}return r}function getContours(e){for(var t=[],r=[],i=0;i<e.length;i+=1){var a=e[i];r.push(a),a.lastPointOfContour&&(t.push(r),r=[])}return g.argument(0===r.length,"There are still points left in the current contour."),t}function getPath(e){var t=new Path2;if(!e)return t;for(var r=getContours(e),i=0;i<r.length;++i){var a=r[i],n=null,s=a[a.length-1],o=a[0];if(s.onCurve)t.moveTo(s.x,s.y);else if(o.onCurve)t.moveTo(o.x,o.y);else{var l={x:(s.x+o.x)*.5,y:(s.y+o.y)*.5};t.moveTo(l.x,l.y)}for(var c=0;c<a.length;++c)if(n=s,s=o,o=a[(c+1)%a.length],s.onCurve)t.lineTo(s.x,s.y);else{var u=o;n.onCurve||(s.x,n.x,s.y,n.y),o.onCurve||(u={x:(s.x+o.x)*.5,y:(s.y+o.y)*.5}),t.quadraticCurveTo(s.x,s.y,u.x,u.y)}t.closePath()}return t}function buildPath(e,t){if(t.isComposite)for(var r=0;r<t.components.length;r+=1){var i=t.components[r],a=e.get(i.glyphIndex);if(a.getPath(),a.points){var n=void 0;if(void 0===i.matchedPoints)n=transformPoints(a.points,i);else{if(i.matchedPoints[0]>t.points.length-1||i.matchedPoints[1]>a.points.length-1)throw Error("Matched points out of range in "+t.name);var s=t.points[i.matchedPoints[0]],o=a.points[i.matchedPoints[1]],l={xScale:i.xScale,scale01:i.scale01,scale10:i.scale10,yScale:i.yScale,dx:0,dy:0};o=transformPoints([o],l)[0],l.dx=s.x-o.x,l.dy=s.y-o.y,n=transformPoints(a.points,l)}t.points=t.points.concat(n)}}return getPath(t.points)}function parseGlyfTableAll(e,t,r,i){for(var a=new O.GlyphSet(i),n=0;n<r.length-1;n+=1){var s=r[n];s!==r[n+1]?a.push(n,O.ttfGlyphLoader(i,n,parseGlyph,e,t+s,buildPath)):a.push(n,O.glyphLoader(i,n))}return a}function parseGlyfTableOnLowMemory(e,t,r,i){var a=new O.GlyphSet(i);return i._push=function(n){var s=r[n];s!==r[n+1]?a.push(n,O.ttfGlyphLoader(i,n,parseGlyph,e,t+s,buildPath)):a.push(n,O.glyphLoader(i,n))},a}Layout.prototype={searchTag,binSearch,getTable:function(e){var t=this.font.tables[this.tableName];return!t&&e&&(t=this.font.tables[this.tableName]=this.createDefaultTable()),t},getScriptNames:function(){var e=this.getTable();return e?e.scripts.map(function(e){return e.tag}):[]},getDefaultScriptName:function(){var e=this.getTable();if(e){for(var t=!1,r=0;r<e.scripts.length;r++){var i=e.scripts[r].tag;if("DFLT"===i)return i;"latn"===i&&(t=!0)}if(t)return"latn"}},getScriptTable:function(e,t){var r=this.getTable(t);if(r){e=e||"DFLT";var i=r.scripts,a=searchTag(r.scripts,e);if(a>=0)return i[a].script;if(t){var n={tag:e,script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}};return i.splice(-1-a,0,n),n.script}}},getLangSysTable:function(e,t,r){var i=this.getScriptTable(e,r);if(i){if(!t||"dflt"===t||"DFLT"===t)return i.defaultLangSys;var a=searchTag(i.langSysRecords,t);if(a>=0)return i.langSysRecords[a].langSys;if(r){var n={tag:t,langSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]}};return i.langSysRecords.splice(-1-a,0,n),n.langSys}}},getFeatureTable:function(e,t,r,i){var a=this.getLangSysTable(e,t,i);if(a){for(var n,s=a.featureIndexes,o=this.font.tables[this.tableName].features,l=0;l<s.length;l++)if((n=o[s[l]]).tag===r)return n.feature;if(i){var c=o.length;return g.assert(0===c||r>=o[c-1].tag,"Features must be added in alphabetical order."),n={tag:r,feature:{params:0,lookupListIndexes:[]}},o.push(n),s.push(c),n.feature}}},getLookupTables:function(e,t,r,i,a){var n=this.getFeatureTable(e,t,r,a),s=[];if(n){for(var o,l=n.lookupListIndexes,c=this.font.tables[this.tableName].lookups,u=0;u<l.length;u++)(o=c[l[u]]).lookupType===i&&s.push(o);if(0===s.length&&a){o={lookupType:i,lookupFlag:0,subtables:[],markFilteringSet:void 0};var h=c.length;return c.push(o),l.push(h),[o]}}return s},getGlyphClass:function(e,t){switch(e.format){case 1:if(e.startGlyph<=t&&t<e.startGlyph+e.classes.length)return e.classes[t-e.startGlyph];return 0;case 2:var r=searchRange(e.ranges,t);return r?r.classId:0}},getCoverageIndex:function(e,t){switch(e.format){case 1:var r=binSearch(e.glyphs,t);return r>=0?r:-1;case 2:var i=searchRange(e.ranges,t);return i?i.index+t-i.start:-1}},expandCoverage:function(e){if(1===e.format)return e.glyphs;for(var t=[],r=e.ranges,i=0;i<r.length;i++)for(var a=r[i],n=a.start,s=a.end,o=n;o<=s;o++)t.push(o);return t}},Position.prototype=Layout.prototype,Position.prototype.init=function(){var e=this.getDefaultScriptName();this.defaultKerningTables=this.getKerningTables(e)},Position.prototype.getKerningValue=function(e,t,r){for(var i=0;i<e.length;i++)for(var a=e[i].subtables,n=0;n<a.length;n++){var s=a[n],o=this.getCoverageIndex(s.coverage,t);if(!(o<0))switch(s.posFormat){case 1:for(var l=s.pairSets[o],c=0;c<l.length;c++){var u=l[c];if(u.secondGlyph===r)return u.value1&&u.value1.xAdvance||0}break;case 2:var h=this.getGlyphClass(s.classDef1,t),p=this.getGlyphClass(s.classDef2,r),d=s.classRecords[h][p];return d.value1&&d.value1.xAdvance||0}}return 0},Position.prototype.getKerningTables=function(e,t){if(this.font.tables.gpos)return this.getLookupTables(e,t,"kern",2)},Substitution.prototype=Layout.prototype,Substitution.prototype.createDefaultTable=function(){return{version:1,scripts:[{tag:"DFLT",script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}}],features:[],lookups:[]}},Substitution.prototype.getSingle=function(e,t,r){for(var i=[],a=this.getLookupTables(t,r,e,1),n=0;n<a.length;n++)for(var s=a[n].subtables,o=0;o<s.length;o++){var l=s[o],c=this.expandCoverage(l.coverage),u=void 0;if(1===l.substFormat){var h=l.deltaGlyphId;for(u=0;u<c.length;u++){var p=c[u];i.push({sub:p,by:p+h})}}else{var d=l.substitute;for(u=0;u<c.length;u++)i.push({sub:c[u],by:d[u]})}}return i},Substitution.prototype.getMultiple=function(e,t,r){for(var i=[],a=this.getLookupTables(t,r,e,2),n=0;n<a.length;n++)for(var s=a[n].subtables,o=0;o<s.length;o++){var l=s[o],c=this.expandCoverage(l.coverage),u=void 0;for(u=0;u<c.length;u++){var h=c[u],p=l.sequences[u];i.push({sub:h,by:p})}}return i},Substitution.prototype.getAlternates=function(e,t,r){for(var i=[],a=this.getLookupTables(t,r,e,3),n=0;n<a.length;n++)for(var s=a[n].subtables,o=0;o<s.length;o++)for(var l=s[o],c=this.expandCoverage(l.coverage),u=l.alternateSets,h=0;h<c.length;h++)i.push({sub:c[h],by:u[h]});return i},Substitution.prototype.getLigatures=function(e,t,r){for(var i=[],a=this.getLookupTables(t,r,e,4),n=0;n<a.length;n++)for(var s=a[n].subtables,o=0;o<s.length;o++)for(var l=s[o],c=this.expandCoverage(l.coverage),u=l.ligatureSets,h=0;h<c.length;h++)for(var p=c[h],d=u[h],f=0;f<d.length;f++){var m=d[f];i.push({sub:[p].concat(m.components),by:m.ligGlyph})}return i},Substitution.prototype.addSingle=function(e,t,r,i){var a=getSubstFormat(this.getLookupTables(r,i,e,1,!0)[0],2,{substFormat:2,coverage:{format:1,glyphs:[]},substitute:[]});g.assert(1===a.coverage.format,"Single: unable to modify coverage table format "+a.coverage.format);var n=t.sub,s=this.binSearch(a.coverage.glyphs,n);s<0&&(s=-1-s,a.coverage.glyphs.splice(s,0,n),a.substitute.splice(s,0,0)),a.substitute[s]=t.by},Substitution.prototype.addMultiple=function(e,t,r,i){g.assert(t.by instanceof Array&&t.by.length>1,'Multiple: "by" must be an array of two or more ids');var a=getSubstFormat(this.getLookupTables(r,i,e,2,!0)[0],1,{substFormat:1,coverage:{format:1,glyphs:[]},sequences:[]});g.assert(1===a.coverage.format,"Multiple: unable to modify coverage table format "+a.coverage.format);var n=t.sub,s=this.binSearch(a.coverage.glyphs,n);s<0&&(s=-1-s,a.coverage.glyphs.splice(s,0,n),a.sequences.splice(s,0,0)),a.sequences[s]=t.by},Substitution.prototype.addAlternate=function(e,t,r,i){var a=getSubstFormat(this.getLookupTables(r,i,e,3,!0)[0],1,{substFormat:1,coverage:{format:1,glyphs:[]},alternateSets:[]});g.assert(1===a.coverage.format,"Alternate: unable to modify coverage table format "+a.coverage.format);var n=t.sub,s=this.binSearch(a.coverage.glyphs,n);s<0&&(s=-1-s,a.coverage.glyphs.splice(s,0,n),a.alternateSets.splice(s,0,0)),a.alternateSets[s]=t.by},Substitution.prototype.addLigature=function(e,t,r,i){var a=this.getLookupTables(r,i,e,4,!0)[0],n=a.subtables[0];n||(n={substFormat:1,coverage:{format:1,glyphs:[]},ligatureSets:[]},a.subtables[0]=n),g.assert(1===n.coverage.format,"Ligature: unable to modify coverage table format "+n.coverage.format);var s=t.sub[0],o=t.sub.slice(1),l={ligGlyph:t.by,components:o},c=this.binSearch(n.coverage.glyphs,s);if(c>=0){for(var u=n.ligatureSets[c],h=0;h<u.length;h++)if(arraysEqual(u[h].components,o))return;u.push(l)}else c=-1-c,n.coverage.glyphs.splice(c,0,s),n.ligatureSets.splice(c,0,[l])},Substitution.prototype.getFeature=function(e,t,r){if(/ss\d\d/.test(e))return this.getSingle(e,t,r);switch(e){case"aalt":case"salt":return this.getSingle(e,t,r).concat(this.getAlternates(e,t,r));case"dlig":case"liga":case"rlig":return this.getLigatures(e,t,r);case"ccmp":return this.getMultiple(e,t,r).concat(this.getLigatures(e,t,r));case"stch":return this.getMultiple(e,t,r)}},Substitution.prototype.add=function(e,t,r,i){if(/ss\d\d/.test(e))return this.addSingle(e,t,r,i);switch(e){case"aalt":case"salt":if("number"==typeof t.by)return this.addSingle(e,t,r,i);return this.addAlternate(e,t,r,i);case"dlig":case"liga":case"rlig":return this.addLigature(e,t,r,i);case"ccmp":if(t.by instanceof Array)return this.addMultiple(e,t,r,i);return this.addLigature(e,t,r,i)}};var en={getPath,parse:function(e,t,r,i,a){return a.lowMemory?parseGlyfTableOnLowMemory(e,t,r,i):parseGlyfTableAll(e,t,r,i)}};function Hinting(e){this.font=e,this.getCommands=function(e){return en.getPath(e).commands},this._fpgmState=this._prepState=void 0,this._errorState=0}function roundOff(e){return e}function roundToGrid(e){return Math.sign(e)*Math.round(Math.abs(e))}function roundToDoubleGrid(e){return Math.sign(e)*Math.round(Math.abs(2*e))/2}function roundToHalfGrid(e){return Math.sign(e)*(Math.round(Math.abs(e)+.5)-.5)}function roundUpToGrid(e){return Math.sign(e)*Math.ceil(Math.abs(e))}function roundDownToGrid(e){return Math.sign(e)*Math.floor(Math.abs(e))}var roundSuper=function(e){var t=this.srPeriod,r=this.srPhase,i=this.srThreshold,a=1;return(e<0&&(e=-e,a=-1),e+=i-r,(e=Math.trunc(e/t)*t+r)<0)?r*a:e*a},es={x:1,y:0,axis:"x",distance:function(e,t,r,i){return(r?e.xo:e.x)-(i?t.xo:t.x)},interpolate:function(e,t,r,i){var a,n,s,o,l,c,u;if(!i||i===this){if(a=e.xo-t.xo,n=e.xo-r.xo,l=t.x-t.xo,c=r.x-r.xo,0===(u=(s=Math.abs(a))+(o=Math.abs(n)))){e.x=e.xo+(l+c)/2;return}e.x=e.xo+(l*o+c*s)/u;return}if(a=i.distance(e,t,!0,!0),n=i.distance(e,r,!0,!0),l=i.distance(t,t,!1,!0),c=i.distance(r,r,!1,!0),0===(u=(s=Math.abs(a))+(o=Math.abs(n)))){es.setRelative(e,e,(l+c)/2,i,!0);return}es.setRelative(e,e,(l*o+c*s)/u,i,!0)},normalSlope:Number.NEGATIVE_INFINITY,setRelative:function(e,t,r,i,a){if(!i||i===this){e.x=(a?t.xo:t.x)+r;return}var n=a?t.xo:t.x,s=a?t.yo:t.y,o=n+r*i.x,l=s+r*i.y;e.x=o+(e.y-l)/i.normalSlope},slope:0,touch:function(e){e.xTouched=!0},touched:function(e){return e.xTouched},untouch:function(e){e.xTouched=!1}},eo={x:0,y:1,axis:"y",distance:function(e,t,r,i){return(r?e.yo:e.y)-(i?t.yo:t.y)},interpolate:function(e,t,r,i){var a,n,s,o,l,c,u;if(!i||i===this){if(a=e.yo-t.yo,n=e.yo-r.yo,l=t.y-t.yo,c=r.y-r.yo,0===(u=(s=Math.abs(a))+(o=Math.abs(n)))){e.y=e.yo+(l+c)/2;return}e.y=e.yo+(l*o+c*s)/u;return}if(a=i.distance(e,t,!0,!0),n=i.distance(e,r,!0,!0),l=i.distance(t,t,!1,!0),c=i.distance(r,r,!1,!0),0===(u=(s=Math.abs(a))+(o=Math.abs(n)))){eo.setRelative(e,e,(l+c)/2,i,!0);return}eo.setRelative(e,e,(l*o+c*s)/u,i,!0)},normalSlope:0,setRelative:function(e,t,r,i,a){if(!i||i===this){e.y=(a?t.yo:t.y)+r;return}var n=a?t.xo:t.x,s=a?t.yo:t.y,o=n+r*i.x,l=s+r*i.y;e.y=l+i.normalSlope*(e.x-o)},slope:Number.POSITIVE_INFINITY,touch:function(e){e.yTouched=!0},touched:function(e){return e.yTouched},untouch:function(e){e.yTouched=!1}};function UnitVector(e,t){this.x=e,this.y=t,this.axis=void 0,this.slope=t/e,this.normalSlope=-e/t,Object.freeze(this)}function getUnitVector(e,t){var r=Math.sqrt(e*e+t*t);return(e/=r,t/=r,1===e&&0===t)?es:0===e&&1===t?eo:new UnitVector(e,t)}function HPoint(e,t,r,i){this.x=this.xo=Math.round(64*e)/64,this.y=this.yo=Math.round(64*t)/64,this.lastPointOfContour=r,this.onCurve=i,this.prevPointOnContour=void 0,this.nextPointOnContour=void 0,this.xTouched=!1,this.yTouched=!1,Object.preventExtensions(this)}Object.freeze(es),Object.freeze(eo),UnitVector.prototype.distance=function(e,t,r,i){return this.x*es.distance(e,t,r,i)+this.y*eo.distance(e,t,r,i)},UnitVector.prototype.interpolate=function(e,t,r,i){var a,n,s,o,l,c,u;if(s=i.distance(e,t,!0,!0),o=i.distance(e,r,!0,!0),a=i.distance(t,t,!1,!0),n=i.distance(r,r,!1,!0),0===(u=(l=Math.abs(s))+(c=Math.abs(o)))){this.setRelative(e,e,(a+n)/2,i,!0);return}this.setRelative(e,e,(a*c+n*l)/u,i,!0)},UnitVector.prototype.setRelative=function(e,t,r,i,a){i=i||this;var n=a?t.xo:t.x,s=a?t.yo:t.y,o=n+r*i.x,l=s+r*i.y,c=i.normalSlope,u=this.slope,h=e.x,p=e.y;e.x=(u*h-c*o+l-p)/(u-c),e.y=u*(e.x-h)+p},UnitVector.prototype.touch=function(e){e.xTouched=!0,e.yTouched=!0},HPoint.prototype.nextTouched=function(e){for(var t=this.nextPointOnContour;!e.touched(t)&&t!==this;)t=t.nextPointOnContour;return t},HPoint.prototype.prevTouched=function(e){for(var t=this.prevPointOnContour;!e.touched(t)&&t!==this;)t=t.prevPointOnContour;return t};var el=Object.freeze(new HPoint(0,0)),ec={cvCutIn:17/16,deltaBase:9,deltaShift:.125,loop:1,minDis:1,autoFlip:!0};function State(e,t){switch(this.env=e,this.stack=[],this.prog=t,e){case"glyf":this.zp0=this.zp1=this.zp2=1,this.rp0=this.rp1=this.rp2=0;case"prep":this.fv=this.pv=this.dpv=es,this.round=roundToGrid}}function initTZone(e){for(var t=e.tZone=Array(e.gZone.length),r=0;r<t.length;r++)t[r]=new HPoint(0,0)}function skip(e,t){var r,i=e.prog,a=e.ip,n=1;do if(88===(r=i[++a]))n++;else if(89===r)n--;else if(64===r)a+=i[a+1]+1;else if(65===r)a+=2*i[a+1]+1;else if(r>=176&&r<=183)a+=r-176+1;else if(r>=184&&r<=191)a+=(r-184+1)*2;else if(t&&1===n&&27===r)break;while(n>0);e.ip=a}function SVTCA(e,t){exports.DEBUG&&console.log(t.step,"SVTCA["+e.axis+"]"),t.fv=t.pv=t.dpv=e}function SPVTCA(e,t){exports.DEBUG&&console.log(t.step,"SPVTCA["+e.axis+"]"),t.pv=t.dpv=e}function SFVTCA(e,t){exports.DEBUG&&console.log(t.step,"SFVTCA["+e.axis+"]"),t.fv=e}function SPVTL(e,t){var r,i,a=t.stack,n=a.pop(),s=a.pop(),o=t.z2[n],l=t.z1[s];exports.DEBUG&&console.log("SPVTL["+e+"]",n,s),e?(r=o.y-l.y,i=l.x-o.x):(r=l.x-o.x,i=l.y-o.y),t.pv=t.dpv=getUnitVector(r,i)}function SFVTL(e,t){var r,i,a=t.stack,n=a.pop(),s=a.pop(),o=t.z2[n],l=t.z1[s];exports.DEBUG&&console.log("SFVTL["+e+"]",n,s),e?(r=o.y-l.y,i=l.x-o.x):(r=l.x-o.x,i=l.y-o.y),t.fv=getUnitVector(r,i)}function SPVFS(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"SPVFS[]",r,i),e.pv=e.dpv=getUnitVector(i,r)}function SFVFS(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"SPVFS[]",r,i),e.fv=getUnitVector(i,r)}function GPV(e){var t=e.stack,r=e.pv;exports.DEBUG&&console.log(e.step,"GPV[]"),t.push(16384*r.x),t.push(16384*r.y)}function GFV(e){var t=e.stack,r=e.fv;exports.DEBUG&&console.log(e.step,"GFV[]"),t.push(16384*r.x),t.push(16384*r.y)}function SFVTPV(e){e.fv=e.pv,exports.DEBUG&&console.log(e.step,"SFVTPV[]")}function ISECT(e){var t=e.stack,r=t.pop(),i=t.pop(),a=t.pop(),n=t.pop(),s=t.pop(),o=e.z0,l=e.z1,c=o[r],u=o[i],h=l[a],p=l[n],d=e.z2[s];exports.DEBUG&&console.log("ISECT[], ",r,i,a,n,s);var f=c.x,m=c.y,g=u.x,v=u.y,y=h.x,x=h.y,b=p.x,T=p.y,S=(f-g)*(x-T)-(m-v)*(y-b),E=f*v-m*g,R=y*T-x*b;d.x=(E*(y-b)-R*(f-g))/S,d.y=(E*(x-T)-R*(m-v))/S}function SRP0(e){e.rp0=e.stack.pop(),exports.DEBUG&&console.log(e.step,"SRP0[]",e.rp0)}function SRP1(e){e.rp1=e.stack.pop(),exports.DEBUG&&console.log(e.step,"SRP1[]",e.rp1)}function SRP2(e){e.rp2=e.stack.pop(),exports.DEBUG&&console.log(e.step,"SRP2[]",e.rp2)}function SZP0(e){var t=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SZP0[]",t),e.zp0=t,t){case 0:e.tZone||initTZone(e),e.z0=e.tZone;break;case 1:e.z0=e.gZone;break;default:throw Error("Invalid zone pointer")}}function SZP1(e){var t=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SZP1[]",t),e.zp1=t,t){case 0:e.tZone||initTZone(e),e.z1=e.tZone;break;case 1:e.z1=e.gZone;break;default:throw Error("Invalid zone pointer")}}function SZP2(e){var t=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SZP2[]",t),e.zp2=t,t){case 0:e.tZone||initTZone(e),e.z2=e.tZone;break;case 1:e.z2=e.gZone;break;default:throw Error("Invalid zone pointer")}}function SZPS(e){var t=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SZPS[]",t),e.zp0=e.zp1=e.zp2=t,t){case 0:e.tZone||initTZone(e),e.z0=e.z1=e.z2=e.tZone;break;case 1:e.z0=e.z1=e.z2=e.gZone;break;default:throw Error("Invalid zone pointer")}}function SLOOP(e){e.loop=e.stack.pop(),exports.DEBUG&&console.log(e.step,"SLOOP[]",e.loop)}function RTG(e){exports.DEBUG&&console.log(e.step,"RTG[]"),e.round=roundToGrid}function RTHG(e){exports.DEBUG&&console.log(e.step,"RTHG[]"),e.round=roundToHalfGrid}function SMD(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SMD[]",t),e.minDis=t/64}function ELSE(e){exports.DEBUG&&console.log(e.step,"ELSE[]"),skip(e,!1)}function JMPR(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"JMPR[]",t),e.ip+=t-1}function SCVTCI(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SCVTCI[]",t),e.cvCutIn=t/64}function DUP(e){var t=e.stack;exports.DEBUG&&console.log(e.step,"DUP[]"),t.push(t[t.length-1])}function POP(e){exports.DEBUG&&console.log(e.step,"POP[]"),e.stack.pop()}function CLEAR(e){exports.DEBUG&&console.log(e.step,"CLEAR[]"),e.stack.length=0}function SWAP(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"SWAP[]"),t.push(r),t.push(i)}function DEPTH(e){var t=e.stack;exports.DEBUG&&console.log(e.step,"DEPTH[]"),t.push(t.length)}function LOOPCALL(e){var t=e.stack,i=t.pop(),a=t.pop();exports.DEBUG&&console.log(e.step,"LOOPCALL[]",i,a);var n=e.ip,s=e.prog;e.prog=e.funcs[i];for(var o=0;o<a;o++)r(e),exports.DEBUG&&console.log(++e.step,o+1<a?"next loopcall":"done loopcall",o);e.ip=n,e.prog=s}function CALL(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"CALL[]",t);var i=e.ip,a=e.prog;e.prog=e.funcs[t],r(e),e.ip=i,e.prog=a,exports.DEBUG&&console.log(++e.step,"returning from",t)}function CINDEX(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"CINDEX[]",r),t.push(t[t.length-r])}function MINDEX(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"MINDEX[]",r),t.push(t.splice(t.length-r,1)[0])}function FDEF(e){if("fpgm"!==e.env)throw Error("FDEF not allowed here");var t=e.stack,r=e.prog,i=e.ip,a=t.pop(),n=i;for(exports.DEBUG&&console.log(e.step,"FDEF[]",a);45!==r[++i];);e.ip=i,e.funcs[a]=r.slice(n+1,i)}function MDAP(e,t){var r=t.stack.pop(),i=t.z0[r],a=t.fv,n=t.pv;exports.DEBUG&&console.log(t.step,"MDAP["+e+"]",r);var s=n.distance(i,el);e&&(s=t.round(s)),a.setRelative(i,el,s,n),a.touch(i),t.rp0=t.rp1=r}function IUP(e,t){var r,i,a,n=t.z2,s=n.length-2;exports.DEBUG&&console.log(t.step,"IUP["+e.axis+"]");for(var o=0;o<s;o++)r=n[o],e.touched(r)||(i=r.prevTouched(e))===r||(i===(a=r.nextTouched(e))&&e.setRelative(r,r,e.distance(i,i,!1,!0),e,!0),e.interpolate(r,i,a,e))}function SHP(e,t){for(var r=t.stack,i=e?t.rp1:t.rp2,a=(e?t.z0:t.z1)[i],n=t.fv,s=t.pv,o=t.loop,l=t.z2;o--;){var c=r.pop(),u=l[c],h=s.distance(a,a,!1,!0);n.setRelative(u,u,h,s),n.touch(u),exports.DEBUG&&console.log(t.step,(t.loop>1?"loop "+(t.loop-o)+": ":"")+"SHP["+(e?"rp1":"rp2")+"]",c)}t.loop=1}function SHC(e,t){var r=t.stack,i=e?t.rp1:t.rp2,a=(e?t.z0:t.z1)[i],n=t.fv,s=t.pv,o=r.pop(),l=t.z2[t.contours[o]],c=l;exports.DEBUG&&console.log(t.step,"SHC["+e+"]",o);var u=s.distance(a,a,!1,!0);do c!==a&&n.setRelative(c,c,u,s),c=c.nextPointOnContour;while(c!==l)}function SHZ(e,t){var r,i,a=t.stack,n=e?t.rp1:t.rp2,s=(e?t.z0:t.z1)[n],o=t.fv,l=t.pv,c=a.pop();switch(exports.DEBUG&&console.log(t.step,"SHZ["+e+"]",c),c){case 0:r=t.tZone;break;case 1:r=t.gZone;break;default:throw Error("Invalid zone")}for(var u=l.distance(s,s,!1,!0),h=r.length-2,p=0;p<h;p++)i=r[p],o.setRelative(i,i,u,l)}function SHPIX(e){for(var t=e.stack,r=e.loop,i=e.fv,a=t.pop()/64,n=e.z2;r--;){var s=t.pop(),o=n[s];exports.DEBUG&&console.log(e.step,(e.loop>1?"loop "+(e.loop-r)+": ":"")+"SHPIX[]",s,a),i.setRelative(o,o,a),i.touch(o)}e.loop=1}function IP(e){for(var t=e.stack,r=e.rp1,i=e.rp2,a=e.loop,n=e.z0[r],s=e.z1[i],o=e.fv,l=e.dpv,c=e.z2;a--;){var u=t.pop(),h=c[u];exports.DEBUG&&console.log(e.step,(e.loop>1?"loop "+(e.loop-a)+": ":"")+"IP[]",u,r,"<->",i),o.interpolate(h,n,s,l),o.touch(h)}e.loop=1}function MSIRP(e,t){var r=t.stack,i=r.pop()/64,a=r.pop(),n=t.z1[a],s=t.z0[t.rp0],o=t.fv,l=t.pv;o.setRelative(n,s,i,l),o.touch(n),exports.DEBUG&&console.log(t.step,"MSIRP["+e+"]",i,a),t.rp1=t.rp0,t.rp2=a,e&&(t.rp0=a)}function ALIGNRP(e){for(var t=e.stack,r=e.rp0,i=e.z0[r],a=e.loop,n=e.fv,s=e.pv,o=e.z1;a--;){var l=t.pop(),c=o[l];exports.DEBUG&&console.log(e.step,(e.loop>1?"loop "+(e.loop-a)+": ":"")+"ALIGNRP[]",l),n.setRelative(c,i,0,s),n.touch(c)}e.loop=1}function RTDG(e){exports.DEBUG&&console.log(e.step,"RTDG[]"),e.round=roundToDoubleGrid}function MIAP(e,t){var r=t.stack,i=r.pop(),a=r.pop(),n=t.z0[a],s=t.fv,o=t.pv,l=t.cvt[i];exports.DEBUG&&console.log(t.step,"MIAP["+e+"]",i,"(",l,")",a);var c=o.distance(n,el);e&&(Math.abs(c-l)<t.cvCutIn&&(c=l),c=t.round(c)),s.setRelative(n,el,c,o),0===t.zp0&&(n.xo=n.x,n.yo=n.y),s.touch(n),t.rp0=t.rp1=a}function NPUSHB(e){var t=e.prog,r=e.ip,i=e.stack,a=t[++r];exports.DEBUG&&console.log(e.step,"NPUSHB[]",a);for(var n=0;n<a;n++)i.push(t[++r]);e.ip=r}function NPUSHW(e){var t=e.ip,r=e.prog,i=e.stack,a=r[++t];exports.DEBUG&&console.log(e.step,"NPUSHW[]",a);for(var n=0;n<a;n++){var s=r[++t]<<8|r[++t];32768&s&&(s=-((65535^s)+1)),i.push(s)}e.ip=t}function WS(e){var t=e.stack,r=e.store;r||(r=e.store=[]);var i=t.pop(),a=t.pop();exports.DEBUG&&console.log(e.step,"WS",i,a),r[a]=i}function RS(e){var t=e.stack,r=e.store,i=t.pop();exports.DEBUG&&console.log(e.step,"RS",i);var a=r&&r[i]||0;t.push(a)}function WCVTP(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"WCVTP",r,i),e.cvt[i]=r/64}function RCVT(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"RCVT",r),t.push(64*e.cvt[r])}function GC(e,t){var r=t.stack,i=r.pop(),a=t.z2[i];exports.DEBUG&&console.log(t.step,"GC["+e+"]",i),r.push(64*t.dpv.distance(a,el,e,!1))}function MD(e,t){var r=t.stack,i=r.pop(),a=r.pop(),n=t.z1[i],s=t.z0[a],o=t.dpv.distance(s,n,e,e);exports.DEBUG&&console.log(t.step,"MD["+e+"]",i,a,"->",o),t.stack.push(Math.round(64*o))}function MPPEM(e){exports.DEBUG&&console.log(e.step,"MPPEM[]"),e.stack.push(e.ppem)}function FLIPON(e){exports.DEBUG&&console.log(e.step,"FLIPON[]"),e.autoFlip=!0}function LT(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"LT[]",r,i),t.push(i<r?1:0)}function LTEQ(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"LTEQ[]",r,i),t.push(i<=r?1:0)}function GT(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"GT[]",r,i),t.push(i>r?1:0)}function GTEQ(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"GTEQ[]",r,i),t.push(i>=r?1:0)}function EQ(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"EQ[]",r,i),t.push(r===i?1:0)}function NEQ(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"NEQ[]",r,i),t.push(r!==i?1:0)}function ODD(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"ODD[]",r),t.push(Math.trunc(r)%2?1:0)}function EVEN(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"EVEN[]",r),t.push(Math.trunc(r)%2?0:1)}function IF(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"IF[]",t),!t&&(skip(e,!0),exports.DEBUG&&console.log(e.step,"EIF[]"))}function EIF(e){exports.DEBUG&&console.log(e.step,"EIF[]")}function AND(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"AND[]",r,i),t.push(r&&i?1:0)}function OR(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"OR[]",r,i),t.push(r||i?1:0)}function NOT(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"NOT[]",r),t.push(r?0:1)}function DELTAP123(e,t){var r=t.stack,i=r.pop(),a=t.fv,n=t.pv,s=t.ppem,o=t.deltaBase+(e-1)*16,l=t.deltaShift,c=t.z0;exports.DEBUG&&console.log(t.step,"DELTAP["+e+"]",i,r);for(var u=0;u<i;u++){var h=r.pop(),p=r.pop();if(o+((240&p)>>4)===s){var d=(15&p)-8;d>=0&&d++,exports.DEBUG&&console.log(t.step,"DELTAPFIX",h,"by",d*l);var f=c[h];a.setRelative(f,f,d*l,n)}}}function SDB(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SDB[]",t),e.deltaBase=t}function SDS(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SDS[]",t),e.deltaShift=Math.pow(.5,t)}function ADD(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"ADD[]",r,i),t.push(i+r)}function SUB(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"SUB[]",r,i),t.push(i-r)}function DIV(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"DIV[]",r,i),t.push(64*i/r)}function MUL(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"MUL[]",r,i),t.push(i*r/64)}function ABS(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"ABS[]",r),t.push(Math.abs(r))}function NEG(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"NEG[]",r),t.push(-r)}function FLOOR(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"FLOOR[]",r),t.push(64*Math.floor(r/64))}function CEILING(e){var t=e.stack,r=t.pop();exports.DEBUG&&console.log(e.step,"CEILING[]",r),t.push(64*Math.ceil(r/64))}function ROUND(e,t){var r=t.stack,i=r.pop();exports.DEBUG&&console.log(t.step,"ROUND[]"),r.push(64*t.round(i/64))}function WCVTF(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"WCVTF[]",r,i),e.cvt[i]=r*e.ppem/e.font.unitsPerEm}function DELTAC123(e,t){var r=t.stack,i=r.pop(),a=t.ppem,n=t.deltaBase+(e-1)*16,s=t.deltaShift;exports.DEBUG&&console.log(t.step,"DELTAC["+e+"]",i,r);for(var o=0;o<i;o++){var l=r.pop(),c=r.pop();if(n+((240&c)>>4)===a){var u=(15&c)-8;u>=0&&u++;var h=u*s;exports.DEBUG&&console.log(t.step,"DELTACFIX",l,"by",h),t.cvt[l]+=h}}}function SROUND(e){var t,r=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"SROUND[]",r),e.round=roundSuper,192&r){case 0:t=.5;break;case 64:t=1;break;case 128:t=2;break;default:throw Error("invalid SROUND value")}switch(e.srPeriod=t,48&r){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*t;break;case 32:e.srPhase=.5*t;break;case 48:e.srPhase=.75*t;break;default:throw Error("invalid SROUND value")}0==(r&=15)?e.srThreshold=0:e.srThreshold=(r/8-.5)*t}function S45ROUND(e){var t,r=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"S45ROUND[]",r),e.round=roundSuper,192&r){case 0:t=Math.sqrt(2)/2;break;case 64:t=Math.sqrt(2);break;case 128:t=2*Math.sqrt(2);break;default:throw Error("invalid S45ROUND value")}switch(e.srPeriod=t,48&r){case 0:e.srPhase=0;break;case 16:e.srPhase=.25*t;break;case 32:e.srPhase=.5*t;break;case 48:e.srPhase=.75*t;break;default:throw Error("invalid S45ROUND value")}0==(r&=15)?e.srThreshold=0:e.srThreshold=(r/8-.5)*t}function ROFF(e){exports.DEBUG&&console.log(e.step,"ROFF[]"),e.round=roundOff}function RUTG(e){exports.DEBUG&&console.log(e.step,"RUTG[]"),e.round=roundUpToGrid}function RDTG(e){exports.DEBUG&&console.log(e.step,"RDTG[]"),e.round=roundDownToGrid}function SCANCTRL(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SCANCTRL[]",t)}function SDPVTL(e,t){var r,i,a=t.stack,n=a.pop(),s=a.pop(),o=t.z2[n],l=t.z1[s];exports.DEBUG&&console.log(t.step,"SDPVTL["+e+"]",n,s),e?(r=o.y-l.y,i=l.x-o.x):(r=l.x-o.x,i=l.y-o.y),t.dpv=getUnitVector(r,i)}function GETINFO(e){var t=e.stack,r=t.pop(),i=0;exports.DEBUG&&console.log(e.step,"GETINFO[]",r),1&r&&(i=35),32&r&&(i|=4096),t.push(i)}function ROLL(e){var t=e.stack,r=t.pop(),i=t.pop(),a=t.pop();exports.DEBUG&&console.log(e.step,"ROLL[]"),t.push(i),t.push(r),t.push(a)}function MAX(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"MAX[]",r,i),t.push(Math.max(i,r))}function MIN(e){var t=e.stack,r=t.pop(),i=t.pop();exports.DEBUG&&console.log(e.step,"MIN[]",r,i),t.push(Math.min(i,r))}function SCANTYPE(e){var t=e.stack.pop();exports.DEBUG&&console.log(e.step,"SCANTYPE[]",t)}function INSTCTRL(e){var t=e.stack.pop(),r=e.stack.pop();switch(exports.DEBUG&&console.log(e.step,"INSTCTRL[]",t,r),t){case 1:e.inhibitGridFit=!!r;return;case 2:e.ignoreCvt=!!r;return;default:throw Error("invalid INSTCTRL[] selector")}}function PUSHB(e,t){var r=t.stack,i=t.prog,a=t.ip;exports.DEBUG&&console.log(t.step,"PUSHB["+e+"]");for(var n=0;n<e;n++)r.push(i[++a]);t.ip=a}function PUSHW(e,t){var r=t.ip,i=t.prog,a=t.stack;exports.DEBUG&&console.log(t.ip,"PUSHW["+e+"]");for(var n=0;n<e;n++){var s=i[++r]<<8|i[++r];32768&s&&(s=-((65535^s)+1)),a.push(s)}t.ip=r}function MDRP_MIRP(e,t,r,i,a,n){var s,o,l,c,u=n.stack,h=e&&u.pop(),p=u.pop(),d=n.rp0,f=n.z0[d],m=n.z1[p],g=n.minDis,v=n.fv,y=n.dpv;l=(o=s=y.distance(m,f,!0,!0))>=0?1:-1,o=Math.abs(o),e&&(c=n.cvt[h],i&&Math.abs(o-c)<n.cvCutIn&&(o=c)),r&&o<g&&(o=g),i&&(o=n.round(o)),v.setRelative(m,f,l*o,y),v.touch(m),exports.DEBUG&&console.log(n.step,(e?"MIRP[":"MDRP[")+(t?"M":"m")+(r?">":"_")+(i?"R":"_")+(0===a?"Gr":1===a?"Bl":2===a?"Wh":"")+"]",e?h+"("+n.cvt[h]+","+c+")":"",p,"(d =",s,"->",l*o,")"),n.rp1=n.rp0,n.rp2=p,t&&(n.rp0=p)}function Token(e){this.char=e,this.state={},this.activeState=null}function ContextRange(e,t,r){this.contextName=r,this.startIndex=e,this.endOffset=t}function ContextChecker(e,t,r){this.contextName=e,this.openRange=null,this.ranges=[],this.checkStart=t,this.checkEnd=r}function ContextParams(e,t){this.context=e,this.index=t,this.length=e.length,this.current=e[t],this.backtrack=e.slice(0,t),this.lookahead=e.slice(t+1)}function Event(e){this.eventId=e,this.subscribers=[]}function initializeCoreEvents(e){var t=this,r=["start","end","next","newToken","contextStart","contextEnd","insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD","updateContextsRanges"];r.forEach(function(e){Object.defineProperty(t.events,e,{value:new Event(e)})}),e&&r.forEach(function(r){var i=e[r];"function"==typeof i&&t.events[r].subscribe(i)}),["insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD"].forEach(function(e){t.events[e].subscribe(t.updateContextsRanges)})}function Tokenizer(e){this.tokens=[],this.registeredContexts={},this.contextCheckers=[],this.events={},this.registeredModifiers=[],initializeCoreEvents.call(this,e)}function isArabicChar(e){return/[\u0600-\u065F\u066A-\u06D2\u06FA-\u06FF]/.test(e)}function isIsolatedArabicChar(e){return/[\u0630\u0690\u0621\u0631\u0661\u0671\u0622\u0632\u0672\u0692\u06C2\u0623\u0673\u0693\u06C3\u0624\u0694\u06C4\u0625\u0675\u0695\u06C5\u06E5\u0676\u0696\u06C6\u0627\u0677\u0697\u06C7\u0648\u0688\u0698\u06C8\u0689\u0699\u06C9\u068A\u06CA\u066B\u068B\u06CB\u068C\u068D\u06CD\u06FD\u068E\u06EE\u06FE\u062F\u068F\u06CF\u06EF]/.test(e)}function isTashkeelArabicChar(e){return/[\u0600-\u0605\u060C-\u060E\u0610-\u061B\u061E\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED]/.test(e)}function isLatinChar(e){return/[A-z]/.test(e)}function isWhiteSpace(e){return/\s/.test(e)}function FeatureQuery(e){this.font=e,this.features={}}function SubstitutionAction(e){this.id=e.id,this.tag=e.tag,this.substitution=e.substitution}function lookupCoverage(e,t){if(!e)return -1;switch(t.format){case 1:return t.glyphs.indexOf(e);case 2:for(var r=t.ranges,i=0;i<r.length;i++){var a=r[i];if(e>=a.start&&e<=a.end){var n=e-a.start;return a.index+n}}}return -1}function singleSubstitutionFormat1(e,t){return -1===lookupCoverage(e,t.coverage)?null:e+t.deltaGlyphId}function singleSubstitutionFormat2(e,t){var r=lookupCoverage(e,t.coverage);return -1===r?null:t.substitute[r]}function lookupCoverageList(e,t){for(var r=[],i=0;i<e.length;i++){var a=e[i],n=t.current,s=lookupCoverage(n=Array.isArray(n)?n[0]:n,a);-1!==s&&r.push(s)}return r.length!==e.length?-1:r}function chainingSubstitutionFormat3(e,t){var r=t.inputCoverage.length+t.lookaheadCoverage.length+t.backtrackCoverage.length;if(e.context.length<r)return[];var i=lookupCoverageList(t.inputCoverage,e);if(-1===i)return[];var a=t.inputCoverage.length-1;if(e.lookahead.length<t.lookaheadCoverage.length)return[];for(var n=e.lookahead.slice(a);n.length&&isTashkeelArabicChar(n[0].char);)n.shift();var s=new ContextParams(n,0),o=lookupCoverageList(t.lookaheadCoverage,s),l=[].concat(e.backtrack);for(l.reverse();l.length&&isTashkeelArabicChar(l[0].char);)l.shift();if(l.length<t.backtrackCoverage.length)return[];var c=new ContextParams(l,0),u=lookupCoverageList(t.backtrackCoverage,c),h=i.length===t.inputCoverage.length&&o.length===t.lookaheadCoverage.length&&u.length===t.backtrackCoverage.length,p=[];if(h)for(var d=0;d<t.lookupRecords.length;d++)for(var f=t.lookupRecords[d].lookupListIndex,m=this.getLookupByIndex(f),g=0;g<m.subtables.length;g++){var v=m.subtables[g],y=this.getLookupMethod(m,v);if("12"===this.getSubstitutionType(m,v))for(var x=0;x<i.length;x++){var b=y(e.get(x));b&&p.push(b)}}return p}function ligatureSubstitutionFormat1(e,t){var r,i=lookupCoverage(e.current,t.coverage);if(-1===i)return null;for(var a=t.ligatureSets[i],n=0;n<a.length;n++){r=a[n];for(var s=0;s<r.components.length&&e.lookahead[s]===r.components[s];s++)if(s===r.components.length-1)return r}return null}function decompositionSubstitutionFormat1(e,t){var r=lookupCoverage(e,t.coverage);return -1===r?null:t.sequences[r]}function arabicWordStartCheck(e){var t=e.current,r=e.get(-1);return null===r&&isArabicChar(t)||!isArabicChar(r)&&isArabicChar(t)}function arabicWordEndCheck(e){var t=e.get(1);return null===t||!isArabicChar(t)}function arabicSentenceStartCheck(e){var t=e.current,r=e.get(-1);return(isArabicChar(t)||isTashkeelArabicChar(t))&&!isArabicChar(r)}function arabicSentenceEndCheck(e){var t=e.get(1);switch(!0){case null===t:return!0;case!isArabicChar(t)&&!isTashkeelArabicChar(t):var r=isWhiteSpace(t);if(!r||r&&!e.lookahead.some(function(e){return isArabicChar(e)||isTashkeelArabicChar(e)}))return!0;break;default:return!1}}Hinting.prototype.exec=function(e,t){if("number"!=typeof t)throw Error("Point size is not a number!");if(!(this._errorState>2)){var a=this.font,n=this._prepState;if(!n||n.ppem!==t){var s=this._fpgmState;if(!s){State.prototype=ec,(s=this._fpgmState=new State("fpgm",a.tables.fpgm)).funcs=[],s.font=a,exports.DEBUG&&(console.log("---EXEC FPGM---"),s.step=-1);try{r(s)}catch(e){console.log("Hinting error in FPGM:"+e),this._errorState=3;return}}State.prototype=s,(n=this._prepState=new State("prep",a.tables.prep)).ppem=t;var o=a.tables.cvt;if(o)for(var l=n.cvt=Array(o.length),c=t/a.unitsPerEm,u=0;u<o.length;u++)l[u]=o[u]*c;else n.cvt=[];exports.DEBUG&&(console.log("---EXEC PREP---"),n.step=-1);try{r(n)}catch(e){this._errorState<2&&console.log("Hinting error in PREP:"+e),this._errorState=2}}if(!(this._errorState>1))try{return i(e,n)}catch(e){this._errorState<1&&(console.log("Hinting error:"+e),console.log("Note: further hinting errors are silenced")),this._errorState=1;return}}},i=function(e,t){var i,n,s,o=t.ppem/t.font.unitsPerEm,l=e.components;if(State.prototype=t,l){var c=t.font;n=[],i=[];for(var u=0;u<l.length;u++){var h=l[u],p=c.glyphs.get(h.glyphIndex);s=new State("glyf",p.instructions),exports.DEBUG&&(console.log("---EXEC COMP "+u+"---"),s.step=-1),a(p,s,o,o);for(var d=Math.round(h.dx*o),f=Math.round(h.dy*o),m=s.gZone,g=s.contours,v=0;v<m.length;v++){var y=m[v];y.xTouched=y.yTouched=!1,y.xo=y.x=y.x+d,y.yo=y.y=y.y+f}var x=n.length;n.push.apply(n,m);for(var b=0;b<g.length;b++)i.push(g[b]+x)}e.instructions&&!s.inhibitGridFit&&((s=new State("glyf",e.instructions)).gZone=s.z0=s.z1=s.z2=n,s.contours=i,n.push(new HPoint(0,0),new HPoint(Math.round(e.advanceWidth*o),0)),exports.DEBUG&&(console.log("---EXEC COMPOSITE---"),s.step=-1),r(s),n.length-=2)}else s=new State("glyf",e.instructions),exports.DEBUG&&(console.log("---EXEC GLYPH---"),s.step=-1),a(e,s,o,o),n=s.gZone;return n},a=function(e,t,i,a){for(var n,s,o,l=e.points||[],c=l.length,u=t.gZone=t.z0=t.z1=t.z2=[],h=t.contours=[],p=0;p<c;p++)n=l[p],u[p]=new HPoint(n.x*i,n.y*a,n.lastPointOfContour,n.onCurve);for(var d=0;d<c;d++)n=u[d],s||(s=n,h.push(d)),n.lastPointOfContour?(n.nextPointOnContour=s,s.prevPointOnContour=n,s=void 0):(o=u[d+1],n.nextPointOnContour=o,o.prevPointOnContour=n);if(!t.inhibitGridFit){if(exports.DEBUG){console.log("PROCESSING GLYPH",t.stack);for(var f=0;f<c;f++)console.log(f,u[f].x,u[f].y)}if(u.push(new HPoint(0,0),new HPoint(Math.round(e.advanceWidth*i),0)),r(t),u.length-=2,exports.DEBUG){console.log("FINISHED GLYPH",t.stack);for(var m=0;m<c;m++)console.log(m,u[m].x,u[m].y)}}},r=function(e){var r,i=e.prog;if(i){var a=i.length;for(e.ip=0;e.ip<a;e.ip++){if(exports.DEBUG&&e.step++,!(r=t[i[e.ip]]))throw Error("unknown instruction: 0x"+Number(i[e.ip]).toString(16));r(e)}}},t=[SVTCA.bind(void 0,eo),SVTCA.bind(void 0,es),SPVTCA.bind(void 0,eo),SPVTCA.bind(void 0,es),SFVTCA.bind(void 0,eo),SFVTCA.bind(void 0,es),SPVTL.bind(void 0,0),SPVTL.bind(void 0,1),SFVTL.bind(void 0,0),SFVTL.bind(void 0,1),SPVFS,SFVFS,GPV,GFV,SFVTPV,ISECT,SRP0,SRP1,SRP2,SZP0,SZP1,SZP2,SZPS,SLOOP,RTG,RTHG,SMD,ELSE,JMPR,SCVTCI,void 0,void 0,DUP,POP,CLEAR,SWAP,DEPTH,CINDEX,MINDEX,void 0,void 0,void 0,LOOPCALL,CALL,FDEF,void 0,MDAP.bind(void 0,0),MDAP.bind(void 0,1),IUP.bind(void 0,eo),IUP.bind(void 0,es),SHP.bind(void 0,0),SHP.bind(void 0,1),SHC.bind(void 0,0),SHC.bind(void 0,1),SHZ.bind(void 0,0),SHZ.bind(void 0,1),SHPIX,IP,MSIRP.bind(void 0,0),MSIRP.bind(void 0,1),ALIGNRP,RTDG,MIAP.bind(void 0,0),MIAP.bind(void 0,1),NPUSHB,NPUSHW,WS,RS,WCVTP,RCVT,GC.bind(void 0,0),GC.bind(void 0,1),void 0,MD.bind(void 0,0),MD.bind(void 0,1),MPPEM,void 0,FLIPON,void 0,void 0,LT,LTEQ,GT,GTEQ,EQ,NEQ,ODD,EVEN,IF,EIF,AND,OR,NOT,DELTAP123.bind(void 0,1),SDB,SDS,ADD,SUB,DIV,MUL,ABS,NEG,FLOOR,CEILING,ROUND.bind(void 0,0),ROUND.bind(void 0,1),ROUND.bind(void 0,2),ROUND.bind(void 0,3),void 0,void 0,void 0,void 0,WCVTF,DELTAP123.bind(void 0,2),DELTAP123.bind(void 0,3),DELTAC123.bind(void 0,1),DELTAC123.bind(void 0,2),DELTAC123.bind(void 0,3),SROUND,S45ROUND,void 0,void 0,ROFF,void 0,RUTG,RDTG,POP,POP,void 0,void 0,void 0,void 0,void 0,SCANCTRL,SDPVTL.bind(void 0,0),SDPVTL.bind(void 0,1),GETINFO,void 0,ROLL,MAX,MIN,SCANTYPE,INSTCTRL,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,PUSHB.bind(void 0,1),PUSHB.bind(void 0,2),PUSHB.bind(void 0,3),PUSHB.bind(void 0,4),PUSHB.bind(void 0,5),PUSHB.bind(void 0,6),PUSHB.bind(void 0,7),PUSHB.bind(void 0,8),PUSHW.bind(void 0,1),PUSHW.bind(void 0,2),PUSHW.bind(void 0,3),PUSHW.bind(void 0,4),PUSHW.bind(void 0,5),PUSHW.bind(void 0,6),PUSHW.bind(void 0,7),PUSHW.bind(void 0,8),MDRP_MIRP.bind(void 0,0,0,0,0,0),MDRP_MIRP.bind(void 0,0,0,0,0,1),MDRP_MIRP.bind(void 0,0,0,0,0,2),MDRP_MIRP.bind(void 0,0,0,0,0,3),MDRP_MIRP.bind(void 0,0,0,0,1,0),MDRP_MIRP.bind(void 0,0,0,0,1,1),MDRP_MIRP.bind(void 0,0,0,0,1,2),MDRP_MIRP.bind(void 0,0,0,0,1,3),MDRP_MIRP.bind(void 0,0,0,1,0,0),MDRP_MIRP.bind(void 0,0,0,1,0,1),MDRP_MIRP.bind(void 0,0,0,1,0,2),MDRP_MIRP.bind(void 0,0,0,1,0,3),MDRP_MIRP.bind(void 0,0,0,1,1,0),MDRP_MIRP.bind(void 0,0,0,1,1,1),MDRP_MIRP.bind(void 0,0,0,1,1,2),MDRP_MIRP.bind(void 0,0,0,1,1,3),MDRP_MIRP.bind(void 0,0,1,0,0,0),MDRP_MIRP.bind(void 0,0,1,0,0,1),MDRP_MIRP.bind(void 0,0,1,0,0,2),MDRP_MIRP.bind(void 0,0,1,0,0,3),MDRP_MIRP.bind(void 0,0,1,0,1,0),MDRP_MIRP.bind(void 0,0,1,0,1,1),MDRP_MIRP.bind(void 0,0,1,0,1,2),MDRP_MIRP.bind(void 0,0,1,0,1,3),MDRP_MIRP.bind(void 0,0,1,1,0,0),MDRP_MIRP.bind(void 0,0,1,1,0,1),MDRP_MIRP.bind(void 0,0,1,1,0,2),MDRP_MIRP.bind(void 0,0,1,1,0,3),MDRP_MIRP.bind(void 0,0,1,1,1,0),MDRP_MIRP.bind(void 0,0,1,1,1,1),MDRP_MIRP.bind(void 0,0,1,1,1,2),MDRP_MIRP.bind(void 0,0,1,1,1,3),MDRP_MIRP.bind(void 0,1,0,0,0,0),MDRP_MIRP.bind(void 0,1,0,0,0,1),MDRP_MIRP.bind(void 0,1,0,0,0,2),MDRP_MIRP.bind(void 0,1,0,0,0,3),MDRP_MIRP.bind(void 0,1,0,0,1,0),MDRP_MIRP.bind(void 0,1,0,0,1,1),MDRP_MIRP.bind(void 0,1,0,0,1,2),MDRP_MIRP.bind(void 0,1,0,0,1,3),MDRP_MIRP.bind(void 0,1,0,1,0,0),MDRP_MIRP.bind(void 0,1,0,1,0,1),MDRP_MIRP.bind(void 0,1,0,1,0,2),MDRP_MIRP.bind(void 0,1,0,1,0,3),MDRP_MIRP.bind(void 0,1,0,1,1,0),MDRP_MIRP.bind(void 0,1,0,1,1,1),MDRP_MIRP.bind(void 0,1,0,1,1,2),MDRP_MIRP.bind(void 0,1,0,1,1,3),MDRP_MIRP.bind(void 0,1,1,0,0,0),MDRP_MIRP.bind(void 0,1,1,0,0,1),MDRP_MIRP.bind(void 0,1,1,0,0,2),MDRP_MIRP.bind(void 0,1,1,0,0,3),MDRP_MIRP.bind(void 0,1,1,0,1,0),MDRP_MIRP.bind(void 0,1,1,0,1,1),MDRP_MIRP.bind(void 0,1,1,0,1,2),MDRP_MIRP.bind(void 0,1,1,0,1,3),MDRP_MIRP.bind(void 0,1,1,1,0,0),MDRP_MIRP.bind(void 0,1,1,1,0,1),MDRP_MIRP.bind(void 0,1,1,1,0,2),MDRP_MIRP.bind(void 0,1,1,1,0,3),MDRP_MIRP.bind(void 0,1,1,1,1,0),MDRP_MIRP.bind(void 0,1,1,1,1,1),MDRP_MIRP.bind(void 0,1,1,1,1,2),MDRP_MIRP.bind(void 0,1,1,1,1,3)],Token.prototype.setState=function(e,t){return this.state[e]=t,this.activeState={key:e,value:this.state[e]},this.activeState},Token.prototype.getState=function(e){return this.state[e]||null},Tokenizer.prototype.inboundIndex=function(e){return e>=0&&e<this.tokens.length},Tokenizer.prototype.composeRUD=function(e){var t=this,r=e.map(function(e){return t[e[0]].apply(t,e.slice(1).concat(!0))}),hasFAILObject=function(e){return"object"==typeof e&&e.hasOwnProperty("FAIL")};if(r.every(hasFAILObject))return{FAIL:"composeRUD: one or more operations hasn't completed successfully",report:r.filter(hasFAILObject)};this.dispatch("composeRUD",[r.filter(function(e){return!hasFAILObject(e)})])},Tokenizer.prototype.replaceRange=function(e,t,r,i){t=null!==t?t:this.tokens.length;var a=r.every(function(e){return e instanceof Token});if(!(!isNaN(e)&&this.inboundIndex(e))||!a)return{FAIL:"replaceRange: invalid tokens or startIndex."};var n=this.tokens.splice.apply(this.tokens,[e,t].concat(r));return i||this.dispatch("replaceToken",[e,t,r]),[n,r]},Tokenizer.prototype.replaceToken=function(e,t,r){if(!(!isNaN(e)&&this.inboundIndex(e))||!(t instanceof Token))return{FAIL:"replaceToken: invalid token or index."};var i=this.tokens.splice(e,1,t);return r||this.dispatch("replaceToken",[e,t]),[i[0],t]},Tokenizer.prototype.removeRange=function(e,t,r){t=isNaN(t)?this.tokens.length:t;var i=this.tokens.splice(e,t);return r||this.dispatch("removeRange",[i,e,t]),i},Tokenizer.prototype.removeToken=function(e,t){if(!(!isNaN(e)&&this.inboundIndex(e)))return{FAIL:"removeToken: invalid token index."};var r=this.tokens.splice(e,1);return t||this.dispatch("removeToken",[r,e]),r},Tokenizer.prototype.insertToken=function(e,t,r){return e.every(function(e){return e instanceof Token})?(this.tokens.splice.apply(this.tokens,[t,0].concat(e)),r||this.dispatch("insertToken",[e,t]),e):{FAIL:"insertToken: invalid token(s)."}},Tokenizer.prototype.registerModifier=function(e,t,r){this.events.newToken.subscribe(function(i,a){if(null===t||!0===t.apply(this,[i,a])){var n=r.apply(this,[i,a]);i.setState(e,n)}}),this.registeredModifiers.push(e)},Event.prototype.subscribe=function(e){return"function"==typeof e?this.subscribers.push(e)-1:{FAIL:"invalid '"+this.eventId+"' event handler"}},Event.prototype.unsubscribe=function(e){this.subscribers.splice(e,1)},ContextParams.prototype.setCurrentIndex=function(e){this.index=e,this.current=this.context[e],this.backtrack=this.context.slice(0,e),this.lookahead=this.context.slice(e+1)},ContextParams.prototype.get=function(e){switch(!0){case 0===e:return this.current;case e<0&&Math.abs(e)<=this.backtrack.length:return this.backtrack.slice(e)[0];case e>0&&e<=this.lookahead.length:return this.lookahead[e-1];default:return null}},Tokenizer.prototype.rangeToText=function(e){if(e instanceof ContextRange)return this.getRangeTokens(e).map(function(e){return e.char}).join("")},Tokenizer.prototype.getText=function(){return this.tokens.map(function(e){return e.char}).join("")},Tokenizer.prototype.getContext=function(e){return this.registeredContexts[e]||null},Tokenizer.prototype.on=function(e,t){var r=this.events[e];return r?r.subscribe(t):null},Tokenizer.prototype.dispatch=function(e,t){var r=this,i=this.events[e];i instanceof Event&&i.subscribers.forEach(function(e){e.apply(r,t||[])})},Tokenizer.prototype.registerContextChecker=function(e,t,r){if(this.getContext(e))return{FAIL:"context name '"+e+"' is already registered."};if("function"!=typeof t)return{FAIL:"missing context start check."};if("function"!=typeof r)return{FAIL:"missing context end check."};var i=new ContextChecker(e,t,r);return this.registeredContexts[e]=i,this.contextCheckers.push(i),i},Tokenizer.prototype.getRangeTokens=function(e){var t=e.startIndex+e.endOffset;return[].concat(this.tokens.slice(e.startIndex,t))},Tokenizer.prototype.getContextRanges=function(e){var t=this.getContext(e);return t?t.ranges:{FAIL:"context checker '"+e+"' is not registered."}},Tokenizer.prototype.resetContextsRanges=function(){var e=this.registeredContexts;for(var t in e)e.hasOwnProperty(t)&&(e[t].ranges=[])},Tokenizer.prototype.updateContextsRanges=function(){this.resetContextsRanges();for(var e=this.tokens.map(function(e){return e.char}),t=0;t<e.length;t++){var r=new ContextParams(e,t);this.runContextCheck(r)}this.dispatch("updateContextsRanges",[this.registeredContexts])},Tokenizer.prototype.setEndOffset=function(e,t){var r=new ContextRange(this.getContext(t).openRange.startIndex,e,t),i=this.getContext(t).ranges;return r.rangeId=t+"."+i.length,i.push(r),this.getContext(t).openRange=null,r},Tokenizer.prototype.runContextCheck=function(e){var t=this,r=e.index;this.contextCheckers.forEach(function(i){var a=i.contextName,n=t.getContext(a).openRange;if(!n&&i.checkStart(e)&&(n=new ContextRange(r,null,a),t.getContext(a).openRange=n,t.dispatch("contextStart",[a,r])),n&&i.checkEnd(e)){var s=r-n.startIndex+1,o=t.setEndOffset(s,a);t.dispatch("contextEnd",[a,o])}})},Tokenizer.prototype.tokenize=function(e){this.tokens=[],this.resetContextsRanges();var t=Array.from(e);this.dispatch("start");for(var r=0;r<t.length;r++){var i=t[r],a=new ContextParams(t,r);this.dispatch("next",[a]),this.runContextCheck(a);var n=new Token(i);this.tokens.push(n),this.dispatch("newToken",[n,a])}return this.dispatch("end",[this.tokens]),this.tokens},FeatureQuery.prototype.getDefaultScriptFeaturesIndexes=function(){for(var e=this.font.tables.gsub.scripts,t=0;t<e.length;t++){var r=e[t];if("DFLT"===r.tag)return r.script.defaultLangSys.featureIndexes}return[]},FeatureQuery.prototype.getScriptFeaturesIndexes=function(e){if(!this.font.tables.gsub)return[];if(!e)return this.getDefaultScriptFeaturesIndexes();for(var t=this.font.tables.gsub.scripts,r=0;r<t.length;r++){var i=t[r];if(i.tag===e&&i.script.defaultLangSys)return i.script.defaultLangSys.featureIndexes;var a=i.langSysRecords;if(a)for(var n=0;n<a.length;n++){var s=a[n];if(s.tag===e)return s.langSys.featureIndexes}}return this.getDefaultScriptFeaturesIndexes()},FeatureQuery.prototype.mapTagsToFeatures=function(e,t){for(var r={},i=0;i<e.length;i++){var a=e[i].tag,n=e[i].feature;r[a]=n}this.features[t].tags=r},FeatureQuery.prototype.getScriptFeatures=function(e){var t=this.features[e];if(this.features.hasOwnProperty(e))return t;var r=this.getScriptFeaturesIndexes(e);if(!r)return null;var i=this.font.tables.gsub;return t=r.map(function(e){return i.features[e]}),this.features[e]=t,this.mapTagsToFeatures(t,e),t},FeatureQuery.prototype.getSubstitutionType=function(e,t){return e.lookupType.toString()+t.substFormat.toString()},FeatureQuery.prototype.getLookupMethod=function(e,t){var r=this;switch(this.getSubstitutionType(e,t)){case"11":return function(e){return singleSubstitutionFormat1.apply(r,[e,t])};case"12":return function(e){return singleSubstitutionFormat2.apply(r,[e,t])};case"63":return function(e){return chainingSubstitutionFormat3.apply(r,[e,t])};case"41":return function(e){return ligatureSubstitutionFormat1.apply(r,[e,t])};case"21":return function(e){return decompositionSubstitutionFormat1.apply(r,[e,t])};default:throw Error("lookupType: "+e.lookupType+" - substFormat: "+t.substFormat+" is not yet supported")}},FeatureQuery.prototype.lookupFeature=function(e){var t=e.contextParams,r=t.index,i=this.getFeature({tag:e.tag,script:e.script});if(!i)return Error("font '"+this.font.names.fullName.en+"' doesn't support feature '"+e.tag+"' for script '"+e.script+"'.");for(var a=this.getFeatureLookups(i),n=[].concat(t.context),s=0;s<a.length;s++)for(var o=a[s],l=this.getLookupSubtables(o),c=0;c<l.length;c++){var u=l[c],h=this.getSubstitutionType(o,u),p=this.getLookupMethod(o,u),d=void 0;switch(h){case"11":(d=p(t.current))&&n.splice(r,1,new SubstitutionAction({id:11,tag:e.tag,substitution:d}));break;case"12":(d=p(t.current))&&n.splice(r,1,new SubstitutionAction({id:12,tag:e.tag,substitution:d}));break;case"63":Array.isArray(d=p(t))&&d.length&&n.splice(r,1,new SubstitutionAction({id:63,tag:e.tag,substitution:d}));break;case"41":(d=p(t))&&n.splice(r,1,new SubstitutionAction({id:41,tag:e.tag,substitution:d}));break;case"21":(d=p(t.current))&&n.splice(r,1,new SubstitutionAction({id:21,tag:e.tag,substitution:d}))}t=new ContextParams(n,r),(!Array.isArray(d)||d.length)&&(d=null)}return n.length?n:null},FeatureQuery.prototype.supports=function(e){if(!e.script)return!1;this.getScriptFeatures(e.script);var t=this.features.hasOwnProperty(e.script);if(!e.tag)return t;var r=this.features[e.script].some(function(t){return t.tag===e.tag});return t&&r},FeatureQuery.prototype.getLookupSubtables=function(e){return e.subtables||null},FeatureQuery.prototype.getLookupByIndex=function(e){return this.font.tables.gsub.lookups[e]||null},FeatureQuery.prototype.getFeatureLookups=function(e){return e.lookupListIndexes.map(this.getLookupByIndex.bind(this))},FeatureQuery.prototype.getFeature=function(e){if(!this.font)return{FAIL:"No font was found"};this.features.hasOwnProperty(e.script)||this.getScriptFeatures(e.script);var t=this.features[e.script];return t?t.tags[e.tag]?this.features[e.script].tags[e.tag]:null:{FAIL:"No feature for script "+e.script}};var eu={11:function(e,t,r){t[r].setState(e.tag,e.substitution)},12:function(e,t,r){t[r].setState(e.tag,e.substitution)},63:function(e,t,r){e.substitution.forEach(function(i,a){t[r+a].setState(e.tag,i)})},41:function(e,t,r){var i=t[r];i.setState(e.tag,e.substitution.ligGlyph);for(var a=e.substitution.components.length,n=0;n<a;n++)(i=t[r+n+1]).setState("deleted",!0)}};function applySubstitution(e,t,r){e instanceof SubstitutionAction&&eu[e.id]&&eu[e.id](e,t,r)}function willConnectPrev(e){for(var t=[].concat(e.backtrack),r=t.length-1;r>=0;r--){var i=t[r],a=isIsolatedArabicChar(i),n=isTashkeelArabicChar(i);if(!a&&!n)return!0;if(a)break}return!1}function willConnectNext(e){if(isIsolatedArabicChar(e.current))return!1;for(var t=0;t<e.lookahead.length;t++)if(!isTashkeelArabicChar(e.lookahead[t]))return!0;return!1}function arabicPresentationForms(e){var t=this,r="arab",i=this.featuresTags[r],a=this.tokenizer.getRangeTokens(e);if(1!==a.length){var n=new ContextParams(a.map(function(e){return e.getState("glyphIndex")}),0),s=new ContextParams(a.map(function(e){return e.char}),0);a.forEach(function(e,o){if(!isTashkeelArabicChar(e.char)){n.setCurrentIndex(o),s.setCurrentIndex(o);var l,c=0;switch(willConnectPrev(s)&&(c|=1),willConnectNext(s)&&(c|=2),c){case 1:l="fina";break;case 2:l="init";break;case 3:l="medi"}if(-1!==i.indexOf(l)){var u=t.query.lookupFeature({tag:l,script:r,contextParams:n});if(u instanceof Error)return console.info(u.message);u.forEach(function(e,t){e instanceof SubstitutionAction&&(applySubstitution(e,a,t),n.context[t]=e.substitution)})}}})}}function getContextParams(e,t){return new ContextParams(e.map(function(e){return e.activeState.value}),t||0)}function arabicRequiredLigatures(e){var t=this,r=this.tokenizer.getRangeTokens(e),i=getContextParams(r);i.context.forEach(function(e,a){i.setCurrentIndex(a);var n=t.query.lookupFeature({tag:"rlig",script:"arab",contextParams:i});n.length&&(n.forEach(function(e){return applySubstitution(e,r,a)}),i=getContextParams(r))})}function latinWordStartCheck(e){var t=e.current,r=e.get(-1);return null===r&&isLatinChar(t)||!isLatinChar(r)&&isLatinChar(t)}function latinWordEndCheck(e){var t=e.get(1);return null===t||!isLatinChar(t)}function getContextParams$1(e,t){return new ContextParams(e.map(function(e){return e.activeState.value}),t||0)}function latinLigature(e){var t=this,r=this.tokenizer.getRangeTokens(e),i=getContextParams$1(r);i.context.forEach(function(e,a){i.setCurrentIndex(a);var n=t.query.lookupFeature({tag:"liga",script:"latn",contextParams:i});n.length&&(n.forEach(function(e){return applySubstitution(e,r,a)}),i=getContextParams$1(r))})}function Bidi(e){this.baseDir=e||"ltr",this.tokenizer=new Tokenizer,this.featuresTags={}}function registerContextChecker(e){var t=this.contextChecks[e+"Check"];return this.tokenizer.registerContextChecker(e,t.startCheck,t.endCheck)}function tokenizeText(){return registerContextChecker.call(this,"latinWord"),registerContextChecker.call(this,"arabicWord"),registerContextChecker.call(this,"arabicSentence"),this.tokenizer.tokenize(this.text)}function reverseArabicSentences(){var e=this;this.tokenizer.getContextRanges("arabicSentence").forEach(function(t){var r=e.tokenizer.getRangeTokens(t);e.tokenizer.replaceRange(t.startIndex,t.endOffset,r.reverse())})}function checkGlyphIndexStatus(){if(-1===this.tokenizer.registeredModifiers.indexOf("glyphIndex"))throw Error("glyphIndex modifier is required to apply arabic presentation features.")}function applyArabicPresentationForms(){var e=this;this.featuresTags.hasOwnProperty("arab")&&(checkGlyphIndexStatus.call(this),this.tokenizer.getContextRanges("arabicWord").forEach(function(t){arabicPresentationForms.call(e,t)}))}function applyArabicRequireLigatures(){var e=this,t="arab";this.featuresTags.hasOwnProperty(t)&&-1!==this.featuresTags[t].indexOf("rlig")&&(checkGlyphIndexStatus.call(this),this.tokenizer.getContextRanges("arabicWord").forEach(function(t){arabicRequiredLigatures.call(e,t)}))}function applyLatinLigatures(){var e=this,t="latn";this.featuresTags.hasOwnProperty(t)&&-1!==this.featuresTags[t].indexOf("liga")&&(checkGlyphIndexStatus.call(this),this.tokenizer.getContextRanges("latinWord").forEach(function(t){latinLigature.call(e,t)}))}function Font2(e){(e=e||{}).tables=e.tables||{},e.empty||(checkArgument(e.familyName,"When creating a new Font object, familyName is required."),checkArgument(e.styleName,"When creating a new Font object, styleName is required."),checkArgument(e.unitsPerEm,"When creating a new Font object, unitsPerEm is required."),checkArgument(e.ascender,"When creating a new Font object, ascender is required."),checkArgument(e.descender<=0,"When creating a new Font object, negative descender value is required."),this.names={fontFamily:{en:e.familyName||" "},fontSubfamily:{en:e.styleName||" "},fullName:{en:e.fullName||e.familyName+" "+e.styleName},postScriptName:{en:e.postScriptName||(e.familyName+e.styleName).replace(/\s/g,"")},designer:{en:e.designer||" "},designerURL:{en:e.designerURL||" "},manufacturer:{en:e.manufacturer||" "},manufacturerURL:{en:e.manufacturerURL||" "},license:{en:e.license||" "},licenseURL:{en:e.licenseURL||" "},version:{en:e.version||"Version 0.1"},description:{en:e.description||" "},copyright:{en:e.copyright||" "},trademark:{en:e.trademark||" "}},this.unitsPerEm=e.unitsPerEm||1e3,this.ascender=e.ascender,this.descender=e.descender,this.createdTimestamp=e.createdTimestamp,this.tables=Object.assign(e.tables,{os2:Object.assign({usWeightClass:e.weightClass||this.usWeightClasses.MEDIUM,usWidthClass:e.widthClass||this.usWidthClasses.MEDIUM,fsSelection:e.fsSelection||this.fsSelectionValues.REGULAR},e.tables.os2)})),this.supported=!0,this.glyphs=new O.GlyphSet(this,e.glyphs||[]),this.encoding=new DefaultEncoding(this),this.position=new Position(this),this.substitution=new Substitution(this),this.tables=this.tables||{},this._push=null,this._hmtxTableData={},Object.defineProperty(this,"hinting",{get:function(){return this._hinting?this._hinting:"truetype"===this.outlinesFormat?this._hinting=new Hinting(this):void 0}})}function addName(e,t){var r=JSON.stringify(e),i=256;for(var a in t){var n=parseInt(a);if(n&&!(n<256)){if(JSON.stringify(t[a])===r)return n;i<=n&&(i=n+1)}}return t[i]=e,i}function makeFvarAxis(e,t,r){var i=addName(t.name,r);return[{name:"tag_"+e,type:"TAG",value:t.tag},{name:"minValue_"+e,type:"FIXED",value:t.minValue<<16},{name:"defaultValue_"+e,type:"FIXED",value:t.defaultValue<<16},{name:"maxValue_"+e,type:"FIXED",value:t.maxValue<<16},{name:"flags_"+e,type:"USHORT",value:0},{name:"nameID_"+e,type:"USHORT",value:i}]}function parseFvarAxis(e,t,r){var i={},a=new C.Parser(e,t);return i.tag=a.parseTag(),i.minValue=a.parseFixed(),i.defaultValue=a.parseFixed(),i.maxValue=a.parseFixed(),a.skip("uShort",1),i.name=r[a.parseUShort()]||{},i}function makeFvarInstance(e,t,r,i){for(var a=[{name:"nameID_"+e,type:"USHORT",value:addName(t.name,i)},{name:"flags_"+e,type:"USHORT",value:0}],n=0;n<r.length;++n){var s=r[n].tag;a.push({name:"axis_"+e+" "+s,type:"FIXED",value:t.coordinates[s]<<16})}return a}function parseFvarInstance(e,t,r,i){var a={},n=new C.Parser(e,t);a.name=i[n.parseUShort()]||{},n.skip("uShort",1),a.coordinates={};for(var s=0;s<r.length;++s)a.coordinates[r[s].tag]=n.parseFixed();return a}Bidi.prototype.setText=function(e){this.text=e},Bidi.prototype.contextChecks={latinWordCheck:{startCheck:latinWordStartCheck,endCheck:latinWordEndCheck},arabicWordCheck:{startCheck:arabicWordStartCheck,endCheck:arabicWordEndCheck},arabicSentenceCheck:{startCheck:arabicSentenceStartCheck,endCheck:arabicSentenceEndCheck}},Bidi.prototype.registerFeatures=function(e,t){var r=this,i=t.filter(function(t){return r.query.supports({script:e,tag:t})});this.featuresTags.hasOwnProperty(e)?this.featuresTags[e]=this.featuresTags[e].concat(i):this.featuresTags[e]=i},Bidi.prototype.applyFeatures=function(e,t){if(!e)throw Error("No valid font was provided to apply features");this.query||(this.query=new FeatureQuery(e));for(var r=0;r<t.length;r++){var i=t[r];this.query.supports({script:i.script})&&this.registerFeatures(i.script,i.tags)}},Bidi.prototype.registerModifier=function(e,t,r){this.tokenizer.registerModifier(e,t,r)},Bidi.prototype.checkContextReady=function(e){return!!this.tokenizer.getContext(e)},Bidi.prototype.applyFeaturesToContexts=function(){this.checkContextReady("arabicWord")&&(applyArabicPresentationForms.call(this),applyArabicRequireLigatures.call(this)),this.checkContextReady("latinWord")&&applyLatinLigatures.call(this),this.checkContextReady("arabicSentence")&&reverseArabicSentences.call(this)},Bidi.prototype.processText=function(e){this.text&&this.text===e||(this.setText(e),tokenizeText.call(this),this.applyFeaturesToContexts())},Bidi.prototype.getBidiText=function(e){return this.processText(e),this.tokenizer.getText()},Bidi.prototype.getTextGlyphs=function(e){this.processText(e);for(var t=[],r=0;r<this.tokenizer.tokens.length;r++){var i=this.tokenizer.tokens[r];if(!i.state.deleted){var a=i.activeState.value;t.push(Array.isArray(a)?a[0]:a)}}return t},Font2.prototype.hasChar=function(e){return null!==this.encoding.charToGlyphIndex(e)},Font2.prototype.charToGlyphIndex=function(e){return this.encoding.charToGlyphIndex(e)},Font2.prototype.charToGlyph=function(e){var t=this.charToGlyphIndex(e),r=this.glyphs.get(t);return r||(r=this.glyphs.get(0)),r},Font2.prototype.updateFeatures=function(e){return this.defaultRenderOptions.features.map(function(t){return"latn"===t.script?{script:"latn",tags:t.tags.filter(function(t){return e[t]})}:t})},Font2.prototype.stringToGlyphs=function(e,t){var r=this,i=new Bidi;i.registerModifier("glyphIndex",null,function(e){return r.charToGlyphIndex(e.char)});var a=t?this.updateFeatures(t.features):this.defaultRenderOptions.features;i.applyFeatures(this,a);for(var n=i.getTextGlyphs(e),s=n.length,o=Array(s),l=this.glyphs.get(0),c=0;c<s;c+=1)o[c]=this.glyphs.get(n[c])||l;return o},Font2.prototype.nameToGlyphIndex=function(e){return this.glyphNames.nameToGlyphIndex(e)},Font2.prototype.nameToGlyph=function(e){var t=this.nameToGlyphIndex(e),r=this.glyphs.get(t);return r||(r=this.glyphs.get(0)),r},Font2.prototype.glyphIndexToName=function(e){return this.glyphNames.glyphIndexToName?this.glyphNames.glyphIndexToName(e):""},Font2.prototype.getKerningValue=function(e,t){e=e.index||e,t=t.index||t;var r=this.position.defaultKerningTables;return r?this.position.getKerningValue(r,e,t):this.kerningPairs[e+","+t]||0},Font2.prototype.defaultRenderOptions={kerning:!0,features:[{script:"arab",tags:["init","medi","fina","rlig"]},{script:"latn",tags:["liga","rlig"]}]},Font2.prototype.forEachGlyph=function(e,t,r,i,a,n){t=void 0!==t?t:0,r=void 0!==r?r:0,i=void 0!==i?i:72,a=Object.assign({},this.defaultRenderOptions,a);var s,o=1/this.unitsPerEm*i,l=this.stringToGlyphs(e,a);if(a.kerning){var c=a.script||this.position.getDefaultScriptName();s=this.position.getKerningTables(c,a.language)}for(var u=0;u<l.length;u+=1){var h=l[u];n.call(this,h,t,r,i,a),h.advanceWidth&&(t+=h.advanceWidth*o),a.kerning&&u<l.length-1&&(t+=(s?this.position.getKerningValue(s,h.index,l[u+1].index):this.getKerningValue(h,l[u+1]))*o),a.letterSpacing?t+=a.letterSpacing*i:a.tracking&&(t+=a.tracking/1e3*i)}return t},Font2.prototype.getPath=function(e,t,r,i,a){var n=new Path2;return this.forEachGlyph(e,t,r,i,a,function(e,t,r,i){var s=e.getPath(t,r,i,a,this);n.extend(s)}),n},Font2.prototype.getPaths=function(e,t,r,i,a){var n=[];return this.forEachGlyph(e,t,r,i,a,function(e,t,r,i){var s=e.getPath(t,r,i,a,this);n.push(s)}),n},Font2.prototype.getAdvanceWidth=function(e,t,r){return this.forEachGlyph(e,0,0,t,r,function(){})},Font2.prototype.draw=function(e,t,r,i,a,n){this.getPath(t,r,i,a,n).draw(e)},Font2.prototype.drawPoints=function(e,t,r,i,a,n){this.forEachGlyph(t,r,i,a,n,function(t,r,i,a){t.drawPoints(e,r,i,a)})},Font2.prototype.drawMetrics=function(e,t,r,i,a,n){this.forEachGlyph(t,r,i,a,n,function(t,r,i,a){t.drawMetrics(e,r,i,a)})},Font2.prototype.getEnglishName=function(e){var t=this.names[e];if(t)return t.en},Font2.prototype.validate=function(){var e=this;function assertNamePresent(t){var r=e.getEnglishName(t);r&&r.trim().length}assertNamePresent("fontFamily"),assertNamePresent("weightName"),assertNamePresent("manufacturer"),assertNamePresent("copyright"),assertNamePresent("version"),this.unitsPerEm},Font2.prototype.toTables=function(){return ea.fontToTable(this)},Font2.prototype.toBuffer=function(){return console.warn("Font.toBuffer is deprecated. Use Font.toArrayBuffer instead."),this.toArrayBuffer()},Font2.prototype.toArrayBuffer=function(){for(var e=this.toTables().encode(),t=new ArrayBuffer(e.length),r=new Uint8Array(t),i=0;i<e.length;i++)r[i]=e[i];return t},Font2.prototype.fsSelectionValues={ITALIC:1,UNDERSCORE:2,NEGATIVE:4,OUTLINED:8,STRIKEOUT:16,BOLD:32,REGULAR:64,USER_TYPO_METRICS:128,WWS:256,OBLIQUE:512},Font2.prototype.usWidthClasses={ULTRA_CONDENSED:1,EXTRA_CONDENSED:2,CONDENSED:3,SEMI_CONDENSED:4,MEDIUM:5,SEMI_EXPANDED:6,EXPANDED:7,EXTRA_EXPANDED:8,ULTRA_EXPANDED:9},Font2.prototype.usWeightClasses={THIN:100,EXTRA_LIGHT:200,LIGHT:300,NORMAL:400,MEDIUM:500,SEMI_BOLD:600,BOLD:700,EXTRA_BOLD:800,BLACK:900};var eh={make:function(e,t){var r=new E.Table("fvar",[{name:"version",type:"ULONG",value:65536},{name:"offsetToData",type:"USHORT",value:0},{name:"countSizePairs",type:"USHORT",value:2},{name:"axisCount",type:"USHORT",value:e.axes.length},{name:"axisSize",type:"USHORT",value:20},{name:"instanceCount",type:"USHORT",value:e.instances.length},{name:"instanceSize",type:"USHORT",value:4+4*e.axes.length}]);r.offsetToData=r.sizeOf();for(var i=0;i<e.axes.length;i++)r.fields=r.fields.concat(makeFvarAxis(i,e.axes[i],t));for(var a=0;a<e.instances.length;a++)r.fields=r.fields.concat(makeFvarInstance(a,e.instances[a],e.axes,t));return r},parse:function(e,t,r){var i=new C.Parser(e,t),a=i.parseULong();g.argument(65536===a,"Unsupported fvar table version.");var n=i.parseOffset16();i.skip("uShort",1);for(var s=i.parseUShort(),o=i.parseUShort(),l=i.parseUShort(),c=i.parseUShort(),u=[],h=0;h<s;h++)u.push(parseFvarAxis(e,t+n+h*o,r));for(var p=[],d=t+n+s*o,f=0;f<l;f++)p.push(parseFvarInstance(e,d+f*c,u,r));return{axes:u,instances:p}}},attachList=function(){return{coverage:this.parsePointer(Parser2.coverage),attachPoints:this.parseList(Parser2.pointer(Parser2.uShortList))}},caretValue=function(){var e=this.parseUShort();return(g.argument(1===e||2===e||3===e,"Unsupported CaretValue table version."),1===e)?{coordinate:this.parseShort()}:2===e?{pointindex:this.parseShort()}:3===e?{coordinate:this.parseShort()}:void 0},ligGlyph=function(){return this.parseList(Parser2.pointer(caretValue))},ligCaretList=function(){return{coverage:this.parsePointer(Parser2.coverage),ligGlyphs:this.parseList(Parser2.pointer(ligGlyph))}},markGlyphSets=function(){return this.parseUShort(),this.parseList(Parser2.pointer(Parser2.coverage))},ep={parse:function(e,t){var r=new Parser2(e,t=t||0),i=r.parseVersion(1);g.argument(1===i||1.2===i||1.3===i,"Unsupported GDEF table version.");var a={version:i,classDef:r.parsePointer(Parser2.classDef),attachList:r.parsePointer(attachList),ligCaretList:r.parsePointer(ligCaretList),markAttachClassDef:r.parsePointer(Parser2.classDef)};return i>=1.2&&(a.markGlyphSets=r.parsePointer(markGlyphSets)),a}},ed=Array(10);function parseGposTable(e,t){var r=new Parser2(e,t=t||0),i=r.parseVersion(1);return(g.argument(1===i||1.1===i,"Unsupported GPOS table version "+i),1===i)?{version:i,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(ed)}:{version:i,scripts:r.parseScriptList(),features:r.parseFeatureList(),lookups:r.parseLookupList(ed),variations:r.parseFeatureVariationsList()}}ed[1]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();return 1===t?{posFormat:1,coverage:this.parsePointer(Parser2.coverage),value:this.parseValueRecord()}:2===t?{posFormat:2,coverage:this.parsePointer(Parser2.coverage),values:this.parseValueRecordList()}:void g.assert(!1,"0x"+e.toString(16)+": GPOS lookup type 1 format must be 1 or 2.")},ed[2]=function(){var e=this.offset+this.relativeOffset,t=this.parseUShort();g.assert(1===t||2===t,"0x"+e.toString(16)+": GPOS lookup type 2 format must be 1 or 2.");var r=this.parsePointer(Parser2.coverage),i=this.parseUShort(),a=this.parseUShort();if(1===t)return{posFormat:t,coverage:r,valueFormat1:i,valueFormat2:a,pairSets:this.parseList(Parser2.pointer(Parser2.list(function(){return{secondGlyph:this.parseUShort(),value1:this.parseValueRecord(i),value2:this.parseValueRecord(a)}})))};if(2===t){var n=this.parsePointer(Parser2.classDef),s=this.parsePointer(Parser2.classDef),o=this.parseUShort(),l=this.parseUShort();return{posFormat:t,coverage:r,valueFormat1:i,valueFormat2:a,classDef1:n,classDef2:s,class1Count:o,class2Count:l,classRecords:this.parseList(o,Parser2.list(l,function(){return{value1:this.parseValueRecord(i),value2:this.parseValueRecord(a)}}))}}},ed[3]=function(){return{error:"GPOS Lookup 3 not supported"}},ed[4]=function(){return{error:"GPOS Lookup 4 not supported"}},ed[5]=function(){return{error:"GPOS Lookup 5 not supported"}},ed[6]=function(){return{error:"GPOS Lookup 6 not supported"}},ed[7]=function(){return{error:"GPOS Lookup 7 not supported"}},ed[8]=function(){return{error:"GPOS Lookup 8 not supported"}},ed[9]=function(){return{error:"GPOS Lookup 9 not supported"}};var ef=Array(10),em={parse:parseGposTable,make:function(e){return new E.Table("GPOS",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new E.ScriptList(e.scripts)},{name:"features",type:"TABLE",value:new E.FeatureList(e.features)},{name:"lookups",type:"TABLE",value:new E.LookupList(e.lookups,ef)}])}};function parseWindowsKernTable(e){var t={};e.skip("uShort");var r=e.parseUShort();g.argument(0===r,"Unsupported kern sub-table version."),e.skip("uShort",2);var i=e.parseUShort();e.skip("uShort",3);for(var a=0;a<i;a+=1){var n=e.parseUShort(),s=e.parseUShort(),o=e.parseShort();t[n+","+s]=o}return t}function parseMacKernTable(e){var t={};e.skip("uShort"),e.parseULong()>1&&console.warn("Only the first kern subtable is supported."),e.skip("uLong");var r=e.parseUShort();if(e.skip("uShort"),0==(255&r)){var i=e.parseUShort();e.skip("uShort",3);for(var a=0;a<i;a+=1){var n=e.parseUShort(),s=e.parseUShort(),o=e.parseShort();t[n+","+s]=o}}return t}var eg={parse:function(e,t){var r=new C.Parser(e,t),i=r.parseUShort();if(0===i)return parseWindowsKernTable(r);if(1===i)return parseMacKernTable(r);throw Error("Unsupported kern table version ("+i+").")}},ev={parse:function(e,t,r,i){for(var a=new C.Parser(e,t),n=i?a.parseUShort:a.parseULong,s=[],o=0;o<r+1;o+=1){var l=n.call(a);i&&(l*=2),s.push(l)}return s}};function parseOpenTypeTableEntries(e,t){for(var r=[],i=12,a=0;a<t;a+=1){var n=C.getTag(e,i),s=C.getULong(e,i+4),o=C.getULong(e,i+8),l=C.getULong(e,i+12);r.push({tag:n,checksum:s,offset:o,length:l,compression:!1}),i+=16}return r}function parseWOFFTableEntries(e,t){for(var r=[],i=44,a=0;a<t;a+=1){var n=C.getTag(e,i),s=C.getULong(e,i+4),o=C.getULong(e,i+8),l=C.getULong(e,i+12),c=void 0;c=o<l&&"WOFF",r.push({tag:n,offset:s,compression:c,compressedLength:o,length:l}),i+=20}return r}function uncompressTable(e,t){if("WOFF"!==t.compression)return{data:e,offset:t.offset};var r=new Uint8Array(e.buffer,t.offset+2,t.compressedLength-2),i=new Uint8Array(t.length);if(m(r,i),i.byteLength!==t.length)throw Error("Decompression error: "+t.tag+" decompressed length doesn't match recorded length");return{data:new DataView(i.buffer,0),offset:0}}return{parseBuffer:function(e,t){t=null==t?{}:t;var r,i,a,n,s,o,l,c,u,h,p,d,f,m,g,v=new Font2({empty:!0}),y=new DataView(e,0),x=[],b=C.getTag(y,0);if(b===String.fromCharCode(0,1,0,0)||"true"===b||"typ1"===b)v.outlinesFormat="truetype",a=C.getUShort(y,4),x=parseOpenTypeTableEntries(y,a);else if("OTTO"===b)v.outlinesFormat="cff",a=C.getUShort(y,4),x=parseOpenTypeTableEntries(y,a);else if("wOFF"===b){var T=C.getTag(y,4);if(T===String.fromCharCode(0,1,0,0))v.outlinesFormat="truetype";else if("OTTO"===T)v.outlinesFormat="cff";else throw Error("Unsupported OpenType flavor "+b);a=C.getUShort(y,12),x=parseWOFFTableEntries(y,a)}else throw Error("Unsupported OpenType signature "+b);for(var S=0;S<a;S+=1){var E=x[S],R=void 0;switch(E.tag){case"cmap":R=uncompressTable(y,E),v.tables.cmap=M.parse(R.data,R.offset),v.encoding=new CmapEncoding(v.tables.cmap);break;case"cvt ":R=uncompressTable(y,E),g=new C.Parser(R.data,R.offset),v.tables.cvt=g.parseShortList(E.length/2);break;case"fvar":s=E;break;case"fpgm":R=uncompressTable(y,E),g=new C.Parser(R.data,R.offset),v.tables.fpgm=g.parseByteList(E.length);break;case"head":R=uncompressTable(y,E),v.tables.head=D.parse(R.data,R.offset),v.unitsPerEm=v.tables.head.unitsPerEm,r=v.tables.head.indexToLocFormat;break;case"hhea":R=uncompressTable(y,E),v.tables.hhea=U.parse(R.data,R.offset),v.ascender=v.tables.hhea.ascender,v.descender=v.tables.hhea.descender,v.numberOfHMetrics=v.tables.hhea.numberOfHMetrics;break;case"hmtx":h=E;break;case"ltag":R=uncompressTable(y,E),i=V.parse(R.data,R.offset);break;case"maxp":R=uncompressTable(y,E),v.tables.maxp=G.parse(R.data,R.offset),v.numGlyphs=v.tables.maxp.numGlyphs;break;case"name":f=E;break;case"OS/2":R=uncompressTable(y,E),v.tables.os2=$.parse(R.data,R.offset);break;case"post":R=uncompressTable(y,E),v.tables.post=Q.parse(R.data,R.offset),v.glyphNames=new GlyphNames(v.tables.post);break;case"prep":R=uncompressTable(y,E),g=new C.Parser(R.data,R.offset),v.tables.prep=g.parseByteList(E.length);break;case"glyf":o=E;break;case"loca":d=E;break;case"CFF ":n=E;break;case"kern":p=E;break;case"GDEF":l=E;break;case"GPOS":c=E;break;case"GSUB":u=E;break;case"meta":m=E}}var A=uncompressTable(y,f);if(v.tables.name=Y.parse(A.data,A.offset,i),v.names=v.tables.name,o&&d){var P=0===r,w=uncompressTable(y,d),I=ev.parse(w.data,w.offset,v.numGlyphs,P),k=uncompressTable(y,o);v.glyphs=en.parse(k.data,k.offset,I,v,t)}else if(n){var _=uncompressTable(y,n);F.parse(_.data,_.offset,v,t)}else throw Error("Font doesn't contain TrueType or CFF outlines.");var O=uncompressTable(y,h);if(B.parse(v,O.data,O.offset,v.numberOfHMetrics,v.numGlyphs,v.glyphs,t),addGlyphNames(v,t),p){var N=uncompressTable(y,p);v.kerningPairs=eg.parse(N.data,N.offset)}else v.kerningPairs={};if(l){var L=uncompressTable(y,l);v.tables.gdef=ep.parse(L.data,L.offset)}if(c){var z=uncompressTable(y,c);v.tables.gpos=em.parse(z.data,z.offset),v.position.init()}if(u){var H=uncompressTable(y,u);v.tables.gsub=er.parse(H.data,H.offset)}if(s){var j=uncompressTable(y,s);v.tables.fvar=eh.parse(j.data,j.offset,v.names)}if(m){var W=uncompressTable(y,m);v.tables.meta=ei.parse(W.data,W.offset),v.metas=v.tables.meta}return v}}})(),tb=new WeakMap,tT=class extends d.Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.workerConfig=null}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerLimit=e,this}detectSupport(e){return this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}load(e,t,r,i){let a=new d.FileLoader(this.manager);a.setResponseType("arraybuffer"),a.setWithCredentials(this.withCredentials);let n=new d.CompressedTexture;return a.load(e,e=>{if(tb.has(e)){let r=tb.get(e);return r.promise.then(t).catch(i)}this._createTexture([e]).then(function(e){n.copy(e),n.needsUpdate=!0,t&&t(n)}).catch(i)},r,i),n}parseInternalAsync(e){let{levels:t}=e,r=new Set;for(let e=0;e<t.length;e++)r.add(t[e].data.buffer);return this._createTexture(Array.from(r),{...e,lowLevel:!0})}_createTexture(e,t={}){let r,i;let a=0;for(let t=0;t<e.length;t++)a+=e[t].byteLength;let n=this._allocateWorker(a).then(a=>(r=a,i=this.workerNextTaskID++,new Promise((a,n)=>{r._callbacks[i]={resolve:a,reject:n},r.postMessage({type:"transcode",id:i,buffers:e,taskConfig:t},e)}))).then(e=>{let{mipmaps:t,width:r,height:i,format:a}=e,n=new d.CompressedTexture(t,r,i,a,d.UnsignedByteType);return n.minFilter=1===t.length?d.LinearFilter:d.LinearMipmapLinearFilter,n.magFilter=d.LinearFilter,n.generateMipmaps=!1,n.needsUpdate=!0,n});return n.catch(()=>!0).then(()=>{r&&i&&(r._taskLoad-=a,delete r._callbacks[i])}),tb.set(e[0],{promise:n}),n}_initTranscoder(){if(!this.transcoderPending){let e=new d.FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);let t=new Promise((t,r)=>{e.load("basis_transcoder.js",t,void 0,r)}),r=new d.FileLoader(this.manager);r.setPath(this.transcoderPath),r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials);let i=new Promise((e,t)=>{r.load("basis_transcoder.wasm",e,void 0,t)});this.transcoderPending=Promise.all([t,i]).then(([e,t])=>{let r=tT.BasisWorker.toString(),i=["/* constants */","let _EngineFormat = "+JSON.stringify(tT.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(tT.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(tT.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i])),this.transcoderBinary=t})}return this.transcoderPending}_allocateWorker(e){return this._initTranscoder().then(()=>{if(this.workerPool.length<this.workerLimit){let e=new Worker(this.workerSourceURL);e._callbacks={},e._taskLoad=0,e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:this.transcoderBinary}),e.onmessage=function(t){let r=t.data;switch(r.type){case"transcode":e._callbacks[r.id].resolve(r);break;case"error":e._callbacks[r.id].reject(r);break;default:console.error('THREE.BasisTextureLoader: Unexpected message, "'+r.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort(function(e,t){return e._taskLoad>t._taskLoad?-1:1});let t=this.workerPool[this.workerPool.length-1];return t._taskLoad+=e,t})}dispose(){for(let e=0;e<this.workerPool.length;e++)this.workerPool[e].terminate();return this.workerPool.length=0,this}};__publicField(tT,"BasisFormat",{ETC1S:0,UASTC_4x4:1}),__publicField(tT,"TranscoderFormat",{ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16}),__publicField(tT,"EngineFormat",{RGBAFormat:d.RGBAFormat,RGBA_ASTC_4x4_Format:d.RGBA_ASTC_4x4_Format,RGBA_BPTC_Format:d.RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:d.RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:d.RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:d.RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:d.RGB_ETC1_Format,RGB_ETC2_Format:d.RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:d.RGB_PVRTC_4BPPV1_Format,RGB_S3TC_DXT1_Format:d.RGB_S3TC_DXT1_Format}),__publicField(tT,"BasisWorker",function(){let e,t,r;let i=_EngineFormat,a=_TranscoderFormat,n=_BasisFormat;function init2(e){t=new Promise(t=>{r={wasmBinary:e,onRuntimeInitialized:t},BASIS(r)}).then(()=>{r.initializeBasis()})}function transcodeLowLevel(e){let{basisFormat:t,width:i,height:a,hasAlpha:s}=e,{transcoderFormat:o,engineFormat:l}=getTranscoderFormat(t,i,a,s),c=r.getBytesPerBlockOrPixel(o);assert(r.isFormatSupported(o),"THREE.BasisTextureLoader: Unsupported format.");let u=[];if(t===n.ETC1S){let t=new r.LowLevelETC1SImageTranscoder,{endpointCount:i,endpointsData:a,selectorCount:n,selectorsData:l,tablesData:h}=e.globalData;try{let r;r=t.decodePalettes(i,a,n,l),assert(r,"THREE.BasisTextureLoader: decodePalettes() failed."),r=t.decodeTables(h),assert(r,"THREE.BasisTextureLoader: decodeTables() failed.");for(let i=0;i<e.levels.length;i++){let a=e.levels[i],n=e.globalData.imageDescs[i],l=getTranscodedImageByteLength(o,a.width,a.height),h=new Uint8Array(l);r=t.transcodeImage(o,h,l/c,a.data,getWidthInBlocks(o,a.width),getHeightInBlocks(o,a.height),a.width,a.height,a.index,n.rgbSliceByteOffset,n.rgbSliceByteLength,n.alphaSliceByteOffset,n.alphaSliceByteLength,n.imageFlags,s,!1,0,0),assert(r,"THREE.BasisTextureLoader: transcodeImage() failed for level "+a.index+"."),u.push({data:h,width:a.width,height:a.height})}}finally{t.delete()}}else for(let t=0;t<e.levels.length;t++){let i=e.levels[t],a=getTranscodedImageByteLength(o,i.width,i.height),n=new Uint8Array(a),l=r.transcodeUASTCImage(o,n,a/c,i.data,getWidthInBlocks(o,i.width),getHeightInBlocks(o,i.height),i.width,i.height,i.index,0,i.data.byteLength,0,s,!1,0,0,-1,-1);assert(l,"THREE.BasisTextureLoader: transcodeUASTCImage() failed for level "+i.index+"."),u.push({data:n,width:i.width,height:i.height})}return{width:i,height:a,hasAlpha:s,mipmaps:u,format:l}}function transcode(e){let t=new r.BasisFile(new Uint8Array(e)),i=t.isUASTC()?n.UASTC_4x4:n.ETC1S,a=t.getImageWidth(0,0),s=t.getImageHeight(0,0),o=t.getNumLevels(0),l=t.getHasAlpha();function cleanup(){t.close(),t.delete()}let{transcoderFormat:c,engineFormat:u}=getTranscoderFormat(i,a,s,l);if(!a||!s||!o)throw cleanup(),Error("THREE.BasisTextureLoader:	Invalid texture");if(!t.startTranscoding())throw cleanup(),Error("THREE.BasisTextureLoader: .startTranscoding failed");let h=[];for(let e=0;e<o;e++){let r=t.getImageWidth(0,e),i=t.getImageHeight(0,e),a=new Uint8Array(t.getImageTranscodedSizeInBytes(0,e,c)),n=t.transcodeImage(a,0,e,c,0,l);if(!n)throw cleanup(),Error("THREE.BasisTextureLoader: .transcodeImage failed.");h.push({data:a,width:r,height:i})}return cleanup(),{width:a,height:s,hasAlpha:l,mipmaps:h,format:u}}onmessage=function(r){let i=r.data;switch(i.type){case"init":e=i.config,init2(i.transcoderBinary);break;case"transcode":t.then(()=>{try{let{width:e,height:t,hasAlpha:r,mipmaps:a,format:n}=i.taskConfig.lowLevel?transcodeLowLevel(i.taskConfig):transcode(i.buffers[0]),s=[];for(let e=0;e<a.length;++e)s.push(a[e].data.buffer);self.postMessage({type:"transcode",id:i.id,width:e,height:t,hasAlpha:r,mipmaps:a,format:n},s)}catch(e){console.error(e),self.postMessage({type:"error",id:i.id,error:e.message})}})}};let s=[{if:"astcSupported",basisFormat:[n.UASTC_4x4],transcoderFormat:[a.ASTC_4x4,a.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.BC7_M5,a.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.BC1,a.BC3],engineFormat:[i.RGB_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.ETC1,a.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.ETC1,a.ETC1],engineFormat:[i.RGB_ETC1_Format,i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[n.ETC1S,n.UASTC_4x4],transcoderFormat:[a.PVRTC1_4_RGB,a.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],o=s.sort(function(e,t){return e.priorityETC1S-t.priorityETC1S}),l=s.sort(function(e,t){return e.priorityUASTC-t.priorityUASTC});function getTranscoderFormat(t,r,s,c){let u;let h=t===n.ETC1S?o:l;for(let i=0;i<h.length;i++){let a=h[i];if(e[a.if]&&a.basisFormat.includes(t)&&(!a.needsPowerOfTwo||isPowerOfTwo(r)&&isPowerOfTwo(s)))return{transcoderFormat:a.transcoderFormat[c?1:0],engineFormat:a.engineFormat[c?1:0]}}return console.warn("THREE.BasisTextureLoader: No suitable compressed texture format found. Decoding to RGBA32."),{transcoderFormat:a.RGBA32,engineFormat:i.RGBAFormat}}function assert(e,t){if(!e)throw Error(t)}function getWidthInBlocks(e,t){return Math.ceil(t/r.getFormatBlockWidth(e))}function getHeightInBlocks(e,t){return Math.ceil(t/r.getFormatBlockHeight(e))}function getTranscodedImageByteLength(e,t,i){let n=r.getBytesPerBlockOrPixel(e);if(r.formatIsUncompressed(e))return t*i*n;if(e===a.PVRTC1_4_RGB||e===a.PVRTC1_4_RGBA){let e=t+3&-4,r=i+3&-4;return(Math.max(8,e)*Math.max(8,r)*4+7)/8}return getWidthInBlocks(e,t)*getHeightInBlocks(e,i)*n}function isPowerOfTwo(e){return e<=2||(e&e-1)==0&&0!==e}});let tS=new d.Vector3,tE=new d.Vector3;let ConditionalLineSegments=class ConditionalLineSegments extends null{constructor(e,t){super(e,t),this.isConditionalLine=!0}};let tR=new d.Ray;let LineParser=class LineParser{constructor(e,t){this.line=e,this.lineLength=e.length,this.currentCharIndex=0,this.currentChar=" ",this.lineNumber=t}seekNonSpace(){for(;this.currentCharIndex<this.lineLength;){if(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"	"!==this.currentChar)return;this.currentCharIndex++}}getToken(){let e=this.currentCharIndex++;for(;this.currentCharIndex<this.lineLength&&(this.currentChar=this.line.charAt(this.currentCharIndex)," "!==this.currentChar&&"	"!==this.currentChar);)this.currentCharIndex++;let t=this.currentCharIndex;return this.seekNonSpace(),this.line.substring(e,t)}getVector(){return new Vector3(parseFloat(this.getToken()),parseFloat(this.getToken()),parseFloat(this.getToken()))}getRemainingString(){return this.line.substring(this.currentCharIndex,this.lineLength)}isAtTheEnd(){return this.currentCharIndex>=this.lineLength}setToEnd(){this.currentCharIndex=this.lineLength}getLineNumberString(){return this.lineNumber>=0?" at line "+this.lineNumber:""}};function sortByMaterial(e,t){return e.colorCode===t.colorCode?0:e.colorCode<t.colorCode?-1:1}let SVGLoader=class SVGLoader extends null{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,r,i){let a=this,n=new FileLoader(a.manager);n.setPath(a.path),n.setRequestHeader(a.requestHeader),n.setWithCredentials(a.withCredentials),n.load(e,function(r){try{t(a.parse(r))}catch(t){i?i(t):console.error(t),a.manager.itemError(e)}},r,i)}parse(e){let t=this;function parseNode(e,t){if(1!==e.nodeType)return;let r=getNodeTransform(e),i=!0,n=null;switch(e.nodeName){case"svg":break;case"style":parseCSSStylesheet(e);break;case"g":t=parseStyle(e,t);break;case"path":t=parseStyle(e,t),e.hasAttribute("d")&&(n=parsePathNode(e));break;case"rect":t=parseStyle(e,t),n=parseRectNode(e);break;case"polygon":t=parseStyle(e,t),n=parsePolygonNode(e);break;case"polyline":t=parseStyle(e,t),n=parsePolylineNode(e);break;case"circle":t=parseStyle(e,t),n=parseCircleNode(e);break;case"ellipse":t=parseStyle(e,t),n=parseEllipseNode(e);break;case"line":t=parseStyle(e,t),n=parseLineNode(e);break;case"defs":case"mask":i=!1;break;case"use":t=parseStyle(e,t);let o=e.href.baseVal.substring(1),l=e.viewportElement.getElementById(o);l?parseNode(l,t):console.warn("SVGLoader: 'use node' references non-existent node id: "+o)}if(n&&(void 0!==t.fill&&"none"!==t.fill&&n.color.setStyle(t.fill),transformPath(n,d),a.push(n),n.userData={node:e,style:t}),i){let r=e.childNodes;for(let e=0;e<r.length;e++)parseNode(r[e],t)}r&&(s.pop(),s.length>0?d.copy(s[s.length-1]):d.identity())}function parsePathNode(e){let t=new ShapePath,r=new Vector2,i=new Vector2,a=new Vector2,n=!0,s=!1,o=e.getAttribute("d"),l=o.match(/[a-df-z][^a-df-z]*/gi);for(let e=0,o=l.length;e<o;e++){var c,u,h,p,d,f,m,g,v,y,x,b,T,S,E,R;let o;let A=l[e],C=A.charAt(0),M=A.substr(1).trim();switch(!0===n&&(s=!0,n=!1),C){case"M":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=2)r.x=o[e+0],r.y=o[e+1],i.x=r.x,i.y=r.y,0===e?t.moveTo(r.x,r.y):t.lineTo(r.x,r.y),0===e&&a.copy(r);break;case"H":o=parseFloats(M);for(let e=0,n=o.length;e<n;e++)r.x=o[e],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===s&&a.copy(r);break;case"V":o=parseFloats(M);for(let e=0,n=o.length;e<n;e++)r.y=o[e],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===s&&a.copy(r);break;case"L":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=2)r.x=o[e+0],r.y=o[e+1],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===s&&a.copy(r);break;case"C":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=6)t.bezierCurveTo(o[e+0],o[e+1],o[e+2],o[e+3],o[e+4],o[e+5]),i.x=o[e+2],i.y=o[e+3],r.x=o[e+4],r.y=o[e+5],0===e&&!0===s&&a.copy(r);break;case"S":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=4)t.bezierCurveTo((c=r.x)-(i.x-c),(h=r.y)-(i.y-h),o[e+0],o[e+1],o[e+2],o[e+3]),i.x=o[e+0],i.y=o[e+1],r.x=o[e+2],r.y=o[e+3],0===e&&!0===s&&a.copy(r);break;case"Q":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=4)t.quadraticCurveTo(o[e+0],o[e+1],o[e+2],o[e+3]),i.x=o[e+0],i.y=o[e+1],r.x=o[e+2],r.y=o[e+3],0===e&&!0===s&&a.copy(r);break;case"T":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=2){let n=(d=r.x)-(i.x-d),l=(m=r.y)-(i.y-m);t.quadraticCurveTo(n,l,o[e+0],o[e+1]),i.x=n,i.y=l,r.x=o[e+0],r.y=o[e+1],0===e&&!0===s&&a.copy(r)}break;case"A":o=parseFloats(M,[3,4],7);for(let e=0,n=o.length;e<n;e+=7){if(o[e+5]==r.x&&o[e+6]==r.y)continue;let n=r.clone();r.x=o[e+5],r.y=o[e+6],i.x=r.x,i.y=r.y,parseArcCommand(t,o[e],o[e+1],o[e+2],o[e+3],o[e+4],n,r),0===e&&!0===s&&a.copy(r)}break;case"m":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=2)r.x+=o[e+0],r.y+=o[e+1],i.x=r.x,i.y=r.y,0===e?t.moveTo(r.x,r.y):t.lineTo(r.x,r.y),0===e&&a.copy(r);break;case"h":o=parseFloats(M);for(let e=0,n=o.length;e<n;e++)r.x+=o[e],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===s&&a.copy(r);break;case"v":o=parseFloats(M);for(let e=0,n=o.length;e<n;e++)r.y+=o[e],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===s&&a.copy(r);break;case"l":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=2)r.x+=o[e+0],r.y+=o[e+1],i.x=r.x,i.y=r.y,t.lineTo(r.x,r.y),0===e&&!0===s&&a.copy(r);break;case"c":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=6)t.bezierCurveTo(r.x+o[e+0],r.y+o[e+1],r.x+o[e+2],r.y+o[e+3],r.x+o[e+4],r.y+o[e+5]),i.x=r.x+o[e+2],i.y=r.y+o[e+3],r.x+=o[e+4],r.y+=o[e+5],0===e&&!0===s&&a.copy(r);break;case"s":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=4)t.bezierCurveTo((v=r.x)-(i.x-v),(x=r.y)-(i.y-x),r.x+o[e+0],r.y+o[e+1],r.x+o[e+2],r.y+o[e+3]),i.x=r.x+o[e+0],i.y=r.y+o[e+1],r.x+=o[e+2],r.y+=o[e+3],0===e&&!0===s&&a.copy(r);break;case"q":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=4)t.quadraticCurveTo(r.x+o[e+0],r.y+o[e+1],r.x+o[e+2],r.y+o[e+3]),i.x=r.x+o[e+0],i.y=r.y+o[e+1],r.x+=o[e+2],r.y+=o[e+3],0===e&&!0===s&&a.copy(r);break;case"t":o=parseFloats(M);for(let e=0,n=o.length;e<n;e+=2){let n=(T=r.x)-(i.x-T),l=(E=r.y)-(i.y-E);t.quadraticCurveTo(n,l,r.x+o[e+0],r.y+o[e+1]),i.x=n,i.y=l,r.x=r.x+o[e+0],r.y=r.y+o[e+1],0===e&&!0===s&&a.copy(r)}break;case"a":o=parseFloats(M,[3,4],7);for(let e=0,n=o.length;e<n;e+=7){if(0==o[e+5]&&0==o[e+6])continue;let n=r.clone();r.x+=o[e+5],r.y+=o[e+6],i.x=r.x,i.y=r.y,parseArcCommand(t,o[e],o[e+1],o[e+2],o[e+3],o[e+4],n,r),0===e&&!0===s&&a.copy(r)}break;case"Z":case"z":t.currentPath.autoClose=!0,t.currentPath.curves.length>0&&(r.copy(a),t.currentPath.currentPoint.copy(r),n=!0);break;default:console.warn(A)}s=!1}return t}function parseCSSStylesheet(e){if(e.sheet&&e.sheet.cssRules&&e.sheet.cssRules.length)for(let t=0;t<e.sheet.cssRules.length;t++){let r=e.sheet.cssRules[t];if(1!==r.type)continue;let i=r.selectorText.split(/,/gm).filter(Boolean).map(e=>e.trim());for(let e=0;e<i.length;e++)n[i[e]]=Object.assign(n[i[e]]||{},r.style)}}function parseArcCommand(e,t,r,i,a,n,s,o){if(0==t||0==r){e.lineTo(o.x,o.y);return}i=i*Math.PI/180,t=Math.abs(t),r=Math.abs(r);let l=(s.x-o.x)/2,c=(s.y-o.y)/2,u=Math.cos(i)*l+Math.sin(i)*c,h=-Math.sin(i)*l+Math.cos(i)*c,p=t*t,d=r*r,f=u*u,m=h*h,g=f/p+m/d;if(g>1){let e=Math.sqrt(g);t*=e,r*=e,p=t*t,d=r*r}let v=p*m+d*f,y=(p*d-v)/v,x=Math.sqrt(Math.max(0,y));a===n&&(x=-x);let b=x*t*h/r,T=-x*r*u/t,S=Math.cos(i)*b-Math.sin(i)*T+(s.x+o.x)/2,E=Math.sin(i)*b+Math.cos(i)*T+(s.y+o.y)/2,R=svgAngle(1,0,(u-b)/t,(h-T)/r),A=svgAngle((u-b)/t,(h-T)/r,(-u-b)/t,(-h-T)/r)%(2*Math.PI);e.currentPath.absellipse(S,E,t,r,R,R+A,0===n,i)}function svgAngle(e,t,r,i){let a=Math.acos(Math.max(-1,Math.min(1,(e*r+t*i)/(Math.sqrt(e*e+t*t)*Math.sqrt(r*r+i*i)))));return e*i-t*r<0&&(a=-a),a}function parseRectNode(e){let t=parseFloatWithUnits(e.getAttribute("x")||0),r=parseFloatWithUnits(e.getAttribute("y")||0),i=parseFloatWithUnits(e.getAttribute("rx")||e.getAttribute("ry")||0),a=parseFloatWithUnits(e.getAttribute("ry")||e.getAttribute("rx")||0),n=parseFloatWithUnits(e.getAttribute("width")),s=parseFloatWithUnits(e.getAttribute("height")),o=new ShapePath;return o.moveTo(t+i,r),o.lineTo(t+n-i,r),(0!==i||0!==a)&&o.bezierCurveTo(t+n-.448084975506*i,r,t+n,r+.448084975506*a,t+n,r+a),o.lineTo(t+n,r+s-a),(0!==i||0!==a)&&o.bezierCurveTo(t+n,r+s-.448084975506*a,t+n-.448084975506*i,r+s,t+n-i,r+s),o.lineTo(t+i,r+s),(0!==i||0!==a)&&o.bezierCurveTo(t+.448084975506*i,r+s,t,r+s-.448084975506*a,t,r+s-a),o.lineTo(t,r+a),(0!==i||0!==a)&&o.bezierCurveTo(t,r+.448084975506*a,t+.448084975506*i,r,t+i,r),o}function parsePolygonNode(e){function iterator(e,i,a){let n=parseFloatWithUnits(i),s=parseFloatWithUnits(a);0===r?t.moveTo(n,s):t.lineTo(n,s),r++}let t=new ShapePath,r=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,iterator),t.currentPath.autoClose=!0,t}function parsePolylineNode(e){function iterator(e,i,a){let n=parseFloatWithUnits(i),s=parseFloatWithUnits(a);0===r?t.moveTo(n,s):t.lineTo(n,s),r++}let t=new ShapePath,r=0;return e.getAttribute("points").replace(/(-?[\d\.?]+)[,|\s](-?[\d\.?]+)/g,iterator),t.currentPath.autoClose=!1,t}function parseCircleNode(e){let t=parseFloatWithUnits(e.getAttribute("cx")||0),r=parseFloatWithUnits(e.getAttribute("cy")||0),i=parseFloatWithUnits(e.getAttribute("r")||0),a=new Path;a.absarc(t,r,i,0,2*Math.PI);let n=new ShapePath;return n.subPaths.push(a),n}function parseEllipseNode(e){let t=parseFloatWithUnits(e.getAttribute("cx")||0),r=parseFloatWithUnits(e.getAttribute("cy")||0),i=parseFloatWithUnits(e.getAttribute("rx")||0),a=parseFloatWithUnits(e.getAttribute("ry")||0),n=new Path;n.absellipse(t,r,i,a,0,2*Math.PI);let s=new ShapePath;return s.subPaths.push(n),s}function parseLineNode(e){let t=parseFloatWithUnits(e.getAttribute("x1")||0),r=parseFloatWithUnits(e.getAttribute("y1")||0),i=parseFloatWithUnits(e.getAttribute("x2")||0),a=parseFloatWithUnits(e.getAttribute("y2")||0),n=new ShapePath;return n.moveTo(t,r),n.lineTo(i,a),n.currentPath.autoClose=!1,n}function parseStyle(e,t){t=Object.assign({},t);let r={};if(e.hasAttribute("class")){let t=e.getAttribute("class").split(/\s/).filter(Boolean).map(e=>e.trim());for(let e=0;e<t.length;e++)r=Object.assign(r,n["."+t[e]])}function addStyle(i,a,n){void 0===n&&(n=function(e){return e.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),e}),e.hasAttribute(i)&&(t[a]=n(e.getAttribute(i))),r[i]&&(t[a]=n(r[i])),e.style&&""!==e.style[i]&&(t[a]=n(e.style[i]))}function clamp2(e){return Math.max(0,Math.min(1,parseFloatWithUnits(e)))}function positive(e){return Math.max(0,parseFloatWithUnits(e))}return e.hasAttribute("id")&&(r=Object.assign(r,n["#"+e.getAttribute("id")])),addStyle("fill","fill"),addStyle("fill-opacity","fillOpacity",clamp2),addStyle("fill-rule","fillRule"),addStyle("opacity","opacity",clamp2),addStyle("stroke","stroke"),addStyle("stroke-opacity","strokeOpacity",clamp2),addStyle("stroke-width","strokeWidth",positive),addStyle("stroke-linejoin","strokeLineJoin"),addStyle("stroke-linecap","strokeLineCap"),addStyle("stroke-miterlimit","strokeMiterLimit",positive),addStyle("visibility","visibility"),t}function parseFloats(e,t,r){let i;if("string"!=typeof e)throw TypeError("Invalid input: "+typeof e);let a={WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/},n=0,s=!0,o="",l="",c=[];function throwSyntaxError(e,t,r){let i=SyntaxError('Unexpected character "'+e+'" at index '+t+".");throw i.partial=r,i}function newNumber(){""!==o&&(""===l?c.push(Number(o)):c.push(Number(o)*Math.pow(10,Number(l)))),o="",l=""}let u=e.length;for(let h=0;h<u;h++){if(i=e[h],Array.isArray(t)&&t.includes(c.length%r)&&a.FLAGS.test(i)){n=1,o=i,newNumber();continue}if(0===n){if(a.WHITESPACE.test(i))continue;if(a.DIGIT.test(i)||a.SIGN.test(i)){n=1,o=i;continue}if(a.POINT.test(i)){n=2,o=i;continue}a.COMMA.test(i)&&(s&&throwSyntaxError(i,h,c),s=!0)}if(1===n){if(a.DIGIT.test(i)){o+=i;continue}if(a.POINT.test(i)){o+=i,n=2;continue}if(a.EXP.test(i)){n=3;continue}a.SIGN.test(i)&&1===o.length&&a.SIGN.test(o[0])&&throwSyntaxError(i,h,c)}if(2===n){if(a.DIGIT.test(i)){o+=i;continue}if(a.EXP.test(i)){n=3;continue}a.POINT.test(i)&&"."===o[o.length-1]&&throwSyntaxError(i,h,c)}if(3===n){if(a.DIGIT.test(i)){l+=i;continue}if(a.SIGN.test(i)){if(""===l){l+=i;continue}1===l.length&&a.SIGN.test(l)&&throwSyntaxError(i,h,c)}}a.WHITESPACE.test(i)?(newNumber(),n=0,s=!1):a.COMMA.test(i)?(newNumber(),n=0,s=!0):a.SIGN.test(i)?(newNumber(),n=1,o=i):a.POINT.test(i)?(newNumber(),n=2,o=i):throwSyntaxError(i,h,c)}return newNumber(),c}let r=["mm","cm","in","pt","pc","px"],i={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:12,pc:1,px:-1},px:{px:1}};function parseFloatWithUnits(e){let a,n="px";if("string"==typeof e||e instanceof String)for(let t=0,i=r.length;t<i;t++){let i=r[t];if(e.endsWith(i)){n=i,e=e.substring(0,e.length-i.length);break}}return"px"===n&&"px"!==t.defaultUnit?a=i.in[t.defaultUnit]/t.defaultDPI:(a=i[n][t.defaultUnit])<0&&(a=i[n].in*t.defaultDPI),a*parseFloat(e)}function getNodeTransform(e){if(!(e.hasAttribute("transform")||"use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))))return null;let t=parseNodeTransform(e);return s.length>0&&t.premultiply(s[s.length-1]),d.copy(t),s.push(t),t}function parseNodeTransform(e){let t=new Matrix3;if("use"===e.nodeName&&(e.hasAttribute("x")||e.hasAttribute("y"))){let r=parseFloatWithUnits(e.getAttribute("x")),i=parseFloatWithUnits(e.getAttribute("y"));t.translate(r,i)}if(e.hasAttribute("transform")){let r=e.getAttribute("transform").split(")");for(let e=r.length-1;e>=0;e--){let i=r[e].trim();if(""===i)continue;let a=i.indexOf("("),n=i.length;if(a>0&&a<n){let e=i.substr(0,a),t=parseFloats(i.substr(a+1,n-a-1));switch(o.identity(),e){case"translate":if(t.length>=1){let e=t[0],r=e;t.length>=2&&(r=t[1]),o.translate(e,r)}break;case"rotate":if(t.length>=1){let e=0,r=0,i=0;e=-t[0]*Math.PI/180,t.length>=3&&(r=t[1],i=t[2]),l.identity().translate(-r,-i),c.identity().rotate(e),u.multiplyMatrices(c,l),l.identity().translate(r,i),o.multiplyMatrices(l,u)}break;case"scale":if(t.length>=1){let e=t[0],r=e;t.length>=2&&(r=t[1]),o.scale(e,r)}break;case"skewX":1===t.length&&o.set(1,Math.tan(t[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":1===t.length&&o.set(1,0,0,Math.tan(t[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":6===t.length&&o.set(t[0],t[2],t[4],t[1],t[3],t[5],0,0,1)}}t.premultiply(o)}}return t}function transformPath(e,t){function transfVec2(e){p.set(e.x,e.y,1).applyMatrix3(t),e.set(p.x,p.y)}let r=isTransformRotated(t),i=e.subPaths;for(let e=0,a=i.length;e<a;e++){let a=i[e],n=a.curves;for(let e=0;e<n.length;e++){let i=n[e];i.isLineCurve?(transfVec2(i.v1),transfVec2(i.v2)):i.isCubicBezierCurve?(transfVec2(i.v0),transfVec2(i.v1),transfVec2(i.v2),transfVec2(i.v3)):i.isQuadraticBezierCurve?(transfVec2(i.v0),transfVec2(i.v1),transfVec2(i.v2)):i.isEllipseCurve&&(r&&console.warn("SVGLoader: Elliptic arc or ellipse rotation or skewing is not implemented."),h.set(i.aX,i.aY),transfVec2(h),i.aX=h.x,i.aY=h.y,i.xRadius*=getTransformScaleX(t),i.yRadius*=getTransformScaleY(t))}}}function isTransformRotated(e){return 0!==e.elements[1]||0!==e.elements[3]}function getTransformScaleX(e){let t=e.elements;return Math.sqrt(t[0]*t[0]+t[1]*t[1])}function getTransformScaleY(e){let t=e.elements;return Math.sqrt(t[3]*t[3]+t[4]*t[4])}let a=[],n={},s=[],o=new Matrix3,l=new Matrix3,c=new Matrix3,u=new Matrix3,h=new Vector2,p=new Vector3,d=new Matrix3,f=new DOMParser().parseFromString(e,"image/svg+xml");parseNode(f.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4});let m={paths:a,xml:f.documentElement};return m}static createShapes(e){let t={ORIGIN:0,DESTINATION:1,BETWEEN:2,LEFT:3,RIGHT:4,BEHIND:5,BEYOND:6},r={loc:t.ORIGIN,t:0};function findEdgeIntersection(e,i,a,n){let s=e.x,o=i.x,l=a.x,c=n.x,u=e.y,h=i.y,p=a.y,d=n.y,f=(c-l)*(u-p)-(d-p)*(s-l),m=(d-p)*(o-s)-(c-l)*(h-u),g=f/m,v=((o-s)*(u-p)-(h-u)*(s-l))/m;if(0===m&&0!==f||g<=0||g>=1||v<0||v>1)return null;if(0===f&&0===m){for(let l=0;l<2;l++){if(classifyPoint(0===l?a:n,e,i),r.loc==t.ORIGIN){let e=0===l?a:n;return{x:e.x,y:e.y,t:r.t}}if(r.loc==t.BETWEEN){let e=+(s+r.t*(o-s)).toPrecision(10),t=+(u+r.t*(h-u)).toPrecision(10);return{x:e,y:t,t:r.t}}}return null}{for(let s=0;s<2;s++)if(classifyPoint(0===s?a:n,e,i),r.loc==t.ORIGIN){let e=0===s?a:n;return{x:e.x,y:e.y,t:r.t}}let l=+(s+g*(o-s)).toPrecision(10),c=+(u+g*(h-u)).toPrecision(10);return{x:l,y:c,t:g}}}function classifyPoint(e,i,a){let n=a.x-i.x,s=a.y-i.y,o=e.x-i.x,l=e.y-i.y,c=n*l-o*s;if(e.x===i.x&&e.y===i.y){r.loc=t.ORIGIN,r.t=0;return}if(e.x===a.x&&e.y===a.y){r.loc=t.DESTINATION,r.t=1;return}if(c<-Number.EPSILON){r.loc=t.LEFT;return}if(c>Number.EPSILON){r.loc=t.RIGHT;return}if(n*o<0||s*l<0){r.loc=t.BEHIND;return}if(Math.sqrt(n*n+s*s)<Math.sqrt(o*o+l*l)){r.loc=t.BEYOND;return}r.loc=t.BETWEEN,r.t=0!==n?o/n:l/s}function getIntersections(e,t){let r=[],i=[];for(let a=1;a<e.length;a++){let n=e[a-1],s=e[a];for(let e=1;e<t.length;e++){let a=t[e-1],o=t[e],l=findEdgeIntersection(n,s,a,o);null!==l&&void 0===r.find(e=>e.t<=l.t+Number.EPSILON&&e.t>=l.t-Number.EPSILON)&&(r.push(l),i.push(new Vector2(l.x,l.y)))}}return i}function getScanlineIntersections(e,t,r){let i=new Vector2;t.getCenter(i);let a=[];return r.forEach(t=>{if(t.boundingBox.containsPoint(i)){let r=getIntersections(e,t.points);r.forEach(e=>{a.push({identifier:t.identifier,isCW:t.isCW,point:e})})}}),a.sort((e,t)=>e.point.x-t.point.x),a}function isHoleTo(e,t,r,i,a){(null==a||""===a)&&(a="nonzero");let n=new Vector2;e.boundingBox.getCenter(n);let s=[new Vector2(r,n.y),new Vector2(i,n.y)],o=getScanlineIntersections(s,e.boundingBox,t);o.sort((e,t)=>e.point.x-t.point.x);let l=[],c=[];o.forEach(t=>{t.identifier===e.identifier?l.push(t):c.push(t)});let u=l[0].point.x,h=[],p=0;for(;p<c.length&&c[p].point.x<u;)h.length>0&&h[h.length-1]===c[p].identifier?h.pop():h.push(c[p].identifier),p++;if(h.push(e.identifier),"evenodd"===a){let t=h.length%2==0,r=h[h.length-2];return{identifier:e.identifier,isHole:t,for:r}}if("nonzero"===a){let r=!0,i=null,a=null;for(let e=0;e<h.length;e++){let n=h[e];r?(a=t[n].isCW,r=!1,i=n):a!==t[n].isCW&&(a=t[n].isCW,r=!0)}return{identifier:e.identifier,isHole:r,for:i}}console.warn('fill-rule: "'+a+'" is currently not implemented.')}let i=0,a=999999999,n=-999999999,s=e.subPaths.map(e=>{let t=e.getPoints(),r=-999999999,s=999999999,o=-999999999,l=999999999;for(let e=0;e<t.length;e++){let i=t[e];i.y>r&&(r=i.y),i.y<s&&(s=i.y),i.x>o&&(o=i.x),i.x<l&&(l=i.x)}return n<=o&&(n=o+1),a>=l&&(a=l-1),{curves:e.curves,points:t,isCW:ShapeUtils.isClockWise(t),identifier:i++,boundingBox:new Box2(new Vector2(l,s),new Vector2(o,r))}});s=s.filter(e=>e.points.length>1);let o=s.map(t=>isHoleTo(t,s,a,n,e.userData.style.fillRule)),l=[];return s.forEach(e=>{let t=o[e.identifier];if(!t.isHole){let t=new Shape;t.curves=e.curves;let r=o.filter(t=>t.isHole&&t.for===e.identifier);r.forEach(e=>{let r=s[e.identifier],i=new Path;i.curves=r.curves,t.holes.push(i)}),l.push(t)}}),l}static getStrokeStyle(e,t,r,i,a){return{strokeColor:t=void 0!==t?t:"#000",strokeWidth:e=void 0!==e?e:1,strokeLineJoin:r=void 0!==r?r:"miter",strokeLineCap:i=void 0!==i?i:"butt",strokeMiterLimit:a=void 0!==a?a:4}}static pointsToStroke(e,t,r,i){let a=[],n=[],s=[];if(0===SVGLoader.pointsToStrokeWithBuffers(e,t,r,i,a,n,s))return null;let o=new BufferGeometry;return o.setAttribute("position",new Float32BufferAttribute(a,3)),o.setAttribute("normal",new Float32BufferAttribute(n,3)),o.setAttribute("uv",new Float32BufferAttribute(s,2)),o}static pointsToStrokeWithBuffers(e,t,r,i,a,n,s,o){let l,c,u,h,p;let d=new Vector2,f=new Vector2,m=new Vector2,g=new Vector2,v=new Vector2,y=new Vector2,x=new Vector2,b=new Vector2,T=new Vector2,S=new Vector2,E=new Vector2,R=new Vector2,A=new Vector2,C=new Vector2,M=new Vector2,P=new Vector2,w=new Vector2;r=void 0!==r?r:12,i=void 0!==i?i:.001,o=void 0!==o?o:0,e=removeDuplicatedPoints(e);let I=e.length;if(I<2)return 0;let k=e[0].equals(e[I-1]),_=e[0],O=t.strokeWidth/2,N=1/(I-1),L=0,F,D=!1,U=0,B=3*o,V=2*o;getNormal(e[0],e[1],d).multiplyScalar(O),b.copy(e[0]).sub(d),T.copy(e[0]).add(d),S.copy(b),E.copy(T);for(let r=1;r<I;r++){if(l=e[r],c=r===I-1?k?e[1]:void 0:e[r+1],getNormal(_,l,d),m.copy(d).multiplyScalar(O),R.copy(l).sub(m),A.copy(l).add(m),F=L+N,u=!1,void 0!==c){getNormal(l,c,f),m.copy(f).multiplyScalar(O),C.copy(l).sub(m),M.copy(l).add(m),h=!0,m.subVectors(c,_),0>d.dot(m)&&(h=!1),1===r&&(D=h),m.subVectors(c,l),m.normalize();let e=Math.abs(d.dot(m));if(0!==e){let r=O/e;m.multiplyScalar(-r),g.subVectors(l,_),v.copy(g).setLength(r).add(m),P.copy(v).negate();let i=v.length(),a=g.length();g.divideScalar(a),y.subVectors(c,l);let n=y.length();switch(y.divideScalar(n),g.dot(P)<a&&y.dot(P)<n&&(u=!0),w.copy(v).add(l),P.add(l),p=!1,u?h?(M.copy(P),A.copy(P)):(C.copy(P),R.copy(P)):makeSegmentTriangles(),t.strokeLineJoin){case"bevel":makeSegmentWithBevelJoin(h,u,F);break;case"round":createSegmentTrianglesWithMiddleSection(h,u),h?makeCircularSector(l,R,C,F,0):makeCircularSector(l,M,A,F,1);break;default:let s=O*t.strokeMiterLimit/i;s<1?"miter-clip"!==t.strokeLineJoin?makeSegmentWithBevelJoin(h,u,F):(createSegmentTrianglesWithMiddleSection(h,u),h?(y.subVectors(w,R).multiplyScalar(s).add(R),x.subVectors(w,C).multiplyScalar(s).add(C),addVertex(R,F,0),addVertex(y,F,0),addVertex(l,F,.5),addVertex(l,F,.5),addVertex(y,F,0),addVertex(x,F,0),addVertex(l,F,.5),addVertex(x,F,0),addVertex(C,F,0)):(y.subVectors(w,A).multiplyScalar(s).add(A),x.subVectors(w,M).multiplyScalar(s).add(M),addVertex(A,F,1),addVertex(y,F,1),addVertex(l,F,.5),addVertex(l,F,.5),addVertex(y,F,1),addVertex(x,F,1),addVertex(l,F,.5),addVertex(x,F,1),addVertex(M,F,1))):(u?(h?(addVertex(T,L,1),addVertex(b,L,0),addVertex(w,F,0),addVertex(T,L,1),addVertex(w,F,0),addVertex(P,F,1)):(addVertex(T,L,1),addVertex(b,L,0),addVertex(w,F,1),addVertex(b,L,0),addVertex(P,F,0),addVertex(w,F,1)),h?C.copy(w):M.copy(w)):h?(addVertex(R,F,0),addVertex(w,F,0),addVertex(l,F,.5),addVertex(l,F,.5),addVertex(w,F,0),addVertex(C,F,0)):(addVertex(A,F,1),addVertex(w,F,1),addVertex(l,F,.5),addVertex(l,F,.5),addVertex(w,F,1),addVertex(M,F,1)),p=!0)}}else makeSegmentTriangles()}else makeSegmentTriangles();k||r!==I-1||addCapGeometry(e[0],S,E,h,!0,L),L=F,_=l,b.copy(C),T.copy(M)}if(k){if(u&&a){let e=w,t=P;D!==h&&(e=P,t=w),h?(p||D)&&(t.toArray(a,0),t.toArray(a,9),p&&e.toArray(a,3)):(p||!D)&&(t.toArray(a,3),t.toArray(a,9),p&&e.toArray(a,0))}}else addCapGeometry(l,R,A,h,!1,F);return U;function getNormal(e,t,r){return r.subVectors(t,e),r.set(-r.y,r.x).normalize()}function addVertex(e,t,r){a&&(a[B]=e.x,a[B+1]=e.y,a[B+2]=0,n&&(n[B]=0,n[B+1]=0,n[B+2]=1),B+=3,s&&(s[V]=t,s[V+1]=r,V+=2)),U+=3}function makeCircularSector(e,t,i,a,n){d.copy(t).sub(e).normalize(),f.copy(i).sub(e).normalize();let s=Math.PI,o=d.dot(f);1>Math.abs(o)&&(s=Math.abs(Math.acos(o))),s/=r,m.copy(t);for(let t=0,i=r-1;t<i;t++)g.copy(m).rotateAround(e,s),addVertex(m,a,n),addVertex(g,a,n),addVertex(e,a,.5),m.copy(g);addVertex(g,a,n),addVertex(i,a,n),addVertex(e,a,.5)}function makeSegmentTriangles(){addVertex(T,L,1),addVertex(b,L,0),addVertex(R,F,0),addVertex(T,L,1),addVertex(R,F,1),addVertex(A,F,0)}function makeSegmentWithBevelJoin(e,t,r){t?(e?(addVertex(T,L,1),addVertex(b,L,0),addVertex(R,F,0),addVertex(T,L,1),addVertex(R,F,0),addVertex(P,F,1),addVertex(R,r,0),addVertex(C,r,0)):(addVertex(T,L,1),addVertex(b,L,0),addVertex(A,F,1),addVertex(b,L,0),addVertex(P,F,0),addVertex(A,F,1),addVertex(A,r,1),addVertex(M,r,0)),addVertex(P,r,.5)):(e?(addVertex(R,r,0),addVertex(C,r,0)):(addVertex(A,r,1),addVertex(M,r,0)),addVertex(l,r,.5))}function createSegmentTrianglesWithMiddleSection(e,t){t&&(e?(addVertex(T,L,1),addVertex(b,L,0),addVertex(R,F,0),addVertex(T,L,1),addVertex(R,F,0),addVertex(P,F,1),addVertex(R,L,0),addVertex(l,F,.5),addVertex(P,F,1),addVertex(l,F,.5),addVertex(C,L,0),addVertex(P,F,1)):(addVertex(T,L,1),addVertex(b,L,0),addVertex(A,F,1),addVertex(b,L,0),addVertex(P,F,0),addVertex(A,F,1),addVertex(A,L,1),addVertex(P,F,0),addVertex(l,F,.5),addVertex(l,F,.5),addVertex(P,F,0),addVertex(M,L,1)))}function addCapGeometry(e,r,i,n,s,o){switch(t.strokeLineCap){case"round":s?makeCircularSector(e,i,r,o,.5):makeCircularSector(e,r,i,o,.5);break;case"square":if(s)d.subVectors(r,e),f.set(d.y,-d.x),m.addVectors(d,f).add(e),g.subVectors(f,d).add(e),n?(m.toArray(a,3),g.toArray(a,0),g.toArray(a,9)):(m.toArray(a,3),m.toArray(a,9),g.toArray(a,0));else{d.subVectors(i,e),f.set(d.y,-d.x),m.addVectors(d,f).add(e),g.subVectors(f,d).add(e);let t=a.length;n?(m.toArray(a,t-3),g.toArray(a,t-6)):(m.toArray(a,t-6),g.toArray(a,t-3)),g.toArray(a,t-12)}}}function removeDuplicatedPoints(e){let t=!1;for(let r=1,a=e.length-1;r<a;r++)if(e[r].distanceTo(e[r+1])<i){t=!0;break}if(!t)return e;let r=[];r.push(e[0]);for(let t=1,a=e.length-1;t<a;t++)e[t].distanceTo(e[t+1])>=i&&r.push(e[t]);return r.push(e[e.length-1]),r}}};let tA={colors:{BloomColor:`
			vec3 BloomColor(vec3 color, float gain) {
				// Guarantee that there's at least a little bit of all 3 channels.
				// This makes fully-saturated strokes (which only have 2 non-zero
				// color channels) eventually clip to white rather than to a secondary.
				float cmin = length(color.rgb) * .05;
				color.rgb = max(color.rgb, vec3(cmin, cmin, cmin));
				// If we try to remove this pow() from .a, it brightens up
				// pressure-sensitive strokes; looks better as-is.
				color = pow(color, vec3(2.2));
				color.rgb *= 2. * exp(gain * 10.);
				return color;
			}
		`,LinearToSrgb:`
			vec3 LinearToSrgb(vec3 color) {
				// Approximation http://chilliant.blogspot.com/2012/08/srgb-approximations-for-hlsl.html
				vec3 linearColor = color.rgb;
				vec3 S1 = sqrt(linearColor);
				vec3 S2 = sqrt(S1);
				vec3 S3 = sqrt(S2);
				color.rgb = 0.662002687 * S1 + 0.684122060 * S2 - 0.323583601 * S3 - 0.0225411470 * linearColor;
				return color;
			}
		`,hsv:`
			// uniform sampler2D lookupTex;
			vec4 lookup(vec4 textureColor) {
				return textureColor;
			}

			vec3 lookup(vec3 textureColor) {
				return textureColor;
			}

			vec3 hsv2rgb( vec3 hsv ) {
				vec3 rgb = clamp( abs(mod(hsv.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0, 0.0, 1.0 );
				return hsv.z * mix( vec3(1.0), rgb, hsv.y);
			}

			vec3 rgb2hsv( vec3 rgb ) {
				vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
				vec4 p = mix(vec4(rgb.bg, K.wz), vec4(rgb.gb, K.xy), step(rgb.b, rgb.g));
				vec4 q = mix(vec4(p.xyw, rgb.r), vec4(rgb.r, p.yzx), step(p.x, rgb.r));

				float d = q.x - min(q.w, q.y);
				float e = 1.0e-10;

				return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
			}
		`,SrgbToLinear:`
			vec3 SrgbToLinear(vec3 color) {
				// Approximation http://chilliant.blogspot.com/2012/08/srgb-approximations-for-hlsl.html
				vec3 sRGB = color.rgb;
				color.rgb = sRGB * (sRGB * (sRGB * 0.305306011 + 0.682171111) + 0.012522878);
				return color;
			}
		`}},tC=null;function isBigEndianPlatform(){if(null===tC){let e=new ArrayBuffer(2),t=new Uint8Array(e),r=new Uint16Array(e);t[0]=170,t[1]=187,tC=43707===r[0]}return tC}Float32Array,Int8Array,Int16Array,Int32Array,Uint8Array,Uint16Array,Uint32Array;let tM={Uint16Array:"getUint16",Uint32Array:"getUint32",Int16Array:"getInt16",Int32Array:"getInt32",Float32Array:"getFloat32",Float64Array:"getFloat64"};function isEven(e){return e%2}let tP=new d.Matrix4,tw=new d.Object3D,tI=new d.Vector3;let Geometry=class Geometry extends null{static createBufferGeometryFromObject(e){let t=new BufferGeometry,r=e.geometry;if(e.isPoints||e.isLine){let e=new Float32BufferAttribute(3*r.vertices.length,3),i=new Float32BufferAttribute(3*r.colors.length,3);if(t.setAttribute("position",e.copyVector3sArray(r.vertices)),t.setAttribute("color",i.copyColorsArray(r.colors)),r.lineDistances&&r.lineDistances.length===r.vertices.length){let e=new Float32BufferAttribute(r.lineDistances.length,1);t.setAttribute("lineDistance",e.copyArray(r.lineDistances))}null!==r.boundingSphere&&(t.boundingSphere=r.boundingSphere.clone()),null!==r.boundingBox&&(t.boundingBox=r.boundingBox.clone())}else e.isMesh&&(t=r.toBufferGeometry());return t}constructor(){super(),this.isGeometry=!0,this.uuid=MathUtils.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}applyMatrix4(e){let t=new Matrix3().getNormalMatrix(e);for(let t=0,r=this.vertices.length;t<r;t++){let r=this.vertices[t];r.applyMatrix4(e)}for(let e=0,r=this.faces.length;e<r;e++){let r=this.faces[e];r.normal.applyMatrix3(t).normalize();for(let e=0,i=r.vertexNormals.length;e<i;e++)r.vertexNormals[e].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this}rotateX(e){return tP.makeRotationX(e),this.applyMatrix4(tP),this}rotateY(e){return tP.makeRotationY(e),this.applyMatrix4(tP),this}rotateZ(e){return tP.makeRotationZ(e),this.applyMatrix4(tP),this}translate(e,t,r){return tP.makeTranslation(e,t,r),this.applyMatrix4(tP),this}scale(e,t,r){return tP.makeScale(e,t,r),this.applyMatrix4(tP),this}lookAt(e){return tw.lookAt(e),tw.updateMatrix(),this.applyMatrix4(tw.matrix),this}fromBufferGeometry(e){let t=this,r=null!==e.index?e.index:void 0,i=e.attributes;if(void 0===i.position)return console.error("THREE.Geometry.fromBufferGeometry(): Position attribute required for conversion."),this;let a=i.position,n=i.normal,s=i.color,o=i.uv,l=i.uv2;void 0!==l&&(this.faceVertexUvs[1]=[]);for(let e=0;e<a.count;e++)t.vertices.push(new Vector3().fromBufferAttribute(a,e)),void 0!==s&&t.colors.push(new Color().fromBufferAttribute(s,e));function addFace(e,r,i,a){let c=void 0===s?[]:[t.colors[e].clone(),t.colors[r].clone(),t.colors[i].clone()],u=void 0===n?[]:[new Vector3().fromBufferAttribute(n,e),new Vector3().fromBufferAttribute(n,r),new Vector3().fromBufferAttribute(n,i)],h=new Face3(e,r,i,u,c,a);t.faces.push(h),void 0!==o&&t.faceVertexUvs[0].push([new Vector2().fromBufferAttribute(o,e),new Vector2().fromBufferAttribute(o,r),new Vector2().fromBufferAttribute(o,i)]),void 0!==l&&t.faceVertexUvs[1].push([new Vector2().fromBufferAttribute(l,e),new Vector2().fromBufferAttribute(l,r),new Vector2().fromBufferAttribute(l,i)])}let c=e.groups;if(c.length>0)for(let e=0;e<c.length;e++){let t=c[e],i=t.start,a=t.count;for(let e=i,n=i+a;e<n;e+=3)void 0!==r?addFace(r.getX(e),r.getX(e+1),r.getX(e+2),t.materialIndex):addFace(e,e+1,e+2,t.materialIndex)}else if(void 0!==r)for(let e=0;e<r.count;e+=3)addFace(r.getX(e),r.getX(e+1),r.getX(e+2));else for(let e=0;e<a.count;e+=3)addFace(e,e+1,e+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(tI).negate(),this.translate(tI.x,tI.y,tI.z),this}normalize(){this.computeBoundingSphere();let e=this.boundingSphere.center,t=this.boundingSphere.radius,r=0===t?1:1/t,i=new Matrix4;return i.set(r,0,0,-r*e.x,0,r,0,-r*e.y,0,0,r,-r*e.z,0,0,0,1),this.applyMatrix4(i),this}computeFaceNormals(){let e=new Vector3,t=new Vector3;for(let r=0,i=this.faces.length;r<i;r++){let i=this.faces[r],a=this.vertices[i.a],n=this.vertices[i.b],s=this.vertices[i.c];e.subVectors(s,n),t.subVectors(a,n),e.cross(t),e.normalize(),i.normal.copy(e)}}computeVertexNormals(e=!0){let t=Array(this.vertices.length);for(let e=0,r=this.vertices.length;e<r;e++)t[e]=new Vector3;if(e){let e=new Vector3,r=new Vector3;for(let i=0,a=this.faces.length;i<a;i++){let a=this.faces[i],n=this.vertices[a.a],s=this.vertices[a.b],o=this.vertices[a.c];e.subVectors(o,s),r.subVectors(n,s),e.cross(r),t[a.a].add(e),t[a.b].add(e),t[a.c].add(e)}}else{this.computeFaceNormals();for(let e=0,r=this.faces.length;e<r;e++){let r=this.faces[e];t[r.a].add(r.normal),t[r.b].add(r.normal),t[r.c].add(r.normal)}}for(let e=0,r=this.vertices.length;e<r;e++)t[e].normalize();for(let e=0,r=this.faces.length;e<r;e++){let r=this.faces[e],i=r.vertexNormals;3===i.length?(i[0].copy(t[r.a]),i[1].copy(t[r.b]),i[2].copy(t[r.c])):(i[0]=t[r.a].clone(),i[1]=t[r.b].clone(),i[2]=t[r.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeFlatVertexNormals(){this.computeFaceNormals();for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e],r=t.vertexNormals;3===r.length?(r[0].copy(t.normal),r[1].copy(t.normal),r[2].copy(t.normal)):(r[0]=t.normal.clone(),r[1]=t.normal.clone(),r[2]=t.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)}computeMorphNormals(){for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e];t.__originalFaceNormal?t.__originalFaceNormal.copy(t.normal):t.__originalFaceNormal=t.normal.clone(),t.__originalVertexNormals||(t.__originalVertexNormals=[]);for(let e=0,r=t.vertexNormals.length;e<r;e++)t.__originalVertexNormals[e]?t.__originalVertexNormals[e].copy(t.vertexNormals[e]):t.__originalVertexNormals[e]=t.vertexNormals[e].clone()}let e=new Geometry;e.faces=this.faces;for(let t=0,r=this.morphTargets.length;t<r;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];let e=this.morphNormals[t].faceNormals,r=this.morphNormals[t].vertexNormals;for(let t=0,i=this.faces.length;t<i;t++){let t=new Vector3,i={a:new Vector3,b:new Vector3,c:new Vector3};e.push(t),r.push(i)}}let r=this.morphNormals[t];e.vertices=this.morphTargets[t].vertices,e.computeFaceNormals(),e.computeVertexNormals();for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e],i=r.faceNormals[e],a=r.vertexNormals[e];i.copy(t.normal),a.a.copy(t.vertexNormals[0]),a.b.copy(t.vertexNormals[1]),a.c.copy(t.vertexNormals[2])}}for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e];t.normal=t.__originalFaceNormal,t.vertexNormals=t.__originalVertexNormals}}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Box3),this.boundingBox.setFromPoints(this.vertices)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Sphere),this.boundingSphere.setFromPoints(this.vertices)}merge(e,t,r=0){let i;if(!(e&&e.isGeometry)){console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);return}let a=this.vertices.length,n=this.vertices,s=e.vertices,o=this.faces,l=e.faces,c=this.colors,u=e.colors;void 0!==t&&(i=new Matrix3().getNormalMatrix(t));for(let e=0,r=s.length;e<r;e++){let r=s[e],i=r.clone();void 0!==t&&i.applyMatrix4(t),n.push(i)}for(let e=0,t=u.length;e<t;e++)c.push(u[e].clone());for(let e=0,t=l.length;e<t;e++){let t,n;let s=l[e],c=s.vertexNormals,u=s.vertexColors,h=new Face3(s.a+a,s.b+a,s.c+a);h.normal.copy(s.normal),void 0!==i&&h.normal.applyMatrix3(i).normalize();for(let e=0,r=c.length;e<r;e++)t=c[e].clone(),void 0!==i&&t.applyMatrix3(i).normalize(),h.vertexNormals.push(t);h.color.copy(s.color);for(let e=0,t=u.length;e<t;e++)n=u[e],h.vertexColors.push(n.clone());h.materialIndex=s.materialIndex+r,o.push(h)}for(let t=0,r=e.faceVertexUvs.length;t<r;t++){let r=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,i=r.length;e<i;e++){let i=r[e],a=[];for(let e=0,t=i.length;e<t;e++)a.push(i[e].clone());this.faceVertexUvs[t].push(a)}}}mergeMesh(e){if(!(e&&e.isMesh)){console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e);return}e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)}mergeVertices(e=4){let t={},r=[],i=[],a=Math.pow(10,e);for(let e=0,n=this.vertices.length;e<n;e++){let n=this.vertices[e],s=`${Math.round(n.x*a)}_${Math.round(n.y*a)}_${Math.round(n.z*a)}`;void 0===t[s]?(t[s]=e,r.push(this.vertices[e]),i[e]=r.length-1):i[e]=i[t[s]]}let n=[];for(let e=0,t=this.faces.length;e<t;e++){let t=this.faces[e];t.a=i[t.a],t.b=i[t.b],t.c=i[t.c];let r=[t.a,t.b,t.c];for(let t=0;t<3;t++)if(r[t]===r[(t+1)%3]){n.push(e);break}}for(let e=n.length-1;e>=0;e--){let t=n[e];this.faces.splice(t,1);for(let e=0,r=this.faceVertexUvs.length;e<r;e++)this.faceVertexUvs[e].splice(t,1)}let s=this.vertices.length-r.length;return this.vertices=r,s}setFromPoints(e){this.vertices=[];for(let t=0,r=e.length;t<r;t++){let r=e[t];this.vertices.push(new Vector3(r.x,r.y,r.z||0))}return this}sortFacesByMaterialIndex(){let e,t;let r=this.faces,i=r.length;for(let e=0;e<i;e++)r[e]._id=e;function materialIndexSort(e,t){return e.materialIndex-t.materialIndex}r.sort(materialIndexSort);let a=this.faceVertexUvs[0],n=this.faceVertexUvs[1];a&&a.length===i&&(e=[]),n&&n.length===i&&(t=[]);for(let s=0;s<i;s++){let i=r[s]._id;e&&e.push(a[i]),t&&t.push(n[i])}e&&(this.faceVertexUvs[0]=e),t&&(this.faceVertexUvs[1]=t)}toJSON(){let e={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){let t=this.parameters;for(let r in t)void 0!==t[r]&&(e[r]=t[r]);return e}let t=[];for(let e=0;e<this.vertices.length;e++){let r=this.vertices[e];t.push(r.x,r.y,r.z)}let r=[],i=[],a={},n=[],s={},o=[],l={};for(let e=0;e<this.faces.length;e++){let t=this.faces[e],i=void 0!==this.faceVertexUvs[0][e],a=t.normal.length()>0,n=t.vertexNormals.length>0,s=1!==t.color.r||1!==t.color.g||1!==t.color.b,o=t.vertexColors.length>0,l=0;if(l=setBit(0,0,0),l=setBit(l,1,!0),l=setBit(l,2,!1),l=setBit(l,3,i),l=setBit(l,4,a),l=setBit(l,5,n),l=setBit(l,6,s),l=setBit(l,7,o),r.push(l),r.push(t.a,t.b,t.c),r.push(t.materialIndex),i){let t=this.faceVertexUvs[0][e];r.push(getUvIndex(t[0]),getUvIndex(t[1]),getUvIndex(t[2]))}if(a&&r.push(getNormalIndex(t.normal)),n){let e=t.vertexNormals;r.push(getNormalIndex(e[0]),getNormalIndex(e[1]),getNormalIndex(e[2]))}if(s&&r.push(getColorIndex(t.color)),o){let e=t.vertexColors;r.push(getColorIndex(e[0]),getColorIndex(e[1]),getColorIndex(e[2]))}}function setBit(e,t,r){return r?e|1<<t:e&~(1<<t)}function getNormalIndex(e){let t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==a[t]||(a[t]=i.length/3,i.push(e.x,e.y,e.z)),a[t]}function getColorIndex(e){let t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==s[t]||(s[t]=n.length,n.push(e.getHex())),s[t]}function getUvIndex(e){let t=e.x.toString()+e.y.toString();return void 0!==l[t]||(l[t]=o.length/2,o.push(e.x,e.y)),l[t]}return e.data={},e.data.vertices=t,e.data.normals=i,n.length>0&&(e.data.colors=n),o.length>0&&(e.data.uvs=[o]),e.data.faces=r,e}clone(){return new Geometry().copy(this)}copy(e){this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;let t=e.vertices;for(let e=0,r=t.length;e<r;e++)this.vertices.push(t[e].clone());let r=e.colors;for(let e=0,t=r.length;e<t;e++)this.colors.push(r[e].clone());let i=e.faces;for(let e=0,t=i.length;e<t;e++)this.faces.push(i[e].clone());for(let t=0,r=e.faceVertexUvs.length;t<r;t++){let r=e.faceVertexUvs[t];void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]);for(let e=0,i=r.length;e<i;e++){let i=r[e],a=[];for(let e=0,t=i.length;e<t;e++){let t=i[e];a.push(t.clone())}this.faceVertexUvs[t].push(a)}}let a=e.morphTargets;for(let e=0,t=a.length;e<t;e++){let t={};if(t.name=a[e].name,void 0!==a[e].vertices){t.vertices=[];for(let r=0,i=a[e].vertices.length;r<i;r++)t.vertices.push(a[e].vertices[r].clone())}if(void 0!==a[e].normals){t.normals=[];for(let r=0,i=a[e].normals.length;r<i;r++)t.normals.push(a[e].normals[r].clone())}this.morphTargets.push(t)}let n=e.morphNormals;for(let e=0,t=n.length;e<t;e++){let t={};if(void 0!==n[e].vertexNormals){t.vertexNormals=[];for(let r=0,i=n[e].vertexNormals.length;r<i;r++){let i=n[e].vertexNormals[r],a={};a.a=i.a.clone(),a.b=i.b.clone(),a.c=i.c.clone(),t.vertexNormals.push(a)}}if(void 0!==n[e].faceNormals){t.faceNormals=[];for(let r=0,i=n[e].faceNormals.length;r<i;r++)t.faceNormals.push(n[e].faceNormals[r].clone())}this.morphNormals.push(t)}let s=e.skinWeights;for(let e=0,t=s.length;e<t;e++)this.skinWeights.push(s[e].clone());let o=e.skinIndices;for(let e=0,t=o.length;e<t;e++)this.skinIndices.push(o[e].clone());let l=e.lineDistances;for(let e=0,t=l.length;e<t;e++)this.lineDistances.push(l[e]);let c=e.boundingBox;null!==c&&(this.boundingBox=c.clone());let u=e.boundingSphere;return null!==u&&(this.boundingSphere=u.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}toBufferGeometry(){let e=new DirectGeometry().fromGeometry(this),t=new BufferGeometry,r=new Float32Array(3*e.vertices.length);if(t.setAttribute("position",new BufferAttribute(r,3).copyVector3sArray(e.vertices)),e.normals.length>0){let r=new Float32Array(3*e.normals.length);t.setAttribute("normal",new BufferAttribute(r,3).copyVector3sArray(e.normals))}if(e.colors.length>0){let r=new Float32Array(3*e.colors.length);t.setAttribute("color",new BufferAttribute(r,3).copyColorsArray(e.colors))}if(e.uvs.length>0){let r=new Float32Array(2*e.uvs.length);t.setAttribute("uv",new BufferAttribute(r,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){let r=new Float32Array(2*e.uvs2.length);t.setAttribute("uv2",new BufferAttribute(r,2).copyVector2sArray(e.uvs2))}for(let r in t.groups=e.groups,e.morphTargets){let i=[],a=e.morphTargets[r];for(let e=0,t=a.length;e<t;e++){let t=a[e],r=new Float32BufferAttribute(3*t.data.length,3);r.name=t.name,i.push(r.copyVector3sArray(t.data))}t.morphAttributes[r]=i}if(e.skinIndices.length>0){let r=new Float32BufferAttribute(4*e.skinIndices.length,4);t.setAttribute("skinIndex",r.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){let r=new Float32BufferAttribute(4*e.skinWeights.length,4);t.setAttribute("skinWeight",r.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(t.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(t.boundingBox=e.boundingBox.clone()),t}computeTangents(){console.error("THREE.Geometry: .computeTangents() has been removed.")}computeLineDistances(){console.error("THREE.Geometry: .computeLineDistances() has been removed. Use THREE.Line.computeLineDistances() instead.")}applyMatrix(e){return console.warn("THREE.Geometry: .applyMatrix() has been renamed to .applyMatrix4()."),this.applyMatrix4(e)}dispose(){this.dispatchEvent({type:"dispose"})}};let DirectGeometry=class DirectGeometry{constructor(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}computeGroups(e){let t,r,i;let a=[],n=e.faces;for(r=0;r<n.length;r++){let e=n[r];e.materialIndex!==i&&(i=e.materialIndex,void 0!==t&&(t.count=3*r-t.start,a.push(t)),t={start:3*r,materialIndex:i})}void 0!==t&&(t.count=3*r-t.start,a.push(t)),this.groups=a}fromGeometry(e){let t,r;let i=e.faces,a=e.vertices,n=e.faceVertexUvs,s=n[0]&&n[0].length>0,o=n[1]&&n[1].length>0,l=e.morphTargets,c=l.length;if(c>0){t=[];for(let e=0;e<c;e++)t[e]={name:l[e].name,data:[]};this.morphTargets.position=t}let u=e.morphNormals,h=u.length;if(h>0){r=[];for(let e=0;e<h;e++)r[e]={name:u[e].name,data:[]};this.morphTargets.normal=r}let p=e.skinIndices,d=e.skinWeights,f=p.length===a.length,m=d.length===a.length;a.length>0&&0===i.length&&console.error("THREE.DirectGeometry: Faceless geometries are not supported.");for(let e=0;e<i.length;e++){let g=i[e];this.vertices.push(a[g.a],a[g.b],a[g.c]);let v=g.vertexNormals;if(3===v.length)this.normals.push(v[0],v[1],v[2]);else{let e=g.normal;this.normals.push(e,e,e)}let y=g.vertexColors;if(3===y.length)this.colors.push(y[0],y[1],y[2]);else{let e=g.color;this.colors.push(e,e,e)}if(!0===s){let t=n[0][e];void 0!==t?this.uvs.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",e),this.uvs.push(new Vector2,new Vector2,new Vector2))}if(!0===o){let t=n[1][e];void 0!==t?this.uvs2.push(t[0],t[1],t[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",e),this.uvs2.push(new Vector2,new Vector2,new Vector2))}for(let e=0;e<c;e++){let r=l[e].vertices;t[e].data.push(r[g.a],r[g.b],r[g.c])}for(let t=0;t<h;t++){let i=u[t].vertexNormals[e];r[t].data.push(i.a,i.b,i.c)}f&&this.skinIndices.push(p[g.a],p[g.b],p[g.c]),m&&this.skinWeights.push(d[g.a],d[g.b],d[g.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this}};let Face3=class Face3{constructor(e,t,r,i,a,n=0){this.a=e,this.b=t,this.c=r,this.normal=i&&i.isVector3?i:new Vector3,this.vertexNormals=Array.isArray(i)?i:[],this.color=a&&a.isColor?a:new Color,this.vertexColors=Array.isArray(a)?a:[],this.materialIndex=n}clone(){return new this.constructor().copy(this)}copy(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(let t=0,r=e.vertexNormals.length;t<r;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(let t=0,r=e.vertexColors.length;t<r;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}}}}]);