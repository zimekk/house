"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1793],{10325:(e,t,r)=>{r.d(t,{jK:()=>f,kh:()=>p});var n=r(13022),i=r(36038),a=r(6152),o=r(80600);function s(e,t,r,n){var a;return(a=class extends i.BKk{constructor(a){for(let n in super({vertexShader:t,fragmentShader:r,...a}),e)this.uniforms[n]=new i.nc$(e[n]),Object.defineProperty(this,n,{get(){return this.uniforms[n].value},set(e){this.uniforms[n].value=e}});this.uniforms=i.LlO.clone(this.uniforms),null==n||n(this)}}).key=i.cj9.generateUUID(),a}let l=s({},"void main() { }","void main() { gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); discard;  }"),u=parseInt(i.sPf.replace(/\D+/g,"")),c=a.createContext(null),d=s({color:new i.Q1f,blend:2,alphaTest:.75,opacity:0,map:null},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vUv = uv;
   }`,`varying vec2 vUv;
   uniform sampler2D map;
   uniform vec3 color;
   uniform float opacity;
   uniform float alphaTest;
   uniform float blend;
   void main() {
     vec4 sampledDiffuseColor = texture2D(map, vUv);
     gl_FragColor = vec4(color * sampledDiffuseColor.r * blend, max(0.0, (1.0 - (sampledDiffuseColor.r + sampledDiffuseColor.g + sampledDiffuseColor.b) / alphaTest)) * opacity);
     #include <tonemapping_fragment>
     #include <${u>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),f=a.forwardRef(({children:e,temporal:t,frames:r=40,limit:n=1/0,blend:i=20,scale:s=10,opacity:l=1,alphaTest:u=.75,color:f="black",colorBlend:p=2,resolution:m=1024,toneMapped:g=!0,...y},w)=>{(0,o.e)({SoftShadowMaterial:d});let v=(0,o.C)(e=>e.gl),x=(0,o.C)(e=>e.scene),b=(0,o.C)(e=>e.camera),M=(0,o.C)(e=>e.invalidate),P=a.useRef(null),A=a.useRef(null),[E]=a.useState(()=>new h(v,x,m));a.useLayoutEffect(()=>{E.configure(P.current)},[]);let T=a.useMemo(()=>({lights:new Map,temporal:!!t,frames:Math.max(2,r),blend:Math.max(2,r===1/0?i:r),count:0,getMesh:()=>P.current,reset:()=>{E.clear();let e=P.current.material;e.opacity=0,e.alphaTest=0,T.count=0},update:(e=1)=>{let t=P.current.material;T.temporal?(t.opacity=Math.min(l,t.opacity+l/T.blend),t.alphaTest=Math.min(u,t.alphaTest+u/T.blend)):(t.opacity=l,t.alphaTest=u),A.current.visible=!0,E.prepare();for(let t=0;t<e;t++)T.lights.forEach(e=>e.update()),E.update(b,T.blend);A.current.visible=!1,E.finish()}}),[E,b,x,t,r,i,l,u]);return a.useLayoutEffect(()=>{T.reset(),T.temporal||T.frames===1/0||T.update(T.blend)}),a.useImperativeHandle(w,()=>T,[T]),(0,o.D)(()=>{(T.temporal||T.frames===1/0)&&T.count<T.frames&&T.count<n&&(M(),T.update(),T.count++)}),a.createElement("group",y,a.createElement("group",{traverse:()=>null,ref:A},a.createElement(c.Provider,{value:T},e)),a.createElement("mesh",{receiveShadow:!0,ref:P,scale:s,rotation:[-Math.PI/2,0,0]},a.createElement("planeGeometry",null),a.createElement("softShadowMaterial",{transparent:!0,depthWrite:!1,toneMapped:g,color:f,blend:p,map:E.progressiveLightMap2.texture})))}),p=a.forwardRef(({castShadow:e=!0,bias:t=.001,mapSize:r=512,size:o=5,near:s=.5,far:l=500,frames:d=1,position:f=[0,0,0],radius:p=1,amount:h=8,intensity:m=u>=155?Math.PI:1,ambient:g=.5,...y},w)=>{let v=a.useRef(null),x=new i.Pq0(...f).length(),b=a.useContext(c),M=a.useCallback(()=>{let e;if(v.current)for(let t=0;t<v.current.children.length;t++)if(e=v.current.children[t],Math.random()>g)e.position.set(f[0]+i.cj9.randFloatSpread(p),f[1]+i.cj9.randFloatSpread(p),f[2]+i.cj9.randFloatSpread(p));else{let t=Math.acos(2*Math.random()-1)-Math.PI/2,r=2*Math.PI*Math.random();e.position.set(Math.cos(t)*Math.cos(r)*x,Math.abs(Math.cos(t)*Math.sin(r)*x),Math.sin(t)*x)}},[p,g,x,...f]),P=a.useMemo(()=>({update:M}),[M]);return a.useImperativeHandle(w,()=>P,[P]),a.useLayoutEffect(()=>{var e;let t=v.current;return b&&(null==(e=b.lights)||e.set(t.uuid,P)),()=>{var e;null==b||null==(e=b.lights)||e.delete(t.uuid)}},[b,P]),a.createElement("group",(0,n.A)({ref:v},y),Array.from({length:h},(n,i)=>a.createElement("directionalLight",{key:i,castShadow:e,"shadow-bias":t,"shadow-mapSize":[r,r],intensity:m/h},a.createElement("orthographicCamera",{attach:"shadow-camera",args:[-o,o,o,-o,s,l]}))))});class h{constructor(e,t,r=1024){this.renderer=e,this.res=r,this.scene=t,this.buffer1Active=!1,this.lights=[],this.meshes=[],this.object=null,this.clearColor=new i.Q1f,this.clearAlpha=0;let n={type:i.ix0,magFilter:i.hxR,minFilter:i.hxR};this.progressiveLightMap1=new i.nWS(this.res,this.res,n),this.progressiveLightMap2=new i.nWS(this.res,this.res,n),this.discardMat=new l,this.targetMat=new i.G_z({fog:!1}),this.previousShadowMap={value:this.progressiveLightMap1.texture},this.averagingWindow={value:100},this.targetMat.onBeforeCompile=e=>{e.vertexShader="varying vec2 vUv;\n"+e.vertexShader.slice(0,-1)+"vUv = uv; gl_Position = vec4((uv - 0.5) * 2.0, 1.0, 1.0); }";let t=e.fragmentShader.indexOf("void main() {");e.fragmentShader="varying vec2 vUv;\n"+e.fragmentShader.slice(0,t)+"uniform sampler2D previousShadowMap;\n	uniform float averagingWindow;\n"+e.fragmentShader.slice(t-1,-1)+`
vec3 texelOld = texture2D(previousShadowMap, vUv).rgb;
        gl_FragColor.rgb = mix(texelOld, gl_FragColor.rgb, 1.0/ averagingWindow);
      }`,e.uniforms.previousShadowMap=this.previousShadowMap,e.uniforms.averagingWindow=this.averagingWindow}}clear(){this.renderer.getClearColor(this.clearColor),this.clearAlpha=this.renderer.getClearAlpha(),this.renderer.setClearColor("black",1),this.renderer.setRenderTarget(this.progressiveLightMap1),this.renderer.clear(),this.renderer.setRenderTarget(this.progressiveLightMap2),this.renderer.clear(),this.renderer.setRenderTarget(null),this.renderer.setClearColor(this.clearColor,this.clearAlpha),this.lights=[],this.meshes=[],this.scene.traverse(e=>{e.geometry?this.meshes.push({object:e,material:e.material}):e.isLight&&this.lights.push({object:e,intensity:e.intensity})})}prepare(){this.lights.forEach(e=>e.object.intensity=0),this.meshes.forEach(e=>e.object.material=this.discardMat)}finish(){this.lights.forEach(e=>e.object.intensity=e.intensity),this.meshes.forEach(e=>e.object.material=e.material)}configure(e){this.object=e}update(e,t=100){if(!this.object)return;this.averagingWindow.value=t,this.object.material=this.targetMat;let r=this.buffer1Active?this.progressiveLightMap1:this.progressiveLightMap2,n=this.buffer1Active?this.progressiveLightMap2:this.progressiveLightMap1,i=this.scene.background;this.scene.background=null,this.renderer.setRenderTarget(r),this.previousShadowMap.value=n.texture,this.buffer1Active=!this.buffer1Active,this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.scene.background=i}}},25571:(e,t,r)=>{let n,i;r.d(t,{n:()=>eg});var a=r(13022),o=r(80600),s=r(6152),l=r(36038),u=r(62972),c=r(8731);let d=new l.Pq0,f=new l.Pq0,p=new l.Pq0,h=new l.I9Y;function m(e,t,r){let n=d.setFromMatrixPosition(e.matrixWorld);n.project(t);let i=r.width/2,a=r.height/2;return[n.x*i+i,-(n.y*a)+a]}let g=e=>1e-10>Math.abs(e)?0:e;function y(e,t,r=""){let n="matrix3d(";for(let r=0;16!==r;r++)n+=g(t[r]*e.elements[r])+(15!==r?",":")");return r+n}let w=(n=[1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1],e=>y(e,n)),v=(i=e=>[1/e,1/e,1/e,1,-1/e,-1/e,-1/e,-1,1/e,1/e,1/e,1,1,1,1,1],(e,t)=>y(e,i(t),"translate(-50%,-50%)")),x=s.forwardRef(({children:e,eps:t=.001,style:r,className:n,prepend:i,center:u,fullscreen:y,portal:x,distanceFactor:b,sprite:M=!1,transform:P=!1,occlude:A,onOcclude:E,castShadow:T,receiveShadow:S,material:B,geometry:C,zIndexRange:_=[0x1000037,0],calculatePosition:I=m,as:R="div",wrapperClass:U,pointerEvents:k="auto",...F},z)=>{let{gl:q,camera:O,scene:D,size:W,raycaster:N,events:L,viewport:j}=(0,o.C)(),[H]=s.useState(()=>document.createElement(R)),G=s.useRef(null),$=s.useRef(null),V=s.useRef(0),X=s.useRef([0,0]),Y=s.useRef(null),Z=s.useRef(null),Q=(null==x?void 0:x.current)||L.connected||q.domElement.parentNode,K=s.useRef(null),J=s.useRef(!1),ee=s.useMemo(()=>A&&"blending"!==A||Array.isArray(A)&&A.length&&function(e){return e&&"object"==typeof e&&"current"in e}(A[0]),[A]);s.useLayoutEffect(()=>{let e=q.domElement;A&&"blending"===A?(e.style.zIndex=`${Math.floor(_[0]/2)}`,e.style.position="absolute",e.style.pointerEvents="none"):(e.style.zIndex=null,e.style.position=null,e.style.pointerEvents=null)},[A]),s.useLayoutEffect(()=>{if($.current){let e=G.current=c.createRoot(H);if(D.updateMatrixWorld(),P)H.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{let e=I($.current,O,W);H.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${e[0]}px,${e[1]}px,0);transform-origin:0 0;`}return Q&&(i?Q.prepend(H):Q.appendChild(H)),()=>{Q&&Q.removeChild(H),e.unmount()}}},[Q,P]),s.useLayoutEffect(()=>{U&&(H.className=U)},[U]);let et=s.useMemo(()=>P?{position:"absolute",top:0,left:0,width:W.width,height:W.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:u?"translate3d(-50%,-50%,0)":"none",...y&&{top:-W.height/2,left:-W.width/2,width:W.width,height:W.height},...r},[r,u,y,W,P]),er=s.useMemo(()=>({position:"absolute",pointerEvents:k}),[k]);s.useLayoutEffect(()=>{var t,i;J.current=!1,P?null==(t=G.current)||t.render(s.createElement("div",{ref:Y,style:et},s.createElement("div",{ref:Z,style:er},s.createElement("div",{ref:z,className:n,style:r,children:e})))):null==(i=G.current)||i.render(s.createElement("div",{ref:z,style:et,className:n,children:e}))});let en=s.useRef(!0);(0,o.D)(e=>{if($.current){O.updateMatrixWorld(),$.current.updateWorldMatrix(!0,!1);let e=P?X.current:I($.current,O,W);if(P||Math.abs(V.current-O.zoom)>t||Math.abs(X.current[0]-e[0])>t||Math.abs(X.current[1]-e[1])>t){let t=function(e,t){let r=d.setFromMatrixPosition(e.matrixWorld),n=f.setFromMatrixPosition(t.matrixWorld),i=r.sub(n),a=t.getWorldDirection(p);return i.angleTo(a)>Math.PI/2}($.current,O),r=!1;ee&&(Array.isArray(A)?r=A.map(e=>e.current):"blending"!==A&&(r=[D]));let n=en.current;r?en.current=function(e,t,r,n){let i=d.setFromMatrixPosition(e.matrixWorld),a=i.clone();a.project(t),h.set(a.x,a.y),r.setFromCamera(h,t);let o=r.intersectObjects(n,!0);if(o.length){let e=o[0].distance;return i.distanceTo(r.ray.origin)<e}return!0}($.current,O,N,r)&&!t:en.current=!t,n!==en.current&&(E?E(!en.current):H.style.display=en.current?"block":"none");let i=Math.floor(_[0]/2),a=A?ee?[_[0],i]:[i-1,0]:_;if(H.style.zIndex=`${function(e,t,r){if(t instanceof l.ubm||t instanceof l.qUd){let n=d.setFromMatrixPosition(e.matrixWorld),i=f.setFromMatrixPosition(t.matrixWorld),a=n.distanceTo(i),o=(r[1]-r[0])/(t.far-t.near),s=r[1]-o*t.far;return Math.round(o*a+s)}}($.current,O,a)}`,P){let[e,t]=[W.width/2,W.height/2],r=O.projectionMatrix.elements[5]*t,{isOrthographicCamera:n,top:i,left:a,bottom:o,right:s}=O,l=w(O.matrixWorldInverse),u=n?`scale(${r})translate(${g(-(s+a)/2)}px,${g((i+o)/2)}px)`:`translateZ(${r}px)`,c=$.current.matrixWorld;M&&((c=O.matrixWorldInverse.clone().transpose().copyPosition(c).scale($.current.scale)).elements[3]=c.elements[7]=c.elements[11]=0,c.elements[15]=1),H.style.width=W.width+"px",H.style.height=W.height+"px",H.style.perspective=n?"":`${r}px`,Y.current&&Z.current&&(Y.current.style.transform=`${u}${l}translate(${e}px,${t}px)`,Z.current.style.transform=v(c,1/((b||10)/400)))}else{let t=void 0===b?1:function(e,t){if(t instanceof l.qUd)return t.zoom;if(!(t instanceof l.ubm))return 1;{let r=d.setFromMatrixPosition(e.matrixWorld),n=f.setFromMatrixPosition(t.matrixWorld);return 1/(2*Math.tan(t.fov*Math.PI/180/2)*r.distanceTo(n))}}($.current,O)*b;H.style.transform=`translate3d(${e[0]}px,${e[1]}px,0) scale(${t})`}X.current=e,V.current=O.zoom}}if(!ee&&K.current&&!J.current)if(P){if(Y.current){let e=Y.current.children[0];if(null!=e&&e.clientWidth&&null!=e&&e.clientHeight){let{isOrthographicCamera:t}=O;if(t||C)F.scale&&(Array.isArray(F.scale)?F.scale instanceof l.Pq0?K.current.scale.copy(F.scale.clone().divideScalar(1)):K.current.scale.set(1/F.scale[0],1/F.scale[1],1/F.scale[2]):K.current.scale.setScalar(1/F.scale));else{let t=(b||10)/400,r=e.clientWidth*t,n=e.clientHeight*t;K.current.scale.set(r,n,1)}J.current=!0}}}else{let t=H.children[0];if(null!=t&&t.clientWidth&&null!=t&&t.clientHeight){let e=1/j.factor,r=t.clientWidth*e,n=t.clientHeight*e;K.current.scale.set(r,n,1),J.current=!0}K.current.lookAt(e.camera.position)}});let ei=s.useMemo(()=>({vertexShader:P?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[P]);return s.createElement("group",(0,a.A)({},F,{ref:$}),A&&!ee&&s.createElement("mesh",{castShadow:T,receiveShadow:S,ref:K},C||s.createElement("planeGeometry",null),B||s.createElement("shaderMaterial",{side:l.$EB,vertexShader:ei.vertexShader,fragmentShader:ei.fragmentShader})))}),b=s.createContext(null),M=new l.Pq0,P=new l.Pq0,A=new l.Pq0(0,1,0),E=new l.kn4,T=({direction:e,axis:t})=>{let{translation:r,translationLimits:n,annotations:i,annotationsClass:a,depthTest:c,scale:d,lineWidth:f,fixed:p,axisColors:h,hoveredColor:m,opacity:g,onDragStart:y,onDrag:w,onDragEnd:v,userData:T}=s.useContext(b),S=(0,o.C)(e=>e.controls),B=s.useRef(null),C=s.useRef(null),_=s.useRef(null),I=s.useRef(0),[R,U]=s.useState(!1),k=s.useCallback(n=>{i&&(B.current.innerText=`${r.current[t].toFixed(2)}`,B.current.style.display="block"),n.stopPropagation();let a=new l.kn4().extractRotation(C.current.matrixWorld),o=n.point.clone(),s=new l.Pq0().setFromMatrixPosition(C.current.matrixWorld),u=e.clone().applyMatrix4(a).normalize();_.current={clickPoint:o,dir:u},I.current=r.current[t],y({component:"Arrow",axis:t,origin:s,directions:[u]}),S&&(S.enabled=!1),n.target.setPointerCapture(n.pointerId)},[i,e,S,y,r,t]),F=s.useCallback(e=>{if(e.stopPropagation(),R||U(!0),_.current){let{clickPoint:a,dir:o}=_.current,[s,l]=(null==n?void 0:n[t])||[void 0,void 0],u=((e,t,r,n)=>{let i=t.dot(t),a=t.dot(e)-t.dot(r),o=t.dot(n);return 0===o?-a/i:(M.copy(n).multiplyScalar(i/o).sub(t),P.copy(n).multiplyScalar(a/o).add(r).sub(e),-M.dot(P)/M.dot(M))})(a,o,e.ray.origin,e.ray.direction);void 0!==s&&(u=Math.max(u,s-I.current)),void 0!==l&&(u=Math.min(u,l-I.current)),r.current[t]=I.current+u,i&&(B.current.innerText=`${r.current[t].toFixed(2)}`),E.makeTranslation(o.x*u,o.y*u,o.z*u),w(E)}},[i,w,R,r,n,t]),z=s.useCallback(e=>{i&&(B.current.style.display="none"),e.stopPropagation(),_.current=null,v(),S&&(S.enabled=!0),e.target.releasePointerCapture(e.pointerId)},[i,S,v]),q=s.useCallback(e=>{e.stopPropagation(),U(!1)},[]),{cylinderLength:O,coneWidth:D,coneLength:W,matrixL:N}=s.useMemo(()=>{let t=p?f/d*1.6:d/20,r=p?.2:d/5,n=p?1-r:d-r,i=new l.PTz().setFromUnitVectors(A,e.clone().normalize());return{cylinderLength:n,coneWidth:t,coneLength:r,matrixL:new l.kn4().makeRotationFromQuaternion(i)}},[e,d,f,p]),L=R?m:h[t];return s.createElement("group",{ref:C},s.createElement("group",{matrix:N,matrixAutoUpdate:!1,onPointerDown:k,onPointerMove:F,onPointerUp:z,onPointerOut:q},i&&s.createElement(x,{position:[0,-W,0]},s.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:a,ref:B})),s.createElement("mesh",{visible:!1,position:[0,(O+W)/2,0],userData:T},s.createElement("cylinderGeometry",{args:[1.4*D,1.4*D,O+W,8,1]})),s.createElement(u.N,{transparent:!0,raycast:()=>null,depthTest:c,points:[0,0,0,0,O,0],lineWidth:f,side:l.$EB,color:L,opacity:g,polygonOffset:!0,renderOrder:1,polygonOffsetFactor:-10,fog:!1}),s.createElement("mesh",{raycast:()=>null,position:[0,O+W/2,0],renderOrder:500},s.createElement("coneGeometry",{args:[D,W,24,1]}),s.createElement("meshBasicMaterial",{transparent:!0,depthTest:c,color:L,opacity:g,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))))},S=new l.Pq0,B=new l.Pq0,C=e=>180*e/Math.PI,_=e=>{let t=((e,t)=>{let r=Math.floor(e/t);return e-(r=r<0?r+1:r)*t})(e,2*Math.PI);return 1e-6>Math.abs(t)?0:(t<0&&(t+=2*Math.PI),t)},I=new l.kn4,R=new l.Pq0,U=new l.RlV,k=new l.Pq0,F=({dir1:e,dir2:t,axis:r})=>{let{rotationLimits:n,annotations:i,annotationsClass:a,depthTest:c,scale:d,lineWidth:f,fixed:p,axisColors:h,hoveredColor:m,opacity:g,onDragStart:y,onDrag:w,onDragEnd:v,userData:M}=s.useContext(b),P=(0,o.C)(e=>e.controls),A=s.useRef(null),E=s.useRef(null),T=s.useRef(0),F=s.useRef(0),z=s.useRef(null),[q,O]=s.useState(!1),D=s.useCallback(e=>{i&&(A.current.innerText=`${C(F.current).toFixed(0)}\xba`,A.current.style.display="block"),e.stopPropagation();let t=e.point.clone(),n=new l.Pq0().setFromMatrixPosition(E.current.matrixWorld),a=new l.Pq0().setFromMatrixColumn(E.current.matrixWorld,0).normalize(),o=new l.Pq0().setFromMatrixColumn(E.current.matrixWorld,1).normalize(),s=new l.Pq0().setFromMatrixColumn(E.current.matrixWorld,2).normalize(),u=new l.Zcv().setFromNormalAndCoplanarPoint(s,n);z.current={clickPoint:t,origin:n,e1:a,e2:o,normal:s,plane:u},y({component:"Rotator",axis:r,origin:n,directions:[a,o,s]}),P&&(P.enabled=!1),e.target.setPointerCapture(e.pointerId)},[i,P,y,r]),W=s.useCallback(e=>{if(e.stopPropagation(),q||O(!0),z.current){let{clickPoint:t,origin:a,e1:o,e2:s,normal:u,plane:c}=z.current,[d,f]=(null==n?void 0:n[r])||[void 0,void 0];U.copy(e.ray),U.intersectPlane(c,k),U.direction.negate(),U.intersectPlane(c,k);let p=((e,t,r,n,i)=>{S.copy(e).sub(r),B.copy(t).sub(r);let a=n.dot(n),o=i.dot(i),s=S.dot(n)/a,l=S.dot(i)/o,u=B.dot(n)/a;return Math.atan2(B.dot(i)/o,u)-Math.atan2(l,s)})(t,k,a,o,s),h=C(p);e.shiftKey&&(p=(h=10*Math.round(h/10))*Math.PI/180),void 0!==d&&void 0!==f&&f-d<2*Math.PI?(p=(p=_(p))>Math.PI?p-2*Math.PI:p,p=l.cj9.clamp(p,d-T.current,f-T.current),F.current=T.current+p):(F.current=_(T.current+p),F.current=F.current>Math.PI?F.current-2*Math.PI:F.current),i&&(h=C(F.current),A.current.innerText=`${h.toFixed(0)}\xba`),I.makeRotationAxis(u,p),R.copy(a).applyMatrix4(I).sub(a).negate(),I.setPosition(R),w(I)}},[i,w,q,n,r]),N=s.useCallback(e=>{i&&(A.current.style.display="none"),e.stopPropagation(),T.current=F.current,z.current=null,v(),P&&(P.enabled=!0),e.target.releasePointerCapture(e.pointerId)},[i,P,v]),L=s.useCallback(e=>{e.stopPropagation(),O(!1)},[]),j=s.useMemo(()=>{let r=e.clone().normalize(),n=t.clone().normalize();return new l.kn4().makeBasis(r,n,r.clone().cross(n))},[e,t]),H=p?.65:.65*d,G=s.useMemo(()=>{let e=[];for(let t=0;t<=32;t++){let r=Math.PI/2*t/32;e.push(new l.Pq0(Math.cos(r)*H,Math.sin(r)*H,0))}return e},[H]);return s.createElement("group",{ref:E,onPointerDown:D,onPointerMove:W,onPointerUp:N,onPointerOut:L,matrix:j,matrixAutoUpdate:!1},i&&s.createElement(x,{position:[H,H,0]},s.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:a,ref:A})),s.createElement(u.N,{points:G,lineWidth:4*f,visible:!1,userData:M}),s.createElement(u.N,{transparent:!0,raycast:()=>null,depthTest:c,points:G,lineWidth:f,side:l.$EB,color:q?m:h[r],opacity:g,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))},z=new l.RlV,q=new l.Pq0,O=new l.kn4,D=({dir1:e,dir2:t,axis:r})=>{let{translation:n,translationLimits:i,annotations:a,annotationsClass:c,depthTest:d,scale:f,lineWidth:p,fixed:h,axisColors:m,hoveredColor:g,opacity:y,onDragStart:w,onDrag:v,onDragEnd:M,userData:P}=s.useContext(b),A=(0,o.C)(e=>e.controls),E=s.useRef(null),T=s.useRef(null),S=s.useRef(null),B=s.useRef(0),C=s.useRef(0),[_,I]=s.useState(!1),R=s.useCallback(e=>{a&&(E.current.innerText=`${n.current[(r+1)%3].toFixed(2)}, ${n.current[(r+2)%3].toFixed(2)}`,E.current.style.display="block"),e.stopPropagation();let t=e.point.clone(),i=new l.Pq0().setFromMatrixPosition(T.current.matrixWorld),o=new l.Pq0().setFromMatrixColumn(T.current.matrixWorld,0).normalize(),s=new l.Pq0().setFromMatrixColumn(T.current.matrixWorld,1).normalize(),u=new l.Pq0().setFromMatrixColumn(T.current.matrixWorld,2).normalize();S.current={clickPoint:t,e1:o,e2:s,plane:new l.Zcv().setFromNormalAndCoplanarPoint(u,i)},B.current=n.current[(r+1)%3],C.current=n.current[(r+2)%3],w({component:"Slider",axis:r,origin:i,directions:[o,s,u]}),A&&(A.enabled=!1),e.target.setPointerCapture(e.pointerId)},[a,A,w,r]),U=s.useCallback(e=>{if(e.stopPropagation(),_||I(!0),S.current){let{clickPoint:t,e1:o,e2:s,plane:l}=S.current,[u,c]=(null==i?void 0:i[(r+1)%3])||[void 0,void 0],[d,f]=(null==i?void 0:i[(r+2)%3])||[void 0,void 0];z.copy(e.ray),z.intersectPlane(l,q),z.direction.negate(),z.intersectPlane(l,q),q.sub(t);let[p,h]=((e,t,r)=>{let n=Math.abs(e.x)>=Math.abs(e.y)&&Math.abs(e.x)>=Math.abs(e.z)?0:Math.abs(e.y)>=Math.abs(e.x)&&Math.abs(e.y)>=Math.abs(e.z)?1:2,i=[0,1,2].sort((e,r)=>Math.abs(t.getComponent(r))-Math.abs(t.getComponent(e))),a=n===i[0]?i[1]:i[0],o=e.getComponent(n),s=e.getComponent(a),l=t.getComponent(n),u=t.getComponent(a),c=r.getComponent(n),d=(r.getComponent(a)-s/o*c)/(u-s/o*l);return[(c-d*l)/o,d]})(o,s,q);void 0!==u&&(p=Math.max(p,u-B.current)),void 0!==c&&(p=Math.min(p,c-B.current)),void 0!==d&&(h=Math.max(h,d-C.current)),void 0!==f&&(h=Math.min(h,f-C.current)),n.current[(r+1)%3]=B.current+p,n.current[(r+2)%3]=C.current+h,a&&(E.current.innerText=`${n.current[(r+1)%3].toFixed(2)}, ${n.current[(r+2)%3].toFixed(2)}`),O.makeTranslation(p*o.x+h*s.x,p*o.y+h*s.y,p*o.z+h*s.z),v(O)}},[a,v,_,n,i,r]),k=s.useCallback(e=>{a&&(E.current.style.display="none"),e.stopPropagation(),S.current=null,M(),A&&(A.enabled=!0),e.target.releasePointerCapture(e.pointerId)},[a,A,M]),F=s.useCallback(e=>{e.stopPropagation(),I(!1)},[]),D=s.useMemo(()=>{let r=e.clone().normalize(),n=t.clone().normalize();return new l.kn4().makeBasis(r,n,r.clone().cross(n))},[e,t]),W=h?1/7:f/7,N=h?.225:.225*f,L=_?g:m[r],j=s.useMemo(()=>[new l.Pq0(0,0,0),new l.Pq0(0,N,0),new l.Pq0(N,N,0),new l.Pq0(N,0,0),new l.Pq0(0,0,0)],[N]);return s.createElement("group",{ref:T,matrix:D,matrixAutoUpdate:!1},a&&s.createElement(x,{position:[0,0,0]},s.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:c,ref:E})),s.createElement("group",{position:[1.7*W,1.7*W,0]},s.createElement("mesh",{visible:!0,onPointerDown:R,onPointerMove:U,onPointerUp:k,onPointerOut:F,scale:N,userData:P},s.createElement("planeGeometry",null),s.createElement("meshBasicMaterial",{transparent:!0,depthTest:d,color:L,polygonOffset:!0,polygonOffsetFactor:-10,side:l.$EB,fog:!1})),s.createElement(u.N,{position:[-N/2,-N/2,0],transparent:!0,depthTest:d,points:j,lineWidth:p,color:L,opacity:y,polygonOffset:!0,polygonOffsetFactor:-10,userData:P,fog:!1})))},W=new l.Pq0,N=new l.Pq0,L=new l.Pq0,j=(e,t,r,n=1)=>{let i=W.set(e.x/r.width*2-1,-(2*(e.y/r.height))+1,n);return i.unproject(t),i},H=(e,t,r,n)=>{let i=((e,t,r)=>{let n=r.width/2,i=r.height/2;t.updateMatrixWorld(!1);let a=e.project(t);return a.x=a.x*n+n,a.y=-(a.y*i)+i,a})(L.copy(e),r,n),a=0;for(let o=0;o<2;++o){let s=N.copy(i).setComponent(o,i.getComponent(o)+t),l=j(s,r,n,s.z);a=Math.max(a,e.distanceTo(l))}return a},G=new l.Pq0,$=new l.Pq0,V=new l.Pq0(0,1,0),X=new l.Pq0,Y=new l.kn4,Z=({direction:e,axis:t})=>{let{scaleLimits:r,annotations:n,annotationsClass:i,depthTest:a,scale:u,lineWidth:c,fixed:d,axisColors:f,hoveredColor:p,opacity:h,onDragStart:m,onDrag:g,onDragEnd:y,userData:w}=s.useContext(b),v=(0,o.C)(e=>e.size),M=(0,o.C)(e=>e.controls),P=s.useRef(null),A=s.useRef(null),E=s.useRef(null),T=s.useRef(1),S=s.useRef(1),B=s.useRef(null),[C,_]=s.useState(!1),I=d?1.2:1.2*u,R=s.useCallback(r=>{n&&(P.current.innerText=`${S.current.toFixed(2)}`,P.current.style.display="block"),r.stopPropagation();let i=new l.kn4().extractRotation(A.current.matrixWorld),a=r.point.clone(),o=new l.Pq0().setFromMatrixPosition(A.current.matrixWorld),s=e.clone().applyMatrix4(i).normalize(),c=A.current.matrixWorld.clone(),f=c.clone().invert();B.current={clickPoint:a,dir:s,mPLG:c,mPLGInv:f,offsetMultiplier:d?1/H(A.current.getWorldPosition(G),u,r.camera,v):1},m({component:"Sphere",axis:t,origin:o,directions:[s]}),M&&(M.enabled=!1),r.target.setPointerCapture(r.pointerId)},[n,M,e,m,t,d,u,v]),U=s.useCallback(e=>{if(e.stopPropagation(),C||_(!0),B.current){let{clickPoint:i,dir:a,mPLG:o,mPLGInv:s,offsetMultiplier:l}=B.current,[c,f]=(null==r?void 0:r[t])||[1e-5,void 0],p=((e,t,r,n)=>{let i=t.dot(t),a=t.dot(e)-t.dot(r),o=t.dot(n);return 0===o?-a/i:(G.copy(n).multiplyScalar(i/o).sub(t),$.copy(n).multiplyScalar(a/o).add(r).sub(e),-G.dot($)/G.dot(G))})(i,a,e.ray.origin,e.ray.direction)*l,h=Math.pow(2,.2*(d?p:p/u));e.shiftKey&&(h=Math.round(10*h)/10),h=Math.max(h,c/T.current),void 0!==f&&(h=Math.min(h,f/T.current)),S.current=T.current*h,E.current.position.set(0,I+p,0),n&&(P.current.innerText=`${S.current.toFixed(2)}`),X.set(1,1,1),X.setComponent(t,h),Y.makeScale(X.x,X.y,X.z).premultiply(o).multiply(s),g(Y)}},[n,I,g,C,r,t]),k=s.useCallback(e=>{n&&(P.current.style.display="none"),e.stopPropagation(),T.current=S.current,B.current=null,E.current.position.set(0,I,0),y(),M&&(M.enabled=!0),e.target.releasePointerCapture(e.pointerId)},[n,M,y,I]),F=s.useCallback(e=>{e.stopPropagation(),_(!1)},[]),{radius:z,matrixL:q}=s.useMemo(()=>{let t=d?c/u*1.8:u/22.5,r=new l.PTz().setFromUnitVectors(V,e.clone().normalize());return{radius:t,matrixL:new l.kn4().makeRotationFromQuaternion(r)}},[e,u,c,d]),O=C?p:f[t];return s.createElement("group",{ref:A},s.createElement("group",{matrix:q,matrixAutoUpdate:!1,onPointerDown:R,onPointerMove:U,onPointerUp:k,onPointerOut:F},n&&s.createElement(x,{position:[0,I/2,0]},s.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:i,ref:P})),s.createElement("mesh",{ref:E,position:[0,I,0],renderOrder:500,userData:w},s.createElement("sphereGeometry",{args:[z,12,12]}),s.createElement("meshBasicMaterial",{transparent:!0,depthTest:a,color:O,opacity:h,polygonOffset:!0,polygonOffsetFactor:-10}))))},Q=new l.kn4,K=new l.kn4,J=new l.kn4,ee=new l.kn4,et=new l.kn4,er=new l.kn4,en=new l.kn4,ei=new l.kn4,ea=new l.kn4,eo=new l.NRn,es=new l.NRn,el=new l.Pq0,eu=new l.Pq0,ec=new l.Pq0,ed=new l.Pq0,ef=new l.Pq0,ep=new l.Pq0(1,0,0),eh=new l.Pq0(0,1,0),em=new l.Pq0(0,0,1),eg=s.forwardRef(({enabled:e=!0,matrix:t,onDragStart:r,onDrag:n,onDragEnd:i,autoTransform:u=!0,anchor:c,disableAxes:d=!1,disableSliders:f=!1,disableRotations:p=!1,disableScaling:h=!1,activeAxes:m=[!0,!0,!0],offset:g=[0,0,0],rotation:y=[0,0,0],scale:w=1,lineWidth:v=4,fixed:x=!1,translationLimits:M,rotationLimits:P,scaleLimits:A,depthTest:E=!0,axisColors:S=["#ff2060","#20df80","#2080ff"],hoveredColor:B="#ffff40",annotations:C=!1,annotationsClass:_,opacity:I=1,visible:R=!0,userData:U,children:k,...z},q)=>{let O=(0,o.C)(e=>e.invalidate),W=s.useRef(null),N=s.useRef(null),L=s.useRef(null),j=s.useRef(null),G=s.useRef([0,0,0]),$=s.useRef(new l.Pq0(1,1,1)),V=s.useRef(new l.Pq0(1,1,1));s.useLayoutEffect(()=>{c&&(j.current.updateWorldMatrix(!0,!0),ee.copy(j.current.matrixWorld).invert(),eo.makeEmpty(),j.current.traverse(e=>{e.geometry&&(e.geometry.boundingBox||e.geometry.computeBoundingBox(),er.copy(e.matrixWorld).premultiply(ee),es.copy(e.geometry.boundingBox),es.applyMatrix4(er),eo.union(es))}),el.copy(eo.max).add(eo.min).multiplyScalar(.5),eu.copy(eo.max).sub(eo.min).multiplyScalar(.5),ec.copy(eu).multiply(new l.Pq0(...c)).add(el),ed.set(...g).add(ec),L.current.position.copy(ed),O())});let X=s.useMemo(()=>({onDragStart:e=>{Q.copy(N.current.matrix),K.copy(N.current.matrixWorld),r&&r(e),O()},onDrag:e=>{J.copy(W.current.matrixWorld),ee.copy(J).invert(),et.copy(K).premultiply(e),er.copy(et).premultiply(ee),en.copy(Q).invert(),ei.copy(er).multiply(en),u&&N.current.matrix.copy(er),n&&n(er,ei,et,e),O()},onDragEnd:()=>{i&&i(),O()},translation:G,translationLimits:M,rotationLimits:P,axisColors:S,hoveredColor:B,opacity:I,scale:w,lineWidth:v,fixed:x,depthTest:E,userData:U,annotations:C,annotationsClass:_}),[r,n,i,G,M,P,A,E,w,v,x,...S,B,I,U,u,C,_]),Y=new l.Pq0;return(0,o.D)(e=>{if(x){let t=H(L.current.getWorldPosition(Y),w,e.camera,e.size);$.current.setScalar(t)}t&&t instanceof l.kn4&&(N.current.matrix=t),N.current.updateWorldMatrix(!0,!0),ea.makeRotationFromEuler(L.current.rotation).setPosition(L.current.position).premultiply(N.current.matrixWorld),V.current.setFromMatrixScale(ea),ef.copy($.current).divide(V.current),(Math.abs(L.current.scale.x-ef.x)>1e-4||Math.abs(L.current.scale.y-ef.y)>1e-4||Math.abs(L.current.scale.z-ef.z)>1e-4)&&(L.current.scale.copy(ef),e.invalidate())}),s.useImperativeHandle(q,()=>N.current,[]),s.createElement(b.Provider,{value:X},s.createElement("group",{ref:W},s.createElement("group",(0,a.A)({ref:N,matrix:t,matrixAutoUpdate:!1},z),s.createElement("group",{visible:R,ref:L,position:g,rotation:y},e&&s.createElement(s.Fragment,null,!d&&m[0]&&s.createElement(T,{axis:0,direction:ep}),!d&&m[1]&&s.createElement(T,{axis:1,direction:eh}),!d&&m[2]&&s.createElement(T,{axis:2,direction:em}),!f&&m[0]&&m[1]&&s.createElement(D,{axis:2,dir1:ep,dir2:eh}),!f&&m[0]&&m[2]&&s.createElement(D,{axis:1,dir1:em,dir2:ep}),!f&&m[2]&&m[1]&&s.createElement(D,{axis:0,dir1:eh,dir2:em}),!p&&m[0]&&m[1]&&s.createElement(F,{axis:2,dir1:ep,dir2:eh}),!p&&m[0]&&m[2]&&s.createElement(F,{axis:1,dir1:em,dir2:ep}),!p&&m[2]&&m[1]&&s.createElement(F,{axis:0,dir1:eh,dir2:em}),!h&&m[0]&&s.createElement(Z,{axis:0,direction:ep}),!h&&m[1]&&s.createElement(Z,{axis:1,direction:eh}),!h&&m[2]&&s.createElement(Z,{axis:2,direction:em}))),s.createElement("group",{ref:j},k))))})},57322:(e,t,r)=>{let n,i;r.d(t,{Lr:()=>t7,C6:()=>t8,V2:()=>t5,ZO:()=>t9});var a=r(63535),o=r(6152),s=r(80600),l=r(36038);let u=Symbol("SKIP_GENERATION");function c(e){return(e.index?e.index.count:e.attributes.position.count)/3}function d(e){let t=c(e),r=e.drawRange,n=r.start/3,i=(r.start+r.count)/3,a=Math.max(0,n),o=Math.min(t,i)-a;return[{offset:Math.floor(a),count:Math.floor(o)}]}function f(e){if(!e.groups||!e.groups.length)return d(e);let t=[],r=new Set,n=e.drawRange,i=n.start/3,a=(n.start+n.count)/3;for(let t of e.groups){let e=t.start/3,n=(t.start+t.count)/3;r.add(Math.max(i,e)),r.add(Math.min(a,n))}let o=Array.from(r.values()).sort((e,t)=>e-t);for(let e=0;e<o.length-1;e++){let r=o[e],n=o[e+1];t.push({offset:Math.floor(r),count:Math.floor(n-r)})}return t}function p(e,t,r){return r.min.x=t[e],r.min.y=t[e+1],r.min.z=t[e+2],r.max.x=t[e+3],r.max.y=t[e+4],r.max.z=t[e+5],r}function h(e){let t=-1,r=-1/0;for(let n=0;n<3;n++){let i=e[n+3]-e[n];i>r&&(r=i,t=n)}return t}function m(e,t,r){let n,i;for(let a=0;a<3;a++){let o=a+3;n=e[a],i=t[a],r[a]=n<i?n:i,n=e[o],i=t[o],r[o]=n>i?n:i}}function g(e,t,r){for(let n=0;n<3;n++){let i=t[e+2*n],a=t[e+2*n+1],o=i-a,s=i+a;o<r[n]&&(r[n]=o),s>r[n+3]&&(r[n+3]=s)}}function y(e){let t=e[3]-e[0],r=e[4]-e[1],n=e[5]-e[2];return 2*(t*r+r*n+n*t)}function w(e,t,r,n,i=null){let a=1/0,o=1/0,s=1/0,l=-1/0,u=-1/0,c=-1/0,d=1/0,f=1/0,p=1/0,h=-1/0,m=-1/0,g=-1/0,y=null!==i;for(let n=6*t,i=(t+r)*6;n<i;n+=6){let t=e[n+0],r=e[n+1],i=t-r,w=t+r;i<a&&(a=i),w>l&&(l=w),y&&t<d&&(d=t),y&&t>h&&(h=t);let v=e[n+2],x=e[n+3],b=v-x,M=v+x;b<o&&(o=b),M>u&&(u=M),y&&v<f&&(f=v),y&&v>m&&(m=v);let P=e[n+4],A=e[n+5],E=P-A,T=P+A;E<s&&(s=E),T>c&&(c=T),y&&P<p&&(p=P),y&&P>g&&(g=P)}n[0]=a,n[1]=o,n[2]=s,n[3]=l,n[4]=u,n[5]=c,y&&(i[0]=d,i[1]=f,i[2]=p,i[3]=h,i[4]=m,i[5]=g)}let v=(e,t)=>e.candidate-t.candidate,x=Array(32).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),b=new Float32Array(6);class M{constructor(){}}function P(e,t,r,n,i,a){let o=n,s=n+i-1,l=a.pos,u=2*a.axis;for(;;){for(;o<=s&&r[6*o+u]<l;)o++;for(;o<=s&&r[6*s+u]>=l;)s--;if(!(o<s))return o;for(let e=0;e<3;e++){let r=t[3*o+e];t[3*o+e]=t[3*s+e],t[3*s+e]=r}for(let e=0;e<6;e++){let t=r[6*o+e];r[6*o+e]=r[6*s+e],r[6*s+e]=t}o++,s--}}function A(e,t,r,n,i,a){let o=n,s=n+i-1,l=a.pos,u=2*a.axis;for(;;){for(;o<=s&&r[6*o+u]<l;)o++;for(;o<=s&&r[6*s+u]>=l;)s--;if(!(o<s))return o;{let t=e[o];e[o]=e[s],e[s]=t;for(let e=0;e<6;e++){let t=r[6*o+e];r[6*o+e]=r[6*s+e],r[6*s+e]=t}o++,s--}}}class E{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let r=1/0,n=-1/0;for(let i=0,a=e.length;i<a;i++){let a=e[i][t];r=a<r?a:r,n=a>n?a:n}this.min=r,this.max=n}setFromPoints(e,t){let r=1/0,n=-1/0;for(let i=0,a=t.length;i<a;i++){let a=t[i],o=e.dot(a);r=o<r?o:r,n=o>n?o:n}this.min=r,this.max=n}isSeparated(e){return this.min>e.max||e.min>this.max}}E.prototype.setFromBox=function(){let e=new l.Pq0;return function(t,r){let n=r.min,i=r.max,a=1/0,o=-1/0;for(let r=0;r<=1;r++)for(let s=0;s<=1;s++)for(let l=0;l<=1;l++){e.x=n.x*r+i.x*(1-r),e.y=n.y*s+i.y*(1-s),e.z=n.z*l+i.z*(1-l);let u=t.dot(e);a=Math.min(u,a),o=Math.max(u,o)}this.min=a,this.max=o}}(),new E;let T=function(){let e=new l.Pq0,t=new l.Pq0,r=new l.Pq0;return function(n,i,a){let o,s,l=n.start,u=i.start;r.subVectors(l,u),e.subVectors(n.end,n.start),t.subVectors(i.end,i.start);let c=r.dot(t),d=t.dot(e),f=t.dot(t),p=r.dot(e),h=e.dot(e)*f-d*d;o=0!==h?(c*d-p*f)/h:0,s=(c+o*d)/f,a.x=o,a.y=s}}(),S=function(){let e=new l.I9Y,t=new l.Pq0,r=new l.Pq0;return function(n,i,a,o){T(n,i,e);let s=e.x,l=e.y;if(s>=0&&s<=1&&l>=0&&l<=1){n.at(s,a),i.at(l,o);return}if(s>=0&&s<=1){l<0?i.at(0,o):i.at(1,o),n.closestPointToPoint(o,!0,a);return}if(l>=0&&l<=1){s<0?n.at(0,a):n.at(1,a),i.closestPointToPoint(a,!0,o);return}{let e,u;if(e=s<0?n.start:n.end,u=l<0?i.start:i.end,n.closestPointToPoint(u,!0,t),i.closestPointToPoint(e,!0,r),t.distanceToSquared(u)<=r.distanceToSquared(e)){a.copy(t),o.copy(u);return}a.copy(e),o.copy(r);return}}}(),B=function(){let e=new l.Pq0,t=new l.Pq0,r=new l.Zcv,n=new l.cZY;return function(i,a){let{radius:o,center:s}=i,{a:l,b:u,c}=a;if(n.start=l,n.end=u,n.closestPointToPoint(s,!0,e).distanceTo(s)<=o||(n.start=l,n.end=c,n.closestPointToPoint(s,!0,e).distanceTo(s)<=o)||(n.start=u,n.end=c,n.closestPointToPoint(s,!0,e).distanceTo(s)<=o))return!0;let d=a.getPlane(r);if(Math.abs(d.distanceToPoint(s))<=o){let e=d.projectPoint(s,t);if(a.containsPoint(e))return!0}return!1}}();function C(e){return 1e-15>Math.abs(e)}class _ extends l.lMl{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=[,,,,].fill().map(()=>new l.Pq0),this.satBounds=[,,,,].fill().map(()=>new E),this.points=[this.a,this.b,this.c],this.sphere=new l.iyt,this.plane=new l.Zcv,this.needsUpdate=!0}intersectsSphere(e){return B(e,this)}update(){let e=this.a,t=this.b,r=this.c,n=this.points,i=this.satAxes,a=this.satBounds,o=i[0],s=a[0];this.getNormal(o),s.setFromPoints(o,n);let l=i[1],u=a[1];l.subVectors(e,t),u.setFromPoints(l,n);let c=i[2],d=a[2];c.subVectors(t,r),d.setFromPoints(c,n);let f=i[3],p=a[3];f.subVectors(r,e),p.setFromPoints(f,n),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(o,e),this.needsUpdate=!1}}_.prototype.closestPointToSegment=function(){let e=new l.Pq0,t=new l.Pq0,r=new l.cZY;return function(n,i=null,a=null){let o,{start:s,end:l}=n,u=this.points,c=1/0;for(let s=0;s<3;s++){let l=(s+1)%3;r.start.copy(u[s]),r.end.copy(u[l]),S(r,n,e,t),(o=e.distanceToSquared(t))<c&&(c=o,i&&i.copy(e),a&&a.copy(t))}return this.closestPointToPoint(s,e),(o=s.distanceToSquared(e))<c&&(c=o,i&&i.copy(e),a&&a.copy(s)),this.closestPointToPoint(l,e),(o=l.distanceToSquared(e))<c&&(c=o,i&&i.copy(e),a&&a.copy(l)),Math.sqrt(c)}}(),_.prototype.intersectsTriangle=function(){let e=new _,t=[,,,],r=[,,,],n=new E,i=new E,a=new l.Pq0,o=new l.Pq0,s=new l.Pq0,u=new l.Pq0,c=new l.Pq0,d=new l.cZY,f=new l.cZY,p=new l.cZY,h=new l.Pq0;function m(e,t,r){let n=e.points,i=0,a=-1;for(let e=0;e<3;e++){let{start:s,end:l}=d;s.copy(n[e]),l.copy(n[(e+1)%3]),d.delta(o);let u=C(t.distanceToPoint(s));if(C(t.normal.dot(o))&&u){r.copy(d),i=2;break}let c=t.intersectLine(d,h);if(!c&&u&&h.copy(s),(c||u)&&!C(h.distanceTo(l))){if(i<=1)(1===i?r.start:r.end).copy(h),u&&(a=i);else if(i>=2){(1===a?r.start:r.end).copy(h),i=2;break}if(2==++i&&-1===a)break}}return i}return function(o,l=null,d=!1){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(e.copy(o),e.update(),o=e);let h=this.plane,g=o.plane;if(Math.abs(h.normal.dot(g.normal))>1-1e-10){let e=this.satBounds,s=this.satAxes;r[0]=o.a,r[1]=o.b,r[2]=o.c;for(let t=0;t<4;t++){let i=e[t],a=s[t];if(n.setFromPoints(a,r),i.isSeparated(n))return!1}let u=o.satBounds,c=o.satAxes;t[0]=this.a,t[1]=this.b,t[2]=this.c;for(let e=0;e<4;e++){let r=u[e],i=c[e];if(n.setFromPoints(i,t),r.isSeparated(n))return!1}for(let e=0;e<4;e++){let o=s[e];for(let e=0;e<4;e++){let s=c[e];if(a.crossVectors(o,s),n.setFromPoints(a,t),i.setFromPoints(a,r),n.isSeparated(i))return!1}}return l&&(d||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),l.start.set(0,0,0),l.end.set(0,0,0)),!0}{let e=m(this,g,f);if(1===e&&o.containsPoint(f.end))return l&&(l.start.copy(f.end),l.end.copy(f.end)),!0;if(2!==e)return!1;let t=m(o,h,p);if(1===t&&this.containsPoint(p.end))return l&&(l.start.copy(p.end),l.end.copy(p.end)),!0;if(2!==t)return!1;if(f.delta(s),p.delta(u),0>s.dot(u)){let e=p.start;p.start=p.end,p.end=e}let r=f.start.dot(s),n=f.end.dot(s),i=p.start.dot(s),a=p.end.dot(s);return(r===a||i===n||n<i!=r<a)&&(l&&(c.subVectors(f.start,p.start),c.dot(s)>0?l.start.copy(f.start):l.start.copy(p.start),c.subVectors(f.end,p.end),0>c.dot(s)?l.end.copy(f.end):l.end.copy(p.end)),!0)}}}(),_.prototype.distanceToPoint=function(){let e=new l.Pq0;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),_.prototype.distanceToTriangle=function(){let e=new l.Pq0,t=new l.Pq0,r=["a","b","c"],n=new l.cZY,i=new l.cZY;return function(a,o=null,s=null){let l=o||s?n:null;if(this.intersectsTriangle(a,l))return(o||s)&&(o&&l.getCenter(o),s&&l.getCenter(s)),0;let u=1/0;for(let t=0;t<3;t++){let n,i=r[t],l=a[i];this.closestPointToPoint(l,e),(n=l.distanceToSquared(e))<u&&(u=n,o&&o.copy(e),s&&s.copy(l));let c=this[i];a.closestPointToPoint(c,e),(n=c.distanceToSquared(e))<u&&(u=n,o&&o.copy(c),s&&s.copy(e))}for(let l=0;l<3;l++){let c=r[l],d=r[(l+1)%3];n.set(this[c],this[d]);for(let l=0;l<3;l++){let c=r[l],d=r[(l+1)%3];i.set(a[c],a[d]),S(n,i,e,t);let f=e.distanceToSquared(t);f<u&&(u=f,o&&o.copy(e),s&&s.copy(t))}}return Math.sqrt(u)}}();class I{constructor(e,t,r){this.isOrientedBox=!0,this.min=new l.Pq0,this.max=new l.Pq0,this.matrix=new l.kn4,this.invMatrix=new l.kn4,this.points=Array(8).fill().map(()=>new l.Pq0),this.satAxes=[,,,].fill().map(()=>new l.Pq0),this.satBounds=[,,,].fill().map(()=>new E),this.alignedSatBounds=[,,,].fill().map(()=>new E),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),r&&this.matrix.copy(r)}set(e,t,r){this.min.copy(e),this.max.copy(t),this.matrix.copy(r),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}I.prototype.update=function(){let e=this.matrix,t=this.min,r=this.max,n=this.points;for(let i=0;i<=1;i++)for(let a=0;a<=1;a++)for(let o=0;o<=1;o++){let s=n[i|2*a|4*o];s.x=i?r.x:t.x,s.y=a?r.y:t.y,s.z=o?r.z:t.z,s.applyMatrix4(e)}let i=this.satBounds,a=this.satAxes,o=n[0];for(let e=0;e<3;e++){let t=a[e],r=i[e],s=n[1<<e];t.subVectors(o,s),r.setFromPoints(t,n)}let s=this.alignedSatBounds;s[0].setFromPointsField(n,"x"),s[1].setFromPointsField(n,"y"),s[2].setFromPointsField(n,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},I.prototype.intersectsBox=function(){let e=new E;return function(t){this.needsUpdate&&this.update();let r=t.min,n=t.max,i=this.satBounds,a=this.satAxes,o=this.alignedSatBounds;if(e.min=r.x,e.max=n.x,o[0].isSeparated(e)||(e.min=r.y,e.max=n.y,o[1].isSeparated(e))||(e.min=r.z,e.max=n.z,o[2].isSeparated(e)))return!1;for(let r=0;r<3;r++){let n=a[r],o=i[r];if(e.setFromBox(n,t),o.isSeparated(e))return!1}return!0}}(),I.prototype.intersectsTriangle=function(){let e=new _,t=[,,,],r=new E,n=new E,i=new l.Pq0;return function(a){this.needsUpdate&&this.update(),a.isExtendedTriangle?a.needsUpdate&&a.update():(e.copy(a),e.update(),a=e);let o=this.satBounds,s=this.satAxes;t[0]=a.a,t[1]=a.b,t[2]=a.c;for(let e=0;e<3;e++){let n=o[e],i=s[e];if(r.setFromPoints(i,t),n.isSeparated(r))return!1}let l=a.satBounds,u=a.satAxes,c=this.points;for(let e=0;e<3;e++){let t=l[e],n=u[e];if(r.setFromPoints(n,c),t.isSeparated(r))return!1}for(let e=0;e<3;e++){let a=s[e];for(let e=0;e<4;e++){let o=u[e];if(i.crossVectors(a,o),r.setFromPoints(i,t),n.setFromPoints(i,c),r.isSeparated(n))return!1}}return!0}}(),I.prototype.closestPointToPoint=function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t},I.prototype.distanceToPoint=function(){let e=new l.Pq0;return function(t){return this.closestPointToPoint(t,e),t.distanceTo(e)}}(),I.prototype.distanceToBox=function(){let e=["x","y","z"],t=Array(12).fill().map(()=>new l.cZY),r=Array(12).fill().map(()=>new l.cZY),n=new l.Pq0,i=new l.Pq0;return function(a,o=0,s=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(a))return(s||l)&&(a.getCenter(i),this.closestPointToPoint(i,n),a.closestPointToPoint(n,i),s&&s.copy(n),l&&l.copy(i)),0;let u=o*o,c=a.min,d=a.max,f=this.points,p=1/0;for(let e=0;e<8;e++){let t=f[e];i.copy(t).clamp(c,d);let r=t.distanceToSquared(i);if(r<p&&(p=r,s&&s.copy(t),l&&l.copy(i),r<u))return Math.sqrt(r)}let h=0;for(let n=0;n<3;n++)for(let i=0;i<=1;i++)for(let a=0;a<=1;a++){let o=(n+1)%3,s=(n+2)%3,l=i<<o|a<<s,u=1<<n|i<<o|a<<s,p=f[l],m=f[u];t[h].set(p,m);let g=e[n],y=e[o],w=e[s],v=r[h],x=v.start,b=v.end;x[g]=c[g],x[y]=i?c[y]:d[y],x[w]=a?c[w]:d[y],b[g]=d[g],b[y]=i?c[y]:d[y],b[w]=a?c[w]:d[y],h++}for(let e=0;e<=1;e++)for(let t=0;t<=1;t++)for(let r=0;r<=1;r++){i.x=e?d.x:c.x,i.y=t?d.y:c.y,i.z=r?d.z:c.z,this.closestPointToPoint(i,n);let a=i.distanceToSquared(n);if(a<p&&(p=a,s&&s.copy(n),l&&l.copy(i),a<u))return Math.sqrt(a)}for(let e=0;e<12;e++){let a=t[e];for(let e=0;e<12;e++){S(a,r[e],n,i);let t=n.distanceToSquared(i);if(t<p&&(p=t,s&&s.copy(n),l&&l.copy(i),t<u))return Math.sqrt(t)}}return Math.sqrt(p)}}();class R{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){let e=this._primitives;return 0===e.length?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class U extends R{constructor(){super(()=>new _)}}let k=new U;function F(e,t){return 65535===t[e+15]}function z(e,t){return t[e+14]}class q{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;let e=[],t=null;this.setBuffer=r=>{t&&e.push(t),t=r,this.float32Array=new Float32Array(r),this.uint16Array=new Uint16Array(r),this.uint32Array=new Uint32Array(r)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==e.length&&this.setBuffer(e.pop())}}}let O=new q,D=[],W=new R(()=>new l.NRn),N=new l.Pq0,L=new l.Pq0,j=new l.Pq0,H=new l.Pq0,G=new l.Pq0,$=new l.I9Y,V=new l.I9Y,X=new l.I9Y,Y=new l.Pq0,Z=new l.Pq0,Q=new l.Pq0,K=new l.Pq0;function J(e,t,r,n,i){let a=3*n,o=a+0,s=a+1,u=a+2,c=e.index;e.index&&(o=c.getX(o),s=c.getX(s),u=c.getX(u));let{position:d,normal:f,uv:p,uv1:h}=e.attributes,m=function(e,t,r,n,i,a,o,s,u){j.fromBufferAttribute(t,a),H.fromBufferAttribute(t,o),G.fromBufferAttribute(t,s);let c=null===(u===l.hsX?e.intersectTriangle(G,H,j,!0,K):e.intersectTriangle(j,H,G,u!==l.$EB,K))?null:{distance:e.origin.distanceTo(K),point:K.clone()};if(c){n&&($.fromBufferAttribute(n,a),V.fromBufferAttribute(n,o),X.fromBufferAttribute(n,s),c.uv=l.lMl.getInterpolation(K,j,H,G,$,V,X,new l.I9Y)),i&&($.fromBufferAttribute(i,a),V.fromBufferAttribute(i,o),X.fromBufferAttribute(i,s),c.uv1=l.lMl.getInterpolation(K,j,H,G,$,V,X,new l.I9Y)),r&&(Y.fromBufferAttribute(r,a),Z.fromBufferAttribute(r,o),Q.fromBufferAttribute(r,s),c.normal=l.lMl.getInterpolation(K,j,H,G,Y,Z,Q,new l.Pq0),c.normal.dot(e.direction)>0&&c.normal.multiplyScalar(-1));let t={a:a,b:o,c:s,normal:new l.Pq0,materialIndex:0};l.lMl.getNormal(j,H,G,t.normal),c.face=t,c.faceIndex=a}return c}(r,d,f,p,h,o,s,u,t);return m?(m.faceIndex=n,i&&i.push(m),m):null}function ee(e,t,r,n){let i=e.a,a=e.b,o=e.c,s=t,l=t+1,u=t+2;r&&(s=r.getX(s),l=r.getX(l),u=r.getX(u)),i.x=n.getX(s),i.y=n.getY(s),i.z=n.getZ(s),a.x=n.getX(l),a.y=n.getY(l),a.z=n.getZ(l),o.x=n.getX(u),o.y=n.getY(u),o.z=n.getZ(u)}function et(e,t,r,n,i,a,o){let{geometry:s}=r,{index:l}=s,u=s.attributes.position;for(let r=e,s=t+e;r<s;r++){let e;if(ee(o,3*(e=r),l,u),o.needsUpdate=!0,n(o,e,i,a))return!0}return!1}let er=new l.NRn;function en(e,t,r,n){return p(e,t,er),r.intersectBox(er,n)}let ei=new l.Pq0;function ea(e,t,r,n,i){O.setBuffer(e._roots[t]),function e(t,r,n,i,a){let{float32Array:o,uint16Array:s,uint32Array:l}=O,u=2*t;if(F(u,s)){let e=l[t+6],o=z(u,s),{geometry:c,_indirectBuffer:d}=r;for(let t=e,r=e+o;t<r;t++)J(c,n,i,t,a)}else{let s=t+8;en(s,o,i,ei)&&e(s,r,n,i,a);let u=l[t+6];en(u,o,i,ei)&&e(u,r,n,i,a)}}(0,e,r,n,i),O.clearBuffer()}let eo=new l.Pq0,es=["x","y","z"];function el(e,t,r,n){O.setBuffer(e._roots[t]);let i=function e(t,r,n,i){let{float32Array:a,uint16Array:o,uint32Array:s}=O,l=2*t;if(F(l,o))return function(e,t,r,n,i){let{geometry:a,_indirectBuffer:o}=e,s=1/0,l=null;for(let e=n,o=n+i;e<o;e++){let n;(n=J(a,t,r,e))&&n.distance<s&&(l=n,s=n.distance)}return l}(r,n,i,s[t+6],z(l,o));{let o,l,u=s[t+7],c=es[u],d=i.direction[c]>=0;d?(o=t+8,l=s[t+6]):(o=s[t+6],l=t+8);let f=en(o,a,i,eo)?e(o,r,n,i):null;if(f){let e=f.point[c];if(d?e<=a[l+u]:e>=a[l+u+3])return f}let p=en(l,a,i,eo)?e(l,r,n,i):null;return f&&p?f.distance<=p.distance?f:p:f||p||null}}(0,e,r,n);return O.clearBuffer(),i}let eu=new l.NRn,ec=new _,ed=new _,ef=new l.kn4,ep=new I,eh=new I;function em(e,t,r,n){O.setBuffer(e._roots[t]);let i=function e(t,r,n,i,a=null){let{float32Array:o,uint16Array:s,uint32Array:l}=O,u=2*t;if(null===a&&(n.boundingBox||n.computeBoundingBox(),ep.set(n.boundingBox.min,n.boundingBox.max,i),a=ep),F(u,s)){let e=r.geometry,a=e.index,c=e.attributes.position,d=n.index,f=n.attributes.position,h=l[t+6],m=z(u,s);if(ef.copy(i).invert(),n.boundsTree)return p(t,o,eh),eh.matrix.copy(ef),eh.needsUpdate=!0,n.boundsTree.shapecast({intersectsBounds:e=>eh.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(i),e.b.applyMatrix4(i),e.c.applyMatrix4(i),e.needsUpdate=!0;for(let t=3*h,r=(m+h)*3;t<r;t+=3)if(ee(ed,t,a,c),ed.needsUpdate=!0,e.intersectsTriangle(ed))return!0;return!1}});for(let e=3*h,t=(m+h)*3;e<t;e+=3){ee(ec,e,a,c),ec.a.applyMatrix4(ef),ec.b.applyMatrix4(ef),ec.c.applyMatrix4(ef),ec.needsUpdate=!0;for(let e=0,t=d.count;e<t;e+=3)if(ee(ed,e,d,f),ed.needsUpdate=!0,ec.intersectsTriangle(ed))return!0}}else{let s=t+8,u=l[t+6];return p(s,o,eu),!!(a.intersectsBox(eu)&&e(s,r,n,i,a))||(p(u,o,eu),!!(a.intersectsBox(eu)&&e(u,r,n,i,a)))}}(0,e,r,n);return O.clearBuffer(),i}let eg=new l.kn4,ey=new I,ew=new I,ev=new l.Pq0,ex=new l.Pq0,eb=new l.Pq0,eM=new l.Pq0;function eP(e,t,r,n,i,a,o){let{geometry:s}=r,{index:l}=s,u=s.attributes.position;for(let s=e,c=t+e;s<c;s++){let e;if(ee(o,3*(e=r.resolveTriangleIndex(s)),l,u),o.needsUpdate=!0,n(o,e,i,a))return!0}return!1}let eA=new l.Pq0;function eE(e,t,r,n,i){O.setBuffer(e._roots[t]),function e(t,r,n,i,a){let{float32Array:o,uint16Array:s,uint32Array:l}=O,u=2*t;if(F(u,s)){let e=l[t+6],o=z(u,s),{geometry:c,_indirectBuffer:d}=r;for(let t=e,r=e+o;t<r;t++)J(c,n,i,d?d[t]:t,a)}else{let s=t+8;en(s,o,i,eA)&&e(s,r,n,i,a);let u=l[t+6];en(u,o,i,eA)&&e(u,r,n,i,a)}}(0,e,r,n,i),O.clearBuffer()}let eT=new l.Pq0,eS=["x","y","z"];function eB(e,t,r,n){O.setBuffer(e._roots[t]);let i=function e(t,r,n,i){let{float32Array:a,uint16Array:o,uint32Array:s}=O,l=2*t;if(F(l,o))return function(e,t,r,n,i){let{geometry:a,_indirectBuffer:o}=e,s=1/0,l=null;for(let e=n,u=n+i;e<u;e++){let n;(n=J(a,t,r,o?o[e]:e))&&n.distance<s&&(l=n,s=n.distance)}return l}(r,n,i,s[t+6],z(l,o));{let o,l,u=s[t+7],c=eS[u],d=i.direction[c]>=0;d?(o=t+8,l=s[t+6]):(o=s[t+6],l=t+8);let f=en(o,a,i,eT)?e(o,r,n,i):null;if(f){let e=f.point[c];if(d?e<=a[l+u]:e>=a[l+u+3])return f}let p=en(l,a,i,eT)?e(l,r,n,i):null;return f&&p?f.distance<=p.distance?f:p:f||p||null}}(0,e,r,n);return O.clearBuffer(),i}let eC=new l.NRn,e_=new _,eI=new _,eR=new l.kn4,eU=new I,ek=new I;function eF(e,t,r,n){O.setBuffer(e._roots[t]);let i=function e(t,r,n,i,a=null){let{float32Array:o,uint16Array:s,uint32Array:l}=O,u=2*t;if(null===a&&(n.boundingBox||n.computeBoundingBox(),eU.set(n.boundingBox.min,n.boundingBox.max,i),a=eU),F(u,s)){let e=r.geometry,a=e.index,c=e.attributes.position,d=n.index,f=n.attributes.position,h=l[t+6],m=z(u,s);if(eR.copy(i).invert(),n.boundsTree)return p(t,o,ek),ek.matrix.copy(eR),ek.needsUpdate=!0,n.boundsTree.shapecast({intersectsBounds:e=>ek.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(i),e.b.applyMatrix4(i),e.c.applyMatrix4(i),e.needsUpdate=!0;for(let t=h,n=m+h;t<n;t++)if(ee(eI,3*r.resolveTriangleIndex(t),a,c),eI.needsUpdate=!0,e.intersectsTriangle(eI))return!0;return!1}});for(let e=h,t=m+h;e<t;e++){ee(e_,3*r.resolveTriangleIndex(e),a,c),e_.a.applyMatrix4(eR),e_.b.applyMatrix4(eR),e_.c.applyMatrix4(eR),e_.needsUpdate=!0;for(let e=0,t=d.count;e<t;e+=3)if(ee(eI,e,d,f),eI.needsUpdate=!0,e_.intersectsTriangle(eI))return!0}}else{let s=t+8,u=l[t+6];return p(s,o,eC),!!(a.intersectsBox(eC)&&e(s,r,n,i,a))||(p(u,o,eC),!!(a.intersectsBox(eC)&&e(u,r,n,i,a)))}}(0,e,r,n);return O.clearBuffer(),i}let ez=new l.kn4,eq=new I,eO=new I,eD=new l.Pq0,eW=new l.Pq0,eN=new l.Pq0,eL=new l.Pq0,ej=new O.constructor,eH=new O.constructor,eG=new R(()=>new l.NRn),e$=new l.NRn,eV=new l.NRn,eX=new l.NRn,eY=new l.NRn,eZ=!1,eQ=new I,eK=new l.NRn;class eJ{static serialize(e,t={}){t={cloneBuffers:!0,...t};let r=e.geometry,n=e._roots,i=e._indirectBuffer,a=r.getIndex();return t.cloneBuffers?{roots:n.map(e=>e.slice()),index:a.array.slice(),indirectBuffer:i?i.slice():null}:{roots:n,index:a.array,indirectBuffer:i}}static deserialize(e,t,r={}){r={setIndex:!0,indirect:!!e.indirectBuffer,...r};let{index:n,roots:i,indirectBuffer:a}=e,o=new eJ(t,{...r,[u]:!0});if(o._roots=i,o._indirectBuffer=a||null,r.setIndex){let r=t.getIndex();if(null===r){let r=new l.THS(e.index,1,!1);t.setIndex(r)}else r.array!==n&&(r.array.set(n),r.needsUpdate=!0)}return o}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw Error("MeshBVH: Only BufferGeometries are supported.");if((t=Object.assign({strategy:0,maxDepth:40,maxLeafTris:10,verbose:!0,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,[u]:!1},t)).useSharedArrayBuffer&&"undefined"==typeof SharedArrayBuffer)throw Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[u]||(!function(e,t){let r,n,i,a=e.geometry;t.indirect&&(e._indirectBuffer=function(e,t){let r=(e.index?e.index.count:e.attributes.position.count)/3,n=r>65536,i=n?4:2,a=t?new SharedArrayBuffer(r*i):new ArrayBuffer(r*i),o=n?new Uint32Array(a):new Uint16Array(a);for(let e=0,t=o.length;e<t;e++)o[e]=e;return o}(a,t.useSharedArrayBuffer),function(e){if(0===e.groups.length)return!1;let t=c(e),r=f(e).sort((e,t)=>e.offset-t.offset),n=r[r.length-1];n.count=Math.min(t-n.offset,n.count);let i=0;return r.forEach(({count:e})=>i+=e),t!==i}(a)&&!t.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),e._indirectBuffer||function(e,t){if(!e.index){let r=e.attributes.position.count,n=function(e,t=ArrayBuffer){return e>65535?new Uint32Array(new t(4*e)):new Uint16Array(new t(2*e))}(r,t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);e.setIndex(new l.THS(n,1));for(let e=0;e<r;e++)n[e]=e}}(a,t);let o=function(e,t){let r=e.geometry,n=r.index?r.index.array:null,i=t.maxDepth,a=t.verbose,o=t.maxLeafTris,s=t.strategy,l=t.onProgress,u=c(r),p=e._indirectBuffer,E=!1,T=new Float32Array(6),S=new Float32Array(6),B=function(e,t){t[0]=t[1]=t[2]=1/0,t[3]=t[4]=t[5]=-1/0;let r=e.attributes.position,n=e.index?e.index.array:null,i=c(e),a=new Float32Array(6*i),o=r.normalized,s=r.array,l=r.offset||0,u=3;r.isInterleavedBufferAttribute&&(u=r.data.stride);let d=["getX","getY","getZ"];for(let e=0;e<i;e++){let i=3*e,c=6*e,f=i+0,p=i+1,h=i+2;n&&(f=n[f],p=n[p],h=n[h]),o||(f=f*u+l,p=p*u+l,h=h*u+l);for(let e=0;e<3;e++){let n,i,l;o?(n=r[d[e]](f),i=r[d[e]](p),l=r[d[e]](h)):(n=s[f+e],i=s[p+e],l=s[h+e]);let u=n;i<u&&(u=i),l<u&&(u=l);let m=n;i>m&&(m=i),l>m&&(m=l);let g=(m-u)/2,y=2*e;a[c+y+0]=u+g,a[c+y+1]=g+(Math.abs(u)+g)*5960464477539063e-23,u<t[e]&&(t[e]=u),m>t[e+3]&&(t[e+3]=m)}}return a}(r,T),C=t.indirect?A:P,_=[],I=t.indirect?d(r):f(r);if(1===I.length){let e=I[0],t=new M;t.boundingData=T,function(e,t,r,n){let i=1/0,a=1/0,o=1/0,s=-1/0,l=-1/0,u=-1/0;for(let n=6*t,c=(t+r)*6;n<c;n+=6){let t=e[n+0];t<i&&(i=t),t>s&&(s=t);let r=e[n+2];r<a&&(a=r),r>l&&(l=r);let c=e[n+4];c<o&&(o=c),c>u&&(u=c)}n[0]=i,n[1]=a,n[2]=o,n[3]=s,n[4]=l,n[5]=u}(B,e.offset,e.count,S),U(t,e.offset,e.count,S),_.push(t)}else for(let e of I){let t=new M;t.boundingData=new Float32Array(6),w(B,e.offset,e.count,t.boundingData,S),U(t,e.offset,e.count,S),_.push(t)}return _;function R(e){l&&l(e/u)}function U(e,t,l,u=null,c=0){if(!E&&c>=i&&(E=!0,a&&(console.warn(`MeshBVH: Max depth of ${i} reached when generating BVH. Consider increasing maxDepth.`),console.warn(r))),l<=o||c>=i)return R(t+l),e.offset=t,e.count=l,e;let d=function(e,t,r,n,i,a){let o=-1,s=0;if(0===a)-1!==(o=h(t))&&(s=(t[o]+t[o+3])/2);else if(1===a)-1!==(o=h(e))&&(s=function(e,t,r,n){let i=0;for(let a=t,o=t+r;a<o;a++)i+=e[6*a+2*n];return i/r}(r,n,i,o));else if(2===a){let a=y(e),u=1.25*i,c=6*n,d=(n+i)*6;for(let e=0;e<3;e++){let n=t[e],f=(t[e+3]-n)/32;if(i<8){let t=[...x];t.length=i;let n=0;for(let i=c;i<d;i+=6,n++){let a=t[n];a.candidate=r[i+2*e],a.count=0;let{bounds:o,leftCacheBounds:s,rightCacheBounds:l}=a;for(let e=0;e<3;e++)l[e]=1/0,l[e+3]=-1/0,s[e]=1/0,s[e+3]=-1/0,o[e]=1/0,o[e+3]=-1/0;g(i,r,o)}t.sort(v);let l=i;for(let e=0;e<l;e++){let r=t[e];for(;e+1<l&&t[e+1].candidate===r.candidate;)t.splice(e+1,1),l--}for(let n=c;n<d;n+=6){let i=r[n+2*e];for(let e=0;e<l;e++){let a=t[e];i>=a.candidate?g(n,r,a.rightCacheBounds):(g(n,r,a.leftCacheBounds),a.count++)}}for(let r=0;r<l;r++){let n=t[r],l=n.count,c=i-n.count,d=n.leftCacheBounds,f=n.rightCacheBounds,p=0;0!==l&&(p=y(d)/a);let h=0;0!==c&&(h=y(f)/a);let m=1+1.25*(p*l+h*c);m<u&&(o=e,u=m,s=n.candidate)}}else{var l;for(let e=0;e<32;e++){let t=x[e];t.count=0,t.candidate=n+f+e*f;let r=t.bounds;for(let e=0;e<3;e++)r[e]=1/0,r[e+3]=-1/0}for(let t=c;t<d;t+=6){let i=~~((r[t+2*e]-n)/f);i>=32&&(i=31);let a=x[i];a.count++,g(t,r,a.bounds)}let t=x[31];l=t.bounds,t.rightCacheBounds.set(l);for(let e=30;e>=0;e--){let t=x[e],r=x[e+1];m(t.bounds,r.rightCacheBounds,t.rightCacheBounds)}let p=0;for(let t=0;t<31;t++){let r=x[t],n=r.count,l=r.bounds,c=x[t+1].rightCacheBounds;0!==n&&(0===p?b.set(l):m(l,b,b));let d=0,f=0;0!==(p+=n)&&(d=y(b)/a);let h=i-p;0!==h&&(f=y(c)/a);let g=1+1.25*(d*p+f*h);g<u&&(o=e,u=g,s=r.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${a} used.`);return{axis:o,pos:s}}(e.boundingData,u,B,t,l,s);if(-1===d.axis)return R(t+l),e.offset=t,e.count=l,e;let f=C(p,n,B,t,l,d);if(f===t||f===t+l)R(t+l),e.offset=t,e.count=l;else{e.splitAxis=d.axis;let r=new M,n=f-t;e.left=r,r.boundingData=new Float32Array(6),w(B,t,n,r.boundingData,S),U(r,t,n,S,c+1);let i=new M,a=l-n;e.right=i,i.boundingData=new Float32Array(6),w(B,f,a,i.boundingData,S),U(i,f,a,S,c+1)}return e}}(e,t),s=[],u=t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer;for(let e=0;e<o.length;e++){let t=o[e],a=new u(32*function e(t){return t.count?1:1+e(t.left)+e(t.right)}(t));r=new Float32Array(a),n=new Uint32Array(a),i=new Uint16Array(a),function e(t,a){let o=t/4,s=t/2,l=!!a.count,u=a.boundingData;for(let e=0;e<6;e++)r[o+e]=u[e];if(l){let e=a.offset,r=a.count;return n[o+6]=e,i[s+14]=r,i[s+15]=65535,t+32}{let r,i=a.left,s=a.right,l=a.splitAxis;if((r=e(t+32,i))/4>0x100000000)throw Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return n[o+6]=r/4,r=e(r,s),n[o+7]=l,r}}(0,t),s.push(a)}e._roots=s}(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new l.NRn)));let{_indirectBuffer:r}=this;this.resolveTriangleIndex=t.indirect?e=>r[e]:e=>e}refit(e=null){return(this.indirect?function(e,t=null){let r,n,i,a;t&&Array.isArray(t)&&(t=new Set(t));let o=e.geometry,s=o.index?o.index.array:null,l=o.attributes.position,u=0,c=e._roots;for(let o=0,d=c.length;o<d;o++)n=new Uint32Array(r=c[o]),i=new Uint16Array(r),a=new Float32Array(r),function r(o,u,c=!1){let d=2*o;if(65535===i[d+15]){let t=n[o+6],r=i[d+14],u=1/0,c=1/0,f=1/0,p=-1/0,h=-1/0,m=-1/0;for(let n=t,i=t+r;n<i;n++){let t=3*e.resolveTriangleIndex(n);for(let e=0;e<3;e++){let r=t+e;r=s?s[r]:r;let n=l.getX(r),i=l.getY(r),a=l.getZ(r);n<u&&(u=n),n>p&&(p=n),i<c&&(c=i),i>h&&(h=i),a<f&&(f=a),a>m&&(m=a)}}return(a[o+0]!==u||a[o+1]!==c||a[o+2]!==f||a[o+3]!==p||a[o+4]!==h||a[o+5]!==m)&&(a[o+0]=u,a[o+1]=c,a[o+2]=f,a[o+3]=p,a[o+4]=h,a[o+5]=m,!0)}{let e=o+8,i=n[o+6],s=e+u,l=i+u,d=c,f=!1,p=!1;t?d||(f=t.has(s),p=t.has(l),d=!f&&!p):(f=!0,p=!0);let h=d||f,m=d||p,g=!1;h&&(g=r(e,u,d));let y=!1;m&&(y=r(i,u,d));let w=g||y;if(w)for(let t=0;t<3;t++){let r=e+t,n=i+t,s=a[r],l=a[r+3],u=a[n],c=a[n+3];a[o+t]=s<u?s:u,a[o+t+3]=l>c?l:c}return w}}(0,u),u+=r.byteLength}:function(e,t=null){let r,n,i,a;t&&Array.isArray(t)&&(t=new Set(t));let o=e.geometry,s=o.index?o.index.array:null,l=o.attributes.position,u=0,c=e._roots;for(let e=0,o=c.length;e<o;e++)n=new Uint32Array(r=c[e]),i=new Uint16Array(r),a=new Float32Array(r),function e(r,o,u=!1){let c=2*r;if(65535===i[c+15]){let e=n[r+6],t=i[c+14],o=1/0,u=1/0,d=1/0,f=-1/0,p=-1/0,h=-1/0;for(let r=3*e,n=3*(e+t);r<n;r++){let e=s[r],t=l.getX(e),n=l.getY(e),i=l.getZ(e);t<o&&(o=t),t>f&&(f=t),n<u&&(u=n),n>p&&(p=n),i<d&&(d=i),i>h&&(h=i)}return(a[r+0]!==o||a[r+1]!==u||a[r+2]!==d||a[r+3]!==f||a[r+4]!==p||a[r+5]!==h)&&(a[r+0]=o,a[r+1]=u,a[r+2]=d,a[r+3]=f,a[r+4]=p,a[r+5]=h,!0)}{let i=r+8,s=n[r+6],l=i+o,c=s+o,d=u,f=!1,p=!1;t?d||(f=t.has(l),p=t.has(c),d=!f&&!p):(f=!0,p=!0);let h=d||f,m=d||p,g=!1;h&&(g=e(i,o,d));let y=!1;m&&(y=e(s,o,d));let w=g||y;if(w)for(let e=0;e<3;e++){let t=i+e,n=s+e,o=a[t],l=a[t+3],u=a[n],c=a[n+3];a[r+e]=o<u?o:u,a[r+e+3]=l>c?l:c}return w}}(0,u),u+=r.byteLength})(this,e)}traverse(e,t=0){let r=this._roots[t],n=new Uint32Array(r),i=new Uint16Array(r);!function t(a,o=0){let s=2*a,l=65535===i[s+15];if(l){let t=n[a+6],u=i[s+14];e(o,l,new Float32Array(r,4*a,6),t,u)}else{let i=n[a+6],s=n[a+7];e(o,l,new Float32Array(r,4*a,6),s)||(t(a+8,o+1),t(i,o+1))}}(0)}raycast(e,t=l.hB5){let r=this._roots,n=this.geometry,i=[],a=t.isMaterial,o=Array.isArray(t),s=n.groups,u=a?t.side:t,c=this.indirect?eE:ea;for(let n=0,a=r.length;n<a;n++){let r=o?t[s[n].materialIndex].side:u,a=i.length;if(c(this,n,r,e,i),o){let e=s[n].materialIndex;for(let t=a,r=i.length;t<r;t++)i[t].face.materialIndex=e}}return i}raycastFirst(e,t=l.hB5){let r=this._roots,n=this.geometry,i=t.isMaterial,a=Array.isArray(t),o=null,s=n.groups,u=i?t.side:t,c=this.indirect?eB:el;for(let n=0,i=r.length;n<i;n++){let r=a?t[s[n].materialIndex].side:u,i=c(this,n,r,e);null!=i&&(null==o||i.distance<o.distance)&&(o=i,a&&(i.face.materialIndex=s[n].materialIndex))}return o}intersectsGeometry(e,t){let r=!1,n=this._roots,i=this.indirect?eF:em;for(let a=0,o=n.length;a<o&&!(r=i(this,a,e,t));a++);return r}shapecast(e){let t=k.getPrimitive(),r=this.indirect?eP:et,{boundsTraverseOrder:a,intersectsBounds:o,intersectsRange:s,intersectsTriangle:l}=e;if(s&&l){let e=s;s=(n,i,a,o,s)=>!!e(n,i,a,o,s)||r(n,i,this,l,a,o,t)}else s||(s=l?(e,n,i,a)=>r(e,n,this,l,i,a,t):(e,t,r)=>r);let u=!1,c=0,d=this._roots;for(let e=0,t=d.length;e<t;e++){let t=d[e];if(u=function(e,t,r,a,o,s){n=W.getPrimitive(),i=W.getPrimitive(),D.push(n,i),O.setBuffer(e._roots[t]);let l=function e(t,r,a,o,s=null,l=0,u=0){let{float32Array:c,uint16Array:d,uint32Array:f}=O,h=2*t;if(F(h,d)){let e=f[t+6],r=z(h,d);return p(t,c,n),o(e,r,!1,u,l+t,n)}{let h,y,w,v,x,b,M=t+8,P=f[t+6],A=M,E=P;if(s&&(w=n,v=i,p(A,c,w),p(E,c,v),h=s(w),(y=s(v))<h)){A=P,E=M;let e=h;h=y,y=e,w=v}w||p(A,c,w=n);let T=a(w,F(2*A,d),h,u+1,l+A);if(2===T){let e=m(A);x=o(e,g(A)-e,!0,u+1,l+A,w)}else x=T&&e(A,r,a,o,s,l,u+1);if(x)return!0;p(E,c,v=i);let S=a(v,F(2*E,d),y,u+1,l+E);if(2===S){let e=m(E);b=o(e,g(E)-e,!0,u+1,l+E,v)}else b=S&&e(E,r,a,o,s,l,u+1);if(b)return!0;return!1;function m(e){let{uint16Array:t,uint32Array:r}=O,n=2*e;for(;!F(n,t);)n=2*(e+=8);return r[e+6]}function g(e){let{uint16Array:t,uint32Array:r}=O,n=2*e;for(;!F(n,t);)n=2*(e=r[e+6]);return r[e+6]+z(n,t)}}}(0,e.geometry,r,a,o,s);O.clearBuffer(),W.releasePrimitive(n),W.releasePrimitive(i),D.pop(),D.pop();let u=D.length;return u>0&&(i=D[u-1],n=D[u-2]),l}(this,e,o,s,a,c))break;c+=t.byteLength}return k.releasePrimitive(t),u}bvhcast(e,t,r){let{intersectsRanges:n,intersectsTriangles:i}=r,a=k.getPrimitive(),o=this.geometry.index,s=this.geometry.attributes.position,u=this.indirect?e=>{ee(a,3*this.resolveTriangleIndex(e),o,s)}:e=>{ee(a,3*e,o,s)},c=k.getPrimitive(),d=e.geometry.index,f=e.geometry.attributes.position,h=e.indirect?t=>{ee(c,3*e.resolveTriangleIndex(t),d,f)}:e=>{ee(c,3*e,d,f)};if(i){let e=(e,r,n,o,s,l,d,f)=>{for(let p=n,m=n+o;p<m;p++){h(p),c.a.applyMatrix4(t),c.b.applyMatrix4(t),c.c.applyMatrix4(t),c.needsUpdate=!0;for(let t=e,n=e+r;t<n;t++)if(u(t),a.needsUpdate=!0,i(a,c,t,p,s,l,d,f))return!0}return!1};if(n){let t=n;n=function(r,n,i,a,o,s,l,u){return!!t(r,n,i,a,o,s,l,u)||e(r,n,i,a,o,s,l,u)}}else n=e}return function(e,t,r,n){let i;if(eZ)throw Error("MeshBVH: Recursive calls to bvhcast not supported.");eZ=!0;let a=e._roots,o=t._roots,s=0,u=0,c=new l.kn4().copy(r).invert();for(let e=0,t=a.length;e<t;e++){ej.setBuffer(a[e]),u=0;let t=eG.getPrimitive();p(0,ej.float32Array,t),t.applyMatrix4(c);for(let a=0,l=o.length;a<l&&(eH.setBuffer(o[e]),i=function e(t,r,n,i,a,o=0,s=0,l=0,u=0,c=null,d=!1){let f,h;d?(f=eH,h=ej):(f=ej,h=eH);let m=f.float32Array,g=f.uint32Array,y=f.uint16Array,w=h.float32Array,v=h.uint32Array,x=h.uint16Array,b=2*r,M=F(2*t,y),P=F(b,x),A=!1;if(P&&M)A=d?a(v[r+6],z(2*r,x),g[t+6],z(2*t,y),u,s+r,l,o+t):a(g[t+6],z(2*t,y),v[r+6],z(2*r,x),l,o+t,u,s+r);else if(P){let c=eG.getPrimitive();p(r,w,c),c.applyMatrix4(n);let f=t+8,h=g[t+6];p(f,m,e$),p(h,m,eV);let y=c.intersectsBox(e$),v=c.intersectsBox(eV);A=y&&e(r,f,i,n,a,s,o,u,l+1,c,!d)||v&&e(r,h,i,n,a,s,o,u,l+1,c,!d),eG.releasePrimitive(c)}else{let f=r+8,h=v[r+6];p(f,w,eX),p(h,w,eY);let y=c.intersectsBox(eX),x=c.intersectsBox(eY);if(y&&x)A=e(t,f,n,i,a,o,s,l,u+1,c,d)||e(t,h,n,i,a,o,s,l,u+1,c,d);else if(y)if(M)A=e(t,f,n,i,a,o,s,l,u+1,c,d);else{let r=eG.getPrimitive();r.copy(eX).applyMatrix4(n);let c=t+8,h=g[t+6];p(c,m,e$),p(h,m,eV);let y=r.intersectsBox(e$),w=r.intersectsBox(eV);A=y&&e(f,c,i,n,a,s,o,u,l+1,r,!d)||w&&e(f,h,i,n,a,s,o,u,l+1,r,!d),eG.releasePrimitive(r)}else if(x)if(M)A=e(t,h,n,i,a,o,s,l,u+1,c,d);else{let r=eG.getPrimitive();r.copy(eY).applyMatrix4(n);let c=t+8,f=g[t+6];p(c,m,e$),p(f,m,eV);let y=r.intersectsBox(e$),w=r.intersectsBox(eV);A=y&&e(h,c,i,n,a,s,o,u,l+1,r,!d)||w&&e(h,f,i,n,a,s,o,u,l+1,r,!d),eG.releasePrimitive(r)}}return A}(0,0,r,c,n,s,u,0,0,t),eH.clearBuffer(),u+=o[a].length,!i);a++);if(eG.releasePrimitive(t),ej.clearBuffer(),s+=a[e].length,i)break}return eZ=!1,i}(this,e,t,n)}intersectsBox(e,t){return eQ.set(e.min,e.max,t),eQ.needsUpdate=!0,this.shapecast({intersectsBounds:e=>eQ.intersectsBox(e),intersectsTriangle:e=>eQ.intersectsTriangle(e)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,r={},n={},i=0,a=1/0){return(this.indirect?function(e,t,r,n={},i={},a=0,o=1/0){t.boundingBox||t.computeBoundingBox(),eq.set(t.boundingBox.min,t.boundingBox.max,r),eq.needsUpdate=!0;let s=e.geometry,l=s.attributes.position,u=s.index,d=t.attributes.position,f=t.index,p=k.getPrimitive(),h=k.getPrimitive(),m=null,g=null;i&&(m=eN,g=eL);let y=1/0,w=null,v=null;return(ez.copy(r).invert(),eO.matrix.copy(ez),e.shapecast({boundsTraverseOrder:e=>eq.distanceToBox(e),intersectsBounds:(e,t,r)=>r<y&&r<o&&(t&&(eO.min.copy(e.min),eO.max.copy(e.max),eO.needsUpdate=!0),!0),intersectsRange:(n,i)=>{if(t.boundsTree){let s=t.boundsTree;return s.shapecast({boundsTraverseOrder:e=>eO.distanceToBox(e),intersectsBounds:(e,t,r)=>r<y&&r<o,intersectsRange:(t,o)=>{for(let c=t,x=t+o;c<x;c++){ee(h,3*s.resolveTriangleIndex(c),f,d),h.a.applyMatrix4(r),h.b.applyMatrix4(r),h.c.applyMatrix4(r),h.needsUpdate=!0;for(let t=n,r=n+i;t<r;t++){ee(p,3*e.resolveTriangleIndex(t),u,l),p.needsUpdate=!0;let r=p.distanceToTriangle(h,eD,m);if(r<y&&(eW.copy(eD),g&&g.copy(m),y=r,w=t,v=c),r<a)return!0}}}})}{let o=c(t);for(let t=0;t<o;t++){ee(h,3*t,f,d),h.a.applyMatrix4(r),h.b.applyMatrix4(r),h.c.applyMatrix4(r),h.needsUpdate=!0;for(let r=n,o=n+i;r<o;r++){ee(p,3*e.resolveTriangleIndex(r),u,l),p.needsUpdate=!0;let n=p.distanceToTriangle(h,eD,m);if(n<y&&(eW.copy(eD),g&&g.copy(m),y=n,w=r,v=t),n<a)return!0}}}}}),k.releasePrimitive(p),k.releasePrimitive(h),y===1/0)?null:(n.point?n.point.copy(eW):n.point=eW.clone(),n.distance=y,n.faceIndex=w,i&&(i.point?i.point.copy(g):i.point=g.clone(),i.point.applyMatrix4(ez),eW.applyMatrix4(ez),i.distance=eW.sub(i.point).length(),i.faceIndex=v),n)}:function(e,t,r,n={},i={},a=0,o=1/0){t.boundingBox||t.computeBoundingBox(),ey.set(t.boundingBox.min,t.boundingBox.max,r),ey.needsUpdate=!0;let s=e.geometry,l=s.attributes.position,u=s.index,d=t.attributes.position,f=t.index,p=k.getPrimitive(),h=k.getPrimitive(),m=null,g=null;i&&(m=eb,g=eM);let y=1/0,w=null,v=null;return(eg.copy(r).invert(),ew.matrix.copy(eg),e.shapecast({boundsTraverseOrder:e=>ey.distanceToBox(e),intersectsBounds:(e,t,r)=>r<y&&r<o&&(t&&(ew.min.copy(e.min),ew.max.copy(e.max),ew.needsUpdate=!0),!0),intersectsRange:(e,n)=>{if(t.boundsTree)return t.boundsTree.shapecast({boundsTraverseOrder:e=>ew.distanceToBox(e),intersectsBounds:(e,t,r)=>r<y&&r<o,intersectsRange:(t,i)=>{for(let o=t,s=t+i;o<s;o++){ee(h,3*o,f,d),h.a.applyMatrix4(r),h.b.applyMatrix4(r),h.c.applyMatrix4(r),h.needsUpdate=!0;for(let t=e,r=e+n;t<r;t++){ee(p,3*t,u,l),p.needsUpdate=!0;let e=p.distanceToTriangle(h,ev,m);if(e<y&&(ex.copy(ev),g&&g.copy(m),y=e,w=t,v=o),e<a)return!0}}}});{let i=c(t);for(let t=0;t<i;t++){ee(h,3*t,f,d),h.a.applyMatrix4(r),h.b.applyMatrix4(r),h.c.applyMatrix4(r),h.needsUpdate=!0;for(let r=e,i=e+n;r<i;r++){ee(p,3*r,u,l),p.needsUpdate=!0;let e=p.distanceToTriangle(h,ev,m);if(e<y&&(ex.copy(ev),g&&g.copy(m),y=e,w=r,v=t),e<a)return!0}}}}}),k.releasePrimitive(p),k.releasePrimitive(h),y===1/0)?null:(n.point?n.point.copy(ex):n.point=ex.clone(),n.distance=y,n.faceIndex=w,i&&(i.point?i.point.copy(g):i.point=g.clone(),i.point.applyMatrix4(eg),ex.applyMatrix4(eg),i.distance=ex.sub(i.point).length(),i.faceIndex=v),n)})(this,e,t,r,n,i,a)}closestPointToPoint(e,t={},r=0,n=1/0){return function(e,t,r={},n=0,i=1/0){let a=n*n,o=i*i,s=1/0,l=null;if(e.shapecast({boundsTraverseOrder:e=>(N.copy(t).clamp(e.min,e.max),N.distanceToSquared(t)),intersectsBounds:(e,t,r)=>r<s&&r<o,intersectsTriangle:(e,r)=>{e.closestPointToPoint(t,N);let n=t.distanceToSquared(N);return n<s&&(L.copy(N),s=n,l=r),n<a}}),s===1/0)return null;let u=Math.sqrt(s);return r.point?r.point.copy(L):r.point=L.clone(),r.distance=u,r.faceIndex=l,r}(this,e,t,r,n)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(t=>{p(0,new Float32Array(t),eK),e.union(eK)}),e}}let e0=Math.pow(10,-Math.log10(1e-6)),e1=5e-7*e0;function e2(e){return~~(e*e0+e1)}function e3(e){return`${e2(e.x)},${e2(e.y)},${e2(e.z)}`}function e4(){return"undefined"!=typeof SharedArrayBuffer}function e6(e){return(e.index?e.index.count:e.attributes.position.count)/3}let e5=new l.Pq0;function e8(e,t){return e.start-t.start}function e7(e,t){return e5.subVectors(t,e.origin).dot(e.direction)}class e9{constructor(){this._rays=[]}addRay(e){this._rays.push(e)}findClosestRay(e){let t=this._rays,r=e.clone();r.direction.multiplyScalar(-1);let n=1/0,i=null;for(let s=0,l=t.length;s<l;s++){let l=t[s];if(a(l,e)&&a(l,r))continue;let u=Math.min(o(l,e),o(l,r));u<n&&(n=u,i=l)}return i;function a(e,t){let r=e.origin.distanceTo(t.origin)>1e-5;return e.direction.angleTo(t.direction)>1e-4||r}function o(e,t){return e.origin.distanceTo(t.origin)/1e-5+e.direction.angleTo(t.direction)/1e-4}}}let te=new l.Pq0,tt=new l.Pq0,tr=new l.RlV,tn=new l.I9Y,ti=new l.Pq0,ta=new l.IUQ,to=["","",""];class ts{constructor(e=null){this.data=null,this.disjointConnections=null,this.unmatchedDisjointEdges=null,this.unmatchedEdges=-1,this.matchedEdges=-1,this.useDrawRange=!0,this.useAllAttributes=!1,this.matchDisjointEdges=!1,this.degenerateEpsilon=1e-8,e&&this.updateFrom(e)}getSiblingTriangleIndex(e,t){let r=this.data[3*e+t];return -1===r?-1:~~(r/3)}getSiblingEdgeIndex(e,t){let r=this.data[3*e+t];return -1===r?-1:r%3}getDisjointSiblingTriangleIndices(e,t){let r=this.disjointConnections.get(3*e+t);return r?r.map(e=>~~(e/3)):[]}getDisjointSiblingEdgeIndices(e,t){let r=this.disjointConnections.get(3*e+t);return r?r.map(e=>e%3):[]}isFullyConnected(){return 0===this.unmatchedEdges}updateFrom(e){let{useAllAttributes:t,useDrawRange:r,matchDisjointEdges:n,degenerateEpsilon:i}=this,a=t?function(e){let t="";for(let i=0,a=l.length;i<a;i++){var r,n;let a,o=s[l[i]];switch(o.itemSize){case 1:a=e2(o.getX(e));break;case 2:r=tn.fromBufferAttribute(o,e),a=`${e2(r.x)},${e2(r.y)}`;break;case 3:a=e3(ti.fromBufferAttribute(o,e));break;case 4:n=ta.fromBufferAttribute(o,e),a=`${e2(n.x)},${e2(n.y)},${e2(n.z)},${e2(n.w)}`}""!==t&&(t+="|"),t+=a}return t}:function(e){return ti.fromBufferAttribute(c,e),e3(ti)},o=new Map,{attributes:s}=e,l=t?Object.keys(s):null,u=e.index,c=s.position,d=e6(e),f=d,p=0;r&&(p=e.drawRange.start,e.drawRange.count!==1/0&&(d=~~(e.drawRange.count/3)));let h=this.data;(!h||h.length<3*f)&&(h=new Int32Array(3*f)),h.fill(-1);let m=0,g=new Set;for(let e=p,t=3*d+p;e<t;e+=3){let t=e;for(let e=0;e<3;e++){let r=t+e;u&&(r=u.getX(r)),to[e]=a(r)}for(let e=0;e<3;e++){let r=(e+1)%3,n=to[e],i=to[r],a=`${i}_${n}`;if(o.has(a)){let r=t+e,n=o.get(a);h[r]=n,h[n]=r,o.delete(a),m+=2,g.delete(n)}else{let r=`${n}_${i}`,a=t+e;o.set(r,a),g.add(a)}}}if(n){let{fragmentMap:t,disjointConnectivityMap:r}=function(e,t,r){let n=e.attributes,i=e.index,a=n.position,o=new Map,s=new Map,l=Array.from(t),u=new e9;for(let e=0,t=l.length;e<t;e++){let t,r=l[e],n=~~(r/3),o=r%3,c=3*n+o,d=3*n+(o+1)%3;i&&(c=i.getX(c),d=i.getX(d)),te.fromBufferAttribute(a,c),tt.fromBufferAttribute(a,d),function(e,t,r){r.direction.subVectors(t,e).normalize();let n=e.dot(r.direction);r.origin.copy(e).addScaledVector(r.direction,-n)}(te,tt,tr);let f=u.findClosestRay(tr);null===f&&(f=tr.clone(),u.addRay(f)),s.has(f)||s.set(f,{forward:[],reverse:[],ray:f}),t=s.get(f);let p=e7(f,te),h=e7(f,tt);p>h&&([p,h]=[h,p]),0>tr.direction.dot(f.direction)?t.reverse.push({start:p,end:h,index:r}):t.forward.push({start:p,end:h,index:r})}return s.forEach(({forward:e,reverse:t},n)=>{!function(e,t,r,n=1e-8){e.sort(e8),t.sort(e8);for(let n=0;n<e.length;n++){let i=e[n];for(let s=0;s<t.length;s++){let l=t[s];if(l.start>i.end);else if(i.end<l.start||l.end<i.start)continue;else if(i.start<=l.start&&i.end>=l.end)a(l.end,i.end)||e.splice(n+1,0,{start:l.end,end:i.end,index:i.index}),i.end=l.start,l.start=0,l.end=0;else if(i.start>=l.start&&i.end<=l.end)a(i.end,l.end)||t.splice(s+1,0,{start:i.end,end:l.end,index:l.index}),l.end=i.start,i.start=0,i.end=0;else if(i.start<=l.start&&i.end<=l.end){let e=i.end;i.end=l.start,l.start=e}else if(i.start>=l.start&&i.end>=l.end){let e=l.end;l.end=i.start,i.start=e}else throw Error();if(r.has(i.index)||r.set(i.index,[]),r.has(l.index)||r.set(l.index,[]),r.get(i.index).push(l.index),r.get(l.index).push(i.index),o(l)&&(t.splice(s,1),s--),o(i)){e.splice(n,1),n--;break}}}function i(e){for(let t=0;t<e.length;t++)o(e[t])&&(e.splice(t,1),t--)}function a(e,t){return Math.abs(t-e)<n}function o(e){return Math.abs(e.end-e.start)<n}i(e),i(t)}(e,t,o,r),0===e.length&&0===t.length&&s.delete(n)}),{disjointConnectivityMap:o,fragmentMap:s}}(e,g,i);g.clear(),t.forEach(({forward:e,reverse:t})=>{e.forEach(({index:e})=>g.add(e)),t.forEach(({index:e})=>g.add(e))}),this.unmatchedDisjointEdges=t,this.disjointConnections=r,m=3*d-g.size}this.matchedEdges=m,this.unmatchedEdges=g.size,this.data=h}}class tl extends l.eaF{constructor(...e){super(...e),this.isBrush=!0,this._previousMatrix=new l.kn4,this._previousMatrix.elements.fill(0)}markUpdated(){this._previousMatrix.copy(this.matrix)}isDirty(){let{matrix:e,_previousMatrix:t}=this,r=e.elements,n=t.elements;for(let e=0;e<16;e++)if(r[e]!==n[e])return!0;return!1}prepareGeometry(){let e=this.geometry,t=e.attributes,r=e4();if(r)for(let e in t){let r=t[e];if(r.isInterleavedBufferAttribute)throw Error("Brush: InterleavedBufferAttributes are not supported.");r.array=function(e){if(e.buffer instanceof SharedArrayBuffer)return e;let t=e.constructor,r=e.buffer,n=new SharedArrayBuffer(r.byteLength),i=new Uint8Array(r);return new Uint8Array(n).set(i,0),new t(n)}(r.array)}if(e.boundsTree||(!function(e,t){if(!e.index){let r=e.attributes.position.count,n=function(e,t=ArrayBuffer){return e>65535?new Uint32Array(new t(4*e)):new Uint16Array(new t(2*e))}(r,t.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);e.setIndex(new l.THS(n,1));for(let e=0;e<r;e++)n[e]=e}}(e,{useSharedArrayBuffer:r}),e.boundsTree=new eJ(e,{maxLeafTris:3,indirect:!0,useSharedArrayBuffer:r})),e.halfEdges||(e.halfEdges=new ts(e)),!e.groupIndices){let t=new Uint16Array(e6(e)),r=e.groups;for(let e=0,n=r.length;e<n;e++){let{start:n,count:i}=r[e];for(let r=n/3,a=(n+i)/3;r<a;r++)t[r]=e}e.groupIndices=t}}disposeCacheData(){let{geometry:e}=this;e.halfEdges=null,e.boundsTree=null,e.groupIndices=null}}let tu=new l.Pq0,tc=new l.Pq0,td=new l.Pq0;function tf(e,t=1e-14){tu.subVectors(e.b,e.a),tc.subVectors(e.c,e.a),td.subVectors(e.b,e.c);let r=tu.angleTo(tc),n=tu.angleTo(td),i=Math.PI-r-n;return Math.abs(r)<t||Math.abs(n)<t||Math.abs(i)<t||e.a.distanceToSquared(e.b)<t||e.a.distanceToSquared(e.c)<t||e.b.distanceToSquared(e.c)<t}let tp=new l.cZY,th=new l.cZY,tm=new l.Pq0,tg=new l.Pq0,ty=new l.Pq0,tw=new l.Zcv,tv=new _;class tx{constructor(){this._pool=[],this._index=0}getTriangle(){return this._index>=this._pool.length&&this._pool.push(new l.lMl),this._pool[this._index++]}clear(){this._index=0}reset(){this._pool.length=0,this._index=0}}class tb{constructor(){this.trianglePool=new tx,this.triangles=[],this.normal=new l.Pq0,this.coplanarTriangleUsed=!1}initialize(e){this.reset();let{triangles:t,trianglePool:r,normal:n}=this;if(Array.isArray(e))for(let i=0,a=e.length;i<a;i++){let a=e[i];if(0===i)a.getNormal(n);else if(Math.abs(1-a.getNormal(tm).dot(n))>1e-10)throw Error("Triangle Splitter: Cannot initialize with triangles that have different normals.");let o=r.getTriangle();o.copy(a),t.push(o)}else{e.getNormal(n);let i=r.getTriangle();i.copy(e),t.push(i)}}splitByTriangle(e){let{normal:t,triangles:r}=this;if(e.getNormal(tg).normalize(),1e-10>Math.abs(1-Math.abs(tg.dot(t)))){this.coplanarTriangleUsed=!0;for(let e=0,t=r.length;e<t;e++)r[e].coplanarCount=0;let t=[e.a,e.b,e.c];for(let r=0;r<3;r++){let n=(r+1)%3,i=t[r],a=t[n];tm.subVectors(a,i).normalize(),ty.crossVectors(tg,tm),tw.setFromNormalAndCoplanarPoint(ty,i),this.splitByPlane(tw,e)}}else e.getPlane(tw),this.splitByPlane(tw,e)}splitByPlane(e,t){let{triangles:r,trianglePool:n}=this;tv.copy(t),tv.needsUpdate=!0;for(let t=0,i=r.length;t<i;t++){let a=r[t];if(!tv.intersectsTriangle(a,tp,!0))continue;let{a:o,b:s,c:l}=a,u=0,c=-1,d=!1,f=[],p=[],h=[o,s,l];for(let t=0;t<3;t++){let r=(t+1)%3;tp.start.copy(h[t]),tp.end.copy(h[r]);let n=e.distanceToPoint(tp.start),i=e.distanceToPoint(tp.end);if(1e-10>Math.abs(n)&&1e-10>Math.abs(i)){d=!0;break}if(n>0?f.push(t):p.push(t),1e-10>Math.abs(n))continue;let a=!!e.intersectLine(tp,tm);!a&&1e-10>Math.abs(i)&&(tm.copy(tp.end),a=!0),a&&!(1e-10>tm.distanceTo(tp.start))&&(1e-10>tm.distanceTo(tp.end)&&(c=t),0===u?th.start.copy(tm):th.end.copy(tm),u++)}if(!d&&2===u&&th.distance()>1e-10)if(-1!==c){let e=0;0==(c=(c+1)%3)&&(e=(e+1)%3);let o=e+1;o===c&&(o=(o+1)%3);let s=n.getTriangle();s.a.copy(h[o]),s.b.copy(th.end),s.c.copy(th.start),tf(s)||r.push(s),a.a.copy(h[e]),a.b.copy(th.start),a.c.copy(th.end),tf(a)&&(r.splice(t,1),t--,i--)}else{let e=f.length>=2?p[0]:f[0];if(0===e){let e=th.start;th.start=th.end,th.end=e}let o=(e+1)%3,s=(e+2)%3,l=n.getTriangle(),u=n.getTriangle();h[o].distanceToSquared(th.start)<h[s].distanceToSquared(th.end)?(l.a.copy(h[o]),l.b.copy(th.start),l.c.copy(th.end),u.a.copy(h[o]),u.b.copy(h[s]),u.c.copy(th.start)):(l.a.copy(h[s]),l.b.copy(th.start),l.c.copy(th.end),u.a.copy(h[o]),u.b.copy(h[s]),u.c.copy(th.end)),a.a.copy(h[e]),a.b.copy(th.end),a.c.copy(th.start),tf(l)||r.push(l),tf(u)||r.push(u),tf(a)&&(r.splice(t,1),t--,i--)}else 3===u&&console.warn("TriangleClipper: Coplanar clip not handled")}}reset(){this.triangles.length=0,this.trianglePool.clear(),this.coplanarTriangleUsed=!1}}class tM{constructor(e,t=500){this.expansionFactor=1.5,this.type=e,this.length=0,this.array=null,this.setSize(t)}setType(e){if(0!==this.length)throw Error("TypeBackedArray: Cannot change the type while there is used data in the buffer.");let t=this.array.buffer;this.array=new e(t),this.type=e}setSize(e){var t;if(this.array&&e===this.array.length)return;let r=this.type,n=new r(new(e4()?SharedArrayBuffer:ArrayBuffer)((t=~~(t=e*r.BYTES_PER_ELEMENT))+4-t%4));this.array&&n.set(this.array,0),this.array=n}expand(){let{array:e,expansionFactor:t}=this;this.setSize(e.length*t)}push(...e){let{array:t,length:r}=this;r+e.length>t.length&&(this.expand(),t=this.array);for(let n=0,i=e.length;n<i;n++)t[r+n]=e[n];this.length+=e.length}clear(){this.length=0}}class tP{constructor(){this.groupAttributes=[{}],this.groupCount=0}getType(e){return this.groupAttributes[0][e].type}getItemSize(e){return this.groupAttributes[0][e].itemSize}getNormalized(e){return this.groupAttributes[0][e].normalized}getCount(e){if(this.groupCount<=e)return 0;let t=this.getGroupAttrArray("position",e);return t.length/t.itemSize}getTotalLength(e){let{groupCount:t,groupAttributes:r}=this,n=0;for(let i=0;i<t;i++)n+=r[i][e].length;return n}getGroupAttrSet(e=0){let{groupAttributes:t}=this;if(t[e])return this.groupCount=Math.max(this.groupCount,e+1),t[e];let r=t[0];for(this.groupCount=Math.max(this.groupCount,e+1);e>=t.length;){let e={};for(let n in t.push(e),r){let t=r[n],i=new tM(t.type);i.itemSize=t.itemSize,i.normalized=t.normalized,e[n]=i}}return t[e]}getGroupAttrArray(e,t=0){let{groupAttributes:r}=this;if(!r[0][e])throw Error(`TypedAttributeData: Attribute with "${e}" has not been initialized`);return this.getGroupAttrSet(t)[e]}initializeArray(e,t,r,n){let{groupAttributes:i}=this,a=i[0][e];if(a){if(a.type!==t)for(let a=0,o=i.length;a<o;a++){let o=i[a][e];o.setType(t),o.itemSize=r,o.normalized=n}}else for(let a=0,o=i.length;a<o;a++){let o=new tM(t);o.itemSize=r,o.normalized=n,i[a][e]=o}}clear(){this.groupCount=0;let{groupAttributes:e}=this;e.forEach(e=>{for(let t in e)e[t].clear()})}delete(e){this.groupAttributes.forEach(t=>{delete t[e]})}reset(){this.groupAttributes=[],this.groupCount=0}}class tA{constructor(){this.intersectionSet={},this.ids=[]}add(e,t){let{intersectionSet:r,ids:n}=this;r[e]||(r[e]=[],n.push(e)),r[e].push(t)}}let tE=new l.RlV,tT=new l.kn4,tS=new l.lMl,tB=new l.Pq0,tC=new l.IUQ,t_=new l.IUQ,tI=new l.IUQ,tR=new l.IUQ,tU=new l.IUQ,tk=new l.IUQ,tF=new l.cZY,tz=new l.Pq0,tq=null;function tO(e,t){e.getMidpoint(tE.origin),e.getNormal(tE.direction);let r=t.raycastFirst(tE,l.$EB);return r&&tE.direction.dot(r.face.normal)>0?-1:1}function tD(e,t,r=!1){switch(e){case 0:if(1===t||2===t&&!r)return 1;break;case 1:if(r){if(-1===t)return 0}else if(1===t||-2===t)return 1;break;case 2:if(r){if(1===t||-2===t)return 1}else if(-1===t)return 0;break;case 4:if(-1===t)return 0;if(1===t)return 1;break;case 3:if(-1===t||2===t&&!r)return 1;break;case 5:if(!r&&(1===t||-2===t))return 1;break;case 6:if(!r&&(-1===t||2===t))return 1;break;default:throw Error(`Unrecognized CSG operation enum "${e}".`)}return 2}function tW(e,t,r,n,i,a,o=!1,s=!1){let l=e=>{a.push(e.x),i>1&&a.push(e.y),i>2&&a.push(e.z),i>3&&a.push(e.w)};tR.set(0,0,0,0).addScaledVector(e,n.a.x).addScaledVector(t,n.a.y).addScaledVector(r,n.a.z),tU.set(0,0,0,0).addScaledVector(e,n.b.x).addScaledVector(t,n.b.y).addScaledVector(r,n.b.z),tk.set(0,0,0,0).addScaledVector(e,n.c.x).addScaledVector(t,n.c.y).addScaledVector(r,n.c.z),s&&(tR.normalize(),tU.normalize(),tk.normalize()),l(tR),o?(l(tk),l(tU)):(l(tU),l(tk))}function tN(e,t,r,n,i,a=!1){for(let o in i){let s=t[o],l=i[o];if(!(o in t))throw Error(`CSG Operations: Attribute ${o} no available on geometry.`);let u=s.itemSize;"position"===o?(tB.fromBufferAttribute(s,e).applyMatrix4(r),l.push(tB.x,tB.y,tB.z)):"normal"===o?(tB.fromBufferAttribute(s,e).applyNormalMatrix(n),a&&tB.multiplyScalar(-1),l.push(tB.x,tB.y,tB.z)):(l.push(s.getX(e)),u>1&&l.push(s.getY(e)),u>2&&l.push(s.getZ(e)),u>3&&l.push(s.getW(e)))}}class tL{constructor(e){this.triangle=new l.lMl().copy(e),this.intersects={}}addTriangle(e,t){this.intersects[e]=new l.lMl().copy(t)}getIntersectArray(){let e=[],{intersects:t}=this;for(let r in t)e.push(t[r]);return e}}class tj{constructor(){this.data={}}addTriangleIntersection(e,t,r,n){let{data:i}=this;i[e]||(i[e]=new tL(t)),i[e].addTriangle(r,n)}getTrianglesAsArray(e=null){let{data:t}=this,r=[];if(null!==e)e in t&&r.push(t[e].triangle);else for(let e in t)r.push(t[e].triangle);return r}getTriangleIndices(){return Object.keys(this.data).map(e=>parseInt(e))}getIntersectionIndices(e){let{data:t}=this;return t[e]?Object.keys(t[e].intersects).map(e=>parseInt(e)):[]}getIntersectionsAsArray(e=null,t=null){let{data:r}=this,n=new Set,i=[],a=e=>{if(r[e])if(null!==t)r[e].intersects[t]&&i.push(r[e].intersects[t]);else{let t=r[e].intersects;for(let e in t)n.has(e)||(n.add(e),i.push(t[e]))}};if(null!==e)a(e);else for(let e in r)a(e);return i}reset(){this.data={}}}class tH{constructor(){this.enabled=!1,this.triangleIntersectsA=new tj,this.triangleIntersectsB=new tj,this.intersectionEdges=[]}addIntersectingTriangles(e,t,r,n){let{triangleIntersectsA:i,triangleIntersectsB:a}=this;i.addTriangleIntersection(e,t,r,n),a.addTriangleIntersection(r,n,e,t)}addEdge(e){this.intersectionEdges.push(e.clone())}reset(){this.triangleIntersectsA.reset(),this.triangleIntersectsB.reset(),this.intersectionEdges=[]}init(){this.enabled&&(this.reset(),tq=this)}complete(){this.enabled&&(tq=null)}}let tG=new l.kn4,t$=new l.dwI,tV=new l.lMl,tX=new l.lMl,tY=new l.lMl,tZ=new l.lMl,tQ=[],tK=[];function tJ(e,t,r,n,i,a,o,s=0){let u=0>e.matrixWorld.determinant();tG.copy(t.matrixWorld).invert().multiply(e.matrixWorld),t$.getNormalMatrix(e.matrixWorld).multiplyScalar(u?-1:1);let c=e.geometry.groupIndices,d=e.geometry.index,f=e.geometry.attributes.position,p=t.geometry.boundsTree,h=t.geometry.index,m=t.geometry.attributes.position,g=r.ids,y=r.intersectionSet;for(let t=0,r=g.length;t<r;t++){let r=g[t],w=-1===s?0:c[r]+s,v=3*r,x=d.getX(v+0),b=d.getX(v+1),M=d.getX(v+2);tV.a.fromBufferAttribute(f,x).applyMatrix4(tG),tV.b.fromBufferAttribute(f,b).applyMatrix4(tG),tV.c.fromBufferAttribute(f,M).applyMatrix4(tG),a.reset(),a.initialize(tV);let P=y[r];for(let e=0,t=P.length;e<t;e++){let t=3*P[e],r=h.getX(t+0),n=h.getX(t+1),i=h.getX(t+2);tX.a.fromBufferAttribute(m,r),tX.b.fromBufferAttribute(m,n),tX.c.fromBufferAttribute(m,i),a.splitByTriangle(tX)}let A=a.triangles;for(let t=0,s=A.length;t<s;t++){let s=A[t],c=a.coplanarTriangleUsed?function(e,t){function r(){return Math.random()-.5}e.getNormal(tz),tE.direction.copy(tz),e.getMidpoint(tE.origin);let n=0,i=1/0;for(let e=0;e<3;e++){tE.direction.x+=1e-8*r(),tE.direction.y+=1e-8*r(),tE.direction.z+=1e-8*r(),tE.direction.multiplyScalar(-1);let a=t.raycastFirst(tE,l.$EB);if(a&&tE.direction.dot(a.face.normal)>0&&n++,null!==a&&(i=Math.min(i,a.distance)),i<=1e-15)return a.face.normal.dot(tz)>0?2:-2;if(n/3>.5||(e-n+1)/3>.5)break}return n/3>.5?-1:1}(s,p):tO(s,p);tQ.length=0,tK.length=0;for(let e=0,t=n.length;e<t;e++){let t=tD(n[e],c,i);2!==t&&(tK.push(t),tQ.push(o[e].getGroupAttrSet(w)))}if(0!==tQ.length){tV.getBarycoord(s.a,tZ.a),tV.getBarycoord(s.b,tZ.b),tV.getBarycoord(s.c,tZ.c);for(let t=0,n=tQ.length;t<n;t++){let n=tQ[t],i=0===tK[t];!function(e,t,r,n,i,a,o=!1){let s=r.attributes,l=r.index,u=3*e,c=l.getX(u+0),d=l.getX(u+1),f=l.getX(u+2);for(let e in a){let r=s[e],l=a[e];if(!(e in s))throw Error(`CSG Operations: Attribute ${e} not available on geometry.`);let u=r.itemSize;"position"===e?(tS.a.fromBufferAttribute(r,c).applyMatrix4(n),tS.b.fromBufferAttribute(r,d).applyMatrix4(n),tS.c.fromBufferAttribute(r,f).applyMatrix4(n),tW(tS.a,tS.b,tS.c,t,3,l,o)):"normal"===e?(tS.a.fromBufferAttribute(r,c).applyNormalMatrix(i),tS.b.fromBufferAttribute(r,d).applyNormalMatrix(i),tS.c.fromBufferAttribute(r,f).applyNormalMatrix(i),o&&(tS.a.multiplyScalar(-1),tS.b.multiplyScalar(-1),tS.c.multiplyScalar(-1)),tW(tS.a,tS.b,tS.c,t,3,l,o,!0)):(tC.fromBufferAttribute(r,c),t_.fromBufferAttribute(r,d),tI.fromBufferAttribute(r,f),tW(tC,t_,tI,t,u,l,o))}}(r,tZ,e.geometry,e.matrixWorld,t$,n,u!==i)}}}}return g.length}function t0(e,t,r,n,i,a,o=0){let s=0>e.matrixWorld.determinant();tG.copy(t.matrixWorld).invert().multiply(e.matrixWorld),t$.getNormalMatrix(e.matrixWorld).multiplyScalar(s?-1:1);let l=t.geometry.boundsTree,u=e.geometry.groupIndices,c=e.geometry.index,d=e.geometry.attributes,f=d.position,p=[],h=e.geometry.halfEdges,m=new Set,g=e6(e.geometry);for(let e=0;e<g;e++)e in r.intersectionSet||m.add(e);for(;m.size>0;){let t=function(e){for(let t of e)return t}(m);m.delete(t),p.push(t);let r=3*t,g=c.getX(r+0),y=c.getX(r+1),w=c.getX(r+2);tY.a.fromBufferAttribute(f,g).applyMatrix4(tG),tY.b.fromBufferAttribute(f,y).applyMatrix4(tG),tY.c.fromBufferAttribute(f,w).applyMatrix4(tG);let v=tO(tY,l);tK.length=0,tQ.length=0;for(let e=0,t=n.length;e<t;e++){let t=tD(n[e],v,i);2!==t&&(tK.push(t),tQ.push(a[e]))}for(;p.length>0;){let t=p.pop();for(let e=0;e<3;e++){let r=h.getSiblingTriangleIndex(t,e);-1!==r&&m.has(r)&&(p.push(r),m.delete(r))}if(0!==tQ.length){let r=3*t,n=c.getX(r+0),i=c.getX(r+1),a=c.getX(r+2),l=-1===o?0:u[t]+o;if(tY.a.fromBufferAttribute(f,n),tY.b.fromBufferAttribute(f,i),tY.c.fromBufferAttribute(f,a),!tf(tY))for(let t=0,r=tQ.length;t<r;t++){let r=tK[t],o=tQ[t].getGroupAttrSet(l),u=0===r;!function(e,t,r,n,i,a,o,s=!1){tN(e,n,i,a,o,s),tN(s?r:t,n,i,a,o,s),tN(s?t:r,n,i,a,o,s)}(n,i,a,d,e.matrixWorld,t$,o,u!==s)}}}}}function t1(e,t){let r=t;return Array.isArray(t)||(r=[],e.forEach(e=>{r[e.materialIndex]=t})),r}class t2{constructor(){this.triangleSplitter=new tb,this.attributeData=[],this.attributes=["position","uv","normal"],this.useGroups=!0,this.consolidateGroups=!0,this.debug=new tH}getGroupRanges(e){return this.useGroups&&0!==e.groups.length?e.groups.map(e=>({...e})):[{start:0,count:1/0,materialIndex:0}]}evaluate(e,t,r,n=new tl){let i=!0;if(Array.isArray(r)||(r=[r]),Array.isArray(n)||(n=[n],i=!1),n.length!==r.length)throw Error("Evaluator: operations and target array passed as different sizes.");e.prepareGeometry(),t.prepareGeometry();let{triangleSplitter:a,attributeData:o,attributes:s,useGroups:u,consolidateGroups:c,debug:d}=this;for(;o.length<n.length;)o.push(new tP);n.forEach((t,r)=>{!function(e,t,r,n){r.clear();let i=e.attributes;for(let e=0,t=n.length;e<t;e++){let t=n[e],a=i[t];r.initializeArray(t,a.array.constructor,a.itemSize,a.normalized)}for(let e in r.attributes)n.includes(e)||r.delete(e);for(let e in t.attributes)n.includes(e)||(t.deleteAttribute(e),t.dispose())}(e.geometry,t.geometry,o[r],s)}),d.init(),function(e,t,r,n,i,a={}){let o,{useGroups:s=!0}=a,{aIntersections:l,bIntersections:u}=function(e,t){let r=new tA,n=new tA;return tT.copy(e.matrixWorld).invert().multiply(t.matrixWorld),e.geometry.boundsTree.bvhcast(t.geometry.boundsTree,tT,{intersectsTriangles(i,a,o,s){if(!tf(i)&&!tf(a)){let l=i.intersectsTriangle(a,tF,!0);if(!l){let e=i.plane,t=a.plane,r=e.normal,n=t.normal;1===r.dot(n)&&1e-14>Math.abs(e.constant-t.constant)&&(l=!0)}if(l){let l=e.geometry.boundsTree.resolveTriangleIndex(o),u=t.geometry.boundsTree.resolveTriangleIndex(s);r.add(l,u),n.add(u,l),tq&&(tq.addEdge(tF),tq.addIntersectingTriangles(o,i,s,a))}}return!1}}),{aIntersections:r,bIntersections:n}}(e,t);tJ(e,t,l,r,!1,n,i,o=s?0:-1),t0(e,t,l,r,!1,i,o),-1!==r.findIndex(e=>6!==e&&5!==e)&&(o=s?e.geometry.groups.length||1:-1,tJ(t,e,u,r,!0,n,i,o),t0(t,e,u,r,!0,i,o)),tQ.length=0,tK.length=0}(e,t,r,a,o,{useGroups:u}),d.complete();let f=this.getGroupRanges(e.geometry),p=t1(f,e.material),h=this.getGroupRanges(t.geometry),m=t1(h,t.material);h.forEach(e=>e.materialIndex+=p.length);let g=[...f,...h].map((e,t)=>({...e,index:t}));if(u){let e=[...p,...m];c&&(g=g.map(t=>{let r=e[t.materialIndex];return t.materialIndex=e.indexOf(r),t}).sort((e,t)=>e.materialIndex-t.materialIndex));let t=[];for(let r=0,n=e.length;r<n;r++){let n=!1;for(let e=0,i=g.length;e<i;e++){let i=g[e];i.materialIndex===r&&(n=!0,i.materialIndex=t.length)}n&&t.push(e[r])}n.forEach(e=>{e.material=t})}else g=[{start:0,count:1/0,index:0,materialIndex:0}],n.forEach(e=>{e.material=p[0]});return n.forEach((e,t)=>{let r=e.geometry;!function(e,t,r){let n=!1,i=-1,a=e.attributes,o=t.groupAttributes[0];for(let s in o){let o=t.getTotalLength(s),u=t.getType(s),c=t.getItemSize(s),d=t.getNormalized(s),f=a[s];(!f||f.array.length<o)&&(f=new l.THS(new u(o),c,d),e.setAttribute(s,f),n=!0);let p=0;for(let e=0,n=Math.min(r.length,t.groupCount);e<n;e++){let n=r[e].index,{array:i,type:a,length:o}=t.groupAttributes[n][s],l=new a(i.buffer,0,o);f.array.set(l,p),p+=l.length}f.needsUpdate=!0,i=o/f.itemSize}if(e.index){let t=e.index.array;if(t.length<i)e.index=null,n=!0;else for(let e=0,r=t.length;e<r;e++)t[e]=e}let s=0;e.clearGroups();for(let n=0,i=Math.min(r.length,t.groupCount);n<i;n++){let{index:i,materialIndex:a}=r[n],o=t.getCount(i);0!==o&&(e.addGroup(s,o,a),s+=o)}e.setDrawRange(0,i),e.boundsTree=null,n&&e.dispose()}(r,o[t],g),c&&function(e){for(let t=0;t<e.length-1;t++){let r=e[t],n=e[t+1];if(r.materialIndex===n.materialIndex){let i=r.start,a=n.start+n.count;n.start=i,n.count=a-i,e.splice(t,1),t--}}}(r.groups)}),i?n:n[0]}evaluateHierarchy(e,t=new tl){e.updateMatrixWorld(!0);let r=(e,t)=>{let n=e.children;for(let e=0,i=n.length;e<i;e++){let i=n[e];i.isOperationGroup?r(i,t):t(i)}},n=e=>{let t=e.children,i=!1;for(let e=0,r=t.length;e<r;e++)i=n(t[e])||i;let a=e.isDirty();if(a&&e.markUpdated(),!i||e.isOperationGroup)return i||a;{let t;return r(e,r=>{t=t?this.evaluate(t,r,r.operation):this.evaluate(e,r,r.operation)}),e._cachedGeometry=t.geometry,e._cachedMaterials=t.material,!0}};return n(e),t.geometry=e._cachedGeometry,t.material=e._cachedMaterials,t}reset(){this.triangleSplitter.reset()}}let t3={subtraction:1,reverseSubtraction:2,addition:0,difference:4,intersection:3};function t4(e){let t=null;return e instanceof tl?(e.updateMatrixWorld(),t=e):e.traverse(e=>{e.updateMatrixWorld(),!t&&e instanceof tl&&(t=e)}),t}let t6=o.createContext(null),t5=o.forwardRef(({children:e,computeVertexNormals:t=!1,useGroups:r=!1,consolidateGroups:n=!1,showOperations:i=!1},a)=>{let s=o.useRef(null),l=o.useRef(null),u=o.useMemo(()=>Object.assign(new t2,{useGroups:r,consolidateGroups:n}),[r,n]),c=o.useCallback(()=>{try{let a=l.current.children.slice();if(a.length>0){!function(e){e.dispose(),e.attributes={},e.groups=[],e.boundsTree=e.index=e.boundingBox=e.boundingSphere=null,e.drawRange={start:0,count:1/0}}(s.current),l.current.matrixWorld.identity();let o=t4(a.shift());if(o){for(var e,r,n,i;a.length;){let e=t4(a.shift());e&&(o=u.evaluate(o,e,t3[e.operator]||0))}s.current.boundsTree=o.geometry.boundsTree,s.current.index=o.geometry.index,s.current.attributes=o.geometry.attributes,s.current.groups=o.geometry.groups,s.current.drawRange=o.geometry.drawRange,u.useGroups&&null!=(e=s.current)&&null!=(r=e.__r3f)&&null!=(n=r.parent)&&null!=(i=n.object)&&i.material&&(s.current.__r3f.parent.object.material=o.material),t&&s.current.computeVertexNormals()}}}catch(e){console.log(e)}},[t,u]),d=o.useMemo(()=>({computeVertexNormals:t,showOperations:i,useGroups:r,consolidateGroups:n,update:c}),[t,i,r,n]);return o.useLayoutEffect(()=>void c()),o.useImperativeHandle(a,()=>({geometry:s.current,operations:l.current,...d}),[d]),o.createElement(o.Fragment,null,o.createElement("group",{matrixAutoUpdate:!1,ref:l},o.createElement(t6.Provider,{value:d},e)),o.createElement("bufferGeometry",{ref:s}))}),t8=o.forwardRef(({showOperation:e=!1,operator:t="addition",...r},n)=>{(0,s.e)({Brush:tl});let{showOperations:i}=o.useContext(t6);return o.createElement("brush",(0,a.A)({operator:t,raycast:()=>null,visible:e||i,ref:n},r))}),t7=o.forwardRef((e,t)=>o.createElement(t8,(0,a.A)({ref:t,operator:"addition"},e))),t9=o.forwardRef((e,t)=>o.createElement(t8,(0,a.A)({ref:t,operator:"subtraction"},e)))},60730:(e,t,r)=>{r.d(t,{z:()=>v,F:()=>d});var n=r(6152),i=r(80600),a=r(36038),o=r(13022);let s=n.forwardRef(({envMap:e,resolution:t=256,frames:r=1/0,children:s,makeDefault:l,...u},c)=>{let d=(0,i.C)(({set:e})=>e),f=(0,i.C)(({camera:e})=>e),p=(0,i.C)(({size:e})=>e),h=n.useRef(null);n.useImperativeHandle(c,()=>h.current,[]);let m=n.useRef(null),g=function(e,t,r){let o=(0,i.C)(e=>e.size),s=(0,i.C)(e=>e.viewport),l="number"==typeof e?e:o.width*s.dpr,u=o.height*s.dpr,c=("number"==typeof e?void 0:e)||{},{samples:d=0,depth:f,...p}=c,h=null!=f?f:c.depthBuffer,m=n.useMemo(()=>{let e=new a.nWS(l,u,{minFilter:a.k6q,magFilter:a.k6q,type:a.ix0,...p});return h&&(e.depthTexture=new a.VCu(l,u,a.RQf)),e.samples=d,e},[]);return n.useLayoutEffect(()=>{m.setSize(l,u),d&&(m.samples=d)},[d,m,l,u]),n.useEffect(()=>()=>m.dispose(),[]),m}(t);n.useLayoutEffect(()=>{u.manual||h.current.updateProjectionMatrix()},[p,u]),n.useLayoutEffect(()=>{h.current.updateProjectionMatrix()}),n.useLayoutEffect(()=>{if(l)return d(()=>({camera:h.current})),()=>d(()=>({camera:f}))},[h,l,d]);let y=0,w=null,v="function"==typeof s;return(0,i.D)(t=>{v&&(r===1/0||y<r)&&(m.current.visible=!1,t.gl.setRenderTarget(g),w=t.scene.background,e&&(t.scene.background=e),t.gl.render(t.scene,h.current),t.scene.background=w,t.gl.setRenderTarget(null),m.current.visible=!0,y++)}),n.createElement(n.Fragment,null,n.createElement("orthographicCamera",(0,o.A)({left:-(p.width/2),right:p.width/2,top:p.height/2,bottom:-(p.height/2),ref:h},u),!v&&s),n.createElement("group",{ref:m},v&&s(g.texture)))});function l({defaultScene:e,defaultCamera:t,renderPriority:r=1}){let a,{gl:o,scene:s,camera:l}=(0,i.C)();return(0,i.D)(()=>{a=o.autoClear,1===r&&(o.autoClear=!0,o.render(e,t)),o.autoClear=!1,o.clearDepth(),o.render(s,l),o.autoClear=a},r),n.createElement("group",{onPointerOver:()=>null})}function u({children:e,renderPriority:t=1}){let{scene:r,camera:o}=(0,i.C)(),[s]=n.useState(()=>new a.Z58);return n.createElement(n.Fragment,null,(0,i.o)(n.createElement(n.Fragment,null,e,n.createElement(l,{defaultScene:r,defaultCamera:o,renderPriority:t})),s,{events:{priority:t+1}}))}let c=n.createContext({}),d=()=>n.useContext(c),f=2*Math.PI,p=new a.B69,h=new a.kn4,[m,g]=[new a.PTz,new a.PTz],y=new a.Pq0,w=new a.Pq0,v=({alignment:e="bottom-right",margin:t=[80,80],renderPriority:r=1,onUpdate:o,onTarget:l,children:d})=>{let v=(0,i.C)(e=>e.size),x=(0,i.C)(e=>e.camera),b=(0,i.C)(e=>e.controls),M=(0,i.C)(e=>e.invalidate),P=n.useRef(null),A=n.useRef(null),E=n.useRef(!1),T=n.useRef(0),S=n.useRef(new a.Pq0(0,0,0)),B=n.useRef(new a.Pq0(0,0,0));n.useEffect(()=>{B.current.copy(x.up),p.up.copy(x.up)},[x]);let C=n.useCallback(e=>{E.current=!0,(b||l)&&(S.current=(null==l?void 0:l())||("getTarget"in b?b.getTarget(S.current):null==b?void 0:b.target)),T.current=x.position.distanceTo(y),m.copy(x.quaternion),w.copy(e).multiplyScalar(T.current).add(y),p.lookAt(w),g.copy(p.quaternion),M()},[b,x,l,M]);(0,i.D)((e,t)=>{if(A.current&&P.current){var r;E.current&&(.01>m.angleTo(g)?(E.current=!1,"minPolarAngle"in b&&x.up.copy(B.current)):(m.rotateTowards(g,t*f),x.position.set(0,0,1).applyQuaternion(m).multiplyScalar(T.current).add(S.current),x.up.set(0,1,0).applyQuaternion(m).normalize(),x.quaternion.copy(m),"getTarget"in b&&b.setPosition(x.position.x,x.position.y,x.position.z),o?o():b&&b.update(t),M())),h.copy(x.matrix).invert(),null==(r=P.current)||r.quaternion.setFromRotationMatrix(h)}});let _=n.useMemo(()=>({tweenCamera:C}),[C]),[I,R]=t,U=e.endsWith("-center")?0:e.endsWith("-left")?-v.width/2+I:v.width/2-I,k=e.startsWith("center-")?0:e.startsWith("top-")?v.height/2-R:-v.height/2+R;return n.createElement(u,{renderPriority:r},n.createElement(c.Provider,{value:_},n.createElement(s,{makeDefault:!0,ref:A,position:[0,0,200]}),n.createElement("group",{ref:P,position:[U,k,0]},d)))}},63535:(e,t,r)=>{r.d(t,{A:()=>n});function n(){return(n=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)({}).hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(null,arguments)}},80845:(e,t,r)=>{r.d(t,{t:()=>c});var n=r(13022),i=r(6152),a=r(80600),o=r(36038),s=r(60730);function l({scale:e=[.8,.05,.05],color:t,rotation:r}){return i.createElement("group",{rotation:r},i.createElement("mesh",{position:[.4,0,0]},i.createElement("boxGeometry",{args:e}),i.createElement("meshBasicMaterial",{color:t,toneMapped:!1})))}function u({onClick:e,font:t,disabled:r,arcStyle:s,label:l,labelColor:u,axisHeadScale:c=1,...d}){let f=(0,a.C)(e=>e.gl),p=i.useMemo(()=>{let e=document.createElement("canvas");e.width=64,e.height=64;let r=e.getContext("2d");return r.beginPath(),r.arc(32,32,16,0,2*Math.PI),r.closePath(),r.fillStyle=s,r.fill(),l&&(r.font=t,r.textAlign="center",r.fillStyle=u,r.fillText(l,32,41)),new o.GOR(e)},[s,l,u,t]),[h,m]=i.useState(!1),g=(l?1:.75)*(h?1.2:1)*c;return i.createElement("sprite",(0,n.A)({scale:g,onPointerOver:r?void 0:e=>{e.stopPropagation(),m(!0)},onPointerOut:r?void 0:e||(e=>{e.stopPropagation(),m(!1)})},d),i.createElement("spriteMaterial",{map:p,"map-anisotropy":f.capabilities.getMaxAnisotropy()||1,alphaTest:.3,opacity:l?1:.75,toneMapped:!1}))}let c=({hideNegativeAxes:e,hideAxisHeads:t,disabled:r,font:a="18px Inter var, Arial, sans-serif",axisColors:o=["#ff2060","#20df80","#2080ff"],axisHeadScale:c=1,axisScale:d,labels:f=["X","Y","Z"],labelColor:p="#000",onClick:h,...m})=>{let[g,y,w]=o,{tweenCamera:v}=(0,s.F)(),x={font:a,disabled:r,labelColor:p,onClick:h,axisHeadScale:c,onPointerDown:r?void 0:e=>{v(e.object.position),e.stopPropagation()}};return i.createElement("group",(0,n.A)({scale:40},m),i.createElement(l,{color:g,rotation:[0,0,0],scale:d}),i.createElement(l,{color:y,rotation:[0,0,Math.PI/2],scale:d}),i.createElement(l,{color:w,rotation:[0,-Math.PI/2,0],scale:d}),!t&&i.createElement(i.Fragment,null,i.createElement(u,(0,n.A)({arcStyle:g,position:[1,0,0],label:f[0]},x)),i.createElement(u,(0,n.A)({arcStyle:y,position:[0,1,0],label:f[1]},x)),i.createElement(u,(0,n.A)({arcStyle:w,position:[0,0,1],label:f[2]},x)),!e&&i.createElement(i.Fragment,null,i.createElement(u,(0,n.A)({arcStyle:g,position:[-1,0,0]},x)),i.createElement(u,(0,n.A)({arcStyle:y,position:[0,-1,0]},x)),i.createElement(u,(0,n.A)({arcStyle:w,position:[0,0,-1]},x)))))}},86780:(e,t,r)=>{let n;r.d(t,{OH:()=>ew});var i=r(13022),a=r(6152),o=r(80600),s=r(36038),l=r(46210);class u extends s.eaF{constructor(e,t){var r,n;let i=(e=>e&&e.isCubeTexture)(e),a=Math.floor(Math.log2((null!=(n=i?null==(r=e.image[0])?void 0:r.width:e.image.width)?n:1024)/4)),o=Math.pow(2,a),u=3*Math.max(o,112),c=`
        varying vec3 vWorldPosition;
        void main() 
        {
            vec4 worldPosition = ( modelMatrix * vec4( position, 1.0 ) );
            vWorldPosition = worldPosition.xyz;
            
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }
        `,d=[i?"#define ENVMAP_TYPE_CUBE":"",`#define CUBEUV_TEXEL_WIDTH ${1/u}`,`#define CUBEUV_TEXEL_HEIGHT ${1/(4*o)}`,`#define CUBEUV_MAX_MIP ${a}.0`].join("\n")+`
        #define ENVMAP_TYPE_CUBE_UV
        varying vec3 vWorldPosition;
        uniform float radius;
        uniform float height;
        uniform float angle;
        #ifdef ENVMAP_TYPE_CUBE
            uniform samplerCube map;
        #else
            uniform sampler2D map;
        #endif
        // From: https://www.shadertoy.com/view/4tsBD7
        float diskIntersectWithBackFaceCulling( vec3 ro, vec3 rd, vec3 c, vec3 n, float r ) 
        {
            float d = dot ( rd, n );
            
            if( d > 0.0 ) { return 1e6; }
            
            vec3  o = ro - c;
            float t = - dot( n, o ) / d;
            vec3  q = o + rd * t;
            
            return ( dot( q, q ) < r * r ) ? t : 1e6;
        }
        // From: https://www.iquilezles.org/www/articles/intersectors/intersectors.htm
        float sphereIntersect( vec3 ro, vec3 rd, vec3 ce, float ra ) 
        {
            vec3 oc = ro - ce;
            float b = dot( oc, rd );
            float c = dot( oc, oc ) - ra * ra;
            float h = b * b - c;
            
            if( h < 0.0 ) { return -1.0; }
            
            h = sqrt( h );
            
            return - b + h;
        }
        vec3 project() 
        {
            vec3 p = normalize( vWorldPosition );
            vec3 camPos = cameraPosition;
            camPos.y -= height;
            float intersection = sphereIntersect( camPos, p, vec3( 0.0 ), radius );
            if( intersection > 0.0 ) {
                
                vec3 h = vec3( 0.0, - height, 0.0 );
                float intersection2 = diskIntersectWithBackFaceCulling( camPos, p, h, vec3( 0.0, 1.0, 0.0 ), radius );
                p = ( camPos + min( intersection, intersection2 ) * p ) / radius;
            } else {
                p = vec3( 0.0, 1.0, 0.0 );
            }
            return p;
        }
        #include <common>
        #include <cube_uv_reflection_fragment>
        void main() 
        {
            vec3 projectedWorldPosition = project();
            
            #ifdef ENVMAP_TYPE_CUBE
                vec3 outcolor = textureCube( map, projectedWorldPosition ).rgb;
            #else
                vec3 direction = normalize( projectedWorldPosition );
                vec2 uv = equirectUv( direction );
                vec3 outcolor = texture2D( map, uv ).rgb;
            #endif
            gl_FragColor = vec4( outcolor, 1.0 );
            #include <tonemapping_fragment>
            #include <${l.r>=154?"colorspace_fragment":"encodings_fragment"}>
        }
        `,f={map:{value:e},height:{value:(null==t?void 0:t.height)||15},radius:{value:(null==t?void 0:t.radius)||100}};super(new s.WBB(1,16),new s.BKk({uniforms:f,fragmentShader:d,vertexShader:c,side:s.$EB}))}set radius(e){this.material.uniforms.radius.value=e}get radius(){return this.material.uniforms.radius.value}set height(e){this.material.uniforms.height.value=e}get height(){return this.material.uniforms.height.value}}class c extends s.BRH{constructor(e){super(e),this.type=s.ix0}parse(e){let t,r,n,i=function(e,t){switch(e){case 1:throw Error("THREE.RGBELoader: Read Error: "+(t||""));case 2:throw Error("THREE.RGBELoader: Write Error: "+(t||""));case 3:throw Error("THREE.RGBELoader: Bad File Format: "+(t||""));default:throw Error("THREE.RGBELoader: Memory Error: "+(t||""))}},a=function(e,t,r){t=t||1024;let n=e.pos,i=-1,a=0,o="",s=String.fromCharCode.apply(null,new Uint16Array(e.subarray(n,n+128)));for(;0>(i=s.indexOf("\n"))&&a<t&&n<e.byteLength;)o+=s,a+=s.length,n+=128,s+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(n,n+128)));return -1<i&&(!1!==r&&(e.pos+=a+i+1),o+s.slice(0,i))},o=new Uint8Array(e);o.pos=0;let l=function(e){let t,r,n=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,o=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,s=/^\s*FORMAT=(\S+)\s*$/,l=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,u={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};for(!(e.pos>=e.byteLength)&&(t=a(e))||i(1,"no header found"),(r=t.match(/^#\?(\S+)/))||i(3,"bad initial token"),u.valid|=1,u.programtype=r[1],u.string+=t+"\n";!1!==(t=a(e));){if(u.string+=t+"\n","#"===t.charAt(0)){u.comments+=t+"\n";continue}if((r=t.match(n))&&(u.gamma=parseFloat(r[1])),(r=t.match(o))&&(u.exposure=parseFloat(r[1])),(r=t.match(s))&&(u.valid|=2,u.format=r[1]),(r=t.match(l))&&(u.valid|=4,u.height=parseInt(r[1],10),u.width=parseInt(r[2],10)),2&u.valid&&4&u.valid)break}return 2&u.valid||i(3,"missing format specifier"),4&u.valid||i(3,"missing image size specifier"),u}(o),u=l.width,c=l.height,d=function(e,t,r){if(t<8||t>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);t!==(e[2]<<8|e[3])&&i(3,"wrong scanline width");let n=new Uint8Array(4*t*r);n.length||i(4,"unable to allocate buffer space");let a=0,o=0,s=4*t,l=new Uint8Array(4),u=new Uint8Array(s),c=r;for(;c>0&&o<e.byteLength;){o+4>e.byteLength&&i(1),l[0]=e[o++],l[1]=e[o++],l[2]=e[o++],l[3]=e[o++],(2!=l[0]||2!=l[1]||(l[2]<<8|l[3])!=t)&&i(3,"bad rgbe scanline format");let r=0,d;for(;r<s&&o<e.byteLength;){let t=(d=e[o++])>128;if(t&&(d-=128),(0===d||r+d>s)&&i(3,"bad scanline data"),t){let t=e[o++];for(let e=0;e<d;e++)u[r++]=t}else u.set(e.subarray(o,o+d),r),r+=d,o+=d}for(let e=0;e<t;e++){let r=0;n[a]=u[e+r],r+=t,n[a+1]=u[e+r],r+=t,n[a+2]=u[e+r],r+=t,n[a+3]=u[e+r],a+=4}c--}return n}(o.subarray(o.pos),u,c);switch(this.type){case s.RQf:let f=new Float32Array(4*(n=d.length/4));for(let e=0;e<n;e++)!function(e,t,r,n){let i=Math.pow(2,e[t+3]-128)/255;r[n+0]=e[t+0]*i,r[n+1]=e[t+1]*i,r[n+2]=e[t+2]*i,r[n+3]=1}(d,4*e,f,4*e);t=f,r=s.RQf;break;case s.ix0:let p=new Uint16Array(4*(n=d.length/4));for(let e=0;e<n;e++)!function(e,t,r,n){let i=Math.pow(2,e[t+3]-128)/255;r[n+0]=s.GxU.toHalfFloat(Math.min(e[t+0]*i,65504)),r[n+1]=s.GxU.toHalfFloat(Math.min(e[t+1]*i,65504)),r[n+2]=s.GxU.toHalfFloat(Math.min(e[t+2]*i,65504)),r[n+3]=s.GxU.toHalfFloat(1)}(d,4*e,p,4*e);t=p,r=s.ix0;break;default:throw Error("THREE.RGBELoader: Unsupported type: "+this.type)}return{width:u,height:c,data:t,header:l.string,gamma:l.gamma,exposure:l.exposure,type:r}}setDataType(e){return this.type=e,this}load(e,t,r,n){return super.load(e,function(e,r){switch(e.type){case s.RQf:case s.ix0:"colorSpace"in e?e.colorSpace="srgb-linear":e.encoding=3e3,e.minFilter=s.k6q,e.magFilter=s.k6q,e.generateMipmaps=!1,e.flipY=!0}t&&t(e,r)},r,n)}}var d=Uint8Array,f=Uint16Array,p=Uint32Array,h=new d([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),m=new d([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),g=new d([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),y=function(e,t){for(var r=new f(31),n=0;n<31;++n)r[n]=t+=1<<e[n-1];for(var i=new p(r[30]),n=1;n<30;++n)for(var a=r[n];a<r[n+1];++a)i[a]=a-r[n]<<5|n;return[r,i]},w=y(h,2),v=w[0],x=w[1];v[28]=258,x[258]=28;var b=y(m,0),M=b[0];b[1];for(var P=new f(32768),A=0;A<32768;++A){var E=(43690&A)>>>1|(21845&A)<<1;E=(61680&(E=(52428&E)>>>2|(13107&E)<<2))>>>4|(3855&E)<<4,P[A]=((65280&E)>>>8|(255&E)<<8)>>>1}for(var T=function(e,t,r){for(var n,i=e.length,a=0,o=new f(t);a<i;++a)++o[e[a]-1];var s=new f(t);for(a=0;a<t;++a)s[a]=s[a-1]+o[a-1]<<1;if(r){n=new f(1<<t);var l=15-t;for(a=0;a<i;++a)if(e[a])for(var u=a<<4|e[a],c=t-e[a],d=s[e[a]-1]++<<c,p=d|(1<<c)-1;d<=p;++d)n[P[d]>>>l]=u}else for(a=0,n=new f(i);a<i;++a)e[a]&&(n[a]=P[s[e[a]-1]++]>>>15-e[a]);return n},S=new d(288),A=0;A<144;++A)S[A]=8;for(var A=144;A<256;++A)S[A]=9;for(var A=256;A<280;++A)S[A]=7;for(var A=280;A<288;++A)S[A]=8;for(var B=new d(32),A=0;A<32;++A)B[A]=5;var C=T(S,9,1),_=T(B,5,1),I=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},R=function(e,t,r){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(7&t)&r},U=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(7&t)},k=function(e,t,r){(null==t||t<0)&&(t=0),(null==r||r>e.length)&&(r=e.length);var n=new(e instanceof f?f:e instanceof p?p:d)(r-t);return n.set(e.subarray(t,r)),n},F=function(e,t,r){var n=e.length;if(!n||r&&!r.l&&n<5)return t||new d(0);var i=!t||r,a=!r||r.i;r||(r={}),t||(t=new d(3*n));var o=function(e){var r=t.length;if(e>r){var n=new d(Math.max(2*r,e));n.set(t),t=n}},s=r.f||0,l=r.p||0,u=r.b||0,c=r.l,f=r.d,p=r.m,y=r.n,w=8*n;do{if(!c){r.f=s=R(e,l,1);var x=R(e,l+1,3);if(l+=3,x)if(1==x)c=C,f=_,p=9,y=5;else if(2==x){var b=R(e,l,31)+257,P=R(e,l+10,15)+4,A=b+R(e,l+5,31)+1;l+=14;for(var E=new d(A),S=new d(19),B=0;B<P;++B)S[g[B]]=R(e,l+3*B,7);l+=3*P;for(var F=I(S),z=(1<<F)-1,q=T(S,F,1),B=0;B<A;){var O=q[R(e,l,z)];l+=15&O;var D=O>>>4;if(D<16)E[B++]=D;else{var W=0,N=0;for(16==D?(N=3+R(e,l,3),l+=2,W=E[B-1]):17==D?(N=3+R(e,l,7),l+=3):18==D&&(N=11+R(e,l,127),l+=7);N--;)E[B++]=W}}var L=E.subarray(0,b),j=E.subarray(b);p=I(L),y=I(j),c=T(L,p,1),f=T(j,y,1)}else throw"invalid block type";else{var H,D=((H=l)/8|0)+(7&H&&1)+4,G=e[D-4]|e[D-3]<<8,$=D+G;if($>n){if(a)throw"unexpected EOF";break}i&&o(u+G),t.set(e.subarray(D,$),u),r.b=u+=G,r.p=l=8*$;continue}if(l>w){if(a)throw"unexpected EOF";break}}i&&o(u+131072);for(var V=(1<<p)-1,X=(1<<y)-1,Y=l;;Y=l){var W=c[U(e,l)&V],Z=W>>>4;if((l+=15&W)>w){if(a)throw"unexpected EOF";break}if(!W)throw"invalid length/literal";if(Z<256)t[u++]=Z;else if(256==Z){Y=l,c=null;break}else{var Q=Z-254;if(Z>264){var B=Z-257,K=h[B];Q=R(e,l,(1<<K)-1)+v[B],l+=K}var J=f[U(e,l)&X],ee=J>>>4;if(!J)throw"invalid distance";l+=15&J;var j=M[ee];if(ee>3){var K=m[ee];j+=U(e,l)&(1<<K)-1,l+=K}if(l>w){if(a)throw"unexpected EOF";break}i&&o(u+131072);for(var et=u+Q;u<et;u+=4)t[u]=t[u-j],t[u+1]=t[u+1-j],t[u+2]=t[u+2-j],t[u+3]=t[u+3-j];u=et}}r.l=c,r.p=Y,r.b=u,c&&(s=1,r.m=p,r.d=f,r.n=y)}while(!s);return u==t.length?t:k(t,0,u)},z=new d(0),q=function(e){if((15&e[0])!=8||e[0]>>>4>7||(e[0]<<8|e[1])%31)throw"invalid zlib data";if(32&e[1])throw"invalid zlib data: preset dictionaries not supported"};function O(e,t){return F((q(e),e.subarray(2,-4)),t)}var D="undefined"!=typeof TextDecoder&&new TextDecoder;try{D.decode(z,{stream:!0})}catch(e){}let W=l.r>=152;class N extends s.BRH{constructor(e){super(e),this.type=s.ix0}parse(e){let t={l:0,c:0,lc:0};function r(e,r,n,i,a){for(;n<e;)r=r<<8|T(i,a),n+=8;t.l=r>>(n-=e)&(1<<e)-1,t.c=r,t.lc=n}let n=Array(59),i={c:0,lc:0};function a(e,t,r,n){e=e<<8|T(r,n),t+=8,i.c=e,i.lc=t}let o={c:0,lc:0};function l(e,t,r,n,s,l,u,c,d,f){if(e==t){n<8&&(a(r,n,s,u),r=i.c,n=i.lc);var p=r>>(n-=8),p=new Uint8Array([p])[0];if(d.value+p>f)return!1;for(var h=c[d.value-1];p-- >0;)c[d.value++]=h}else{if(!(d.value<f))return!1;c[d.value++]=e}o.c=r,o.lc=n}function u(e){var t=65535&e;return t>32767?t-65536:t}let c={a:0,b:0};function d(e,t){var r=u(e),n=u(t),i=r+(1&n)+(n>>1),a=i-n;c.a=i,c.b=a}function f(e,t){var r=65535&t,n=(65535&e)-(r>>1)&65535;c.a=r+n-32768&65535,c.b=n}function p(e,s,u,c,d,f){var p=u.value,h=E(s,u),m=E(s,u);u.value+=4;var g=E(s,u);if(u.value+=4,h<0||h>=65537||m<0||m>=65537)throw"Something wrong with HUF_ENCSIZE";for(var y=Array(65537),w=Array(16384),v=0;v<16384;v++)w[v]={},w[v].len=0,w[v].lit=0,w[v].p=null;var x=c-(u.value-p);if(!function(e,i,a,o,s,l,u){for(var c=0,d=0;s<=l;s++){if(a.value-a.value>o)return!1;r(6,c,d,e,a);var f=t.l;if(c=t.c,d=t.lc,u[s]=f,63==f){if(a.value-a.value>o)throw"Something wrong with hufUnpackEncTable";r(8,c,d,e,a);var p=t.l+6;if(c=t.c,d=t.lc,s+p>l+1)throw"Something wrong with hufUnpackEncTable";for(;p--;)u[s++]=0;s--}else if(f>=59){var p=f-59+2;if(s+p>l+1)throw"Something wrong with hufUnpackEncTable";for(;p--;)u[s++]=0;s--}}!function(e){for(var t=0;t<=58;++t)n[t]=0;for(var t=0;t<65537;++t)n[e[t]]+=1;for(var r=0,t=58;t>0;--t){var i=r+n[t]>>1;n[t]=r,r=i}for(var t=0;t<65537;++t){var a=e[t];a>0&&(e[t]=a|n[a]++<<6)}}(u)}(e,0,u,x,h,m,y),g>8*(c-(u.value-p)))throw"Something wrong with hufUncompress";!function(e,t,r,n){for(;t<=r;t++){var i=e[t]>>6,a=63&e[t];if(i>>a)throw"Invalid table entry";if(a>14){var o=n[i>>a-14];if(o.len)throw"Invalid table entry";if(o.lit++,o.p){var s=o.p;o.p=Array(o.lit);for(var l=0;l<o.lit-1;++l)o.p[l]=s[l]}else o.p=[,];o.p[o.lit-1]=t}else if(a)for(var u=0,l=1<<14-a;l>0;l--){var o=n[(i<<14-a)+u];if(o.len||o.p)throw"Invalid table entry";o.len=a,o.lit=t,u++}}}(y,h,m,w),function(e,t,r,n,s,u,c,d,f,p){for(var h=0,m=0,g=Math.trunc(s.value+(u+7)/8);s.value<g;)for(a(h,m,r,s),h=i.c,m=i.lc;m>=14;){var y=t[h>>m-14&16383];if(y.len)m-=y.len,l(y.lit,c,h,m,r,n,s,f,p,d),h=o.c,m=o.lc;else{if(!y.p)throw"hufDecode issues";for(w=0;w<y.lit;w++){for(var w,v=63&e[y.p[w]];m<v&&s.value<g;)a(h,m,r,s),h=i.c,m=i.lc;if(m>=v&&e[y.p[w]]>>6==(h>>m-v&(1<<v)-1)){m-=v,l(y.p[w],c,h,m,r,n,s,f,p,d),h=o.c,m=o.lc;break}}if(w==y.lit)throw"hufDecode issues"}}var x=8-u&7;for(h>>=x,m-=x;m>0;){var y=t[h<<14-m&16383];if(y.len)m-=y.len,l(y.lit,c,h,m,r,n,s,f,p,d),h=o.c,m=o.lc;else throw"hufDecode issues"}}(y,w,e,s,u,g,m,f,d,{value:0})}function h(e){for(var t=1;t<e.length;t++){var r=e[t-1]+e[t]-128;e[t]=r}}function m(e,t){for(var r=0,n=Math.floor((e.length+1)/2),i=0,a=e.length-1;!(i>a)&&(t[i++]=e[r++],!(i>a));){;t[i++]=e[n++]}}function g(e){for(var t=e.byteLength,r=[],n=0,i=new DataView(e);t>0;){var a=i.getInt8(n++);if(a<0){var o=-a;t-=o+1;for(var s=0;s<o;s++)r.push(i.getUint8(n++))}else{var o=a;t-=2;for(var l=i.getUint8(n++),s=0;s<o+1;s++)r.push(l)}}return r}function y(e){return new DataView(e.array.buffer,e.offset.value,e.size)}function w(e){var t=new Uint8Array(g(e.viewer.buffer.slice(e.offset.value,e.offset.value+e.size))),r=new Uint8Array(t.length);return h(t),m(t,r),new DataView(r.buffer)}function v(e){var t=O(e.array.slice(e.offset.value,e.offset.value+e.size)),r=new Uint8Array(t.length);return h(t),m(t,r),new DataView(r.buffer)}function x(e){for(var t=e.viewer,r={value:e.offset.value},n=new Uint16Array(e.width*e.scanlineBlockSize*(e.channels*e.type)),i=new Uint8Array(8192),a=0,o=Array(e.channels),s=0;s<e.channels;s++)o[s]={},o[s].start=a,o[s].end=o[s].start,o[s].nx=e.width,o[s].ny=e.lines,o[s].size=e.type,a+=o[s].nx*o[s].ny*o[s].size;var l=R(t,r),u=R(t,r);if(u>=8192)throw"Something is wrong with PIZ_COMPRESSION BITMAP_SIZE";if(l<=u)for(var s=0;s<u-l+1;s++)i[s+l]=S(t,r);var h=new Uint16Array(65536),m=function(e,t){for(var r=0,n=0;n<65536;++n)(0==n||e[n>>3]&1<<(7&n))&&(t[r++]=n);for(var i=r-1;r<65536;)t[r++]=0;return i}(i,h),g=E(t,r);p(e.array,t,r,g,n,a);for(var s=0;s<e.channels;++s)for(var y=o[s],w=0;w<o[s].size;++w)!function(e,t,r,n,i,a,o){for(var s=o<16384,l=r>i?i:r,u=1;u<=l;)u<<=1;for(u>>=1,p=u,u>>=1;u>=1;){for(var p,h,m,g,y,w=0,v=0+a*(i-p),x=a*u,b=a*p,M=n*u,P=n*p;w<=v;w+=b){for(var A=w,E=w+n*(r-p);A<=E;A+=P){var T=A+M,S=A+x,B=S+M;s?(d(e[A+t],e[S+t]),h=c.a,g=c.b,d(e[T+t],e[B+t]),m=c.a,y=c.b,d(h,m),e[A+t]=c.a,e[T+t]=c.b,d(g,y)):(f(e[A+t],e[S+t]),h=c.a,g=c.b,f(e[T+t],e[B+t]),m=c.a,y=c.b,f(h,m),e[A+t]=c.a,e[T+t]=c.b,f(g,y)),e[S+t]=c.a,e[B+t]=c.b}if(r&u){var S=A+x;s?d(e[A+t],e[S+t]):f(e[A+t],e[S+t]),h=c.a,e[S+t]=c.b,e[A+t]=h}}if(i&u)for(var A=w,E=w+n*(r-p);A<=E;A+=P){var T=A+M;s?d(e[A+t],e[T+t]):f(e[A+t],e[T+t]),h=c.a,e[T+t]=c.b,e[A+t]=h}p=u,u>>=1}}(n,y.start+w,y.nx,y.size,y.ny,y.nx*y.size,m);for(var v=a,x=0;x<v;++x)n[x]=h[n[x]];for(var b=0,M=new Uint8Array(n.buffer.byteLength),P=0;P<e.lines;P++)for(var A=0;A<e.channels;A++){var y=o[A],T=y.nx*y.size,B=new Uint8Array(n.buffer,2*y.end,2*T);M.set(B,b),b+=2*T,y.end+=T}return new DataView(M.buffer)}function b(e){var t=O(e.array.slice(e.offset.value,e.offset.value+e.size));let r=e.lines*e.channels*e.width,n=1==e.type?new Uint16Array(r):new Uint32Array(r),i=0,a=0,o=[,,,,];for(let r=0;r<e.lines;r++)for(let r=0;r<e.channels;r++){let r=0;switch(e.type){case 1:o[0]=i,o[1]=o[0]+e.width,i=o[1]+e.width;for(let i=0;i<e.width;++i)r+=t[o[0]++]<<8|t[o[1]++],n[a]=r,a++;break;case 2:o[0]=i,o[1]=o[0]+e.width,o[2]=o[1]+e.width,i=o[2]+e.width;for(let i=0;i<e.width;++i)r+=t[o[0]++]<<24|t[o[1]++]<<16|t[o[2]++]<<8,n[a]=r,a++}}return new DataView(n.buffer)}function M(e){var t=e.viewer,r={value:e.offset.value},n=new Uint8Array(e.width*e.lines*(e.channels*e.type*2)),i={version:B(t,r),unknownUncompressedSize:B(t,r),unknownCompressedSize:B(t,r),acCompressedSize:B(t,r),dcCompressedSize:B(t,r),rleCompressedSize:B(t,r),rleUncompressedSize:B(t,r),rleRawSize:B(t,r),totalAcUncompressedCount:B(t,r),totalDcUncompressedCount:B(t,r),acCompression:B(t,r)};if(i.version<2)throw"EXRLoader.parse: "+q.compression+" version "+i.version+" is unsupported";for(var a=[],o=R(t,r)-2;o>0;){var l=P(t.buffer,r),u=S(t,r),c=u>>2&3,d=new Int8Array([(u>>4)-1])[0],f=S(t,r);a.push({name:l,index:d,type:f,compression:c}),o-=l.length+3}for(var h=q.channels,m=Array(e.channels),y=0;y<e.channels;++y){var w=m[y]={},x=h[y];w.name=x.name,w.compression=0,w.decoded=!1,w.type=x.pixelType,w.pLinear=x.pLinear,w.width=e.width,w.height=e.lines}for(var b={idx:[,,,]},M=0;M<e.channels;++M)for(var w=m[M],y=0;y<a.length;++y){var A=a[y];w.name==A.name&&(w.compression=A.compression,A.index>=0&&(b.idx[A.index]=M),w.offset=M)}if(i.acCompressedSize>0)switch(i.acCompression){case 0:var E=new Uint16Array(i.totalAcUncompressedCount);p(e.array,t,r,i.acCompressedSize,E,i.totalAcUncompressedCount);break;case 1:var T=e.array.slice(r.value,r.value+i.totalAcUncompressedCount),C=O(T),E=new Uint16Array(C.buffer);r.value+=i.totalAcUncompressedCount}if(i.dcCompressedSize>0){var _=new Uint16Array(v({array:e.array,offset:r,size:i.dcCompressedSize}).buffer);r.value+=i.dcCompressedSize}if(i.rleRawSize>0){var T=e.array.slice(r.value,r.value+i.rleCompressedSize),C=O(T),U=g(C.buffer);r.value+=i.rleCompressedSize}for(var k=0,F=Array(m.length),y=0;y<F.length;++y)F[y]=[];for(var z=0;z<e.lines;++z)for(var D=0;D<m.length;++D)F[D].push(k),k+=m[D].width*e.type*2;!function(e,t,r,n,i,a){var o=new DataView(a.buffer),l=r[e.idx[0]].width,u=r[e.idx[0]].height,c=Math.floor(l/8),d=Math.ceil(l/8),f=Math.ceil(u/8),p=l-(d-1)*8,h=u-(f-1)*8,m={value:0},g=[,,,],y=[,,,],w=[,,,],v=[,,,],x=[,,,];for(let r=0;r<3;++r)x[r]=t[e.idx[r]],g[r]=r<1?0:g[r-1]+d*f,y[r]=new Float32Array(64),w[r]=new Uint16Array(64),v[r]=new Uint16Array(64*d);for(let t=0;t<f;++t){var b,M,P=8;t==f-1&&(P=h);var A=8;for(let e=0;e<d;++e){e==d-1&&(A=p);for(let e=0;e<3;++e){w[e].fill(0),w[e][0]=i[g[e]++],function(e,t,r){for(var n,i=1;i<64;)65280==(n=t[e.value])?i=64:n>>8==255?i+=255&n:(r[i]=n,i++),e.value++}(m,n,w[e]),b=w[e],(M=y[e])[0]=I(b[0]),M[1]=I(b[1]),M[2]=I(b[5]),M[3]=I(b[6]),M[4]=I(b[14]),M[5]=I(b[15]),M[6]=I(b[27]),M[7]=I(b[28]),M[8]=I(b[2]),M[9]=I(b[4]),M[10]=I(b[7]),M[11]=I(b[13]),M[12]=I(b[16]),M[13]=I(b[26]),M[14]=I(b[29]),M[15]=I(b[42]),M[16]=I(b[3]),M[17]=I(b[8]),M[18]=I(b[12]),M[19]=I(b[17]),M[20]=I(b[25]),M[21]=I(b[30]),M[22]=I(b[41]),M[23]=I(b[43]),M[24]=I(b[9]),M[25]=I(b[11]),M[26]=I(b[18]),M[27]=I(b[24]),M[28]=I(b[31]),M[29]=I(b[40]),M[30]=I(b[44]),M[31]=I(b[53]),M[32]=I(b[10]),M[33]=I(b[19]),M[34]=I(b[23]),M[35]=I(b[32]),M[36]=I(b[39]),M[37]=I(b[45]),M[38]=I(b[52]),M[39]=I(b[54]),M[40]=I(b[20]),M[41]=I(b[22]),M[42]=I(b[33]),M[43]=I(b[38]),M[44]=I(b[46]),M[45]=I(b[51]),M[46]=I(b[55]),M[47]=I(b[60]),M[48]=I(b[21]),M[49]=I(b[34]),M[50]=I(b[37]),M[51]=I(b[47]),M[52]=I(b[50]),M[53]=I(b[56]),M[54]=I(b[59]),M[55]=I(b[61]),M[56]=I(b[35]),M[57]=I(b[36]),M[58]=I(b[48]),M[59]=I(b[49]),M[60]=I(b[57]),M[61]=I(b[58]),M[62]=I(b[62]),M[63]=I(b[63]),function(e){let t=.5*Math.cos(3.14159/16),r=.5*Math.cos(3.14159/8),n=.5*Math.cos(3*3.14159/16),i=.5*Math.cos(3*3.14159/8);for(var a=[,,,,],o=[,,,,],s=[,,,,],l=[,,,,],u=0;u<8;++u){var c=8*u;a[0]=r*e[c+2],a[1]=i*e[c+2],a[2]=r*e[c+6],a[3]=i*e[c+6],o[0]=t*e[c+1]+n*e[c+3]+.2777854612564676*e[c+5]+.09754573032714427*e[c+7],o[1]=n*e[c+1]-.09754573032714427*e[c+3]-t*e[c+5]-.2777854612564676*e[c+7],o[2]=.2777854612564676*e[c+1]-t*e[c+3]+.09754573032714427*e[c+5]+n*e[c+7],o[3]=.09754573032714427*e[c+1]-.2777854612564676*e[c+3]+n*e[c+5]-t*e[c+7],s[0]=.35355362513961314*(e[c+0]+e[c+4]),s[3]=.35355362513961314*(e[c+0]-e[c+4]),s[1]=a[0]+a[3],s[2]=a[1]-a[2],l[0]=s[0]+s[1],l[1]=s[3]+s[2],l[2]=s[3]-s[2],l[3]=s[0]-s[1],e[c+0]=l[0]+o[0],e[c+1]=l[1]+o[1],e[c+2]=l[2]+o[2],e[c+3]=l[3]+o[3],e[c+4]=l[3]-o[3],e[c+5]=l[2]-o[2],e[c+6]=l[1]-o[1],e[c+7]=l[0]-o[0]}for(var d=0;d<8;++d)a[0]=r*e[16+d],a[1]=i*e[16+d],a[2]=r*e[48+d],a[3]=i*e[48+d],o[0]=t*e[8+d]+n*e[24+d]+.2777854612564676*e[40+d]+.09754573032714427*e[56+d],o[1]=n*e[8+d]-.09754573032714427*e[24+d]-t*e[40+d]-.2777854612564676*e[56+d],o[2]=.2777854612564676*e[8+d]-t*e[24+d]+.09754573032714427*e[40+d]+n*e[56+d],o[3]=.09754573032714427*e[8+d]-.2777854612564676*e[24+d]+n*e[40+d]-t*e[56+d],s[0]=.35355362513961314*(e[d]+e[32+d]),s[3]=.35355362513961314*(e[d]-e[32+d]),s[1]=a[0]+a[3],s[2]=a[1]-a[2],l[0]=s[0]+s[1],l[1]=s[3]+s[2],l[2]=s[3]-s[2],l[3]=s[0]-s[1],e[0+d]=l[0]+o[0],e[8+d]=l[1]+o[1],e[16+d]=l[2]+o[2],e[24+d]=l[3]+o[3],e[32+d]=l[3]-o[3],e[40+d]=l[2]-o[2],e[48+d]=l[1]-o[1],e[56+d]=l[0]-o[0]}(y[e])}for(var E=y,T=0;T<64;++T){var S=E[0][T],B=E[1][T],C=E[2][T];E[0][T]=S+1.5747*C,E[1][T]=S-.1873*B-.4682*C,E[2][T]=S+1.8556*B}for(let t=0;t<3;++t)!function(e,t,r){for(var n,i=0;i<64;++i){t[r+i]=s.GxU.toHalfFloat((n=e[i])<=1?Math.sign(n)*Math.pow(Math.abs(n),2.2):Math.sign(n)*Math.pow(9.025013291561939,Math.abs(n)-1))}}(y[t],v[t],64*e)}let a=0;for(let n=0;n<3;++n){let i=r[e.idx[n]].type;for(let e=8*t;e<8*t+P;++e){a=x[n][e];for(let t=0;t<c;++t){let r=64*t+(7&e)*8;o.setUint16(a+0*i,v[n][r+0],!0),o.setUint16(a+2*i,v[n][r+1],!0),o.setUint16(a+4*i,v[n][r+2],!0),o.setUint16(a+6*i,v[n][r+3],!0),o.setUint16(a+8*i,v[n][r+4],!0),o.setUint16(a+10*i,v[n][r+5],!0),o.setUint16(a+12*i,v[n][r+6],!0),o.setUint16(a+14*i,v[n][r+7],!0),a+=16*i}}if(c!=d)for(let e=8*t;e<8*t+P;++e){let t=x[n][e]+8*c*2*i,r=64*c+(7&e)*8;for(let e=0;e<A;++e)o.setUint16(t+2*e*i,v[n][r+e],!0)}}}for(var _=new Uint16Array(l),o=new DataView(a.buffer),R=0;R<3;++R){r[e.idx[R]].decoded=!0;var U=r[e.idx[R]].type;if(2==r[R].type)for(var k=0;k<u;++k){let e=x[R][k];for(var F=0;F<l;++F)_[F]=o.getUint16(e+2*F*U,!0);for(var F=0;F<l;++F)o.setFloat32(e+2*F*U,I(_[F]),!0)}}}(b,F,m,E,_,n);for(var y=0;y<m.length;++y){var w=m[y];if(!w.decoded)if(2===w.compression)for(var W=0,N=0,z=0;z<e.lines;++z){for(var L=F[y][W],j=0;j<w.width;++j){for(var H=0;H<2*w.type;++H)n[L++]=U[N+H*w.width*w.height];N++}W++}else throw"EXRLoader.parse: unsupported channel compression"}return new DataView(n.buffer)}function P(e,t){for(var r=new Uint8Array(e),n=0;0!=r[t.value+n];)n+=1;var i=new TextDecoder().decode(r.slice(t.value,t.value+n));return t.value=t.value+n+1,i}function A(e,t){var r=e.getInt32(t.value,!0);return t.value=t.value+4,r}function E(e,t){var r=e.getUint32(t.value,!0);return t.value=t.value+4,r}function T(e,t){var r=e[t.value];return t.value=t.value+1,r}function S(e,t){var r=e.getUint8(t.value);return t.value=t.value+1,r}let B=function(e,t){let r;return r="getBigInt64"in DataView.prototype?Number(e.getBigInt64(t.value,!0)):e.getUint32(t.value+4,!0)+Number(e.getUint32(t.value,!0)<<32),t.value+=8,r};function C(e,t){var r=e.getFloat32(t.value,!0);return t.value+=4,r}function _(e,t){return s.GxU.toHalfFloat(C(e,t))}function I(e){var t=(31744&e)>>10,r=1023&e;return(e>>15?-1:1)*(t?31===t?r?NaN:1/0:Math.pow(2,t-15)*(1+r/1024):r/1024*6103515625e-14)}function R(e,t){var r=e.getUint16(t.value,!0);return t.value+=2,r}function U(e,t){return I(R(e,t))}let k=new DataView(e),F=new Uint8Array(e),z={value:0},q=function(e,t,r){let n={};if(0x1312f76!=e.getUint32(0,!0))throw"THREE.EXRLoader: provided file doesn't appear to be in OpenEXR format.";n.version=e.getUint8(4);let i=e.getUint8(5);n.spec={singleTile:!!(2&i),longName:!!(4&i),deepFormat:!!(8&i),multiPart:!!(16&i)},r.value=8;for(var a=!0;a;){var o=P(t,r);if(0==o)a=!1;else{var s=P(t,r),l=E(e,r),u=function(e,t,r,n,i){var a,o,s,l,u,c,d;if("string"===n||"stringvector"===n||"iccProfile"===n)return a=new TextDecoder().decode(new Uint8Array(t).slice(r.value,r.value+i)),r.value=r.value+i,a;if("chlist"===n)return function(e,t,r,n){for(var i=r.value,a=[];r.value<i+n-1;){var o=P(t,r),s=A(e,r),l=S(e,r);r.value+=3;var u=A(e,r),c=A(e,r);a.push({name:o,pixelType:s,pLinear:l,xSampling:u,ySampling:c})}return r.value+=1,a}(e,t,r,i);if("chromaticities"===n)return o=C(e,r),s=C(e,r),l=C(e,r),u=C(e,r),c=C(e,r),{redX:o,redY:s,greenX:l,greenY:u,blueX:c,blueY:C(e,r),whiteX:C(e,r),whiteY:C(e,r)};if("compression"===n)return["NO_COMPRESSION","RLE_COMPRESSION","ZIPS_COMPRESSION","ZIP_COMPRESSION","PIZ_COMPRESSION","PXR24_COMPRESSION","B44_COMPRESSION","B44A_COMPRESSION","DWAA_COMPRESSION","DWAB_COMPRESSION"][S(e,r)];if("box2i"===n)return d=E(e,r),{xMin:d,yMin:E(e,r),xMax:E(e,r),yMax:E(e,r)};else if("lineOrder"===n)return["INCREASING_Y"][S(e,r)];else if("float"===n)return C(e,r);else if("v2f"===n)return[C(e,r),C(e,r)];else if("v3f"===n)return[C(e,r),C(e,r),C(e,r)];else if("int"===n)return A(e,r);else if("rational"===n)return[A(e,r),E(e,r)];else if("timecode"===n)return[E(e,r),E(e,r)];else return"preview"===n?(r.value+=i,"skipped"):(r.value+=i,void 0)}(e,t,r,s,l);void 0===u?console.warn(`EXRLoader.parse: skipped unknown header attribute type '${s}'.`):n[o]=u}}if((-5&i)!=0)throw console.error("EXRHeader:",n),"THREE.EXRLoader: provided file is currently unsupported.";return n}(k,e,z),D=function(e,t,r,n,i){let a={size:0,viewer:t,array:r,offset:n,width:e.dataWindow.xMax-e.dataWindow.xMin+1,height:e.dataWindow.yMax-e.dataWindow.yMin+1,channels:e.channels.length,bytesPerLine:null,lines:null,inputSize:null,type:e.channels[0].pixelType,uncompress:null,getter:null,format:null,[W?"colorSpace":"encoding"]:null};switch(e.compression){case"NO_COMPRESSION":a.lines=1,a.uncompress=y;break;case"RLE_COMPRESSION":a.lines=1,a.uncompress=w;break;case"ZIPS_COMPRESSION":a.lines=1,a.uncompress=v;break;case"ZIP_COMPRESSION":a.lines=16,a.uncompress=v;break;case"PIZ_COMPRESSION":a.lines=32,a.uncompress=x;break;case"PXR24_COMPRESSION":a.lines=16,a.uncompress=b;break;case"DWAA_COMPRESSION":a.lines=32,a.uncompress=M;break;case"DWAB_COMPRESSION":a.lines=256,a.uncompress=M;break;default:throw"EXRLoader.parse: "+e.compression+" is unsupported"}if(a.scanlineBlockSize=a.lines,1==a.type)switch(i){case s.RQf:a.getter=U,a.inputSize=2;break;case s.ix0:a.getter=R,a.inputSize=2}else if(2==a.type)switch(i){case s.RQf:a.getter=C,a.inputSize=4;break;case s.ix0:a.getter=_,a.inputSize=4}else throw"EXRLoader.parse: unsupported pixelType "+a.type+" for "+e.compression+".";a.blockCount=(e.dataWindow.yMax+1)/a.scanlineBlockSize;for(var o=0;o<a.blockCount;o++)B(t,n);a.outputChannels=3==a.channels?4:a.channels;let l=a.width*a.height*a.outputChannels;switch(i){case s.RQf:a.byteArray=new Float32Array(l),a.channels<a.outputChannels&&a.byteArray.fill(1,0,l);break;case s.ix0:a.byteArray=new Uint16Array(l),a.channels<a.outputChannels&&a.byteArray.fill(15360,0,l);break;default:console.error("THREE.EXRLoader: unsupported type: ",i)}return a.bytesPerLine=a.width*a.inputSize*a.channels,4==a.outputChannels?a.format=s.GWd:a.format=s.VT0,W?a.colorSpace="srgb-linear":a.encoding=3e3,a}(q,k,F,z,this.type),N={value:0},L={R:0,G:1,B:2,A:3,Y:0};for(let e=0;e<D.height/D.scanlineBlockSize;e++){let t=E(k,z);D.size=E(k,z),D.lines=t+D.scanlineBlockSize>D.height?D.height-t:D.scanlineBlockSize;let r=D.size<D.lines*D.bytesPerLine?D.uncompress(D):y(D);z.value+=D.size;for(let t=0;t<D.scanlineBlockSize;t++){let n=t+e*D.scanlineBlockSize;if(n>=D.height)break;for(let e=0;e<D.channels;e++){let i=L[q.channels[e].name];for(let a=0;a<D.width;a++){N.value=(t*(D.channels*D.width)+e*D.width+a)*D.inputSize;let o=(D.height-1-n)*(D.width*D.outputChannels)+a*D.outputChannels+i;D.byteArray[o]=D.getter(r,N)}}}}return{header:q,width:D.width,height:D.height,data:D.byteArray,format:D.format,[W?"colorSpace":"encoding"]:D[W?"colorSpace":"encoding"],type:this.type}}setDataType(e){return this.type=e,this}load(e,t,r,n){return super.load(e,function(e,r){W?e.colorSpace=r.colorSpace:e.encoding=r.encoding,e.minFilter=s.k6q,e.magFilter=s.k6q,e.generateMipmaps=!1,e.flipY=!1,t&&t(e,r)},r,n)}}var L=r(85925);let j=(e,t,r)=>{let n;switch(e){case s.OUM:n=new Uint8ClampedArray(t*r*4);break;case s.ix0:n=new Uint16Array(t*r*4);break;case s.bkx:n=new Uint32Array(t*r*4);break;case s.tJf:n=new Int8Array(t*r*4);break;case s.fBL:n=new Int16Array(t*r*4);break;case s.Yuy:n=new Int32Array(t*r*4);break;case s.RQf:n=new Float32Array(t*r*4);break;default:throw Error("Unsupported data type")}return n};class H{constructor(e){var t,r,i,a,o,l,u,c,d,f,p,h,m,g,y,w;this._rendererIsDisposable=!1,this._supportsReadPixels=!0,this.render=()=>{this._renderer.setRenderTarget(this._renderTarget);try{this._renderer.render(this._scene,this._camera)}catch(e){throw this._renderer.setRenderTarget(null),e}this._renderer.setRenderTarget(null)},this._width=e.width,this._height=e.height,this._type=e.type,this._colorSpace=e.colorSpace;let v={format:s.GWd,depthBuffer:!1,stencilBuffer:!1,type:this._type,colorSpace:this._colorSpace,anisotropy:(null==(t=e.renderTargetOptions)?void 0:t.anisotropy)!==void 0?null==(r=e.renderTargetOptions)?void 0:r.anisotropy:1,generateMipmaps:(null==(i=e.renderTargetOptions)?void 0:i.generateMipmaps)!==void 0&&(null==(a=e.renderTargetOptions)?void 0:a.generateMipmaps),magFilter:(null==(o=e.renderTargetOptions)?void 0:o.magFilter)!==void 0?null==(l=e.renderTargetOptions)?void 0:l.magFilter:s.k6q,minFilter:(null==(u=e.renderTargetOptions)?void 0:u.minFilter)!==void 0?null==(c=e.renderTargetOptions)?void 0:c.minFilter:s.k6q,samples:(null==(d=e.renderTargetOptions)?void 0:d.samples)!==void 0?null==(f=e.renderTargetOptions)?void 0:f.samples:void 0,wrapS:(null==(p=e.renderTargetOptions)?void 0:p.wrapS)!==void 0?null==(h=e.renderTargetOptions)?void 0:h.wrapS:s.ghU,wrapT:(null==(m=e.renderTargetOptions)?void 0:m.wrapT)!==void 0?null==(g=e.renderTargetOptions)?void 0:g.wrapT:s.ghU};if(this._material=e.material,e.renderer?this._renderer=e.renderer:(this._renderer=H.instantiateRenderer(),this._rendererIsDisposable=!0),this._scene=new s.Z58,this._camera=new s.qUd,this._camera.position.set(0,0,10),this._camera.left=-.5,this._camera.right=.5,this._camera.top=.5,this._camera.bottom=-.5,this._camera.updateProjectionMatrix(),!((e,t,r,i)=>{if(void 0!==n)return n;let a=new s.nWS(1,1,i);t.setRenderTarget(a);let o=new s.eaF(new s.bdM,new s.V9B({color:0xffffff}));t.render(o,r),t.setRenderTarget(null);let l=j(e,a.width,a.height);return t.readRenderTargetPixels(a,0,0,a.width,a.height,l),a.dispose(),o.geometry.dispose(),o.material.dispose(),n=0!==l[0]})(this._type,this._renderer,this._camera,v)){let e;this._type===s.ix0&&(e=this._renderer.extensions.has("EXT_color_buffer_float")?s.RQf:void 0),void 0!==e?(console.warn(`This browser does not support reading pixels from ${this._type} RenderTargets, switching to ${s.RQf}`),this._type=e):(this._supportsReadPixels=!1,console.warn("This browser dos not support toArray or toDataTexture, calls to those methods will result in an error thrown"))}this._quad=new s.eaF(new s.bdM,this._material),this._quad.geometry.computeBoundingBox(),this._scene.add(this._quad),this._renderTarget=new s.nWS(this.width,this.height,v),this._renderTarget.texture.mapping=(null==(y=e.renderTargetOptions)?void 0:y.mapping)!==void 0?null==(w=e.renderTargetOptions)?void 0:w.mapping:s.UTZ}static instantiateRenderer(){let e=new L.WebGLRenderer;return e.setSize(128,128),e}toArray(){if(!this._supportsReadPixels)throw Error("Can't read pixels in this browser");let e=j(this._type,this._width,this._height);return this._renderer.readRenderTargetPixels(this._renderTarget,0,0,this._width,this._height,e),e}toDataTexture(e){let t=new s.GYF(this.toArray(),this.width,this.height,s.GWd,this._type,(null==e?void 0:e.mapping)||s.UTZ,(null==e?void 0:e.wrapS)||s.ghU,(null==e?void 0:e.wrapT)||s.ghU,(null==e?void 0:e.magFilter)||s.k6q,(null==e?void 0:e.minFilter)||s.k6q,(null==e?void 0:e.anisotropy)||1,s.Zr2);return t.generateMipmaps=(null==e?void 0:e.generateMipmaps)!==void 0&&(null==e?void 0:e.generateMipmaps),t}disposeOnDemandRenderer(){this._renderer.setRenderTarget(null),this._rendererIsDisposable&&(this._renderer.dispose(),this._renderer.forceContextLoss())}dispose(e){this.disposeOnDemandRenderer(),e&&this.renderTarget.dispose(),this.material instanceof s.BKk&&Object.values(this.material.uniforms).forEach(e=>{e.value instanceof s.gPd&&e.value.dispose()}),Object.values(this.material).forEach(e=>{e instanceof s.gPd&&e.dispose()}),this.material.dispose(),this._quad.geometry.dispose()}get width(){return this._width}set width(e){this._width=e,this._renderTarget.setSize(this._width,this._height)}get height(){return this._height}set height(e){this._height=e,this._renderTarget.setSize(this._width,this._height)}get renderer(){return this._renderer}get renderTarget(){return this._renderTarget}set renderTarget(e){this._renderTarget=e,this._width=e.width,this._height=e.height}get material(){return this._material}get type(){return this._type}get colorSpace(){return this._colorSpace}}let G=`
varying vec2 vUv;

void main() {
  vUv = uv;
  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
}
`,$=`
// min half float value
#define HALF_FLOAT_MIN vec3( -65504, -65504, -65504 )
// max half float value
#define HALF_FLOAT_MAX vec3( 65504, 65504, 65504 )

uniform sampler2D sdr;
uniform sampler2D gainMap;
uniform vec3 gamma;
uniform vec3 offsetHdr;
uniform vec3 offsetSdr;
uniform vec3 gainMapMin;
uniform vec3 gainMapMax;
uniform float weightFactor;

varying vec2 vUv;

void main() {
  vec3 rgb = texture2D( sdr, vUv ).rgb;
  vec3 recovery = texture2D( gainMap, vUv ).rgb;
  vec3 logRecovery = pow( recovery, gamma );
  vec3 logBoost = gainMapMin * ( 1.0 - logRecovery ) + gainMapMax * logRecovery;
  vec3 hdrColor = (rgb + offsetSdr) * exp2( logBoost * weightFactor ) - offsetHdr;
  vec3 clampedHdrColor = max( HALF_FLOAT_MIN, min( HALF_FLOAT_MAX, hdrColor ));
  gl_FragColor = vec4( clampedHdrColor , 1.0 );
}
`;class V extends s.BKk{constructor({gamma:e,offsetHdr:t,offsetSdr:r,gainMapMin:n,gainMapMax:i,maxDisplayBoost:a,hdrCapacityMin:o,hdrCapacityMax:l,sdr:u,gainMap:c}){super({name:"GainMapDecoderMaterial",vertexShader:G,fragmentShader:$,uniforms:{sdr:{value:u},gainMap:{value:c},gamma:{value:new s.Pq0(1/e[0],1/e[1],1/e[2])},offsetHdr:{value:new s.Pq0().fromArray(t)},offsetSdr:{value:new s.Pq0().fromArray(r)},gainMapMin:{value:new s.Pq0().fromArray(n)},gainMapMax:{value:new s.Pq0().fromArray(i)},weightFactor:{value:(Math.log2(a)-o)/(l-o)}},blending:s.XIg,depthTest:!1,depthWrite:!1}),this._maxDisplayBoost=a,this._hdrCapacityMin=o,this._hdrCapacityMax=l,this.needsUpdate=!0,this.uniformsNeedUpdate=!0}get sdr(){return this.uniforms.sdr.value}set sdr(e){this.uniforms.sdr.value=e}get gainMap(){return this.uniforms.gainMap.value}set gainMap(e){this.uniforms.gainMap.value=e}get offsetHdr(){return this.uniforms.offsetHdr.value.toArray()}set offsetHdr(e){this.uniforms.offsetHdr.value.fromArray(e)}get offsetSdr(){return this.uniforms.offsetSdr.value.toArray()}set offsetSdr(e){this.uniforms.offsetSdr.value.fromArray(e)}get gainMapMin(){return this.uniforms.gainMapMin.value.toArray()}set gainMapMin(e){this.uniforms.gainMapMin.value.fromArray(e)}get gainMapMax(){return this.uniforms.gainMapMax.value.toArray()}set gainMapMax(e){this.uniforms.gainMapMax.value.fromArray(e)}get gamma(){let e=this.uniforms.gamma.value;return[1/e.x,1/e.y,1/e.z]}set gamma(e){let t=this.uniforms.gamma.value;t.x=1/e[0],t.y=1/e[1],t.z=1/e[2]}get hdrCapacityMin(){return this._hdrCapacityMin}set hdrCapacityMin(e){this._hdrCapacityMin=e,this.calculateWeight()}get hdrCapacityMax(){return this._hdrCapacityMax}set hdrCapacityMax(e){this._hdrCapacityMax=e,this.calculateWeight()}get maxDisplayBoost(){return this._maxDisplayBoost}set maxDisplayBoost(e){this._maxDisplayBoost=Math.max(1,Math.min(65504,e)),this.calculateWeight()}calculateWeight(){let e=(Math.log2(this._maxDisplayBoost)-this._hdrCapacityMin)/(this._hdrCapacityMax-this._hdrCapacityMin);this.uniforms.weightFactor.value=Math.max(0,Math.min(1,e))}}class X extends Error{}class Y extends Error{}let Z=(e,t,r)=>{let n=RegExp(`${t}="([^"]*)"`,"i").exec(e);if(n)return n[1];let i=RegExp(`<${t}[^>]*>([\\s\\S]*?)</${t}>`,"i").exec(e);if(i){let e=i[1].match(/<rdf:li>([^<]*)<\/rdf:li>/g);return e&&3===e.length?e.map(e=>e.replace(/<\/?rdf:li>/g,"")):i[1].trim()}if(void 0!==r)return r;throw Error(`Can't find ${t} in gainmap metadata`)};class Q{constructor(e){this.options={debug:!!e&&void 0!==e.debug&&e.debug,extractFII:!e||void 0===e.extractFII||e.extractFII,extractNonFII:!e||void 0===e.extractNonFII||e.extractNonFII}}extract(e){return new Promise((t,r)=>{let n,i=this.options.debug,a=new DataView(e.buffer);if(65496!==a.getUint16(0))return void r(Error("Not a valid jpeg"));let o=a.byteLength,s=2,l=0;for(;s<o;){if(++l>250)return void r(Error(`Found no marker after ${l} loops `));if(255!==a.getUint8(s))return void r(Error(`Not a valid marker at offset 0x${s.toString(16)}, found: 0x${a.getUint8(s).toString(16)}`));if(n=a.getUint8(s+1),i&&console.log(`Marker: ${n.toString(16)}`),226===n){i&&console.log("Found APP2 marker (0xffe2)");let e=s+4;if(0x4d504600===a.getUint32(e)){let n,i=e+4;if(18761===a.getUint16(i))n=!1;else{if(19789!==a.getUint16(i))return void r(Error("No valid endianness marker found in TIFF header"));n=!0}if(42!==a.getUint16(i+2,!n))return void r(Error("Not valid TIFF data! (no 0x002A marker)"));let o=a.getUint32(i+4,!n);if(o<8)return void r(Error("Not valid TIFF data! (First offset less than 8)"));let s=i+o,l=a.getUint16(s,!n),u=s+2,c=0;for(let e=u;e<u+12*l;e+=12)45057===a.getUint16(e,!n)&&(c=a.getUint32(e+8,!n));let d=s+2+12*l+4,f=[];for(let e=d;e<d+16*c;e+=16){let t={MPType:a.getUint32(e,!n),size:a.getUint32(e+4,!n),dataOffset:a.getUint32(e+8,!n),dependantImages:a.getUint32(e+12,!n),start:-1,end:-1,isFII:!1};t.dataOffset?(t.start=i+t.dataOffset,t.isFII=!1):(t.start=0,t.isFII=!0),t.end=t.start+t.size,f.push(t)}if(this.options.extractNonFII&&f.length){let e=new Blob([a]),r=[];for(let t of f){if(t.isFII&&!this.options.extractFII)continue;let n=e.slice(t.start,t.end+1,"image/jpeg");r.push(n)}t(r)}}}s+=2+a.getUint16(s+2)}})}}let K=async e=>{let t=(e=>{let t,r=(t="undefined"!=typeof TextDecoder?new TextDecoder().decode(e):e.toString()).indexOf("<x:xmpmeta");for(;-1!==r;){let e=t.indexOf("x:xmpmeta>",r),n=t.slice(r,e+10);try{let e=Z(n,"hdrgm:GainMapMin","0"),t=Z(n,"hdrgm:GainMapMax"),r=Z(n,"hdrgm:Gamma","1"),i=Z(n,"hdrgm:OffsetSDR","0.015625"),a=Z(n,"hdrgm:OffsetHDR","0.015625"),o=/hdrgm:HDRCapacityMin="([^"]*)"/.exec(n),s=o?o[1]:"0",l=/hdrgm:HDRCapacityMax="([^"]*)"/.exec(n);if(!l)throw Error("Incomplete gainmap metadata");let u=l[1];return{gainMapMin:Array.isArray(e)?e.map(e=>parseFloat(e)):[parseFloat(e),parseFloat(e),parseFloat(e)],gainMapMax:Array.isArray(t)?t.map(e=>parseFloat(e)):[parseFloat(t),parseFloat(t),parseFloat(t)],gamma:Array.isArray(r)?r.map(e=>parseFloat(e)):[parseFloat(r),parseFloat(r),parseFloat(r)],offsetSdr:Array.isArray(i)?i.map(e=>parseFloat(e)):[parseFloat(i),parseFloat(i),parseFloat(i)],offsetHdr:Array.isArray(a)?a.map(e=>parseFloat(e)):[parseFloat(a),parseFloat(a),parseFloat(a)],hdrCapacityMin:parseFloat(s),hdrCapacityMax:parseFloat(u)}}catch(e){}r=t.indexOf("<x:xmpmeta",e)}})(e);if(!t)throw new Y("Gain map XMP metadata not found");let r=new Q({extractFII:!0,extractNonFII:!0}),n=await r.extract(e);if(2!==n.length)throw new X("Gain map recovery image not found");return{sdr:new Uint8Array(await n[0].arrayBuffer()),gainMap:new Uint8Array(await n[1].arrayBuffer()),metadata:t}},J=e=>new Promise((t,r)=>{let n=document.createElement("img");n.onload=()=>{t(n)},n.onerror=e=>{r(e)},n.src=URL.createObjectURL(e)});class ee extends s.aHM{constructor(e,t){super(t),e&&(this._renderer=e),this._internalLoadingManager=new s.KPJ}setRenderer(e){return this._renderer=e,this}setRenderTargetOptions(e){return this._renderTargetOptions=e,this}prepareQuadRenderer(){this._renderer||console.warn("WARNING: An existing WebGL Renderer was not passed to this Loader constructor or in setRenderer, the result of this Loader will need to be converted to a Data Texture with toDataTexture() before you can use it in your renderer.");let e=new V({gainMapMax:[1,1,1],gainMapMin:[0,0,0],gamma:[1,1,1],offsetHdr:[1,1,1],offsetSdr:[1,1,1],hdrCapacityMax:1,hdrCapacityMin:0,maxDisplayBoost:1,gainMap:new s.gPd,sdr:new s.gPd});return new H({width:16,height:16,type:s.ix0,colorSpace:s.Zr2,material:e,renderer:this._renderer,renderTargetOptions:this._renderTargetOptions})}async render(e,t,r,n){let i,a,o=n?new Blob([n],{type:"image/jpeg"}):void 0,l=new Blob([r],{type:"image/jpeg"}),u=!1;if("undefined"==typeof createImageBitmap){let e=await Promise.all([o?J(o):Promise.resolve(void 0),J(l)]);a=e[0],i=e[1],u=!0}else{let e=await Promise.all([o?createImageBitmap(o,{imageOrientation:"flipY"}):Promise.resolve(void 0),createImageBitmap(l,{imageOrientation:"flipY"})]);a=e[0],i=e[1]}let c=new s.gPd(a||new ImageData(2,2),s.UTZ,s.ghU,s.ghU,s.k6q,s.NZq,s.GWd,s.OUM,1,s.Zr2);c.flipY=u,c.needsUpdate=!0;let d=new s.gPd(i,s.UTZ,s.ghU,s.ghU,s.k6q,s.NZq,s.GWd,s.OUM,1,s.er$);d.flipY=u,d.needsUpdate=!0,e.width=i.width,e.height=i.height,e.material.gainMap=c,e.material.sdr=d,e.material.gainMapMin=t.gainMapMin,e.material.gainMapMax=t.gainMapMax,e.material.offsetHdr=t.offsetHdr,e.material.offsetSdr=t.offsetSdr,e.material.gamma=t.gamma,e.material.hdrCapacityMin=t.hdrCapacityMin,e.material.hdrCapacityMax=t.hdrCapacityMax,e.material.maxDisplayBoost=Math.pow(2,t.hdrCapacityMax),e.material.needsUpdate=!0,e.render()}}class et extends ee{load([e,t,r],n,i,a){let o,l,u,c=this.prepareQuadRenderer(),d=async()=>{if(o&&l&&u){try{await this.render(c,u,o,l)}catch(n){this.manager.itemError(e),this.manager.itemError(t),this.manager.itemError(r),"function"==typeof a&&a(n),c.disposeOnDemandRenderer();return}"function"==typeof n&&n(c),this.manager.itemEnd(e),this.manager.itemEnd(t),this.manager.itemEnd(r),c.disposeOnDemandRenderer()}},f=!0,p=0,h=0,m=!0,g=0,y=0,w=!0,v=0,x=0,b=()=>{"function"==typeof i&&i(new ProgressEvent("progress",{lengthComputable:f&&m&&w,loaded:h+y+x,total:p+g+v}))};this.manager.itemStart(e),this.manager.itemStart(t),this.manager.itemStart(r);let M=new s.Y9S(this._internalLoadingManager);M.setResponseType("arraybuffer"),M.setRequestHeader(this.requestHeader),M.setPath(this.path),M.setWithCredentials(this.withCredentials),M.load(e,async e=>{if("string"==typeof e)throw Error("Invalid sdr buffer");o=e,await d()},e=>{f=e.lengthComputable,h=e.loaded,p=e.total,b()},t=>{this.manager.itemError(e),"function"==typeof a&&a(t)});let P=new s.Y9S(this._internalLoadingManager);P.setResponseType("arraybuffer"),P.setRequestHeader(this.requestHeader),P.setPath(this.path),P.setWithCredentials(this.withCredentials),P.load(t,async e=>{if("string"==typeof e)throw Error("Invalid gainmap buffer");l=e,await d()},e=>{m=e.lengthComputable,y=e.loaded,g=e.total,b()},e=>{this.manager.itemError(t),"function"==typeof a&&a(e)});let A=new s.Y9S(this._internalLoadingManager);return A.setRequestHeader(this.requestHeader),A.setPath(this.path),A.setWithCredentials(this.withCredentials),A.load(r,async e=>{if("string"!=typeof e)throw Error("Invalid metadata string");u=JSON.parse(e),await d()},e=>{w=e.lengthComputable,x=e.loaded,v=e.total,b()},e=>{this.manager.itemError(r),"function"==typeof a&&a(e)}),c}}class er extends ee{load(e,t,r,n){let i=this.prepareQuadRenderer(),a=new s.Y9S(this._internalLoadingManager);return a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setPath(this.path),a.setWithCredentials(this.withCredentials),this.manager.itemStart(e),a.load(e,async r=>{let a,o,s;if("string"==typeof r)throw Error("Invalid buffer, received [string], was expecting [ArrayBuffer]");let l=new Uint8Array(r);try{let e=await K(l);a=e.sdr,o=e.gainMap,s=e.metadata}catch(t){if(t instanceof Y||t instanceof X)console.warn(`Failure to reconstruct an HDR image from ${e}: Gain map metadata not found in the file, HDRJPGLoader will render the SDR jpeg`),s={gainMapMin:[0,0,0],gainMapMax:[1,1,1],gamma:[1,1,1],hdrCapacityMin:0,hdrCapacityMax:1,offsetHdr:[0,0,0],offsetSdr:[0,0,0]},a=l;else throw t}try{await this.render(i,s,a,o)}catch(t){this.manager.itemError(e),"function"==typeof n&&n(t),i.disposeOnDemandRenderer();return}"function"==typeof t&&t(i),this.manager.itemEnd(e),i.disposeOnDemandRenderer()},r,t=>{this.manager.itemError(e),"function"==typeof n&&n(t)}),i}}let en={apartment:"lebombo_1k.hdr",city:"potsdamer_platz_1k.hdr",dawn:"kiara_1_dawn_1k.hdr",forest:"forest_slope_1k.hdr",lobby:"st_fagans_interior_1k.hdr",night:"dikhololo_night_1k.hdr",park:"rooitou_park_1k.hdr",studio:"studio_small_03_1k.hdr",sunset:"venice_sunset_1k.hdr",warehouse:"empty_warehouse_01_1k.hdr"},ei="https://raw.githack.com/pmndrs/drei-assets/456060a26bbeb8fdf79326f224b6d99b8bcce736/hdri/",ea=e=>Array.isArray(e),eo=["/px.png","/nx.png","/py.png","/ny.png","/pz.png","/nz.png"];function es({files:e=eo,path:t="",preset:r,colorSpace:n,extensions:i}={}){r&&(ec(r),e=en[r],t=ei);let l=ea(e),{extension:u,isCubemap:c}=ed(e),d=ef(u);if(!d)throw Error("useEnvironment: Unrecognized file extension: "+e);let f=(0,o.C)(e=>e.gl);(0,a.useLayoutEffect)(()=>{("webp"===u||"jpg"===u||"jpeg"===u)&&f.domElement.addEventListener("webglcontextlost",function(){o.G.clear(d,l?[e]:e)},{once:!0})},[e,f.domElement]);let p=(0,o.G)(d,l?[e]:e,e=>{("webp"===u||"jpg"===u||"jpeg"===u)&&e.setRenderer(f),null==e.setPath||e.setPath(t),i&&i(e)}),h=l?p[0]:p;if("jpg"===u||"jpeg"===u||"webp"===u){var m;h=null==(m=h.renderTarget)?void 0:m.texture}return h.mapping=c?s.hy7:s.wfO,h.colorSpace=null!=n?n:c?"srgb":"srgb-linear",h}let el={files:eo,path:"",preset:void 0,extensions:void 0};es.preload=e=>{let t={...el,...e},{files:r,path:n=""}=t,{preset:i,extensions:a}=t;i&&(ec(i),r=en[i],n=ei);let{extension:s}=ed(r);if("webp"===s||"jpg"===s||"jpeg"===s)throw Error("useEnvironment: Preloading gainmaps is not supported");let l=ef(s);if(!l)throw Error("useEnvironment: Unrecognized file extension: "+r);o.G.preload(l,ea(r)?[r]:r,e=>{null==e.setPath||e.setPath(n),a&&a(e)})};let eu={files:eo,preset:void 0};function ec(e){if(!(e in en))throw Error("Preset must be one of: "+Object.keys(en).join(", "))}function ed(e){var t;let r=ea(e)&&6===e.length,n=ea(e)&&3===e.length&&e.some(e=>e.endsWith("json")),i=ea(e)?e[0]:e;return{extension:r?"cube":n?"webp":i.startsWith("data:application/exr")?"exr":i.startsWith("data:application/hdr")?"hdr":i.startsWith("data:image/jpeg")?"jpg":null==(t=i.split(".").pop())||null==(t=t.split("?"))||null==(t=t.shift())?void 0:t.toLowerCase(),isCubemap:r,isGainmap:n}}function ef(e){return"cube"===e?s.ScU:"hdr"===e?c:"exr"===e?N:"jpg"===e||"jpeg"===e?er:"webp"===e?et:null}function ep(e,t,r,n,i={}){var a,s,l,u;let c,d;i={backgroundBlurriness:0,backgroundIntensity:1,backgroundRotation:[0,0,0],environmentIntensity:1,environmentRotation:[0,0,0],...i};let f=(d=c=t||r).current&&d.current.isScene?c.current:c,p=f.background,h=f.environment,m={backgroundBlurriness:f.backgroundBlurriness,backgroundIntensity:f.backgroundIntensity,backgroundRotation:null!=(a=null==(s=f.backgroundRotation)||null==s.clone?void 0:s.clone())?a:[0,0,0],environmentIntensity:f.environmentIntensity,environmentRotation:null!=(l=null==(u=f.environmentRotation)||null==u.clone?void 0:u.clone())?l:[0,0,0]};return"only"!==e&&(f.environment=n),e&&(f.background=n),(0,o.s)(f,i),()=>{"only"!==e&&(f.environment=h),e&&(f.background=p),(0,o.s)(f,m)}}function eh({scene:e,background:t=!1,map:r,...n}){let i=(0,o.C)(e=>e.scene);return a.useLayoutEffect(()=>{if(r)return ep(t,e,i,r,n)}),null}function em({background:e=!1,scene:t,blur:r,backgroundBlurriness:n,backgroundIntensity:i,backgroundRotation:s,environmentIntensity:l,environmentRotation:u,...c}){let d=es(c),f=(0,o.C)(e=>e.scene);return a.useLayoutEffect(()=>ep(e,t,f,d,{backgroundBlurriness:null!=r?r:n,backgroundIntensity:i,backgroundRotation:s,environmentIntensity:l,environmentRotation:u})),a.useEffect(()=>()=>{d.dispose()},[d]),null}function eg({children:e,near:t=.1,far:r=1e3,resolution:n=256,frames:i=1,map:l,background:u=!1,blur:c,backgroundBlurriness:d,backgroundIntensity:f,backgroundRotation:p,environmentIntensity:h,environmentRotation:m,scene:g,files:y,path:w,preset:v,extensions:x}){let b=(0,o.C)(e=>e.gl),M=(0,o.C)(e=>e.scene),P=a.useRef(null),[A]=a.useState(()=>new s.Z58),E=a.useMemo(()=>{let e=new s.o6l(n);return e.texture.type=s.ix0,e},[n]);a.useEffect(()=>()=>{E.dispose()},[E]),a.useLayoutEffect(()=>{if(1===i){let e=b.autoClear;b.autoClear=!0,P.current.update(b,A),b.autoClear=e}return ep(u,g,M,E.texture,{backgroundBlurriness:null!=c?c:d,backgroundIntensity:f,backgroundRotation:p,environmentIntensity:h,environmentRotation:m})},[e,A,E.texture,g,M,u,i,b]);let T=1;return(0,o.D)(()=>{if(i===1/0||T<i){let e=b.autoClear;b.autoClear=!0,P.current.update(b,A),b.autoClear=e,T++}}),a.createElement(a.Fragment,null,(0,o.o)(a.createElement(a.Fragment,null,e,a.createElement("cubeCamera",{ref:P,args:[t,r,E]}),y||v?a.createElement(em,{background:!0,files:y,preset:v,path:w,extensions:x}):l?a.createElement(eh,{background:!0,map:l,extensions:x}):null),A))}function ey(e){var t,r,n,s;let l=es(e),c=e.map||l;a.useMemo(()=>(0,o.e)({GroundProjectedEnvImpl:u}),[]),a.useEffect(()=>()=>{l.dispose()},[l]);let d=a.useMemo(()=>[c],[c]),f=null==(t=e.ground)?void 0:t.height,p=null==(r=e.ground)?void 0:r.radius,h=null!=(n=null==(s=e.ground)?void 0:s.scale)?n:1e3;return a.createElement(a.Fragment,null,a.createElement(eh,(0,i.A)({},e,{map:c})),a.createElement("groundProjectedEnvImpl",{args:d,scale:h,height:f,radius:p}))}function ew(e){return e.ground?a.createElement(ey,e):e.map?a.createElement(eh,e):e.children?a.createElement(eg,e):a.createElement(em,e)}es.clear=e=>{let t={...eu,...e},{files:r}=t,{preset:n}=t;n&&(ec(n),r=en[n]);let{extension:i}=ed(r),a=ef(i);if(!a)throw Error("useEnvironment: Unrecognized file extension: "+r);o.G.clear(a,ea(r)?[r]:r)}}}]);